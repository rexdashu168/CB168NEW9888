<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.37 (æ•¸æ“šå®Œç¾å°æ¥ç‰ˆ) - Rexå¤§å”</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
/* ================= é¢¨æ ¼è¨­å®š ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
    min-height: 100vh; padding: 20px;
}
.container { max-width: 1600px; margin: 0 auto; display: none; }

.header {
    background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.header h1 { color: #b21f1f; font-size: 32px; margin-bottom: 10px; font-weight: 800; }
.header .subtitle { color: #555; font-size: 16px; font-weight: 500; }
.version-badge { display: inline-block; background: #1a2a6c; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }

.evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }

.input-panel {
    background: white; border-radius: 15px; padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2); height: fit-content; position: sticky; top: 20px;
}
.input-panel h2 { color: #1a2a6c; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #1a2a6c; }

.form-section { margin-bottom: 25px; }
.form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; border-left: 4px solid #b21f1f; padding-left: 10px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 600; }
.form-group input, .form-group select {
    width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
}
.form-group input:focus, .form-group select:focus { outline: none; border-color: #b21f1f; }

.info-box {
    background: #f8f9fa; padding: 15px; border-radius: 8px;
    border-left: 5px solid #4CAF50; margin-top: 10px; display: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.stat-value { font-weight: bold; color: #333; }

.calculate-btn {
    width: 100%; padding: 18px; background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
    color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold;
    cursor: pointer; transition: transform 0.2s; margin-top: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.calculate-btn:hover { transform: translateY(-2px); }

.result-panel {
    background: white; border-radius: 15px; padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2); min-height: 600px;
}
.welcome-message { text-align: center; padding: 60px 20px; }
.stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
.stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
.stat-box .number { font-size: 36px; font-weight: bold; color: #1a2a6c; margin-bottom: 10px; }

.evaluation-result { display: none; }
.evaluation-result.active { display: block; animation: fadeIn 0.5s; }

.result-header {
    background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
    color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
}
.detail-section {
    background: white; border-radius: 12px; padding: 30px;
    margin-bottom: 25px; border: 2px solid #e0e0e0;
}
.detail-section h3 { color: #1a2a6c; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #1a2a6c; }

.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; position: relative; overflow: hidden; }
.strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
.strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
.strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
.strategy-card .price { font-size: 36px; font-weight: bold; margin: 20px 0; color: #333; }

.data-table {
    width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.data-table th {
    background-color: #1a2a6c; color: white; padding: 15px 10px;
    text-align: center; font-weight: bold; border: 1px solid #0d1b5e;
}
.data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
.data-table tr:nth-child(even) { background-color: #f8f9fa; }

/* è¼‰å…¥ç•«é¢ */
#loading {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 9999; color: white; font-size: 24px; font-weight: bold;
}

@media (max-width: 1200px) {
    .evaluation-container { grid-template-columns: 1fr; }
}
</style>
</head>

<body>

<div id="loading">
    <div>ğŸ”„ æ­£åœ¨é€£ç·š 00_CB.xlsx è³‡æ–™åº«...</div>
    <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æº–å‚™è®€å– Excel</div>
    <div id="error-msg" style="margin-top: 20px; font-size: 14px; color: #ffcdd2; max-width: 80%; text-align: center; white-space: pre-wrap;"></div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.37</span></h1>
        <p class="subtitle" id="headerSubtitle">åˆå§‹åŒ–ä¸­...</p>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                    <div class="form-group">
                        <label>CBåç¨± * (è¼¸å…¥ä»£è™Ÿæˆ–åç¨±)</label>
                        <input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ / 23837">
                        <div id="cbNameInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>è‚¡æœ¬ (å„„å…ƒ) *</label>
                        <input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š52.00">
                        <div id="capitalInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç”¢æ¥­åˆ†é¡ *</label>
                        <select id="industry" required><option value="">(è®€å–ä¸­)</option></select>
                        <div id="industryInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç™¼è¡Œåˆ¸å•†</label>
                        <select id="broker"><option value="">(è®€å–ä¸­)</option></select>
                        <div id="brokerInfo" class="info-box"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group">
                        <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label>
                        <input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š10.0">
                        <div id="issueSizeInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š100.0">
                        <div id="conversionPriceInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç™¼è¡Œå¹´æœŸ *</label>
                        <select id="years" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="3">3å¹´æœŸ</option>
                            <option value="5">5å¹´æœŸ</option>
                            <option value="7">7å¹´æœŸ</option>
                        </select>
                        <div id="yearsInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>æ“”ä¿æƒ…æ³ *</label>
                        <select id="guarantee" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                            <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                        </select>
                        <div id="guaranteeInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                        <select id="rating" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="1">TCRI 1</option>
                            <option value="2">TCRI 2</option>
                            <option value="3">TCRI 3</option>
                            <option value="4">TCRI 4</option>
                            <option value="5">TCRI 5</option>
                            <option value="6">TCRI 6</option>
                            <option value="7">TCRI 7</option>
                            <option value="8">TCRI 8</option>
                            <option value="9">TCRI 9</option>
                            <option value="BBB">BBBç´š</option>
                        </select>
                        <div id="ratingInfo" class="info-box"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                    <div class="form-group">
                        <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š105.0">
                    </div>
                </div>

                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
            </form>
        </div>

        <div class="result-panel">
            <div id="welcomeMsg" class="welcome-message">
                <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
                <p>âœ… V3.37 æ•¸æ“šå®Œç¾å°æ¥ç‰ˆ<br>è‡ªå‹•æ¯”å° Excel 05 å€é–“å®šç¾©</p>
                <div class="stats-summary" id="statsSummary"></div>
            </div>
            <div id="evaluationResult" class="evaluation-result"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// V3.37 æ ¸å¿ƒé‚è¼¯ - ä¾æ“šæˆªåœ–æ¬„ä½èˆ‡å€é–“é‚è¼¯
// ==========================================

// å…¨åŸŸè®Šæ•¸
let statistics = {};     // å„²å­˜ Sheet 05 çš„çµ±è¨ˆè³‡æ–™
let cbDatabase = {};     // å„²å­˜ Sheet 01 + 00 çš„å€‹è‚¡è³‡æ–™
let cbNameMap = {};      // åç¨±å°ç…§è¡¨
let auctionRawData = []; // å„²å­˜ Sheet 04 çš„åŸå§‹ç«¶æ‹è³‡æ–™
let globalMarketStats = { low: 5, avg: 10 }; // é è¨­å®‰å…¨å€¼

// 1. å•Ÿå‹•è¼‰å…¥
window.addEventListener('DOMContentLoaded', loadExcelDatabase);

async function loadExcelDatabase() {
    const loadingDiv = document.getElementById('loading');
    const detailDiv = document.getElementById('loading-detail');
    const errorDiv = document.getElementById('error-msg');

    try {
        const fileName = '00_CB.xlsx'; 
        
        detailDiv.textContent = `æ­£åœ¨è®€å– ${fileName} ...`;
        const response = await fetch(fileName);
        
        if (!response.ok) throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆ: ${fileName}ï¼Œè«‹ç¢ºèªæª”æ¡ˆä½ç½®ã€‚`);
        
        const arrayBuffer = await response.arrayBuffer();
        detailDiv.textContent = "æ­£åœ¨è§£æ Excel æ¬„ä½æ¶æ§‹...";
        
        const workbook = XLSX.read(arrayBuffer);
        processExcelData(workbook);
        
        // è¼‰å…¥å®Œæˆï¼Œéš±è—è®€å–ç•«é¢
        loadingDiv.style.display = 'none';
        document.querySelector('.container').style.display = 'block';
        
        // åˆå§‹åŒ–é¸å–®
        initializeUI();

    } catch (e) {
        console.error(e);
        detailDiv.textContent = "âš ï¸ è³‡æ–™åº«è®€å–å¤±æ•—";
        errorDiv.textContent = e.message + "\n\nè«‹ç¢ºèª Excel æª”æ¡ˆæ˜¯å¦æ”¾åœ¨æ­£ç¢ºç›®éŒ„ä¸‹ã€‚";
    }
}

// 2. æ ¸å¿ƒï¼šè™•ç† Excel è³‡æ–™ (å°æ¥æˆªåœ–æ¬„ä½)
function processExcelData(workbook) {
    const sheetNames = workbook.SheetNames;
    
    // è¼”åŠ©æ‰¾å·¥ä½œè¡¨å‡½æ•¸
    const getSheet = (keys) => {
        const name = sheetNames.find(n => keys.some(k => n.includes(k)));
        return name ? XLSX.utils.sheet_to_json(workbook.Sheets[name]) : null;
    };

    // --- A. è™•ç† Sheet 00 (æ›ç‰Œé«˜ä½) & Sheet 01 (åŸºæœ¬è³‡æ–™) ---
    const raw00 = getSheet(['00_', 'æ›ç‰Œ']);
    const raw01 = getSheet(['01_', 'åŸºæœ¬è³‡æ–™']);

    // å…ˆå»ºç«‹åŸºæœ¬è³‡æ–™åº« (ä»¥ 01 ç‚ºä¸»)
    if (raw01) {
        raw01.forEach(row => {
            let code = safeString(row['ä»£è™Ÿ'] || row['CBä»£è™Ÿ']);
            if (!code) return;
            
            cbDatabase[code] = {
                "ä»£è™Ÿ": code,
                "åç¨±": safeString(row['åç¨±']),
                "ç”¢æ¥­åˆ†é¡": safeString(row['ç”¢æ¥­åˆ†é¡']),
                "ç™¼è¡Œåˆ¸å•†": safeString(row['æ‰¿éŠ·åˆ¸å•†'] || row['ä¸»è¾¦åˆ¸å•†']),
                "è‚¡æœ¬": safeFloat(row['è‚¡æœ¬'] || row['è‚¡æœ¬(å„„)'] || row['è‚¡æœ¬è¦æ¨¡']),
                "ç™¼è¡Œè¦æ¨¡": safeFloat(row['ç™¼è¡Œè¦æ¨¡'] || row['ç™¼è¡Œè¦æ¨¡(å„„)']),
                "å¹´æœŸ": safeFloat(row['ç™¼è¡Œå¹´æœŸ'] || row['å¹´æœŸ']),
                "è½‰æ›åƒ¹": safeFloat(row['è½‰æ›åƒ¹æ ¼']),
                "æ“”ä¿": safeString(row['æ“”ä¿'] || row['æœ‰ç„¡æ“”ä¿']),
                "ä¿¡è©•": safeString(row['ä¿¡è©•'] || row['TCRI(è©•ç­‰)']),
                "æ›ç‰Œæœ€é«˜": 0, "æ›ç‰Œæœ€ä½": 0 // é è¨­
            };
        });
    }

    // å†æŠŠ 00 çš„åƒ¹æ ¼è£œé€²å»
    if (raw00) {
        raw00.forEach(row => {
            let code = safeString(row['ä»£è™Ÿ']);
            if (cbDatabase[code]) {
                cbDatabase[code]['æ›ç‰Œæœ€é«˜'] = safeFloat(row['æ›ç‰Œæœ€é«˜']);
                cbDatabase[code]['æ›ç‰Œæœ€ä½'] = safeFloat(row['æ›ç‰Œæœ€ä½']);
            }
        });
    }
    
    // å»ºç«‹åç¨±ç´¢å¼•
    Object.values(cbDatabase).forEach(item => {
        if (item['åç¨±']) cbNameMap[item['åç¨±']] = item;
    });

    // --- B. è™•ç† Sheet 04 (ç«¶æ‹è³‡æ–™åº«) ---
    const raw04 = getSheet(['04_', 'ç«¶æ‹']);
    if (raw04) {
        auctionRawData = raw04.map(row => ({
            "åç¨±": safeString(row['åç¨±']),
            "æœ€ä½æº¢åƒ¹": safeFloat(row['æœ€ä½æº¢åƒ¹'] || row['æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡']),
            "å¹³å‡æº¢åƒ¹": safeFloat(row['å¹³å‡æº¢åƒ¹'] || row['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡']),
            "ç”¢æ¥­åˆ†é¡": safeString(row['ç”¢æ¥­åˆ†é¡']),
            "ç™¼è¡Œåˆ¸å•†": safeString(row['æ‰¿éŠ·åˆ¸å•†'] || row['ç™¼è¡Œåˆ¸å•†']),
            "æ“”ä¿": safeString(row['æ“”ä¿']),
            "å¹´æœŸ": safeFloat(row['å¹´æœŸ'] || row['ç™¼è¡Œå¹´æœŸ']),
            "è‚¡æœ¬": safeFloat(row['è‚¡æœ¬'] || row['è‚¡æœ¬(å„„)']),
            "ç™¼è¡Œè¦æ¨¡": safeFloat(row['ç™¼è¡Œè¦æ¨¡'] || row['ç™¼è¡Œè¦æ¨¡(å„„)'])
        }));
        
        calculateGlobalStats();
    }

    // --- C. è™•ç† Sheet 05 (çµ±è¨ˆ/ç¯©é¸æ¢ä»¶) ---
    const raw05 = getSheet(['05_', 'ç¯©é¸', 'çµ±è¨ˆ']);
    
    // åˆå§‹åŒ–çµ±è¨ˆçµæ§‹
    statistics['è‚¡æœ¬'] = {};
    statistics['ç™¼è¡Œè¦æ¨¡'] = {};
    statistics['è½‰æ›åƒ¹'] = {};
    statistics['ä¿¡è©•'] = {};
    statistics['ç”¢æ¥­'] = {};
    statistics['ç™¼è¡Œåˆ¸å•†'] = {};
    statistics['æ“”ä¿'] = {};
    statistics['å¹´æœŸ'] = {};

    if (raw05) {
        raw05.forEach(row => {
            let key = safeString(row['æ¢ä»¶å€é–“'] || row['ç¶­åº¦'] || row['å€é–“'] || row['è‚¡æœ¬å¤§å°'] || row['è¦æ¨¡å¤§å°'] || row['è½‰æ›åƒ¹æ ¼']);
            
            // ç”±æ–¼æˆªåœ–ä¸­ä¸åŒæ¬„ä½æœ‰ä¸åŒåç¨±ï¼Œæˆ‘å€‘åšå¯¬é¬†è®€å–
            // è®€å–çµ±è¨ˆå€¼
            let data = {
                "å¹³å‡æœ€ä½æº¢åƒ¹": safeFloat(row['æ­·å²æœ€ä½æº¢åƒ¹'] || row['å¹³å‡æœ€ä½æº¢åƒ¹']),
                "å¹³å‡æº¢åƒ¹": safeFloat(row['æ­·å²å¹³å‡æº¢åƒ¹'] || row['å¹³å‡æº¢åƒ¹']),
                "æ¨£æœ¬æ•¸": safeFloat(row['æ¨£æœ¬æ•¸'])
            };

            // åˆ†é¡æ­¸æª”ï¼šä¾æ“š Key çš„ç‰¹å¾µ
            if (key.includes('è‚¡æœ¬å¤§å°')) statistics['è‚¡æœ¬'][key] = data;
            else if (key.includes('ç™¼è¡Œè¦æ¨¡') || key.includes('è¦æ¨¡å¤§å°')) statistics['ç™¼è¡Œè¦æ¨¡'][key] = data;
            else if (key.includes('è½‰æ›åƒ¹æ ¼')) statistics['è½‰æ›åƒ¹'][key] = data;
            
            // å…¶ä»–é¡å‹ (ç”¢æ¥­ã€åˆ¸å•†) å¯èƒ½æ²’æœ‰çµ±ä¸€ Keyï¼Œè‹¥éœ€è™•ç†è«‹å‘ŠçŸ¥
        });
    }
}

// 3. æ ¸å¿ƒé‹ç®—ï¼šå€é–“åˆ†é¡å™¨ (å®Œå…¨ä¾ç…§æˆªåœ–é‚è¼¯)
function getClassTag(category, val) {
    if (category === 'è‚¡æœ¬') {
        let v = parseFloat(val);
        if (v < 3) return "1_è‚¡æœ¬å¤§å°_å°æ–¼3å„„";
        if (v >= 3 && v < 6) return "2_è‚¡æœ¬å¤§å°_3~6å„„";
        if (v >= 6 && v < 10) return "3_è‚¡æœ¬å¤§å°_6~10å„„";
        if (v >= 10 && v < 15) return "4_è‚¡æœ¬å¤§å°_10~15å„„";
        if (v >= 15 && v < 20) return "5_è‚¡æœ¬å¤§å°_15~20å„„";
        if (v >= 20) return "6_è‚¡æœ¬å¤§å°_å¤§æ–¼20å„„";
    }
    if (category === 'ç™¼è¡Œè¦æ¨¡') {
        let v = parseFloat(val);
        if (v < 2) return "1_ç™¼è¡Œè¦æ¨¡_å°æ–¼2å„„";
        if (v >= 2 && v < 5) return "2_ç™¼è¡Œè¦æ¨¡_2~5å„„";
        if (v >= 5 && v < 10) return "3_ç™¼è¡Œè¦æ¨¡_5~10å„„";
        if (v >= 10 && v < 15) return "4_ç™¼è¡Œè¦æ¨¡_10~15å„„";
        if (v >= 15 && v < 20) return "5_ç™¼è¡Œè¦æ¨¡_15~20å„„";
        if (v >= 20) return "6_ç™¼è¡Œè¦æ¨¡_å¤§æ–¼20å„„";
    }
    if (category === 'è½‰æ›åƒ¹') {
        let v = parseFloat(val);
        if (v < 20) return "1_è½‰æ›åƒ¹æ ¼_å°æ–¼20å…ƒ";
        if (v >= 20 && v < 50) return "2_è½‰æ›åƒ¹æ ¼_ä»‹æ–¼20~50å…ƒ";
        if (v >= 50 && v < 100) return "3_è½‰æ›åƒ¹æ ¼_ä»‹æ–¼50~100å…ƒ";
        if (v >= 100 && v < 150) return "4_è½‰æ›åƒ¹æ ¼_ä»‹æ–¼100~150å…ƒ";
        if (v >= 150 && v < 200) return "5_è½‰æ›åƒ¹æ ¼_ä»‹æ–¼150~200å…ƒ";
        if (v >= 200) return "6_è½‰æ›åƒ¹æ ¼_å¤§æ–¼200å…ƒ";
    }
    return null;
}

// 4. å–å¾—çµ±è¨ˆæ•¸æ“š (æ··åˆ æŸ¥è¡¨ + å³æ™‚é‹ç®—)
function getStatsSmart(category, val) {
    let result = { low: globalMarketStats.low, avg: globalMarketStats.avg, rawData: null, label: val };

    // A. è™•ç†æ•¸å€¼å€é–“é¡ -> å„ªå…ˆæŸ¥ Sheet 05
    let lookupKey = null;
    if (['è‚¡æœ¬', 'ç™¼è¡Œè¦æ¨¡', 'è½‰æ›åƒ¹'].includes(category)) {
        lookupKey = getClassTag(category, val);
        if (lookupKey && statistics[category] && statistics[category][lookupKey]) {
            let data = statistics[category][lookupKey];
            result.low = data['å¹³å‡æœ€ä½æº¢åƒ¹'];
            result.avg = data['å¹³å‡æº¢åƒ¹'];
            result.rawData = data;
            result.label = lookupKey; 
            return result;
        }
    }

    // B. è™•ç†é¡åˆ¥é¡ -> å„ªå…ˆç”¨ Sheet 04 å³æ™‚é‹ç®—
    let filterFn = null;
    if (category === 'ç™¼è¡Œåˆ¸å•†') filterFn = d => d['ç™¼è¡Œåˆ¸å•†'] === val;
    else if (category === 'ç”¢æ¥­') filterFn = d => d['ç”¢æ¥­åˆ†é¡'] === val;
    else if (category === 'æ“”ä¿') filterFn = d => (d['æ“”ä¿']||'').includes(val);
    else if (category === 'å¹´æœŸ') filterFn = d => d['å¹´æœŸ'] == val;
    else if (category === 'ä¿¡è©•') filterFn = d => (d['ä¿¡è©•']||'').toString().includes(val.toString());
    
    if (filterFn) {
        const matches = auctionRawData.filter(filterFn);
        if (matches.length > 0) {
            let sumLow = 0, sumAvg = 0, count = 0;
            matches.forEach(d => {
                let l = d['æœ€ä½æº¢åƒ¹'];
                let a = d['å¹³å‡æº¢åƒ¹'];
                if (l < 2 && l > -2) l *= 100;
                if (a < 2 && a > -2) a *= 100;
                
                if (l > -10 && l < 200) { 
                    sumLow += l; sumAvg += a; count++;
                }
            });
            if (count > 0) {
                result.low = sumLow / count;
                result.avg = sumAvg / count;
                result.rawData = { 'æ¨£æœ¬æ•¸': count, 'å¹³å‡æœ€ä½æº¢åƒ¹': result.low, 'å¹³å‡æº¢åƒ¹': result.avg };
            }
        }
    }

    return result;
}

// 5. è¼”åŠ©å‡½æ•¸
function safeString(val) { return val ? String(val).trim() : ""; }
function safeFloat(val) {
    if (val == null || val === '') return 0;
    if (typeof val === 'string') val = val.replace(/,/g, '').replace(/%/g, '');
    let n = parseFloat(val);
    return isNaN(n) ? 0 : n;
}
function calculateGlobalStats() {
    if (auctionRawData.length === 0) return;
    let sumLow=0, sumAvg=0, count=0;
    auctionRawData.forEach(d => {
        let l = safeFloat(d['æœ€ä½æº¢åƒ¹']);
        let a = safeFloat(d['å¹³å‡æº¢åƒ¹']);
        if(l < 2) l*=100; if(a < 2) a*=100;
        if(l > 0) { sumLow+=l; sumAvg+=a; count++; }
    });
    if(count>0) { globalMarketStats.low = sumLow/count; globalMarketStats.avg = sumAvg/count; }
}

// 6. UI æ›´æ–°èˆ‡ç¶å®š
function initializeUI() {
    document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | å·²è¼‰å…¥ ${Object.keys(cbDatabase).length} æª” CB è³‡æ–™`;

    const industries = new Set(auctionRawData.map(d => d['ç”¢æ¥­åˆ†é¡']).filter(Boolean));
    const brokers = new Set(auctionRawData.map(d => d['ç™¼è¡Œåˆ¸å•†']).filter(Boolean));
    
    populateSelect('industry', Array.from(industries).sort());
    populateSelect('broker', Array.from(brokers).sort());

    showStatsSummary();
    bindEvents();
}

function populateSelect(id, list) {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
    list.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item; opt.textContent = item;
        sel.appendChild(opt);
    });
}

function showStatsSummary() {
    document.getElementById('statsSummary').innerHTML = `
        <div class="stat-box"><div class="number">${Object.keys(cbDatabase).length}</div><div class="label">CB è³‡æ–™åº«</div></div>
        <div class="stat-box"><div class="number">${auctionRawData.length}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
    `;
}

function bindEvents() {
    // è¼¸å…¥ä»£è™Ÿï¼Œè‡ªå‹•å¸¶å…¥
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim();
        const info = document.getElementById('cbNameInfo');
        if(!val) { info.style.display='none'; return; }

        const match = Object.values(cbDatabase).find(d => d['åç¨±'].includes(val) || d['ä»£è™Ÿ'].includes(val));
        
        if (match) {
            let html = `<div class="stats-header">âœ… æ‰¾åˆ°è³‡æ–™: ${match['åç¨±']} (${match['ä»£è™Ÿ']})</div>`;
            if (match['æ›ç‰Œæœ€é«˜'] > 0) {
                 html += `<div class="stat-row"><span>æ­·å²æœ€é«˜:</span><strong>${match['æ›ç‰Œæœ€é«˜']}</strong></div>`;
                 html += `<div class="stat-row"><span>æ­·å²æœ€ä½:</span><strong>${match['æ›ç‰Œæœ€ä½']}</strong></div>`;
            }
            if(match['è‚¡æœ¬']) document.getElementById('capital').value = match['è‚¡æœ¬'];
            if(match['ç™¼è¡Œè¦æ¨¡']) document.getElementById('issueSize').value = match['ç™¼è¡Œè¦æ¨¡'];
            if(match['ç”¢æ¥­åˆ†é¡']) document.getElementById('industry').value = match['ç”¢æ¥­åˆ†é¡'];
            if(match['ç™¼è¡Œåˆ¸å•†']) document.getElementById('broker').value = match['ç™¼è¡Œåˆ¸å•†'];
            if(match['è½‰æ›åƒ¹']) document.getElementById('conversionPrice').value = match['è½‰æ›åƒ¹'];
            
            updateAllStats();
            info.innerHTML = html;
            info.style.display = 'block';
        } else {
            info.style.display = 'none';
        }
    });

    // æ¬„ä½æ›´å‹•æ™‚è§¸ç™¼æ›´æ–°
    const ids = ['capital', 'issueSize', 'conversionPrice', 'industry', 'broker', 'years', 'guarantee', 'rating'];
    ids.forEach(id => {
        document.getElementById(id).addEventListener('change', updateAllStats);
    });
}

function updateAllStats() {
    const updateOne = (inputId, category, infoId) => {
        const val = document.getElementById(inputId).value;
        const info = document.getElementById(infoId);
        if (!val) { info.style.display = 'none'; return; }

        const stats = getStatsSmart(category, val);
        
        // æ¸²æŸ“ç¶ è‰²å°æ¡†æ¡†
        info.innerHTML = `
            <div class="stats-header">ğŸ“Š çµ±è¨ˆ (${stats.label || val})</div>
            <div class="stat-row"><span>æ¨£æœ¬æ•¸:</span><strong>${stats.rawData ? stats.rawData['æ¨£æœ¬æ•¸'] : 'é‹ç®—ä¸­'}</strong></div>
            <div style="background:#e8f5e9; padding:5px; margin-top:5px; border-radius:4px;">
                <div class="stat-row">æœ€ä½æº¢åƒ¹: <span style="color:#d32f2f; font-weight:bold;">${stats.low.toFixed(2)}%</span></div>
                <div class="stat-row">å¹³å‡æº¢åƒ¹: <span style="color:#388e3c; font-weight:bold;">${stats.avg.toFixed(2)}%</span></div>
            </div>
        `;
        info.style.display = 'block';
    };

    updateOne('capital', 'è‚¡æœ¬', 'capitalInfo');
    updateOne('issueSize', 'ç™¼è¡Œè¦æ¨¡', 'issueSizeInfo');
    updateOne('conversionPrice', 'è½‰æ›åƒ¹', 'conversionPriceInfo');
    updateOne('industry', 'ç”¢æ¥­', 'industryInfo');
    updateOne('broker', 'ç™¼è¡Œåˆ¸å•†', 'brokerInfo');
    updateOne('years', 'å¹´æœŸ', 'yearsInfo');
    updateOne('guarantee', 'æ“”ä¿', 'guaranteeInfo');
    updateOne('rating', 'ä¿¡è©•', 'ratingInfo');
}

// 7. æœ€çµ‚è©•ä¼°è¨ˆç®—
document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // æ”¶é›†æ‰€æœ‰è¼¸å…¥
    const data = {
        cbName: document.getElementById('cbName').value,
        stockPrice: parseFloat(document.getElementById('stockPrice').value),
        conversionPrice: parseFloat(document.getElementById('conversionPrice').value)
    };

    // æ¬Šé‡è¨­å®š (å¯å¾®èª¿)
    const inputs = [
        { id:'industry', w:0.25, cat:'ç”¢æ¥­' },
        { id:'broker', w:0.13, cat:'ç™¼è¡Œåˆ¸å•†' },
        { id:'capital', w:0.12, cat:'è‚¡æœ¬' },
        { id:'issueSize', w:0.10, cat:'ç™¼è¡Œè¦æ¨¡' },
        { id:'rating', w:0.15, cat:'ä¿¡è©•' },
        { id:'guarantee', w:0.12, cat:'æ“”ä¿' },
        { id:'years', w:0.08, cat:'å¹´æœŸ' },
        { id:'conversionPrice', w:0.05, cat:'è½‰æ›åƒ¹' }
    ];

    let wLow = 0, wAvg = 0;
    
    inputs.forEach(item => {
        const val = document.getElementById(item.id).value;
        const stats = getStatsSmart(item.cat, val);
        wLow += stats.low * item.w;
        wAvg += stats.avg * item.w;
    });

    const theoPrice = (data.stockPrice / data.conversionPrice) * 100;
    const gap = wAvg - wLow;

    // é¡¯ç¤ºçµæœ
    const resDiv = document.getElementById('evaluationResult');
    document.getElementById('welcomeMsg').style.display = 'none';
    resDiv.className = 'evaluation-result active';
    
    resDiv.innerHTML = `
    <div class="result-header"><h2>${data.cbName}</h2><div class="subtitle">AI æ™ºèƒ½è©•ä¼°çµæœ</div></div>
    <div class="detail-section">
        <h3>ğŸ“Š åŸºç¤åˆ†æ</h3>
        <table class="data-table">
            <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
            <tr><td>ç›®å‰è‚¡åƒ¹</td><td>${data.stockPrice}</td></tr>
            <tr><td>è½‰æ›åƒ¹æ ¼</td><td>${data.conversionPrice}</td></tr>
            <tr style="background:#fff3e0; font-weight:bold; font-size:16px;"><td>ç†è«–åƒ¹æ ¼</td><td style="color:#d32f2f;">${theoPrice.toFixed(2)}</td></tr>
        </table>
    </div>
    <div class="detail-section">
        <h3>ğŸ’¡ å»ºè­°æŠ•æ¨™åƒ¹æ ¼ (V3.37 é æ¸¬)</h3>
        <p style="margin-bottom:15px; color:#666; font-size:14px;">æ ¹æ“šæ­·å²å€é–“å¤§æ•¸æ“šåŠ æ¬Šé‹ç®—ï¼šé æœŸæœ€ä½æº¢åƒ¹ç‡ <b>${wLow.toFixed(2)}%</b> / å¹³å‡æº¢åƒ¹ç‡ <b>${wAvg.toFixed(2)}%</b></p>
        <div class="price-grid">
            <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆ (åœ°æ¿)</h4><div class="price">${(theoPrice * (1 + wLow/100)).toFixed(2)}</div></div>
            <div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡ (å‡åƒ¹)</h4><div class="price">${(theoPrice * (1 + wAvg/100)).toFixed(2)}</div></div>
            <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µ (è¡åˆº)</h4><div class="price">${(theoPrice * (1 + (wAvg+gap*0.5)/100)).toFixed(2)}</div></div>
        </div>
    </div>
    <div style="text-align:center; margin-top:30px;">
        <button onclick="location.reload()" style="padding:10px 30px; border-radius:5px; border:none; background:#ddd; cursor:pointer;">é‡æ–°è©•ä¼°</button>
    </div>
    `;
    resDiv.scrollIntoView({ behavior: 'smooth' });
});

</script>
</body>
</html>
