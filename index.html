<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.51 (Rexå¤§å”å®Œç¾èåˆç‰ˆ)</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
/* ================= é¢¨æ ¼è¨­å®š (v3.50 å¤§å­—é«”ç‰ˆ) ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; font-size: 17px; }
.container { max-width: 1600px; margin: 0 auto; }

/* Header */
.header { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
.header::before { content: ""; position: absolute; top: 0; left: 0; width: 10px; height: 100%; background: #9C27B0; }
.header h1 { color: #667eea; font-size: 36px; margin-bottom: 10px; font-weight: 900; }
.header .subtitle { color: #666; font-size: 18px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
.version-badge { display: inline-block; background: #7B1FA2; color: white; padding: 5px 15px; border-radius: 20px; font-size: 16px; font-weight: bold; }

/* Layout */
.evaluation-container { display: grid; grid-template-columns: 480px 1fr; gap: 25px; }
.input-panel { background: white; border-radius: 15px; padding: 35px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }
.input-panel h2 { color: #667eea; font-size: 26px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; font-weight: 800; }

/* Forms */
.form-section { margin-bottom: 30px; }
.form-section h3 { color: #333; font-size: 18px; margin-bottom: 15px; font-weight: bold; border-left: 5px solid #667eea; padding-left: 12px; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; color: #444; font-size: 16px; margin-bottom: 8px; font-weight: 700; }
.form-group input, .form-group select { width: 100%; padding: 14px; border: 2px solid #bbb; border-radius: 10px; font-size: 17px; transition: border-color 0.3s; font-weight: 600; color:#000; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; background: #fcfdff; border-width: 2px; }

/* Warning Box */
.warning-box { background: #fff3e0; border: 2px solid #ffb74d; border-radius: 8px; padding: 15px; margin-top: 8px; font-size: 15px; color: #bf360c; font-weight: bold; line-height: 1.6; }

/* v3.48 ç¶“å…¸ç¶ è‰²è³‡è¨Šå¡ (Info Cards) - æ¨£å¼å›æ­¸ */
.info-box { background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 6px solid #4CAF50; margin-top: 10px; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); animation: slideDown 0.3s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.stats-header { font-size: 15px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 14px; color: #333; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.stat-label { color: #555; font-weight: 600; }
.stat-value { font-weight: 900; color: #000; }

/* v3.50 è©³ç´°æ­·å²æœå°‹çµæœ */
.history-results { 
    margin-top: 12px; background: #f3e5f5; border: 2px solid #ce93d8; 
    border-radius: 10px; padding: 12px; display: none; 
    max-height: 400px; overflow-y: auto; box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
}
.history-item { 
    background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; 
    border-left: 5px solid #9c27b0; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.history-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
.h-label { color: #666; font-size: 14px; }
.h-val { font-weight: bold; color: #000; }
.h-tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 12px; color: #555; }

/* Result Panel */
.result-panel { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px; }
.result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 35px; border-radius: 15px; margin-bottom: 35px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; }

/* Table Optimization */
.data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 16px; margin-top: 15px; border: 2px solid #1A237E; border-radius: 8px; overflow: hidden; }
.data-table th { 
    background-color: #1A237E; color: white; padding: 15px 12px; 
    text-align: center; font-weight: 900; border-bottom: 2px solid #0d1b5e; border-right: 1px solid #3949ab;
    vertical-align: middle; line-height: 1.3; font-size: 17px;
}
.data-table th:last-child { border-right: none; }
.data-table td { padding: 14px 12px; border-bottom: 1px solid #ddd; border-right: 1px solid #ddd; color: #000; font-weight: 600; text-align: center; }
.data-table td:last-child { border-right: none; }
.data-table td:nth-child(n+3) { text-align: right; font-family: 'Segoe UI', monospace; font-size: 17px; }
.data-table tfoot td { background-color: #e8eaf6; font-weight: 900; color: #1A237E; border-top: 3px solid #3f51b5; font-size: 18px; }

/* Strategy Cards */
.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-top: 25px; }
.strategy-card { border: 3px solid; border-radius: 15px; padding: 25px; text-align: center; background: #fff; transition: transform 0.2s; }
.strategy-card:hover { transform: translateY(-5px); }
.strategy-card h4 { font-size: 20px; font-weight: 900; margin-bottom: 10px; }
.strategy-card .price { font-size: 38px; font-weight: 900; margin: 15px 0; color: #222; font-family: 'Segoe UI', sans-serif; }
.strategy-card .formula { font-size: 13px; color: #666; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 5px; margin-top: 10px; display: inline-block;}

/* Rex Analysis */
.rex-analysis { background: #fff8e1; border-left: 8px solid #ffb300; padding: 30px; border-radius: 10px; margin-top: 40px; }
.rex-title { font-size: 22px; color: #e65100; margin-bottom: 15px; font-weight: 900; }
.rex-content { font-size: 17px; line-height: 1.8; color: #4e342e; }

.calculate-btn { width: 100%; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 22px; font-weight: 900; cursor: pointer; transition: all 0.2s; margin-top: 25px; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }

@media (max-width: 1200px) { .evaluation-container { grid-template-columns: 1fr; } }
</style>
</head>

<body>
<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white;">
    <div style="font-size: 50px;">ğŸ”„</div>
    <div style="font-size: 28px; font-weight: bold; margin-top: 15px;">Rexå¤§å”ç«¶æ‹ç³»çµ± v3.51</div>
    <div style="font-size: 18px; margin-top: 10px; opacity: 0.9;">æ­£åœ¨é‚„åŸå¡ç‰‡åŠŸèƒ½ä¸¦è¼‰å…¥æ­·å²åº«...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.51 å®Œç¾èåˆç‰ˆ</span></h1>
        <div class="subtitle">
            <span>Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</span>
            <span style="color:#ddd">|</span>
            <span id="headerSubtitle">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™ (æ”¯æ´æ­·å²æœå°‹)</h3>
                    <div class="form-group">
                        <label>CBåç¨± / ä»£è™Ÿ *</label>
                        <input type="text" id="cbName" required placeholder="è¼¸å…¥ 2368 æˆ– é‡‘åƒé›»..." autocomplete="off">
                        <div id="historyResults" class="history-results"></div>
                        <div id="cbNameInfo" class="info-box"></div>
                    </div>
                    <div class="form-group"><label>è‚¡æœ¬ (å„„å…ƒ) *</label><input type="number" id="capital" step="0.01" required><div id="capitalInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç”¢æ¥­åˆ†é¡ *</label><select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select><div id="industryInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç™¼è¡Œåˆ¸å•†</label><select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select><div id="brokerInfo" class="info-box"></div></div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group"><label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label><input type="number" id="issueSize" step="0.1" required><div id="issueSizeInfo" class="info-box"></div></div>
                    <div class="form-group"><label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label><input type="number" id="conversionPrice" step="0.01" required><div id="conversionPriceInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç™¼è¡Œå¹´æœŸ *</label><select id="years" required><option value="3">3å¹´æœŸ</option><option value="5">5å¹´æœŸ</option><option value="7">7å¹´æœŸ</option></select><div id="yearsInfo" class="info-box"></div></div>
                    <div class="form-group"><label>æ“”ä¿æƒ…æ³ *</label><select id="guarantee" required><option value="">è«‹é¸æ“‡...</option><option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option><option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option></select><div id="guaranteeInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label><select id="rating" required><option value="">è«‹é¸æ“‡...</option><option value="1">TCRI 1</option><option value="2">TCRI 2</option><option value="3">TCRI 3</option><option value="4">TCRI 4</option><option value="5">TCRI 5</option><option value="6">TCRI 6</option><option value="7">TCRI 7</option><option value="8">TCRI 8</option><option value="9">TCRI 9</option><option value="BBB">BBBç´š</option></select><div id="ratingInfo" class="info-box"></div></div>
                </div>

                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                    <div class="form-group">
                        <label>ç«¶æ‹æˆªæ­¢æ—¥ 13:30 æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                        <div class="warning-box">
                            âš ï¸ æˆªæ¨™æ—¥ 1:30 è‚¡åƒ¹æ”¶ç›¤å‰ç†è«–åƒ¹æ ¼éƒ½æœƒéš¨è‚¡åƒ¹æ³¢å‹•è€Œè®Šå‹•ï¼Œå»ºè­°æ–¼ 13:30 æ”¶ç›¤å¾Œè‡³ 2:00 å‰å®ŒæˆæŠ•æ¨™ã€‚
                        </div>
                    </div>
                </div>

                <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 20px;">
                    <h3 style="color: #e65100; border-left:none; padding-left:0;">âš–ï¸ ä¸»è§€æ¬Šé‡èª¿æ•´</h3>
                    <div style="background:#fff; padding:10px; border-radius:8px; font-size:14px; margin-bottom:15px; border:1px solid #ffcc80;">
                        ğŸ’¡ <b>ç‚ºä½•è¦æœ‰ä¸»è§€æ¬Šé‡ï¼Ÿ</b><br>
                        çµ±è¨ˆæ•¸æ“šæ˜¯å®¢è§€åŸºç¤ï¼Œä½†è‹¥æ‚¨æœ‰è±å¯Œç¶“é©—æˆ–ç¨åˆ°è¦‹è§£ï¼Œå¯åœ¨æ­¤æ³¨å…¥æ‚¨çš„ã€ŒæŠ•è³‡éˆé­‚ã€ï¼Œèª¿æ•´ç³»çµ±å»ºè­°çš„æº¢åƒ¹æ¯”é‡ã€‚
                    </div>
                    <div class="form-group"><label>ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label><input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0"></div>
                    <div class="form-group"><label>ä¸»è§€æœ€ä½æº¢åƒ¹ç‡ (%)</label><input type="number" id="subjectiveLowPremium" step="0.1" value="0"></div>
                    <div class="form-group"><label>ä¸»è§€å¹³å‡æº¢åƒ¹ç‡ (%)</label><input type="number" id="subjectiveAvgPremium" step="0.1" value="0"></div>
                </div>

                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹ AI è©•ä¼°</button>
            </form>
        </div>
        
        <div class="result-panel">
            <div id="welcomeMsg" class="welcome-message" style="text-align: center; padding: 60px 20px;">
                <h2>æ­¡è¿ä½¿ç”¨ v3.51 çµ‚æ¥µç‰ˆ</h2>
                <p style="margin-top:15px; color:#666; font-size:18px;">
                    âœ… ç¶“å…¸ç¶ è‰²è³‡è¨Šå¡å·²å›æ­¸<br>
                    âœ… æ”¯æ´è©³ç´°æ­·å²æŠ•æ¨™æ•¸æ“š
                </p>
                <div class="stats-summary" id="statsSummary" style="margin-top:30px; font-weight:bold;"></div>
            </div>
            <div id="evaluationResult" class="evaluation-result"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. æ¬„ä½èˆ‡å·¥å…·
// ==========================================
const FIELD_ALIASES = {
    'cbId': ['CBä»£è™Ÿ', 'ä»£è™Ÿ', 'è‚¡ç¥¨ä»£è™Ÿ'], 
    'name': ['åç¨±', 'CBåç¨±', 'å…¬å¸åç¨±'],
    'industry': ['ç”¢æ¥­åˆ†é¡', 'ç”¢æ¥­åˆ¥', 'ç”¢æ¥­'], 
    'broker': ['ç™¼è¡Œåˆ¸å•†', 'æ‰¿éŠ·åˆ¸å•†', 'ä¸»è¾¦åˆ¸å•†'],
    'capital': ['è‚¡æœ¬', 'è‚¡æœ¬(å„„)'], 
    'issueSize': ['ç™¼è¡Œè¦æ¨¡', 'ç™¼è¡Œç¸½é¡', 'ç¸½é¡'],
    'minBidPrice': ['æœ€ä½å¾—æ¨™', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼'], 
    'avgBidPrice': ['å¹³å‡å¾—æ¨™', 'å¹³å‡å¾—æ¨™åƒ¹æ ¼'],
    'lowPremium': ['æœ€ä½æº¢åƒ¹', 'æœ€ä½å¾—æ¨™æº¢åƒ¹', 'æœ€ä½æº¢åƒ¹ç‡'],
    'avgPremium': ['å¹³å‡æº¢åƒ¹', 'å¹³å‡å¾—æ¨™æº¢åƒ¹', 'å¹³å‡æº¢åƒ¹ç‡'],
    'marketHigh': ['æ›ç‰Œæœ€é«˜', 'æ›ç‰Œæœ€é«˜åƒ¹'],
    'marketLow': ['æ›ç‰Œæœ€ä½', 'æ›ç‰Œæœ€ä½åƒ¹'],
    'issueDate': ['é–‹æ¨™æ—¥æœŸ', 'é–‹æ¨™æ—¥', 'ç«¶æ‹æ—¥æœŸ', 'æ—¥æœŸ'],
    'bidMultiplier': ['æŠ•æ¨™å€æ•¸', 'ç«¶æ‹å€æ•¸', 'è¶…é¡èªè³¼', 'è¶…é¡å€æ•¸'], 
    'rating': ['ä¿¡è©•', 'TCRI'],
    'guarantee': ['æ“”ä¿', 'æœ‰ç„¡æ“”ä¿']
};

let auctionRawData = [], cbDatabase = {}, statistics = { 'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} } };
let globalMarketStats = { low: 0, avg: 0 };

function normalizeKeys(obj) { const n={}; Object.keys(obj).forEach(k=>n[k.trim()]=obj[k]); return n; }
function getSmartValue(row, key) { if(!FIELD_ALIASES[key]) return undefined; for(let a of FIELD_ALIASES[key]) if(row[a]!==undefined) return row[a]; return undefined; }
function safeFloat(v) { const n=parseFloat(v); return isNaN(n)?0:n; }
function safeFixed(v,d=2) { const n=parseFloat(v); return isNaN(n)?'-':n.toFixed(d); }

// ==========================================
// 2. è³‡æ–™è¼‰å…¥
// ==========================================
async function loadData() {
    try {
        const res = await fetch('00_CB.xlsx');
        if(!res.ok) throw new Error("è®€å– Excel å¤±æ•—");
        const wb = XLSX.read(await res.arrayBuffer(), {type:'array'});
        
        const shAuc = wb.SheetNames.find(n => n.includes('04') || n.includes('ç«¶æ‹'));
        const shHl = wb.SheetNames.find(n => n.includes('00') || n.includes('æ›ç‰Œ'));
        
        const rawAuc = XLSX.utils.sheet_to_json(wb.Sheets[shAuc]);
        const rawHl = shHl ? XLSX.utils.sheet_to_json(wb.Sheets[shHl]) : [];
        const hlMap = {};
        
        rawHl.forEach(r => {
            const n = normalizeKeys(r);
            const id = String(n['ä»£è™Ÿ']||n['CBä»£è™Ÿ']||'').trim().replace('.0','');
            if(id) hlMap[id] = n;
        });

        auctionRawData = rawAuc.map(r => {
            const row = normalizeKeys(r);
            const id = String(row['ä»£è™Ÿ']||row['CBä»£è™Ÿ']||'').trim().replace('.0','');
            if(!id) return null;
            
            const hl = hlMap[id] || {};
            let lp = safeFloat(getSmartValue(row, 'lowPremium'));
            let ap = safeFloat(getSmartValue(row, 'avgPremium'));
            if(Math.abs(lp)<2 && lp!==0) lp*=100;
            if(Math.abs(ap)<2 && ap!==0) ap*=100;
            
            let dateVal = getSmartValue(row, 'issueDate');
            if(typeof dateVal === 'number') {
                const dateObj = XLSX.SSF.parse_date_code(dateVal);
                dateVal = `${dateObj.y}/${dateObj.m}/${dateObj.d}`;
            }

            return {
                id, name: getSmartValue(row, 'name'), 
                industry: getSmartValue(row, 'industry'), broker: getSmartValue(row, 'broker'),
                capital: safeFloat(getSmartValue(row, 'capital')), issueSize: safeFloat(getSmartValue(row, 'issueSize')),
                minBid: safeFloat(getSmartValue(row, 'minBidPrice')), avgBid: safeFloat(getSmartValue(row, 'avgBidPrice')),
                lowPrem: lp, avgPrem: ap,
                mkHigh: safeFloat(getSmartValue(hl, 'marketHigh')), mkLow: safeFloat(getSmartValue(hl, 'marketLow')),
                date: dateVal || '-',
                multiplier: safeFloat(getSmartValue(row, 'bidMultiplier')),
                rating: getSmartValue(row, 'rating'),
                guarantee: getSmartValue(row, 'guarantee'),
                conversionPrice: safeFloat(getSmartValue(row, 'conversionPrice')),
                years: getSmartValue(row, 'years')
            };
        }).filter(x=>x && x.minBid>0);

        let sumL=0, sumA=0;
        auctionRawData.forEach(d => {
            cbDatabase[d.name] = d;
            sumL+=d.lowPrem; sumA+=d.avgPrem;
            ['industry','broker'].forEach(k => {
                const val = d[k]; if(!val) return;
                const cat = k==='industry'?'ç”¢æ¥­':'ç™¼è¡Œåˆ¸å•†';
                if(!statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val]) statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val] = {c:0, sL:0, sA:0};
                statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val].c++;
                statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val].sL+=d.lowPrem;
                statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val].sA+=d.avgPrem;
            });
        });
        if(auctionRawData.length>0) { globalMarketStats.low = sumL/auctionRawData.length; globalMarketStats.avg = sumA/auctionRawData.length; }

        initUI();
        document.getElementById('loading').style.display='none';
        document.querySelector('.container').style.display='block';

    } catch(e) {
        alert("ç³»çµ±å•Ÿå‹•å¤±æ•—: " + e.message);
    }
}

// ==========================================
// 3. UI äº’å‹•é‚è¼¯ (ä¿®å¾©æ ¸å¿ƒï¼šæ‰¾å› v3.48 çš„å¡ç‰‡)
// ==========================================
function getRangeLabel(category, val) {
    const v = parseFloat(val);
    if (isNaN(v)) return val;
    if (category === 'è‚¡æœ¬') {
        if (v < 3) return "å°æ–¼ 3 å„„";
        if (v < 6) return "3 ~ 6 å„„";
        if (v < 10) return "6 ~ 10 å„„";
        if (v < 15) return "10 ~ 15 å„„";
        if (v < 20) return "15 ~ 20 å„„";
        return "å¤§æ–¼ 20 å„„";
    }
    if (category === 'ç™¼è¡Œè¦æ¨¡') {
        if (v < 2) return "å°æ–¼ 2 å„„";
        if (v < 5) return "2 ~ 5 å„„";
        if (v < 10) return "5 ~ 10 å„„";
        if (v < 15) return "10 ~ 15 å„„";
        if (v < 20) return "15 ~ 20 å„„";
        return "å¤§æ–¼ 20 å„„";
    }
    if (category === 'è½‰æ›åƒ¹') {
        if (v < 20) return "å°æ–¼ 20 å…ƒ";
        if (v < 50) return "20 ~ 50 å…ƒ";
        if (v < 100) return "50 ~ 100 å…ƒ";
        if (v < 150) return "100 ~ 150 å…ƒ";
        if (v < 200) return "150 ~ 200 å…ƒ";
        return "å¤§æ–¼ 200 å…ƒ";
    }
    return val;
}

function generateStandardCard(data, titleOverride) {
    // é€™æ˜¯ v3.48 çš„ç¶“å…¸å¡ç‰‡ HTML ç”¢ç”Ÿå™¨
    if (!data || data.count === 0) return `<div class="stat-row" style="color:#999;">æŸ¥ç„¡è³‡æ–™ (å·²ä½¿ç”¨å…¨å¸‚å ´å‡å€¼)</div>`;
    
    const title = titleOverride || 'æ­·å²çµ±è¨ˆ';
    let html = `<div class="stats-header">ğŸ“Š ${title}</div>`;
    html += `<div class="stat-row" style="color:#555; font-weight:bold; margin-bottom:8px;">æ¨£æœ¬æ•¸: ${data.count} æª”</div>`;
    
    html += `<div style="background:#f1f8e9; padding:8px; border-radius:5px; margin-bottom:8px;">
    <div class="stat-row"><span class="stat-label">ğŸ“‰ å¹³å‡æœ€ä½æº¢åƒ¹:</span><span class="stat-value">${safeFixed(data.low)}%</span></div>
    <div class="stat-row"><span class="stat-label">âš–ï¸ å¹³å‡å¾—æ¨™æº¢åƒ¹:</span><span class="stat-value">${safeFixed(data.avg)}%</span></div>
    </div>`;
    return html;
}

function initUI() {
    document.getElementById('headerSubtitle').textContent = `è³‡æ–™åº«å°±ç·’ (æ¨£æœ¬æ•¸: ${auctionRawData.length})`;
    document.getElementById('statsSummary').textContent = `ç›®å‰è³‡æ–™åº«æ”¶éŒ„ ${auctionRawData.length} ç­†å®Œæ•´ç«¶æ‹æ•¸æ“š`;
    
    // å¡«å……é¸å–®
    const fill = (id, obj) => {
        const s=document.getElementById(id);
        Object.keys(obj).sort((a,b)=>obj[b].c-obj[a].c).forEach(k=>{
            s.add(new Option(`${k} (${obj[k].c})`, k));
        });
    };
    fill('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']);
    fill('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);

    // 1. CBåç¨±ï¼šä¿ç•™åŸæœ¬é‚è¼¯ï¼Œæ–°å¢æ­·å²æœå°‹
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim(); 
        const histDiv = document.getElementById('historyResults');
        const infoDiv = document.getElementById('cbNameInfo');
        
        // A. æ­·å²æœå°‹ (v3.50 åŠŸèƒ½)
        if(val.length >= 2) {
             const cleanVal = val.replace(/[0-9]/g, '');
             const matches = auctionRawData.filter(d => d.id.startsWith(val) || (cleanVal.length>1 && d.name.includes(cleanVal))).sort((a,b) => b.id.localeCompare(a.id));
             
             if(matches.length > 0) {
                 histDiv.innerHTML = `<div style="font-weight:900; color:#6a1b9a; margin-bottom:8px; border-bottom:1px solid #ddd; padding-bottom:5px;">ğŸ” ç›¸é—œæ­·å²è³‡æ–™ (å…±${matches.length}ç­†)</div>` + 
                 matches.map(d => `
                    <div class="history-item">
                        <div class="history-row">
                            <div><span class="h-tag">${d.date}</span> <span style="font-size:16px; font-weight:900; color:#1A237E;">${d.name} (${d.id})</span></div>
                            <div class="h-tag" style="background:${d.multiplier>3?'#ffebee':'#f5f5f5'}; color:${d.multiplier>3?'#c62828':'#555'}">æŠ•æ¨™å€æ•¸: ${d.multiplier}x</div>
                        </div>
                        <div class="history-row">
                            <span class="h-label">è¦æ¨¡: <b class="h-val">${d.issueSize}å„„</b></span>
                            <span class="h-label">è©•ç­‰: <b class="h-val">${d.rating}</b></span>
                            <span class="h-label">ç”¢æ¥­: <b class="h-val">${d.industry}</b></span>
                        </div>
                        <div class="history-row" style="background:#f9f9f9; padding:5px; border-radius:4px;">
                            <span class="h-label">æœ€ä½æº¢åƒ¹: <b class="h-val" style="color:#2e7d32">${safeFixed(d.lowPrem)}%</b></span>
                            <span class="h-label">å¹³å‡æº¢åƒ¹: <b class="h-val" style="color:#2e7d32">${safeFixed(d.avgPrem)}%</b></span>
                        </div>
                        <div class="history-row" style="margin-top:4px;">
                            <span class="h-label">æ›ç‰Œé«˜: ${safeFixed(d.mkHigh)}</span>
                            <span class="h-label">æ›ç‰Œä½: ${safeFixed(d.mkLow)}</span>
                        </div>
                    </div>`).join('');
                 histDiv.style.display = 'block';
             } else {
                 histDiv.style.display = 'none';
             }
        } else {
            histDiv.style.display = 'none';
        }

        // B. è³‡è¨Šå¡ (v3.48 åŠŸèƒ½)
        if (!val) { infoDiv.style.display='none'; return; }
        const found = cbDatabase[val] || Object.values(cbDatabase).find(d => d.name === val);
        if (found) {
            infoDiv.innerHTML = `<div class="stats-header">ğŸ“Š æ­·å²: ${found.name}</div>
            <div class="stat-row">æŠ•æ¨™å€æ•¸: ${found.multiplier}å€</div>
            <div class="stat-row">æœ€ä½/å¹³å‡æº¢åƒ¹: ${safeFixed(found.lowPrem)}% / ${safeFixed(found.avgPrem)}%</div>`;
            infoDiv.style.display='block';
        } else infoDiv.style.display='none';
    });

    // 2. ç¶å®šå…¶ä»–æ¬„ä½ (ä¿®å¾©ï¼šä½¿ç”¨ generateStandardCard)
    const bind = (id, cat) => {
        const handler = function() {
            const rawVal = this.value;
            const val = parseFloat(rawVal) || rawVal;
            if (val) {
                let displayTitle = val;
                // ä½¿ç”¨ RangeLabel è®“æ¨™é¡Œè®Šå›ä¸­æ–‡ (å¦‚ "å°æ–¼3å„„")
                if(['è‚¡æœ¬','ç™¼è¡Œè¦æ¨¡','è½‰æ›åƒ¹'].includes(cat)) {
                     displayTitle = getRangeLabel(cat, val);
                }
                const smartResult = getStats(cat, val);
                // å‘¼å« v3.48 çš„å¡ç‰‡ç”Ÿæˆå™¨
                const box = document.getElementById(id+'Info');
                box.innerHTML = generateStandardCard(smartResult, `å€é–“çµ±è¨ˆ: ${displayTitle}`);
                box.style.display = 'block';
            }
        };
        const el = document.getElementById(id); 
        el.addEventListener('change', handler); 
        if(el.tagName==='INPUT') el.addEventListener('input', handler);
    };
    
    // é‡æ–°ç¶å®šæ‰€æœ‰è¼¸å…¥æ¡†
    ['capital','issueSize','conversionPrice','industry','broker','years','guarantee','rating'].forEach(k => bind(k, k==='capital'?'è‚¡æœ¬':k==='issueSize'?'ç™¼è¡Œè¦æ¨¡':k==='conversionPrice'?'è½‰æ›åƒ¹':k==='industry'?'ç”¢æ¥­':k==='broker'?'ç™¼è¡Œåˆ¸å•†':k==='years'?'å¹´æœŸ':k==='guarantee'?'æ“”ä¿':'ä¿¡è©•'));
}

// ==========================================
// 4. è¨ˆç®—èˆ‡æŸ¥è©¢
// ==========================================
function getStats(cat, val) {
    let list = [], label = val;
    const v = parseFloat(val);

    if(cat==='è‚¡æœ¬') {
        if(v<3) { label='< 3å„„'; list=auctionRawData.filter(d=>d.capital<3); }
        else if(v<6) { label='3~6å„„'; list=auctionRawData.filter(d=>d.capital>=3 && d.capital<6); }
        else if(v<10) { label='6~10å„„'; list=auctionRawData.filter(d=>d.capital>=6 && d.capital<10); }
        else if(v<15) { label='10~15å„„'; list=auctionRawData.filter(d=>d.capital>=10 && d.capital<15); }
        else if(v<20) { label='15~20å„„'; list=auctionRawData.filter(d=>d.capital>=15 && d.capital<20); }
        else { label='> 20å„„'; list=auctionRawData.filter(d=>d.capital>=20); }
    } else if(cat==='ç™¼è¡Œè¦æ¨¡') {
        if(v<2) { label='< 2å„„'; list=auctionRawData.filter(d=>d.issueSize<2); }
        else if(v<5) { label='2~5å„„'; list=auctionRawData.filter(d=>d.issueSize>=2 && d.issueSize<5); }
        else if(v<10) { label='5~10å„„'; list=auctionRawData.filter(d=>d.issueSize>=5 && d.issueSize<10); }
        else if(v<15) { label='10~15å„„'; list=auctionRawData.filter(d=>d.issueSize>=10 && d.issueSize<15); }
        else if(v<20) { label='15~20å„„'; list=auctionRawData.filter(d=>d.issueSize>=15 && d.issueSize<20); }
        else { label='> 20å„„'; list=auctionRawData.filter(d=>d.issueSize>=20); }
    } else if(cat==='è½‰æ›åƒ¹') {
        if(v<20) { label='<20å…ƒ'; list=auctionRawData.filter(d=>d.conversionPrice<20); }
        else if(v<50) { label='20~50å…ƒ'; list=auctionRawData.filter(d=>d.conversionPrice>=20 && d.conversionPrice<50); }
        else if(v<100) { label='50~100å…ƒ'; list=auctionRawData.filter(d=>d.conversionPrice>=50 && d.conversionPrice<100); }
        else { label='>100å…ƒ'; list=auctionRawData.filter(d=>d.conversionPrice>=100); }
    } else {
        if(cat==='ç”¢æ¥­') list = auctionRawData.filter(d=>d.industry===val);
        else if(cat==='ç™¼è¡Œåˆ¸å•†') list = auctionRawData.filter(d=>(d.broker||'').includes(val));
        else if(cat==='ä¿¡è©•') list = auctionRawData.filter(d=>String(d.rating).includes(val));
        else if(cat==='æ“”ä¿') list = auctionRawData.filter(d=>(d.guarantee||'').includes(val));
        else if(cat==='å¹´æœŸ') list = auctionRawData.filter(d=>d.years==val);
    }

    if(list.length > 0) {
        const avgL = list.reduce((s,i)=>s+i.lowPrem,0)/list.length;
        const avgA = list.reduce((s,i)=>s+i.avgPrem,0)/list.length;
        return { low: avgL, avg: avgA, label: label, count: list.length };
    }
    return { low: globalMarketStats.low, avg: globalMarketStats.avg, label: label, count: 0 };
}

// ==========================================
// 5. çµæœé¡¯ç¤º (v3.50 å„ªåŒ–è¡¨æ ¼èˆ‡å…¬å¼)
// ==========================================
function displayResult(res) {
    document.getElementById('welcomeMsg').style.display = 'none';
    const div = document.getElementById('evaluationResult');
    div.style.display = 'block';

    let tableRows = '';
    let totalDimLow = 0, totalDimAvg = 0;
    
    res.details.forEach(d => {
        totalDimLow += d.stats.low;
        totalDimAvg += d.stats.avg;
        
        tableRows += `<tr>
            <td>${d.name}</td>
            <td>${d.displayVal}</td>
            <td>${safeFixed(d.stats.low)}%</td>
            <td>${safeFixed(d.stats.avg)}%</td>
            <td>${(d.weight*100).toFixed(0)}%</td>
            <td style="color:#1A237E; font-weight:bold;">${safeFixed(d.wLow)}</td>
            <td style="color:#1A237E; font-weight:bold;">${safeFixed(d.wAvg)}</td>
        </tr>`;
    });
    
    const dimCount = res.details.length;
    const avgDimLow = totalDimLow / dimCount; 
    const avgDimAvg = totalDimAvg / dimCount;

    if(res.subW > 0) {
        tableRows += `<tr style="background:#fff3e0;">
            <td style="color:#e65100;">ä¸»è§€</td>
            <td>è‡ªè¨‚</td>
            <td>${res.subL}%</td>
            <td>${res.subA}%</td>
            <td>${res.subW}%</td>
            <td style="color:#e65100; font-weight:bold;">${res.wSubL.toFixed(2)}</td>
            <td style="color:#e65100; font-weight:bold;">${res.wSubA.toFixed(2)}</td>
        </tr>`;
    }

    const tHTML = `
    <div class="result-header">
        <h2>${res.name}</h2>
        <div style="font-size:22px; margin-top:15px; font-weight:bold;">ç†è«–åƒ¹æ ¼ï¼š${res.theoPrice} å…ƒ</div>
    </div>

    <div style="background:white; padding:25px; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
        <h3 style="color:#1A237E; border-bottom:3px solid #1A237E; padding-bottom:12px; margin-bottom:20px; font-size:24px; font-weight:900;">ğŸ“Š ç¶­åº¦æ¬Šé‡åˆ†æ</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ç¶­åº¦</th>
                    <th>çµ„åˆæ¢ä»¶</th>
                    <th>æœ€ä½<br>æº¢åƒ¹</th>
                    <th>å¹³å‡<br>æº¢åƒ¹</th>
                    <th>åŠ æ¬Š<br>æ¯”é‡</th>
                    <th>åŠ æ¬Š<br>æœ€ä½</th>
                    <th>åŠ æ¬Š<br>å¹³å‡</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
            <tfoot>
                <tr>
                    <td>å¹³å‡</td>
                    <td style="text-align:right;"></td>
                    <td style="text-align:right;">${safeFixed(avgDimLow)}%</td>
                    <td style="text-align:right;">${safeFixed(avgDimAvg)}%</td>
                    <td style="text-align:center;">100%</td>
                    <td style="text-align:right;">${res.finalLow}%</td>
                    <td style="text-align:right;">${res.finalAvg}%</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div style="margin-top:40px;">
        <h3 style="color:#1A237E; border-left:6px solid #1A237E; padding-left:15px; font-size:24px; font-weight:900; margin-bottom:20px;">ğŸ’¡ æŠ•æ¨™å»ºè­°åƒ¹æ ¼</h3>
        <div class="price-grid">
            <div class="strategy-card" style="border-color:#4CAF50; background:#E8F5E9;">
                <h4 style="color:#2E7D32;">ğŸ›¡ï¸ ä¿å®ˆä½ˆå±€</h4>
                <div class="price">${res.prices.p1}</div>
                <div class="formula">ç†è«–åƒ¹ Ã— (1 + åŠ æ¬Šæœ€ä½%)</div>
                <div style="color:#444; margin-top:5px; font-size:14px;">å®‰å…¨é‚Šéš›å„ªå…ˆ</div>
            </div>
            <div class="strategy-card" style="border-color:#FF9800; background:#FFF3E0;">
                <h4 style="color:#EF6C00;">âš–ï¸ å¹³è¡¡ç­–ç•¥</h4>
                <div class="price">${res.prices.p2}</div>
                <div class="formula">ç†è«–åƒ¹ Ã— (1 + åŠ æ¬Šå¹³å‡%)</div>
                <div style="color:#444; margin-top:5px; font-size:14px;">è²¼è¿‘å¸‚å ´å‡å€¼</div>
            </div>
            <div class="strategy-card" style="border-color:#F44336; background:#FFEBEE;">
                <h4 style="color:#C62828;">ğŸš€ ç©æ¥µæ¶æ¨™</h4>
                <div class="price">${res.prices.p3}</div>
                <div class="formula">ç†è«–åƒ¹ Ã— (1 + å‡æº¢ + åƒ¹å·®)</div>
                <div style="color:#444; margin-top:5px; font-size:14px;">æé«˜å¾—æ¨™ç‡</div>
            </div>
            <div class="strategy-card" style="border-color:#9C27B0; background:#F3E5F5;">
                <h4 style="color:#6A1B9A;">ğŸ”¥ æ¥µè‡´åƒ¹æ ¼</h4>
                <div class="price">${res.prices.p4}</div>
                <div class="formula">ç†è«–åƒ¹ Ã— (1 + å‡æº¢ + 2å€åƒ¹å·®)</div>
                <div style="color:#444; margin-top:5px; font-size:14px;">ç†±é–€æ¨™çš„é©ç”¨</div>
            </div>
        </div>
    </div>
    
    <div style="margin-top:30px; text-align:right; font-size:14px; color:#666;">
        *åƒ¹å·® = åŠ æ¬Šå¹³å‡æº¢åƒ¹ - åŠ æ¬Šæœ€ä½æº¢åƒ¹
    </div>
    
    <button onclick="window.print()" class="calculate-btn" style="margin-top:30px; background:#555;">ğŸ–¨ï¸ åˆ—å°å ±å‘Š</button>
    `;

    div.innerHTML = tHTML;
    div.scrollIntoView({behavior:'smooth'});
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const getVal = (id) => document.getElementById(id).value;
    const getNum = (id) => parseFloat(document.getElementById(id).value)||0;

    const data = {
        name: getVal('cbName'),
        stock: getNum('stockPrice'), conv: getNum('conversionPrice'),
        subW: getNum('subjectiveWeight'), subL: getNum('subjectiveLowPremium'), subA: getNum('subjectiveAvgPremium')
    };

    const dims = [
        {k:'industry', n:'ç”¢æ¥­', v:getVal('industry'), w:0.25},
        {k:'broker', n:'åˆ¸å•†', v:getVal('broker'), w:0.13},
        {k:'capital', n:'è‚¡æœ¬', v:getNum('capital'), w:0.12},
        {k:'issueSize', n:'è¦æ¨¡', v:getNum('issueSize'), w:0.10},
        {k:'rating', n:'ä¿¡è©•', v:getVal('rating'), w:0.15},
        {k:'guarantee', n:'æ“”ä¿', v:getVal('guarantee'), w:0.12},
        {k:'years', n:'å¹´æœŸ', v:getVal('years'), w:0.08},
        {k:'conv', n:'è½‰åƒ¹', v:getNum('conversionPrice'), w:0.05}
    ];

    let sumWL=0, sumWA=0;
    const details = dims.map(d => {
        const s = getStats(d.n, d.v);
        const wL = s.low * d.w;
        const wA = s.avg * d.w;
        sumWL += wL; sumWA += wA;
        return { name:d.n, displayVal:s.label||d.v, stats:s, weight:d.w, wLow:wL, wAvg:wA };
    });

    const sR = data.subW/100;
    const oR = 1 - sR;
    const wSubL = data.subL * sR;
    const wSubA = data.subA * sR;
    
    const finalL = (sumWL * oR) + wSubL;
    const finalA = (sumWA * oR) + wSubA;
    const theo = (data.stock / data.conv) * 100;
    
    displayResult({
        name: data.name, theoPrice: safeFixed(theo),
        details: details,
        subW: data.subW, subL: data.subL, subA: data.subA, wSubL: wSubL, wSubA: wSubA,
        finalLow: safeFixed(finalL), finalAvg: safeFixed(finalA),
        prices: {
            p1: safeFixed(theo*(1+finalL/100)),
            p2: safeFixed(theo*(1+finalA/100)),
            p3: safeFixed(theo*(1+(finalA + (finalA-finalL))/100)),
            p4: safeFixed(theo*(1+(finalA + (finalA-finalL)*2)/100))
        }
    });
});

window.onload = loadData;
</script>
</body>
</html>
