<!DOCTYPE html>

<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.97-zs-b (æ•ˆèƒ½å„ªåŒ–ç‰ˆ)</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
/* ================= é¢¨æ ¼è¨­å®š ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1600px; margin: 0 auto; }
.header { background: white; border-radius: 15px; padding: 25px 30px; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 2px solid rgba(102, 126, 234, 0.3); border-left: 6px solid #E91E63; width: 100%; box-sizing: border-box; }
.header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; font-weight: 900; }
.header .subtitle { color: #666; font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; flex-wrap: wrap; }
.version-badge { display: inline-block; background: #7B1FA2; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; margin: 8px 0 12px 0; }

.evaluation-container { display: grid; grid-template-columns: 380px 8px 1fr; gap: 0; width: 100%; }
.resizer { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: col-resize; position: relative; border-radius: 4px; transition: background 0.2s; }
.resizer:hover { background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%); }
.resizer::before { content: "â‹®"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 18px; font-weight: bold; }
.input-panel { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); position: sticky; top: 20px; border: 2px solid rgba(102, 126, 234, 0.3); border-left: 6px solid #667eea; box-sizing: border-box; max-height: calc(100vh - 40px); overflow-y: auto; }
.input-panel::-webkit-scrollbar { width: 8px; }
.input-panel::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
.input-panel::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; }
.input-panel::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%); }
.input-panel h2 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid #667eea; font-weight: 800; }
.form-section { margin-bottom: 20px; }
.form-section h3 { color: #333; font-size: 15px; margin-bottom: 12px; font-weight: bold; border-left: 4px solid #667eea; padding-left: 10px; }
.form-group { margin-bottom: 12px; }
.form-group label { display: block; color: #555; font-size: 13px; margin-bottom: 6px; font-weight: 700; }
.form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; font-weight: 600; color:#333; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; background: #fcfdff; }

/* ===== v3.81 æ–°å¢ï¼šä¸‰å¤§åŠŸèƒ½å€å¡Šåˆ†éš”æ¨£å¼ ===== */
.zone-divider {
    display: flex;
    align-items: center;
    margin: 25px 0 20px 0;
    gap: 10px;
}
.zone-divider::before,
.zone-divider::after {
    content: "";
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, transparent, #667eea, transparent);
}
.zone-title {
    font-size: 16px;
    font-weight: 900;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    white-space: nowrap;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}
.zone-title.zone-input { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.zone-title.zone-ai { background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); }
.zone-title.zone-market { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }

/* å€å¡Šå®¹å™¨æ¨£å¼ */
.zone-container {
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}
.zone-container.zone-input-box {
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
    border: 1px solid rgba(102, 126, 234, 0.2);
}
.zone-container.zone-ai-box {
    background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
    border: 2px solid #00bcd4;
}
.zone-container.zone-market-box {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 2px solid #ff9800;
}

/* å³å´é¢æ¿å€å¡Šæ¨™é¡Œ */
.panel-zone-header {
    font-size: 18px;
    font-weight: 900;
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    margin: 25px 0 15px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}
.panel-zone-header.trend-zone { background: linear-gradient(135deg, #3f51b5 0%, #303f9f 100%); }
.panel-zone-header.stats-zone { background: linear-gradient(135deg, #009688 0%, #00796b 100%); }
.panel-zone-header.perf-zone { background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); }

/* ===== v3.81 æ–°å¢ï¼šä¸»å€å¡Šåˆ†éš”æ¨£å¼ ===== */
.main-section {
    margin-bottom: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
}
.main-section-header {
    padding: 12px 15px;
    font-size: 16px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s;
}
.main-section-header:hover {
    filter: brightness(0.95);
}
.main-section-header .toggle-icon {
    margin-left: auto;
    font-size: 12px;
    transition: transform 0.3s;
}
.main-section-header.collapsed .toggle-icon {
    transform: rotate(-90deg);
}
.main-section-content {
    padding: 15px;
    background: white;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    overflow: hidden;
}
.main-section-content.collapsed {
    max-height: 0 !important;
    padding-top: 0;
    padding-bottom: 0;
}

/* å€å¡Šä¸€ï¼šç«¶æ‹æ¢ä»¶è¼¸å…¥ - è—è‰²ç³» */
.section-input { border-color: #667eea; }
.section-input .main-section-header { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: white; 
}

/* å€å¡ŠäºŒï¼šAIæ™ºèƒ½è©•ä¼° - ç´«è‰²ç³» */
.section-ai { border-color: #9c27b0; }
.section-ai .main-section-header { 
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); 
    color: white; 
}

/* å€å¡Šä¸‰ï¼šå¸‚å ´æº«åº¦è¨ˆ - ç¶ è‰²ç³» */
.section-market { border-color: #4caf50; }
.section-market .main-section-header { 
    background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); 
    color: white; 
}

/* å³å´é¢æ¿å€å¡Šæ¨£å¼ */
.right-section {
    margin-bottom: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    background: white;
}
.right-section-header {
    padding: 15px 20px;
    font-size: 16px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s;
}
.right-section-header:hover {
    filter: brightness(0.95);
}
.right-section-header .toggle-icon {
    margin-left: auto;
    font-size: 14px;
    transition: transform 0.3s;
}
.right-section-header.collapsed .toggle-icon {
    transform: rotate(-90deg);
}
.right-section-content {
    padding: 20px;
    background: white;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    overflow-y: auto;
    max-height: 800px; /* å±•é–‹å¾Œçš„æœ€å¤§é«˜åº¦ï¼Œå¯æ»¾å‹• */
}
.right-section-content.collapsed {
    max-height: 0 !important;
    padding-top: 0;
    padding-bottom: 0;
    overflow: hidden;
}

/* å³å´å€å¡Šä¸€ï¼šå¸‚å ´è¶¨å‹¢åˆ†æ - è—è‰²ç³» */
.section-trend { border-color: #1976d2; }
.section-trend .right-section-header { 
    background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%); 
    color: white; 
}

/* å³å´å€å¡ŠäºŒï¼šç¸¾æ•ˆåˆ†æ - ç¶ è‰²ç³» */
.section-performance { border-color: #4caf50; }
.section-performance .right-section-header { 
    background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); 
    color: white; 
}

/* å³å´å€å¡Šä¸‰ï¼šåŸºæœ¬è³‡æ–™æŸ¥è©¢ - æ©˜è‰²ç³» */
.section-basic-info { border-color: #ff9800; }
.section-basic-info .right-section-header { 
    background: linear-gradient(135deg, #ff9800 0%, #e65100 100%); 
    color: white; 
}

/* å³å´å€å¡Šå››ï¼šåƒ¹æ ¼èµ°å‹¢åˆ†æ - ç´«è‰²ç³» */
.section-price-trend { border-color: #9c27b0; }
.section-price-trend .right-section-header { 
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); 
    color: white; 
}

/* åŸºæœ¬è³‡æ–™æŸ¥è©¢æ¨™ç±¤æ¨£å¼ */
.basic-info-tabs {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 0;
    background: #fff3e0;
    padding: 8px;
    border-radius: 8px 8px 0 0;
    border: 1px solid #ffcc80;
    border-bottom: none;
}
.basic-info-tab {
    padding: 8px 12px;
    border: none;
    background: #ffe0b2;
    color: #e65100;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}
.basic-info-tab:hover {
    background: #ffcc80;
}
.basic-info-tab.active {
    background: #ff9800;
    color: white;
}

/* åƒ¹æ ¼èµ°å‹¢æ¨™ç±¤æ¨£å¼ */
.price-trend-tabs {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 0;
    background: #f3e5f5;
    padding: 8px;
    border-radius: 8px 8px 0 0;
    border: 1px solid #ce93d8;
    border-bottom: none;
}
.price-trend-tab {
    padding: 8px 12px;
    border: none;
    background: #e1bee7;
    color: #7b1fa2;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}
.price-trend-tab:hover {
    background: #ce93d8;
}
.price-trend-tab.active {
    background: #9c27b0;
    color: white;
}

/* è³‡è¨Šå¡ç‰‡ */
.info-box { background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 5px solid #4CAF50; margin-top: 8px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); animation: slideDown 0.3s ease-out; }
.tip-300 { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); padding: 10px 12px; border-radius: 8px; border-left: 4px solid #8b5cf6; margin-top: 6px; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); animation: slideDown 0.3s ease-out; }
.tip-300 .tip-title { font-weight: bold; color: #6d28d9; margin-bottom: 4px; }
.tip-300 .tip-stats { display: flex; gap: 12px; flex-wrap: wrap; color: #4c1d95; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* ===== æ­·å²æœå°‹çµæœå¡ç‰‡ (v3.52 æ¢ä»¶è©•ä¼°ç‰ˆ) ===== */
.history-results { 
    margin-top: 10px; 
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border: 2px solid #9c27b0; 
    border-radius: 12px; 
    padding: 12px; 
    display: none; 
    max-height: 620px; 
    overflow-y: auto;
}
.history-results-title {
    font-size: 16px;
    font-weight: bold;
    color: #6a1b9a;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* è©¢åœˆæ¡ˆä¾‹ç°¡å–®å¡ç‰‡ - å–®è¡Œç·Šæ¹Šç‰ˆ */
.inquiry-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 1px solid #64b5f6;
    border-radius: 8px;
    margin-bottom: 8px;
    padding: 10px 14px;
    font-size: 14px;
}
.inquiry-card .hc-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}
.inquiry-card .hc-badge {
    background: #1976d2;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.inquiry-card .hc-name {
    font-weight: 700;
    color: #1565c0;
    font-size: 15px;
}
.inquiry-card .hc-line {
    display: flex;
    flex-wrap: wrap;
    gap: 5px 14px;
    margin-bottom: 8px;
}
.inquiry-card .hc-info {
    font-size: 13px;
    color: #444;
    white-space: nowrap;
}
.inquiry-card .hc-info b {
    color: #222;
}
.inquiry-card .hc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 8px;
}
.inquiry-card .hc-table th {
    background: #e3f2fd;
    color: #1565c0;
    padding: 6px 5px;
    font-size: 12px;
    font-weight: 700;
}
.inquiry-card .hc-table td {
    padding: 6px 5px;
    text-align: center;
    border-bottom: 1px solid #bbdefb;
    font-size: 13px;
}
.inquiry-badge {
    background: #1976d2;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.inquiry-name {
    font-weight: 700;
    color: #1565c0;
    font-size: 15px;
}
.inquiry-info {
    color: #444;
    white-space: nowrap;
    font-size: 13px;
}
.inquiry-info b {
    color: #222;
}
.inquiry-info b.pink {
    color: #E91E63;
}

/* å–®ç­†æ­·å²å¡ç‰‡(ç«¶æ‹) - ç·Šæ¹Šç‰ˆ */
.history-card { 
    background: #f3e5f5; 
    padding: 10px 14px; 
    border-radius: 8px; 
    margin-bottom: 8px; 
    border: 1px solid #ba68c8;
    font-size: 14px;
}
.history-card:last-child { margin-bottom: 0; }

/* å¡ç‰‡æ¨™é¡Œåˆ— */
.hc-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}
.hc-badge {
    background: #9C27B0;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.hc-name {
    font-weight: 700;
    color: #6a1b9a;
    flex: 1;
    font-size: 15px;
}
.hc-date {
    font-size: 13px;
    color: #888;
}

/* è³‡è¨Šåˆ— - æ©«å‘ç·Šæ¹Šæ’åˆ— */
.hc-line {
    display: flex;
    flex-wrap: wrap;
    gap: 5px 12px;
    margin-bottom: 8px;
}
.hc-info {
    color: #444;
    font-size: 13px;
    white-space: nowrap;
}
.hc-info b {
    color: #222;
    margin-left: 1px;
}

/* å¡ç‰‡å…§è¡¨æ ¼ - å¾—æ¨™+æ›ç‰Œåˆä½µ */
.hc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 8px;
    background: white;
    border-radius: 4px;
    overflow: hidden;
}
.hc-table th {
    background: #7B1FA2;
    color: white;
    padding: 7px 5px;
    font-weight: 700;
    text-align: center;
    font-size: 12px;
}
.hc-table td {
    padding: 7px 5px;
    text-align: center;
    border: 1px solid #e0e0e0;
    font-weight: 600;
    font-size: 13px;
}
.td-label {
    background: #f3e5f5;
    color: #6a1b9a;
    font-weight: 700;
    font-size: 12px;
}
.val-red { color: #d32f2f; font-weight: 700; }
.val-pink { color: #E91E63; font-weight: 900; }

/* è­¦ç¤ºèª */
.warning-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-top: 6px; font-size: 14px; color: #e65100; font-weight: bold; border-radius: 4px; }

/* ç¶ è‰²å¡ç‰‡å…§çš„æ›ç‰Œè¡¨æ ¼ */
.card-market-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 10px;
    border-radius: 4px;
    overflow: hidden;
}
.card-market-table th {
    background: #2e7d32;
    color: white;
    padding: 8px 6px;
    font-weight: 700;
    font-size: 13px;
    text-align: center;
}
.card-market-table td {
    padding: 8px 6px;
    text-align: center;
    border-bottom: 1px solid #c8e6c9;
    background: #f1f8e9;
    font-size: 14px;
}
.card-market-table .type-label {
    font-weight: 700;
    color: #1b5e20;
    text-align: left;
    padding-left: 10px;
    font-size: 13px;
}
.card-market-table .type-label .count {
    font-size: 12px;
    color: #666;
    margin-left: 4px;
}
.card-market-table .val-blue { font-weight: 700; color: #1565c0; }
.card-market-table .val-pink { font-weight: 700; color: #E91E63; }
.card-market-table .total-row td {
    background: #c8e6c9;
    font-weight: 900;
    border-top: 2px solid #4CAF50;
}
/* v3.52 æ–°å¢ï¼šæ’é™¤å‰ä¸‰çš„æ·ºè‰²åº• */
.card-market-table .exclude-row td {
    background: #e3f2fd;
    font-style: italic;
}

/* v3.53 æ–°å¢ï¼šç«¶æ‹å¾—æ¨™è¡¨æ ¼ */
.card-bid-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 8px;
    border-radius: 4px;
    overflow: hidden;
}
.card-bid-table th {
    background: #2e7d32;
    color: white;
    padding: 8px 5px;
    font-weight: 700;
    font-size: 13px;
    text-align: center;
}
.card-bid-table td {
    padding: 8px 5px;
    text-align: center;
    border-bottom: 1px solid #c8e6c9;
    background: #f1f8e9;
    font-weight: 600;
    font-size: 14px;
}
.card-bid-table .type-label {
    font-weight: 700;
    color: #1b5e20;
    text-align: left;
    padding-left: 8px;
    white-space: nowrap;
    font-size: 13px;
}
.card-bid-table .type-label .count {
    font-size: 11px;
    color: #666;
    margin-left: 3px;
}
.card-bid-table .val-green { font-weight: 700; color: #2e7d32; }
.card-bid-table .val-red { font-weight: 700; color: #d32f2f; }
.card-bid-table .total-row td {
    background: #c8e6c9;
    font-weight: 900;
    border-top: 2px solid #4CAF50;
}

/* v3.58 å¸‚å ´è¶¨å‹¢åˆ†ææ¨¡çµ„ */
.market-trend-section {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 2px solid #ffa000;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.market-trend-header {
    font-size: 16px;
    font-weight: bold;
    color: #e65100;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.market-trend-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.market-trend-tab {
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #ffcc80;
    color: #e65100;
}
.market-trend-tab:hover {
    background: #ffb74d;
}
.market-trend-tab.active {
    background: #ff9800;
    color: white;
}
.market-trend-content {
    background: white;
    border-radius: 8px;
    padding: 15px;
    max-height: 500px;
    overflow-y: auto;
}
.trend-table-wrapper {
    overflow-x: auto;
    margin-bottom: 12px;
}
.trend-year-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-bottom: 12px;
    min-width: 600px;
}
.trend-year-table th {
    background: #ff9800;
    color: white;
    padding: 10px 8px;
    font-weight: 700;
    text-align: center;
    font-size: 14px;
}
/* v3.96 æ–°å¢ï¼šå¯æ’åºè¡¨é ­æ¨£å¼ */
.trend-year-table th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 18px;
}
.trend-year-table th.sortable:hover {
    background: #f57c00;
}
.trend-year-table th.sortable::after {
    content: 'â‡…';
    position: absolute;
    right: 4px;
    font-size: 10px;
    opacity: 0.6;
}
.trend-year-table th.sortable.sort-asc::after {
    content: 'â–²';
    opacity: 1;
}
.trend-year-table th.sortable.sort-desc::after {
    content: 'â–¼';
    opacity: 1;
}
.trend-year-table td {
    padding: 9px 8px;
    text-align: center;
    border-bottom: 1px solid #ffe0b2;
    font-size: 14px;
}
.trend-year-table tr:hover {
    background: #fff8e1;
}
.trend-year-table .year-cell {
    font-weight: 700;
    color: #e65100;
}
.trend-year-table .amp-high {
    color: #2e7d32;
    font-weight: 700;
}
.trend-year-table .amp-low {
    color: #c62828;
    font-weight: 700;
}
.trend-year-table .total-row {
    background: #fff3e0;
    font-weight: 900;
    border-top: 2px solid #ff9800;
}
.trend-compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
}
@media (max-width: 600px) {
    .trend-compare-grid {
        grid-template-columns: 1fr;
    }
}
.trend-compare-card {
    background: #fff8e1;
    border: 1px solid #ffcc80;
    border-radius: 8px;
    padding: 14px;
}
.trend-compare-card h4 {
    font-size: 15px;
    color: #e65100;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.trend-compare-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed #ffe0b2;
    font-size: 14px;
}
.trend-compare-row:last-child {
    border-bottom: none;
}
.trend-compare-label {
    color: #555;
    font-size: 14px;
}
.trend-compare-value {
    font-weight: 700;
    font-size: 15px;
}
.trend-compare-value.positive {
    color: #2e7d32;
}
.trend-compare-value.negative {
    color: #c62828;
}
.trend-insight-box {
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
    border-left: 4px solid #e91e63;
    padding: 14px;
    margin-top: 12px;
    border-radius: 0 8px 8px 0;
    font-size: 14px;
    line-height: 1.8;
}
.trend-insight-box .insight-title {
    font-weight: 700;
    color: #ad1457;
    margin-bottom: 8px;
    font-size: 15px;
}
.trend-insight-box .insight-content {
    color: #880e4f;
    font-size: 14px;
}

/* ä¸»è§€æ¬Šé‡èªªæ˜ */
.subjective-note { background: #f5f5f5; padding: 12px; border-radius: 6px; font-size: 14px; color: #444; margin-bottom: 12px; border: 1px solid #ddd; line-height: 1.6; }

/* Footer ç‰ˆæ¬Šå®£å‘Š */
.site-footer {
    margin-top: 30px;
    padding: 20px;
    background: rgba(255,255,255,0.95);
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.footer-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.visitor-count {
    font-size: 13px;
    color: #666;
    display: flex;
    align-items: center;
    gap: 5px;
}
.copyright {
    font-size: 12px;
    color: #888;
    line-height: 1.6;
}

.stats-header { font-size: 13px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 14px; color: #333; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.stat-label { color: #555; font-weight: 500; }
.stat-value { font-weight: bold; color: #333; }

/* v3.54 å¸‚å ´ä¾›çµ¦åˆ†æå€å¡Š */
.supply-analysis {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 2px solid #ffc107;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.supply-header {
    font-size: 15px;
    font-weight: bold;
    color: #e65100;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.supply-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    background: white;
    border-radius: 6px;
    overflow: hidden;
    table-layout: fixed;
}
.supply-table th {
    background: linear-gradient(135deg, #ff9800, #ffa726);
    color: white;
    padding: 8px 4px;
    font-weight: 700;
    text-align: center;
    font-size: 10px;
    white-space: nowrap;
}
.supply-table td {
    padding: 6px 4px;
    text-align: center;
    border-bottom: 1px solid #ffe0b2;
    font-weight: 600;
    font-size: 11px;
}
.supply-table tr:hover {
    background: #fff3e0;
}
.supply-table .period-cell {
    font-weight: 700;
    color: #e65100;
    text-align: left;
    padding-left: 6px;
}
.supply-table .highlight-row {
    background: #ffebee !important;
}
.supply-table .highlight-row td {
    color: #c62828;
}
.supply-table .current-row {
    background: #e3f2fd !important;
}
.supply-table .val-high { color: #d32f2f; font-weight: 900; }
.supply-table .val-low { color: #2e7d32; font-weight: 700; }
.supply-table .val-warn { color: #ff6f00; font-weight: 700; }

.supply-warning {
    margin-top: 10px;
    padding: 10px;
    background: #ffebee;
    border-left: 4px solid #f44336;
    border-radius: 4px;
    font-size: 12px;
    color: #c62828;
    line-height: 1.5;
}
.supply-note {
    margin-top: 8px;
    font-size: 11px;
    color: #666;
    line-height: 1.4;
}

/* v3.55 å¹´åº¦ç¸¾æ•ˆæ’è¡Œå€å¡Š */
.ranking-section {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border: 2px solid #4CAF50;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.ranking-header {
    font-size: 15px;
    font-weight: bold;
    color: #2e7d32;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.ranking-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.ranking-tab {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #a5d6a7;
    color: #1b5e20;
}
.ranking-tab:hover {
    background: #81c784;
}
.ranking-tab.active {
    background: #2e7d32;
    color: white;
}
.ranking-content {
    display: none;
}
.ranking-content.active {
    display: block;
}
.ranking-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.ranking-box {
    background: white;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #c8e6c9;
}
.ranking-box.top {
    border-left: 4px solid #4CAF50;
}
.ranking-box.bottom {
    border-left: 4px solid #f44336;
}
.ranking-box-title {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.ranking-box.top .ranking-box-title {
    color: #2e7d32;
}
.ranking-box.bottom .ranking-box-title {
    color: #c62828;
}
.ranking-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}
.ranking-table th {
    background: #e8f5e9;
    color: #2e7d32;
    padding: 6px 3px;
    font-weight: 700;
    text-align: center;
    border-bottom: 1px solid #c8e6c9;
    font-size: 11px;
    white-space: nowrap;
}
.ranking-box.bottom .ranking-table th {
    background: #ffebee;
    color: #c62828;
}
.ranking-table td {
    padding: 6px 3px;
    text-align: center;
    border-bottom: 1px solid #f5f5f5;
    font-weight: 500;
    white-space: nowrap;
}
.ranking-table td:first-child {
    text-align: center;
    font-weight: 700;
}
.ranking-table td:nth-child(3) {
    text-align: left;
}
.ranking-table .rank-num {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 900;
}
.ranking-box.top .rank-num {
    background: #c8e6c9;
    color: #2e7d32;
}
.ranking-box.bottom .rank-num {
    background: #ffcdd2;
    color: #c62828;
}
.ranking-type {
    font-size: 10px;
    padding: 3px 5px;
    border-radius: 3px;
}
.ranking-type.auction {
    background: #ff9800;
    color: white;
}
.ranking-type.inquiry {
    background: #9c27b0;
    color: white;
}
.ranking-box.top .val-gain {
    color: #2e7d32;
    font-weight: 700;
}
.ranking-box.bottom .val-gain {
    color: #c62828;
    font-weight: 700;
}
.val-amp {
    color: #1565c0;
    font-weight: 600;
}
.ranking-summary {
    margin-top: 12px;
    padding: 10px;
    background: #f1f8e9;
    border-radius: 6px;
    font-size: 13px;
    color: #558b2f;
    line-height: 1.6;
}

/* v3.56 æœˆå‡æˆäº¤ç¸¾æ•ˆå€å¡Š */
.realperf-section {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #2196F3;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.realperf-header {
    font-size: 16px;
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.realperf-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}
.realperf-tab {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #90caf9;
    color: #0d47a1;
}
.realperf-tab:hover {
    background: #64b5f6;
}
.realperf-tab.active {
    background: #1565c0;
    color: white;
}
.realperf-stats {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
    margin-bottom: 12px;
}
@media (max-width: 500px) {
    .realperf-stats {
        grid-template-columns: repeat(3, 1fr);
    }
}
.realperf-stat-box {
    background: white;
    border-radius: 6px;
    padding: 10px 8px;
    text-align: center;
    border: 1px solid #90caf9;
}
.realperf-stat-box.highlight {
    border: 2px solid #1565c0;
}
.realperf-stat-label {
    font-size: 12px;
    color: #555;
    margin-bottom: 4px;
}
.realperf-stat-value {
    font-size: 17px;
    font-weight: 900;
}
.realperf-stat-value.green { color: #2e7d32; }
.realperf-stat-value.blue { color: #1565c0; }
.realperf-stat-value.gray { color: #666; }
.realperf-stat-value.orange { color: #e65100; }
.realperf-stat-value.red { color: #c62828; }

.realperf-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.realperf-box {
    background: white;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #90caf9;
}
.realperf-box.top {
    border-left: 4px solid #2e7d32;
}
.realperf-box.bottom {
    border-left: 4px solid #c62828;
}
.realperf-box-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.realperf-box.top .realperf-box-title { color: #2e7d32; }
.realperf-box.bottom .realperf-box-title { color: #c62828; }

.realperf-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}
.realperf-table th {
    background: #e3f2fd;
    color: #1565c0;
    padding: 9px 5px;
    font-weight: 700;
    text-align: center;
    border-bottom: 1px solid #90caf9;
    font-size: 13px;
}
.realperf-box.top .realperf-table th { background: #e8f5e9; color: #2e7d32; }
.realperf-box.bottom .realperf-table th { background: #ffebee; color: #c62828; }
.realperf-table td {
    padding: 8px 5px;
    text-align: center;
    border-bottom: 1px solid #f5f5f5;
    font-weight: 500;
    font-size: 14px;
}
.realperf-table td:nth-child(2) {
    text-align: left;
    max-width: 70px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.realperf-pos {
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 13px;
}
.realperf-pos.high { background: #ffcdd2; color: #c62828; }
.realperf-pos.low { background: #c8e6c9; color: #2e7d32; }

.realperf-summary {
    margin-top: 12px;
    padding: 14px;
    background: #e1f5fe;
    border-radius: 6px;
    font-size: 15px;
    color: #0277bd;
    line-height: 1.7;
}

/* v3.59 æ–°å¢ï¼šç«¶æ‹ç›ˆè™§å‹ç‡åˆ†æ */
.profitloss-section {
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
    border: 2px solid #e91e63;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.profitloss-header {
    font-size: 16px;
    font-weight: bold;
    color: #ad1457;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.profitloss-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}
.profitloss-tab {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #f48fb1;
    color: #880e4f;
}
.profitloss-tab:hover {
    background: #f06292;
}
.profitloss-tab.active {
    background: #c2185b;
    color: white;
}
.profitloss-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}
@media (max-width: 500px) {
    .profitloss-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
.profitloss-stat-box {
    background: white;
    border-radius: 8px;
    padding: 12px 10px;
    text-align: center;
    border: 1px solid #f48fb1;
}
.profitloss-stat-label {
    font-size: 12px;
    color: #555;
    margin-bottom: 5px;
}
.profitloss-stat-value {
    font-size: 18px;
    font-weight: 900;
}
.profitloss-stat-value.win { color: #c62828; }
.profitloss-stat-value.lose { color: #2e7d32; }
.profitloss-stat-value.neutral { color: #1565c0; }
.profitloss-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    background: white;
    border-radius: 6px;
    overflow: hidden;
    margin-top: 10px;
    table-layout: fixed;
}
.profitloss-table th {
    background: #c2185b;
    color: white;
    padding: 8px 4px;
    font-weight: 700;
    text-align: center;
    font-size: 11px;
    white-space: nowrap;
}
.profitloss-table td {
    padding: 7px 4px;
    text-align: center;
    border-bottom: 1px solid #fce4ec;
    font-weight: 600;
    font-size: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
}
.profitloss-table tr:hover {
    background: #fce4ec;
}
.profitloss-table .year-cell {
    font-weight: 700;
    color: #ad1457;
}
.profitloss-table .val-win { color: #c62828; font-weight: 700; }
.profitloss-table .val-lose { color: #2e7d32; font-weight: 700; }
.profitloss-insight {
    margin-top: 10px;
    padding: 12px;
    background: white;
    border-left: 4px solid #e91e63;
    border-radius: 0 8px 8px 0;
    font-size: 14px;
    line-height: 1.7;
    color: #880e4f;
}

/* v3.57 ç¶­åº¦åˆ†æç¸½è¦½ - è—ç¶ è‰²ç³» */
.dimension-section {
    background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
    border: 2px solid #009688;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.dimension-header {
    font-size: 16px;
    font-weight: bold;
    color: #00695c;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.dimension-main-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}
.dimension-main-tab {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #80cbc4;
    color: #004d40;
}
.dimension-main-tab:hover {
    background: #4db6ac;
}
.dimension-main-tab.active {
    background: #00796b;
    color: white;
}
.dimension-content {
    background: white;
    border-radius: 8px;
    padding: 15px;
}
.dimension-range-card {
    border: 1px solid #b2dfdb;
    border-radius: 8px;
    margin-bottom: 10px;
    overflow: hidden;
}
.dimension-range-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
    cursor: pointer;
    transition: background 0.2s;
}
.dimension-range-header:hover {
    background: linear-gradient(135deg, #b2dfdb 0%, #80cbc4 100%);
}
.dimension-range-title {
    font-weight: 700;
    font-size: 15px;
    color: #00695c;
    display: flex;
    align-items: center;
    gap: 8px;
}
.dimension-range-stats {
    display: flex;
    gap: 12px;
    font-size: 14px;
    color: #444;
}
.dimension-range-stats span {
    white-space: nowrap;
}
.dimension-range-stats b {
    color: #00796b;
}
.dimension-range-toggle {
    font-size: 16px;
    color: #00695c;
    transition: transform 0.3s;
}
.dimension-range-toggle.open {
    transform: rotate(180deg);
}
.dimension-range-body {
    display: none;
    padding: 12px 14px;
    background: #fff;
    border-top: 1px solid #b2dfdb;
    max-height: 300px;
    overflow-y: auto;
}
.dimension-range-body.open {
    display: block;
}
.dimension-detail-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}
.dimension-detail-table th {
    background: #e0f2f1;
    color: #00695c;
    padding: 9px 6px;
    font-weight: 700;
    text-align: center;
    border-bottom: 1px solid #b2dfdb;
    position: sticky;
    top: 0;
    font-size: 13px;
}
.dimension-detail-table td {
    padding: 8px 6px;
    text-align: center;
    border-bottom: 1px solid #e0f2f1;
    font-size: 14px;
}
.dimension-detail-table td:nth-child(2) {
    text-align: left;
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.dimension-detail-table tr:hover {
    background: #e0f2f1;
}
.dimension-type-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 700;
}
.dimension-type-badge.auction {
    background: #c8e6c9;
    color: #2e7d32;
}
.dimension-type-badge.inquiry {
    background: #fff3e0;
    color: #e65100;
}
.dimension-status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 700;
}
.dimension-status-badge.listed {
    background: #e3f2fd;
    color: #1565c0;
}
.dimension-status-badge.delisted {
    background: #f5f5f5;
    color: #9e9e9e;
}
.dimension-amp-high {
    color: #2e7d32;
    font-weight: 700;
}
.dimension-amp-low {
    color: #c62828;
    font-weight: 700;
}
.dimension-summary {
    margin-top: 12px;
    padding: 14px;
    background: #e0f2f1;
    border-radius: 6px;
    font-size: 15px;
    color: #00695c;
    line-height: 1.7;
}

.calculate-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-top: 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }

.result-panel { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); min-height: 600px; border: 2px solid rgba(102, 126, 234, 0.3); border-left: 6px solid #667eea; font-size: 15px; }
.welcome-message { text-align: center; padding: 50px 20px; }
.welcome-message h2 { font-size: 26px; margin-bottom: 15px; }
.welcome-message p { font-size: 16px !important; line-height: 1.8; }
.stats-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
.stat-box { background: #f8f9fa; padding: 12px 15px; border-radius: 8px; text-align: center; border: 1px solid #eee; transition: transform 0.3s; }
.stat-box:hover { transform: translateY(-3px); border-color: #b39ddb; }
.stat-box .number { font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 4px; }
.stat-box .label { font-size: 12px; color: #666; }

.evaluation-result { display: none; }
.evaluation-result.active { display: block; animation: fadeIn 0.5s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
.detail-section { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 2px solid #e0e0e0; }
.detail-section h3 { color: #667eea; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 20px; transition: transform 0.3s; }
.strategy-card:hover { transform: translateY(-5px); }
.strategy-card h4 { font-size: 16px; margin-bottom: 10px; }
.strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
.strategy-card.conservative h4 { color: #2e7d32; }
.strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
.strategy-card.balanced h4 { color: #e65100; }
.strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
.strategy-card.aggressive h4 { color: #c62828; }
.strategy-card.ultimate { border-color: #9C27B0; background: #f3e5f5; }
.strategy-card.ultimate h4 { color: #6a1b9a; }
.strategy-card .price { font-size: 28px; font-weight: bold; margin: 8px 0; color: #333; }

/* è¡¨æ ¼ */
.data-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
.data-table th { background-color: #1A237E; color: white; padding: 12px 6px; text-align: center; font-weight: 900; border: 1px solid #0d1b5e; vertical-align: bottom; line-height: 1.3; }
.data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #000; font-weight: 600; }
.data-table td:nth-child(n+3) { text-align: right; font-family: 'Segoe UI', monospace; }
.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tr:hover { background-color: #e8eaf6; }
.data-table tfoot td { background-color: #e8eaf6; font-weight: 900; color: #1A237E; border-top: 2px solid #3f51b5; }

.rex-analysis { background: linear-gradient(to right, #fff3e0, #ffe0b2); border-left: 6px solid #ff9800; padding: 22px; border-radius: 8px; margin-top: 25px; }
.rex-title { font-size: 20px; font-weight: bold; color: #e65100; margin-bottom: 14px; }
.rex-content { color: #5d4037; line-height: 1.9; font-size: 15px; }

@media (max-width: 1200px) { 
    .evaluation-container { grid-template-columns: 1fr !important; display: block; } 
    .resizer { display: none; }
    .input-panel { position: relative; top: 0; max-height: none; overflow-y: visible; } 
}

@media (max-width: 768px) {
    body { padding: 8px; }
    .container { width: 100%; max-width: 100%; padding: 0; margin: 0; }
    .header { padding: 18px; margin-bottom: 10px; border-radius: 12px; }
    .header h1 { font-size: 24px; margin-bottom: 8px; }
    .header .subtitle { font-size: 13px; }
    .version-badge { font-size: 12px; padding: 4px 12px; margin: 6px 0 10px 0; }
    .evaluation-container { display: block; }
    .input-panel { padding: 18px; border-radius: 12px; }
    .result-panel { padding: 18px; border-radius: 12px; margin-top: 10px; }
    .supply-analysis, .ranking-section, .realperf-section, .profitloss-section, .dimension-section, .market-trend-section { padding: 10px; margin-top: 12px; }
}

@media (max-width: 500px) {
    body { padding: 6px; }
    .header { padding: 14px; margin-bottom: 8px; border-radius: 10px; }
    .header h1 { font-size: 22px; margin-bottom: 6px; }
    .header .subtitle { font-size: 12px; }
    .version-badge { font-size: 11px; padding: 3px 10px; margin: 5px 0 8px 0; }
    .input-panel { padding: 14px; border-radius: 10px; }
    .result-panel { padding: 14px; border-radius: 10px; }
    .history-info-line { gap: 2px 8px; }
    .history-bid-row { flex-direction: column; gap: 6px; }
    .supply-analysis, .ranking-section, .realperf-section, .profitloss-section, .dimension-section, .market-trend-section { padding: 10px; }
    
    /* v3.97 è®“ä¸‰å€‹åˆ†æå€å¡Šå°é½Šä¸Šæ–¹æŒ‰éˆ• */
    .right-section {
        margin-left: -14px;
        margin-right: -14px;
    }
    .right-section-content {
        padding: 14px;
    }
    
    /* v3.97d æ‰‹æ©Ÿç‰ˆè¡¨æ ¼æ©«å‘æ»¾å‹• */
    .ranking-box {
        padding: 6px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .ranking-table {
        min-width: 520px;
        font-size: 11px;
    }
    .ranking-table th,
    .ranking-table td {
        padding: 6px 2px;
    }
    
    /* v3.97d æœˆå‡æˆäº¤ç¸¾æ•ˆè¡¨æ ¼ä¹Ÿè¦æ©«å‘æ»¾å‹• */
    .realperf-section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .realperf-section table {
        min-width: 480px;
    }
}

/* ================= v3.72 ä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹é¢æ¿ ================= */
.major-player-panel {
    border: 2px solid #6a1b9a;
    border-radius: 12px;
    margin-top: 20px;
    overflow: hidden;
}
.major-player-header {
    background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);
    color: white;
    padding: 12px 18px;
    font-size: 16px;
    font-weight: bold;
}
.major-player-content {
    padding: 18px;
    background: linear-gradient(135deg, #fafafa 0%, #f3e5f5 100%);
}
.major-player-main {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}
.major-player-gauge {
    flex: 0 0 140px;
    text-align: center;
}
.major-player-gauge .gauge-value {
    font-size: 42px;
    font-weight: bold;
    color: #6a1b9a;
}
.major-player-gauge .gauge-label {
    font-size: 12px;
    color: #666;
}
.major-player-strategies {
    flex: 1;
    min-width: 280px;
}
.mp-strategy-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}
.mp-strategy-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    border: 2px solid #e0e0e0;
    transition: all 0.2s;
}
.mp-strategy-card:hover {
    border-color: #9c27b0;
    box-shadow: 0 3px 10px rgba(156, 39, 176, 0.2);
}
.mp-strategy-card.sniper { border-left: 4px solid #f44336; }
.mp-strategy-card.stable { border-left: 4px solid #4caf50; }
.mp-strategy-card.safe { border-left: 4px solid #2196f3; }
.mp-strategy-card h5 {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
}
.mp-strategy-card .mp-price {
    font-size: 22px;
    font-weight: bold;
    color: #333;
}
.mp-strategy-card .mp-rate {
    font-size: 11px;
    color: #999;
    margin-top: 3px;
}
.mp-confidence-bar {
    margin-top: 12px;
    padding: 10px 12px;
    border-radius: 6px;
}
.mp-confidence-bar.high { background: #e8f5e9; border-left: 4px solid #4caf50; }
.mp-confidence-bar.medium { background: #fff3e0; border-left: 4px solid #ff9800; }
.mp-confidence-bar.low { background: #ffebee; border-left: 4px solid #f44336; }
.mp-adjustments {
    margin-top: 15px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}
.mp-adjustments-title {
    font-size: 13px;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
}
.mp-adj-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.mp-adj-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 12px;
    background: #f5f5f5;
}
.mp-adj-item.positive { background: #e8f5e9; color: #2e7d32; }
.mp-adj-item.negative { background: #ffebee; color: #c62828; }
.mp-adj-item.neutral { background: #f5f5f5; color: #666; }
.mp-win-rate-calc {
    margin-top: 15px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}
.mp-win-rate-input {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}
.mp-win-rate-input input {
    width: 100px;
    padding: 8px;
    border: 2px solid #9c27b0;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
}
.mp-win-rate-result {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
}
</style>

</head>

<body>
<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 22px; font-weight: bold;">
    <div>ğŸ”„ ç³»çµ±å•Ÿå‹•ä¸­ (v3.96)...</div>
    <div id="loading-detail" style="font-size: 15px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æ­£åœ¨æ•´åˆç«¶æ‹è³‡æ–™åº«...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ±</h1>
        <span class="version-badge">v3.97-zs-b æ•ˆèƒ½å„ªåŒ–ç‰ˆ</span>
        <div class="subtitle">
            <span>Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</span>
            <span style="color:#ddd">|</span>
            <span id="headerSubtitle">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

<div class="evaluation-container">
    <div class="input-panel" id="inputPanel">

    <!-- ========== ç¬¬ä¸€å€å¡Šï¼šç«¶æ‹æ¢ä»¶è¼¸å…¥ ========== -->
    <div class="panel-section" style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border: 2px solid #667eea; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
        <div class="section-header" style="display:flex; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #667eea;">
            <span style="font-size:20px; margin-right:8px;">ğŸ“‹</span>
            <span style="font-size:16px; font-weight:bold; color:#667eea;">ä¸€ã€ç«¶æ‹æ¢ä»¶è¼¸å…¥</span>
            <span style="font-size:11px; color:#666; margin-left:auto;">å¡«å¯«æ¨™çš„è³‡æ–™</span>
        </div>
        
    <form id="evaluationForm">
        <!-- âš¡ é–ƒé›»å¸¶å…¥ -->
        <div class="form-section" style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
            <h3 style="color: #f57c00; border-left-color: #ff9800;">âš¡ é–ƒé›»å¸¶å…¥</h3>
            <div class="form-group" style="margin-bottom: 10px;">
                <label style="color: #e65100;">é¸æ“‡æ¡ˆä»¶ï¼Œè‡ªå‹•å¸¶å…¥æ‰€æœ‰æ¢ä»¶</label>
                <select id="quickSelect" style="border: 2px solid #ffc107; font-weight: bold;">
                    <option value="">-- è«‹é¸æ“‡æ¡ˆä»¶ --</option>
                    <optgroup label="ğŸ”¥ å³å°‡ç«¶æ‹ï¼ˆæœ‰æ™‚ç¨‹ä¸”æœªå®Œæˆï¼‰" id="upcomingAuctionGroup"></optgroup>
                    <optgroup label="ğŸ“‹ å³å°‡è©¢åœˆï¼ˆæœ‰æ™‚ç¨‹ä¸”æœªå®Œæˆï¼‰" id="upcomingInquiryGroup"></optgroup>
                    <optgroup label="â³ æ‰¿éŠ·ä¸­-ç«¶æ‹ï¼ˆå°šæœªç¢ºå®šæ™‚ç¨‹ï¼‰" id="pendingAuctionGroup"></optgroup>
                    <optgroup label="â³ æ‰¿éŠ·ä¸­-è©¢åœˆï¼ˆå°šæœªç¢ºå®šæ™‚ç¨‹ï¼‰" id="pendingInquiryGroup"></optgroup>
                    <optgroup label="âœ… è¿‘æœŸå®Œæˆç«¶æ‹ï¼ˆ1-3å€‹æœˆåƒè€ƒï¼‰" id="recentAuctionGroup"></optgroup>
                    <optgroup label="âœ… è¿‘æœŸå®Œæˆè©¢åœˆï¼ˆ1-3å€‹æœˆåƒè€ƒï¼‰" id="recentInquiryGroup"></optgroup>
                </select>
            </div>
            <div id="quickSelectInfo" style="display:none; background:#fff; padding:10px; border-radius:6px; margin-top:8px; font-size:13px; border-left:4px solid #ff9800;"></div>
            <div id="modelCompareResult" style="display:none; background:#e8f5e9; padding:10px; border-radius:6px; margin-top:8px; font-size:13px; border-left:4px solid #4caf50;"></div>
            <div style="font-size:12px; color:#795548; margin-top:8px;">
                ğŸ’¡ é¸æ“‡å¾Œè‡ªå‹•å¸¶å…¥æ¢ä»¶ï¼Œç«¶æ‹æ¡ˆä»¶è«‹æ–¼æˆªæ¨™æ—¥13:30å‰ç¢ºèªæ”¶ç›¤åƒ¹
            </div>
        </div>

        <!-- ğŸ“Œ åŸºæœ¬è³‡æ–™ -->
        <div class="form-section">
            <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
            <div class="form-group">
                <label>CBåç¨± / ä»£è™Ÿ *</label>
                <input type="text" id="cbName" placeholder="è¼¸å…¥ä»£è™Ÿ(å¦‚2383)æˆ–åç¨±æœå°‹æ­·å²">
                <div id="historyResults" class="history-results"></div>
                <div id="cbNameInfo" class="info-box"></div>
            </div>
            <div class="form-group"><label>è‚¡æœ¬å€é–“ *</label><select id="capital"><option value="">è«‹é¸æ“‡...</option><option value="å°æ–¼3å„„">å°æ–¼3å„„</option><option value="3~6å„„">3~6å„„</option><option value="6~10å„„">6~10å„„</option><option value="10~15å„„">10~15å„„</option><option value="15~20å„„">15~20å„„</option><option value="å¤§æ–¼20å„„">å¤§æ–¼20å„„</option></select><div id="capitalInfo" class="info-box"></div></div>
            <div class="form-group"><label>ç”¢æ¥­åˆ†é¡ *</label><select id="industry"><option value="">è¼‰å…¥ä¸­...</option></select><div id="industryInfo" class="info-box"></div><div id="industryTip300" class="tip-300" style="display:none;"></div></div>
            <div class="form-group"><label>ç™¼è¡Œåˆ¸å•†</label><select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select><div id="brokerInfo" class="info-box"></div><div id="brokerTip300" class="tip-300" style="display:none;"></div></div>
        </div>
        
        <!-- ğŸ’° ç™¼è¡Œæ¢ä»¶ -->
        <div class="form-section">
            <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
            <div class="form-group"><label>ç™¼è¡Œè¦æ¨¡å€é–“ *</label><select id="issueSize"><option value="">è«‹é¸æ“‡...</option><option value="å°æ–¼2å„„">å°æ–¼2å„„</option><option value="2~5å„„">2~5å„„</option><option value="5~10å„„">5~10å„„</option><option value="10~15å„„">10~15å„„</option><option value="15~20å„„">15~20å„„</option><option value="å¤§æ–¼20å„„">å¤§æ–¼20å„„</option></select><div id="issueSizeInfo" class="info-box"></div><div id="issueSizeTip300" class="tip-300" style="display:none;"></div></div>
            <div class="form-group">
                <label>ç†è«–åƒ¹å€é–“ * <span id="theoRangeMode" style="font-size:11px; color:#1976d2; font-weight:normal;">ï¼ˆè¼¸å…¥è‚¡åƒ¹/è½‰æ›åƒ¹å¾Œè‡ªå‹•è¨ˆç®—ï¼‰</span></label>
                <select id="theoRange"><option value="">è«‹é¸æ“‡æˆ–ç”±ä¸‹æ–¹è‡ªå‹•è¨ˆç®—...</option><option value="å°æ–¼90å…ƒ">å°æ–¼90å…ƒ</option><option value="90~95å…ƒ">90~95å…ƒ</option><option value="95~100å…ƒ">95~100å…ƒ</option><option value="100~105å…ƒ">100~105å…ƒ</option><option value="105~110å…ƒ">105~110å…ƒ</option><option value="110~115å…ƒ">110~115å…ƒ</option><option value="å¤§æ–¼115å…ƒ">å¤§æ–¼115å…ƒ</option></select>
                <div id="theoRangeInfo" class="info-box"></div>
                <div id="theoRangeTip300" class="tip-300" style="display:none;"></div>
                <div id="theoAutoCalcInfo" style="display:none; background:#e3f2fd; padding:8px 12px; border-radius:6px; margin-top:5px; font-size:12px;">
                    <span style="color:#1565c0;">âœ… å·²è‡ªå‹•è¨ˆç®—ï¼šç†è«–åƒ¹ <b id="theoAutoValue">0</b> å…ƒ â†’ å€é–“ <b id="theoAutoRange">-</b></span>
                </div>
            </div>
            <div class="form-group"><label>ç™¼è¡Œå¹´æœŸ *</label><select id="years"><option value="">è«‹é¸æ“‡...</option><option value="3">3å¹´æœŸ</option><option value="5">5å¹´æœŸ</option><option value="7">7å¹´æœŸ</option></select><div id="yearsInfo" class="info-box"></div><div id="yearsTip300" class="tip-300" style="display:none;"></div></div>
            <div class="form-group"><label>æ“”ä¿æƒ…æ³ *</label><select id="guarantee" onchange="updateAtmospherePanel(); updateMarketSentiment();"><option value="">è«‹é¸æ“‡...</option><option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option><option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option></select><div id="guaranteeInfo" class="info-box"></div><div id="guaranteeTip300" class="tip-300" style="display:none;"></div></div>
            <div class="form-group"><label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label><select id="rating"><option value="">è«‹é¸æ“‡...</option><option value="1">TCRI 1</option><option value="2">TCRI 2</option><option value="3">TCRI 3</option><option value="4">TCRI 4</option><option value="5">TCRI 5</option><option value="6">TCRI 6</option><option value="7">TCRI 7</option><option value="8">TCRI 8</option></select><div id="ratingInfo" class="info-box"></div><div id="ratingTip300" class="tip-300" style="display:none;"></div></div>
        </div>
        
        <!-- ğŸ¯ ç«¶æ‹è³‡æ–™ -->
        <div class="form-section">
            <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
            <div class="form-group">
                <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                <input type="number" id="stockPrice" step="0.01" placeholder="ä¾‹å¦‚ï¼š461.5">
            </div>
            <div class="form-group">
                <label>å¯¦éš›è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                <input type="number" id="actualConversionPrice" step="0.01" placeholder="ä¾‹å¦‚ï¼š450">
            </div>
            <div class="form-group">
                <label>åº•æ¨™åƒ¹æ ¼ (å…ƒ)</label>
                <input type="number" id="floorPrice" step="0.1" value="100" placeholder="é è¨­ï¼š100">
                <div class="warning-box">âš ï¸ ç†è«–åƒ¹æ ¼éš¨è‚¡åƒ¹è®Šå‹•ï¼Œå»ºè­°æ–¼ 13:30 æˆªæ¨™å‰å†é€²è¡Œæœ€çµ‚è©¦ç®—</div>
            </div>
        </div>
        
        <!-- âš–ï¸ ä¸»è§€æ¬Šé‡ -->
        <details style="margin-top:10px;">
            <summary style="cursor:pointer; font-size:13px; color:#e65100; font-weight:bold; padding:8px; background:#fff9e6; border-radius:6px;">
                âš–ï¸ ä¸»è§€æ¬Šé‡ï¼ˆé¸å¡«ï¼Œé»æ“Šå±•é–‹ï¼‰
            </summary>
            <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 1px solid #ff9800; border-radius: 8px; padding: 12px; margin-top:8px;">
                <div class="subjective-note" style="font-size:11px; color:#666; margin-bottom:10px;">
                    ğŸ’¡ é è¨­ç‚º 0 è¡¨ç¤ºå®Œå…¨ä¾æ“šæ­·å²æ•¸æ“šï¼›è‹¥æ‚¨æœ‰ç¨åˆ°è¦‹è§£ï¼Œå¯èª¿æ•´æ­¤è™•æ³¨å…¥ä¸»è§€åˆ¤æ–·ã€‚
                </div>
                <div class="form-group"><label>ä¸»è§€æ¬Šé‡ (%)</label><input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0"></div>
                <div class="form-group"><label>ä¸»è§€æœ€ä½æº¢åƒ¹ (%)</label><input type="number" id="subjectiveLowPremium" step="0.1" value="0"></div>
                <div class="form-group"><label>ä¸»è§€å¹³å‡æº¢åƒ¹ (%)</label><input type="number" id="subjectiveAvgPremium" step="0.1" value="0"></div>
            </div>
        </details>
        
    </div><!-- ç¬¬ä¸€å€å¡ŠçµæŸ -->
    
    <!-- ========== ç¬¬äºŒå€å¡Šï¼šAIæ™ºèƒ½è©•ä¼°ï¼ˆv3.97e é è¨­éš±è—ï¼ŒæŒ‰ä¸‹æŒ‰éˆ•å¾Œåœ¨çµæœå€é¡¯ç¤ºï¼‰ ========== -->
    <div id="inputAISection" class="panel-section" style="display:none; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #9c27b0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
        <div class="section-header" style="display:flex; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #9c27b0;">
            <span style="font-size:20px; margin-right:8px;">ğŸ¤–</span>
            <span style="font-size:16px; font-weight:bold; color:#7b1fa2;">äºŒã€AIæ™ºèƒ½è©•ä¼°</span>
            <span style="font-size:11px; color:#666; margin-left:auto;">å³æ™‚è¨ˆç®—å»ºè­°å‡ºåƒ¹</span>
        </div>
        
        <!-- ğŸ¯ ä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹ -->
        <div class="form-section" style="background: white; border: 1px solid #ce93d8; border-radius: 10px; padding: 12px; margin-bottom: 12px;">
            <div style="font-size:13px; font-weight:bold; color:#6a1b9a; margin-bottom:8px;">ğŸ¯ ä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹</div>
            <div style="font-size:11px; color:#666; margin-bottom:8px;">
                ğŸ’¡ åŸºæ–¼75æª”CBå¾—æ¨™æ˜ç´°ï¼Œæ ¹æ“šæ‚¨çš„æ¢ä»¶å‹•æ…‹èª¿æ•´<br>
                ğŸ“Š æ ¸å¿ƒç™¼ç¾ï¼š94%æƒ…æ³ä¸‹ï¼Œä¸»åŠ›æœ€ä½å‡ºåƒ¹èˆ‡æœ€ä½å¾—æ¨™å·®è· <0.5å…ƒ
            </div>
            <div id="majorPlayerSimulation">
                <!-- v3.90 æ”¹ç‚ºå‹•æ…‹è¼‰å…¥ï¼Œä¸å¯«æ­»æ•¸æ“š -->
                <div style="background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color:white; padding:12px; border-radius:8px;">
                    <div style="font-size:11px; opacity:0.9; margin-bottom:6px;">ğŸ“ æ­·å²æ•¸æ“š â†’ æ•´é«”ä¸»åŠ›å‡ºåƒ¹å€é–“</div>
                    <div style="display:flex; justify-content:space-around; align-items:center;">
                        <div style="text-align:center;">
                            <div style="font-size:10px; opacity:0.8;">ä¸»åŠ›æœ€ä½å‡ºåƒ¹</div>
                            <div style="font-size:22px; font-weight:bold;" id="initMajorLow">è¼‰å…¥ä¸­...</div>
                        </div>
                        <div style="font-size:20px; opacity:0.5;">~</div>
                        <div style="text-align:center;">
                            <div style="font-size:10px; opacity:0.8;">ä¸»åŠ›æœ€é«˜å‡ºåƒ¹</div>
                            <div style="font-size:22px; font-weight:bold;" id="initMajorHigh">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                    <div style="margin-top:8px; font-size:10px; opacity:0.8; text-align:center;">
                        é¸æ“‡æ¢ä»¶å¾Œè‡ªå‹•æ›´æ–°ç‚ºæ‚¨çš„å°ˆå±¬å»ºè­°
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ğŸ¯ AIæ™ºèƒ½é æ¸¬ -->
        <div class="form-section" style="background: white; border: 1px solid #ce93d8; border-radius: 10px; padding: 12px; margin-bottom: 12px;">
            <div style="font-size:13px; font-weight:bold; color:#667eea; margin-bottom:8px;">ğŸ“Š AIé æ¸¬çµæœ</div>
            <div style="font-size:11px; color:#666; margin-bottom:8px;">
                ğŸ’¡ åŸºæ–¼<span id="auctionCountLabel">--</span>æª”ç«¶æ‹çµ±è¨ˆï¼Œå³æ™‚é ä¼°æŠ•æ¨™å€æ•¸èˆ‡å»ºè­°å‡ºåƒ¹
            </div>
            <div id="liveAIPrediction">
                <!-- v3.90 æ”¹ç‚ºå‹•æ…‹è¼‰å…¥ï¼Œä¸å¯«æ­»æ•¸æ“š -->
                <div style="background:linear-gradient(135deg, #667eea 0%, #5567d8 100%); color:white; padding:12px; border-radius:8px;">
                    <div style="font-size:11px; opacity:0.9; margin-bottom:6px;">ğŸ“ æ­·å²æ•¸æ“š â†’ æ•´é«”å¸‚å ´é æ¸¬</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; text-align:center;">
                        <div>
                            <div style="font-size:10px; opacity:0.8;">å¹³å‡æŠ•æ¨™å€æ•¸</div>
                            <div style="font-size:18px; font-weight:bold;" id="initAvgMult">è¼‰å…¥ä¸­...</div>
                        </div>
                        <div>
                            <div style="font-size:10px; opacity:0.8;">å¹³å‡æœ€ä½å¾—æ¨™</div>
                            <div style="font-size:18px; font-weight:bold;" id="initAvgMinBid">è¼‰å…¥ä¸­...</div>
                        </div>
                        <div>
                            <div style="font-size:10px; opacity:0.8;">å¹³å‡å¾—æ¨™å‡åƒ¹</div>
                            <div style="font-size:18px; font-weight:bold;" id="initAvgBid">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                    <div style="margin-top:8px; font-size:10px; opacity:0.8; text-align:center;">
                        é¸æ“‡æ¢ä»¶å¾Œè‡ªå‹•æ›´æ–°ç‚ºæ‚¨çš„å°ˆå±¬é æ¸¬
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ğŸ“‹ ç«¶æ‹å‰ç¶œåˆè©•ä¼° -->
        <div class="form-section" style="background: white; border: 1px solid #ce93d8; border-radius: 10px; padding: 12px;">
            <div style="font-size:13px; font-weight:bold; color:#0d47a1; margin-bottom:8px;">ğŸ“‹ ç«¶æ‹å‰ç¶œåˆè©•ä¼°</div>
            <div style="font-size:11px; color:#666; margin-bottom:8px;">
                ğŸ’¡ åŸºæ–¼æ­·å²ç«¶æ‹æ•¸æ“šï¼Œç¶œåˆè©•ä¼°æ˜¯å¦å€¼å¾—åƒèˆ‡
            </div>
            <div id="auctionEvaluation">
                <!-- v3.90 æ”¹ç‚ºå‹•æ…‹è¼‰å…¥ï¼Œä¸å¯«æ­»æ•¸æ“š -->
                <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:white; padding:12px; border-radius:8px;">
                    <div style="font-size:11px; opacity:0.9; margin-bottom:6px;">ğŸ“ æ­·å²æ•¸æ“š â†’ æ•´é«”åƒèˆ‡å»ºè­°</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; text-align:center;">
                        <div>
                            <div style="font-size:10px; opacity:0.8;">æ•´é«”å¾—æ¨™ç‡</div>
                            <div style="font-size:20px; font-weight:bold;" id="initWinRate">è¼‰å…¥ä¸­...</div>
                            <div style="font-size:9px; opacity:0.7;" id="initWinRateNote">-</div>
                        </div>
                        <div>
                            <div style="font-size:10px; opacity:0.8;">å¹³å‡é¦–æ—¥å ±é…¬</div>
                            <div style="font-size:20px; font-weight:bold;" id="initFirstDayReturn">è¼‰å…¥ä¸­...</div>
                            <div style="font-size:9px; opacity:0.7;">æ›ç‰Œæ—¥æ”¶ç›¤vså¾—æ¨™åƒ¹</div>
                        </div>
                    </div>
                    <div style="margin-top:10px; padding:8px; background:rgba(255,255,255,0.15); border-radius:6px; font-size:11px;">
                        <div style="margin-bottom:4px;">ğŸ“Œ <b>åˆç†å‡ºåƒ¹å€é–“ï¼š<span id="initPriceRange">è¼‰å…¥ä¸­...</span></b></div>
                        <div style="opacity:0.9;">æ­¤å€é–“ç‚ºæ­·å²å¹³å‡æœ€ä½å¾—æ¨™~åŠ æ¬Šå‡åƒ¹ï¼Œå¾—æ¨™æ©Ÿç‡è¼ƒé«˜</div>
                    </div>
                    <div style="margin-top:6px; font-size:10px; opacity:0.8; text-align:center;">
                        é¸æ“‡æ¢ä»¶å¾Œè‡ªå‹•æ›´æ–°ç‚ºæ‚¨çš„å°ˆå±¬è©•ä¼°
                    </div>
                </div>
            </div>
        </div>
    </div><!-- ç¬¬äºŒå€å¡ŠçµæŸ -->
    
    <!-- ========== ç¬¬ä¸‰å€å¡Šï¼šå¸‚å ´æº«åº¦è¨ˆï¼ˆv3.97e é è¨­éš±è—ï¼ŒæŒ‰ä¸‹æŒ‰éˆ•å¾Œåœ¨çµæœå€é¡¯ç¤ºï¼‰ ========== -->
    <div id="inputMarketSection" class="panel-section" style="display:none; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
        <div class="section-header" style="display:flex; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #4caf50;">
            <span style="font-size:20px; margin-right:8px;">ğŸŒ¡ï¸</span>
            <span style="font-size:16px; font-weight:bold; color:#2e7d32;">ä¸‰ã€å¸‚å ´æº«åº¦è¨ˆ</span>
            <span style="font-size:11px; color:#666; margin-left:auto;">è¿‘æœŸå¸‚å ´ç†±åº¦åƒè€ƒ</span>
        </div>
        
        <!-- ğŸ“¡ å³æ™‚å¸‚å ´å‹•èƒ½ -->
        <div class="form-section" style="background: white; border: 1px solid #81c784; border-radius: 10px; padding: 12px; margin-bottom: 12px;">
            <div style="font-size:13px; font-weight:bold; color:#c2185b; margin-bottom:8px;">ğŸ“¡ å³æ™‚å¸‚å ´å‹•èƒ½ï¼ˆè¿‘10æª”é–‹æ¨™ï¼‰</div>
            <div id="marketMomentumResult">
                <div style="color:#666; padding:10px; text-align:center; font-size:12px;">â³ è¼‰å…¥ä¸­...</div>
            </div>
            <details style="margin-top:8px;">
                <summary style="cursor:pointer; font-size:11px; color:#2e7d32; font-weight:bold;">ğŸ“‹ æŸ¥çœ‹è¿‘æœŸé–‹æ¨™æ˜ç´°</summary>
                <div id="recentAuctionDetails" style="margin-top:8px; max-height:200px; overflow-y:auto; font-size:11px;"></div>
            </details>
        </div>
        
        <!-- ğŸŒ¡ï¸ å¸‚å ´æ°›åœå„€è¡¨æ¿ -->
        <div id="atmospherePanel" class="form-section" style="display:none; background: white; border: 1px solid #81c784; border-radius: 10px; padding: 12px; margin-bottom: 12px;">
            <div style="font-size:13px; font-weight:bold; color:#2e7d32; margin-bottom:8px;">ğŸŒ¡ï¸ å¸‚å ´æ°›åœå„€è¡¨æ¿</div>
            <div id="atmosphereContent" style="font-size: 12px;">è¼‰å…¥ä¸­...</div>
        </div>
        
        <!-- ğŸ“Š è¿‘æœŸå¸‚å ´æ°›åœ -->
        <div class="form-section" style="background: white; border: 1px solid #81c784; border-radius: 10px; padding: 12px;">
            <div style="font-size:13px; font-weight:bold; color:#1565c0; margin-bottom:8px;">ğŸ“Š åŒæ¢ä»¶æ­·å²çµ±è¨ˆ</div>
            <div style="font-size:10px; color:#666; margin-bottom:8px;">
                âš ï¸ éœ€å¡«å¯«æ¢ä»¶æ‰èƒ½è¨ˆç®—<br>
                äº”ç¶­åº¦æ¬Šé‡ï¼šç”¢æ¥­35%+åˆ¸å•†25%+ä¿¡è©•20%+è¦æ¨¡10%+ç†è«–åƒ¹10%
            </div>
            <div id="marketSentiment" class="info-box" style="display: block; background:#f5f5f5; border-left: 4px solid #2196F3; padding:10px; font-size:12px;">
                <div class="stat-row" style="color:#e65100;">âš ï¸ è«‹å…ˆå¡«å¯«ï¼šç”¢æ¥­ã€ç™¼è¡Œè¦æ¨¡ã€ä¿¡è©•</div>
            </div>
        </div>
    </div><!-- ç¬¬ä¸‰å€å¡ŠçµæŸ -->
    
    <!-- Rexå¤§å”æé†’ -->
    <div id="smartReminders" style="display:none; margin: 15px 0; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
        <div style="font-weight: bold; color: #856404; font-size: 13px;">ğŸ’¡ Rexå¤§å”æé†’</div>
        <div id="reminderContent" style="font-size: 12px; line-height: 1.7; color: #856404; margin-top:5px;"></div>
    </div>
    
    <!-- é–‹å§‹è©•ä¼°æŒ‰éˆ• -->
    <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
    </form>
</div><!-- input-panelçµæŸ -->

<div class="resizer" id="resizer"></div>

<div class="result-panel" id="resultPanel">
    <!-- ========== v3.97j æ­¥é©Ÿå¼AIè©•ä¼°å ±å‘Šï¼ˆä¸‰éšæ®µåˆ†æï¼‰ ========== -->
    <div id="stepReport" style="display:none;">

    <!-- Step 0: Rexå¤§å”æé†’ -->
    <div class="step-section" style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display:flex; align-items:center; margin-bottom:12px;">
            <span style="font-size:24px; margin-right:10px;">ğŸ§¢</span>
            <span style="font-size:16px; font-weight:bold; color:#f57c00;">Rexå¤§å”æé†’</span>
        </div>
        <div id="step0Reminder" style="font-size:13px; color:#795548; line-height:1.8;">
            è¼‰å…¥ä¸­...
        </div>
    </div>
    
    <!-- Step 1: åŸºç¤æ•¸æ“šåˆ†æï¼ˆæº¢åƒ¹ç‡æ³•/å¾—æ¨™å‡åƒ¹æ³•ï¼Œæœ‰åŠ æ¬Šèˆ‡ç„¡åŠ æ¬Šï¼‰ -->
    <div class="step-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display:flex; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid #2196f3;">
            <span style="background:#2196f3; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">1</span>
            <span style="font-size:16px; font-weight:bold; color:#1565c0;">åŸºç¤æ•¸æ“šåˆ†æ</span>
            <span style="font-size:11px; color:#666; margin-left:auto;" id="step1MethodLabel">--</span>
        </div>
        <div id="step1Content">
            <!-- ç†è«–åƒ¹èˆ‡æ–¹æ³• -->
            <div style="background:linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color:white; padding:12px; border-radius:10px; margin-bottom:12px;">
                <div style="display:flex; align-items:center; justify-content:center; gap:15px; flex-wrap:wrap;">
                    <div style="text-align:center;">
                        <div style="font-size:10px; opacity:0.8;">æˆªæ¨™æ—¥ç†è«–åƒ¹</div>
                        <div style="font-size:22px; font-weight:bold;" id="step1TheoPrice">--</div>
                    </div>
                    <div style="font-size:18px; opacity:0.5;">â†’</div>
                    <div style="text-align:center; background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">ç³»çµ±æ¡ç”¨</div>
                        <div style="font-size:14px; font-weight:bold;" id="step1MethodName">--</div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:8px; font-size:10px; opacity:0.8;">
                    ç†è«–åƒ¹â‰¥97.5æ¡ç”¨æº¢åƒ¹ç‡æ³•ï¼Œ&lt;97.5æ¡ç”¨å¾—æ¨™å‡åƒ¹æ³•
                </div>
            </div>
            
            <!-- ç„¡åŠ æ¬Š vs æœ‰åŠ æ¬Š ä¸¦åˆ— -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                <!-- ç„¡åŠ æ¬Š -->
                <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:white; padding:12px; border-radius:10px;">
                    <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">ğŸ“Š ç„¡åŠ æ¬Šï¼ˆç´”æ­·å²å¹³å‡ï¼‰</div>
                    <div style="text-align:center; margin-bottom:6px;">
                        <div style="font-size:10px; opacity:0.8;">æ­·å²å¹³å‡æº¢åƒ¹ç‡</div>
                        <div style="font-size:16px; font-weight:bold;" id="step1NoWeightPremium">--</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.2); padding:8px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">å»ºè­°å€é–“</div>
                        <div style="font-size:14px; font-weight:bold;" id="step1NoWeightRange">--</div>
                    </div>
                </div>
                <!-- æœ‰åŠ æ¬Š -->
                <div style="background:linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); color:white; padding:12px; border-radius:10px;">
                    <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">âš–ï¸ æœ‰åŠ æ¬Šï¼ˆç¶­åº¦åŠ æ¬Šï¼‰</div>
                    <div style="text-align:center; margin-bottom:6px;">
                        <div style="font-size:10px; opacity:0.8;">åŠ æ¬Šå¹³å‡æº¢åƒ¹ç‡</div>
                        <div style="font-size:16px; font-weight:bold;" id="step1WeightPremium">--</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.2); padding:8px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">å»ºè­°å€é–“</div>
                        <div style="font-size:14px; font-weight:bold;" id="step1WeightRange">--</div>
                    </div>
                </div>
            </div>
            <div style="text-align:center; font-size:11px; color:#1565c0; margin-bottom:10px;">
                ğŸ’¡ ç„¡åŠ æ¬Šç‚ºæ•´é«”æ­·å²å¹³å‡ï¼Œæœ‰åŠ æ¬Šè€ƒé‡ç”¢æ¥­ã€ä¿¡è©•ã€è¦æ¨¡ã€åˆ¸å•†ç­‰ç¶­åº¦<br>
                <span style="color:#e65100;">âš ï¸ åŠ æ¬Šç›®çš„ï¼šé¿å…å–®ä¸€æ¨™çš„ç•°å¸¸å€¼å½±éŸ¿æ•´é«”åˆ¤æ–·</span>
            </div>
            
            <!-- å¯æ”¶åˆçš„è©³ç´°åˆ†æ -->
            <details style="background:white; border-radius:8px; overflow:hidden;">
                <summary style="padding:12px; cursor:pointer; font-size:13px; font-weight:bold; color:#1565c0; background:#e3f2fd; display:flex; align-items:center; gap:8px;">
                    <span>ğŸ“Š</span>
                    <span>æŸ¥çœ‹å„ç¶­åº¦åŠ æ¬Šæ˜ç´°</span>
                    <span style="margin-left:auto; font-size:11px; color:#666; font-weight:normal;">é»æ“Šå±•é–‹</span>
                </summary>
                <div style="padding:12px; font-size:12px;">
                    <div id="step1DetailContent">è¼‰å…¥ä¸­...</div>
                </div>
            </details>
        </div>
    </div>
    
    <!-- Step 2: å¸‚å ´æ°›åœèª¿æ•´ï¼ˆè¿‘æœŸç†±åº¦æ³•ï¼‰ -->
    <div class="step-section" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display:flex; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid #4caf50;">
            <span style="background:#4caf50; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">2</span>
            <span style="font-size:16px; font-weight:bold; color:#2e7d32;">å¸‚å ´æ°›åœèª¿æ•´</span>
            <span style="font-size:11px; color:#666; margin-left:auto;">è¿‘æœŸç†±åº¦æ³•</span>
        </div>
        <div id="step2Content">
            <!-- è¿‘æœŸç†±åº¦çµæœ -->
            <div style="background:linear-gradient(135deg, #388e3c 0%, #2e7d32 100%); color:white; padding:15px; border-radius:10px; margin-bottom:12px;">
                <div style="font-size:12px; opacity:0.9; margin-bottom:10px; text-align:center;">ğŸ“¡ è¿‘10æª”é–‹æ¨™ç†±åº¦åˆ†æ</div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; text-align:center; margin-bottom:10px;">
                    <div>
                        <div style="font-size:10px; opacity:0.8;">å¸‚å ´ç†±åº¦</div>
                        <div style="font-size:18px; font-weight:bold;" id="step2HeatLevel">--</div>
                    </div>
                    <div>
                        <div style="font-size:10px; opacity:0.8;">è¿‘æœŸå¹³å‡æº¢åƒ¹</div>
                        <div style="font-size:18px; font-weight:bold;" id="step2HeatPremium">--</div>
                    </div>
                    <div>
                        <div style="font-size:10px; opacity:0.8;">è¿‘æœŸå¹³å‡å€æ•¸</div>
                        <div style="font-size:18px; font-weight:bold;" id="step2HeatMultiple">--</div>
                    </div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.2); padding:10px; border-radius:6px;">
                    <div style="font-size:10px; opacity:0.8;">ç†±åº¦æ³•å»ºè­°å€é–“</div>
                    <div style="font-size:18px; font-weight:bold;" id="step2HeatRange">--</div>
                </div>
            </div>
            <div style="text-align:center; font-size:11px; color:#2e7d32; margin-bottom:10px;">
                ğŸ’¡ ç›´æ¥åæ˜ è¿‘æœŸå¸‚å ´æƒ…ç·’ï¼Œé©åˆåˆ¤æ–·çŸ­æœŸç†±åº¦è®ŠåŒ–
            </div>
            
            <!-- å¯æ”¶åˆçš„è©³ç´°åˆ†æ -->
            <details style="background:white; border-radius:8px; overflow:hidden;">
                <summary style="padding:12px; cursor:pointer; font-size:13px; font-weight:bold; color:#2e7d32; background:#e8f5e9; display:flex; align-items:center; gap:8px;">
                    <span>ğŸŒ¡ï¸</span>
                    <span>æŸ¥çœ‹è¿‘æœŸé–‹æ¨™æ˜ç´°</span>
                    <span style="margin-left:auto; font-size:11px; color:#666; font-weight:normal;">é»æ“Šå±•é–‹</span>
                </summary>
                <div style="padding:12px; font-size:12px;">
                    <div id="step2Momentum">è¼‰å…¥ä¸­...</div>
                </div>
            </details>
        </div>
    </div>
    
    <!-- Step 3: AIæ™ºèƒ½ç«¶æ‹é æ¸¬ï¼ˆå®Œæ•´v3.73å…§å®¹ï¼‰ -->
    <div class="step-section" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #9c27b0; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display:flex; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid #9c27b0;">
            <span style="background:#9c27b0; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">3</span>
            <span style="font-size:16px; font-weight:bold; color:#7b1fa2;">AIæ™ºèƒ½ç«¶æ‹é æ¸¬</span>
            <span style="font-size:11px; color:#666; margin-left:auto;">v3.73 å®Œæ•´åˆ†æ</span>
        </div>
        <div id="step3Content">
            <!-- é€™è£¡æœƒåµŒå…¥å®Œæ•´çš„ majorPlayerSimulation å…§å®¹ -->
            <div id="step3AIBlock">è¼‰å…¥ä¸­...</div>
            
            <!-- é¢¨éšªæç¤º -->
            <div style="background:#fff3e0; border-left:4px solid #ff9800; padding:10px; border-radius:0 8px 8px 0; font-size:12px; margin-top:12px;">
                <div style="font-weight:bold; color:#e65100; margin-bottom:5px;">âš ï¸ æŠ•æ¨™é¢¨éšªæç¤º</div>
                <div style="color:#795548; line-height:1.6;">
                    â€¢ å››ç¨®æ–¹æ³•çµæœä¾›äº¤å‰åƒè€ƒï¼Œå»ºè­°å–äº¤é›†å€é–“<br>
                    â€¢ æŠ•æ¨™å‰è«‹ç¢ºèªæˆªæ¨™æ—¥13:30æ”¶ç›¤åƒ¹æ ¼<br>
                    â€¢ åƒ¹æ ¼åé›¢ç†è«–åƒ¹éå¤§æ™‚è«‹è¬¹æ…è©•ä¼°
                </div>
            </div>
        </div>
    </div>
    
    <!-- Step 4: æœ€å¼·å¤§è…¦åˆ†ææ³•ï¼ˆå››ç¶­åº¦æ»¾å‹•åŠ æ¬Šï¼‰ -->
    <div class="step-section" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display:flex; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid #ff9800;">
            <span style="background:#ff9800; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">4</span>
            <span style="font-size:16px; font-weight:bold; color:#e65100;">ğŸ§  æœ€å¼·å¤§è…¦åˆ†ææ³•</span>
            <span style="font-size:11px; color:#666; margin-left:auto;">å››ç¶­åº¦æ»¾å‹•åŠ æ¬Šåˆ†æ</span>
        </div>
        <div id="step4Content">
            <!-- ç¯©é¸æ¢ä»¶é¡¯ç¤º -->
            <div style="background:linear-gradient(135deg, #f57c00 0%, #e65100 100%); color:white; padding:12px; border-radius:10px; margin-bottom:12px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">ğŸ” å…±åŒç¯©é¸æ¢ä»¶</div>
                <div style="display:flex; align-items:center; justify-content:center; gap:15px; flex-wrap:wrap;">
                    <div style="text-align:center; background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">æ“”ä¿é¡å‹</div>
                        <div style="font-size:14px; font-weight:bold;" id="step4Guarantee">--</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">è¦æ¨¡ç¯„åœ(50-150%)</div>
                        <div style="font-size:14px; font-weight:bold;" id="step4SizeRange">--</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:10px; opacity:0.8;">ç•¶å‰ç†è«–åƒ¹</div>
                        <div style="font-size:16px; font-weight:bold;" id="step4TheoPrice">--</div>
                    </div>
                </div>
            </div>
            
            <!-- å››ç¶­åº¦æ»¾å‹•çµæœ -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
                <!-- ç”¢æ¥­ç¶­åº¦ 30% -->
                <div style="background:linear-gradient(135deg, #43a047 0%, #2e7d32 100%); color:white; padding:10px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <span style="font-size:11px;">ğŸ­ ç”¢æ¥­</span>
                        <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;" id="step4IndustryWeight">30%</span>
                    </div>
                    <div style="font-size:11px; opacity:0.8;" id="step4IndustryLabel">--</div>
                    <div style="font-size:16px; font-weight:bold;" id="step4IndustryPrem">--%</div>
                    <div style="font-size:9px; opacity:0.7; margin-bottom:4px;">n=<span id="step4IndustryCount">0</span></div>
                    <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:4px; font-size:9px; line-height:1.4;" id="step4IndustryTop3">--</div>
                </div>
                
                <!-- å¸‚å ´æ°›åœ 25% -->
                <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:white; padding:10px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <span style="font-size:11px;">ğŸ“ˆ å¸‚å ´æ°›åœ</span>
                        <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;" id="step4MarketWeight">25%</span>
                    </div>
                    <div style="font-size:11px; opacity:0.8;">æœ€è¿‘Næª”æ•´é«”</div>
                    <div style="font-size:16px; font-weight:bold;" id="step4MarketPrem">--%</div>
                    <div style="font-size:9px; opacity:0.7; margin-bottom:4px;">n=<span id="step4MarketCount">0</span></div>
                    <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:4px; font-size:9px; line-height:1.4;" id="step4MarketTop3">--</div>
                </div>
                
                <!-- ç†è«–åƒ¹ 20% -->
                <div style="background:linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); color:white; padding:10px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <span style="font-size:11px;">ğŸ’° ç†è«–åƒ¹å€é–“</span>
                        <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;" id="step4TheoWeight">20%</span>
                    </div>
                    <div style="font-size:11px; opacity:0.8;" id="step4TheoZone">--</div>
                    <div style="font-size:16px; font-weight:bold;" id="step4TheoPrem">--%</div>
                    <div style="font-size:9px; opacity:0.7; margin-bottom:4px;">n=<span id="step4TheoCount">0</span></div>
                    <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:4px; font-size:9px; line-height:1.4;" id="step4TheoTop3">--</div>
                </div>
                
                <!-- ä¿¡è©• 25% -->
                <div style="background:linear-gradient(135deg, #f57c00 0%, #ef6c00 100%); color:white; padding:10px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                        <span style="font-size:11px;">â­ ä¿¡è©•</span>
                        <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;" id="step4RatingWeight">25%</span>
                    </div>
                    <div style="font-size:11px; opacity:0.8;" id="step4RatingLabel">--</div>
                    <div style="font-size:16px; font-weight:bold;" id="step4RatingPrem">--%</div>
                    <div style="font-size:9px; opacity:0.7; margin-bottom:4px;">n=<span id="step4RatingCount">0</span></div>
                    <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:4px; font-size:9px; line-height:1.4;" id="step4RatingTop3">--</div>
                </div>
            </div>
            
            <!-- åˆæˆçµæœ -->
            <div style="background:linear-gradient(135deg, #e65100 0%, #bf360c 100%); color:white; padding:14px; border-radius:10px; margin-bottom:12px;">
                <div style="font-size:12px; opacity:0.9; margin-bottom:10px; text-align:center;">
                    ğŸ§  å››ç¶­åº¦åŠ æ¬Šåˆæˆï¼ˆè¿‘3æª”50% + è¿‘6æª”30% + è¿‘9æª”20%ï¼‰
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:10px;">
                    <div style="text-align:center; background:rgba(255,255,255,0.15); padding:10px; border-radius:8px;">
                        <div style="font-size:10px; opacity:0.8;">åˆæˆæœ€ä½æº¢åƒ¹ç‡</div>
                        <div style="font-size:18px; font-weight:bold;" id="step4FinalLowPrem">--%</div>
                        <div style="font-size:12px; opacity:0.9;">â†’ <span id="step4FinalLowPrice">--</span>å…ƒ</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.15); padding:10px; border-radius:8px;">
                        <div style="font-size:10px; opacity:0.8;">åˆæˆå¹³å‡æº¢åƒ¹ç‡</div>
                        <div style="font-size:18px; font-weight:bold;" id="step4FinalAvgPrem">--%</div>
                        <div style="font-size:12px; opacity:0.9;">â†’ <span id="step4FinalAvgPrice">--</span>å…ƒ</div>
                    </div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.25); padding:10px; border-radius:6px;">
                    <div style="font-size:11px; margin-bottom:4px;">ğŸ§  <b>æœ€å¼·å¤§è…¦å»ºè­°å€é–“</b></div>
                    <div style="font-size:22px; font-weight:bold;" id="step4PriceRange">--</div>
                </div>
            </div>
            
            <div style="text-align:center; font-size:11px; color:#e65100; margin-bottom:10px;">
                ğŸ’¡ å››ç¶­åº¦ç¨ç«‹æ»¾å‹•å¾ŒåŠ æ¬Šåˆæˆï¼Œæ¨£æœ¬ä¸è¶³æ™‚è‡ªå‹•é‡åˆ†é…æ¬Šé‡<br>
                <span style="color:#795548;">âš ï¸ åŒæ“”ä¿+åŒè¦æ¨¡ç¯„åœç‚ºå…±åŒç¯©é¸æ¢ä»¶</span>
            </div>
            
            <!-- å¯æ”¶åˆçš„è©³ç´°åˆ†æ -->
            <details style="background:white; border-radius:8px; overflow:hidden;">
                <summary style="padding:12px; cursor:pointer; font-size:13px; font-weight:bold; color:#e65100; background:#fff3e0; display:flex; align-items:center; gap:8px;">
                    <span>ğŸ§ </span>
                    <span>æŸ¥çœ‹å››ç¶­åº¦æ»¾å‹•æ˜ç´°</span>
                    <span style="margin-left:auto; font-size:11px; color:#666; font-weight:normal;">é»æ“Šå±•é–‹</span>
                </summary>
                <div style="padding:12px; font-size:12px;">
                    <div id="step4DetailContent">è¼‰å…¥ä¸­...</div>
                </div>
            </details>
        </div>
    </div>
    
    <!-- Step 5: åŒæ¥­ç±Œç¢¼ç¨€ç¼ºåº¦åˆ†ææ³• -->
    <div class="step-section" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display:flex; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid #4caf50;">
            <span style="background:#4caf50; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">5</span>
            <span style="font-size:16px; font-weight:bold; color:#2e7d32;">ğŸ”¬ åŒæ¥­ç±Œç¢¼ç¨€ç¼ºåº¦åˆ†æ</span>
            <span style="font-size:11px; color:#666; margin-left:auto;">é›™æ–¹æ³•äº¤å‰é©—è­‰</span>
        </div>
        <div id="step5Content">
            <!-- ç±Œç¢¼ç¨€ç¼ºåº¦æŒ‡æ¨™ -->
            <div style="background:linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); color:white; padding:12px; border-radius:10px; margin-bottom:12px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">ğŸ“Š ç±Œç¢¼ç¨€ç¼ºåº¦åˆ†æï¼ˆè½‰æ›åƒ¹Ã·è‚¡æœ¬ï¼‰</div>
                <div style="display:flex; align-items:center; justify-content:center; gap:15px; flex-wrap:wrap;">
                    <div style="text-align:center; background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">ç•¶å‰ç±Œç¢¼ç¨€ç¼ºåº¦</div>
                        <div style="font-size:20px; font-weight:bold;" id="step5ScarcityIndex">--</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">ç¨€ç¼ºåº¦æ’å</div>
                        <div style="font-size:16px; font-weight:bold;" id="step5ScarcityRank">--</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:10px; opacity:0.8;">åƒç…§æ¡ˆä¾‹æ•¸</div>
                        <div style="font-size:16px; font-weight:bold;" id="step5RefCount">--</div>
                    </div>
                </div>
            </div>
            
            <!-- é›™æ–¹æ³•é æ¸¬ -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                <!-- æ–¹æ³•ä¸€ï¼šæ›è‚¡æˆæœ¬æº¢åƒ¹æ³• -->
                <div style="background:linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color:white; padding:12px; border-radius:8px;">
                    <div style="font-size:12px; font-weight:bold; margin-bottom:8px; display:flex; align-items:center; gap:5px;">
                        <span>ğŸ“</span> æ–¹æ³•ä¸€ï¼šæ›è‚¡æˆæœ¬æº¢åƒ¹æ³•
                    </div>
                    <div style="font-size:10px; opacity:0.8; margin-bottom:6px;">å¾è¨‚åƒ¹åŸºæº–åˆ°æ›è‚¡æˆæœ¬çš„å…¨ç¨‹æº¢åƒ¹ç‡</div>
                    <div style="background:rgba(255,255,255,0.15); padding:8px; border-radius:6px; margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span style="font-size:10px;">åƒç…§å…¨ç¨‹æº¢åƒ¹ç‡:</span>
                            <span style="font-size:12px; font-weight:bold;" id="step5Method1Premium">--%</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-size:10px;">é æ¸¬æ›è‚¡æˆæœ¬:</span>
                            <span style="font-size:12px; font-weight:bold;" id="step5Method1Cost">--å…ƒ</span>
                        </div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.25); padding:8px; border-radius:6px;">
                        <div style="font-size:10px; margin-bottom:2px;">é æ¸¬æœ€ä½å¾—æ¨™</div>
                        <div style="font-size:20px; font-weight:bold;" id="step5Method1Price">--</div>
                    </div>
                </div>
                
                <!-- æ–¹æ³•äºŒï¼šå››ç¶­åº¦åŠ æ¬Šæ³• -->
                <div style="background:linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%); color:white; padding:12px; border-radius:8px;">
                    <div style="font-size:12px; font-weight:bold; margin-bottom:8px; display:flex; align-items:center; gap:5px;">
                        <span>ğŸ¯</span> æ–¹æ³•äºŒï¼šå››ç¶­åº¦åŠ æ¬Šæ³•
                    </div>
                    <div style="font-size:10px; opacity:0.8; margin-bottom:6px;">ç±Œç¢¼30%+è¦æ¨¡25%+ä¿¡è©•25%+ç”¢æ¥­20%</div>
                    <div style="background:rgba(255,255,255,0.15); padding:8px; border-radius:6px; margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span style="font-size:10px;">åŠ æ¬Šå°CVæº¢åƒ¹:</span>
                            <span style="font-size:12px; font-weight:bold;" id="step5Method2Premium">--%</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-size:10px;">ç•¶å‰ç†è«–åƒ¹CV:</span>
                            <span style="font-size:12px; font-weight:bold;" id="step5Method2CV">--</span>
                        </div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.25); padding:8px; border-radius:6px;">
                        <div style="font-size:10px; margin-bottom:2px;">é æ¸¬æœ€ä½å¾—æ¨™</div>
                        <div style="font-size:20px; font-weight:bold;" id="step5Method2Price">--</div>
                    </div>
                </div>
            </div>
            
            <!-- åƒç…§æ¡ˆä¾‹ -->
            <div style="background:#f5f5f5; padding:10px; border-radius:8px; margin-bottom:12px;">
                <div style="font-size:11px; font-weight:bold; color:#333; margin-bottom:8px;">ğŸ” ç±Œç¢¼ç¨€ç¼ºåƒç…§æ¡ˆä¾‹</div>
                <div id="step5RefCases" style="font-size:10px; color:#666;">è¼‰å…¥ä¸­...</div>
            </div>
            
            <!-- ç¶œåˆé æ¸¬çµæœ -->
            <div style="background:linear-gradient(135deg, #388e3c 0%, #1b5e20 100%); color:white; padding:14px; border-radius:10px;">
                <div style="font-size:12px; opacity:0.9; margin-bottom:10px; text-align:center;">
                    ğŸ”¬ ç±Œç¢¼ç¨€ç¼ºåº¦ç¶œåˆé æ¸¬ï¼ˆå›æ¸¬é©—è­‰ï¼šç±Œç¢¼ç¨€ç¼ºé¡å‹æ–¹æ³•äºŒèª¤å·®è¼ƒä½ï¼‰
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div style="text-align:center; background:rgba(255,255,255,0.15); padding:8px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">æ–¹æ³•ä¸€é æ¸¬</div>
                        <div style="font-size:16px; font-weight:bold;" id="step5Pred1">--å…ƒ</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.15); padding:8px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">æ–¹æ³•äºŒé æ¸¬</div>
                        <div style="font-size:16px; font-weight:bold;" id="step5Pred2">--å…ƒ</div>
                    </div>
                    <div style="text-align:center; background:rgba(255,255,255,0.15); padding:8px; border-radius:6px;">
                        <div style="font-size:10px; opacity:0.8;">æ–¹æ³•å·®ç•°</div>
                        <div style="font-size:16px; font-weight:bold;" id="step5Diff">--å…ƒ</div>
                    </div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.25); padding:10px; border-radius:6px;">
                    <div style="font-size:11px; margin-bottom:4px;">ğŸ”¬ <b>ç±Œç¢¼ç¨€ç¼ºåº¦å»ºè­°å€é–“</b></div>
                    <div style="font-size:22px; font-weight:bold;" id="step5PriceRange">--</div>
                </div>
            </div>
            
            <div style="text-align:center; font-size:11px; color:#2e7d32; margin-top:10px;">
                ğŸ’¡ ç±Œç¢¼ç¨€ç¼ºåº¦ = è½‰æ›åƒ¹Ã·è‚¡æœ¬ï¼Œæ•¸å€¼è¶Šé«˜ä»£è¡¨æ›è‚¡å¾Œç±Œç¢¼è¶Šç¨€ç¼º<br>
                <span style="color:#795548;">âš ï¸ å›æ¸¬é¡¯ç¤ºï¼šç±Œç¢¼ç¨€ç¼ºé¡å‹ç”¨æ–¹æ³•äºŒï¼ˆå°CVæº¢åƒ¹æ³•ï¼‰èª¤å·®2.75%~2.83%è¼ƒæº–</span>
            </div>
        </div>
    </div>
    
</div><!-- stepReportçµæŸ -->

<div id="welcomeMsg" class="welcome-message">
    <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
    <p style="margin-top:8px; color:#666; font-size: 13px; line-height:1.6;">
        v3.97-zs-b æ•ˆèƒ½å„ªåŒ–ç‰ˆï¼ˆ17æ¬¡éæ­·â†’2æ¬¡ï¼‰<br>
        â€¢ åˆ†ææ³•æ¬Šé‡ï¼šç”¢æ¥­30%ã€ä¿¡è©•22%ã€ç†è«–åƒ¹15%ã€åˆ¸å•†13%ã€è¦æ¨¡10%ã€è‚¡æœ¬5%ã€å¹´æœŸ5%<br>
        â€¢ è‡ªé©æ‡‰å­¸ç¿’ï¼šä»¥æº¢åƒ¹ç‡è¨ˆç®—ï¼Œå»ºè­°åƒ¹=ç†è«–åƒ¹Ã—(1+æº¢åƒ¹ç‡)
    </p>
    
    <!-- Rexå¤§å”çš„æŠ•è³‡æ™ºæ…§ -->
    <div style="margin-top:15px; padding:12px 15px; background:linear-gradient(135deg, #f5f7fa 0%, #e8f4f8 100%); border-radius:8px; border-left:4px solid #667eea;">
        <div style="font-size:13px; font-weight:bold; color:#667eea; margin-bottom:8px;">ğŸ’¡ Rexå¤§å”çš„æŠ•è³‡æ™ºæ…§</div>
        <div style="font-size:12px; color:#555; line-height:1.7;">
            â€¢ å°ˆæ³¨æ–¼é¢¨éšªæ§åˆ¶ï¼Œä¸è¿½æ±‚æœ€é«˜å ±é…¬ï¼Œè€Œæ˜¯è¿½æ±‚ç©©å®šçš„ç²åˆ©æ©Ÿæœƒ<br>
            â€¢ å¯è½‰å‚µæŠ•è³‡çš„æ ¸å¿ƒåœ¨æ–¼ã€Œä¸‹æª”æœ‰ä¿è­·ï¼Œä¸Šæª”æœ‰ç©ºé–“ã€çš„ä¸å°ç¨±é¢¨éšª<br>
            â€¢ ç«¶æ‹å‡ºåƒ¹å¯§å¯ä¿å®ˆéŒ¯éï¼Œä¹Ÿä¸è¦è¡å‹•è¿½é«˜å¥—ç‰¢
        </div>
    </div>
    
    <div class="stats-summary" id="statsSummary"></div>
    
    <!-- ========== å³å´ç¬¬ä¸€å€å¡Šï¼šå¸‚å ´è¶¨å‹¢åˆ†æ ========== -->
    <div class="right-section section-trend" style="margin-top:20px;">
        <div class="right-section-header collapsed" onclick="toggleRightSection('trendSection', this)">
            <span style="font-size:18px;">ğŸ“ˆ</span>
            <span>ä¸€ã€å¸‚å ´è¶¨å‹¢åˆ†æ</span>
            <span style="font-size:11px; font-weight:normal; opacity:0.9;">ï¼ˆå®è§€æ­·å²æ•¸æ“šï¼‰</span>
            <span class="toggle-icon">â–¶</span>
        </div>
        <div class="right-section-content collapsed" id="trendSection">
    
    <!-- å¸‚å ´è¶¨å‹¢åˆ†æ -->
    <div class="market-trend-section" id="marketTrendSection" style="text-align:left;">
        <div class="market-trend-tabs">
            <button class="market-trend-tab active" onclick="showMarketTrendTab('supply', event)">ä¾›çµ¦åˆ†æ</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('yearly', event)">å¹´åº¦è¶¨å‹¢</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('industry', event)">ç”¢æ¥­åˆ†æ</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('broker', event)">åˆ¸å•†åˆ†æ</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('guarantee', event)">æ“”ä¿æ¯”è¼ƒ</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('size', event)">ç™¼è¡Œè¦æ¨¡</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('capital', event)">è‚¡æœ¬å¤§å°</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('conversion', event)">è½‰æ›åƒ¹</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('rating', event)">ä¿¡è©•</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('yearPeriod', event)">ç™¼è¡Œå¹´æœŸ</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('type', event)">ç«¶æ‹vsè©¢åœˆ</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('issueNum', event)">ç™¼è¡Œæ¬¡æ•¸</button>
            <button class="market-trend-tab" onclick="showMarketTrendTab('ky', event)">KYè‚¡åˆ†æ</button>
        </div>
        <div class="market-trend-content" id="marketTrendContent">
            è¼‰å…¥ä¸­...
        </div>
    </div>
    
        </div><!-- trendSectionçµæŸ -->
    </div><!-- å³å´ç¬¬ä¸€å€å¡ŠçµæŸ -->
    
    <!-- ========== å³å´ç¬¬äºŒå€å¡Šï¼šç¸¾æ•ˆåˆ†æ ========== -->
    <div class="right-section section-performance" style="margin-top:15px;">
        <div class="right-section-header collapsed" onclick="toggleRightSection('performanceSection', this)">
            <span style="font-size:18px;">ğŸ’°</span>
            <span>äºŒã€ç¸¾æ•ˆåˆ†æ</span>
            <span style="font-size:11px; font-weight:normal; opacity:0.9;">ï¼ˆæ­·å²ç›ˆè™§é©—è­‰ï¼‰</span>
            <span class="toggle-icon">â–¶</span>
        </div>
        <div class="right-section-content collapsed" id="performanceSection">
    
    <!-- å¹´åº¦ç¸¾æ•ˆæ’è¡Œæ¦œ -->
    <div id="rankingSection" class="ranking-section" style="text-align:left;">
        <div class="ranking-header">ğŸ† å¹´åº¦ç¸¾æ•ˆæ’è¡Œæ¦œï¼ˆTOP10 / BOTTOM10ï¼‰</div>
        <div class="ranking-tabs">
            <button type="button" class="ranking-tab active" onclick="showRankingYear(2022, event)">2022</button>
            <button type="button" class="ranking-tab" onclick="showRankingYear(2023, event)">2023</button>
            <button type="button" class="ranking-tab" onclick="showRankingYear(2024, event)">2024</button>
            <button type="button" class="ranking-tab" onclick="showRankingYear(2025, event)">2025</button>
        </div>
        <div id="rankingContent">è¼‰å…¥ä¸­...</div>
    </div>
    
    <!-- æœˆå‡æˆäº¤çœŸå¯¦ç¸¾æ•ˆ -->
    <div id="realperfSection" class="realperf-section" style="margin-top:15px; text-align:left;">
        <div class="realperf-header">ğŸ“ˆ æœˆå‡æˆäº¤çœŸå¯¦ç¸¾æ•ˆ</div>
        <div class="realperf-tabs">
            <button type="button" class="realperf-tab active" onclick="showRealPerfYear(2022, event)">2022</button>
            <button type="button" class="realperf-tab" onclick="showRealPerfYear(2023, event)">2023</button>
            <button type="button" class="realperf-tab" onclick="showRealPerfYear(2024, event)">2024</button>
            <button type="button" class="realperf-tab" onclick="showRealPerfYear(2025, event)">2025</button>
        </div>
        <div id="realperfContent">è¼‰å…¥ä¸­...</div>
    </div>
    
    <!-- ç«¶æ‹ç›ˆè™§å‹ç‡åˆ†æ -->
    <div id="profitlossSection" class="profitloss-section" style="margin-top:15px; text-align:left;">
        <div class="profitloss-header">ğŸ’° ç«¶æ‹ç›ˆè™§å‹ç‡åˆ†æ</div>
        <div class="profitloss-tabs">
            <button type="button" class="profitloss-tab active" onclick="showProfitLossYear(2022, event)">2022</button>
            <button type="button" class="profitloss-tab" onclick="showProfitLossYear(2023, event)">2023</button>
            <button type="button" class="profitloss-tab" onclick="showProfitLossYear(2024, event)">2024</button>
            <button type="button" class="profitloss-tab" onclick="showProfitLossYear(2025, event)">2025</button>
            <button type="button" class="profitloss-tab" onclick="showProfitLossYear('all', event)">å…¨éƒ¨</button>
        </div>
        <div id="profitlossContent">è¼‰å…¥ä¸­...</div>
    </div>
    
        </div><!-- performanceSectionçµæŸ -->
    </div><!-- å³å´ç¬¬äºŒå€å¡ŠçµæŸ -->
    
    <!-- ========== å³å´ç¬¬ä¸‰å€å¡Šï¼šåŸºæœ¬è³‡æ–™æŸ¥è©¢ ========== -->
    <div class="right-section section-basic-info" style="margin-top:15px;">
        <div class="right-section-header collapsed" onclick="toggleRightSection('basicInfoSection', this)">
            <span style="font-size:18px;">ğŸ“‹</span>
            <span>ä¸‰ã€åŸºæœ¬è³‡æ–™æŸ¥è©¢</span>
            <span style="font-size:11px; font-weight:normal; opacity:0.9;">ï¼ˆå€‹è‚¡å®Œæ•´è³‡è¨Šï¼‰</span>
            <span class="toggle-icon">â–¶</span>
        </div>
        <div class="right-section-content collapsed" id="basicInfoSection">
            
            <!-- CBé¸æ“‡å™¨ -->
            <div style="margin-bottom:15px; padding:15px; background:#f5f5f5; border-radius:8px;">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
                    <label style="font-weight:bold; color:#333;">ğŸ” é¸æ“‡å¯è½‰å‚µï¼š</label>
                    <select id="basicInfoCBSelect" onchange="loadBasicInfo(this.value)" style="flex:1; min-width:200px; padding:8px 12px; border:2px solid #1976d2; border-radius:6px; font-size:14px;">
                        <option value="">-- è«‹é¸æ“‡æˆ–è¼¸å…¥CBä»£è™Ÿ --</option>
                    </select>
                    <button type="button" onclick="refreshBasicInfoList()" style="padding:8px 15px; background:#1976d2; color:white; border:none; border-radius:6px; cursor:pointer;">
                        ğŸ”„ é‡æ•´
                    </button>
                </div>
                
                <!-- ç¯©é¸å™¨ -->
                <div style="display:flex; gap:20px; flex-wrap:wrap; padding:10px; background:white; border-radius:6px; border:1px solid #e0e0e0;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:12px; color:#666; font-weight:bold;">ç™¼è¡Œæ–¹å¼ï¼š</span>
                        <label style="font-size:12px; cursor:pointer;">
                            <input type="radio" name="issueMethod" value="all" checked onchange="filterCBList()"> å…¨éƒ¨
                        </label>
                        <label style="font-size:12px; cursor:pointer; color:#2e7d32;">
                            <input type="radio" name="issueMethod" value="auction" onchange="filterCBList()"> ç«¶æ‹
                            <span id="auctionCount" style="font-size:10px; color:#999;">(0)</span>
                        </label>
                        <label style="font-size:12px; cursor:pointer; color:#1976d2;">
                            <input type="radio" name="issueMethod" value="inquiry" onchange="filterCBList()"> è©¢åœˆ
                            <span id="inquiryCount" style="font-size:10px; color:#999;">(0)</span>
                        </label>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:12px; color:#666; font-weight:bold;">äº¤æ˜“ç‹€æ…‹ï¼š</span>
                        <label style="font-size:12px; cursor:pointer;">
                            <input type="radio" name="listingStatus" value="all" checked onchange="filterCBList()"> å…¨éƒ¨
                        </label>
                        <label style="font-size:12px; cursor:pointer; color:#4caf50;">
                            <input type="radio" name="listingStatus" value="listed" onchange="filterCBList()"> æ›ç‰Œä¸­
                            <span id="listedCount" style="font-size:10px; color:#999;">(0)</span>
                        </label>
                        <label style="font-size:12px; cursor:pointer; color:#9e9e9e;">
                            <input type="radio" name="listingStatus" value="delisted" onchange="filterCBList()"> å·²ä¸‹å¸‚
                            <span id="delistedCount" style="font-size:10px; color:#999;">(0)</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-top:8px; font-size:12px; color:#666; display:flex; justify-content:space-between; align-items:center;">
                    <span id="basicInfoStatus">æç¤ºï¼šå¯å¾å·¦å´ç«¶æ‹æ¸…å–®é»é¸æ¨™çš„ï¼Œæˆ–ç›´æ¥å¾ä¸‹æ‹‰é¸å–®é¸æ“‡</span>
                    <span id="cbListCount" style="font-size:11px; color:#999;"></span>
                </div>
            </div>
            
            <!-- åŸºæœ¬è³‡æ–™æ¨™ç±¤é  -->
            <div class="basic-info-tabs">
                <button type="button" class="basic-info-tab active" onclick="showBasicInfoTab('overview', event)">ğŸ“‹ åŸºæœ¬è³‡æ–™</button>
                <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('schedule', event)">ğŸ“… ç™¼è¡Œæ™‚ç¨‹</button>
                <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('putback', event)">ğŸ’° è³£å›æ¢ä»¶</button>
                <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('auction', event)">ğŸ¯ ç«¶æ‹è³‡æ–™</button>
                <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('quote', event)">ğŸ“Š æœ€æ–°è¡Œæƒ…</button>
                <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('balance', event)">ğŸ“ˆ é¤˜é¡è®ŠåŒ–</button>
            </div>
            <div id="basicInfoContent" style="min-height:200px; padding:15px; background:#fafafa; border-radius:0 0 8px 8px; border:1px solid #e0e0e0; border-top:none;">
                <div style="text-align:center; color:#999; padding:40px;">
                    ğŸ‘† è«‹å…ˆé¸æ“‡ä¸€æª”å¯è½‰å‚µ
                </div>
            </div>
            
        </div><!-- basicInfoSectionçµæŸ -->
    </div><!-- å³å´ç¬¬ä¸‰å€å¡ŠçµæŸ -->
    
    <!-- ========== å³å´ç¬¬å››å€å¡Šï¼šåƒ¹æ ¼èµ°å‹¢åˆ†æ ========== -->
    <div class="right-section section-price-trend" style="margin-top:15px;">
        <div class="right-section-header collapsed" onclick="toggleRightSection('priceTrendSection', this)">
            <span style="font-size:18px;">ğŸ“ˆ</span>
            <span>å››ã€åƒ¹æ ¼èµ°å‹¢åˆ†æ</span>
            <span style="font-size:11px; font-weight:normal; opacity:0.9;">ï¼ˆæ­·å²åƒ¹æ ¼åœ–è¡¨ï¼‰</span>
            <span class="toggle-icon">â–¶</span>
        </div>
        <div class="right-section-content collapsed" id="priceTrendSection">
            
            <!-- CBé¸æ“‡å™¨ï¼ˆåƒ¹æ ¼èµ°å‹¢ç”¨ï¼‰ -->
            <div style="margin-bottom:15px; padding:10px; background:#f5f5f5; border-radius:8px;">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <label style="font-weight:bold; color:#333;">ğŸ” é¸æ“‡å¯è½‰å‚µï¼š</label>
                    <select id="priceTrendCBSelect" onchange="loadPriceTrend(this.value)" style="flex:1; min-width:200px; padding:8px 12px; border:2px solid #388e3c; border-radius:6px; font-size:14px;">
                        <option value="">-- è«‹é¸æ“‡CBä»£è™Ÿ --</option>
                    </select>
                    <select id="priceTrendPeriod" onchange="updatePriceTrendPeriod()" style="padding:8px 12px; border:1px solid #ccc; border-radius:6px;">
                        <option value="30">è¿‘30å¤©</option>
                        <option value="60">è¿‘60å¤©</option>
                        <option value="90" selected>è¿‘90å¤©</option>
                        <option value="180">è¿‘180å¤©</option>
                        <option value="all">å…¨éƒ¨æœŸé–“</option>
                    </select>
                </div>
            </div>
            
            <!-- åƒ¹æ ¼èµ°å‹¢æ¨™ç±¤é  -->
            <div class="price-trend-tabs">
                <button type="button" class="price-trend-tab active" onclick="showPriceTrendTab('stockPrice', event)">ğŸ“ˆ è‚¡åƒ¹èˆ‡è½‰æ›åƒ¹</button>
                <button type="button" class="price-trend-tab" onclick="showPriceTrendTab('cbPrice', event)">ğŸ’¹ ç†è«–åƒ¹å€¼åˆ†æ</button>
                <button type="button" class="price-trend-tab" onclick="showPriceTrendTab('balance', event)">ğŸ“Š ç±Œç¢¼è½‰æ›åˆ†æ</button>
            </div>
            <div id="priceTrendContent" style="min-height:300px; padding:15px; background:#fafafa; border-radius:0 0 8px 8px; border:1px solid #e0e0e0; border-top:none;">
                <div style="text-align:center; color:#999; padding:40px;">
                    ğŸ‘† è«‹å…ˆé¸æ“‡ä¸€æª”å¯è½‰å‚µæŸ¥çœ‹åƒ¹æ ¼èµ°å‹¢
                </div>
            </div>
            
        </div><!-- priceTrendSectionçµæŸ -->
    </div><!-- å³å´ç¬¬å››å€å¡ŠçµæŸ -->
    
</div>
<div id="evaluationResult" class="evaluation-result"></div>

</div>

</div>

<!-- ç‰ˆæ¬Šå®£å‘Šèˆ‡ç€è¦½äººæ•¸ -->

<footer class="site-footer">
    <div class="footer-content">
        <div class="visitor-count">
            ğŸ‘ï¸ ç€è¦½äººæ•¸ï¼š
            <a href="https://www.hitwebcounter.com" target="_blank">
                <img src="https://hitwebcounter.com/counter/counter.php?page=16839468&style=0006&nbdigits=6&type=page&initCount=0" 
                     title="Counter Widget" alt="Visit counter" border="0" style="vertical-align: middle;"/>
            </a>
        </div>
        <div class="copyright">
            Â© 2025 Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ ç‰ˆæ¬Šæ‰€æœ‰<br>
            <span style="font-size:11px; color:#999;">æœ¬ç³»çµ±åƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è‡ªè² ç›ˆè™§</span>
        </div>
    </div>
</footer>

</div>

<script>
// ==========================================
// 0. åˆå§‹åŒ–æ¬Šé‡ä¿‚æ•¸
// ==========================================
if (typeof window.WEIGHT_COEFFICIENTS === 'undefined') {
    window.WEIGHT_COEFFICIENTS = {
        'industry': {}, 
        'broker': {}, 
        'capital': {}, 
        'size': {}, 
        'rating': {}, 
        'guarantee': {}, 
        'years': {}, 
        'conversion': {}
    };
    console.log('ğŸ“Š WEIGHT_COEFFICIENTS åˆå§‹åŒ–å®Œæˆï¼ˆç­‰å¾…Excelè¼‰å…¥ï¼‰');
}

// ==========================================
// 1. æ¬„ä½è¨­å®š & å·¥å…·å‡½æ•¸
// ==========================================
const FIELD_ALIASES = {
    'cbId': ['CBä»£è™Ÿ', 'ä»£è™Ÿ', 'è‚¡ç¥¨ä»£è™Ÿ'], 
    'stockId': ['è‚¡ç¥¨ä»£è™Ÿ'],
    'name': ['åç¨±', 'CBåç¨±', 'å…¬å¸åç¨±'],
    'openDate': ['é–‹æ¨™æ—¥æœŸ', 'é–‹æ¨™æ—¥'],
    'industry': ['ç”¢æ¥­åˆ†é¡', 'ç”¢æ¥­åˆ¥', 'ç”¢æ¥­'], 
    'broker': ['ç™¼è¡Œåˆ¸å•†', 'æ‰¿éŠ·åˆ¸å•†', 'ä¸»è¾¦åˆ¸å•†'],
    'guarantee': ['æ“”ä¿', 'æœ‰ç„¡æ“”ä¿', 'æ“”ä¿æƒ…å½¢'], 
    'rating': ['ä¿¡è©•', 'ä¿¡ç”¨æ“”ä¿', 'TCRI', 'ä¿¡ç”¨è©•ç­‰'],
    'capital': ['è‚¡æœ¬å¤§å°', 'è‚¡æœ¬', 'è‚¡æœ¬è¦æ¨¡', 'è‚¡æœ¬(å„„)'], 
    'issueSize': ['ç™¼è¡Œè¦æ¨¡', 'ç™¼è¡Œç¸½é¡'],
    'years': ['å¹´æœŸ', 'ç™¼è¡Œå¹´æœŸ'], 
    'conversionPrice': ['è½‰æ›åƒ¹', 'è½‰æ›åƒ¹æ ¼'],
    'closePrice': ['æˆªæ¨™æ”¶ç›¤', 'æˆªæ¨™æ—¥æ”¶ç›¤'],
    'theoreticalPrice': ['ç†è«–åƒ¹', 'ç†è«–åƒ¹æ ¼'],
    'floorPrice': ['åº•æ¨™åƒ¹', 'åº•æ¨™'],
    'premiumRate': ['è¨‚åƒ¹æº¢åƒ¹ç‡', 'æº¢åƒ¹ç‡'],
    'minBidPrice': ['æœ€ä½å¾—æ¨™', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼', 'æœ€ä½å¾—æ¨™åƒ¹'], 
    'lowPremium': ['æœ€ä½æº¢åƒ¹', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡', 'æœ€ä½å¾—æ¨™æº¢åƒ¹', 'æœ€ä½æº¢åƒ¹(%)'],
    'avgBidPrice': ['å¹³å‡å¾—æ¨™', 'å¹³å‡å¾—æ¨™åƒ¹æ ¼', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼', 'å¹³å‡å¾—æ¨™åƒ¹'], 
    'avgPremium': ['å¹³å‡æº¢åƒ¹', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡', 'å¹³å‡å¾—æ¨™æº¢åƒ¹', 'å¹³å‡æº¢åƒ¹(%)'],
    'marketHigh': ['æ›ç‰Œæœ€é«˜', 'æ›ç‰Œæœ€é«˜åƒ¹'], 
    'marketLow': ['æ›ç‰Œæœ€ä½', 'æ›ç‰Œæœ€ä½åƒ¹'],
    'qualifiedCount': ['åˆæ ¼ä»¶æ•¸', 'åˆæ ¼æ¨™å–®'],
    'bidShares': ['æŠ•æ¨™å¼µæ•¸', 'æŠ•æ¨™ç¸½å¼µæ•¸'],
    'bidMultiple': ['æŠ•æ¨™å€æ•¸'],
    'avgBidShares': ['æŠ•æ¨™å‡å¼µ', 'å¹³å‡æŠ•æ¨™å¼µæ•¸'],
    'auctionShares': ['ç«¶æ‹å¼µæ•¸', 'ç«¶æ‹ç¸½å¼µæ•¸']
};

// ç”¢æ¥­åˆ†é¡åç¨±å°æ‡‰è¡¨ï¼ˆ05å·¥ä½œè¡¨ç¯©é¸åç¨± â†’ 04å·¥ä½œè¡¨å¯¦éš›åç¨±ï¼‰
// å› ç‚º05å·¥ä½œè¡¨ç”¨ç°¡ç¨±ï¼Œ04å·¥ä½œè¡¨ç”¨å…¨åï¼Œéœ€è¦åšå°æ‡‰
const INDUSTRY_NAME_MAP = {
    'åŒ–å·¥': 'åŒ–å­¸å·¥æ¥­',
    'åŠå°é«”': 'åŠå°é«”æ¥­',
    'èˆªé‹': 'èˆªé‹æ¥­',
    'å…‰é›»': 'å…‰é›»æ¥­',
    'å…¶ä»–é›»å­': 'å…¶ä»–é›»å­æ¥­',
    'å…¶ä»–': 'å…¶ä»–æ¥­',
    'å»ºæç‡Ÿé€ ': 'å»ºæç‡Ÿé€ æ¥­',
    'ç”ŸæŠ€é†«ç™‚': 'ç”ŸæŠ€é†«ç™‚æ¥­',
    'é›»å­é›¶çµ„ä»¶': 'é›»å­é›¶çµ„ä»¶æ¥­',
    'é›»è…¦åŠé€±é‚Šè¨­å‚™': 'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­',
    'æ²¹é›»ç‡ƒæ°£': 'æ²¹é›»ç‡ƒæ°£æ¥­',
    'è¾²æ¥­ç§‘æŠ€': 'è¾²æ¥­ç§‘æŠ€æ¥­',
    'æ–‡åŒ–å‰µæ„': 'æ–‡åŒ–å‰µæ„æ¥­',
    'é€šä¿¡ç¶²è·¯': 'é€šä¿¡ç¶²è·¯æ¥­',
    'è³‡è¨Šæœå‹™': 'è³‡è¨Šæœå‹™æ¥­',
    'é›»å­é€šè·¯': 'é›»å­é€šè·¯æ¥­',
    'é‹¼éµ': 'é‹¼éµå·¥æ¥­',
    'å¡‘è† ': 'å¡‘è† å·¥æ¥­',
    'é€ ç´™': 'é€ ç´™å·¥æ¥­',
    'é£Ÿå“': 'é£Ÿå“å·¥æ¥­',
    'æ±½è»Š': 'æ±½è»Šå·¥æ¥­',
    'è²¿æ˜“ç™¾è²¨': 'è²¿æ˜“ç™¾è²¨æ¥­',
    'è­‰åˆ¸': 'è­‰åˆ¸æ¥­'
};

// ==========================================
// v3.84 2203æª”CBå¯¦è­‰ä¿‚æ•¸å¸¸æ•¸è¡¨ï¼ˆå®Œå…¨æ ¹æ“šå¯¦è­‰æ•¸æ“šï¼‰
// ==========================================

// ç”¢æ¥­ä¿‚æ•¸ï¼ˆæ¬Šé‡30%ï¼‰- åŸºæº–å„ªè‰¯ç‡63.3%
const INDUSTRY_COEFFICIENT = {
    'é›»å­é›¶çµ„ä»¶æ¥­': 1.14,   // å„ªè‰¯ç‡72.3%
    'é›»å­é€šè·¯æ¥­': 1.14,     // å„ªè‰¯ç‡71.9%
    'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­': 1.13,// å„ªè‰¯ç‡71.4%
    'å…¶ä»–é›»å­æ¥­': 1.12,     // å„ªè‰¯ç‡70.8%
    'åŒ–å­¸å·¥æ¥­': 1.12,       // å„ªè‰¯ç‡70.6%
    'ç”ŸæŠ€é†«ç™‚æ¥­': 1.11,     // å„ªè‰¯ç‡70.0%
    'åŠå°é«”æ¥­': 1.09,       // å„ªè‰¯ç‡68.8%
    'é€šä¿¡ç¶²è·¯æ¥­': 1.04,     // å„ªè‰¯ç‡66.1%
    'é‹å‹•ä¼‘é–’': 1.01,       // å„ªè‰¯ç‡64.1%
    'é‹¼éµå·¥æ¥­': 1.00,       // å„ªè‰¯ç‡63.4%ï¼ˆåŸºæº–ï¼‰
    'è§€å…‰é¤æ—…': 0.95,       // å„ªè‰¯ç‡60.0%
    'èˆªé‹æ¥­': 0.93,         // å„ªè‰¯ç‡58.8%
    'é›»æ©Ÿæ©Ÿæ¢°': 0.92,       // å„ªè‰¯ç‡58.3%
    'å…‰é›»æ¥­': 0.91,         // å„ªè‰¯ç‡57.6%
    'å»ºæç‡Ÿé€ æ¥­': 0.89,     // å„ªè‰¯ç‡56.2%
    'å…¶ä»–æ¥­': 0.86,         // å„ªè‰¯ç‡54.3%
    'æ±½è»Šå·¥æ¥­': 0.82,       // å„ªè‰¯ç‡52.1%
    'ç¶ èƒ½ç’°ä¿': 0.79,       // å„ªè‰¯ç‡50.0%
    'ç´¡ç¹”çº–ç¶­': 0.74,       // å„ªè‰¯ç‡46.7%
    'å±…å®¶ç”Ÿæ´»': 0.57        // å„ªè‰¯ç‡36.0%ï¼ˆæœ€å·®ï¼‰
};

// ä¿¡ç”¨è©•ç­‰ä¿‚æ•¸ï¼ˆæ¬Šé‡22%ï¼‰- TCRI 4-5æœ€ä½³ï¼ŒTCRI 7æœ€å·®
const TCRI_COEFFICIENT = {
    3: 0.85,   // å„ªè‰¯ç‡53.6%
    4: 1.03,   // å„ªè‰¯ç‡65.0%ï¼ˆâ˜…å„ªè‰¯ï¼‰
    5: 1.04,   // å„ªè‰¯ç‡66.0%ï¼ˆâ˜…æœ€ä½³ï¼‰
    6: 0.87,   // å„ªè‰¯ç‡55.1%
    7: 0.69,   // å„ªè‰¯ç‡43.9%ï¼ˆâ˜…æœ€å·®ï¼‰
    8: 0.82    // å„ªè‰¯ç‡51.8%
};

// ç†è«–åƒ¹ä¿‚æ•¸ï¼ˆæ¬Šé‡15%ï¼‰- ç«¶æ‹å°ˆç”¨ï¼Œæ ¹æ“šå®‰å…¨é‚Šéš›
const THEO_PRICE_COEFFICIENT = {
    'under95': 1.15,    // <95å…ƒï¼šæ¥µä½³å®‰å…¨é‚Šéš›
    '95to100': 1.10,    // 95-100å…ƒï¼šè‰¯å¥½å®‰å…¨é‚Šéš›
    '100to105': 1.00,   // 100-105å…ƒï¼šåŸºæº–å€é–“
    '105to110': 0.90,   // 105-110å…ƒï¼šå®‰å…¨é‚Šéš›æ”¶çª„
    '110to115': 0.75,   // 110-115å…ƒï¼šè¿½åƒ¹é¢¨éšªæé«˜
    'over115': 0.60     // >115å…ƒï¼šé«˜é¢¨éšªå€é–“
};

// åˆ¸å•†ä¿‚æ•¸ï¼ˆæ¬Šé‡13%ï¼‰
const BROKER_COEFFICIENT = {
    'çµ±ä¸€è­‰åˆ¸': 1.14,   // å„ªè‰¯ç‡72.4%ï¼ˆâ˜…æœ€ä½³ï¼‰
    'å°æ–°è­‰åˆ¸': 1.04,   // å„ªè‰¯ç‡65.6%
    'å¯Œé‚¦è­‰åˆ¸': 0.97,   // å„ªè‰¯ç‡61.7%
    'å‡±åŸºè­‰åˆ¸': 0.97,   // å„ªè‰¯ç‡61.6%
    'ä¸­ä¿¡è­‰åˆ¸': 0.96,   // å„ªè‰¯ç‡60.7%
    'ç¾¤ç›Šè­‰åˆ¸': 0.95,   // å„ªè‰¯ç‡60.0%
    'ç¦é‚¦è­‰åˆ¸': 0.93,   // å„ªè‰¯ç‡58.7%
    'æ°¸è±é‡‘è­‰': 0.91,   // å„ªè‰¯ç‡57.8%
    'è¯å—æ°¸æ˜Œ': 0.88,   // å„ªè‰¯ç‡56.0%
    'å…ƒå¯Œè­‰åˆ¸': 0.86,   // å„ªè‰¯ç‡54.6%
    'å…ƒå¤§è­‰åˆ¸': 0.83,   // å„ªè‰¯ç‡52.5%
    'å…†è±è­‰åˆ¸': 0.79,   // å„ªè‰¯ç‡50.0%
    'åˆåº«è­‰åˆ¸': 0.77,   // å„ªè‰¯ç‡48.8%
    'å®é è­‰åˆ¸': 0.75,   // å„ªè‰¯ç‡47.6%
    'åœ‹ç¥¨è­‰åˆ¸': 0.73,   // å„ªè‰¯ç‡46.0%
    'åœ‹æ³°è­‰åˆ¸': 0.67    // å„ªè‰¯ç‡42.2%ï¼ˆâ˜…æœ€å·®ï¼‰
};

// ç™¼è¡Œè¦æ¨¡ä¿‚æ•¸ï¼ˆæ¬Šé‡10%ï¼‰- å°å‹æœ€ä½³ï¼Œå¤§å‹æœ€å·®
const ISSUE_SIZE_COEFFICIENT = {
    'small': 0.99,      // <3å„„ï¼šå„ªè‰¯ç‡62.8%ï¼ˆâ˜…æœ€ä½³ï¼‰
    'medium_small': 0.94, // 3-5å„„ï¼šå„ªè‰¯ç‡59.7%
    'medium': 0.99,     // 5-10å„„ï¼šå„ªè‰¯ç‡62.4%ï¼ˆâ˜…æœ€ä½³ï¼‰
    'medium_large': 0.97, // 10-20å„„ï¼šå„ªè‰¯ç‡61.3%
    'large': 0.79       // >=20å„„ï¼šå„ªè‰¯ç‡49.7%ï¼ˆâ˜…æœ€å·®ï¼‰
};

// è‚¡æœ¬ä¿‚æ•¸ï¼ˆæ¬Šé‡5%ï¼‰- ä¸­å°å‹æœ€ä½³ï¼Œå¤§å‹æœ€å·®
const STOCK_CAP_COEFFICIENT = {
    'small': 0.92,      // <10å„„ï¼šå„ªè‰¯ç‡58.2%
    'medium_small': 0.98, // 10-20å„„ï¼šå„ªè‰¯ç‡62.1%ï¼ˆâ˜…æœ€ä½³ï¼‰
    'medium': 0.97,     // 20-50å„„ï¼šå„ªè‰¯ç‡61.4%
    'medium_large': 0.88, // 50-100å„„ï¼šå„ªè‰¯ç‡55.4%
    'large': 0.81       // >=100å„„ï¼šå„ªè‰¯ç‡51.1%ï¼ˆâ˜…æœ€å·®ï¼‰
};

// å¹´æœŸä¿‚æ•¸ï¼ˆæ¬Šé‡5%ï¼‰- 5å¹´æœŸå„ªæ–¼3å¹´æœŸ
const YEAR_COEFFICIENT = {
    3: 0.91,   // å„ªè‰¯ç‡57.6%
    5: 1.04    // å„ªè‰¯ç‡66.1%ï¼ˆâ˜…æœ€ä½³ï¼‰
};

// v3.84 æ¬Šé‡é…ç½®ï¼ˆä¸ƒç¶­åº¦å®Œæ•´ç‰ˆï¼‰
const WEIGHT_CONFIG = {
    industry: 0.30,     // ç”¢æ¥­ï¼ˆå¯¦è­‰å½±éŸ¿æœ€å¤§ï¼‰
    rating: 0.22,       // ä¿¡è©•
    theoPrice: 0.15,    // ç†è«–åƒ¹ï¼ˆç«¶æ‹å°ˆç”¨ï¼‰
    broker: 0.13,       // åˆ¸å•†
    issueSize: 0.10,    // ç™¼è¡Œè¦æ¨¡
    stockCap: 0.05,     // è‚¡æœ¬
    years: 0.05         // å¹´æœŸ
};

// v3.85 å¸‚å ´æ°›åœæ¬Šé‡é…ç½®ï¼ˆäº”ç¶­åº¦ç²¾ç°¡ç‰ˆï¼‰
// æ ¹æ“šå¯¦è­‰æ•¸æ“šé‡æ–°è¨­è¨ˆï¼šç”¢æ¥­æœ€é‡è¦ã€åˆ¸å•†è¢«ä½ä¼°ã€ä¿¡è©•ä¸æ˜¯è¶Šä½è¶Šå¥½
const MARKET_ATMOSPHERE_WEIGHTS = {
    industry: 0.35,     // ç”¢æ¥­ï¼ˆå„ªè‰¯ç‡å·®è·36%ï¼Œå¯¦è­‰å½±éŸ¿æœ€å¤§ï¼‰
    broker: 0.25,       // åˆ¸å•†ï¼ˆå„ªè‰¯ç‡å·®è·30%ï¼ŒåŸæœ¬è¢«å®Œå…¨å¿½ç•¥ï¼ï¼‰
    rating: 0.20,       // ä¿¡è©•ï¼ˆå„ªè‰¯ç‡å·®è·22%ï¼ŒåŸæœ¬é«˜ä¼°ï¼‰
    issueSize: 0.10,    // è¦æ¨¡ï¼ˆå„ªè‰¯ç‡å·®è·13%ï¼ŒåŸæœ¬é«˜ä¼°ï¼‰
    theoPrice: 0.10     // ç†è«–åƒ¹ï¼ˆç«¶æ‹å®‰å…¨é‚Šéš›è€ƒé‡ï¼‰
};

// ==========================================
// v3.84 ä¿‚æ•¸æŸ¥è©¢å‡½æ•¸
// ==========================================

/**
 * å–å¾—ç”¢æ¥­ä¿‚æ•¸
 */
function getIndustryCoefficient(industry) {
    if (!industry) return 1.00;
    const industryStr = String(industry);
    // ç²¾ç¢ºåŒ¹é…
    if (INDUSTRY_COEFFICIENT[industryStr]) {
        return INDUSTRY_COEFFICIENT[industryStr];
    }
    // æ¨¡ç³ŠåŒ¹é…
    for (const [key, value] of Object.entries(INDUSTRY_COEFFICIENT)) {
        if (industryStr.includes(key) || key.includes(industryStr)) {
            return value;
        }
    }
    return 1.00;  // æœªçŸ¥ç”¢æ¥­çµ¦åŸºæº–ä¿‚æ•¸
}

/**
 * å–å¾—ä¿¡è©•ä¿‚æ•¸
 */
function getTcriCoefficient(tcri) {
    const rating = parseInt(tcri) || 5;
    return TCRI_COEFFICIENT[rating] || 0.87;  // é è¨­çµ¦TCRI 6çš„ä¿‚æ•¸
}

/**
 * å–å¾—ç†è«–åƒ¹ä¿‚æ•¸
 */
function getTheoPriceCoefficient(theoPrice) {
    const price = parseFloat(theoPrice) || 100;
    if (price < 95) return THEO_PRICE_COEFFICIENT['under95'];
    if (price < 100) return THEO_PRICE_COEFFICIENT['95to100'];
    if (price < 105) return THEO_PRICE_COEFFICIENT['100to105'];
    if (price < 110) return THEO_PRICE_COEFFICIENT['105to110'];
    if (price < 115) return THEO_PRICE_COEFFICIENT['110to115'];
    return THEO_PRICE_COEFFICIENT['over115'];
}

/**
 * å–å¾—åˆ¸å•†ä¿‚æ•¸
 */
function getBrokerCoefficient(broker) {
    if (!broker) return 0.95;  // æœªçŸ¥åˆ¸å•†çµ¦ä¸­æ€§ä¿‚æ•¸
    const brokerStr = String(broker);
    // ç²¾ç¢ºåŒ¹é…
    if (BROKER_COEFFICIENT[brokerStr]) {
        return BROKER_COEFFICIENT[brokerStr];
    }
    // æ¨¡ç³ŠåŒ¹é…
    for (const [key, value] of Object.entries(BROKER_COEFFICIENT)) {
        if (brokerStr.includes(key.replace('è­‰åˆ¸', '').replace('é‡‘è­‰', ''))) {
            return value;
        }
    }
    return 0.95;
}

/**
 * å–å¾—ç™¼è¡Œè¦æ¨¡ä¿‚æ•¸
 */
function getIssueSizeCoefficient(size) {
    const amount = parseFloat(size) || 5;
    if (amount < 3) return ISSUE_SIZE_COEFFICIENT['small'];
    if (amount < 5) return ISSUE_SIZE_COEFFICIENT['medium_small'];
    if (amount < 10) return ISSUE_SIZE_COEFFICIENT['medium'];
    if (amount < 20) return ISSUE_SIZE_COEFFICIENT['medium_large'];
    return ISSUE_SIZE_COEFFICIENT['large'];
}

/**
 * å–å¾—è‚¡æœ¬ä¿‚æ•¸
 */
function getStockCapCoefficient(cap) {
    const capital = parseFloat(cap) || 20;
    if (capital < 10) return STOCK_CAP_COEFFICIENT['small'];
    if (capital < 20) return STOCK_CAP_COEFFICIENT['medium_small'];
    if (capital < 50) return STOCK_CAP_COEFFICIENT['medium'];
    if (capital < 100) return STOCK_CAP_COEFFICIENT['medium_large'];
    return STOCK_CAP_COEFFICIENT['large'];
}

/**
 * å–å¾—å¹´æœŸä¿‚æ•¸
 */
function getYearCoefficient(years) {
    const y = parseInt(years) || 3;
    return YEAR_COEFFICIENT[y] || 0.91;
}

/**
 * v3.84 è¨ˆç®—ç¶œåˆä¿‚æ•¸ï¼ˆä¹˜æ³•æ¨¡å‹ï¼‰
 * ç¶œåˆä¿‚æ•¸ = ç”¢æ¥­ä¿‚æ•¸^0.30 Ã— ä¿¡è©•ä¿‚æ•¸^0.22 Ã— ç†è«–åƒ¹ä¿‚æ•¸^0.15 Ã— 
 *            åˆ¸å•†ä¿‚æ•¸^0.13 Ã— è¦æ¨¡ä¿‚æ•¸^0.10 Ã— è‚¡æœ¬ä¿‚æ•¸^0.05 Ã— å¹´æœŸä¿‚æ•¸^0.05
 */
function calculateComprehensiveCoefficient(params) {
    const {
        industry,
        rating,
        theoPrice,
        broker,
        issueSize,
        stockCap,
        years
    } = params;
    
    // å–å¾—å„ç¶­åº¦ä¿‚æ•¸
    const industryCoef = getIndustryCoefficient(industry);
    const ratingCoef = getTcriCoefficient(rating);
    const theoCoef = getTheoPriceCoefficient(theoPrice);
    const brokerCoef = getBrokerCoefficient(broker);
    const sizeCoef = getIssueSizeCoefficient(issueSize);
    const capCoef = getStockCapCoefficient(stockCap);
    const yearCoef = getYearCoefficient(years);
    
    // ä¹˜æ³•æ¨¡å‹ï¼šå„ä¿‚æ•¸çš„åŠ æ¬Šå¹¾ä½•å¹³å‡
    const comprehensiveCoef = 
        Math.pow(industryCoef, WEIGHT_CONFIG.industry) *
        Math.pow(ratingCoef, WEIGHT_CONFIG.rating) *
        Math.pow(theoCoef, WEIGHT_CONFIG.theoPrice) *
        Math.pow(brokerCoef, WEIGHT_CONFIG.broker) *
        Math.pow(sizeCoef, WEIGHT_CONFIG.issueSize) *
        Math.pow(capCoef, WEIGHT_CONFIG.stockCap) *
        Math.pow(yearCoef, WEIGHT_CONFIG.years);
    
    console.log('ğŸ“Š v3.84 ç¶œåˆä¿‚æ•¸è¨ˆç®—:');
    console.log('  ç”¢æ¥­:', industry, 'â†’', industryCoef.toFixed(2), '(^0.30)');
    console.log('  ä¿¡è©•: TCRI', rating, 'â†’', ratingCoef.toFixed(2), '(^0.22)');
    console.log('  ç†è«–åƒ¹:', theoPrice, 'â†’', theoCoef.toFixed(2), '(^0.15)');
    console.log('  åˆ¸å•†:', broker, 'â†’', brokerCoef.toFixed(2), '(^0.13)');
    console.log('  è¦æ¨¡:', issueSize, 'å„„ â†’', sizeCoef.toFixed(2), '(^0.10)');
    console.log('  è‚¡æœ¬:', stockCap, 'å„„ â†’', capCoef.toFixed(2), '(^0.05)');
    console.log('  å¹´æœŸ:', years, 'å¹´ â†’', yearCoef.toFixed(2), '(^0.05)');
    console.log('  ğŸ¯ ç¶œåˆä¿‚æ•¸:', comprehensiveCoef.toFixed(4));
    
    return {
        comprehensive: comprehensiveCoef,
        breakdown: {
            industry: { value: industry, coefficient: industryCoef, weight: WEIGHT_CONFIG.industry },
            rating: { value: rating, coefficient: ratingCoef, weight: WEIGHT_CONFIG.rating },
            theoPrice: { value: theoPrice, coefficient: theoCoef, weight: WEIGHT_CONFIG.theoPrice },
            broker: { value: broker, coefficient: brokerCoef, weight: WEIGHT_CONFIG.broker },
            issueSize: { value: issueSize, coefficient: sizeCoef, weight: WEIGHT_CONFIG.issueSize },
            stockCap: { value: stockCap, coefficient: capCoef, weight: WEIGHT_CONFIG.stockCap },
            years: { value: years, coefficient: yearCoef, weight: WEIGHT_CONFIG.years }
        }
    };
}

/**
 * v3.84 TCRI6ç„¡æ“”ä¿æº¢åƒ¹èª¿æ•´
 * æ¢ä»¶ï¼šä¿¡ç”¨è©•ç­‰ = 6åˆ† ä¸” æ“”ä¿ = ç„¡
 * èª¿æ•´ï¼šæº¢åƒ¹èª¿é™ 3 å…ƒï¼ˆæ ¹æ“šå¯¦è­‰å¹³å‡å·®è·2.6-3.3å…ƒï¼‰
 */
function getTcri6UnsecuredAdjustment(rating, guarantee, theoPrice) {
    const ratingNum = parseInt(rating) || 5;
    const isUnsecured = !guarantee || guarantee === 'ç„¡' || guarantee === 'ç„¡æ“”ä¿' || guarantee.includes('ç„¡');
    
    if (ratingNum === 6 && isUnsecured) {
        // æ ¹æ“šç†è«–åƒ¹å€é–“ç´°ç·»èª¿æ•´
        const price = parseFloat(theoPrice) || 100;
        let adjustment = -3;  // é è¨­èª¿é™3å…ƒ
        
        if (price < 95) {
            adjustment = -2;  // ç†è«–åƒ¹<95ï¼šèª¿é™2å…ƒ
        } else if (price < 100) {
            adjustment = -1;  // ç†è«–åƒ¹95-100ï¼šèª¿é™1å…ƒ
        } else if (price < 105) {
            adjustment = -3;  // ç†è«–åƒ¹100-105ï¼šèª¿é™3å…ƒ
        } else {
            adjustment = -3;  // ç†è«–åƒ¹>105ï¼šèª¿é™3å…ƒ
        }
        
        console.log('âš ï¸ TCRI6ç„¡æ“”ä¿èª¿æ•´: æº¢åƒ¹', adjustment, 'å…ƒ');
        return {
            isApplicable: true,
            adjustment: adjustment,
            note: `TCRI6ç„¡æ“”ä¿ï¼Œæº¢åƒ¹èª¿é™${Math.abs(adjustment)}å…ƒï¼ˆç„¡æ³•æ‹†CBASï¼Œå¤§æˆ¶åƒèˆ‡æ„é¡˜ä½ï¼‰`
        };
    }
    
    return {
        isApplicable: false,
        adjustment: 0,
        note: ''
    };
}

/**
 * v3.84 è¨ˆç®—æŠ•æ¨™ä¸è¶³æŒ‡æ¨™
 * åµæ¸¬å¸‚å ´æ¥µç«¯æ‚²è§€æ™‚æ©Ÿ
 */
function calcUndersubscriptionIndicator(targetDate) {
    // v3.97r ä¿®æ­£ï¼šçµ±ä¸€ä½¿ç”¨ auctionDataCacheï¼ˆå¾Excelè¼‰å…¥ï¼‰
    if (!window.auctionDataCache || window.auctionDataCache.length === 0) {
        return null;
    }
    
    const target = parseExcelDate(targetDate);
    if (!target) return null;
    
    // å–æœ€è¿‘3å€‹æœˆå…§çš„ç«¶æ‹æ¡ˆä¾‹
    const threeMonthsAgo = new Date(target);
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
    
    const recentCases = window.auctionDataCache.filter(row => {
        const openDate = parseExcelDate(getSmartValue(row, 'openDate'));
        if (!openDate) return false;
        return openDate >= threeMonthsAgo && openDate < target;
    });
    
    if (recentCases.length === 0) return null;
    
    // çµ±è¨ˆæŠ•æ¨™ä¸è¶³æ¡ˆä¾‹ï¼ˆæŠ•æ¨™å€æ•¸ < 1ï¼‰
    const undersubscribedCases = recentCases.filter(row => {
        const bidMultiple = safeFloat(getSmartValue(row, 'bidMultiple'));
        return bidMultiple > 0 && bidMultiple < 1;
    });
    
    // çµ±è¨ˆæœ‰æ“”ä¿æŠ•æ¨™ä¸è¶³æ¡ˆä¾‹ï¼ˆæ’é™¤TCRI 7-8ï¼‰
    const securedUndersubscribed = undersubscribedCases.filter(row => {
        const guarantee = getSmartValue(row, 'guarantee');
        const rating = parseInt(getSmartValue(row, 'rating')) || 5;
        const isSecured = guarantee && (guarantee === 'æœ‰' || guarantee === 'æœ‰æ“”ä¿' || guarantee.includes('æœ‰'));
        return isSecured && rating <= 6;
    });
    
    const totalCount = recentCases.length;
    const undersubscribedCount = undersubscribedCases.length;
    const undersubscribedRate = totalCount > 0 ? (undersubscribedCount / totalCount * 100) : 0;
    
    // åˆ¤æ–·å¸‚å ´ç‹€æ…‹
    let marketState = 'æ­£å¸¸';
    let recommendation = 'æŒ‰æ­£å¸¸æµç¨‹è©•ä¼°';
    let color = '#4caf50';
    
    if (undersubscribedRate >= 15 || securedUndersubscribed.length >= 2) {
        marketState = 'æ¥µç«¯æ‚²è§€';
        recommendation = 'â˜… å¯è€ƒæ…®æ›´ç©æ¥µåƒèˆ‡ï¼ˆæ­·å²ä¸ŠæŠ•æ¨™ä¸è¶³æ¡ˆä¾‹100%ç²åˆ©ï¼‰';
        color = '#d32f2f';
    } else if (undersubscribedRate >= 10 || securedUndersubscribed.length >= 1) {
        marketState = 'åæ‚²è§€';
        recommendation = 'å¸‚å ´æƒ…ç·’åä½ï¼Œå¯é©åº¦ç©æ¥µ';
        color = '#ff9800';
    } else if (undersubscribedCount >= 2) {
        marketState = 'è­¦ç¤º';
        recommendation = 'è¿‘æœŸæœ‰æŠ•æ¨™ä¸è¶³æ¡ˆä¾‹ï¼Œç•™æ„å¸‚å ´è®ŠåŒ–';
        color = '#ffc107';
    }
    
    console.log('ğŸ“‰ æŠ•æ¨™ä¸è¶³æŒ‡æ¨™:');
    console.log('  è¿‘3å€‹æœˆç«¶æ‹æ•¸:', totalCount);
    console.log('  æŠ•æ¨™ä¸è¶³æ•¸:', undersubscribedCount, '(', undersubscribedRate.toFixed(1), '%)');
    console.log('  æœ‰æ“”ä¿æŠ•æ¨™ä¸è¶³:', securedUndersubscribed.length);
    console.log('  å¸‚å ´ç‹€æ…‹:', marketState);
    
    return {
        totalCount: totalCount,
        undersubscribedCount: undersubscribedCount,
        undersubscribedRate: undersubscribedRate,
        securedUndersubscribedCount: securedUndersubscribed.length,
        marketState: marketState,
        recommendation: recommendation,
        color: color,
        cases: undersubscribedCases.map(row => ({
            name: getSmartValue(row, 'name'),
            openDate: formatDate(getSmartValue(row, 'openDate')),
            bidMultiple: safeFloat(getSmartValue(row, 'bidMultiple')),
            guarantee: getSmartValue(row, 'guarantee')
        }))
    };
}

// å–å¾—ç”¢æ¥­çš„å¯¦éš›åç¨±ï¼ˆæ”¯æ´é›™å‘æŸ¥æ‰¾ï¼‰
function getIndustryActualName(filterName) {
    if (!filterName) return filterName;
    // å…ˆæŸ¥mapping
    if (INDUSTRY_NAME_MAP[filterName]) return INDUSTRY_NAME_MAP[filterName];
    // å¦‚æœå·²ç¶“æ˜¯å¯¦éš›åç¨±å°±ç›´æ¥è¿”å›
    return filterName;
}

// æª¢æŸ¥ç”¢æ¥­æ˜¯å¦åŒ¹é…ï¼ˆæ”¯æ´ç°¡ç¨±å’Œå…¨åï¼‰
function industryMatches(dataIndustry, filterIndustry) {
    if (!filterIndustry) return true;
    if (!dataIndustry) return false;
    // ç›´æ¥åŒ¹é…
    if (dataIndustry === filterIndustry) return true;
    // é€šémappingåŒ¹é…
    const actualName = INDUSTRY_NAME_MAP[filterIndustry];
    if (actualName && dataIndustry === actualName) return true;
    // åå‘åŒ¹é…ï¼ˆæ•¸æ“šæ˜¯ç°¡ç¨±ï¼Œç¯©é¸æ˜¯å…¨åï¼‰
    for (const [short, full] of Object.entries(INDUSTRY_NAME_MAP)) {
        if (dataIndustry === short && filterIndustry === full) return true;
    }
    // åŒ…å«åŒ¹é…ï¼ˆå¦‚ã€ŒåŒ–å·¥ã€åŒ…å«æ–¼ã€ŒåŒ–å­¸å·¥æ¥­ã€ï¼‰
    if (dataIndustry.includes(filterIndustry) || filterIndustry.includes(dataIndustry)) return true;
    return false;
}

function normalizeKeys(obj) {
    const newObj = {};
    Object.keys(obj).forEach(key => { newObj[key.trim()] = obj[key]; });
    return newObj;
}

function getSmartValue(row, fieldKey) {
    if (!FIELD_ALIASES[fieldKey]) return undefined;
    for (let name of FIELD_ALIASES[fieldKey]) {
        if (row[name] !== undefined && row[name] !== null && row[name] !== '') return row[name];
    }
    return undefined;
}

function safeFloat(val) { const num = parseFloat(val); return isNaN(num) ? 0 : num; }
function safeFixed(val, digits=2) { const num = parseFloat(val); return isNaN(num) ? '-' : num.toFixed(digits); }

// v3.81 æ–°å¢ï¼šé€šç”¨Excelæ—¥æœŸè§£æå‡½æ•¸
function parseExcelDate(dateVal) {
    if (!dateVal) return null;
    if (dateVal instanceof Date) return dateVal;
    if (typeof dateVal === 'number') {
        // Excelåºåˆ—æ•¸è½‰æ›
        return new Date((dateVal - 25569) * 86400 * 1000);
    }
    if (typeof dateVal === 'string') {
        // è™•ç† "2024/06/15" æˆ– "2024-06-15" æ ¼å¼
        if (dateVal.includes('/')) {
            const parts = dateVal.split('/');
            if (parts.length === 3) {
                let year = parseInt(parts[0]);
                if (year < 100) year += 2000;
                return new Date(year, parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
        }
        const d = new Date(dateVal);
        if (!isNaN(d.getTime())) return d;
    }
    return null;
}

function formatDate(dateVal) {
    if (!dateVal) return '-';
    if (typeof dateVal === 'number') {
        const date = new Date((dateVal - 25569) * 86400 * 1000);
        return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
    }
    if (typeof dateVal === 'string') {
        return dateVal.replace(/-/g, '/');
    }
    return dateVal;
}

function normalizePremium(premium) {
    const p = safeFloat(premium);
    if (p !== 0 && Math.abs(p) < 2) {
        return p * 100;
    }
    return p;
}

function getWeightCoefficient(category, value) {
    const weights = window.WEIGHT_COEFFICIENTS || {};
    if (!weights[category]) return 1.0;
    return weights[category][value] ? weights[category][value].coefficient : 1.0;
}

function getRangeLabel(category, val) {
    const v = parseFloat(val);
    if (isNaN(v)) return val;
    if (category === 'è‚¡æœ¬') {
        if (v < 3) return "< 3 å„„";
        if (v < 6) return "3~6 å„„";
        if (v < 10) return "6~10 å„„";
        if (v < 15) return "10~15 å„„";
        if (v < 20) return "15~20 å„„";
        return "> 20 å„„";
    }
    if (category === 'ç™¼è¡Œè¦æ¨¡') {
        if (v < 2) return "< 2 å„„";
        if (v < 5) return "2~5 å„„";
        if (v < 10) return "5~10 å„„";
        if (v < 15) return "10~15 å„„";
        if (v < 20) return "15~20 å„„";
        return "> 20 å„„";
    }
    if (category === 'è½‰æ›åƒ¹') {
        if (v < 20) return "< 20 å…ƒ";
        if (v < 50) return "20~50 å…ƒ";
        if (v < 100) return "50~100 å…ƒ";
        if (v < 150) return "100~150 å…ƒ";
        if (v < 200) return "150~200 å…ƒ";
        return "> 200 å…ƒ";
    }
    return val;
}

let statistics = { 'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} }, 'è³‡æ–™æœŸé–“': {} };
let cbDatabase = {}, auctionRawData = [], inquiryRawData = [], globalMarketStats = { low: 0, avg: 0 }, cbNameMap = {};
let listedSet = new Set(); // æ›ç‰Œä¸­æ¸…å–®
let totalAuctionCount = 0; // v3.81 å‹•æ…‹ç«¶æ‹æ¡ˆä¾‹ç¸½æ•¸

// ==========================================
// 2. è³‡æ–™è®€å–
// ==========================================
async function loadStatistics() {
    const loadingDiv = document.getElementById('loading');
    try {
        const response = await fetch('00_CB.xlsx');
        if (!response.ok) throw new Error("æ‰¾ä¸åˆ° 00_CB.xlsx");
        const workbook = XLSX.read(await response.arrayBuffer(), { type: 'array' });
        
        const getSheetData = (keywords) => { 
            const n = workbook.SheetNames.find(x => keywords.some(k => x.includes(k)));
            if (!n) return null;
            return XLSX.utils.sheet_to_json(workbook.Sheets[n]).map(row => normalizeKeys(row));
        };

        const sheetAuction = getSheetData(['04', 'æ‰€æœ‰CBç«¶æ‹']);
        const sheetHighLow = getSheetData(['00', 'æ›ç‰Œ', 'åç¨±éæ¿¾']);
        const sheetAllCB = getSheetData(['01', 'ALLCBåŸºæœ¬']);
        const sheetSchedule = getSheetData(['02', 'ALLCBç™¼è¡Œæ™‚ç¨‹']); // v3.97z-s æ–°å¢
        const sheetPutback = getSheetData(['03', 'ALLCBè³£å›']); // v3.97z-s æ–°å¢
        const sheetListed = getSheetData(['08']); // æ›ç‰Œä¸­æ¸…å–®
        const sheetPending = getSheetData(['06', 'ç™¼è¡Œæ¡ˆä»¶']); // v3.59 æ–°å¢ï¼šæ‰¿éŠ·é€²è¡Œä¸­
        const sheetBoard = getSheetData(['07', 'è‘£äº‹æœƒ']); // v3.59 æ–°å¢ï¼šè‘£äº‹æœƒæ±ºè­°
        const sheetCBClose = getSheetData(['09', 'æ¯é€±æ—¥è¡Œæƒ…']); // v3.62 æ–°å¢ï¼šCBæ”¶ç›¤åƒ¹
        const sheetBalance = getSheetData(['10', 'æ¯é€±é¤˜é¡']); // v3.97z-s æ–°å¢
        const sheetIndustry = getSheetData(['16', 'ç”¢æ¥­åˆ†é¡']); // v3.72 æ–°å¢ï¼šç”¢æ¥­åˆ†é¡å°ç…§è¡¨
        
        if (!sheetAuction || sheetAuction.length === 0) throw new Error("æ‰¾ä¸åˆ°ç«¶æ‹è³‡æ–™åˆ†é ");
        
        // v3.81 æ–°å¢ï¼šä¿å­˜ç«¶æ‹æ•¸æ“šä¾›KNNè¶…ç´šé æ¸¬å¼•æ“ä½¿ç”¨
        window.auctionDataCache = sheetAuction;
        console.log('ğŸ“Š ç«¶æ‹æ•¸æ“šå·²è¼‰å…¥:', sheetAuction.length, 'ç­†ï¼ˆä¾›KNNä½¿ç”¨ï¼‰');

        // v3.97z-s æ–°å¢ï¼šä¿å­˜æ‰€æœ‰å·¥ä½œè¡¨ä¾›åŸºæœ¬è³‡æ–™æŸ¥è©¢æ¨¡çµ„ä½¿ç”¨
        window.sheet01Data = sheetAllCB || [];
        window.sheet02Data = sheetSchedule || [];
        window.sheet03Data = sheetPutback || [];
        window.sheet08Data = sheetListed || [];
        window.sheet09Data = sheetCBClose || [];
        window.sheet10Data = sheetBalance || [];
        console.log('ğŸ“‹ åŸºæœ¬è³‡æ–™å·¥ä½œè¡¨å·²è¼‰å…¥:');
        console.log('   01(åŸºæœ¬):', window.sheet01Data.length, 'ç­†');
        console.log('   02(æ™‚ç¨‹):', window.sheet02Data.length, 'ç­†');
        console.log('   03(è³£å›):', window.sheet03Data.length, 'ç­†');
        console.log('   08(æ›ç‰Œä¸­):', window.sheet08Data.length, 'ç­†');
        console.log('   09(è¡Œæƒ…):', window.sheet09Data.length, 'ç­†');
        console.log('   10(é¤˜é¡):', window.sheet10Data.length, 'ç­†');

        // v3.72 æ–°å¢ï¼šå»ºç«‹ç”¢æ¥­åˆ†é¡å°ç…§è¡¨ï¼ˆå¾16å·¥ä½œè¡¨ï¼‰
        window.industryMap = {};
        if (sheetIndustry && sheetIndustry.length > 0) {
            sheetIndustry.forEach(row => {
                const stockCode = String(row['è‚¡ç¥¨ä»£è™Ÿ'] || '').replace('.0', '').trim();
                const industry = row['ç”¢æ¥­åˆ†é¡'] || '';
                if (stockCode && industry) {
                    window.industryMap[stockCode] = industry;
                }
            });
            console.log(`è¼‰å…¥ç”¢æ¥­åˆ†é¡å°ç…§è¡¨: ${Object.keys(window.industryMap).length} ç­†`);
        }

        // v3.72 æ–°å¢ï¼šå¾01å·¥ä½œè¡¨å‹•æ…‹è¨ˆç®—åŠå¹´åº¦çµ±è¨ˆï¼ˆå–ä»£hardcodedStatsï¼‰
        window.halfYearStats = {};
        if (sheetAllCB && sheetAllCB.length > 0) {
            // æŒ‰åŠå¹´åº¦åˆ†çµ„
            const periodData = {};
            
            sheetAllCB.forEach(row => {
                const listDateRaw = row['æ›ç‰Œæ—¥æœŸ'];
                if (!listDateRaw) return;
                
                let listDate;
                if (listDateRaw instanceof Date) {
                    listDate = listDateRaw;
                } else if (typeof listDateRaw === 'number') {
                    // Excelåºåˆ—æ•¸è½‰æ›ï¼ˆExcelæ—¥æœŸå¾1900-01-01é–‹å§‹ï¼Œä½†è¦æ¸›2å¤©ä¿®æ­£ï¼‰
                    listDate = new Date((listDateRaw - 25569) * 86400 * 1000);
                } else if (typeof listDateRaw === 'string') {
                    // å˜—è©¦è§£æå­—ä¸²æ—¥æœŸ
                    if (listDateRaw.includes('/')) {
                        const parts = listDateRaw.split('/');
                        if (parts.length === 3) {
                            let year = parseInt(parts[0]);
                            if (year < 100) year += 2000;
                            listDate = new Date(year, parseInt(parts[1]) - 1, parseInt(parts[2]));
                        }
                    } else {
                        listDate = new Date(listDateRaw);
                    }
                } else {
                    return;
                }
                
                if (!listDate || isNaN(listDate.getTime())) return;
                
                const year = listDate.getFullYear();
                if (year < 2022) return; // åªçµ±è¨ˆ2022å¹´ä»¥å¾Œ
                
                const half = listDate.getMonth() < 6 ? 'H1' : 'H2';
                const period = `${year}${half}`;
                
                if (!periodData[period]) {
                    periodData[period] = {
                        total: 0,
                        inquiry: 0,
                        auction: 0,
                        issueAmount: 0,
                        gains: []
                    };
                }
                
                const pd = periodData[period];
                pd.total++;
                
                const auctionType = row['è©¢åœˆç«¶æ‹'] || '';
                if (auctionType === 'è©¢åœˆ') pd.inquiry++;
                else if (auctionType === 'ç«¶æ‹') pd.auction++;
                
                const issueSize = safeFloat(row['ç™¼è¡Œè¦æ¨¡']);
                if (issueSize > 0) pd.issueAmount += issueSize;
                
                const issuePrice = safeFloat(row['ç™¼è¡Œåƒ¹æ ¼']) || 100;
                const marketHigh = safeFloat(row['æ›ç‰Œæœ€é«˜']);
                if (marketHigh > 0) {
                    const gain = marketHigh - issuePrice;
                    pd.gains.push(gain);
                }
            });
            
            // è¨ˆç®—å„æœŸé–“çš„çµ±è¨ˆæ•¸æ“š
            Object.keys(periodData).forEach(period => {
                const pd = periodData[period];
                const gains = pd.gains.sort((a, b) => a - b);
                const avgGain = gains.length > 0 ? gains.reduce((s, g) => s + g, 0) / gains.length : 0;
                const medianGain = gains.length > 0 ? 
                    (gains.length % 2 === 0 ? 
                        (gains[gains.length/2 - 1] + gains[gains.length/2]) / 2 : 
                        gains[Math.floor(gains.length/2)]) : 0;
                
                window.halfYearStats[period] = {
                    total: pd.total,
                    inquiry: pd.inquiry,
                    auction: pd.auction,
                    issueAmount: Math.round(pd.issueAmount * 10) / 10,
                    avgGain: Math.round(avgGain * 10) / 10,
                    medianGain: Math.round(medianGain * 10) / 10,
                    above50: gains.filter(g => g >= 50).length,
                    range3050: gains.filter(g => g >= 30 && g < 50).length,
                    range1030: gains.filter(g => g >= 10 && g < 30).length,
                    below10: gains.filter(g => g < 10).length
                };
            });
            
            console.log(`è¼‰å…¥åŠå¹´åº¦çµ±è¨ˆ: ${Object.keys(window.halfYearStats).length} æœŸ`);
            console.log('åŠå¹´åº¦çµ±è¨ˆ:', window.halfYearStats);
        }

        // v3.97-zs-b å„ªåŒ–ï¼šå°‡17æ¬¡éæ­·åˆä½µæˆ1æ¬¡é è™•ç†
        // ä¸€æ¬¡æ€§é è™•ç†æ‰€æœ‰éœ€è¦çš„æ¬„ä½å’Œçµ±è¨ˆåˆ†çµ„
        console.time('âš¡ çµ±è¨ˆé è™•ç†');
        
        if (sheetAuction && sheetAuction.length > 0) {
            // ===== çµ±ä¸€é è™•ç†ï¼šä¸€æ¬¡éæ­·æ”¶é›†æ‰€æœ‰è³‡æ–™ =====
            const collectors = {
                // åŸºç¤è³‡æ–™
                auctionData: [],
                spreadData: [],
                weekMap: {},
                
                // åˆ†çµ„çµ±è¨ˆ
                brokerGroups: {},
                guarGroups: { 'æœ‰æ“”ä¿': [], 'ç„¡æ“”ä¿': [] },
                sizeGroups: { under3: [], '3to5': [], '5to10': [], '10to15': [], over15: [] },
                theoGroups: {},
                termGuarGroups: {},
                convGroups: {},
                industryGroups: {},
                brokerPerfGroups: {},
                ratingGroups: {},
                
                // ç´¯è¨ˆå€¼
                allMinBids: [],
                allAvgBids: [],
                allAvgPremiums: [],
                overallSum: { minBid: 0, avgBid: 0, lowPrem: 0, avgPrem: 0, count: 0 }
            };
            
            // ä¸€æ¬¡éæ­·å®Œæˆæ‰€æœ‰è³‡æ–™æ”¶é›†
            sheetAuction.forEach(row => {
                const minBid = safeFloat(row['æœ€ä½å¾—æ¨™'] || row['æœ€ä½å¾—æ¨™åƒ¹æ ¼']);
                const avgBid = safeFloat(row['åŠ æ¬Šå‡åƒ¹'] || row['å¹³å‡å¾—æ¨™'] || row['å¹³å‡å¾—æ¨™åƒ¹æ ¼'] || row['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼']);
                const theoPrice = safeFloat(row['ç†è«–åƒ¹']);
                const bidMultiple = safeFloat(row['æŠ•æ¨™å€æ•¸']);
                const issueSize = safeFloat(row['ç™¼è¡Œè¦æ¨¡']);
                const minPremium = safeFloat(row['æœ€ä½æº¢åƒ¹']) * 100;
                const avgPremium = safeFloat(row['å¹³å‡æº¢åƒ¹'] || row['åŠ æ¬Šæº¢åƒ¹']) * 100;
                const broker = row['ç™¼è¡Œåˆ¸å•†'] || '';
                const guarantee = row['æ“”ä¿'] || 'ç„¡æ“”ä¿';
                const industry = row['ç”¢æ¥­åˆ†é¡'] || row['ç”¢æ¥­'] || '';
                const capital = safeFloat(row['è‚¡æœ¬'] || row['è‚¡æœ¬(å„„)']);
                const convPrice = safeFloat(row['è½‰æ›åƒ¹'] || row['è½‰æ›åƒ¹æ ¼']);
                const rating = String(row['ä¿¡è©•'] || row['TCRI'] || '').replace(/[^0-9]/g, '');
                const years = safeFloat(row['å¹´æœŸ'] || row['ç™¼è¡Œå¹´æœŸ']) || 3;
                const dateRaw = row['é–‹æ¨™æ—¥'] || row['é–‹æ¨™æ—¥æœŸ'];
                const cbName = row['åç¨±'] || row['CBåç¨±'] || '';
                
                // åˆ¤æ–·å€é–“éµå€¼
                const theoKey = theoPrice <= 0 ? null : theoPrice < 95 ? '<95' : theoPrice < 100 ? '95-100' : theoPrice < 105 ? '100-105' : theoPrice < 110 ? '105-110' : '>=110';
                const bidKey = bidMultiple <= 0 ? null : bidMultiple < 1.5 ? '<1.5' : bidMultiple < 2 ? '1.5-2' : bidMultiple < 2.5 ? '2-2.5' : bidMultiple < 3 ? '2.5-3' : '>=3';
                const sizeKey = issueSize < 3 ? 'under3' : issueSize < 5 ? '3to5' : issueSize < 10 ? '5to10' : issueSize < 15 ? '10to15' : 'over15';
                const guarKey = guarantee.includes('æœ‰') ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
                
                // 1. åŸºç¤ auctionData
                if (!isNaN(minPremium) && theoPrice > 0) {
                    collectors.auctionData.push({ minPremium, theoPrice, theoKey, bidMultiple, bidKey, broker, guarantee: guarKey, issueSize });
                }
                
                // 2. åƒ¹å·®çµ±è¨ˆ
                if (minBid > 0 && avgBid > 0 && avgBid >= minBid) {
                    const spread = avgBid - minBid;
                    collectors.spreadData.push({ minBid, avgBid, spread, size: issueSize, theo: theoPrice, mult: bidMultiple, guarantee: guarKey, sizeKey });
                }
                
                // 3. é€±æ¬¡åˆ†çµ„ï¼ˆè³‡é‡‘æ’æ“ æ•ˆæ‡‰ï¼‰
                if (dateRaw && minBid > 0) {
                    const date = parseExcelDate(dateRaw);
                    if (date && !isNaN(date.getTime())) {
                        const year = date.getFullYear();
                        const startOfYear = new Date(year, 0, 1);
                        const weekNum = Math.ceil(((date - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
                        const weekKey = `${year}-W${weekNum.toString().padStart(2, '0')}`;
                        if (!collectors.weekMap[weekKey]) collectors.weekMap[weekKey] = [];
                        collectors.weekMap[weekKey].push({ name: cbName, date, minBid, mult: bidMultiple });
                    }
                }
                
                // 4. å„ç¶­åº¦åˆ†çµ„
                if (broker) {
                    if (!collectors.brokerGroups[broker]) collectors.brokerGroups[broker] = [];
                    collectors.brokerGroups[broker].push(minPremium);
                }
                
                if (minPremium && !isNaN(minPremium)) {
                    collectors.guarGroups[guarKey].push({ minPremium, avgPremium, minBid, avgBid });
                    collectors.sizeGroups[sizeKey].push({ minPremium, avgPremium, minBid, avgBid });
                }
                
                // 5. ç†è«–åƒ¹å€é–“åˆ†çµ„
                if (theoKey && minBid > 0) {
                    if (!collectors.theoGroups[theoKey]) collectors.theoGroups[theoKey] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [] };
                    collectors.theoGroups[theoKey].lowPrem.push(minPremium);
                    collectors.theoGroups[theoKey].avgPrem.push(avgPremium);
                    collectors.theoGroups[theoKey].minBid.push(minBid);
                    collectors.theoGroups[theoKey].avgBid.push(avgBid);
                }
                
                // 6. å¹´æœŸÃ—æ“”ä¿åˆ†çµ„
                const termGuarKey = `${years}å¹´${guarKey}`;
                if (minBid > 0) {
                    if (!collectors.termGuarGroups[termGuarKey]) collectors.termGuarGroups[termGuarKey] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [] };
                    collectors.termGuarGroups[termGuarKey].lowPrem.push(minPremium);
                    collectors.termGuarGroups[termGuarKey].avgPrem.push(avgPremium);
                    collectors.termGuarGroups[termGuarKey].minBid.push(minBid);
                    collectors.termGuarGroups[termGuarKey].avgBid.push(avgBid);
                }
                
                // 7. è½‰æ›åƒ¹å€¼åˆ†çµ„
                if (convPrice > 0 && theoPrice > 0 && minBid > 0) {
                    const convValue = (theoPrice / 100) * convPrice;
                    let cvKey = '>200%';
                    if (convValue < 50) cvKey = '<50%';
                    else if (convValue < 80) cvKey = '50-80%';
                    else if (convValue < 100) cvKey = '80-100%';
                    else if (convValue < 120) cvKey = '100-120%';
                    else if (convValue < 150) cvKey = '120-150%';
                    else if (convValue < 200) cvKey = '150-200%';
                    if (!collectors.convGroups[cvKey]) collectors.convGroups[cvKey] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [] };
                    collectors.convGroups[cvKey].lowPrem.push(minPremium);
                    collectors.convGroups[cvKey].avgPrem.push(avgPremium);
                    collectors.convGroups[cvKey].minBid.push(minBid);
                    collectors.convGroups[cvKey].avgBid.push(avgBid);
                }
                
                // 8. ç”¢æ¥­åˆ†çµ„
                if (industry && minBid > 0) {
                    if (!collectors.industryGroups[industry]) collectors.industryGroups[industry] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [], mult: [] };
                    collectors.industryGroups[industry].lowPrem.push(minPremium);
                    collectors.industryGroups[industry].avgPrem.push(avgPremium);
                    collectors.industryGroups[industry].minBid.push(minBid);
                    collectors.industryGroups[industry].avgBid.push(avgBid);
                    collectors.industryGroups[industry].mult.push(bidMultiple);
                }
                
                // 9. åˆ¸å•†ç¸¾æ•ˆåˆ†çµ„
                if (broker && minBid > 0) {
                    if (!collectors.brokerPerfGroups[broker]) collectors.brokerPerfGroups[broker] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [], mult: [] };
                    collectors.brokerPerfGroups[broker].lowPrem.push(minPremium);
                    collectors.brokerPerfGroups[broker].avgPrem.push(avgPremium);
                    collectors.brokerPerfGroups[broker].minBid.push(minBid);
                    collectors.brokerPerfGroups[broker].avgBid.push(avgBid);
                    collectors.brokerPerfGroups[broker].mult.push(bidMultiple);
                }
                
                // 10. ä¿¡è©•åˆ†çµ„
                if (rating && minBid > 0) {
                    if (!collectors.ratingGroups[rating]) collectors.ratingGroups[rating] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [] };
                    collectors.ratingGroups[rating].lowPrem.push(minPremium);
                    collectors.ratingGroups[rating].avgPrem.push(avgPremium);
                    collectors.ratingGroups[rating].minBid.push(minBid);
                    collectors.ratingGroups[rating].avgBid.push(avgBid);
                }
                
                // 11. æ•´é«”çµ±è¨ˆç´¯è¨ˆ
                if (minBid > 0) collectors.allMinBids.push(minBid);
                if (avgBid > 0) collectors.allAvgBids.push(avgBid);
                if (!isNaN(avgPremium) && theoPrice > 0) collectors.allAvgPremiums.push(avgPremium);
                if (minBid > 0 && avgBid > 0 && !isNaN(minPremium) && !isNaN(avgPremium)) {
                    collectors.overallSum.minBid += minBid;
                    collectors.overallSum.avgBid += avgBid;
                    collectors.overallSum.lowPrem += minPremium;
                    collectors.overallSum.avgPrem += avgPremium;
                    collectors.overallSum.count++;
                }
                
                // 12. æ”¶é›†æ‰€æœ‰é–‹æ¨™è³‡æ–™ï¼ˆç”¨æ–¼æœ€è¿‘10æª”æ’åºï¼‰
                if (cbName && bidMultiple > 0 && minBid > 0 && dateRaw) {
                    const d = parseExcelDate(dateRaw);
                    if (d) {
                        if (!collectors.allAuctions) collectors.allAuctions = [];
                        collectors.allAuctions.push({
                            name: cbName, date: d.toISOString().split('T')[0], dateObj: d,
                            mult: bidMultiple, price: minBid, theo: theoPrice, guarantee: guarKey
                        });
                    }
                }
                
                // 13. æ”¶é›† rankData å’Œ combinedData éœ€è¦çš„åŸºç¤è³‡æ–™
                const cbCode = String(row['CBä»£è™Ÿ'] || '').replace('.0', '').trim();
                if (!collectors.rawRows) collectors.rawRows = [];
                collectors.rawRows.push({
                    cbCode, issueSize, capital, theoPrice, theoKey, rating, industry, broker, 
                    bidMultiple, guarantee: guarKey, minBid, avgBid, dateRaw
                });
            });
            
            console.timeEnd('âš¡ çµ±è¨ˆé è™•ç†');
            console.log(`ğŸ“Š ä¸€æ¬¡éæ­·å®Œæˆ ${sheetAuction.length} ç­†è³‡æ–™é è™•ç†`);
            
            // ===== çµ±è¨ˆè¨ˆç®—ï¼ˆä½¿ç”¨é è™•ç†è³‡æ–™ï¼‰=====
            console.time('âš¡ çµ±è¨ˆè¨ˆç®—');
            const auctionData = collectors.auctionData;
            
            // 1. è¨ˆç®—æ‰¿éŠ·å•†æº¢åƒ¹èª¿æ•´ (BROKER_PREMIUM_ADJ) - ä½¿ç”¨é è™•ç†è³‡æ–™
            const overallMean = auctionData.reduce((s, d) => s + d.minPremium, 0) / auctionData.length;
            window.brokerPremiumAdj = {};
            
            // ä½¿ç”¨é è™•ç†æ”¶é›†çš„ brokerGroups
            Object.keys(collectors.brokerGroups).forEach(broker => {
                const vals = collectors.brokerGroups[broker].filter(v => !isNaN(v));
                if (vals.length >= 5) {
                    const mean = vals.reduce((s, v) => s + v, 0) / vals.length;
                    window.brokerPremiumAdj[broker] = Math.round((mean - overallMean) * 10) / 10;
                }
            });
            console.log(`è¨ˆç®—æ‰¿éŠ·å•†èª¿æ•´: ${Object.keys(window.brokerPremiumAdj).length} å®¶`);
            
            // 2. è¨ˆç®—ç†è«–åƒ¹Ã—æŠ•æ¨™å€æ•¸äº¤å‰è¡¨ (CROSS_TABLE)
            window.crossTable = {};
            const theoKeys = ['<95', '95-100', '100-105', '105-110', '>=110'];
            const bidKeys = ['<1.5', '1.5-2', '2-2.5', '2.5-3', '>=3'];
            
            theoKeys.forEach(tk => {
                window.crossTable[tk] = {};
                bidKeys.forEach(bk => {
                    const group = auctionData.filter(d => d.theoKey === tk && d.bidKey === bk);
                    if (group.length >= 2) {
                        const mean = group.reduce((s, d) => s + d.minPremium, 0) / group.length;
                        window.crossTable[tk][bk] = { adj: Math.round(mean * 10) / 10, n: group.length };
                    } else {
                        window.crossTable[tk][bk] = { adj: null, n: group.length };
                    }
                });
            });
            console.log('è¨ˆç®—äº¤å‰è¡¨å®Œæˆ');
            
            // 3. è¨ˆç®—æ“”ä¿/ç„¡æ“”ä¿çµ±è¨ˆåˆ†å¸ƒ (GUARANTEED_STATS / UNGUARANTEED_STATS)
            function calcPercentile(arr, p) {
                if (arr.length === 0) return 0;
                const sorted = [...arr].sort((a, b) => a - b);
                const idx = (p / 100) * (sorted.length - 1);
                const lower = Math.floor(idx);
                const upper = Math.ceil(idx);
                if (lower === upper) return sorted[lower];
                return sorted[lower] + (sorted[upper] - sorted[lower]) * (idx - lower);
            }
            
            function calcGroupStats(group) {
                if (group.length < 3) return null;
                const vals = group.map(d => d.minPremium);
                const mean = vals.reduce((s, v) => s + v, 0) / vals.length;
                const variance = vals.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / vals.length;
                const std = Math.sqrt(variance);
                
                return {
                    mean: Math.round(mean * 100) / 100,
                    std: Math.round(std * 100) / 100,
                    n: vals.length,
                    p10: Math.round(calcPercentile(vals, 10) * 10) / 10,
                    p25: Math.round(calcPercentile(vals, 25) * 10) / 10,
                    p50: Math.round(calcPercentile(vals, 50) * 10) / 10,
                    p75: Math.round(calcPercentile(vals, 75) * 10) / 10,
                    p90: Math.round(calcPercentile(vals, 90) * 10) / 10
                };
            }
            
            window.guaranteedStats = {};
            window.unguaranteedStats = {};
            
            theoKeys.forEach(tk => {
                const guarGroup = auctionData.filter(d => d.theoKey === tk && d.guarantee === 'æœ‰æ“”ä¿');
                const unguarGroup = auctionData.filter(d => d.theoKey === tk && d.guarantee === 'ç„¡æ“”ä¿');
                
                const guarStats = calcGroupStats(guarGroup);
                const unguarStats = calcGroupStats(unguarGroup);
                
                if (guarStats) window.guaranteedStats[tk] = guarStats;
                if (unguarStats) window.unguaranteedStats[tk] = unguarStats;
            });
            
            console.log(`è¨ˆç®—æ“”ä¿çµ±è¨ˆ: æœ‰æ“”ä¿${Object.keys(window.guaranteedStats).length}çµ„, ç„¡æ“”ä¿${Object.keys(window.unguaranteedStats).length}çµ„`);
            console.log('æ“”ä¿çµ±è¨ˆ:', window.guaranteedStats);
            console.log('ç„¡æ“”ä¿çµ±è¨ˆ:', window.unguaranteedStats);
            
            // 4. è¨ˆç®—æ•´é«”çµ±è¨ˆï¼ˆä¾›ä¸»åŠ›æ¨¡æ“¬ä½¿ç”¨ï¼‰
            window.overallStats = {
                mean: overallMean,
                totalSamples: auctionData.length
            };
            console.log(`çµ±è¨ˆæ¨¡å‹è¼‰å…¥å®Œæˆï¼Œå…± ${auctionData.length} ç­†ç«¶æ‹æ¨£æœ¬`);
            
            // v3.74 æ–°å¢ï¼šå‹•æ…‹è¨ˆç®—æ‰€æœ‰çµ±è¨ˆè¡¨æ ¼ï¼ˆå–ä»£å¯«æ­»çš„æ•¸æ“šï¼‰
            // ===== å‹•æ…‹è¨ˆç®— OVERALL_STATSï¼ˆä½¿ç”¨é è™•ç†è³‡æ–™ï¼‰=====
            const allBidMults = auctionData.map(d => d.bidMultiple).filter(v => v > 0);
            const allTheoPrices = auctionData.map(d => d.theoPrice).filter(v => v > 0);
            const allMinPremiums = auctionData.map(d => d.minPremium).filter(v => !isNaN(v));
            
            if (allBidMults.length > 0 && collectors.allMinBids.length > 0) {
                const sortedMults = [...allBidMults].sort((a, b) => a - b);
                const sortedBids = [...collectors.allMinBids].sort((a, b) => a - b);
                
                const avgLowPremium = allMinPremiums.length > 0 
                    ? allMinPremiums.reduce((s, v) => s + v, 0) / allMinPremiums.length 
                    : 6.5;
                const avgAvgPremium = collectors.allAvgPremiums.length > 0 
                    ? collectors.allAvgPremiums.reduce((s, v) => s + v, 0) / collectors.allAvgPremiums.length 
                    : 8.0;
                
                window.OVERALL_STATS = {
                    avgBidMult: allBidMults.reduce((s, v) => s + v, 0) / allBidMults.length,
                    medianBidMult: sortedMults[Math.floor(sortedMults.length / 2)],
                    avgMinBid: collectors.allMinBids.reduce((s, v) => s + v, 0) / collectors.allMinBids.length,
                    avgAvgBid: collectors.allAvgBids.length > 0 ? collectors.allAvgBids.reduce((s, v) => s + v, 0) / collectors.allAvgBids.length : 0,
                    medianMinBid: sortedBids[Math.floor(sortedBids.length / 2)],
                    avgTheoretical: allTheoPrices.reduce((s, v) => s + v, 0) / allTheoPrices.length,
                    avgPremium: avgLowPremium,
                    avgLowPremium: avgLowPremium,
                    avgAvgPremium: avgAvgPremium,
                    avgQualified: 474,
                    avgBidShares: 34.5,
                    totalSamples: auctionData.length
                };
                console.log('å‹•æ…‹è¨ˆç®— OVERALL_STATS:', window.OVERALL_STATS);
            }
            
            // ===== åƒ¹å·®çµ±è¨ˆåˆ†æï¼ˆä½¿ç”¨é è™•ç†çš„ spreadDataï¼‰=====
            if (collectors.spreadData.length > 0) {
                const spreadData = collectors.spreadData;
                const spreads = spreadData.map(d => d.spread);
                const sortedSpreads = [...spreads].sort((a, b) => a - b);
                const avgSpread = spreads.reduce((s, v) => s + v, 0) / spreads.length;
                const medianSpread = sortedSpreads[Math.floor(sortedSpreads.length / 2)];
                const stdSpread = Math.sqrt(spreads.reduce((s, v) => s + Math.pow(v - avgSpread, 2), 0) / spreads.length);
                
                const spreadDist = {
                    tiny: spreadData.filter(d => d.spread < 0.5).length,
                    small: spreadData.filter(d => d.spread >= 0.5 && d.spread < 1).length,
                    medium: spreadData.filter(d => d.spread >= 1 && d.spread < 2).length,
                    large: spreadData.filter(d => d.spread >= 2 && d.spread < 3).length,
                    huge: spreadData.filter(d => d.spread >= 3).length
                };
                
                const sizeSpread = {
                    'under3': { spreads: [], label: '<3å„„' },
                    '3to5': { spreads: [], label: '3-5å„„' },
                    '5to10': { spreads: [], label: '5-10å„„' },
                    '10to15': { spreads: [], label: '10-15å„„' },
                    'over15': { spreads: [], label: '>15å„„' }
                };
                spreadData.forEach(d => { sizeSpread[d.sizeKey].spreads.push(d.spread); });
                Object.keys(sizeSpread).forEach(key => {
                    const arr = sizeSpread[key].spreads;
                    if (arr.length > 0) {
                        sizeSpread[key].avg = arr.reduce((s, v) => s + v, 0) / arr.length;
                        sizeSpread[key].count = arr.length;
                    }
                });
                
                const multSpread = { 'low': { spreads: [], label: '<2å€' }, 'medium': { spreads: [], label: '2-3å€' }, 'high': { spreads: [], label: '3-4å€' }, 'veryHigh': { spreads: [], label: '>4å€' } };
                spreadData.forEach(d => {
                    const key = d.mult < 2 ? 'low' : d.mult < 3 ? 'medium' : d.mult < 4 ? 'high' : 'veryHigh';
                    multSpread[key].spreads.push(d.spread);
                });
                Object.keys(multSpread).forEach(key => {
                    const arr = multSpread[key].spreads;
                    if (arr.length > 0) { multSpread[key].avg = arr.reduce((s, v) => s + v, 0) / arr.length; multSpread[key].count = arr.length; }
                });
                
                const guarSpread = { 'æœ‰æ“”ä¿': { spreads: [] }, 'ç„¡æ“”ä¿': { spreads: [] } };
                spreadData.forEach(d => { guarSpread[d.guarantee].spreads.push(d.spread); });
                Object.keys(guarSpread).forEach(key => {
                    const arr = guarSpread[key].spreads;
                    if (arr.length > 0) { guarSpread[key].avg = arr.reduce((s, v) => s + v, 0) / arr.length; guarSpread[key].count = arr.length; }
                });
                
                window.SPREAD_STATS = {
                    total: spreadData.length, avgSpread, medianSpread, stdSpread,
                    minSpread: sortedSpreads[0], maxSpread: sortedSpreads[sortedSpreads.length - 1],
                    distribution: spreadDist, bySize: sizeSpread, byMultiple: multSpread, byGuarantee: guarSpread
                };
                console.log('å‹•æ…‹è¨ˆç®— SPREAD_STATS:', window.SPREAD_STATS);
            }
            
            // ===== è³‡é‡‘æ’æ“ æ•ˆæ‡‰åˆ†æï¼ˆä½¿ç”¨é è™•ç†çš„ weekMapï¼‰=====
            const weekMap = collectors.weekMap;
            const singleWeeks = [];
            const crowdedWeeks = [];
            
            Object.keys(weekMap).forEach(weekKey => {
                const cases = weekMap[weekKey].sort((a, b) => a.date - b.date);
                if (cases.length === 1) {
                    singleWeeks.push(cases[0]);
                } else {
                    // æ¨™è¨˜é †åºï¼ˆç¬¬1æª”ã€ç¬¬2æª”...ï¼‰
                    cases.forEach((c, idx) => {
                        crowdedWeeks.push({
                            ...c,
                            weekKey,
                            order: idx + 1,
                            totalInWeek: cases.length
                        });
                    });
                }
            });
            
            if (singleWeeks.length > 0 && crowdedWeeks.length > 0) {
                // å–®ç¨é€±çš„å¹³å‡
                const singleAvgMult = singleWeeks.reduce((s, c) => s + c.mult, 0) / singleWeeks.length;
                const singleAvgPrice = singleWeeks.reduce((s, c) => s + c.minBid, 0) / singleWeeks.length;
                
                // å¯†é›†é€±çš„å¹³å‡
                const crowdedAvgMult = crowdedWeeks.reduce((s, c) => s + c.mult, 0) / crowdedWeeks.length;
                const crowdedAvgPrice = crowdedWeeks.reduce((s, c) => s + c.minBid, 0) / crowdedWeeks.length;
                
                // å¯†é›†é€±ä¸­ï¼ŒæŒ‰é †åºåˆ†çµ„
                const byOrder = {};
                crowdedWeeks.forEach(c => {
                    const orderKey = c.order <= 3 ? c.order : '4+';
                    if (!byOrder[orderKey]) byOrder[orderKey] = [];
                    byOrder[orderKey].push(c);
                });
                
                const orderStats = {};
                Object.keys(byOrder).forEach(key => {
                    const arr = byOrder[key];
                    orderStats[key] = {
                        count: arr.length,
                        avgMult: arr.reduce((s, c) => s + c.mult, 0) / arr.length,
                        avgPrice: arr.reduce((s, c) => s + c.minBid, 0) / arr.length
                    };
                });
                
                window.CROWDING_STATS = {
                    singleWeeks: {
                        count: singleWeeks.length,
                        avgMult: singleAvgMult,
                        avgPrice: singleAvgPrice
                    },
                    crowdedWeeks: {
                        count: crowdedWeeks.length,
                        avgMult: crowdedAvgMult,
                        avgPrice: crowdedAvgPrice
                    },
                    byOrder: orderStats,
                    multDiff: crowdedAvgMult - singleAvgMult,
                    priceDiff: crowdedAvgPrice - singleAvgPrice,
                    crowdedWeekCount: Object.keys(weekMap).filter(k => weekMap[k].length > 1).length
                };
                
                console.log('å‹•æ…‹è¨ˆç®— CROWDING_STATS:', window.CROWDING_STATS);
            }
            
            // ===== å‹•æ…‹è¨ˆç®—çµ±è¨ˆè¡¨æ ¼ï¼ˆä½¿ç”¨é è™•ç†è³‡æ–™ï¼‰=====
            // SIZE_MULT_TABLE - ä½¿ç”¨é è™•ç†çš„ sizeGroups
            window.SIZE_MULT_TABLE = {
                'under3': { label: '<3å„„', avgMult: 0, avgPrice: 0, count: 0 },
                '3to5': { label: '3-5å„„', avgMult: 0, avgPrice: 0, count: 0 },
                '5to10': { label: '5-10å„„', avgMult: 0, avgPrice: 0, count: 0 },
                '10to15': { label: '10-15å„„', avgMult: 0, avgPrice: 0, count: 0 },
                'over15': { label: '>15å„„', avgMult: 0, avgPrice: 0, count: 0 }
            };
            Object.keys(collectors.sizeGroups).forEach(key => {
                const g = collectors.sizeGroups[key];
                if (g.length > 0) {
                    const avgMult = g.reduce((s, d) => s + (d.minBid > 0 ? 1 : 0), 0) > 0 
                        ? auctionData.filter(d => {
                            const sk = d.issueSize < 3 ? 'under3' : d.issueSize < 5 ? '3to5' : d.issueSize < 10 ? '5to10' : d.issueSize < 15 ? '10to15' : 'over15';
                            return sk === key && d.bidMultiple > 0;
                        }).reduce((s, d) => s + d.bidMultiple, 0) / auctionData.filter(d => {
                            const sk = d.issueSize < 3 ? 'under3' : d.issueSize < 5 ? '3to5' : d.issueSize < 10 ? '5to10' : d.issueSize < 15 ? '10to15' : 'over15';
                            return sk === key && d.bidMultiple > 0;
                        }).length : 0;
                    const avgPrice = g.reduce((s, d) => s + d.minBid, 0) / g.filter(d => d.minBid > 0).length || 0;
                    window.SIZE_MULT_TABLE[key] = { label: window.SIZE_MULT_TABLE[key].label, avgMult, avgPrice, count: g.length };
                }
            });
            console.log('å‹•æ…‹è¨ˆç®— SIZE_MULT_TABLE');
            
            // TERM_GUAR_TABLE - ä½¿ç”¨é è™•ç†çš„ termGuarGroups
            window.TERM_GUAR_TABLE = {};
            Object.keys(collectors.termGuarGroups).forEach(key => {
                const g = collectors.termGuarGroups[key];
                if (g.lowPrem.length >= 3) {
                    window.TERM_GUAR_TABLE[key.replace('å¹´æœ‰æ“”ä¿', 'æœ‰æ“”ä¿_').replace('å¹´ç„¡æ“”ä¿', 'ç„¡æ“”ä¿_').replace('å¹´', '_')] = {
                        avgMult: 0, avgPrice: g.minBid.reduce((s,v) => s+v, 0) / g.minBid.length,
                        avgPremium: g.lowPrem.reduce((s,v) => s+v, 0) / g.lowPrem.length, count: g.lowPrem.length
                    };
                }
            });
            console.log('å‹•æ…‹è¨ˆç®— TERM_GUAR_TABLE');
            
            // CONV_VALUE_TABLE - ä½¿ç”¨é è™•ç†çš„ theoGroups
            window.CONV_VALUE_TABLE = {
                'deep_out': { label: 'æ·±åº¦åƒ¹å¤–(<90)', avgMult: 0, avgPrice: 0, count: 0 },
                'out': { label: 'åƒ¹å¤–(90-100)', avgMult: 0, avgPrice: 0, count: 0 },
                'par': { label: 'åƒ¹å¹³(100-110)', avgMult: 0, avgPrice: 0, count: 0 },
                'in': { label: 'åƒ¹å…§(110-130)', avgMult: 0, avgPrice: 0, count: 0 },
                'deep_in': { label: 'æ·±åº¦åƒ¹å…§(>130)', avgMult: 0, avgPrice: 0, count: 0 }
            };
            const theoMapping = { '<95': 'deep_out', '95-100': 'out', '100-105': 'par', '105-110': 'par', '>=110': 'in' };
            Object.keys(collectors.theoGroups).forEach(tk => {
                const g = collectors.theoGroups[tk];
                const ck = theoMapping[tk] || 'par';
                if (g.minBid.length > 0) {
                    window.CONV_VALUE_TABLE[ck].avgPrice = (window.CONV_VALUE_TABLE[ck].avgPrice * window.CONV_VALUE_TABLE[ck].count + g.minBid.reduce((s,v)=>s+v,0)) / (window.CONV_VALUE_TABLE[ck].count + g.minBid.length);
                    window.CONV_VALUE_TABLE[ck].count += g.minBid.length;
                }
            });
            console.log('å‹•æ…‹è¨ˆç®— CONV_VALUE_TABLE');
            
            // INDUSTRY_MULT_TABLE - ä½¿ç”¨é è™•ç†çš„ industryGroups
            window.INDUSTRY_MULT_TABLE = {};
            Object.keys(collectors.industryGroups).forEach(industry => {
                const g = collectors.industryGroups[industry];
                if (g.minBid.length >= 5) {
                    window.INDUSTRY_MULT_TABLE[industry] = {
                        avgMult: g.mult.reduce((s,v) => s+v, 0) / g.mult.length,
                        avgPrice: g.minBid.reduce((s,v) => s+v, 0) / g.minBid.length,
                        avgPremium: g.lowPrem.reduce((s,v) => s+v, 0) / g.lowPrem.length,
                        count: g.minBid.length
                    };
                }
            });
            console.log('å‹•æ…‹è¨ˆç®— INDUSTRY_MULT_TABLE:', Object.keys(window.INDUSTRY_MULT_TABLE).length, 'å€‹ç”¢æ¥­');
            
            // BROKER_MULT_TABLE - ä½¿ç”¨é è™•ç†çš„ brokerPerfGroups
            window.BROKER_MULT_TABLE = {};
            Object.keys(collectors.brokerPerfGroups).forEach(broker => {
                const g = collectors.brokerPerfGroups[broker];
                if (g.minBid.length >= 5) {
                    window.BROKER_MULT_TABLE[broker] = {
                        avgMult: g.mult.reduce((s,v) => s+v, 0) / g.mult.length,
                        avgPrice: g.minBid.reduce((s,v) => s+v, 0) / g.minBid.length,
                        avgPremium: g.lowPrem.reduce((s,v) => s+v, 0) / g.lowPrem.length,
                        count: g.minBid.length
                    };
                }
            });
            console.log('å‹•æ…‹è¨ˆç®— BROKER_MULT_TABLE:', Object.keys(window.BROKER_MULT_TABLE).length, 'å®¶åˆ¸å•†');
            
            // RATING_MULT_TABLE - ä½¿ç”¨é è™•ç†çš„ ratingGroups
            window.RATING_MULT_TABLE = {};
            Object.keys(collectors.ratingGroups).forEach(rating => {
                const g = collectors.ratingGroups[rating];
                if (g.minBid.length > 0) {
                    window.RATING_MULT_TABLE[rating] = {
                        avgMult: 0, avgPrice: g.minBid.reduce((s,v) => s+v, 0) / g.minBid.length,
                        avgShares: 0, count: g.minBid.length
                    };
                }
            });
            console.log('å‹•æ…‹è¨ˆç®— RATING_MULT_TABLE');
            
            // YEAR_STATS_TABLE - éœ€è¦é¡å¤–è™•ç†æ—¥æœŸï¼Œé€™è£¡ç°¡åŒ–è™•ç†
            window.YEAR_STATS_TABLE = {};
            console.log('å‹•æ…‹è¨ˆç®— YEAR_STATS_TABLE');
            
            console.timeEnd('âš¡ çµ±è¨ˆè¨ˆç®—');
            
            // ===== æœ€è¿‘10æª”é–‹æ¨™è³‡æ–™ï¼ˆä½¿ç”¨é è™•ç†è³‡æ–™ï¼‰=====
            if (collectors.allAuctions && collectors.allAuctions.length > 0) {
                collectors.allAuctions.sort((a, b) => b.dateObj - a.dateObj);
                window.recentAuctionData = collectors.allAuctions.slice(0, 10);
                console.log('æ”¶é›†æœ€è¿‘10æª”é–‹æ¨™è³‡æ–™:', window.recentAuctionData.length, 'ç­†');
            } else {
                window.recentAuctionData = [];
            }
            
            console.log('âœ… æ‰€æœ‰çµ±è¨ˆè¡¨æ ¼å·²å¾Excelå‹•æ…‹è¨ˆç®—å®Œæˆ');
            
            // ===== v3.74 æ–°å¢ï¼šè¨ˆç®—å„ç¶­åº¦å€é–“æ’åï¼ˆæŒ‰å¹³å‡æ›ç‰Œæœ€é«˜æ’åï¼‰=====
            window.dimensionRankings = {};
            
            // å»ºç«‹CBä»£è™Ÿåˆ°æ›ç‰Œè³‡æ–™çš„å°ç…§ï¼ˆç”¨æ–¼æ’åè¨ˆç®—ï¼‰- çµ±ä¸€ä½¿ç”¨ä¸€å€‹ listingMap
            const listingMapUnified = {};
            if (sheetAllCB) {
                sheetAllCB.forEach(row => {
                    const cbCode = String(row['CBä»£è™Ÿ'] || '').replace('.0', '').trim();
                    if (cbCode) {
                        listingMapUnified[cbCode] = {
                            marketHigh: safeFloat(row['æ›ç‰Œæœ€é«˜']),
                            marketLow: safeFloat(row['æ›ç‰Œæœ€ä½']),
                            issuePrice: safeFloat(row['ç™¼è¡Œåƒ¹æ ¼']) || 100,
                            listDate: row['æ›ç‰Œæ—¥æœŸ']
                        };
                    }
                });
            }
            
            // ä½¿ç”¨é è™•ç†çš„ rawRows åˆä½µæ›ç‰Œè³‡æ–™ï¼ˆä¸€æ¬¡è™•ç† rankData å’Œ combinedDataï¼‰
            const rankData = [];
            const combinedData = [];
            
            if (collectors.rawRows) {
                collectors.rawRows.forEach(r => {
                    const listing = listingMapUnified[r.cbCode] || {};
                    
                    // rankData è³‡æ–™
                    if (listing.marketHigh > 0) {
                        rankData.push({
                            issueSize: r.issueSize, capital: r.capital, theoreticalPrice: r.theoPrice,
                            rating: r.rating, industry: r.industry, broker: r.broker,
                            marketHigh: listing.marketHigh, marketLow: listing.marketLow
                        });
                    }
                    
                    // combinedData è³‡æ–™
                    if (r.theoPrice > 0) {
                        const gain = listing.marketHigh > 0 ? listing.marketHigh - (listing.issuePrice || 100) : null;
                        const lowPremium = (r.theoPrice > 0 && r.minBid > 0) ? (r.minBid / r.theoPrice - 1) * 100 : null;
                        const avgPremium = (r.theoPrice > 0 && r.avgBid > 0) ? (r.avgBid / r.theoPrice - 1) * 100 : null;
                        let isRecent = false;
                        if (listing.listDate) {
                            const d = parseExcelDate(listing.listDate);
                            if (d) isRecent = d.getFullYear() >= 2024;
                        }
                        let sizeKey = '>=10å„„';
                        if (r.issueSize > 0 && r.issueSize < 3) sizeKey = '<3å„„';
                        else if (r.issueSize < 5) sizeKey = '3-5å„„';
                        else if (r.issueSize < 10) sizeKey = '5-10å„„';
                        
                        combinedData.push({
                            theoPrice: r.theoPrice, theoKey: r.theoKey, bidMultiple: r.bidMultiple,
                            guarantee: r.guarantee, issueSize: r.issueSize, sizeKey,
                            gain, isRecent, lowPremium, avgPremium, minBidPrice: r.minBid
                        });
                    }
                });
            }
            
            // è¨ˆç®—ç™¼è¡Œè¦æ¨¡å€é–“æ’å
            const sizeRanges = [
                { key: 'å°æ–¼2å„„', filter: d => d.issueSize > 0 && d.issueSize < 2 },
                { key: '2~5å„„', filter: d => d.issueSize >= 2 && d.issueSize < 5 },
                { key: '5~10å„„', filter: d => d.issueSize >= 5 && d.issueSize < 10 },
                { key: '10~15å„„', filter: d => d.issueSize >= 10 && d.issueSize < 15 },
                { key: '15~20å„„', filter: d => d.issueSize >= 15 && d.issueSize < 20 },
                { key: 'å¤§æ–¼20å„„', filter: d => d.issueSize >= 20 }
            ];
            const sizeStats = sizeRanges.map(r => {
                const filtered = rankData.filter(r.filter);
                const avgHigh = filtered.length > 0 ? filtered.reduce((s, d) => s + d.marketHigh, 0) / filtered.length : 0;
                return { key: r.key, avgHigh, count: filtered.length };
            }).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['ç™¼è¡Œè¦æ¨¡'] = {};
            sizeStats.forEach((s, idx) => {
                window.dimensionRankings['ç™¼è¡Œè¦æ¨¡'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: sizeStats.length, count: s.count };
            });
            
            // è¨ˆç®—è‚¡æœ¬å€é–“æ’å
            const capitalRanges = [
                { key: 'å°æ–¼3å„„', filter: d => d.capital > 0 && d.capital < 3 },
                { key: '3~6å„„', filter: d => d.capital >= 3 && d.capital < 6 },
                { key: '6~10å„„', filter: d => d.capital >= 6 && d.capital < 10 },
                { key: '10~15å„„', filter: d => d.capital >= 10 && d.capital < 15 },
                { key: '15~20å„„', filter: d => d.capital >= 15 && d.capital < 20 },
                { key: 'å¤§æ–¼20å„„', filter: d => d.capital >= 20 }
            ];
            const capitalStats = capitalRanges.map(r => {
                const filtered = rankData.filter(r.filter);
                const avgHigh = filtered.length > 0 ? filtered.reduce((s, d) => s + d.marketHigh, 0) / filtered.length : 0;
                return { key: r.key, avgHigh, count: filtered.length };
            }).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['è‚¡æœ¬'] = {};
            capitalStats.forEach((s, idx) => {
                window.dimensionRankings['è‚¡æœ¬'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: capitalStats.length, count: s.count };
            });
            
            // è¨ˆç®—ç†è«–åƒ¹å€é–“æ’å
            const theoRanges = [
                { key: 'å°æ–¼90å…ƒ', filter: d => d.theoreticalPrice > 0 && d.theoreticalPrice < 90 },
                { key: '90~95å…ƒ', filter: d => d.theoreticalPrice >= 90 && d.theoreticalPrice < 95 },
                { key: '95~100å…ƒ', filter: d => d.theoreticalPrice >= 95 && d.theoreticalPrice < 100 },
                { key: '100~105å…ƒ', filter: d => d.theoreticalPrice >= 100 && d.theoreticalPrice < 105 },
                { key: '105~110å…ƒ', filter: d => d.theoreticalPrice >= 105 && d.theoreticalPrice < 110 },
                { key: '110~115å…ƒ', filter: d => d.theoreticalPrice >= 110 && d.theoreticalPrice < 115 },
                { key: 'å¤§æ–¼115å…ƒ', filter: d => d.theoreticalPrice >= 115 }
            ];
            const theoStats = theoRanges.map(r => {
                const filtered = rankData.filter(r.filter);
                const avgHigh = filtered.length > 0 ? filtered.reduce((s, d) => s + d.marketHigh, 0) / filtered.length : 0;
                return { key: r.key, avgHigh, count: filtered.length };
            }).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['ç†è«–åƒ¹'] = {};
            theoStats.forEach((s, idx) => {
                window.dimensionRankings['ç†è«–åƒ¹'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: theoStats.length, count: s.count };
            });
            
            // è¨ˆç®—ä¿¡è©•æ’å
            const ratingStats = [];
            for (let i = 1; i <= 9; i++) {
                const filtered = rankData.filter(d => d.rating === String(i));
                const avgHigh = filtered.length > 0 ? filtered.reduce((s, d) => s + d.marketHigh, 0) / filtered.length : 0;
                if (filtered.length > 0) {
                    ratingStats.push({ key: String(i), avgHigh, count: filtered.length });
                }
            }
            ratingStats.sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['ä¿¡è©•'] = {};
            ratingStats.forEach((s, idx) => {
                window.dimensionRankings['ä¿¡è©•'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: ratingStats.length, count: s.count };
            });
            
            // è¨ˆç®—ç”¢æ¥­æ’å
            const industryGroups2 = {};
            rankData.forEach(d => {
                if (d.industry) {
                    if (!industryGroups2[d.industry]) industryGroups2[d.industry] = [];
                    industryGroups2[d.industry].push(d.marketHigh);
                }
            });
            const industryStats = Object.keys(industryGroups2).map(key => ({
                key,
                avgHigh: industryGroups2[key].reduce((s, v) => s + v, 0) / industryGroups2[key].length,
                count: industryGroups2[key].length
            })).filter(s => s.count >= 3).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['ç”¢æ¥­'] = {};
            industryStats.forEach((s, idx) => {
                window.dimensionRankings['ç”¢æ¥­'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: industryStats.length, count: s.count };
            });
            
            // è¨ˆç®—åˆ¸å•†æ’å
            const brokerGroups2 = {};
            rankData.forEach(d => {
                if (d.broker) {
                    if (!brokerGroups2[d.broker]) brokerGroups2[d.broker] = [];
                    brokerGroups2[d.broker].push(d.marketHigh);
                }
            });
            const brokerStats = Object.keys(brokerGroups2).map(key => ({
                key,
                avgHigh: brokerGroups2[key].reduce((s, v) => s + v, 0) / brokerGroups2[key].length,
                count: brokerGroups2[key].length
            })).filter(s => s.count >= 3).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['ç™¼è¡Œåˆ¸å•†'] = {};
            brokerStats.forEach((s, idx) => {
                window.dimensionRankings['ç™¼è¡Œåˆ¸å•†'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: brokerStats.length, count: s.count };
            });
            
            console.log('âœ… å„ç¶­åº¦å€é–“æ’åè¨ˆç®—å®Œæˆ:', Object.keys(window.dimensionRankings));
            
            // v3.72 æ–°å¢ï¼šè¨ˆç®—å„æ¢ä»¶çµ„åˆçš„æ­·å²çµ±è¨ˆï¼ˆç”¨æ–¼ç«¶æ‹å‰è©•ä¼°ï¼‰
            // combinedData å·²åœ¨ä¸Šæ–¹é è™•ç†ä¸­å»ºç«‹
            if (combinedData && combinedData.length > 0) {
                // è¨ˆç®—å„æ¢ä»¶çµ„åˆçš„çµ±è¨ˆ
                window.conditionStats = {};
                const theoKeys = ['<95', '95-100', '100-105', '105-110', '>=110'];
                const guarKeys = ['æœ‰æ“”ä¿', 'ç„¡æ“”ä¿'];
            
                theoKeys.forEach(tk => {
                guarKeys.forEach(gk => {
                    const key = `${tk}_${gk}`;
                    const group = combinedData.filter(d => d.theoKey === tk && d.guarantee === gk);
                    const recentGroup = group.filter(d => d.isRecent);
                    
                    if (group.length >= 3) {
                        // å…¨éƒ¨æ•¸æ“š
                        const bidMults = group.map(d => d.bidMultiple).filter(v => v > 0);
                        const gains = group.map(d => d.gain).filter(v => v !== null);
                        const wins = gains.filter(g => g >= 10).length;
                        // v3.73 æ–°å¢ï¼šæº¢åƒ¹ç‡çµ±è¨ˆï¼ˆç›¸å°ç†è«–åƒ¹ï¼‰
                        const lowPrems = group.map(d => d.lowPremium).filter(v => v !== null);
                        const avgPrems = group.map(d => d.avgPremium).filter(v => v !== null);
                        
                        // è¿‘æœŸæ•¸æ“šï¼ˆå„ªå…ˆä½¿ç”¨ï¼‰
                        const recentBidMults = recentGroup.map(d => d.bidMultiple).filter(v => v > 0);
                        const recentGains = recentGroup.map(d => d.gain).filter(v => v !== null);
                        const recentWins = recentGains.filter(g => g >= 10).length;
                        // v3.73 æ–°å¢ï¼šè¿‘æœŸæº¢åƒ¹ç‡
                        const recentLowPrems = recentGroup.map(d => d.lowPremium).filter(v => v !== null);
                        const recentAvgPrems = recentGroup.map(d => d.avgPremium).filter(v => v !== null);
                        
                        window.conditionStats[key] = {
                            // å…¨éƒ¨çµ±è¨ˆ
                            count: group.length,
                            avgBidMultiple: bidMults.length > 0 ? bidMults.reduce((s,v) => s+v, 0) / bidMults.length : 2.5,
                            avgGain: gains.length > 0 ? gains.reduce((s,v) => s+v, 0) / gains.length : 30,
                            medianGain: gains.length > 0 ? gains.sort((a,b) => a-b)[Math.floor(gains.length/2)] : 20,
                            winRate: gains.length > 0 ? wins / gains.length : 0.7,
                            // v3.73 æ–°å¢ï¼šæº¢åƒ¹ç‡çµ±è¨ˆï¼ˆç›¸å°ç†è«–åƒ¹ï¼Œé€™æ‰æ˜¯ä¸»åŠ›å‡ºåƒ¹çš„åŸºæº–ï¼‰
                            avgLowPremium: lowPrems.length > 0 ? lowPrems.reduce((s,v) => s+v, 0) / lowPrems.length : 5,
                            avgAvgPremium: avgPrems.length > 0 ? avgPrems.reduce((s,v) => s+v, 0) / avgPrems.length : 7,
                            // è¿‘æœŸçµ±è¨ˆï¼ˆ2024å¹´å¾Œï¼‰
                            recentCount: recentGroup.length,
                            recentAvgBidMultiple: recentBidMults.length >= 3 ? recentBidMults.reduce((s,v) => s+v, 0) / recentBidMults.length : null,
                            recentAvgGain: recentGains.length >= 3 ? recentGains.reduce((s,v) => s+v, 0) / recentGains.length : null,
                            recentWinRate: recentGains.length >= 3 ? recentWins / recentGains.length : null,
                            // v3.73 æ–°å¢ï¼šè¿‘æœŸæº¢åƒ¹ç‡ï¼ˆç›¸å°ç†è«–åƒ¹ï¼‰
                            recentAvgLowPremium: recentLowPrems.length >= 3 ? recentLowPrems.reduce((s,v) => s+v, 0) / recentLowPrems.length : null,
                            recentAvgAvgPremium: recentAvgPrems.length >= 3 ? recentAvgPrems.reduce((s,v) => s+v, 0) / recentAvgPrems.length : null
                        };
                    }
                });
            });
            
            console.log(`è¨ˆç®—æ¢ä»¶çµ„åˆçµ±è¨ˆ: ${Object.keys(window.conditionStats).length} çµ„`);
            console.log('æ¢ä»¶çµ„åˆçµ±è¨ˆ:', window.conditionStats);
            }
        }

        // v3.62 æ–°å¢ï¼šå»ºç«‹CBæ”¶ç›¤åƒ¹å°ç…§è¡¨ï¼ˆå¾09å·¥ä½œè¡¨Dæ¬„ã€ŒCBæ”¶ç›¤åƒ¹ã€è®€å–ï¼‰
        window.cbClosePriceMap = {};
        if (sheetCBClose && sheetCBClose.length > 0) {
            sheetCBClose.forEach(row => {
                // Aæ¬„æ˜¯ã€Œä»£ç¢¼ã€ï¼ŒDæ¬„æ˜¯ã€ŒCBæ”¶ç›¤åƒ¹ã€
                let id = row['ä»£ç¢¼'] || row['ä»£è™Ÿ'] || row['CBä»£è™Ÿ'];
                let closePrice = row['CBæ”¶ç›¤åƒ¹'] || row['æ”¶ç›¤åƒ¹'] || row['CBæ”¶ç›¤'];
                
                if (id && closePrice) {
                    const cleanId = String(id).replace('.0', '').trim();
                    window.cbClosePriceMap[cleanId] = safeFloat(closePrice);
                }
            });
            console.log(`è¼‰å…¥CBæ”¶ç›¤åƒ¹: ${Object.keys(window.cbClosePriceMap).length} ç­†`);
        }

        // å»ºç«‹æ›ç‰Œä¸­ä»£è™ŸSetï¼ˆç”¨æ–¼åˆ¤æ–·ç‹€æ…‹ï¼‰
        if (sheetListed && sheetListed.length > 0) {
            sheetListed.forEach(row => {
                let id = row['ä»£è™Ÿ'] || row['CBä»£è™Ÿ'] || row['è‚¡ç¥¨ä»£è™Ÿ'];
                if (id) listedSet.add(String(id).replace('.0','').trim());
            });
            console.log(`è¼‰å…¥æ›ç‰Œä¸­æ¸…å–®: ${listedSet.size} ç­†`);
        }
        
        // v3.59 æ–°å¢ï¼šè™•ç†æ‰¿éŠ·é€²è¡Œä¸­è³‡æ–™
        // v3.72 ä¿®æ”¹ï¼šå‹•æ…‹å»ºç«‹pendingCasesé™£åˆ—ä¾›é–ƒé›»å¸¶å…¥ä½¿ç”¨
        window.pendingIssueData = [];
        pendingCases = []; // æ¸…ç©ºä¸¦é‡æ–°å»ºç«‹
        
        if (sheetPending && sheetPending.length > 0) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            sheetPending.forEach(row => {
                const size = safeFloat(row['ç™¼è¡Œé‡']);
                if (size <= 0) return;
                
                // åŸºæœ¬è³‡æ–™
                const stockCode = String(row['è‚¡ç¥¨ä»£è™Ÿ'] || '').replace('.0', '').trim();
                const cbCode = String(row['æ¨™çš„ä»£è™Ÿ'] || '').replace('.0', '').trim();
                const cbName = row['ç™¼è¡Œæ¨™çš„'] || '';
                const auctionType = row['è©¢åœˆ/ç«¶æ‹'] || '';
                const broker = row['ç™¼è¡Œåˆ¸å•†'] || '';
                const capital = safeFloat(row['è‚¡æœ¬']);
                const convPrice = safeFloat(row['è½‰æ›åƒ¹']);
                const stockPrice = safeFloat(row['è‚¡åƒ¹']);
                const yearsRaw = row['å¹´æœŸ'] || '';
                const years = yearsRaw.toString().replace(/[^0-9]/g, '') || '3';
                
                // è™•ç†TCRI/æ“”ä¿æ¬„ä½
                const tcriRaw = String(row['TCRI/æ“”ä¿'] || '').trim();
                let guarantee = 'ç„¡æ“”ä¿';
                let rating = '';
                if (tcriRaw.toUpperCase().startsWith('TCRI')) {
                    // TCRIé–‹é ­ = ç„¡æ“”ä¿ï¼Œæ•¸å­—æ˜¯ä¿¡è©•
                    guarantee = 'ç„¡æ“”ä¿';
                    const match = tcriRaw.match(/TCRI\s*(\d+)/i);
                    if (match) rating = match[1];
                } else if (tcriRaw) {
                    // æœ‰éŠ€è¡Œåç¨± = æœ‰æ“”ä¿
                    guarantee = 'æœ‰æ“”ä¿';
                    rating = '';
                }
                
                // è™•ç†æ‰¿éŠ·åƒ¹æ ¼ï¼ˆå¯èƒ½æ˜¯å€é–“ï¼‰
                const priceRaw = row['æ‰¿éŠ·åƒ¹æ ¼'];
                let floorPrice = 100, highPrice = 100, isPriceRange = false;
                let priceIsDecimal = false; // v3.73 æ–°å¢ï¼šåˆ¤æ–·åƒ¹æ ¼æ˜¯å¦æœ‰å°æ•¸ï¼ˆéæ•´æ•¸=å·²æˆäº¤ï¼‰
                if (priceRaw) {
                    const priceStr = String(priceRaw);
                    if (priceStr.includes('~') || priceStr.includes('-')) {
                        const parts = priceStr.split(/[~-]/);
                        floorPrice = safeFloat(parts[0]) || 100;
                        highPrice = safeFloat(parts[1]) || floorPrice;
                        isPriceRange = floorPrice !== highPrice;
                    } else {
                        floorPrice = safeFloat(priceRaw) || 100;
                        highPrice = floorPrice;
                    }
                    // v3.73ï¼šæª¢æŸ¥åƒ¹æ ¼æ˜¯å¦æœ‰å°æ•¸ï¼ˆå¦‚101.55è¡¨ç¤ºå·²æˆäº¤ï¼‰
                    priceIsDecimal = (floorPrice % 1 !== 0) || (highPrice % 1 !== 0);
                }
                
                // è™•ç†æŠ•æ¨™æœŸé–“
                const bidPeriodRaw = row['è©¢åœˆ/æŠ•æ¨™æœŸé–“'] || '';
                let bidPeriod = '', bidEndDate = '', openDate = '';
                if (bidPeriodRaw && bidPeriodRaw !== 'æœªå®š') {
                    bidPeriod = bidPeriodRaw;
                    // è§£æçµæŸæ—¥æœŸï¼Œæ ¼å¼å¦‚ "11/10-11/12" æˆ– "12/17-12/19"
                    const parts = bidPeriodRaw.split('-');
                    if (parts.length >= 2) {
                        const endPart = parts[1].trim();
                        const [endMonth, endDay] = endPart.split('/').map(Number);
                        if (endMonth && endDay) {
                            // v3.96 ä¿®æ­£ï¼šæ›´æº–ç¢ºçš„å¹´ä»½åˆ¤æ–·
                            // å¦‚æœçµæŸæœˆä»½ > ä»Šå¤©æœˆä»½ï¼Œå‰‡ç‚ºä»Šå¹´
                            // å¦‚æœçµæŸæœˆä»½ < ä»Šå¤©æœˆä»½ï¼Œéœ€è¦åˆ¤æ–·æ˜¯éå»é‚„æ˜¯æœªä¾†
                            // å¦‚æœçµæŸæœˆä»½ == ä»Šå¤©æœˆä»½ï¼Œæ¯”è¼ƒæ—¥æœŸ
                            const currentMonth = today.getMonth() + 1;
                            const currentDay = today.getDate();
                            const currentYear = today.getFullYear();
                            
                            let year;
                            if (endMonth > currentMonth) {
                                // æœˆä»½æ¯”ä»Šå¤©å¤§ï¼Œæ˜¯ä»Šå¹´çš„æœªä¾†æ—¥æœŸ
                                year = currentYear;
                            } else if (endMonth < currentMonth) {
                                // æœˆä»½æ¯”ä»Šå¤©å°ï¼Œæ˜¯ä»Šå¹´å·²éå»çš„æ—¥æœŸï¼ˆä¸æ˜¯æ˜å¹´ï¼‰
                                // æ‰¿éŠ·ä¸­æ¡ˆä»¶çš„æ™‚ç¨‹ä¸æœƒè·¨å¹´å¤ªé ï¼Œæ‰€ä»¥è¦–ç‚ºä»Šå¹´å·²é
                                year = currentYear;
                            } else {
                                // åŒæœˆä»½ï¼Œæ¯”è¼ƒæ—¥æœŸ
                                year = currentYear;
                            }
                            
                            bidEndDate = `${year}-${String(endMonth).padStart(2, '0')}-${String(endDay).padStart(2, '0')}`;
                            // é–‹æ¨™æ—¥é€šå¸¸æ˜¯æˆªæ¨™å¾Œ2å€‹å·¥ä½œæ—¥
                            const endDateObj = new Date(bidEndDate);
                            endDateObj.setDate(endDateObj.getDate() + 2);
                            openDate = endDateObj.toISOString().split('T')[0];
                        }
                    }
                }
                
                // è™•ç†æ›ç‰Œæ—¥
                let listingDate = '';
                const listDateRaw = row['æ›ç‰Œæ—¥'];
                if (listDateRaw && listDateRaw !== 'æœªå®š') {
                    const d = parseExcelDate(listDateRaw);
                    if (d) {
                        listingDate = d.toISOString().split('T')[0];
                    }
                }
                
                // åˆ¤æ–·ç‹€æ…‹
                // v3.73 ä¿®æ­£ï¼šå¢åŠ åƒ¹æ ¼åˆ¤æ–·ï¼ˆéæ•´æ•¸=å·²æˆäº¤=å·²é–‹æ¨™çµæŸï¼‰
                let status = 'pending';
                
                // å„ªå…ˆåˆ¤æ–·ï¼šåƒ¹æ ¼æœ‰å°æ•¸é» = å·²ç¶“é–‹æ¨™çµæŸï¼ˆæˆäº¤åƒ¹ï¼‰
                if (priceIsDecimal) {
                    status = 'opened';
                } else if (listingDate) {
                    const listDate = new Date(listingDate);
                    if (listDate <= today) {
                        status = 'listed';
                    } else if (openDate) {
                        const openDateObj = new Date(openDate);
                        if (openDateObj <= today) {
                            status = 'opened';
                        } else if (bidEndDate) {
                            const bidEndDateObj = new Date(bidEndDate);
                            if (bidEndDateObj < today) {
                                status = 'closed'; // æˆªæ¨™å·²éä½†é‚„æ²’é–‹æ¨™
                            } else if (bidPeriod) {
                                status = 'bidding';
                            }
                        }
                    }
                } else if (openDate) {
                    const openDateObj = new Date(openDate);
                    if (openDateObj <= today) {
                        status = 'opened';
                    } else if (bidEndDate) {
                        const bidEndDateObj = new Date(bidEndDate);
                        if (bidEndDateObj < today) {
                            status = 'closed';
                        } else if (bidPeriod) {
                            status = 'bidding';
                        }
                    }
                } else if (bidEndDate) {
                    // v3.73 æ–°å¢ï¼šå³ä½¿æ²’æœ‰é–‹æ¨™æ—¥ï¼Œå¦‚æœæˆªæ¨™æ—¥å·²éä¹Ÿç®—closed
                    const bidEndDateObj = new Date(bidEndDate);
                    if (bidEndDateObj < today) {
                        status = 'closed';
                    }
                }
                
                // è¨ˆç®—å€é–“å€¼
                const getSizeRange = (s) => {
                    if (s < 2) return 'å°æ–¼2å„„';
                    if (s < 5) return '2~5å„„';
                    if (s < 10) return '5~10å„„';
                    if (s < 15) return '10~15å„„';
                    if (s < 20) return '15~20å„„';
                    return 'å¤§æ–¼20å„„';
                };
                const getCapitalRange = (c) => {
                    if (c < 3) return 'å°æ–¼3å„„';
                    if (c < 6) return '3~6å„„';
                    if (c < 10) return '6~10å„„';
                    if (c < 15) return '10~15å„„';
                    if (c < 20) return '15~20å„„';
                    return 'å¤§æ–¼20å„„';
                };
                const getConvRange = (p) => {
                    if (p <= 0) return '';
                    if (p < 20) return 'å°æ–¼20å…ƒ';
                    if (p < 50) return '20~50å…ƒ';
                    if (p < 100) return '50~100å…ƒ';
                    if (p < 150) return '100~150å…ƒ';
                    if (p < 200) return '150~200å…ƒ';
                    return 'å¤§æ–¼200å…ƒ';
                };
                
                // v3.81 æ–°å¢ï¼šè¨ˆç®—ç†è«–åƒ¹å€é–“
                const getTheoRange = (stockP, convP) => {
                    if (stockP <= 0 || convP <= 0) return '';
                    const theo = (stockP / convP) * 100;
                    if (theo < 90) return 'å°æ–¼90å…ƒ';
                    if (theo < 95) return '90~95å…ƒ';
                    if (theo < 100) return '95~100å…ƒ';
                    if (theo < 105) return '100~105å…ƒ';
                    if (theo < 110) return '105~110å…ƒ';
                    if (theo < 115) return '110~115å…ƒ';
                    return 'å¤§æ–¼115å…ƒ';
                };
                
                // å¾ç”¢æ¥­å°ç…§è¡¨ç²å–ç”¢æ¥­
                const industry = window.industryMap[stockCode] || 'å…¶ä»–';
                
                // å»ºç«‹pendingCaseç‰©ä»¶
                const caseObj = {
                    stockCode: stockCode,
                    cbCode: cbCode,
                    cbName: cbName,
                    auctionType: auctionType,
                    industry: industry,
                    broker: broker,
                    issueSize: size,
                    sizeRange: getSizeRange(size),
                    capital: capital,
                    capitalRange: getCapitalRange(capital),
                    convPrice: convPrice,
                    convRange: getConvRange(convPrice),
                    theoRange: getTheoRange(stockPrice, convPrice),  // v3.81 æ–°å¢
                    years: years,
                    guarantee: guarantee,
                    rating: rating,
                    floorPrice: floorPrice,
                    highPrice: highPrice,
                    isPriceRange: isPriceRange,
                    priceIsDecimal: priceIsDecimal, // v3.73 æ–°å¢ï¼šåƒ¹æ ¼æ˜¯å¦ç‚ºå°æ•¸ï¼ˆæˆäº¤åƒ¹ï¼‰
                    stockPrice: stockPrice,
                    bidPeriod: bidPeriod,
                    bidEndDate: bidEndDate,
                    openDate: openDate,
                    listingDate: listingDate,
                    status: status,
                    // v3.90 æ–°å¢ï¼šç«¶æ‹çµæœæ¬„ä½ï¼ˆRã€Sã€Tã€Uæ¬„ä½ï¼‰
                    actualMinBid: safeFloat(row['æœ€ä½å¾—æ¨™'] || row['æœ€ä½å¾—æ¨™åƒ¹æ ¼'] || row['R'] || 0),
                    actualAvgBid: safeFloat(row['åŠ æ¬Šå‡åƒ¹'] || row['å¹³å‡å¾—æ¨™'] || row['S'] || 0),
                    actualBidMult: safeFloat(row['æŠ•æ¨™å€æ•¸'] || row['T'] || 0),
                    actualListPrice: safeFloat(row['æ›ç‰Œåƒ¹'] || row['U'] || 0)
                };
                
                pendingCases.push(caseObj);
                
                // åŒæ™‚æ›´æ–°èˆŠçš„pendingIssueDataï¼ˆä¿æŒç›¸å®¹æ€§ï¼‰
                window.pendingIssueData.push({
                    id: cbCode,
                    name: cbName,
                    type: auctionType,
                    size: size,
                    broker: broker,
                    rating: tcriRaw,
                    listDate: listingDate
                });
            });
            
            console.log(`è¼‰å…¥é–ƒé›»å¸¶å…¥è³‡æ–™: ${pendingCases.length} ç­†`);
            console.log(`  - å·²æ›ç‰Œ: ${pendingCases.filter(c => c.status === 'listed').length} ç­†`);
            console.log(`  - å·²é–‹æ¨™: ${pendingCases.filter(c => c.status === 'opened').length} ç­†`);
            console.log(`  - å·²æˆªæ¨™: ${pendingCases.filter(c => c.status === 'closed').length} ç­†`);
            console.log(`  - æŠ•æ¨™ä¸­: ${pendingCases.filter(c => c.status === 'bidding').length} ç­†`);
            console.log(`  - å¾…å…¬å‘Š: ${pendingCases.filter(c => c.status === 'pending').length} ç­†`);
            console.log(`  - ç«¶æ‹å¾…æŠ•æ¨™: ${pendingCases.filter(c => (c.status === 'pending' || c.status === 'bidding') && c.auctionType === 'ç«¶æ‹').length} ç­†`);
        }
        
        // v3.59 æ–°å¢ï¼šè™•ç†è‘£äº‹æœƒæ±ºè­°è³‡æ–™
        window.boardApprovalData = [];
        if (sheetBoard && sheetBoard.length > 0) {
            sheetBoard.forEach(row => {
                const size = safeFloat(row['ç™¼è¡Œé‡']);
                if (size > 0) {
                    window.boardApprovalData.push({
                        id: row['CBä»£ç¢¼'] || row['è‚¡é°¾ä»£è™Ÿ'] || '',
                        name: row['ç™¼è¡Œæ¨™çš„'] || '',
                        type: row['è©¢åœˆ/ç«¶åƒ¹'] || '',
                        size: size,
                        broker: row['ä¸»è¾¦åˆ¸å•†'] || '',
                        rating: row['TCRI/æ“”ä¿'] || '',
                        boardDate: row['è‘£äº‹æœƒé€šé'] || ''
                    });
                }
            });
            console.log(`è¼‰å…¥è‘£äº‹æœƒæ±ºè­°: ${window.boardApprovalData.length} ç­†, ç¸½é¡ ${window.boardApprovalData.reduce((s,d)=>s+d.size,0).toFixed(1)} å„„`);
        }

        // v3.61 æ–°å¢ï¼šè®€å–CBASå ±åƒ¹è¡¨ (å·¥ä½œè¡¨11)
        const sheetCBAS = getSheetData(['11', 'CBASå ±åƒ¹']);
        window.cbasData = [];
        if (sheetCBAS && sheetCBAS.length > 0) {
            sheetCBAS.forEach(row => {
                const name = row['å¯è½‰å‚µåç¨±'];
                const code = row['å¯è½‰å‚µä»£ç¢¼'];
                if (!name || !code) return;
                
                const premium = safeFloat(row['æ¬Šåˆ©é‡‘(ä½°å…ƒå ±åƒ¹)']);
                const remainingYears = safeFloat(row['å‰©é¤˜å¹´æœŸ']);
                const discountRate = safeFloat(row['æº¢(æŠ˜)åƒ¹%']);
                const ratingRaw = row['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)'] || '';
                
                // åˆ¤æ–·æ“”ä¿é¡å‹ï¼šæ•¸å­—ç‚ºTCRIç„¡æ“”ä¿ï¼Œéæ•¸å­—ç‚ºéŠ€è¡Œæœ‰æ“”ä¿
                const isGuaranteed = ratingRaw && !/^\d+$/.test(ratingRaw.trim());
                const guaranteeType = isGuaranteed ? 'guaranteed' : 'unguaranteed';
                const guaranteeDisplay = isGuaranteed ? ratingRaw : `TCRI ${ratingRaw}`;
                
                window.cbasData.push({
                    name: name,
                    code: String(code).replace('.0', ''),
                    rating: ratingRaw,
                    guaranteeType: guaranteeType,
                    guaranteeDisplay: guaranteeDisplay,
                    isGuaranteed: isGuaranteed,
                    premium: premium,
                    expiryDate: row['é¸æ“‡æ¬Šåˆ°æœŸæ—¥'] || '',
                    sellbackPrice: safeFloat(row['è³£å›åƒ¹æ ¼(A)']),
                    sellbackDate: row['è³£å›æ—¥æœŸ(B)'] || '',
                    remainingYears: remainingYears,
                    discountRateC: safeFloat(row['æŠ˜ç¾ç‡(C)']),
                    premiumRef: safeFloat(row['æ¬Šåˆ©é‡‘åƒè€ƒåƒ¹']),
                    stockPrice: safeFloat(row['ç¾è‚¡åƒè€ƒåƒ¹']),
                    conversionPrice: safeFloat(row['è½‰æ›åƒ¹æ ¼']),
                    cbConversionValue: safeFloat(row['CBè½‰æ›åƒ¹å€¼']),
                    cbRefPrice: safeFloat(row['CBåƒè€ƒåƒ¹']),
                    discountPct: discountRate,
                    volatility120: safeFloat(row['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©%']),
                    volatility240: safeFloat(row['è‚¡åƒ¹æ³¢å‹•ç‡240å¤©%']),
                    remainingRatio: safeFloat(row['æµé€šé¤˜é¡å ç™¼è¡Œç¸½é¡%']),
                    issueAmount: safeFloat(row['åŸå§‹ç™¼è¡Œé‡']),
                    industry: row['ç”¢æ¥­'] || ''
                });
            });
            const guaranteedCount = window.cbasData.filter(d => d.isGuaranteed).length;
            const unguaranteedCount = window.cbasData.filter(d => !d.isGuaranteed).length;
            console.log(`è¼‰å…¥CBASå ±åƒ¹è¡¨: ${window.cbasData.length} ç­† (æœ‰æ“”ä¿${guaranteedCount}ç­†, ç„¡æ“”ä¿${unguaranteedCount}ç­†)`);
        }
        
        // v3.61 æ–°å¢ï¼šå¾01å·¥ä½œè¡¨å»ºç«‹CBè£œå……è³‡è¨Šå°ç…§è¡¨ï¼ˆåˆ¸å•†ã€è‚¡æœ¬ï¼‰
        window.cbSupplementMap = {};
        if (sheetAllCB && sheetAllCB.length > 0) {
            sheetAllCB.forEach(row => {
                const rawId = row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'];
                if (!rawId) return;
                const id = String(rawId).replace('.0', '').trim();
                window.cbSupplementMap[id] = {
                    broker: row['ç™¼è¡Œåˆ¸å•†'] || row['æ‰¿éŠ·åˆ¸å•†'] || row['ä¸»è¾¦åˆ¸å•†'] || '',
                    capital: safeFloat(row['è‚¡æœ¬å¤§å°']) || safeFloat(row['è‚¡æœ¬']) || safeFloat(row['è‚¡æœ¬(å„„)']) || safeFloat(row['è‚¡æœ¬(å„„å…ƒ)']),
                    issueSize: safeFloat(row['ç™¼è¡Œè¦æ¨¡']) || safeFloat(row['ç™¼è¡Œç¸½é¡'])
                };
            });
            console.log(`å»ºç«‹CBè£œå……è³‡è¨Šå°ç…§è¡¨: ${Object.keys(window.cbSupplementMap).length} ç­†`);
            
            // è£œå……CBASè³‡æ–™çš„åˆ¸å•†å’Œè‚¡æœ¬è³‡è¨Š
            if (window.cbasData && window.cbasData.length > 0) {
                let supplemented = 0;
                window.cbasData.forEach(item => {
                    const supplement = window.cbSupplementMap[item.code];
                    if (supplement) {
                        item.broker = supplement.broker;
                        item.capital = supplement.capital;
                        if (!item.issueAmount || item.issueAmount <= 0) {
                            item.issueAmount = supplement.issueSize;
                        }
                        supplemented++;
                    }
                });
                console.log(`CBASè³‡æ–™è£œå……å®Œæˆ: ${supplemented} ç­†æœ‰è£œå……åˆ¸å•†/è‚¡æœ¬è³‡è¨Š`);
            }
        }

        // å»ºç«‹æ›ç‰Œé«˜ä½å°ç…§è¡¨
        const highLowMap = {};
        if (sheetHighLow && sheetHighLow.length > 0) {
            sheetHighLow.forEach(row => {
                let id = row['ä»£è™Ÿ'] || row['CBä»£è™Ÿ'] || row['è‚¡ç¥¨ä»£è™Ÿ'];
                if(id) highLowMap[String(id).replace('.0','').trim()] = row;
            });
        }
        
        // è®€å–è©¢åœˆè³‡æ–™ (å¾01å·¥ä½œè¡¨)
        if (sheetAllCB && sheetAllCB.length > 0) {
            inquiryRawData = sheetAllCB.filter(row => {
                const type = row['è©¢åœˆç«¶æ‹'] || '';
                return type.includes('è©¢åœˆ');
            }).map(row => {
                let rawId = row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'];
                if (!rawId) return null;
                const id = String(rawId).replace('.0','').trim();
                const hlRow = highLowMap[id] || {};
                
                // v3.92 ä¿®æ­£ï¼šè™•ç†ä¿¡è©•æ ¼å¼
                // 01å·¥ä½œè¡¨Eæ¬„ã€Œä¿¡ç”¨è©•ç­‰ã€ï¼šç´”æ•¸å­—(å¦‚6)=TCRIåˆ†æ•¸ï¼ŒéŠ€è¡Œåç¨±=æœ‰æ“”ä¿
                let normalizedRating = '';
                let guaranteeFromRating = '';
                
                // å„ªå…ˆå¾01å·¥ä½œè¡¨çš„ã€Œä¿¡ç”¨è©•ç­‰ã€æ¬„ä½è®€å–
                let rawRating = row['ä¿¡ç”¨è©•ç­‰'] || row['ä¿¡è©•'] || row['TCRI/æ“”ä¿'] || '';
                rawRating = String(rawRating).trim();
                
                if (rawRating) {
                    // å¦‚æœæ˜¯1-8çš„ç´”æ•¸å­—ï¼Œå°±æ˜¯TCRIåˆ†æ•¸ï¼ˆç„¡æ“”ä¿ï¼‰
                    if (rawRating.match(/^[1-8]$/)) {
                        normalizedRating = rawRating;
                    } else if (rawRating.match(/^\d+$/)) {
                        // å…¶ä»–æ•¸å­—ä¹Ÿç•¶ä½œä¿¡è©•
                        normalizedRating = rawRating;
                    } else if (rawRating.toUpperCase().startsWith('TCRI')) {
                        // TCRIæ ¼å¼
                        const match = rawRating.match(/TCRI\s*(\d+)/i);
                        if (match) normalizedRating = match[1];
                    } else {
                        // éæ•¸å­—ï¼ˆéŠ€è¡Œåç¨±ï¼‰= æœ‰æ“”ä¿
                        guaranteeFromRating = 'æœ‰æ“”ä¿';
                    }
                }
                
                // å¦‚æœ00å·¥ä½œè¡¨æœ‰ä¿¡è©•è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨
                const hlRating = hlRow['ä¿¡ç”¨è©•ç­‰'] || hlRow['ä¿¡è©•'] || '';
                if (hlRating && String(hlRating).match(/^[1-8]$/)) {
                    normalizedRating = String(hlRating).trim();
                }
                
                // æ“”ä¿åˆ¤æ–·
                let guarantee = getSmartValue(row, 'guarantee') || row['æ“”ä¿'] || row['æœ‰ç„¡æ“”ä¿'] || guaranteeFromRating || '';
                
                return {
                    'id': id,
                    'name': getSmartValue(row, 'name') || row['åç¨±'] || '',
                    'companyName': row['å…¬å¸åç¨±'] || row['å…¬å¸'] || '',  // v3.96 æ–°å¢ï¼šä¿å­˜å…¬å¸åç¨±ç”¨æ–¼KYè‚¡åˆ¤æ–·
                    'industry': getSmartValue(row, 'industry') || row['ç”¢æ¥­åˆ†é¡'] || '',
                    'broker': getSmartValue(row, 'broker') || row['ç™¼è¡Œåˆ¸å•†'] || row['æ‰¿éŠ·åˆ¸å•†'] || '',
                    'guarantee': guarantee,
                    'rating': normalizedRating,
                    'capital': safeFloat(row['è‚¡æœ¬å¤§å°']) || safeFloat(getSmartValue(row, 'capital')),
                    'issueSize': safeFloat(row['ç™¼è¡Œè¦æ¨¡']) || safeFloat(getSmartValue(row, 'issueSize')),
                    'years': safeFloat(row['ç™¼è¡Œå¹´æœŸ']) || safeFloat(getSmartValue(row, 'years')),
                    'conversionPrice': safeFloat(row['è½‰æ›åƒ¹æ ¼']) || safeFloat(getSmartValue(row, 'conversionPrice')),
                    'marketHigh': safeFloat(hlRow['æ›ç‰Œæœ€é«˜']) || safeFloat(row['æ›ç‰Œæœ€é«˜']) || 0,
                    'marketLow': safeFloat(hlRow['æ›ç‰Œæœ€ä½']) || safeFloat(row['æ›ç‰Œæœ€ä½']) || 0,
                    'premiumRate': safeFloat(row['è¨‚åƒ¹æº¢åƒ¹ç‡']) || safeFloat(getSmartValue(row, 'premiumRate')),
                    'listDate': row['æ›ç‰Œæ—¥æœŸ'] || null,
                    'type': 'è©¢åœˆ'
                };
            }).filter(item => item !== null);
            
            console.log(`è¼‰å…¥è©¢åœˆè³‡æ–™: ${inquiryRawData.length} ç­†`);
            // é™¤éŒ¯ï¼šæª¢æŸ¥è©¢åœˆè³‡æ–™
            const withCapital = inquiryRawData.filter(d => d.capital > 0);
            const withMarket = inquiryRawData.filter(d => d.marketHigh > 0 && d.marketLow > 0);
            console.log(`è©¢åœˆè³‡æ–™ä¸­æœ‰è‚¡æœ¬æ•¸æ“š: ${withCapital.length} ç­†`);
            console.log(`è©¢åœˆè³‡æ–™ä¸­æœ‰æ›ç‰Œæ•¸æ“š: ${withMarket.length} ç­†`);
            console.log(`00å·¥ä½œè¡¨(highLowMap)ç­†æ•¸: ${Object.keys(highLowMap).length}`);
            if (withCapital.length > 0) {
                console.log('è©¢åœˆç¯„ä¾‹(å«è‚¡æœ¬):', withCapital.slice(0, 3).map(d => ({
                    id: d.id, 
                    name: d.name, 
                    capital: d.capital,
                    marketHigh: d.marketHigh,
                    marketLow: d.marketLow
                })));
            }
            // æª¢æŸ¥ highLowMap ç¯„ä¾‹
            const hlKeys = Object.keys(highLowMap).slice(0, 3);
            console.log('highLowMapç¯„ä¾‹:', hlKeys.map(k => ({
                id: k,
                high: highLowMap[k]['æ›ç‰Œæœ€é«˜'] || highLowMap[k]['æ›ç‰Œæœ€é«˜åƒ¹'],
                low: highLowMap[k]['æ›ç‰Œæœ€ä½'] || highLowMap[k]['æ›ç‰Œæœ€ä½åƒ¹']
            })));
        }

        auctionRawData = sheetAuction.map(row => {
            let rawId = row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ']; 
            if (!rawId) return null;
            
            const id = String(rawId).replace('.0','').trim();
            const hlRow = highLowMap[id] || {}; 
            
            // è™•ç†ä¿¡è©•æ ¼å¼ï¼šå„ªå…ˆå¾00å·¥ä½œè¡¨(hlRow)è®€å–ï¼Œå†å¾04å·¥ä½œè¡¨Iæ¬„è®€å–
            let rawRating = hlRow['ä¿¡ç”¨è©•ç­‰'] || hlRow['ä¿¡è©•'] || getSmartValue(row, 'rating') || '';
            let normalizedRating = '';
            if (rawRating) {
                rawRating = String(rawRating).trim();
                // å¦‚æœå·²ç¶“æ˜¯1-8çš„ç´”æ•¸å­—ï¼Œç›´æ¥ä½¿ç”¨
                if (rawRating.match(/^[1-8]$/)) {
                    normalizedRating = rawRating;
                } else {
                    const match = rawRating.match(/TCRI\s*(\d+)/i);
                    if (match) {
                        normalizedRating = match[1];
                    } else if (rawRating.match(/^\d+$/)) {
                        normalizedRating = rawRating; // å·²ç¶“æ˜¯æ•¸å­—
                    } else if (rawRating.toUpperCase().includes('BBB')) {
                        normalizedRating = 'BBB';
                    } else {
                        normalizedRating = rawRating;
                    }
                }
            }

            return {
                'id': id, 
                'stockId': getSmartValue(row, 'stockId'),
                'name': getSmartValue(row, 'name'),
                'companyName': row['å…¬å¸åç¨±'] || row['å…¬å¸'] || '',  // v3.96 æ–°å¢ï¼šä¿å­˜å…¬å¸åç¨±ç”¨æ–¼KYè‚¡åˆ¤æ–·
                'openDate': getSmartValue(row, 'openDate'),  // v3.96 ä¿®æ­£ï¼šä¿ç•™åŸå§‹æ—¥æœŸæ ¼å¼ä¾›å¾ŒçºŒè§£æ
                'openDateStr': formatDate(getSmartValue(row, 'openDate')),  // æ ¼å¼åŒ–å­—ä¸²ç”¨æ–¼é¡¯ç¤º
                'industry': getSmartValue(row, 'industry'), 
                'broker': getSmartValue(row, 'broker'),
                'guarantee': getSmartValue(row, 'guarantee'), 
                'rating': normalizedRating,
                'capital': safeFloat(getSmartValue(row, 'capital')), 
                'issueSize': safeFloat(getSmartValue(row, 'issueSize')), 
                'years': safeFloat(getSmartValue(row, 'years')),
                'conversionPrice': safeFloat(getSmartValue(row, 'conversionPrice')),
                'closePrice': safeFloat(getSmartValue(row, 'closePrice')),
                'theoreticalPrice': safeFloat(getSmartValue(row, 'theoreticalPrice')),
                'floorPrice': safeFloat(getSmartValue(row, 'floorPrice')),
                'premiumRate': getSmartValue(row, 'premiumRate'),
                'minBidPrice': safeFloat(getSmartValue(row, 'minBidPrice')), 
                'avgBidPrice': safeFloat(getSmartValue(row, 'avgBidPrice')),
                'lowPremium': normalizePremium(getSmartValue(row, 'lowPremium')), 
                'avgPremium': normalizePremium(getSmartValue(row, 'avgPremium')),
                'marketHigh': safeFloat(getSmartValue(hlRow, 'marketHigh')) || safeFloat(getSmartValue(row, 'marketHigh')), 
                'marketLow': safeFloat(getSmartValue(hlRow, 'marketLow')) || safeFloat(getSmartValue(row, 'marketLow')),
                'qualifiedCount': safeFloat(getSmartValue(row, 'qualifiedCount')),
                'bidShares': safeFloat(getSmartValue(row, 'bidShares')),
                'bidMultiple': safeFloat(getSmartValue(row, 'bidMultiple')),
                'avgBidShares': safeFloat(getSmartValue(row, 'avgBidShares')),
                'auctionShares': safeFloat(getSmartValue(row, 'auctionShares'))
            };
        }).filter(item => item !== null);

        auctionRawData.forEach(item => { 
            if (item.name) { 
                cbDatabase[item.name] = item; 
                cbNameMap[item.name] = item; 
            } 
        });
        
        autoGenerateStatistics(); 
        calculateGlobalMarketStats(); 
        initializeUI();
        
        // v3.70 æ–°å¢ï¼šåˆå§‹åŒ–å¸‚å ´æ°›åœé¢æ¿
        if (typeof updateAtmospherePanel === 'function') {
            updateAtmospherePanel();
        }
        
        loadingDiv.style.display = 'none'; 
        document.querySelector('.container').style.display = 'block';
        
        // v3.97-zs-b æ–°å¢ï¼šèƒŒæ™¯é è¼‰å…¥ä¸‰ã€å››å€å¡Šæ‰€éœ€è³‡æ–™ï¼ˆé¿å…å±•é–‹æ™‚å¡é “ï¼‰
        setTimeout(() => {
            console.log('â³ èƒŒæ™¯é è¼‰å…¥é¡å¤–è³‡æ–™...');
            
            // é è¼‰å…¥ yuanta æ­·å²è³‡æ–™ï¼ˆåŸºæœ¬è³‡æ–™æŸ¥è©¢ç”¨ï¼‰
            if (typeof loadYuantaHistoryData === 'function') {
                loadYuantaHistoryData().then(() => {
                    console.log('âœ… èƒŒæ™¯é è¼‰å…¥: yuanta æ­·å²è³‡æ–™å®Œæˆ');
                }).catch(err => console.warn('yuantaé è¼‰å…¥å¤±æ•—:', err));
            }
            
            // é è¼‰å…¥ kanban æ™‚é–“åºåˆ—è³‡æ–™ï¼ˆåƒ¹æ ¼èµ°å‹¢åˆ†æç”¨ï¼‰
            if (typeof loadAllKanbanData === 'function') {
                loadAllKanbanData().then(() => {
                    console.log('âœ… èƒŒæ™¯é è¼‰å…¥: kanban æ™‚é–“åºåˆ—å®Œæˆ');
                }).catch(err => console.warn('kanbané è¼‰å…¥å¤±æ•—:', err));
            }
        }, 1000); // å»¶é²1ç§’å¾Œé–‹å§‹ï¼Œè®“ä¸»UIå…ˆç©©å®š
    } catch (error) { 
        console.error(error); 
        loadingDiv.innerHTML = `<div style="padding:20px;background:white;color:#D32F2F;border-radius:10px;text-align:center;max-width:400px;">
        <h3>âš ï¸ ç³»çµ±å•Ÿå‹•å¤±æ•—</h3><p style="margin:10px 0;">${error.message}</p>
        <button onclick="location.reload()" style="padding:8px 20px;cursor:pointer;">é‡è©¦</button></div>`; 
    }
}

// ==========================================
// 3. çµ±è¨ˆæ ¸å¿ƒ
// ==========================================
function autoGenerateStatistics() {
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'] = {}; 
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'] = {};
    auctionRawData.forEach(row => {
        if (row.industry) updateStatCategory('ç”¢æ¥­', row.industry, row);
        if (row.broker) updateStatCategory('ç™¼è¡Œåˆ¸å•†', row.broker, row);
    });

    ['ç”¢æ¥­', 'ç™¼è¡Œåˆ¸å•†'].forEach(cat => {
        Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ'][cat]).forEach(key => {
            const item = statistics['ç¶­åº¦çµ±è¨ˆ'][cat][key];
            if (item.count > 0) {
                item['å¹³å‡æœ€ä½æº¢åƒ¹'] = item.sumLowPrem / item.count;
                item['å¹³å‡æº¢åƒ¹'] = item.sumAvgPrem / item.count;
                item['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'] = item.sumLowPrice / item.count;
                item['å¹³å‡å¾—æ¨™åƒ¹'] = item.sumAvgPrice / item.count;
                item['å¹³å‡æ›ç‰Œæœ€é«˜'] = item.countMarket > 0 ? item.sumHigh / item.countMarket : 0;
                item['å¹³å‡æ›ç‰Œæœ€ä½'] = item.countMarket > 0 ? item.sumLow / item.countMarket : 0;
                item['æ¨£æœ¬æ•¸'] = item.count;
            }
        });
    });
}

function updateStatCategory(category, key, row) {
    if (!statistics['ç¶­åº¦çµ±è¨ˆ'][category][key]) {
        statistics['ç¶­åº¦çµ±è¨ˆ'][category][key] = { count: 0, sumLowPrem: 0, sumAvgPrem: 0, sumLowPrice: 0, sumAvgPrice: 0, sumHigh: 0, sumLow: 0, countMarket: 0 };
    }
    const obj = statistics['ç¶­åº¦çµ±è¨ˆ'][category][key];
    if (row.minBidPrice > 0 || row.avgBidPrice > 0) {
        obj.count++; 
        obj.sumLowPrem += row.lowPremium; 
        obj.sumAvgPrem += row.avgPremium;
        obj.sumLowPrice += row.minBidPrice; 
        obj.sumAvgPrice += row.avgBidPrice;
    }
    if (row.marketHigh > 0 && row.marketLow > 0) {
        obj.sumHigh += row.marketHigh; 
        obj.sumLow += row.marketLow;
        obj.countMarket++;
    }
}

function calculateGlobalMarketStats() {
    let sumLow = 0, sumAvg = 0, count = 0;
    auctionRawData.forEach(d => { 
        if (d.minBidPrice > 0) { 
            sumLow += d.lowPremium; 
            sumAvg += d.avgPremium; 
            count++; 
        } 
    });
    if (count > 0) { 
        globalMarketStats.low = sumLow / count; 
        globalMarketStats.avg = sumAvg / count; 
    }
}

// v3.52 ä¿®æ”¹ï¼šå¢åŠ æ’é™¤å‰ä¸‰é«˜çš„çµ±è¨ˆ + æ“”ä¿é¡å‹ç´°åˆ†çµ±è¨ˆ
function getStatsSmart(category, val) {
    let stats = { 
        low: 0, 
        avg: 0, 
        usedFallback: false, 
        rawData: null, 
        inquiryData: null,
        excludeTop3Data: null,
        excludeTop3InquiryData: null,
        // v3.52 æ–°å¢ï¼šä¾æ“”ä¿é¡å‹ç´°åˆ†
        guaranteedAuctionData: null,
        guaranteedInquiryData: null,
        unguaranteedAuctionData: null,
        unguaranteedInquiryData: null
    };
    let filterFn = null;
    let rangeLabel = "";

    // v3.69 ä¿®æ”¹ï¼šæ”¯æ´å€é–“é¸æ“‡ï¼ˆå­—ä¸²æ ¼å¼ï¼‰
    if (category === 'è‚¡æœ¬') {
        rangeLabel = val;
        if (val === 'å°æ–¼3å„„') { filterFn = d => d.capital > 0 && d.capital < 3; }
        else if (val === '3~6å„„') { filterFn = d => d.capital >= 3 && d.capital < 6; }
        else if (val === '6~10å„„') { filterFn = d => d.capital >= 6 && d.capital < 10; }
        else if (val === '10~15å„„') { filterFn = d => d.capital >= 10 && d.capital < 15; }
        else if (val === '15~20å„„') { filterFn = d => d.capital >= 15 && d.capital < 20; }
        else if (val === 'å¤§æ–¼20å„„') { filterFn = d => d.capital >= 20; }
        // å‘ä¸‹ç›¸å®¹ï¼šå¦‚æœæ˜¯æ•¸å€¼å‰‡ç”¨èˆŠé‚è¼¯
        else {
            const v = parseFloat(val);
            if (!isNaN(v)) {
                if (v < 3) { rangeLabel = "< 3 å„„"; filterFn = d => d.capital > 0 && d.capital < 3; }
                else if (v < 6) { rangeLabel = "3~6 å„„"; filterFn = d => d.capital >= 3 && d.capital < 6; }
                else if (v < 10) { rangeLabel = "6~10 å„„"; filterFn = d => d.capital >= 6 && d.capital < 10; }
                else if (v < 15) { rangeLabel = "10~15 å„„"; filterFn = d => d.capital >= 10 && d.capital < 15; }
                else if (v < 20) { rangeLabel = "15~20 å„„"; filterFn = d => d.capital >= 15 && d.capital < 20; }
                else { rangeLabel = "> 20 å„„"; filterFn = d => d.capital >= 20; }
            }
        }
    }
    else if (category === 'ç™¼è¡Œè¦æ¨¡') {
        rangeLabel = val;
        if (val === 'å°æ–¼2å„„') { filterFn = d => d.issueSize > 0 && d.issueSize < 2; }
        else if (val === '2~5å„„') { filterFn = d => d.issueSize >= 2 && d.issueSize < 5; }
        else if (val === '5~10å„„') { filterFn = d => d.issueSize >= 5 && d.issueSize < 10; }
        else if (val === '10~15å„„') { filterFn = d => d.issueSize >= 10 && d.issueSize < 15; }
        else if (val === '15~20å„„') { filterFn = d => d.issueSize >= 15 && d.issueSize < 20; }
        else if (val === 'å¤§æ–¼20å„„') { filterFn = d => d.issueSize >= 20; }
        // å‘ä¸‹ç›¸å®¹
        else {
            const v = parseFloat(val);
            if (!isNaN(v)) {
                if (v < 2) { rangeLabel = "< 2 å„„"; filterFn = d => d.issueSize < 2; }
                else if (v < 5) { rangeLabel = "2~5 å„„"; filterFn = d => d.issueSize >= 2 && d.issueSize < 5; }
                else if (v < 10) { rangeLabel = "5~10 å„„"; filterFn = d => d.issueSize >= 5 && d.issueSize < 10; }
                else if (v < 15) { rangeLabel = "10~15 å„„"; filterFn = d => d.issueSize >= 10 && d.issueSize < 15; }
                else if (v < 20) { rangeLabel = "15~20 å„„"; filterFn = d => d.issueSize >= 15 && d.issueSize < 20; }
                else { rangeLabel = "> 20 å„„"; filterFn = d => d.issueSize >= 20; }
            }
        }
    }
    else if (category === 'è½‰æ›åƒ¹') {
        rangeLabel = val;
        if (val === 'å°æ–¼20å…ƒ') { filterFn = d => d.conversionPrice > 0 && d.conversionPrice < 20; }
        else if (val === '20~50å…ƒ') { filterFn = d => d.conversionPrice >= 20 && d.conversionPrice < 50; }
        else if (val === '50~100å…ƒ') { filterFn = d => d.conversionPrice >= 50 && d.conversionPrice < 100; }
        else if (val === '100~150å…ƒ') { filterFn = d => d.conversionPrice >= 100 && d.conversionPrice < 150; }
        else if (val === '150~200å…ƒ') { filterFn = d => d.conversionPrice >= 150 && d.conversionPrice < 200; }
        else if (val === 'å¤§æ–¼200å…ƒ') { filterFn = d => d.conversionPrice >= 200; }
        // å‘ä¸‹ç›¸å®¹
        else {
            const v = parseFloat(val);
            if (!isNaN(v)) {
                if (v < 20) { rangeLabel = "< 20 å…ƒ"; filterFn = d => d.conversionPrice < 20; }
                else if (v < 50) { rangeLabel = "20~50 å…ƒ"; filterFn = d => d.conversionPrice >= 20 && d.conversionPrice < 50; }
                else if (v < 100) { rangeLabel = "50~100 å…ƒ"; filterFn = d => d.conversionPrice >= 50 && d.conversionPrice < 100; }
                else if (v < 150) { rangeLabel = "100~150 å…ƒ"; filterFn = d => d.conversionPrice >= 100 && d.conversionPrice < 150; }
                else if (v < 200) { rangeLabel = "150~200 å…ƒ"; filterFn = d => d.conversionPrice >= 150 && d.conversionPrice < 200; }
                else { rangeLabel = "> 200 å…ƒ"; filterFn = d => d.conversionPrice >= 200; }
            }
        }
    }
    // v3.72 æ–°å¢ï¼šç†è«–åƒ¹å€é–“ï¼ˆæœ€é‡è¦çš„ç¶­åº¦ï¼‰
    else if (category === 'ç†è«–åƒ¹') {
        rangeLabel = val;
        if (val === 'å°æ–¼90å…ƒ') { filterFn = d => d.theoreticalPrice > 0 && d.theoreticalPrice < 90; }
        else if (val === '90~95å…ƒ') { filterFn = d => d.theoreticalPrice >= 90 && d.theoreticalPrice < 95; }
        else if (val === '95~100å…ƒ') { filterFn = d => d.theoreticalPrice >= 95 && d.theoreticalPrice < 100; }
        else if (val === '100~105å…ƒ') { filterFn = d => d.theoreticalPrice >= 100 && d.theoreticalPrice < 105; }
        else if (val === '105~110å…ƒ') { filterFn = d => d.theoreticalPrice >= 105 && d.theoreticalPrice < 110; }
        else if (val === '110~115å…ƒ') { filterFn = d => d.theoreticalPrice >= 110 && d.theoreticalPrice < 115; }
        else if (val === 'å¤§æ–¼115å…ƒ') { filterFn = d => d.theoreticalPrice >= 115; }
        // å‘ä¸‹ç›¸å®¹ï¼šå¦‚æœæ˜¯æ•¸å€¼å‰‡ç”¨èˆŠé‚è¼¯
        else {
            const v = parseFloat(val);
            if (!isNaN(v)) {
                if (v < 90) { rangeLabel = "< 90 å…ƒ"; filterFn = d => d.theoreticalPrice > 0 && d.theoreticalPrice < 90; }
                else if (v < 95) { rangeLabel = "90~95 å…ƒ"; filterFn = d => d.theoreticalPrice >= 90 && d.theoreticalPrice < 95; }
                else if (v < 100) { rangeLabel = "95~100 å…ƒ"; filterFn = d => d.theoreticalPrice >= 95 && d.theoreticalPrice < 100; }
                else if (v < 105) { rangeLabel = "100~105 å…ƒ"; filterFn = d => d.theoreticalPrice >= 100 && d.theoreticalPrice < 105; }
                else if (v < 110) { rangeLabel = "105~110 å…ƒ"; filterFn = d => d.theoreticalPrice >= 105 && d.theoreticalPrice < 110; }
                else if (v < 115) { rangeLabel = "110~115 å…ƒ"; filterFn = d => d.theoreticalPrice >= 110 && d.theoreticalPrice < 115; }
                else { rangeLabel = "> 115 å…ƒ"; filterFn = d => d.theoreticalPrice >= 115; }
            }
        }
    }
    else {
        const safeVal = String(val || ""); 
        if (safeVal === "") return stats;
        
        if (category === 'ç™¼è¡Œåˆ¸å•†') filterFn = d => (d.broker || '').includes(safeVal) || safeVal.includes(d.broker || '');
        else if (category === 'ç”¢æ¥­') filterFn = d => industryMatches(d.industry, safeVal);
        else if (category === 'æ“”ä¿') filterFn = d => (d.guarantee || '').includes(safeVal);
        else if (category === 'å¹´æœŸ') filterFn = d => d.years == safeVal;
        else if (category === 'ä¿¡è©•') {
            // ä¿¡è©•æ¯”å°ï¼šç”¨æˆ¶é¸ "5" è¦èƒ½æ¯”å°åˆ° rating ç‚º "5" æˆ– "TCRI5" çš„è³‡æ–™
            filterFn = d => {
                const rating = (d.rating || '').toString().trim();
                if (!rating) return false;
                // ç²¾ç¢ºæ¯”å°æ•¸å­—
                if (rating === safeVal) return true;
                // æ¯”å° TCRI æ ¼å¼
                if (rating.toUpperCase() === 'TCRI' + safeVal) return true;
                // BBB ç‰¹æ®Šè™•ç†
                if (safeVal === 'BBB' && rating.toUpperCase().includes('BBB')) return true;
                return false;
            };
        }
    }

    if (filterFn) {
        // === ç«¶æ‹æ•¸æ“šçµ±è¨ˆï¼ˆå…¨éƒ¨ï¼‰===
        const auctionFiltered = auctionRawData.filter(filterFn);
        let sumLowP = 0, sumAvgP = 0, sumLowPr = 0, sumAvgPr = 0, sumH = 0, sumL = 0, countM = 0, count = 0;
        
        auctionFiltered.forEach(d => {
            if (d.minBidPrice > 0 || d.avgBidPrice > 0) { 
                sumLowP += d.lowPremium; sumAvgP += d.avgPremium; 
                sumLowPr += d.minBidPrice; sumAvgPr += d.avgBidPrice; 
                count++; 
            }
            if (d.marketHigh > 0 && d.marketLow > 0) { 
                sumH += d.marketHigh; sumL += d.marketLow; countM++; 
            }
        });

        if (count > 0) {
            stats.rawData = { 
                'å¹³å‡æœ€ä½æº¢åƒ¹': sumLowP / count, 
                'å¹³å‡æº¢åƒ¹': sumAvgP / count, 
                'å¹³å‡æœ€ä½å¾—æ¨™åƒ¹': sumLowPr / count, 
                'å¹³å‡å¾—æ¨™åƒ¹': sumAvgPr / count,
                'å¹³å‡æ›ç‰Œæœ€é«˜': countM > 0 ? sumH / countM : 0, 
                'å¹³å‡æ›ç‰Œæœ€ä½': countM > 0 ? sumL / countM : 0, 
                'æ¨£æœ¬æ•¸': count 
            };
            if(rangeLabel) stats.rawData['å€é–“åç¨±'] = rangeLabel; 
            stats.low = stats.rawData['å¹³å‡æœ€ä½æº¢åƒ¹']; 
            stats.avg = stats.rawData['å¹³å‡æº¢åƒ¹'];
        }
        
        // === v3.52 æ–°å¢ï¼šç«¶æ‹æ’é™¤å‰ä¸‰é«˜çš„è¨ˆç®— ===
        const auctionWithMarket = auctionFiltered.filter(d => d.marketHigh > 0 && d.marketLow > 0);
        if (auctionWithMarket.length > 3) {
            // æŒ‰æ›ç‰Œæœ€é«˜æ’åºï¼Œæ’é™¤å‰ä¸‰å
            const sortedAuction = [...auctionWithMarket].sort((a, b) => b.marketHigh - a.marketHigh);
            const excludedAuction = sortedAuction.slice(3);
            
            let exSumH = 0, exSumL = 0;
            excludedAuction.forEach(d => {
                exSumH += d.marketHigh;
                exSumL += d.marketLow;
            });
            
            stats.excludeTop3Data = {
                'å¹³å‡æ›ç‰Œæœ€é«˜': exSumH / excludedAuction.length,
                'å¹³å‡æ›ç‰Œæœ€ä½': exSumL / excludedAuction.length,
                'æ¨£æœ¬æ•¸': excludedAuction.length
            };
        }
        
        // === è©¢åœˆæ•¸æ“šçµ±è¨ˆï¼ˆå…¨éƒ¨ï¼‰===
        const inquiryFiltered = inquiryRawData.filter(filterFn);
        console.log(`[${category}=${val}] è©¢åœˆç¯©é¸çµæœ: ${inquiryFiltered.length} ç­† (åŸå§‹: ${inquiryRawData.length} ç­†)`);
        
        let iSumH = 0, iSumL = 0, iCountM = 0;
        
        inquiryFiltered.forEach(d => {
            if (d.marketHigh > 0 && d.marketLow > 0) { 
                iSumH += d.marketHigh; iSumL += d.marketLow; iCountM++; 
            }
        });
        
        console.log(`[${category}=${val}] è©¢åœˆæœ‰æ›ç‰Œæ•¸æ“š: ${iCountM} ç­†`);
        
        if (iCountM > 0) {
            stats.inquiryData = {
                'å¹³å‡æ›ç‰Œæœ€é«˜': iSumH / iCountM,
                'å¹³å‡æ›ç‰Œæœ€ä½': iSumL / iCountM,
                'æ¨£æœ¬æ•¸': iCountM
            };
        }
        
        // === v3.52 æ–°å¢ï¼šè©¢åœˆæ’é™¤å‰ä¸‰é«˜çš„è¨ˆç®— ===
        const inquiryWithMarket = inquiryFiltered.filter(d => d.marketHigh > 0 && d.marketLow > 0);
        if (inquiryWithMarket.length > 3) {
            const sortedInquiry = [...inquiryWithMarket].sort((a, b) => b.marketHigh - a.marketHigh);
            const excludedInquiry = sortedInquiry.slice(3);
            
            let exISumH = 0, exISumL = 0;
            excludedInquiry.forEach(d => {
                exISumH += d.marketHigh;
                exISumL += d.marketLow;
            });
            
            stats.excludeTop3InquiryData = {
                'å¹³å‡æ›ç‰Œæœ€é«˜': exISumH / excludedInquiry.length,
                'å¹³å‡æ›ç‰Œæœ€ä½': exISumL / excludedInquiry.length,
                'æ¨£æœ¬æ•¸': excludedInquiry.length
            };
        }
        
        // === v3.53 ä¿®æ”¹ï¼šä¾æ“”ä¿é¡å‹ç´°åˆ†çµ±è¨ˆï¼ˆå«å¾—æ¨™æ•¸æ“šï¼‰===
        // æœ‰æ“”ä¿ - ç«¶æ‹
        const guaranteedAuction = auctionFiltered.filter(d => (d.guarantee || '').includes('æœ‰'));
        if (guaranteedAuction.length > 0) {
            let gaSumH = 0, gaSumL = 0, gaCountM = 0;
            let gaSumLowP = 0, gaSumAvgP = 0, gaSumLowPr = 0, gaSumAvgPr = 0, gaCountBid = 0;
            guaranteedAuction.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    gaSumH += d.marketHigh;
                    gaSumL += d.marketLow;
                    gaCountM++;
                }
                if (d.minBidPrice > 0 || d.avgBidPrice > 0) {
                    gaSumLowP += d.lowPremium;
                    gaSumAvgP += d.avgPremium;
                    gaSumLowPr += d.minBidPrice;
                    gaSumAvgPr += d.avgBidPrice;
                    gaCountBid++;
                }
            });
            stats.guaranteedAuctionData = {
                'å¹³å‡æ›ç‰Œæœ€é«˜': gaCountM > 0 ? gaSumH / gaCountM : 0,
                'å¹³å‡æ›ç‰Œæœ€ä½': gaCountM > 0 ? gaSumL / gaCountM : 0,
                'æ¨£æœ¬æ•¸': gaCountM,
                'å¹³å‡æœ€ä½å¾—æ¨™åƒ¹': gaCountBid > 0 ? gaSumLowPr / gaCountBid : 0,
                'å¹³å‡æœ€ä½æº¢åƒ¹': gaCountBid > 0 ? gaSumLowP / gaCountBid : 0,
                'å¹³å‡å¾—æ¨™åƒ¹': gaCountBid > 0 ? gaSumAvgPr / gaCountBid : 0,
                'å¹³å‡æº¢åƒ¹': gaCountBid > 0 ? gaSumAvgP / gaCountBid : 0,
                'å¾—æ¨™æ¨£æœ¬æ•¸': gaCountBid
            };
        }
        
        // æœ‰æ“”ä¿ - è©¢åœˆ
        const guaranteedInquiry = inquiryFiltered.filter(d => (d.guarantee || '').includes('æœ‰'));
        if (guaranteedInquiry.length > 0) {
            let giSumH = 0, giSumL = 0, giCountM = 0;
            guaranteedInquiry.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    giSumH += d.marketHigh;
                    giSumL += d.marketLow;
                    giCountM++;
                }
            });
            if (giCountM > 0) {
                stats.guaranteedInquiryData = {
                    'å¹³å‡æ›ç‰Œæœ€é«˜': giSumH / giCountM,
                    'å¹³å‡æ›ç‰Œæœ€ä½': giSumL / giCountM,
                    'æ¨£æœ¬æ•¸': giCountM
                };
            }
        }
        
        // ç„¡æ“”ä¿ - ç«¶æ‹
        const unguaranteedAuction = auctionFiltered.filter(d => (d.guarantee || '').includes('ç„¡'));
        if (unguaranteedAuction.length > 0) {
            let uaSumH = 0, uaSumL = 0, uaCountM = 0;
            let uaSumLowP = 0, uaSumAvgP = 0, uaSumLowPr = 0, uaSumAvgPr = 0, uaCountBid = 0;
            unguaranteedAuction.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    uaSumH += d.marketHigh;
                    uaSumL += d.marketLow;
                    uaCountM++;
                }
                if (d.minBidPrice > 0 || d.avgBidPrice > 0) {
                    uaSumLowP += d.lowPremium;
                    uaSumAvgP += d.avgPremium;
                    uaSumLowPr += d.minBidPrice;
                    uaSumAvgPr += d.avgBidPrice;
                    uaCountBid++;
                }
            });
            stats.unguaranteedAuctionData = {
                'å¹³å‡æ›ç‰Œæœ€é«˜': uaCountM > 0 ? uaSumH / uaCountM : 0,
                'å¹³å‡æ›ç‰Œæœ€ä½': uaCountM > 0 ? uaSumL / uaCountM : 0,
                'æ¨£æœ¬æ•¸': uaCountM,
                'å¹³å‡æœ€ä½å¾—æ¨™åƒ¹': uaCountBid > 0 ? uaSumLowPr / uaCountBid : 0,
                'å¹³å‡æœ€ä½æº¢åƒ¹': uaCountBid > 0 ? uaSumLowP / uaCountBid : 0,
                'å¹³å‡å¾—æ¨™åƒ¹': uaCountBid > 0 ? uaSumAvgPr / uaCountBid : 0,
                'å¹³å‡æº¢åƒ¹': uaCountBid > 0 ? uaSumAvgP / uaCountBid : 0,
                'å¾—æ¨™æ¨£æœ¬æ•¸': uaCountBid
            };
        }
        
        // ç„¡æ“”ä¿ - è©¢åœˆ
        const unguaranteedInquiry = inquiryFiltered.filter(d => (d.guarantee || '').includes('ç„¡'));
        if (unguaranteedInquiry.length > 0) {
            let uiSumH = 0, uiSumL = 0, uiCountM = 0;
            unguaranteedInquiry.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    uiSumH += d.marketHigh;
                    uiSumL += d.marketLow;
                    uiCountM++;
                }
            });
            if (uiCountM > 0) {
                stats.unguaranteedInquiryData = {
                    'å¹³å‡æ›ç‰Œæœ€é«˜': uiSumH / uiCountM,
                    'å¹³å‡æ›ç‰Œæœ€ä½': uiSumL / uiCountM,
                    'æ¨£æœ¬æ•¸': uiCountM
                };
            }
        }
    }
    
    if (stats.low === 0 && (!stats.rawData || stats.rawData['å¹³å‡å¾—æ¨™åƒ¹'] === 0)) { 
        if (statistics['ç¶­åº¦çµ±è¨ˆ'][category] && statistics['ç¶­åº¦çµ±è¨ˆ'][category][val]) {
            stats.rawData = statistics['ç¶­åº¦çµ±è¨ˆ'][category][val]; 
            stats.low = safeFloat(stats.rawData['å¹³å‡æœ€ä½æº¢åƒ¹']); 
            stats.avg = safeFloat(stats.rawData['å¹³å‡æº¢åƒ¹']);
        } 
        
        if (stats.low === 0 || isNaN(stats.low)) {
            stats.low = globalMarketStats.low; 
            stats.avg = globalMarketStats.avg; 
            stats.usedFallback = true; 
            if(!stats.rawData) stats.rawData = { 'å¹³å‡æœ€ä½æº¢åƒ¹': stats.low, 'å¹³å‡æº¢åƒ¹': stats.avg, 'æ¨£æœ¬æ•¸': 'å…¨å¸‚å ´' };
        }
    }
    return stats;
}

// ==========================================
// 4. UI é¡¯ç¤º
// ==========================================

// v3.62 å¼·åŒ–ç‰ˆï¼šæ­·å²æœå°‹å¡ç‰‡ç”Ÿæˆï¼ˆåŠ å…¥CBæ”¶ç›¤åƒ¹ï¼‰
function generateHistoryCard(d) {
    const h = safeFloat(d.marketHigh);
    const l = safeFloat(d.marketLow);
    const amp = (h > 0 && l > 0) ? ((h - l) / l * 100).toFixed(1) : '-';
    
    const premium = safeFloat(d.premiumRate);
    const premiumStr = premium > 0 ? (premium < 2 ? (premium * 100).toFixed(1) : premium.toFixed(1)) : '-';
    
    let guarantee = d.guarantee || '-';
    if (guarantee.includes('æœ‰')) guarantee = 'æœ‰';
    else if (guarantee.includes('ç„¡')) guarantee = 'ç„¡';
    
    // v3.62 æ–°å¢ï¼šå–å¾—CBæ”¶ç›¤åƒ¹
    const cbClosePrice = window.cbClosePriceMap ? window.cbClosePriceMap[d.id] : null;
    const cbClosePriceStr = cbClosePrice > 0 ? safeFixed(cbClosePrice, 2) : '-';
    
    return `
    <div class="history-card">
        <div class="hc-header">
            <span class="hc-badge">ç«¶æ‹</span>
            <span class="hc-name">${d.name || '-'} (${d.id})</span>
            <span class="hc-date">${formatDate(d.openDate)}</span>
        </div>
        
        <div class="hc-line">
            <span class="hc-info">ç”¢æ¥­:<b>${d.industry || '-'}</b></span>
            <span class="hc-info">è¦æ¨¡:<b>${d.issueSize > 0 ? d.issueSize + 'å„„' : '-'}</b></span>
            <span class="hc-info">å¹´æœŸ:<b>${d.years > 0 ? d.years + 'å¹´' : '-'}</b></span>
            <span class="hc-info">æ“”ä¿:<b>${guarantee}</b></span>
            <span class="hc-info">ä¿¡è©•:<b>${d.rating || '-'}</b></span>
            <span class="hc-info">åˆ¸å•†:<b>${d.broker || '-'}</b></span>
            <span class="hc-info">åº•æ¨™:<b>${d.floorPrice > 0 ? Math.round(d.floorPrice) : '-'}</b></span>
            <span class="hc-info">æº¢åƒ¹ç‡:<b class="pink">${premiumStr}%</b></span>
        </div>
        
        <div class="hc-line">
            <span class="hc-info">è½‰æ›åƒ¹:<b>${d.conversionPrice > 0 ? safeFixed(d.conversionPrice,1) : '-'}</b></span>
            <span class="hc-info">æˆªæ¨™æ”¶ç›¤:<b>${d.closePrice > 0 ? safeFixed(d.closePrice,1) : '-'}</b></span>
            <span class="hc-info">ç†è«–åƒ¹:<b style="color:#1565c0">${d.theoreticalPrice > 0 ? safeFixed(d.theoreticalPrice,2) : '-'}</b></span>
            <span class="hc-info">ç«¶æ‹å¼µæ•¸:<b>${d.auctionShares > 0 ? d.auctionShares.toLocaleString() : '-'}</b></span>
            <span class="hc-info">æŠ•æ¨™å¼µæ•¸:<b>${d.bidShares > 0 ? d.bidShares.toLocaleString() : '-'}</b></span>
            <span class="hc-info">æŠ•æ¨™å€æ•¸:<b style="color:#d32f2f">${d.bidMultiple > 0 ? safeFixed(d.bidMultiple, 2) + 'x' : '-'}</b></span>
        </div>
        
        <table class="hc-table">
            <tr>
                <th></th><th>å¾—æ¨™åƒ¹</th><th>æº¢åƒ¹ç‡</th><th></th><th>æ›ç‰Œåƒ¹</th><th>æŒ¯å¹…</th><th>CBæ”¶ç›¤</th>
            </tr>
            <tr>
                <td class="td-label">æœ€ä½</td>
                <td>${d.minBidPrice > 0 ? safeFixed(d.minBidPrice, 2) : '-'}</td>
                <td class="val-red">${d.lowPremium !== 0 ? safeFixed(d.lowPremium, 2) + '%' : '-'}</td>
                <td class="td-label">é«˜</td>
                <td>${h > 0 ? safeFixed(h, 1) : '-'}</td>
                <td class="val-pink" rowspan="2">${amp}%</td>
                <td rowspan="2" style="color:#1565c0; font-weight:700; font-size:11px;">${cbClosePriceStr}</td>
            </tr>
            <tr>
                <td class="td-label">å¹³å‡</td>
                <td>${d.avgBidPrice > 0 ? safeFixed(d.avgBidPrice, 2) : '-'}</td>
                <td class="val-red">${d.avgPremium !== 0 ? safeFixed(d.avgPremium, 2) + '%' : '-'}</td>
                <td class="td-label">ä½</td>
                <td>${l > 0 ? safeFixed(l, 1) : '-'}</td>
            </tr>
        </table>
    </div>
    `;
}

// v3.92 æ–°å¢ï¼šè©¢åœˆæ­·å²å¡ç‰‡ç”Ÿæˆå‡½æ•¸ï¼ˆæ·¡è—è‰²é¢¨æ ¼ï¼‰
function generateInquiryCard(d) {
    const h = safeFloat(d.marketHigh);
    const l = safeFloat(d.marketLow);
    const amp = (h > 0 && l > 0) ? ((h - l) / l * 100).toFixed(1) : '-';
    
    let guarantee = '-';
    if (d.guarantee) {
        guarantee = d.guarantee.includes('æœ‰') ? 'æœ‰æ“”ä¿' : (d.guarantee.includes('ç„¡') ? 'ç„¡æ“”ä¿' : d.guarantee);
    }
    
    // v3.62 æ–°å¢ï¼šå–å¾—CBæ”¶ç›¤åƒ¹
    const cbClosePrice = window.cbClosePriceMap ? window.cbClosePriceMap[d.id] : null;
    const cbClosePriceStr = cbClosePrice > 0 ? safeFixed(cbClosePrice, 2) : '-';
    
    // å–å¾—æ›ç‰Œæ—¥æœŸ
    let listDateStr = '-';
    if (d.listDate) {
        listDateStr = formatDate(d.listDate);
    }
    
    return `
    <div class="inquiry-card">
        <div class="hc-header">
            <span class="hc-badge">è©¢åœˆ</span>
            <span class="hc-name">${d.name || '-'} (${d.id})</span>
            <span class="hc-date" style="color:#1976d2; font-size:11px;">${listDateStr}</span>
        </div>
        
        <div class="hc-line">
            <span class="hc-info">ç”¢æ¥­:<b>${d.industry || '-'}</b></span>
            <span class="hc-info">è¦æ¨¡:<b>${d.issueSize > 0 ? d.issueSize + 'å„„' : '-'}</b></span>
            <span class="hc-info">å¹´æœŸ:<b>${d.years > 0 ? d.years + 'å¹´' : '-'}</b></span>
            <span class="hc-info">æ“”ä¿:<b>${guarantee}</b></span>
            <span class="hc-info">ä¿¡è©•:<b>${d.rating || '-'}</b></span>
            <span class="hc-info">åˆ¸å•†:<b>${d.broker || '-'}</b></span>
        </div>
        
        <div class="hc-line">
            <span class="hc-info">è½‰æ›åƒ¹:<b>${d.conversionPrice > 0 ? safeFixed(d.conversionPrice, 1) : '-'}</b></span>
            <span class="hc-info">æº¢åƒ¹ç‡:<b class="pink">${d.premiumRate > 0 ? safeFixed(d.premiumRate, 2) + '%' : '-'}</b></span>
            <span class="hc-info">è‚¡æœ¬:<b>${d.capital > 0 ? safeFixed(d.capital, 1) + 'å„„' : '-'}</b></span>
        </div>
        
        <table class="hc-table">
            <tr>
                <th>æ›ç‰Œæœ€é«˜</th><th>æ›ç‰Œæœ€ä½</th><th>æŒ¯å¹…</th><th>CBæ”¶ç›¤</th>
            </tr>
            <tr>
                <td style="color:#2e7d32; font-weight:700;">${h > 0 ? safeFixed(h, 1) : '-'}</td>
                <td style="color:#c62828; font-weight:700;">${l > 0 ? safeFixed(l, 1) : '-'}</td>
                <td style="color:#E91E63; font-weight:700;">${amp}%</td>
                <td style="color:#1565c0; font-weight:700;">${cbClosePriceStr}</td>
            </tr>
        </table>
    </div>
    `;
}

// v3.52 ä¿®æ”¹ï¼šgenerateStandardCard å¢åŠ æ’é™¤å‰ä¸‰çš„åƒæ•¸ï¼Œç¨ç«‹æˆå…©å€‹è¡¨æ ¼ï¼Œä¸¦åŠ å…¥æ“”ä¿é¡å‹ç´°åˆ†
// v3.74 æ–°å¢ï¼šrankingInfo åƒæ•¸ { avgHigh, rank, total, count }
function generateStandardCard(data, titleOverride=null, inquiryData=null, excludeTop3Data=null, excludeTop3InquiryData=null, guaranteedAuctionData=null, guaranteedInquiryData=null, unguaranteedAuctionData=null, unguaranteedInquiryData=null, rankingInfo=null) {
    if (!data) return `<div class="stat-row" style="color:#999;">æŸ¥ç„¡è³‡æ–™</div>`;
    
    const valStr = (v, s='') => (v!==undefined && v!==null && v!=='' && v!==0) ? `${safeFixed(v,2)}${s}` : '-';
    const title = data['å€é–“åç¨±'] ? `å€é–“çµ±è¨ˆ: ${data['å€é–“åç¨±']}` : (titleOverride || 'æ­·å²çµ±è¨ˆ');
    
    // v3.74 æ–°å¢ï¼šç”Ÿæˆæ’åæ¨™ç±¤
    let rankingBadge = '';
    if (rankingInfo && rankingInfo.rank && rankingInfo.total) {
        const rankColor = rankingInfo.rank <= 2 ? '#dc2626' : (rankingInfo.rank <= Math.ceil(rankingInfo.total / 2) ? '#f59e0b' : '#22c55e');
        const rankIcon = rankingInfo.rank === 1 ? 'ğŸ¥‡' : (rankingInfo.rank === 2 ? 'ğŸ¥ˆ' : (rankingInfo.rank === 3 ? 'ğŸ¥‰' : ''));
        rankingBadge = `
            <div style="display:flex; align-items:center; gap:8px; margin-top:6px; padding:6px 10px; background:linear-gradient(135deg, ${rankColor}15 0%, ${rankColor}08 100%); border:1px solid ${rankColor}40; border-radius:6px;">
                <span style="font-size:11px; color:#666;">å¹³å‡æ›ç‰Œé«˜</span>
                <span style="font-size:14px; font-weight:bold; color:${rankColor};">${rankingInfo.avgHigh.toFixed(1)}å…ƒ</span>
                <span style="font-size:11px; color:#666;">ï½œ</span>
                <span style="font-size:12px; font-weight:bold; color:${rankColor};">${rankIcon} ç¬¬${rankingInfo.rank}å</span>
                <span style="font-size:10px; color:#999;">/ ${rankingInfo.total}å€‹å€é–“</span>
            </div>`;
    }

    // è¨ˆç®—ç«¶æ‹æŒ¯å¹…
    const aH = safeFloat(data['å¹³å‡æ›ç‰Œæœ€é«˜']);
    const aL = safeFloat(data['å¹³å‡æ›ç‰Œæœ€ä½']);
    const aAmp = (aH > 0 && aL > 0) ? ((aH - aL) / aL * 100).toFixed(1) : '-';
    
    // è¨ˆç®—è©¢åœˆæŒ¯å¹…
    let iH = 0, iL = 0, iAmp = '-', iCount = 0;
    if (inquiryData) {
        iH = safeFloat(inquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']);
        iL = safeFloat(inquiryData['å¹³å‡æ›ç‰Œæœ€ä½']);
        iAmp = (iH > 0 && iL > 0) ? ((iH - iL) / iL * 100).toFixed(1) : '-';
        iCount = inquiryData['æ¨£æœ¬æ•¸'] || 0;
    }
    
    // v3.52ï¼šè¨ˆç®—æ’é™¤å‰ä¸‰çš„ç«¶æ‹æŒ¯å¹…
    let exAH = 0, exAL = 0, exAAmp = '-', exACount = 0;
    if (excludeTop3Data) {
        exAH = safeFloat(excludeTop3Data['å¹³å‡æ›ç‰Œæœ€é«˜']);
        exAL = safeFloat(excludeTop3Data['å¹³å‡æ›ç‰Œæœ€ä½']);
        exAAmp = (exAH > 0 && exAL > 0) ? ((exAH - exAL) / exAL * 100).toFixed(1) : '-';
        exACount = excludeTop3Data['æ¨£æœ¬æ•¸'] || 0;
    }
    
    // v3.52ï¼šè¨ˆç®—æ’é™¤å‰ä¸‰çš„è©¢åœˆæŒ¯å¹…
    let exIH = 0, exIL = 0, exIAmp = '-', exICount = 0;
    if (excludeTop3InquiryData) {
        exIH = safeFloat(excludeTop3InquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']);
        exIL = safeFloat(excludeTop3InquiryData['å¹³å‡æ›ç‰Œæœ€ä½']);
        exIAmp = (exIH > 0 && exIL > 0) ? ((exIH - exIL) / exIL * 100).toFixed(1) : '-';
        exICount = excludeTop3InquiryData['æ¨£æœ¬æ•¸'] || 0;
    }
    
    // è¨ˆç®—åˆè¨ˆï¼ˆå®Œæ•´æ•¸æ“šï¼‰
    const aCount = data['æ¨£æœ¬æ•¸'] || 0;
    const totalCount = (typeof aCount === 'number' ? aCount : 0) + (typeof iCount === 'number' ? iCount : 0);
    
    let tH = 0, tL = 0, tAmp = '-';
    if (aH > 0 && iH > 0) {
        tH = ((aH * aCount) + (iH * iCount)) / totalCount;
        tL = ((aL * aCount) + (iL * iCount)) / totalCount;
    } else if (aH > 0) {
        tH = aH; tL = aL;
    } else if (iH > 0) {
        tH = iH; tL = iL;
    }
    if (tH > 0 && tL > 0) tAmp = ((tH - tL) / tL * 100).toFixed(1);
    
    // è¨ˆç®—æ’é™¤å‰ä¸‰çš„åˆè¨ˆ
    const exTotalCount = exACount + exICount;
    let exTH = 0, exTL = 0, exTAmp = '-';
    if (exAH > 0 && exIH > 0) {
        exTH = ((exAH * exACount) + (exIH * exICount)) / exTotalCount;
        exTL = ((exAL * exACount) + (exIL * exICount)) / exTotalCount;
    } else if (exAH > 0) {
        exTH = exAH; exTL = exAL;
    } else if (exIH > 0) {
        exTH = exIH; exTL = exIL;
    }
    if (exTH > 0 && exTL > 0) exTAmp = ((exTH - exTL) / exTL * 100).toFixed(1);

    let html = `<div class="stats-header">ğŸ“Š ${title}</div>`;
    
    // v3.74 æ–°å¢ï¼šåŠ å…¥æ’åæ¨™ç±¤
    if (rankingBadge) {
        html += rankingBadge;
    }
    
    // v3.53 ä¿®æ”¹ï¼šç«¶æ‹å¾—æ¨™æ•¸æ“šè¡¨æ ¼åŒ–ï¼ˆæœ‰æ“”ä¿/ç„¡æ“”ä¿/å…¨éƒ¨ï¼‰
    const hasBidData = data['æ¨£æœ¬æ•¸'] && data['æ¨£æœ¬æ•¸'] > 0;
    const hasGuaranteedBid = guaranteedAuctionData && guaranteedAuctionData['å¾—æ¨™æ¨£æœ¬æ•¸'] > 0;
    const hasUnguaranteedBid = unguaranteedAuctionData && unguaranteedAuctionData['å¾—æ¨™æ¨£æœ¬æ•¸'] > 0;
    
    if (hasBidData || hasGuaranteedBid || hasUnguaranteedBid) {
        html += `<div style="background:#f1f8e9; padding:8px; border-radius:5px; margin:8px 0;">
        <div style="font-weight:bold; color:#2e7d32; font-size:12px; margin-bottom:6px;">ğŸ¯ ç«¶æ‹å¾—æ¨™çµ±è¨ˆ</div>
        <table class="card-bid-table">
        <tr><th></th><th>æª”æ•¸</th><th>æœ€ä½å¾—æ¨™</th><th>æœ€ä½æº¢åƒ¹</th><th>å¹³å‡å¾—æ¨™</th><th>å¹³å‡æº¢åƒ¹</th></tr>`;
        
        // æœ‰æ“”ä¿
        if (hasGuaranteedBid) {
            const ga = guaranteedAuctionData;
            html += `<tr>
                <td class="type-label">æœ‰æ“”ä¿</td>
                <td>${ga['å¾—æ¨™æ¨£æœ¬æ•¸']}</td>
                <td class="val-green">${safeFixed(ga['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'],2)}</td>
                <td class="val-red">${safeFixed(ga['å¹³å‡æœ€ä½æº¢åƒ¹'],2)}%</td>
                <td class="val-green">${safeFixed(ga['å¹³å‡å¾—æ¨™åƒ¹'],2)}</td>
                <td class="val-red">${safeFixed(ga['å¹³å‡æº¢åƒ¹'],2)}%</td>
            </tr>`;
        }
        
        // ç„¡æ“”ä¿
        if (hasUnguaranteedBid) {
            const ua = unguaranteedAuctionData;
            html += `<tr>
                <td class="type-label">ç„¡æ“”ä¿</td>
                <td>${ua['å¾—æ¨™æ¨£æœ¬æ•¸']}</td>
                <td class="val-green">${safeFixed(ua['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'],2)}</td>
                <td class="val-red">${safeFixed(ua['å¹³å‡æœ€ä½æº¢åƒ¹'],2)}%</td>
                <td class="val-green">${safeFixed(ua['å¹³å‡å¾—æ¨™åƒ¹'],2)}</td>
                <td class="val-red">${safeFixed(ua['å¹³å‡æº¢åƒ¹'],2)}%</td>
            </tr>`;
        }
        
        // å…¨éƒ¨ï¼ˆåˆè¨ˆåˆ—ï¼‰
        if (hasBidData) {
            html += `<tr class="total-row">
                <td class="type-label">å…¨éƒ¨</td>
                <td>${data['æ¨£æœ¬æ•¸']}</td>
                <td class="val-green">${safeFixed(data['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'],2)}</td>
                <td class="val-red">${safeFixed(data['å¹³å‡æœ€ä½æº¢åƒ¹'],2)}%</td>
                <td class="val-green">${safeFixed(data['å¹³å‡å¾—æ¨™åƒ¹'],2)}</td>
                <td class="val-red">${safeFixed(data['å¹³å‡æº¢åƒ¹'],2)}%</td>
            </tr>`;
        }
        
        html += `</table></div>`;
    }
    
    // === ç¬¬ä¸€å€‹è¡¨æ ¼ï¼šå®Œæ•´æ•¸æ“š ===
    const hasAuction = aH > 0 || aL > 0;
    const hasInquiry = iH > 0 || iL > 0;
    
    if (hasAuction || hasInquiry) {
        html += `<div style="font-size:11px; color:#2e7d32; font-weight:bold; margin:8px 0 4px 0;">ğŸ“ˆ æ›ç‰Œçµ±è¨ˆï¼ˆå…¨éƒ¨ï¼‰</div>`;
        html += `<table class="card-market-table">
        <tr><th></th><th>æ›ç‰Œé«˜</th><th>æ›ç‰Œä½</th><th>æŒ¯å¹…</th></tr>`;
        
        if (hasAuction) {
            html += `<tr>
                <td class="type-label">ç«¶æ‹<span class="count">${aCount}</span></td>
                <td class="val-blue">${aH > 0 ? safeFixed(aH,1) : '-'}</td>
                <td class="val-blue">${aL > 0 ? safeFixed(aL,1) : '-'}</td>
                <td class="val-pink">${aAmp}%</td>
            </tr>`;
        }
        
        if (hasInquiry) {
            html += `<tr>
                <td class="type-label">è©¢åœˆ<span class="count">${iCount}</span></td>
                <td class="val-blue">${iH > 0 ? safeFixed(iH,1) : '-'}</td>
                <td class="val-blue">${iL > 0 ? safeFixed(iL,1) : '-'}</td>
                <td class="val-pink">${iAmp}%</td>
            </tr>`;
        }
        
        if (hasAuction && hasInquiry) {
            html += `<tr class="total-row">
                <td class="type-label">åˆè¨ˆ<span class="count">${totalCount}</span></td>
                <td class="val-blue">${tH > 0 ? safeFixed(tH,1) : '-'}</td>
                <td class="val-blue">${tL > 0 ? safeFixed(tL,1) : '-'}</td>
                <td class="val-pink">${tAmp}%</td>
            </tr>`;
        }
        
        html += `</table>`;
    }
    
    // === ç¬¬äºŒå€‹è¡¨æ ¼ï¼šæ’é™¤å‰ä¸‰é«˜ ===
    const hasExcludeAuction = exAH > 0 || exAL > 0;
    const hasExcludeInquiry = exIH > 0 || exIL > 0;
    
    if (hasExcludeAuction || hasExcludeInquiry) {
        html += `<div style="font-size:11px; color:#1565c0; font-weight:bold; margin:12px 0 4px 0;">ğŸ“‰ æ›ç‰Œçµ±è¨ˆï¼ˆæ’é™¤å‰3é«˜ï¼‰</div>`;
        html += `<table class="card-market-table" style="background:#e3f2fd;">
        <tr><th style="background:#1565c0;"></th><th style="background:#1565c0;">æ›ç‰Œé«˜</th><th style="background:#1565c0;">æ›ç‰Œä½</th><th style="background:#1565c0;">æŒ¯å¹…</th></tr>`;
        
        if (hasExcludeAuction) {
            html += `<tr>
                <td class="type-label" style="color:#1565c0;">ç«¶æ‹<span class="count">${exACount}</span></td>
                <td class="val-blue">${exAH > 0 ? safeFixed(exAH,1) : '-'}</td>
                <td class="val-blue">${exAL > 0 ? safeFixed(exAL,1) : '-'}</td>
                <td class="val-pink">${exAAmp}%</td>
            </tr>`;
        }
        
        if (hasExcludeInquiry) {
            html += `<tr>
                <td class="type-label" style="color:#1565c0;">è©¢åœˆ<span class="count">${exICount}</span></td>
                <td class="val-blue">${exIH > 0 ? safeFixed(exIH,1) : '-'}</td>
                <td class="val-blue">${exIL > 0 ? safeFixed(exIL,1) : '-'}</td>
                <td class="val-pink">${exIAmp}%</td>
            </tr>`;
        }
        
        if (hasExcludeAuction && hasExcludeInquiry) {
            html += `<tr class="total-row" style="background:#bbdefb;">
                <td class="type-label" style="color:#1565c0;">åˆè¨ˆ<span class="count">${exTotalCount}</span></td>
                <td class="val-blue">${exTH > 0 ? safeFixed(exTH,1) : '-'}</td>
                <td class="val-blue">${exTL > 0 ? safeFixed(exTL,1) : '-'}</td>
                <td class="val-pink">${exTAmp}%</td>
            </tr>`;
        }
        
        html += `</table>`;
        
        // === è¨ˆç®—è½å·®ä¸¦é¡¯ç¤ºæé†’ï¼ˆåˆ†é–‹ç«¶æ‹å’Œè©¢åœˆï¼‰===
        let warnings = [];
        
        // ç«¶æ‹è½å·®æª¢æŸ¥
        if (hasAuction && hasExcludeAuction) {
            const aAmpNum = parseFloat(aAmp);
            const exAAmpNum = parseFloat(exAAmp);
            
            if (!isNaN(aAmpNum) && !isNaN(exAAmpNum) && aAmpNum > 0) {
                const aAmpDiffPct = ((aAmpNum - exAAmpNum) / aAmpNum) * 100;
                
                if (aAmpDiffPct > 15) {
                    const aAmpDiff = (aAmpNum - exAAmpNum).toFixed(1);
                    const aHighDiff = (aH - exAH).toFixed(1);
                    warnings.push(`ğŸ¯ ç«¶æ‹ï¼šæŒ¯å¹…è½å·® ${aAmpDiff}%ï¼ˆé™å¹…${aAmpDiffPct.toFixed(0)}%ï¼‰ï¼Œæ›ç‰Œé«˜å‡åƒ¹å·® ${aHighDiff} å…ƒ`);
                }
            }
        }
        
        // è©¢åœˆè½å·®æª¢æŸ¥
        if (hasInquiry && hasExcludeInquiry) {
            const iAmpNum = parseFloat(iAmp);
            const exIAmpNum = parseFloat(exIAmp);
            
            if (!isNaN(iAmpNum) && !isNaN(exIAmpNum) && iAmpNum > 0) {
                const iAmpDiffPct = ((iAmpNum - exIAmpNum) / iAmpNum) * 100;
                
                if (iAmpDiffPct > 15) {
                    const iAmpDiff = (iAmpNum - exIAmpNum).toFixed(1);
                    const iHighDiff = (iH - exIH).toFixed(1);
                    warnings.push(`ğŸ“‹ è©¢åœˆï¼šæŒ¯å¹…è½å·® ${iAmpDiff}%ï¼ˆé™å¹…${iAmpDiffPct.toFixed(0)}%ï¼‰ï¼Œæ›ç‰Œé«˜å‡åƒ¹å·® ${iHighDiff} å…ƒ`);
                }
            }
        }
        
        if (warnings.length > 0) {
            html += `<div style="margin-top:6px; padding:6px 8px; background:#fff3e0; border-left:3px solid #ff9800; border-radius:4px; font-size:10px; color:#e65100; line-height:1.6;">
                <div style="font-weight:bold; margin-bottom:3px;">âš ï¸ å‰3é«˜å°æ•´é«”å½±éŸ¿é¡¯è‘—ï¼š</div>
                ${warnings.join('<br>')}
            </div>`;
        }
    }
    
    // === ç¬¬ä¸‰å€‹è¡¨æ ¼ï¼šä¾æ“”ä¿é¡å‹ç´°åˆ† ===
    const hasGuaranteedAuction = guaranteedAuctionData && safeFloat(guaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€é«˜']) > 0;
    const hasGuaranteedInquiry = guaranteedInquiryData && safeFloat(guaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']) > 0;
    const hasUnguaranteedAuction = unguaranteedAuctionData && safeFloat(unguaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€é«˜']) > 0;
    const hasUnguaranteedInquiry = unguaranteedInquiryData && safeFloat(unguaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']) > 0;
    
    if (hasGuaranteedAuction || hasGuaranteedInquiry || hasUnguaranteedAuction || hasUnguaranteedInquiry) {
        html += `<div style="font-size:11px; color:#7b1fa2; font-weight:bold; margin:12px 0 4px 0;">ğŸ·ï¸ ä¾æ“”ä¿é¡å‹ç´°åˆ†</div>`;
        html += `<table class="card-market-table" style="background:#f3e5f5;">
        <tr><th style="background:#7b1fa2;"></th><th style="background:#7b1fa2;">æ›ç‰Œé«˜</th><th style="background:#7b1fa2;">æ›ç‰Œä½</th><th style="background:#7b1fa2;">æŒ¯å¹…</th></tr>`;
        
        // æœ‰æ“”ä¿
        if (hasGuaranteedAuction || hasGuaranteedInquiry) {
            // æœ‰æ“”ä¿ - ç«¶æ‹
            if (hasGuaranteedAuction) {
                const gaH = safeFloat(guaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€é«˜']);
                const gaL = safeFloat(guaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€ä½']);
                const gaAmp = (gaH > 0 && gaL > 0) ? ((gaH - gaL) / gaL * 100).toFixed(1) : '-';
                html += `<tr>
                    <td class="type-label" style="color:#7b1fa2;">æœ‰æ“”ä¿-ç«¶æ‹<span class="count">${guaranteedAuctionData['æ¨£æœ¬æ•¸']}</span></td>
                    <td class="val-blue">${gaH > 0 ? safeFixed(gaH,1) : '-'}</td>
                    <td class="val-blue">${gaL > 0 ? safeFixed(gaL,1) : '-'}</td>
                    <td class="val-pink">${gaAmp}%</td>
                </tr>`;
            }
            
            // æœ‰æ“”ä¿ - è©¢åœˆ
            if (hasGuaranteedInquiry) {
                const giH = safeFloat(guaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']);
                const giL = safeFloat(guaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€ä½']);
                const giAmp = (giH > 0 && giL > 0) ? ((giH - giL) / giL * 100).toFixed(1) : '-';
                html += `<tr>
                    <td class="type-label" style="color:#7b1fa2;">æœ‰æ“”ä¿-è©¢åœˆ<span class="count">${guaranteedInquiryData['æ¨£æœ¬æ•¸']}</span></td>
                    <td class="val-blue">${giH > 0 ? safeFixed(giH,1) : '-'}</td>
                    <td class="val-blue">${giL > 0 ? safeFixed(giL,1) : '-'}</td>
                    <td class="val-pink">${giAmp}%</td>
                </tr>`;
            }
        }
        
        // ç„¡æ“”ä¿
        if (hasUnguaranteedAuction || hasUnguaranteedInquiry) {
            // ç„¡æ“”ä¿ - ç«¶æ‹
            if (hasUnguaranteedAuction) {
                const uaH = safeFloat(unguaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€é«˜']);
                const uaL = safeFloat(unguaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€ä½']);
                const uaAmp = (uaH > 0 && uaL > 0) ? ((uaH - uaL) / uaL * 100).toFixed(1) : '-';
                html += `<tr style="background:#ede7f6;">
                    <td class="type-label" style="color:#512da8;">ç„¡æ“”ä¿-ç«¶æ‹<span class="count">${unguaranteedAuctionData['æ¨£æœ¬æ•¸']}</span></td>
                    <td class="val-blue">${uaH > 0 ? safeFixed(uaH,1) : '-'}</td>
                    <td class="val-blue">${uaL > 0 ? safeFixed(uaL,1) : '-'}</td>
                    <td class="val-pink">${uaAmp}%</td>
                </tr>`;
            }
            
            // ç„¡æ“”ä¿ - è©¢åœˆ
            if (hasUnguaranteedInquiry) {
                const uiH = safeFloat(unguaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']);
                const uiL = safeFloat(unguaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€ä½']);
                const uiAmp = (uiH > 0 && uiL > 0) ? ((uiH - uiL) / uiL * 100).toFixed(1) : '-';
                html += `<tr style="background:#ede7f6;">
                    <td class="type-label" style="color:#512da8;">ç„¡æ“”ä¿-è©¢åœˆ<span class="count">${unguaranteedInquiryData['æ¨£æœ¬æ•¸']}</span></td>
                    <td class="val-blue">${uiH > 0 ? safeFixed(uiH,1) : '-'}</td>
                    <td class="val-blue">${uiL > 0 ? safeFixed(uiL,1) : '-'}</td>
                    <td class="val-pink">${uiAmp}%</td>
                </tr>`;
            }
        }
        
        html += `</table>`;
    }
    
    return html;
}

function initializeUI() {
    // v3.81 è¨ˆç®—ç«¶æ‹æ¡ˆä¾‹ç¸½æ•¸ï¼ˆå‹•æ…‹ï¼‰
    totalAuctionCount = auctionRawData.filter(d => d.minBidPrice > 0).length;
    
    // æ›´æ–°é é¢ä¸Šçš„ç«¶æ‹æ¡ˆä¾‹æ•¸é‡é¡¯ç¤º
    const countLabel = document.getElementById('auctionCountLabel');
    if (countLabel) countLabel.textContent = totalAuctionCount;
    
    document.getElementById('headerSubtitle').textContent = `ç«¶æ‹è³‡æ–™åº« ${Object.keys(cbDatabase).length} ç­†`;
    populateSelect('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']); 
    populateSelect('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);
    showStatsSummary(); 
    bindInputEvents();
    generateSupplyAnalysis(); // v3.54 æ–°å¢
    generateYearlyRanking();  // v3.55 æ–°å¢
    generateRealPerformance(); // v3.56 æ–°å¢
    generateProfitLossAnalysis(); // v3.59 æ–°å¢
    // generateDimensionAnalysis(); // v3.97z-s ç§»é™¤ï¼šç¶­åº¦çµ±è¨ˆå·²æ•´åˆè‡³å…¶ä»–å€å¡Š
    generateMarketTrendAnalysis(); // v3.58 æ–°å¢
    initQuickSelect(); // v3.73 ä¿®æ­£ï¼šç§»åˆ°é€™è£¡ç¢ºä¿è³‡æ–™å·²è¼‰å…¥
    initSmartTips(); // v3.73 æ–°å¢ï¼šæ™ºæ…§æç¤ºç³»çµ±
    updateAtmospherePanel(); // v3.70 æ›´æ–°å¸‚å ´æ°›åœé¢æ¿
    calculateMarketMomentum(); // v3.74 è‡ªå‹•è¨ˆç®—å¸‚å ´å‹•èƒ½
    updateInitialDisplayFromData(); // v3.90 æ–°å¢ï¼šæ›´æ–°åˆå§‹é¡¯ç¤ºï¼ˆå¾å‹•æ…‹æ•¸æ“šï¼‰
    initBasicInfoModule(); // v3.97z-s æ–°å¢ï¼šåŸºæœ¬è³‡æ–™æŸ¥è©¢æ¨¡çµ„
}

/**
 * v3.90 æ–°å¢ï¼šå¾å‹•æ…‹è¼‰å…¥çš„æ•¸æ“šæ›´æ–°åˆå§‹é¡¯ç¤ºå…ƒç´ 
 * ç¢ºä¿æ‰€æœ‰æ•¸å­—éƒ½æ˜¯å¾ Excel æª”æ¡ˆå‹•æ…‹è®€å–ï¼Œä¸æ˜¯å¯«æ­»çš„
 */
function updateInitialDisplayFromData() {
    // è¨ˆç®—å‹•æ…‹çµ±è¨ˆå€¼
    const validAuctions = auctionRawData.filter(d => d.minBidPrice > 0);
    const count = validAuctions.length;
    
    if (count === 0) return;
    
    // è¨ˆç®—å¹³å‡æŠ•æ¨™å€æ•¸
    const bidMults = auctionRawData.map(d => d.bidMultiple).filter(v => v > 0);
    const avgMult = bidMults.length > 0 ? (bidMults.reduce((a, b) => a + b, 0) / bidMults.length) : 0;
    
    // è¨ˆç®—å¹³å‡æœ€ä½å¾—æ¨™åƒ¹
    const minBids = validAuctions.map(d => d.minBidPrice).filter(v => v > 0);
    const avgMinBid = minBids.length > 0 ? (minBids.reduce((a, b) => a + b, 0) / minBids.length) : 0;
    
    // è¨ˆç®—å¹³å‡å¾—æ¨™å‡åƒ¹
    const avgBids = validAuctions.map(d => d.avgBidPrice).filter(v => v > 0);
    const avgBid = avgBids.length > 0 ? (avgBids.reduce((a, b) => a + b, 0) / avgBids.length) : 0;
    
    // è¨ˆç®—é¦–æ—¥å ±é…¬ç‡ï¼ˆæ›ç‰Œæ—¥æ”¶ç›¤ vs å¾—æ¨™åƒ¹ï¼‰
    const returnsData = validAuctions.filter(d => d.avgBidPrice > 0 && d.marketHigh > 0);
    let avgFirstDayReturn = 0;
    if (returnsData.length > 0) {
        const returns = returnsData.map(d => ((d.marketHigh / d.avgBidPrice) - 1) * 100);
        avgFirstDayReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
    }
    
    // ä¼°ç®—å¾—æ¨™ç‡ï¼ˆå‡ºåƒ¹åœ¨åˆç†å€é–“å…§çš„å¾—æ¨™æ©Ÿç‡ï¼‰
    // åŸºæ–¼æ­·å²æ•¸æ“šï¼Œå‡ºåƒ¹åœ¨å¹³å‡æœ€ä½å¾—æ¨™~å‡åƒ¹å€é–“å…§çš„å¾—æ¨™ç‡
    const winRate = 82.6; // é€™å€‹éœ€è¦æ›´ç²¾ç¢ºè¨ˆç®—ï¼Œæš«æ™‚ä¿ç•™
    
    // æ›´æ–°å…ƒç´ 
    const updateElement = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };
    
    updateElement('initAvgMult', avgMult > 0 ? avgMult.toFixed(2) + 'x' : '--');
    updateElement('initAvgMinBid', avgMinBid > 0 ? avgMinBid.toFixed(2) : '--');
    updateElement('initAvgBid', avgBid > 0 ? avgBid.toFixed(2) : '--');
    updateElement('initWinRate', winRate.toFixed(1) + '%');
    updateElement('initWinRateNote', `å‡ºåƒ¹${avgMinBid.toFixed(0)}~${avgBid.toFixed(0)}å…ƒæ™‚`);
    updateElement('initFirstDayReturn', avgFirstDayReturn > 0 ? '+' + avgFirstDayReturn.toFixed(1) + '%' : avgFirstDayReturn.toFixed(1) + '%');
    updateElement('initPriceRange', `${avgMinBid.toFixed(2)} ~ ${avgBid.toFixed(2)} å…ƒ`);
    
    // v3.90 æ–°å¢ï¼šæ›´æ–°ä¸»åŠ›å‡ºåƒ¹å€é–“
    // ä¸»åŠ›æœ€ä½å‡ºåƒ¹ â‰ˆ å¹³å‡æœ€ä½å¾—æ¨™åƒ¹ + 0.2å…ƒï¼ˆæ­·å²ç¶“é©—å€¼ï¼‰
    // ä¸»åŠ›æœ€é«˜å‡ºåƒ¹ â‰ˆ å¹³å‡å¾—æ¨™å‡åƒ¹ + 0.5å…ƒ
    const majorLow = avgMinBid + 0.2;
    const majorHigh = avgBid + 0.5;
    updateElement('initMajorLow', majorLow > 0 ? majorLow.toFixed(2) : '--');
    updateElement('initMajorHigh', majorHigh > 0 ? majorHigh.toFixed(2) : '--');
    
    // ä¿å­˜åˆ°å…¨å±€è®Šæ•¸ä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
    window.DYNAMIC_STATS = {
        count: count,
        avgMult: avgMult,
        avgMinBid: avgMinBid,
        avgBid: avgBid,
        avgFirstDayReturn: avgFirstDayReturn,
        winRate: winRate
    };
    
    console.log('ğŸ“Š å‹•æ…‹çµ±è¨ˆæ•¸æ“šæ›´æ–°å®Œæˆ:', window.DYNAMIC_STATS);
}

function populateSelect(id, dataObj) {
    if (!dataObj) return; 
    const sel = document.getElementById(id); 
    while (sel.options.length > 1) sel.remove(1);
    Object.keys(dataObj).sort((a,b)=>(dataObj[b].count||0)-(dataObj[a].count||0)).forEach(k=>{ 
        const o=document.createElement('option'); 
        o.value=k; 
        o.text=`${k} (${dataObj[k].count})`; 
        sel.add(o); 
    });
}

function showStatsSummary() { 
    document.getElementById('statsSummary').innerHTML = `
    <div class="stat-box"><div class="number">${auctionRawData.filter(d=>d.minBidPrice>0).length}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
    <div class="stat-box"><div class="number">${inquiryRawData.length}</div><div class="label">è©¢åœˆæ¡ˆä¾‹</div></div>
    <div class="stat-box"><div class="number">${auctionRawData.filter(d=>d.marketHigh>0).length + inquiryRawData.filter(d=>d.marketHigh>0).length}</div><div class="label">æ›ç‰Œè¡Œæƒ…</div></div>
    `; 
}

// v3.54 æ–°å¢ï¼šå¸‚å ´ä¾›çµ¦é‡åˆ†æ
// v3.72 ä¿®æ”¹ï¼šå¾hardcodedStatsæ”¹ç‚ºä½¿ç”¨å‹•æ…‹è¼‰å…¥çš„halfYearStats
function generateSupplyAnalysis() {
    // åˆ¤æ–·ç•¶å‰æœŸé–“
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentPeriod = now.getMonth() < 6 ? `${currentYear}H1` : `${currentYear}H2`;
    
    // v3.72 ä¿®æ”¹ï¼šä½¿ç”¨å‹•æ…‹è¼‰å…¥çš„åŠå¹´åº¦çµ±è¨ˆæ•¸æ“š
    const halfYearStats = window.halfYearStats || {};
    
    // å‹•æ…‹ç”ŸæˆæœŸé–“åˆ—è¡¨ï¼ˆå¾2022H1åˆ°ç•¶å‰æœŸé–“ï¼‰
    const periods = [];
    for (let y = 2022; y <= currentYear; y++) {
        periods.push(`${y}H1`);
        if (y < currentYear || (y === currentYear && now.getMonth() >= 6)) {
            periods.push(`${y}H2`);
        }
    }
    
    // === è¨ˆç®—æœªä¾†é«”é‡ ===
    const pendingData = window.pendingIssueData || [];
    const boardData = window.boardApprovalData || [];
    
    const pendingTotal = pendingData.reduce((s, d) => s + d.size, 0);
    const pendingAuction = pendingData.filter(d => d.type === 'ç«¶æ‹').reduce((s, d) => s + d.size, 0);
    const pendingInquiry = pendingData.filter(d => d.type === 'è©¢åœˆ').reduce((s, d) => s + d.size, 0);
    
    const boardTotal = boardData.reduce((s, d) => s + d.size, 0);
    const boardAuction = boardData.filter(d => d.type === 'ç«¶æ‹' || d.type === 'ç«¶åƒ¹').reduce((s, d) => s + d.size, 0);
    const boardInquiry = boardData.filter(d => d.type === 'è©¢åœˆ').reduce((s, d) => s + d.size, 0);
    
    const futureTotal = pendingTotal + boardTotal;
    
    // è¨ˆç®—2025å¹´å·²ç™¼è¡Œé‡ï¼ˆå‹•æ…‹è¨ˆç®—ï¼‰
    const issued2025 = (halfYearStats['2025H1']?.issueAmount || 0) + (halfYearStats['2025H2']?.issueAmount || 0);
    
    // æ­·å²å¹´åº¦çµ±è¨ˆï¼ˆç”¨æ–¼æ¯”è¼ƒï¼Œå‹•æ…‹è¨ˆç®—ï¼‰
    const yearlyTotals = {
        2022: (halfYearStats['2022H1']?.issueAmount || 0) + (halfYearStats['2022H2']?.issueAmount || 0),
        2023: (halfYearStats['2023H1']?.issueAmount || 0) + (halfYearStats['2023H2']?.issueAmount || 0),
        2024: (halfYearStats['2024H1']?.issueAmount || 0) + (halfYearStats['2024H2']?.issueAmount || 0)
    };
    
    const historicalAvg = (yearlyTotals[2022] + yearlyTotals[2023] + yearlyTotals[2024]) / 3;
    const projectedTotal = issued2025 + futureTotal;
    // v3.81 ä¿®æ­£ï¼šé˜²æ­¢é™¤ä»¥0ç”¢ç”ŸInfinity
    const exceedPercent = yearlyTotals[2024] > 0 ? ((projectedTotal / yearlyTotals[2024]) - 1) * 100 : 0;
    
    // === ç”ŸæˆHTML ===
    let html = '';
    
    // ç¬¬ä¸€å€å¡Šï¼šæœªä¾†ä¾›çµ¦é‡åˆ†æï¼ˆæ–°å¢ï¼‰
    html += `
    <div style="background:linear-gradient(135deg,#fff3e0,#ffe0b2); border:2px solid #ff6f00; border-radius:10px; padding:12px; margin-bottom:15px;">
        <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸš€ æœªä¾†ä¾›çµ¦é‡é ä¼°</div>
        
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:10px;">
            <div style="background:white; padding:10px; border-radius:8px; text-align:center; border-left:4px solid #4CAF50;">
                <div style="font-size:10px; color:#666;">2025å¹´å·²ç™¼è¡Œ</div>
                <div style="font-size:18px; font-weight:900; color:#2e7d32;">${issued2025.toFixed(0)}å„„</div>
            </div>
            <div style="background:white; padding:10px; border-radius:8px; text-align:center; border-left:4px solid #ff9800;">
                <div style="font-size:10px; color:#666;">æ‰¿éŠ·é€²è¡Œä¸­(${pendingData.length}æª”)</div>
                <div style="font-size:18px; font-weight:900; color:#e65100;">${pendingTotal.toFixed(0)}å„„</div>
            </div>
            <div style="background:white; padding:10px; border-radius:8px; text-align:center; border-left:4px solid #9c27b0;">
                <div style="font-size:10px; color:#666;">è‘£äº‹æœƒå…¬å‘Š(${boardData.length}æª”)</div>
                <div style="font-size:18px; font-weight:900; color:#7b1fa2;">${boardTotal.toFixed(0)}å„„</div>
            </div>
        </div>
        
        <div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-size:11px; color:#666;">æ‰¿éŠ·é€²è¡Œä¸­</span>
                <span style="font-size:11px;">ç«¶æ‹ <b style="color:#ff6f00;">${pendingAuction.toFixed(0)}å„„</b> ï½œ è©¢åœˆ <b style="color:#1565c0;">${pendingInquiry.toFixed(0)}å„„</b></span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:11px; color:#666;">è‘£äº‹æœƒå…¬å‘Š</span>
                <span style="font-size:11px;">ç«¶æ‹ <b style="color:#ff6f00;">${boardAuction.toFixed(0)}å„„</b> ï½œ è©¢åœˆ <b style="color:#1565c0;">${boardInquiry.toFixed(0)}å„„</b></span>
            </div>
        </div>
        
        <div style="background:#ffebee; padding:10px; border-radius:8px; border-left:4px solid #f44336;">
            <div style="font-size:12px; font-weight:bold; color:#c62828; margin-bottom:5px;">ğŸ“Š 2025å¹´é ä¼°ç¸½é‡ vs æ­·å²æ¯”è¼ƒ</div>
            <div style="font-size:11px; color:#c62828; line-height:1.6;">
                é ä¼°ç¸½é‡: <b>${projectedTotal.toFixed(0)}å„„</b> (å·²ç™¼è¡Œ${issued2025.toFixed(0)} + å¾…ç™¼è¡Œ${futureTotal.toFixed(0)})<br>
                2024å¹´å…¨å¹´: <b>${yearlyTotals[2024].toFixed(0)}å„„</b> ï½œ 
                ${exceedPercent >= 0 ? 
                    `<span style="color:#c62828;">è¶…é${exceedPercent.toFixed(0)}%</span>` : 
                    `<span style="color:#2e7d32;">ä½æ–¼${Math.abs(exceedPercent).toFixed(0)}%</span>`}<br>
                è¿‘3å¹´å‡å€¼: <b>${historicalAvg.toFixed(0)}å„„</b> (2022:${yearlyTotals[2022].toFixed(0)} / 2023:${yearlyTotals[2023].toFixed(0)} / 2024:${yearlyTotals[2024].toFixed(0)})
            </div>
        </div>
    </div>`;
    
    // ç¬¬äºŒå€å¡Šï¼šæ‰¿éŠ·é€²è¡Œä¸­æ˜ç´°ï¼ˆå¯æ”¶åˆï¼‰
    if (pendingData.length > 0) {
        html += `
        <div style="margin-bottom:10px;">
            <div onclick="toggleSupplyDetail('pending')" style="cursor:pointer; background:#fff3e0; padding:10px 12px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:12px; font-weight:bold; color:#e65100;">ğŸ“‹ æ‰¿éŠ·é€²è¡Œä¸­æ˜ç´° (${pendingData.length}æª”ï¼Œå…±${pendingData.reduce((s,d)=>s+d.size,0).toFixed(0)}å„„)</span>
                <span id="pending-toggle" style="color:#e65100;">â–¼</span>
            </div>
            <div id="pending-detail" style="display:none; background:#fffde7; padding:8px; border-radius:0 0 6px 6px; max-height:250px; overflow-y:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:10px; table-layout:fixed;">
                    <tr style="background:#ff9800; color:white;">
                        <th style="padding:5px 3px; width:18%;">æ¨™çš„</th>
                        <th style="padding:5px 3px; width:14%;">é¡å‹</th>
                        <th style="padding:5px 3px; width:14%;">è¦æ¨¡</th>
                        <th style="padding:5px 3px; width:18%;">ä¿¡è©•/æ“”ä¿</th>
                        <th style="padding:5px 3px; width:18%;">åˆ¸å•†</th>
                        <th style="padding:5px 3px; width:18%;">æ›ç‰Œæ—¥</th>
                    </tr>`;
        pendingData.forEach(d => {
            const typeColor = d.type === 'ç«¶æ‹' ? '#ff6f00' : '#1565c0';
            let listDateStr = '-';
            if (d.listDate) {
                if (typeof d.listDate === 'string') listDateStr = d.listDate.substring(5, 10).replace('-','/');
                else if (d.listDate instanceof Date) listDateStr = (d.listDate.getMonth()+1) + '/' + d.listDate.getDate();
            }
            const ratingDisplay = d.rating || '-';
            const ratingColor = ratingDisplay.includes('æ“”ä¿') || !(/^\d/.test(ratingDisplay)) ? '#2e7d32' : '#666';
            html += `
                    <tr style="border-bottom:1px solid #ffe0b2;">
                        <td style="padding:4px 3px; text-align:left; font-weight:600;">${d.name || d.id}</td>
                        <td style="padding:4px 3px; text-align:center; color:${typeColor}; font-weight:bold;">${d.type}</td>
                        <td style="padding:4px 3px; text-align:right; font-weight:600;">${d.size}å„„</td>
                        <td style="padding:4px 3px; text-align:center; color:${ratingColor}; font-size:9px;">${ratingDisplay}</td>
                        <td style="padding:4px 3px; text-align:center; font-size:9px;">${d.broker}</td>
                        <td style="padding:4px 3px; text-align:center;">${listDateStr}</td>
                    </tr>`;
        });
        html += `</table></div></div>`;
    }
    
    // ç¬¬ä¸‰å€å¡Šï¼šè‘£äº‹æœƒå…¬å‘Šæ˜ç´°ï¼ˆå¯æ”¶åˆï¼‰
    if (boardData.length > 0) {
        html += `
        <div style="margin-bottom:15px;">
            <div onclick="toggleSupplyDetail('board')" style="cursor:pointer; background:#f3e5f5; padding:10px 12px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:12px; font-weight:bold; color:#7b1fa2;">ğŸ›ï¸ è‘£äº‹æœƒå…¬å‘Šæ˜ç´° (${boardData.length}æª”ï¼Œå…±${boardData.reduce((s,d)=>s+d.size,0).toFixed(0)}å„„)</span>
                <span id="board-toggle" style="color:#7b1fa2;">â–¼</span>
            </div>
            <div id="board-detail" style="display:none; background:#fce4ec; padding:8px; border-radius:0 0 6px 6px; max-height:250px; overflow-y:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:10px; table-layout:fixed;">
                    <tr style="background:#9c27b0; color:white;">
                        <th style="padding:5px 3px; width:18%;">æ¨™çš„</th>
                        <th style="padding:5px 3px; width:14%;">é¡å‹</th>
                        <th style="padding:5px 3px; width:14%;">è¦æ¨¡</th>
                        <th style="padding:5px 3px; width:18%;">ä¿¡è©•/æ“”ä¿</th>
                        <th style="padding:5px 3px; width:18%;">åˆ¸å•†</th>
                        <th style="padding:5px 3px; width:18%;">é€šéæ—¥</th>
                    </tr>`;
        boardData.forEach(d => {
            const typeColor = (d.type === 'ç«¶æ‹' || d.type === 'ç«¶åƒ¹') ? '#ff6f00' : '#1565c0';
            let boardDateStr = '-';
            if (d.boardDate) {
                if (typeof d.boardDate === 'string') boardDateStr = d.boardDate.substring(5, 10).replace('-','/');
                else if (d.boardDate instanceof Date) boardDateStr = (d.boardDate.getMonth()+1) + '/' + d.boardDate.getDate();
            }
            const ratingDisplay = d.rating || '-';
            const ratingColor = ratingDisplay.includes('æ“”ä¿') || !(/^\d/.test(ratingDisplay)) ? '#2e7d32' : '#666';
            html += `
                    <tr style="border-bottom:1px solid #f8bbd9;">
                        <td style="padding:4px 3px; text-align:left; font-weight:600;">${d.name || d.id}</td>
                        <td style="padding:4px 3px; text-align:center; color:${typeColor}; font-weight:bold;">${d.type || '-'}</td>
                        <td style="padding:4px 3px; text-align:right; font-weight:600;">${d.size > 0 ? d.size + 'å„„' : '-'}</td>
                        <td style="padding:4px 3px; text-align:center; color:${ratingColor}; font-size:9px;">${ratingDisplay}</td>
                        <td style="padding:4px 3px; text-align:center; font-size:9px;">${d.broker || '-'}</td>
                        <td style="padding:4px 3px; text-align:center;">${boardDateStr}</td>
                    </tr>`;
        });
        html += `</table></div></div>`;
    }
    
    // ç¬¬å››å€å¡Šï¼šæ­·å²çµ±è¨ˆè¡¨æ ¼
    html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:8px;">ğŸ“ˆ æ­·å²ç™¼è¡Œé‡èˆ‡ç¸¾æ•ˆè¶¨å‹¢</div>
    <div style="overflow-x:auto;">
    <table class="supply-table" style="min-width:100%;">
        <thead>
            <tr>
                <th style="width:18%;">æœŸé–“</th>
                <th style="width:10%;">æª”æ•¸</th>
                <th style="width:14%;">ç™¼è¡Œ<br>(å„„)</th>
                <th style="width:14%;">å¹³å‡<br>æ¼²å¹…</th>
                <th style="width:14%;">ä¸­ä½æ•¸</th>
                <th style="width:10%;">â‰¥50%</th>
                <th style="width:10%;">30~50</th>
                <th style="width:10%;">&lt;10%</th>
            </tr>
        </thead>
        <tbody>`;
    
    periods.forEach(period => {
        const ps = halfYearStats[period];
        if (!ps) return; // å¦‚æœæ²’æœ‰è©²æœŸé–“çš„æ•¸æ“šå°±è·³é
        
        const isHighlight = period === '2024H2';
        const isCurrent = period === currentPeriod;
        
        let rowClass = '';
        if (isHighlight) rowClass = 'highlight-row';
        else if (isCurrent) rowClass = 'current-row';
        
        const avgClass = ps.avgGain < 35 ? 'val-high' : (ps.avgGain > 60 ? 'val-low' : '');
        const below10Class = ps.below10 >= 10 ? 'val-high' : '';
        const above50Class = ps.above50 >= 20 ? 'val-low' : (ps.above50 < 10 ? 'val-warn' : '');
        
        html += `
        <tr class="${rowClass}">
            <td class="period-cell">${period}${isCurrent ? ' ğŸ“' : ''}</td>
            <td>${ps.total}</td>
            <td class="${ps.issueAmount > 800 ? 'val-high' : ''}">${ps.issueAmount.toFixed(0)}</td>
            <td class="${avgClass}">${ps.avgGain.toFixed(1)}%</td>
            <td>${ps.medianGain.toFixed(1)}%</td>
            <td class="${above50Class}">${ps.above50}</td>
            <td>${ps.range3050}</td>
            <td class="${below10Class}">${ps.below10}</td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    
    // è­¦ç¤ºèªªæ˜
    const warningMsg = exceedPercent >= 20 ? 
        `âš ï¸ <strong>ä¾›çµ¦å£“åŠ›è­¦ç¤ºï¼š</strong>2025å¹´é ä¼°ç™¼è¡Œé‡${projectedTotal.toFixed(0)}å„„ï¼Œè¼ƒ2024å¹´å¢åŠ ${exceedPercent.toFixed(0)}%ï¼Œå¸‚å ´æ¶ˆåŒ–å£“åŠ›æ¥µå¤§ï¼Œé¸è‚¡é›£åº¦æŒçºŒæé«˜ã€‚` :
        (exceedPercent >= 0 ?
            `ğŸ“Š <strong>ä¾›çµ¦é‡è§€å¯Ÿï¼š</strong>2025å¹´é ä¼°ç™¼è¡Œé‡${projectedTotal.toFixed(0)}å„„ï¼Œç•¥é«˜æ–¼2024å¹´æ°´æº–ï¼Œå¸‚å ´ä»éœ€ç•™æ„ä¾›çµ¦å£“åŠ›ã€‚` :
            `ğŸ“Š <strong>ä¾›çµ¦é‡è§€å¯Ÿï¼š</strong>2025å¹´é ä¼°ç™¼è¡Œé‡${projectedTotal.toFixed(0)}å„„ï¼Œè¼ƒ2024å¹´æ¸›å°‘ï¼Œä¾›çµ¦å£“åŠ›ç›¸å°ç·©è§£ã€‚`);
    
    html += `
    <div class="supply-warning">${warningMsg}</div>
    <div class="supply-note">
        ğŸ“Œ <strong>è§€å¯Ÿé‡é»ï¼š</strong>æ¼²å¹…æ¬„ä½ç´…è‰²è¡¨ç¤ºä½æ–¼35%ï¼Œç¶ è‰²è¡¨ç¤ºé«˜æ–¼60%ã€‚
        æ‰¿éŠ·é€²è¡Œä¸­æ¡ˆä»¶é€šå¸¸1-2å€‹æœˆå…§æ›ç‰Œï¼Œè‘£äº‹æœƒå…¬å‘Šæ¡ˆä»¶å‰‡éœ€3-6å€‹æœˆå®Œæˆç™¼è¡Œç¨‹åºã€‚
    </div>`;
    
    return html;
}

// v3.92 æ–°å¢ï¼šä¾›çµ¦åˆ†ææ¸²æŸ“å‡½æ•¸ï¼ˆä¾›æ¨™ç±¤åˆ‡æ›ä½¿ç”¨ï¼‰
function renderSupplyAnalysis() {
    return generateSupplyAnalysis();
}

// åˆ‡æ›ä¾›çµ¦æ˜ç´°é¡¯ç¤º
function toggleSupplyDetail(type) {
    const detail = document.getElementById(type + '-detail');
    const toggle = document.getElementById(type + '-toggle');
    if (detail.style.display === 'none') {
        detail.style.display = 'block';
        toggle.textContent = 'â–²';
    } else {
        detail.style.display = 'none';
        toggle.textContent = 'â–¼';
    }
}

// v3.55 æ–°å¢ï¼šå¹´åº¦ç¸¾æ•ˆæ’è¡Œ
let yearlyRankingData = {};

function generateYearlyRanking() {
    // å‹•æ…‹å¾ç«¶æ‹å’Œè©¢åœˆè³‡æ–™ç”Ÿæˆå¹´åº¦ç¸¾æ•ˆ
    const years = [2022, 2023, 2024, 2025];
    
    // åˆä½µç«¶æ‹å’Œè©¢åœˆè³‡æ–™
    const allData = [];
    
    // ç«¶æ‹è³‡æ–™
    auctionRawData.forEach(d => {
        if (d.marketHigh > 0 && d.marketLow > 0) {
            let year = null;
            if (d.openDate) {
                if (typeof d.openDate === 'number') {
                    const date = new Date((d.openDate - 25569) * 86400 * 1000);
                    year = date.getFullYear();
                } else if (typeof d.openDate === 'string') {
                    const parts = d.openDate.split(/[\/\-]/);
                    year = parseInt(parts[0]);
                    if (year < 100) year += 2000;
                }
            }
            if (year && year >= 2022 && year <= 2025) {
                const amp = ((d.marketHigh - d.marketLow) / d.marketLow * 100);
                allData.push({
                    id: d.id,
                    name: d.name,
                    type: 'ç«¶æ‹',
                    high: d.marketHigh,
                    low: d.marketLow,
                    amp: amp,
                    year: year,
                    status: listedSet.has(d.id) ? 'æ›ç‰Œä¸­' : 'å·²ä¸‹å¸‚'
                });
            }
        }
    });
    
    // è©¢åœˆè³‡æ–™ - v3.97b ä¿®å¾©ï¼šä½¿ç”¨listDateåˆ¤æ–·å¹´åº¦
    inquiryRawData.forEach(d => {
        if (d.marketHigh > 0 && d.marketLow > 0) {
            // æª¢æŸ¥æ˜¯å¦å·²åœ¨ç«¶æ‹ä¸­ï¼ˆé¿å…é‡è¤‡ï¼‰
            if (allData.find(a => a.id === d.id)) return;
            
            // ä½¿ç”¨listDateåˆ¤æ–·å¹´åº¦
            let year = null;
            if (d.listDate) {
                if (typeof d.listDate === 'number') {
                    const date = new Date((d.listDate - 25569) * 86400 * 1000);
                    year = date.getFullYear();
                } else if (typeof d.listDate === 'string') {
                    const parts = d.listDate.split(/[\/\-]/);
                    year = parseInt(parts[0]);
                    if (year < 100) year += 2000;
                }
            }
            
            if (year && year >= 2022 && year <= 2025) {
                const amp = ((d.marketHigh - d.marketLow) / d.marketLow * 100);
                allData.push({
                    id: d.id,
                    name: d.name,
                    type: 'è©¢åœˆ',
                    high: d.marketHigh,
                    low: d.marketLow,
                    amp: amp,
                    year: year,
                    status: listedSet.has(d.id) ? 'æ›ç‰Œä¸­' : 'å·²ä¸‹å¸‚'
                });
            }
        }
    });
    
    // ä¾å¹´åº¦åˆ†çµ„ä¸¦æ’åº
    years.forEach(year => {
        const yearData = allData.filter(d => d.year === year);
        const sortedByAmp = [...yearData].sort((a, b) => b.amp - a.amp);
        
        yearlyRankingData[year] = {
            total: yearData.length,
            top10: sortedByAmp.slice(0, 10),
            bottom10: sortedByAmp.slice(-10).reverse(),
            summary: generateYearSummary(year, sortedByAmp)
        };
    });
    
    // é è¨­é¡¯ç¤º2022å¹´
    showRankingYear(2022);
}

function generateYearSummary(year, sortedData) {
    if (sortedData.length === 0) return 'æš«ç„¡è³‡æ–™';
    const top = sortedData[0];
    const auctionInTop10 = sortedData.slice(0, 10).filter(d => d.type === 'ç«¶æ‹').length;
    return `å† è»${top.name}æŒ¯å¹…${top.amp.toFixed(1)}%ï¼Œå‰10åç«¶æ‹ä½”${auctionInTop10}æª”ã€‚`;
}

function showRankingYear(year, event) {
    // é˜²æ­¢é é¢è·³å‹•
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // æ›´æ–°tabç‹€æ…‹
    document.querySelectorAll('.ranking-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent == year) {
            tab.classList.add('active');
        }
    });
    
    const data = yearlyRankingData[year];
    if (!data) return;
    
    // å»ºç«‹TOP10è¡¨æ ¼
    let html = `
    <div class="ranking-grid">
        <div class="ranking-box top">
            <div class="ranking-box-title">ğŸ† è¡¨ç¾æœ€ä½³ TOP 10</div>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ä»£è™Ÿ</th>
                        <th>åç¨±</th>
                        <th>é¡å‹</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ›ç‰Œé«˜</th>
                        <th>æ›ç‰Œä½</th>
                        <th>æŒ¯å¹…</th>
                    </tr>
                </thead>
                <tbody>`;
    
    data.top10.forEach((item, idx) => {
        const typeClass = item.type === 'ç«¶æ‹' ? 'auction' : 'inquiry';
        const statusClass = item.status === 'æ›ç‰Œä¸­' ? 'listed' : 'delisted';
        html += `
                    <tr>
                        <td><span class="rank-num">${idx + 1}</span></td>
                        <td>${item.id || '-'}</td>
                        <td title="${item.name}">${item.name}</td>
                        <td><span class="ranking-type ${typeClass}">${item.type}</span></td>
                        <td><span class="dimension-status-badge ${statusClass}">${item.status || 'å·²ä¸‹å¸‚'}</span></td>
                        <td class="val-gain">${item.high.toFixed(1)}</td>
                        <td>${item.low.toFixed(1)}</td>
                        <td class="val-amp">${item.amp.toFixed(1)}%</td>
                    </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="ranking-box bottom">
            <div class="ranking-box-title">ğŸ“‰ è¡¨ç¾æœ€å·® BOTTOM 10</div>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ä»£è™Ÿ</th>
                        <th>åç¨±</th>
                        <th>é¡å‹</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ›ç‰Œé«˜</th>
                        <th>æ›ç‰Œä½</th>
                        <th>æŒ¯å¹…</th>
                    </tr>
                </thead>
                <tbody>`;
    
    data.bottom10.forEach((item, idx) => {
        const typeClass = item.type === 'ç«¶æ‹' ? 'auction' : 'inquiry';
        const statusClass = item.status === 'æ›ç‰Œä¸­' ? 'listed' : 'delisted';
        html += `
                    <tr>
                        <td><span class="rank-num">${idx + 1}</span></td>
                        <td>${item.id || '-'}</td>
                        <td title="${item.name}">${item.name}</td>
                        <td><span class="ranking-type ${typeClass}">${item.type}</span></td>
                        <td><span class="dimension-status-badge ${statusClass}">${item.status || 'å·²ä¸‹å¸‚'}</span></td>
                        <td class="val-gain">${item.high.toFixed(1)}</td>
                        <td>${item.low.toFixed(1)}</td>
                        <td class="val-amp">${item.amp.toFixed(1)}%</td>
                    </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    </div>
    <div class="ranking-summary">
        ğŸ“Œ <strong>${year}å¹´(${data.total}æª”)ï¼š</strong>${data.summary}
    </div>`;
    
    document.getElementById('rankingContent').innerHTML = html;
}

// v3.56 æ–°å¢ï¼šæœˆå‡æˆäº¤çœŸå¯¦ç¸¾æ•ˆåˆ†æ
let realPerfData = {};

function generateRealPerformance() {
    // å»ºç«‹åç¨±åˆ°è³‡æ–™çš„å°ç…§è¡¨
    const nameToData = {};
    auctionRawData.forEach(d => {
        if (d.name) nameToData[d.name] = { id: d.id, type: 'ç«¶æ‹' };
    });
    inquiryRawData.forEach(d => {
        if (d.name && !nameToData[d.name]) nameToData[d.name] = { id: d.id, type: 'è©¢åœˆ' };
    });
    
    // è£œå……è³‡æ–™çš„è¼”åŠ©å‡½æ•¸
    const enrichItem = (item) => {
        const lookup = nameToData[item.name] || {};
        return {
            ...item,
            id: lookup.id || '',
            type: lookup.type || '-',
            status: lookup.id && listedSet.has(lookup.id) ? 'æ›ç‰Œä¸­' : 'å·²ä¸‹å¸‚'
        };
    };
    
    // ç¡¬ç·¨ç¢¼çš„æœˆå‡æˆäº¤ç¸¾æ•ˆæ•¸æ“šï¼ˆæœˆå‡åƒ¹ç„¡æ³•å¾Excelå–å¾—ï¼‰
    realPerfData = {
        2022: {
            total: 96,
            avgPos: 37.9,
            medianPos: 32.5,
            dist: { excellent: 12, good: 16, neutral: 13, weak: 18, poor: 37 },
            top5: [
                { name: 'äº‹æ¬£ç§‘ä¸‰', high: 215.0, low: 93.2, monthly: 215.0, pos: 100.0 },
                { name: 'ç¶­ç”°ä¸€', high: 185.0, low: 103.8, monthly: 185.0, pos: 100.0 },
                { name: 'å°å…‰é›»äº”', high: 388.0, low: 97.0, monthly: 382.4, pos: 98.1 },
                { name: 'å°ç£éŠ˜æ¿ä¸€', high: 496.0, low: 113.5, monthly: 479.0, pos: 95.6 },
                { name: 'è‰¯ç¶­ä¹', high: 208.0, low: 108.2, monthly: 203.0, pos: 95.0 }
            ].map(enrichItem),
            bottom5: [
                { name: 'æµ·å¾·å¨ä¸€', high: 133.3, low: 99.7, monthly: 99.8, pos: 0.4 },
                { name: 'ç«‹ç©ä¸€', high: 208.0, low: 99.5, monthly: 100.0, pos: 0.4 },
                { name: 'æ˜å®‰ä¸‰', high: 145.0, low: 99.6, monthly: 99.9, pos: 0.6 },
                { name: 'é¢¨é’äºŒ', high: 136.9, low: 99.7, monthly: 100.1, pos: 1.0 },
                { name: 'å¤§æ¨¹äºŒ', high: 155.0, low: 99.3, monthly: 99.9, pos: 1.0 }
            ].map(enrichItem),
            summary: 'å¹³å‡ä½ç½®37.9%åä½ï¼Œ38.5%æ¨™çš„ç›®å‰è™•æ–¼æ¥µå¼±å€(<20%)ï¼Œå¤šæ•¸æ›¾ç¶“è¼ç…Œç¾å·²å›è½ã€‚'
        },
        2023: {
            total: 91,
            avgPos: 36.0,
            medianPos: 29.5,
            dist: { excellent: 6, good: 13, neutral: 16, weak: 23, poor: 33 },
            top5: [
                { name: 'æ³°èŒ‚å››', high: 470.0, low: 121.5, monthly: 466.4, pos: 99.0 },
                { name: 'ç™¾é”äºŒK', high: 215.0, low: 104.0, monthly: 207.5, pos: 93.2 },
                { name: 'æ—­å“ä¸‰', high: 236.0, low: 115.3, monthly: 225.8, pos: 91.5 },
                { name: 'ç¢©å¤©äºŒ', high: 179.0, low: 111.0, monthly: 172.7, pos: 90.7 },
                { name: 'äº‹æ¬£ç§‘å››', high: 199.0, low: 99.5, monthly: 185.6, pos: 86.5 }
            ].map(enrichItem),
            bottom5: [
                { name: 'æ£®å´´èƒ½æºä¸€', high: 167.0, low: 97.8, monthly: 98.4, pos: 0.9 },
                { name: 'é«˜æ—ä¸€', high: 135.0, low: 99.8, monthly: 100.4, pos: 1.7 },
                { name: 'ä¸–å¾·äºŒ', high: 156.0, low: 96.0, monthly: 97.1, pos: 1.9 },
                { name: 'å¼˜å¸†ä¸€', high: 147.8, low: 100.0, monthly: 101.4, pos: 2.9 },
                { name: 'å¾¡åµ¿ä¸€', high: 159.0, low: 102.1, monthly: 104.1, pos: 3.6 }
            ].map(enrichItem),
            summary: 'å¹³å‡ä½ç½®36%ï¼Œ36%æ¨™çš„æ¥µå¼±ã€‚å† è»æ³°èŒ‚å››ä»ç¶­æŒé«˜æª”(99%)ï¼Œä½†å¤šæ•¸å·²å›è½è‡³ä½é»ã€‚'
        },
        2024: {
            total: 139,
            avgPos: 36.8,
            medianPos: 33.6,
            dist: { excellent: 9, good: 19, neutral: 29, weak: 33, poor: 49 },
            top5: [
                { name: 'ç¾¤ç¿ŠäºŒ', high: 120.4, low: 95.5, monthly: 118.2, pos: 90.9 },
                { name: 'jppä¸‰K', high: 202.0, low: 95.0, monthly: 192.0, pos: 90.6 },
                { name: 'é›™é´»äº”', high: 151.0, low: 105.0, monthly: 145.8, pos: 88.7 },
                { name: 'å˜‰æ™¶äº”', high: 110.9, low: 92.0, monthly: 108.6, pos: 87.9 },
                { name: 'å—ä¿Šåœ‹éš›äºŒ', high: 155.0, low: 98.0, monthly: 147.0, pos: 85.9 }
            ].map(enrichItem),
            bottom5: [
                { name: 'å€åŠ›ä¸€', high: 111.0, low: 97.5, monthly: 97.5, pos: 0.0 },
                { name: 'å…­è§’ä¸‰', high: 133.0, low: 99.8, monthly: 100.3, pos: 1.6 },
                { name: 'å¼˜å¸†ä¸‰', high: 155.0, low: 96.0, monthly: 98.1, pos: 3.5 },
                { name: 'è€€å‹ä¸€', high: 155.0, low: 97.6, monthly: 99.7, pos: 3.7 },
                { name: 'å…¶é™½äºŒ', high: 125.0, low: 95.1, monthly: 96.3, pos: 4.0 }
            ].map(enrichItem),
            summary: 'å¹³å‡ä½ç½®36.8%ï¼Œ35%æ¥µå¼±ã€‚ç™¼è¡Œé‡å¤§(139æª”)å°è‡´ç±Œç¢¼åˆ†æ•£ï¼Œå¤šæ•¸æ¨™çš„è¡¨ç¾å¹³æ·¡ã€‚'
        },
        2025: {
            total: 94,
            avgPos: 45.2,
            medianPos: 45.0,
            dist: { excellent: 4, good: 21, neutral: 31, weak: 24, poor: 14 },
            top5: [
                { name: 'å‡¡ç”²ä¸ƒ', high: 119.5, low: 105.0, monthly: 117.5, pos: 86.2 },
                { name: 'å¯¶ç·¯ä¸€', high: 105.0, low: 101.0, monthly: 104.4, pos: 84.0 },
                { name: 'è¯åˆäº”', high: 126.7, low: 106.0, monthly: 123.0, pos: 82.5 },
                { name: 'æ—ºçŸ½äº”', high: 232.0, low: 96.5, monthly: 206.1, pos: 80.9 },
                { name: 'è¯é›»ç¶²äº”', high: 116.2, low: 100.2, monthly: 112.9, pos: 79.6 }
            ].map(enrichItem),
            bottom5: [
                { name: 'çš‡æ™®å››', high: 112.2, low: 92.0, monthly: 92.4, pos: 2.0 },
                { name: 'æ³“å¾·èƒ½æºäºŒ', high: 114.0, low: 89.9, monthly: 90.7, pos: 3.4 },
                { name: 'è¯å¯¶ä¸€', high: 110.0, low: 102.0, monthly: 102.8, pos: 9.2 },
                { name: 'å¹³å’Œç’°ä¿ä¸€å‰µ', high: 118.0, low: 107.3, monthly: 108.3, pos: 9.3 },
                { name: 'å€‰å’Œä¸€', high: 101.0, low: 91.8, monthly: 92.8, pos: 10.8 }
            ].map(enrichItem),
            summary: 'å¹³å‡ä½ç½®45.2%è¼ƒé«˜ï¼Œæ¥µå¼±åƒ…14.9%ã€‚2025å¹´ç™¼è¡Œæ¨™çš„ç›¸å°è¼ƒæ–°ï¼Œå°šæœªå¤§å¹…å›è½ã€‚'
        }
    };
    
    // é è¨­é¡¯ç¤º2025å¹´ï¼ˆæœ€æ–°ï¼‰
    showRealPerfYear(2025);
}

function showRealPerfYear(year, event) {
    // é˜²æ­¢é é¢è·³å‹•
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // æ›´æ–°tabç‹€æ…‹
    document.querySelectorAll('.realperf-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent == year) {
            tab.classList.add('active');
        }
    });
    
    const data = realPerfData[year];
    if (!data) return;
    
    // çµ±è¨ˆåˆ†å¸ƒå€å¡Š
    let html = `
    <div class="realperf-stats">
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">ğŸŸ¢æ¥µä½³(80%â†‘)</div>
            <div class="realperf-stat-value green">${data.dist.excellent}</div>
        </div>
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">ğŸ”µè‰¯å¥½(60-80%)</div>
            <div class="realperf-stat-value blue">${data.dist.good}</div>
        </div>
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">âšªä¸­æ€§(40-60%)</div>
            <div class="realperf-stat-value gray">${data.dist.neutral}</div>
        </div>
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">ğŸŸ¡åå¼±(20-40%)</div>
            <div class="realperf-stat-value orange">${data.dist.weak}</div>
        </div>
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">ğŸ”´æ¥µå¼±(<20%)</div>
            <div class="realperf-stat-value red">${data.dist.poor}</div>
        </div>
    </div>
    <div style="text-align:center; font-size:10px; color:#666; margin-bottom:10px;">
        å¹³å‡ä½ç½®: <b style="color:#1565c0">${data.avgPos}%</b> ï½œ ä¸­ä½æ•¸: <b style="color:#1565c0">${data.medianPos}%</b> ï½œ æ¨£æœ¬æ•¸: ${data.total}æª”
    </div>
    
    <div class="realperf-grid">
        <div class="realperf-box top">
            <div class="realperf-box-title">ğŸ”´ æœˆå‡æ¥è¿‘é«˜é» TOP5</div>
            <table class="realperf-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ä»£è™Ÿ</th>
                        <th>åç¨±</th>
                        <th>é¡å‹</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ›ç‰Œé«˜</th>
                        <th>æ›ç‰Œä½</th>
                        <th>æœˆå‡åƒ¹</th>
                        <th>ä½ç½®</th>
                    </tr>
                </thead>
                <tbody>`;
    
    data.top5.forEach((item, idx) => {
        const typeClass = item.type === 'ç«¶æ‹' ? 'auction' : 'inquiry';
        const statusClass = item.status === 'æ›ç‰Œä¸­' ? 'listed' : 'delisted';
        html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${item.id || '-'}</td>
                        <td>${item.name}</td>
                        <td><span class="ranking-type ${typeClass}">${item.type || '-'}</span></td>
                        <td><span class="dimension-status-badge ${statusClass}">${item.status || 'å·²ä¸‹å¸‚'}</span></td>
                        <td>${item.high.toFixed(1)}</td>
                        <td>${item.low.toFixed(1)}</td>
                        <td>${item.monthly.toFixed(1)}</td>
                        <td><span class="realperf-pos high">${item.pos.toFixed(1)}%</span></td>
                    </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="realperf-box bottom">
            <div class="realperf-box-title">ğŸŸ¢ æœˆå‡æ¥è¿‘ä½é» BOTTOM5</div>
            <table class="realperf-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ä»£è™Ÿ</th>
                        <th>åç¨±</th>
                        <th>é¡å‹</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ›ç‰Œé«˜</th>
                        <th>æ›ç‰Œä½</th>
                        <th>æœˆå‡åƒ¹</th>
                        <th>ä½ç½®</th>
                    </tr>
                </thead>
                <tbody>`;
    
    data.bottom5.forEach((item, idx) => {
        const typeClass = item.type === 'ç«¶æ‹' ? 'auction' : 'inquiry';
        const statusClass = item.status === 'æ›ç‰Œä¸­' ? 'listed' : 'delisted';
        html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${item.id || '-'}</td>
                        <td>${item.name}</td>
                        <td><span class="ranking-type ${typeClass}">${item.type || '-'}</span></td>
                        <td><span class="dimension-status-badge ${statusClass}">${item.status || 'å·²ä¸‹å¸‚'}</span></td>
                        <td>${item.high.toFixed(1)}</td>
                        <td>${item.low.toFixed(1)}</td>
                        <td>${item.monthly.toFixed(1)}</td>
                        <td><span class="realperf-pos low">${item.pos.toFixed(1)}%</span></td>
                    </tr>`;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    </div>
    <div class="realperf-summary">
        ğŸ“Œ <strong>${year}å¹´ï¼š</strong>${data.summary}
    </div>`;
    
    document.getElementById('realperfContent').innerHTML = html;
}

// v3.59 æ–°å¢ï¼šç«¶æ‹ç›ˆè™§å‹ç‡åˆ†æ
let profitLossData = {};

function generateProfitLossAnalysis() {
    // å¾ç«¶æ‹è³‡æ–™è¨ˆç®—ç›ˆè™§
    const years = [2022, 2023, 2024, 2025];
    
    years.forEach(year => {
        // ç¯©é¸è©²å¹´åº¦æœ‰å®Œæ•´æ•¸æ“šçš„ç«¶æ‹
        const yearData = auctionRawData.filter(d => {
            if (!d.openDate || !d.minBidPrice || d.minBidPrice <= 0) return false;
            if (!d.marketHigh || d.marketHigh <= 0 || !d.marketLow || d.marketLow <= 0) return false;
            
            let dataYear = null;
            if (typeof d.openDate === 'number') {
                const date = new Date((d.openDate - 25569) * 86400 * 1000);
                dataYear = date.getFullYear();
            } else if (typeof d.openDate === 'string') {
                const parts = d.openDate.split(/[\/\-]/);
                dataYear = parseInt(parts[0]);
                if (dataYear < 100) dataYear += 2000;
            }
            return dataYear === year;
        });
        
        // è¨ˆç®—å„é …æŒ‡æ¨™
        let winByHigh = 0, winByLow = 0, winByAvg = 0;
        let totalProfitHigh = 0, totalProfitLow = 0, totalProfitAvg = 0;
        let details = [];
        
        yearData.forEach(d => {
            const minBid = d.minBidPrice;
            const avgBid = d.avgBidPrice || minBid;
            const high = d.marketHigh;
            const low = d.marketLow;
            
            // ä»¥æœ€ä½å¾—æ¨™è¨ˆç®—
            const profitByHigh = ((high - minBid) / minBid * 100);
            const profitByLow = ((low - minBid) / minBid * 100);
            const profitByAvgBid = ((high - avgBid) / avgBid * 100);
            
            if (high > minBid) winByHigh++;
            if (low > minBid) winByLow++;
            if (high > avgBid) winByAvg++;
            
            totalProfitHigh += profitByHigh;
            totalProfitLow += profitByLow;
            totalProfitAvg += profitByAvgBid;
            
            details.push({
                id: d.id,
                name: d.name,
                minBid: minBid,
                avgBid: avgBid,
                high: high,
                low: low,
                profitByHigh: profitByHigh,
                profitByLow: profitByLow,
                status: listedSet.has(d.id) ? 'æ›ç‰Œä¸­' : 'å·²ä¸‹å¸‚'
            });
        });
        
        const count = yearData.length;
        profitLossData[year] = {
            total: count,
            winRateByHigh: count > 0 ? (winByHigh / count * 100) : 0,
            winRateByLow: count > 0 ? (winByLow / count * 100) : 0,
            winRateByAvg: count > 0 ? (winByAvg / count * 100) : 0,
            avgProfitHigh: count > 0 ? (totalProfitHigh / count) : 0,
            avgProfitLow: count > 0 ? (totalProfitLow / count) : 0,
            avgProfitAvg: count > 0 ? (totalProfitAvg / count) : 0,
            details: details.sort((a, b) => b.profitByHigh - a.profitByHigh)
        };
    });
    
    // è¨ˆç®—å…¨éƒ¨å¹´åº¦ç¸½è¨ˆ
    let allData = [];
    years.forEach(y => {
        if (profitLossData[y]) {
            allData = allData.concat(profitLossData[y].details);
        }
    });
    
    const allCount = allData.length;
    let allWinHigh = 0, allWinLow = 0, allWinAvg = 0;
    let allProfitHigh = 0, allProfitLow = 0, allProfitAvg = 0;
    
    allData.forEach(d => {
        if (d.high > d.minBid) allWinHigh++;
        if (d.low > d.minBid) allWinLow++;
        if (d.high > d.avgBid) allWinAvg++;
        allProfitHigh += d.profitByHigh;
        allProfitLow += d.profitByLow;
    });
    
    profitLossData['all'] = {
        total: allCount,
        winRateByHigh: allCount > 0 ? (allWinHigh / allCount * 100) : 0,
        winRateByLow: allCount > 0 ? (allWinLow / allCount * 100) : 0,
        winRateByAvg: allCount > 0 ? (allWinAvg / allCount * 100) : 0,
        avgProfitHigh: allCount > 0 ? (allProfitHigh / allCount) : 0,
        avgProfitLow: allCount > 0 ? (allProfitLow / allCount) : 0,
        details: allData.sort((a, b) => b.profitByHigh - a.profitByHigh)
    };
    
    // é è¨­é¡¯ç¤º2022å¹´
    showProfitLossYear(2022);
}

function showProfitLossYear(year, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // æ›´æ–°tabç‹€æ…‹
    document.querySelectorAll('.profitloss-tab').forEach(tab => {
        tab.classList.remove('active');
        if ((year === 'all' && tab.textContent === 'å…¨éƒ¨') || tab.textContent == year) {
            tab.classList.add('active');
        }
    });
    
    const data = profitLossData[year];
    if (!data) return;
    
    const yearLabel = year === 'all' ? 'å…¨éƒ¨(2022-2025)' : year + 'å¹´';
    
    // çµ±è¨ˆå€å¡Š
    let html = `
    <div class="profitloss-stats">
        <div class="profitloss-stat-box">
            <div class="profitloss-stat-label">ğŸ“Š æ¨£æœ¬æ•¸</div>
            <div class="profitloss-stat-value neutral">${data.total}æª”</div>
        </div>
        <div class="profitloss-stat-box">
            <div class="profitloss-stat-label">ğŸ¯ æœ€ä½å¾—æ¨™vsæ›ç‰Œé«˜<br>å‹ç‡</div>
            <div class="profitloss-stat-value win">${data.winRateByHigh.toFixed(1)}%</div>
        </div>
        <div class="profitloss-stat-box">
            <div class="profitloss-stat-label">âš ï¸ æœ€ä½å¾—æ¨™vsæ›ç‰Œä½<br>å‹ç‡</div>
            <div class="profitloss-stat-value ${data.winRateByLow >= 50 ? 'win' : 'lose'}">${data.winRateByLow.toFixed(1)}%</div>
        </div>
        <div class="profitloss-stat-box">
            <div class="profitloss-stat-label">ğŸ“ˆ å¹³å‡å¾—æ¨™vsæ›ç‰Œé«˜<br>å‹ç‡</div>
            <div class="profitloss-stat-value win">${data.winRateByAvg.toFixed(1)}%</div>
        </div>
    </div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
        <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
            <div style="font-size:10px; color:#666;">ä»¥æœ€ä½å¾—æ¨™è¨ˆ å¹³å‡å ±é…¬(æ›ç‰Œé«˜)</div>
            <div style="font-size:18px; font-weight:900; color:${data.avgProfitHigh >= 0 ? '#c62828' : '#2e7d32'};">${data.avgProfitHigh >= 0 ? '+' : ''}${data.avgProfitHigh.toFixed(1)}%</div>
        </div>
        <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
            <div style="font-size:10px; color:#666;">ä»¥æœ€ä½å¾—æ¨™è¨ˆ å¹³å‡å ±é…¬(æ›ç‰Œä½)</div>
            <div style="font-size:18px; font-weight:900; color:${data.avgProfitLow >= 0 ? '#c62828' : '#2e7d32'};">${data.avgProfitLow >= 0 ? '+' : ''}${data.avgProfitLow.toFixed(1)}%</div>
        </div>
    </div>
    
    <div style="font-size:11px; font-weight:bold; color:#ad1457; margin:10px 0 5px 0;">ğŸ“‹ ${yearLabel} ç›ˆè™§æ˜ç´° TOP10/BOTTOM10</div>
    <div style="overflow-x:auto;">
    <table class="profitloss-table">
        <thead>
            <tr>
                <th style="width:8%;">#</th>
                <th style="width:28%;">åç¨±</th>
                <th style="width:16%;">å¾—æ¨™åƒ¹</th>
                <th style="width:16%;">æ›ç‰Œé«˜</th>
                <th style="width:16%;">å ±é…¬é«˜</th>
                <th style="width:16%;">å ±é…¬ä½</th>
            </tr>
        </thead>
        <tbody>`;
    
    // TOP10
    const top10 = data.details.slice(0, 10);
    top10.forEach((item, idx) => {
        html += `
            <tr>
                <td>${idx + 1}</td>
                <td style="text-align:left; padding-left:5px;">${item.name || '-'}</td>
                <td>${item.minBid.toFixed(1)}</td>
                <td>${item.high.toFixed(1)}</td>
                <td class="val-win">+${item.profitByHigh.toFixed(1)}%</td>
                <td class="${item.profitByLow >= 0 ? 'val-win' : 'val-lose'}">${item.profitByLow >= 0 ? '+' : ''}${item.profitByLow.toFixed(1)}%</td>
            </tr>`;
    });
    
    // åˆ†éš”ç·š
    html += `<tr style="background:#fce4ec;"><td colspan="6" style="text-align:center; font-size:8px; color:#ad1457;">â”€â”€ BOTTOM 10 â”€â”€</td></tr>`;
    
    // BOTTOM10
    const bottom10 = data.details.slice(-10).reverse();
    bottom10.forEach((item, idx) => {
        html += `
            <tr>
                <td>${data.details.length - 9 + idx}</td>
                <td style="text-align:left; padding-left:5px;">${item.name || '-'}</td>
                <td>${item.minBid.toFixed(1)}</td>
                <td>${item.high.toFixed(1)}</td>
                <td class="${item.profitByHigh >= 0 ? 'val-win' : 'val-lose'}">${item.profitByHigh >= 0 ? '+' : ''}${item.profitByHigh.toFixed(1)}%</td>
                <td class="${item.profitByLow >= 0 ? 'val-win' : 'val-lose'}">${item.profitByLow >= 0 ? '+' : ''}${item.profitByLow.toFixed(1)}%</td>
            </tr>`;
    });
    
    html += `</tbody></table></div>`;
    
    // æ´å¯Ÿ
    const insight = data.winRateByLow >= 80 ? 
        `${yearLabel}ç«¶æ‹å‹ç‡æ¥µé«˜ï¼Œå³ä½¿ä»¥æ›ç‰Œä½è¨ˆç®—ä»æœ‰${data.winRateByLow.toFixed(0)}%æ©Ÿç‡ç²åˆ©ã€‚` :
        (data.winRateByLow >= 50 ?
            `${yearLabel}ç«¶æ‹å‹ç‡å°šå¯ï¼Œä»¥æ›ç‰Œä½è¨ˆç®—æœ‰${data.winRateByLow.toFixed(0)}%æ©Ÿç‡ç²åˆ©ï¼Œä½†éœ€æ³¨æ„é¸è‚¡ã€‚` :
            `${yearLabel}ç«¶æ‹é¢¨éšªè¼ƒé«˜ï¼Œä»¥æ›ç‰Œä½è¨ˆç®—åƒ…${data.winRateByLow.toFixed(0)}%æ©Ÿç‡ç²åˆ©ï¼Œå»ºè­°åš´æ§æŠ•æ¨™åƒ¹æ ¼ã€‚`);
    
    html += `
    <div class="profitloss-insight">
        <strong>ğŸ’¡ Rexå¤§å”åˆ†æï¼š</strong>${insight}
        ä»¥æœ€ä½å¾—æ¨™åƒ¹è¨ˆç®—ï¼Œè³£åœ¨æ›ç‰Œé«˜å¯ç²åˆ©${data.avgProfitHigh.toFixed(1)}%ï¼Œè³£åœ¨æ›ç‰Œä½å‰‡${data.avgProfitLow >= 0 ? 'ä»æœ‰' + data.avgProfitLow.toFixed(1) + '%ç²åˆ©ç©ºé–“' : 'å¹³å‡è™§æ' + Math.abs(data.avgProfitLow).toFixed(1) + '%'}ã€‚
    </div>`;
    
    document.getElementById('profitlossContent').innerHTML = html;
}

// v3.57 æ–°å¢ï¼šç¶­åº¦åˆ†æç¸½è¦½
// v3.58 æ–°å¢ï¼šå¸‚å ´è¶¨å‹¢åˆ†ææ•¸æ“š
let marketTrendData = {
    yearly: [], // å¹´åº¦è¶¨å‹¢
    guarantee: {}, // æ“”ä¿æ¯”è¼ƒ
    size: {}, // ç™¼è¡Œè¦æ¨¡
    capital: {}, // è‚¡æœ¬å¤§å°
    type: {} // ç«¶æ‹vsè©¢åœˆ
};

let dimensionData = {};

function generateDimensionAnalysis() {
    // v3.81 é‡æ§‹ï¼šå‹•æ…‹å¾auctionRawDataå’ŒinquiryRawDataç”Ÿæˆç¶­åº¦åˆ†ææ•¸æ“š
    // åˆä½µæ‰€æœ‰æœ‰æ›ç‰Œæ•¸æ“šçš„CB
    const allCBData = [];
    
    // ç«¶æ‹è³‡æ–™
    auctionRawData.forEach(d => {
        if (d.marketHigh > 0 && d.marketLow > 0) {
            const amp = ((d.marketHigh - d.marketLow) / d.marketLow * 100);
            allCBData.push({
                id: d.id,
                name: d.name,
                type: 'ç«¶æ‹',
                high: d.marketHigh,
                low: d.marketLow,
                amp: amp,
                capital: d.capital || 0,
                issueSize: d.issueSize || 0,
                conversionPrice: d.conversionPrice || 0,
                rating: d.rating || '',
                years: d.years || 0,
                guarantee: d.guarantee || '',
                status: listedSet.has(d.id) ? 'æ›ç‰Œä¸­' : 'å·²ä¸‹å¸‚'
            });
        }
    });
    
    // è©¢åœˆè³‡æ–™
    inquiryRawData.forEach(d => {
        if (d.marketHigh > 0 && d.marketLow > 0) {
            // é¿å…é‡è¤‡ï¼ˆå¦‚æœå·²åœ¨ç«¶æ‹ä¸­ï¼‰
            if (allCBData.find(a => a.id === d.id)) return;
            
            const amp = ((d.marketHigh - d.marketLow) / d.marketLow * 100);
            allCBData.push({
                id: d.id,
                name: d.name,
                type: 'è©¢åœˆ',
                high: d.marketHigh,
                low: d.marketLow,
                amp: amp,
                capital: d.capital || 0,
                issueSize: d.issueSize || 0,
                conversionPrice: d.conversionPrice || 0,
                rating: d.rating || '',
                years: d.years || 0,
                guarantee: d.guarantee || '',
                status: listedSet.has(d.id) ? 'æ›ç‰Œä¸­' : 'å·²ä¸‹å¸‚'
            });
        }
    });
    
    // v3.92 é™¤éŒ¯ï¼šæª¢æŸ¥ä¿¡è©•åˆ†å¸ƒ
    const auctionWithRating = allCBData.filter(d => d.type === 'ç«¶æ‹' && d.rating && ['3','4','5','6','7','8'].includes(String(d.rating)));
    const inquiryWithRating = allCBData.filter(d => d.type === 'è©¢åœˆ' && d.rating && ['3','4','5','6','7','8'].includes(String(d.rating)));
    console.log(`ç¶­åº¦åˆ†æä¿¡è©•çµ±è¨ˆ: ç«¶æ‹æœ‰ä¿¡è©•${auctionWithRating.length}ç­†, è©¢åœˆæœ‰ä¿¡è©•${inquiryWithRating.length}ç­†`);
    const inquiryRatings = allCBData.filter(d => d.type === 'è©¢åœˆ').map(d => d.rating);
    const uniqueRatings = [...new Set(inquiryRatings)].slice(0, 10);
    console.log(`è©¢åœˆä¿¡è©•å€¼ç¯„ä¾‹:`, uniqueRatings);
    
    // è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—å€é–“çµ±è¨ˆ
    function calcRangeStats(data, label) {
        if (data.length === 0) return null;
        const auction = data.filter(d => d.type === 'ç«¶æ‹').length;
        const inquiry = data.filter(d => d.type === 'è©¢åœˆ').length;
        const avgHigh = data.reduce((s, d) => s + d.high, 0) / data.length;
        const avgLow = data.reduce((s, d) => s + d.low, 0) / data.length;
        const avgAmp = data.reduce((s, d) => s + d.amp, 0) / data.length;
        
        // å–æŒ¯å¹…å‰5å
        const top5 = [...data].sort((a, b) => b.amp - a.amp).slice(0, 5);
        
        return {
            label: label,
            total: data.length,
            auction: auction,
            inquiry: inquiry,
            avgHigh: avgHigh,
            avgLow: avgLow,
            avgAmp: avgAmp,
            items: top5.map(d => ({
                id: d.id,
                name: d.name,
                type: d.type,
                high: d.high,
                low: d.low,
                amp: d.amp,
                status: d.status
            }))
        };
    }
    
    // 1. è‚¡æœ¬ç¶­åº¦
    const capitalRanges = [
        { label: '< 3å„„', min: 0, max: 3 },
        { label: '3~6å„„', min: 3, max: 6 },
        { label: '6~10å„„', min: 6, max: 10 },
        { label: '10~20å„„', min: 10, max: 20 },
        { label: '20~50å„„', min: 20, max: 50 },
        { label: '> 50å„„', min: 50, max: 99999 }
    ];
    
    const capitalStats = capitalRanges.map(r => {
        const filtered = allCBData.filter(d => d.capital >= r.min && d.capital < r.max);
        return calcRangeStats(filtered, r.label);
    }).filter(s => s !== null);
    
    // 2. ç™¼è¡Œè¦æ¨¡ç¶­åº¦
    const sizeRanges = [
        { label: '< 2å„„', min: 0, max: 2 },
        { label: '2~5å„„', min: 2, max: 5 },
        { label: '5~10å„„', min: 5, max: 10 },
        { label: '10~20å„„', min: 10, max: 20 },
        { label: '> 20å„„', min: 20, max: 99999 }
    ];
    
    const sizeStats = sizeRanges.map(r => {
        const filtered = allCBData.filter(d => d.issueSize >= r.min && d.issueSize < r.max);
        return calcRangeStats(filtered, r.label);
    }).filter(s => s !== null);
    
    // 3. è½‰æ›åƒ¹ç¶­åº¦
    const priceRanges = [
        { label: '< 20å…ƒ', min: 0, max: 20 },
        { label: '20~50å…ƒ', min: 20, max: 50 },
        { label: '50~100å…ƒ', min: 50, max: 100 },
        { label: '100~150å…ƒ', min: 100, max: 150 },
        { label: '150~200å…ƒ', min: 150, max: 200 },
        { label: '> 200å…ƒ', min: 200, max: 99999 }
    ];
    
    const priceStats = priceRanges.map(r => {
        const filtered = allCBData.filter(d => d.conversionPrice >= r.min && d.conversionPrice < r.max);
        return calcRangeStats(filtered, r.label);
    }).filter(s => s !== null);
    
    // 4. ä¿¡è©•ç¶­åº¦
    const ratingRanges = ['3', '4', '5', '6', '7', '8'];
    const ratingStats = ratingRanges.map(r => {
        const filtered = allCBData.filter(d => String(d.rating) === r);
        return calcRangeStats(filtered, 'TCRI ' + r);
    }).filter(s => s !== null && s.total > 0);
    
    // 5. å¹´æœŸç¶­åº¦
    const yearRanges = [
        { label: '3å¹´', min: 2.5, max: 3.5 },
        { label: '5å¹´', min: 4.5, max: 5.5 },
        { label: '7å¹´', min: 6.5, max: 7.5 }
    ];
    
    const yearStats = yearRanges.map(r => {
        const filtered = allCBData.filter(d => d.years >= r.min && d.years <= r.max);
        return calcRangeStats(filtered, r.label);
    }).filter(s => s !== null && s.total > 0);
    
    // 6. æ“”ä¿ç¶­åº¦
    const guaranteeStats = [];
    const guaranteed = allCBData.filter(d => d.guarantee && d.guarantee.includes('æœ‰'));
    const unguaranteed = allCBData.filter(d => !d.guarantee || d.guarantee.includes('ç„¡') || !d.guarantee.includes('æœ‰'));
    
    if (guaranteed.length > 0) guaranteeStats.push(calcRangeStats(guaranteed, 'æœ‰æ“”ä¿'));
    if (unguaranteed.length > 0) guaranteeStats.push(calcRangeStats(unguaranteed, 'ç„¡æ“”ä¿'));
    
    // ç”Ÿæˆæ‘˜è¦
    function genSummary(stats, dimName) {
        if (stats.length === 0) return 'æš«ç„¡è³‡æ–™';
        const sorted = [...stats].sort((a, b) => b.avgAmp - a.avgAmp);
        const best = sorted[0];
        const worst = sorted[sorted.length - 1];
        return `${best.label}æŒ¯å¹…æœ€é«˜(${best.avgAmp.toFixed(1)}%)ï¼Œ${worst.label}æŒ¯å¹…æœ€ä½(${worst.avgAmp.toFixed(1)}%)ã€‚`;
    }
    
    dimensionData = {
        capital: {
            name: 'è‚¡æœ¬',
            ranges: capitalStats,
            summary: genSummary(capitalStats, 'è‚¡æœ¬')
        },
        size: {
            name: 'ç™¼è¡Œè¦æ¨¡',
            ranges: sizeStats,
            summary: genSummary(sizeStats, 'ç™¼è¡Œè¦æ¨¡')
        },
        conversionPrice: {
            name: 'è½‰æ›åƒ¹',
            ranges: priceStats,
            summary: genSummary(priceStats, 'è½‰æ›åƒ¹')
        },
        rating: {
            name: 'ä¿¡è©•',
            ranges: ratingStats,
            summary: genSummary(ratingStats, 'ä¿¡è©•')
        },
        years: {
            name: 'å¹´æœŸ',
            ranges: yearStats,
            summary: genSummary(yearStats, 'å¹´æœŸ')
        },
        guarantee: {
            name: 'æ“”ä¿',
            ranges: guaranteeStats,
            summary: genSummary(guaranteeStats, 'æ“”ä¿')
        }
    };
    
    // é è¨­é¡¯ç¤ºè‚¡æœ¬
    showDimensionTab('capital');
}

// v3.81 é‡æ§‹ï¼šå¸‚å ´è¶¨å‹¢åˆ†æï¼ˆå®Œå…¨å‹•æ…‹å¾è³‡æ–™åº«ç”Ÿæˆï¼‰
function generateMarketTrendAnalysis() {
    // åˆä½µæ‰€æœ‰CBæ•¸æ“š
    const allCBData = [];
    
    // å¾auctionRawDataå–å¾—æ•¸æ“šï¼ˆå«openDateï¼‰
    auctionRawData.forEach(d => {
        let year = null;
        if (d.openDate) {
            if (typeof d.openDate === 'number') {
                const date = new Date((d.openDate - 25569) * 86400 * 1000);
                year = date.getFullYear();
            } else if (typeof d.openDate === 'string') {
                const parts = d.openDate.split(/[\/\-]/);
                year = parseInt(parts[0]);
                if (year < 100) year += 2000;
            }
        }
        
        const hasMarket = d.marketHigh > 0 && d.marketLow > 0;
        const amp = hasMarket ? ((d.marketHigh - d.marketLow) / d.marketLow * 100) : 0;
        
        allCBData.push({
            id: d.id,
            name: d.name || '',
            type: 'ç«¶æ‹',
            year: year,
            high: d.marketHigh || 0,
            low: d.marketLow || 0,
            amp: amp,
            hasMarket: hasMarket,
            capital: d.capital || 0,
            issueSize: d.issueSize || 0,
            conversionPrice: d.conversionPrice || 0,
            rating: d.rating || '',
            years: d.years || 0,
            guarantee: d.guarantee || '',
            industry: d.industry || '',
            broker: d.broker || '',
            isKY: ((d.name || '') + (d.companyName || '')).toUpperCase().includes('KY') || 
                  ((d.name || '') + (d.companyName || '')).toUpperCase().includes('F-')
        });
    });
    
    // å¾inquiryRawDataå–å¾—æ•¸æ“š
    inquiryRawData.forEach(d => {
        if (allCBData.find(a => a.id === d.id)) return; // é¿å…é‡è¤‡
        
        // v3.92 ä¿®æ­£ï¼šä½¿ç”¨ listDate (æ›ç‰Œæ—¥æœŸ) ä¾†å–å¾—å¹´åº¦
        let year = null;
        const dateField = d.listDate || d.openDate;
        if (dateField) {
            if (typeof dateField === 'number') {
                const date = new Date((dateField - 25569) * 86400 * 1000);
                year = date.getFullYear();
            } else if (dateField instanceof Date) {
                year = dateField.getFullYear();
            } else if (typeof dateField === 'string') {
                const parts = dateField.split(/[\/\-]/);
                year = parseInt(parts[0]);
                if (year < 100) year += 2000;
            }
        }
        
        const hasMarket = d.marketHigh > 0 && d.marketLow > 0;
        const amp = hasMarket ? ((d.marketHigh - d.marketLow) / d.marketLow * 100) : 0;
        
        allCBData.push({
            id: d.id,
            name: d.name || '',
            type: 'è©¢åœˆ',
            year: year,
            high: d.marketHigh || 0,
            low: d.marketLow || 0,
            amp: amp,
            hasMarket: hasMarket,
            capital: d.capital || 0,
            issueSize: d.issueSize || 0,
            conversionPrice: d.conversionPrice || 0,
            rating: d.rating || '',
            years: d.years || 0,
            guarantee: d.guarantee || '',
            industry: d.industry || '',
            broker: d.broker || '',
            isKY: ((d.name || '') + (d.companyName || '')).toUpperCase().includes('KY') || 
                  ((d.name || '') + (d.companyName || '')).toUpperCase().includes('F-')
        });
    });
    
    // è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—å€é–“çµ±è¨ˆ
    function calcStats(data) {
        const withMarket = data.filter(d => d.hasMarket);
        if (withMarket.length === 0) return { count: data.length, avgHigh: 0, avgLow: 0, avgAmp: 0 };
        return {
            count: data.length,
            avgHigh: withMarket.reduce((s, d) => s + d.high, 0) / withMarket.length,
            avgLow: withMarket.reduce((s, d) => s + d.low, 0) / withMarket.length,
            avgAmp: withMarket.reduce((s, d) => s + d.amp, 0) / withMarket.length
        };
    }
    
    // 1. å¹´åº¦æ•¸æ“šï¼ˆå‹•æ…‹ç”Ÿæˆ2010-ç•¶å‰å¹´ï¼‰- v3.92å¢å¼·ç‰ˆ
    const currentYear = new Date().getFullYear();
    const yearlyData = [];
    for (let y = 2010; y <= currentYear; y++) {
        const yearCB = allCBData.filter(d => d.year === y);
        const auction = yearCB.filter(d => d.type === 'ç«¶æ‹');
        const inquiry = yearCB.filter(d => d.type === 'è©¢åœˆ');
        const withMarket = yearCB.filter(d => d.hasMarket);
        const avgAmp = withMarket.length > 0 ? withMarket.reduce((s, d) => s + d.amp, 0) / withMarket.length : 0;
        const avgHigh = withMarket.length > 0 ? withMarket.reduce((s, d) => s + d.high, 0) / withMarket.length : 0;
        const avgLow = withMarket.length > 0 ? withMarket.reduce((s, d) => s + d.low, 0) / withMarket.length : 0;
        
        // æ“”ä¿çµ±è¨ˆ
        const gYear = yearCB.filter(d => d.guarantee && d.guarantee.includes('æœ‰'));
        const uYear = yearCB.filter(d => !d.guarantee || !d.guarantee.includes('æœ‰'));
        
        // ç™¼è¡Œé‡çµ±è¨ˆ
        const issueAmount = yearCB.reduce((s, d) => s + (d.issueSize || 0), 0);
        
        // æŒ¯å¹…åˆ†å¸ƒ
        const above50 = withMarket.filter(d => d.amp >= 50).length;
        const below20 = withMarket.filter(d => d.amp < 20).length;
        
        yearlyData.push({
            year: y,
            total: yearCB.length,
            auction: auction.length,
            inquiry: inquiry.length,
            guaranteed: gYear.length,
            unguaranteed: uYear.length,
            issueAmount: issueAmount,
            avgHigh: parseFloat(avgHigh.toFixed(1)),
            avgLow: parseFloat(avgLow.toFixed(1)),
            avgAmp: parseFloat(avgAmp.toFixed(1)),
            above50: above50,
            below20: below20
        });
    }
    marketTrendData.yearly = yearlyData.filter(d => d.total > 0);
    
    // 2. æ“”ä¿æ¯”è¼ƒï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const guaranteed = allCBData.filter(d => d.guarantee && d.guarantee.includes('æœ‰'));
    const unguaranteed = allCBData.filter(d => !d.guarantee || d.guarantee.includes('ç„¡') || !d.guarantee.includes('æœ‰'));
    const gStats = calcStats(guaranteed);
    const uStats = calcStats(unguaranteed);
    
    // v3.92 æ–°å¢ï¼šç”Ÿæˆå¹´åº¦æ“”ä¿æ¯”è¼ƒè³‡æ–™
    const guaranteeYearlyData = [];
    for (let y = 2019; y <= currentYear; y++) {
        const gYear = guaranteed.filter(d => d.year === y);
        const uYear = unguaranteed.filter(d => d.year === y);
        const gYearStats = calcStats(gYear);
        const uYearStats = calcStats(uYear);
        if (gYear.length > 0 || uYear.length > 0) {
            guaranteeYearlyData.push({
                year: y,
                gCount: gYear.length,
                gAmp: gYearStats.avgAmp,
                uCount: uYear.length,
                uAmp: uYearStats.avgAmp
            });
        }
    }
    
    marketTrendData.guarantee = {
        overall: {
            guaranteed: { count: gStats.count, avgHigh: gStats.avgHigh, avgLow: gStats.avgLow, avgAmp: gStats.avgAmp },
            unguaranteed: { count: uStats.count, avgHigh: uStats.avgHigh, avgLow: uStats.avgLow, avgAmp: uStats.avgAmp }
        },
        yearly: guaranteeYearlyData
    };
    
    // 3. ç™¼è¡Œè¦æ¨¡å€é–“ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const sizeRanges = [
        { label: 'å°æ–¼2å„„', min: 0, max: 2 },
        { label: '2~5å„„', min: 2, max: 5 },
        { label: '5~10å„„', min: 5, max: 10 },
        { label: '10~15å„„', min: 10, max: 15 },
        { label: '15~20å„„', min: 15, max: 20 },
        { label: 'å¤§æ–¼20å„„', min: 20, max: 99999 }
    ];
    marketTrendData.size = {
        ranges: sizeRanges.map(r => {
            const filtered = allCBData.filter(d => d.issueSize >= r.min && d.issueSize < r.max);
            const stats = calcStats(filtered);
            return { label: r.label, count: stats.count, avgHigh: stats.avgHigh, avgLow: stats.avgLow, avgAmp: stats.avgAmp };
        }).filter(r => r.count > 0)
    };
    
    // 4. è‚¡æœ¬å€é–“ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const capitalRanges = [
        { label: 'å°æ–¼3å„„', min: 0, max: 3 },
        { label: '3~6å„„', min: 3, max: 6 },
        { label: '6~10å„„', min: 6, max: 10 },
        { label: '10~15å„„', min: 10, max: 15 },
        { label: '15~20å„„', min: 15, max: 20 },
        { label: 'å¤§æ–¼20å„„', min: 20, max: 99999 }
    ];
    marketTrendData.capital = {
        ranges: capitalRanges.map(r => {
            const filtered = allCBData.filter(d => d.capital >= r.min && d.capital < r.max);
            const stats = calcStats(filtered);
            return { label: r.label, count: stats.count, avgHigh: stats.avgHigh, avgLow: stats.avgLow, avgAmp: stats.avgAmp };
        }).filter(r => r.count > 0)
    };
    
    // 5. è½‰æ›åƒ¹å€é–“ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const priceRanges = [
        { label: 'å°æ–¼20å…ƒ', min: 0, max: 20 },
        { label: '20~50å…ƒ', min: 20, max: 50 },
        { label: '50~100å…ƒ', min: 50, max: 100 },
        { label: '100~150å…ƒ', min: 100, max: 150 },
        { label: '150~200å…ƒ', min: 150, max: 200 },
        { label: 'å¤§æ–¼200å…ƒ', min: 200, max: 99999 }
    ];
    marketTrendData.conversion = {
        ranges: priceRanges.map(r => {
            const filtered = allCBData.filter(d => d.conversionPrice >= r.min && d.conversionPrice < r.max);
            const stats = calcStats(filtered);
            return { label: r.label, count: stats.count, avgHigh: stats.avgHigh, avgLow: stats.avgLow, avgAmp: stats.avgAmp };
        }).filter(r => r.count > 0)
    };
    
    // 6. ä¿¡è©•å€é–“ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const ratingRanges = [];
    for (let tcri = 1; tcri <= 8; tcri++) {
        const tcriStr = String(tcri);
        const filtered = allCBData.filter(d => {
            const r = String(d.rating || '').trim();
            return r === tcriStr || r === 'TCRI' + tcriStr || r === 'TCRI ' + tcriStr;
        });
        const stats = calcStats(filtered);
        if (stats.count > 0) {
            ratingRanges.push({
                label: 'TCRI ' + tcri,
                count: stats.count,
                avgHigh: parseFloat(stats.avgHigh.toFixed(1)),
                avgLow: parseFloat(stats.avgLow.toFixed(1)),
                avgAmp: parseFloat(stats.avgAmp.toFixed(1))
            });
        }
    }
    marketTrendData.rating = { ranges: ratingRanges };
    
    // 7. ç™¼è¡Œå¹´æœŸï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const yearRanges = [
        { label: '3å¹´æœŸ', min: 2.5, max: 3.5 },
        { label: '5å¹´æœŸ', min: 4.5, max: 5.5 },
        { label: '7å¹´æœŸ', min: 6.5, max: 7.5 }
    ];
    marketTrendData.years = {
        ranges: yearRanges.map(r => {
            const filtered = allCBData.filter(d => d.years >= r.min && d.years <= r.max);
            const stats = calcStats(filtered);
            return { label: r.label, count: stats.count, avgHigh: stats.avgHigh, avgLow: stats.avgLow, avgAmp: stats.avgAmp };
        }).filter(r => r.count > 0)
    };
    
    // 8. ç«¶æ‹vsè©¢åœˆï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const auctionCB = allCBData.filter(d => d.type === 'ç«¶æ‹');
    const inquiryCB = allCBData.filter(d => d.type === 'è©¢åœˆ');
    const aStats = calcStats(auctionCB);
    const iStats = calcStats(inquiryCB);
    
    // v3.92 æ–°å¢ï¼šç”Ÿæˆå¹´åº¦ç«¶æ‹VSè©¢åœˆæ¯”è¼ƒè³‡æ–™
    const typeYearlyData = [];
    for (let y = 2010; y <= currentYear; y++) {
        const aYear = auctionCB.filter(d => d.year === y);
        const iYear = inquiryCB.filter(d => d.year === y);
        const aYearStats = calcStats(aYear);
        const iYearStats = calcStats(iYear);
        if (aYear.length > 0 || iYear.length > 0) {
            typeYearlyData.push({
                year: y,
                aCount: aYear.length,
                aAmp: aYearStats.avgAmp,
                iCount: iYear.length,
                iAmp: iYearStats.avgAmp
            });
        }
    }
    
    marketTrendData.type = {
        auction: { count: aStats.count, avgHigh: aStats.avgHigh, avgLow: aStats.avgLow, avgAmp: aStats.avgAmp },
        inquiry: { count: iStats.count, avgHigh: iStats.avgHigh, avgLow: iStats.avgLow, avgAmp: iStats.avgAmp },
        yearly: typeYearlyData
    };
    
    // 9. ç™¼è¡Œæ¬¡æ•¸åˆ†æï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const issueNumData = [];
    for (let num = 1; num <= 10; num++) {
        // å¾CBåç¨±æœ«å°¾æå–ç™¼è¡Œæ¬¡æ•¸ï¼ˆå¦‚ï¼šä½³å¿…çªä¸‰â†’3ï¼‰
        const numChar = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'][num];
        const filtered = allCBData.filter(d => {
            const name = d.name || '';
            return name.endsWith(numChar) || name.endsWith(num + 'K') || name.endsWith(numChar + 'K');
        });
        const stats = calcStats(filtered);
        if (stats.count > 0) {
            issueNumData.push({
                num: num,
                total: filtered.length,
                count: filtered.filter(d => d.hasMarket).length,
                avgHigh: parseFloat(stats.avgHigh.toFixed(1)),
                avgLow: parseFloat(stats.avgLow.toFixed(1)),
                avgAmp: parseFloat(stats.avgAmp.toFixed(1))
            });
        }
    }
    marketTrendData.issueNum = { byNumber: issueNumData, yearly: [] };
    
    // 10. KYè‚¡åˆ†æï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰
    const kyCB = allCBData.filter(d => d.isKY);
    const nonKyCB = allCBData.filter(d => !d.isKY);
    const kyStats = calcStats(kyCB);
    const nonKyStats = calcStats(nonKyCB);
    
    // v3.92 æ–°å¢ï¼šç”ŸæˆKYè‚¡å¹´åº¦è³‡æ–™
    const kyYearlyData = [];
    for (let y = 2010; y <= currentYear; y++) {
        const kyYear = kyCB.filter(d => d.year === y);
        const nonKyYear = nonKyCB.filter(d => d.year === y);
        const totalYear = kyYear.length + nonKyYear.length;
        
        if (totalYear > 0) {
            const kyYearStats = calcStats(kyYear);
            const nonKyYearStats = calcStats(nonKyYear);
            kyYearlyData.push({
                year: y,
                total: totalYear,
                ky: kyYear.length,
                nonKy: nonKyYear.length,
                kyRatio: (kyYear.length / totalYear) * 100,
                kyAmp: kyYearStats.avgAmp || 0,
                nonKyAmp: nonKyYearStats.avgAmp || 0
            });
        }
    }
    
    marketTrendData.ky = {
        overall: {
            ky: { count: kyStats.count, avgHigh: kyStats.avgHigh, avgLow: kyStats.avgLow, avgAmp: kyStats.avgAmp },
            nonKy: { count: nonKyStats.count, avgHigh: nonKyStats.avgHigh, avgLow: nonKyStats.avgLow, avgAmp: nonKyStats.avgAmp }
        },
        yearly: kyYearlyData
    };
    
    // 11. v3.92 æ–°å¢ï¼šç”¢æ¥­åˆ†æï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰- æ’é™¤æœªçŸ¥è³‡æ–™
    const industryMap = {};
    allCBData.forEach(d => {
        const ind = (d.industry || '').trim();
        // æ’é™¤ç©ºç™½ã€æœªåˆ†é¡ã€æœªçŸ¥ç­‰ç„¡æ•ˆè³‡æ–™
        if (!ind || ind === 'æœªåˆ†é¡' || ind === 'æœªçŸ¥' || ind === '-') return;
        
        if (!industryMap[ind]) {
            industryMap[ind] = { count: 0, auction: 0, inquiry: 0, ampSum: 0, ampCount: 0, highSum: 0, lowSum: 0 };
        }
        industryMap[ind].count++;
        if (d.type === 'ç«¶æ‹') industryMap[ind].auction++;
        if (d.type === 'è©¢åœˆ') industryMap[ind].inquiry++;
        if (d.hasMarket) {
            industryMap[ind].ampSum += d.amp;
            industryMap[ind].highSum += d.high;
            industryMap[ind].lowSum += d.low;
            industryMap[ind].ampCount++;
        }
    });
    
    const validIndustryCount = Object.values(industryMap).reduce((s, d) => s + d.count, 0);
    const industryData = Object.entries(industryMap)
        .map(([name, data]) => ({
            name: name,
            count: data.count,
            auction: data.auction,
            inquiry: data.inquiry,
            avgHigh: data.ampCount > 0 ? data.highSum / data.ampCount : 0,
            avgLow: data.ampCount > 0 ? data.lowSum / data.ampCount : 0,
            avgAmp: data.ampCount > 0 ? data.ampSum / data.ampCount : 0,
            ratio: (data.count / validIndustryCount * 100)
        }))
        .sort((a, b) => b.count - a.count);
    
    marketTrendData.industry = industryData;
    
    // 12. v3.92 æ–°å¢ï¼šåˆ¸å•†åˆ†æï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰- æ’é™¤æœªçŸ¥è³‡æ–™
    const brokerMap = {};
    allCBData.forEach(d => {
        const broker = (d.broker || '').trim();
        // æ’é™¤ç©ºç™½ã€æœªçŸ¥ç­‰ç„¡æ•ˆè³‡æ–™
        if (!broker || broker === 'æœªçŸ¥' || broker === '-') return;
        
        if (!brokerMap[broker]) {
            brokerMap[broker] = { count: 0, auction: 0, inquiry: 0, ampSum: 0, ampCount: 0, highSum: 0, lowSum: 0 };
        }
        brokerMap[broker].count++;
        if (d.type === 'ç«¶æ‹') brokerMap[broker].auction++;
        if (d.type === 'è©¢åœˆ') brokerMap[broker].inquiry++;
        if (d.hasMarket) {
            brokerMap[broker].ampSum += d.amp;
            brokerMap[broker].highSum += d.high;
            brokerMap[broker].lowSum += d.low;
            brokerMap[broker].ampCount++;
        }
    });
    
    const validBrokerCount = Object.values(brokerMap).reduce((s, d) => s + d.count, 0);
    const brokerData = Object.entries(brokerMap)
        .map(([name, data]) => ({
            name: name,
            count: data.count,
            auction: data.auction,
            inquiry: data.inquiry,
            avgHigh: data.ampCount > 0 ? data.highSum / data.ampCount : 0,
            avgLow: data.ampCount > 0 ? data.lowSum / data.ampCount : 0,
            avgAmp: data.ampCount > 0 ? data.ampSum / data.ampCount : 0,
            ratio: (data.count / validBrokerCount * 100)
        }))
        .sort((a, b) => b.count - a.count);
    
    marketTrendData.broker = brokerData;
    
    // é¡¯ç¤ºé è¨­Tab
    showMarketTrendTab('supply');
}

// v3.81 æ–°å¢ï¼šå³å´å€å¡Šå±•é–‹/æ”¶åˆåŠŸèƒ½
function toggleRightSection(sectionId, headerElement) {
    const content = document.getElementById(sectionId);
    if (!content) return;
    
    const isCollapsed = content.classList.contains('collapsed');
    
    if (isCollapsed) {
        // å±•é–‹
        content.classList.remove('collapsed');
        content.style.maxHeight = '800px'; // çµ¦è¶³å¤ é«˜åº¦
        headerElement.classList.remove('collapsed');
        
        // ç‰¹æ®Šè™•ç†ï¼šå±•é–‹åƒ¹æ ¼èµ°å‹¢å€å¡Šæ™‚è‡ªå‹•è¼‰å…¥ç¬¬ä¸€ç­†è³‡æ–™
        if (sectionId === 'priceTrendSection') {
            setTimeout(() => {
                const select = document.getElementById('priceTrendCBSelect');
                if (select && select.options.length > 1 && !select.value) {
                    select.selectedIndex = 1; // é¸æ“‡ç¬¬ä¸€ç­†CB
                    loadPriceTrend(select.value);
                }
            }, 100);
        }
        
        // ç‰¹æ®Šè™•ç†ï¼šå±•é–‹åŸºæœ¬è³‡æ–™å€å¡Šæ™‚è‡ªå‹•è¼‰å…¥ç¬¬ä¸€ç­†è³‡æ–™
        if (sectionId === 'basicInfoSection') {
            setTimeout(() => {
                const select = document.getElementById('basicInfoCBSelect');
                if (select && select.options.length > 1 && !select.value) {
                    select.selectedIndex = 1; // é¸æ“‡ç¬¬ä¸€ç­†CB
                    loadBasicInfo(select.value);
                }
            }, 100);
        }
    } else {
        // æ”¶åˆ
        content.style.maxHeight = content.scrollHeight + 'px';
        setTimeout(() => {
            content.classList.add('collapsed');
            content.style.maxHeight = '0';
            headerElement.classList.add('collapsed');
        }, 10);
    }
}

// ==========================================
// v3.96 æ–°å¢ï¼šé€šç”¨è¡¨æ ¼æ’åºåŠŸèƒ½
// ==========================================
function enableTableSort(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const headers = table.querySelectorAll('th.sortable');
    headers.forEach((th, colIndex) => {
        th.addEventListener('click', () => sortTable(table, colIndex, th));
    });
}

function sortTable(table, colIndex, th) {
    const tbody = table.querySelector('tbody') || table;
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.classList.contains('total-row') && row.querySelector('td'));
    
    // åˆ¤æ–·ç›®å‰æ’åºæ–¹å‘
    const isAsc = th.classList.contains('sort-asc');
    const isDesc = th.classList.contains('sort-desc');
    
    // æ¸…é™¤æ‰€æœ‰è¡¨é ­çš„æ’åºç‹€æ…‹
    table.querySelectorAll('th').forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
    });
    
    // è¨­å®šæ–°çš„æ’åºæ–¹å‘
    let direction = 'desc'; // é è¨­é™åº
    if (isDesc) {
        direction = 'asc';
        th.classList.add('sort-asc');
    } else {
        th.classList.add('sort-desc');
    }
    
    // æ’åº
    rows.sort((a, b) => {
        const cellA = a.querySelectorAll('td')[colIndex];
        const cellB = b.querySelectorAll('td')[colIndex];
        if (!cellA || !cellB) return 0;
        
        let valA = cellA.textContent.trim();
        let valB = cellB.textContent.trim();
        
        // ç§»é™¤ç™¾åˆ†æ¯”ã€å…ƒç­‰å–®ä½
        valA = valA.replace(/[%å…ƒå„„å¹´æª”æ¬¡,\s]/g, '').replace(/[ï¼ˆ(].*[ï¼‰)]/g, '');
        valB = valB.replace(/[%å…ƒå„„å¹´æª”æ¬¡,\s]/g, '').replace(/[ï¼ˆ(].*[ï¼‰)]/g, '');
        
        // å˜—è©¦è½‰ç‚ºæ•¸å­—
        const numA = parseFloat(valA);
        const numB = parseFloat(valB);
        
        if (!isNaN(numA) && !isNaN(numB)) {
            return direction === 'asc' ? numA - numB : numB - numA;
        }
        
        // å­—ä¸²æ¯”è¼ƒ
        return direction === 'asc' ? valA.localeCompare(valB, 'zh-TW') : valB.localeCompare(valA, 'zh-TW');
    });
    
    // é‡æ–°æ’åˆ—è¡Œ
    const totalRow = tbody.querySelector('tr.total-row');
    rows.forEach(row => tbody.appendChild(row));
    if (totalRow) tbody.appendChild(totalRow); // åˆè¨ˆè¡Œå§‹çµ‚åœ¨æœ€å¾Œ
}

// ç‚ºå‹•æ…‹ç”Ÿæˆçš„è¡¨æ ¼å•Ÿç”¨æ’åº
function initTableSortForContent() {
    const tables = document.querySelectorAll('#marketTrendContent .trend-year-table');
    tables.forEach((table, idx) => {
        table.id = 'trendTable_' + idx;
        enableTableSort(table.id);
    });
}

function showMarketTrendTab(tab, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // æ›´æ–°Tabç‹€æ…‹
    document.querySelectorAll('.market-trend-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.market-trend-tab').forEach(t => {
        const tabMap = {
            'supply': 'ä¾›çµ¦åˆ†æ',
            'yearly': 'å¹´åº¦è¶¨å‹¢',
            'industry': 'ç”¢æ¥­åˆ†æ',
            'broker': 'åˆ¸å•†åˆ†æ',
            'guarantee': 'æ“”ä¿æ¯”è¼ƒ',
            'size': 'ç™¼è¡Œè¦æ¨¡',
            'capital': 'è‚¡æœ¬å¤§å°',
            'conversion': 'è½‰æ›åƒ¹',
            'rating': 'ä¿¡è©•',
            'yearPeriod': 'ç™¼è¡Œå¹´æœŸ',
            'type': 'ç«¶æ‹vsè©¢åœˆ',
            'issueNum': 'ç™¼è¡Œæ¬¡æ•¸',
            'ky': 'KYè‚¡åˆ†æ'
        };
        if (t.textContent.includes(tabMap[tab])) {
            t.classList.add('active');
        }
    });
    
    const content = document.getElementById('marketTrendContent');
    let html = '';
    
    if (tab === 'supply') {
        html = renderSupplyAnalysis();
    } else if (tab === 'yearly') {
        html = renderYearlyTrend();
    } else if (tab === 'industry') {
        html = renderIndustryAnalysis();
    } else if (tab === 'broker') {
        html = renderBrokerAnalysis();
    } else if (tab === 'guarantee') {
        html = renderGuaranteeCompare();
    } else if (tab === 'size') {
        html = renderSizeCompare();
    } else if (tab === 'capital') {
        html = renderCapitalCompare();
    } else if (tab === 'conversion') {
        html = renderConversionCompare();
    } else if (tab === 'rating') {
        html = renderRatingCompare();
    } else if (tab === 'yearPeriod') {
        html = renderYearPeriodCompare();
    } else if (tab === 'type') {
        html = renderTypeCompare();
    } else if (tab === 'issueNum') {
        html = renderIssueNumAnalysis();
    } else if (tab === 'ky') {
        html = renderKYAnalysis();
    }
    
    content.innerHTML = html;
    
    // v3.96 æ–°å¢ï¼šå•Ÿç”¨è¡¨æ ¼æ’åºåŠŸèƒ½
    setTimeout(() => initTableSortForContent(), 100);
}

function renderYearlyTrend() {
    const data = marketTrendData.yearly;
    if (!data || data.length === 0) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ“Š å„å¹´åº¦ç™¼è¡Œçµ±è¨ˆèˆ‡ç¸¾æ•ˆåˆ†æï¼ˆ2010-2025ï¼‰</div>
    <div class="trend-table-wrapper">
    <table class="trend-year-table">
        <tr>
            <th class="sortable">å¹´åº¦</th>
            <th class="sortable">ç¸½æª”æ•¸</th>
            <th class="sortable">ç™¼è¡Œé‡(å„„)</th>
            <th class="sortable">æœ‰æ“”ä¿</th>
            <th class="sortable">ç„¡æ“”ä¿</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    let totalAll = 0, totalAmount = 0, totalGuaranteed = 0, totalUnguaranteed = 0;
    let sumHigh = 0, sumLow = 0, countWithMarket = 0;
    data.forEach(d => {
        const ampClass = d.avgAmp >= 80 ? 'amp-high' : (d.avgAmp < 30 ? 'amp-low' : '');
        const gRatio = d.total > 0 ? (d.guaranteed / d.total * 100).toFixed(0) : 0;
        const uRatio = d.total > 0 ? (d.unguaranteed / d.total * 100).toFixed(0) : 0;
        html += `
        <tr>
            <td class="year-cell">${d.year}å¹´</td>
            <td><b>${d.total}</b></td>
            <td>${d.issueAmount > 0 ? d.issueAmount.toFixed(0) : '-'}</td>
            <td style="color:#2e7d32;">${d.guaranteed}(${gRatio}%)</td>
            <td style="color:#e65100;">${d.unguaranteed}(${uRatio}%)</td>
            <td style="color:#2e7d32;">${d.avgHigh > 0 ? d.avgHigh.toFixed(1) : '-'}</td>
            <td style="color:#c62828;">${d.avgLow > 0 ? d.avgLow.toFixed(1) : '-'}</td>
            <td class="${ampClass}">${d.avgAmp > 0 ? d.avgAmp.toFixed(1) + '%' : '-'}</td>
        </tr>`;
        totalAll += d.total;
        totalAmount += d.issueAmount || 0;
        totalGuaranteed += d.guaranteed || 0;
        totalUnguaranteed += d.unguaranteed || 0;
        if (d.avgHigh > 0) { sumHigh += d.avgHigh; countWithMarket++; }
        if (d.avgLow > 0) { sumLow += d.avgLow; }
    });
    
    // åˆè¨ˆåˆ—
    const gRatioTotal = totalAll > 0 ? (totalGuaranteed / totalAll * 100).toFixed(0) : 0;
    const uRatioTotal = totalAll > 0 ? (totalUnguaranteed / totalAll * 100).toFixed(0) : 0;
    const avgHighTotal = countWithMarket > 0 ? (sumHigh / countWithMarket).toFixed(1) : '-';
    const avgLowTotal = countWithMarket > 0 ? (sumLow / countWithMarket).toFixed(1) : '-';
    html += `
        <tr class="total-row">
            <td><b>å¹³å‡</b></td>
            <td><b>${totalAll}</b></td>
            <td><b>${totalAmount.toFixed(0)}</b></td>
            <td style="color:#2e7d32;"><b>${totalGuaranteed}(${gRatioTotal}%)</b></td>
            <td style="color:#e65100;"><b>${totalUnguaranteed}(${uRatioTotal}%)</b></td>
            <td style="color:#2e7d32;"><b>${avgHighTotal}</b></td>
            <td style="color:#c62828;"><b>${avgLowTotal}</b></td>
            <td>-</td>
        </tr>`;
    
    html += `</table></div>`;
    
    // è¶¨å‹¢æ´å¯Ÿ
    const peak = data.reduce((max, d) => d.avgAmp > max.avgAmp ? d : max, data[0]);
    const peakCount = data.reduce((max, d) => d.total > max.total ? d : max, data[0]);
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”è¶¨å‹¢è§€å¯Ÿ</div>
        <div class="insight-content">
            ç™¼è¡Œé‡é«˜å³°ç‚º${peakCount.year}å¹´(${peakCount.total}æª”)ï¼ŒæŒ¯å¹…é«˜å³°ç‚º${peak.year}å¹´(${peak.avgAmp.toFixed(1)}%)ã€‚<br>
            æœ‰æ“”ä¿CBæ•´é«”å æ¯”${gRatioTotal}%ï¼ŒæŒ¯å¹…è¡¨ç¾é€šå¸¸è¼ƒç©©å®šä½†åä½ã€‚<br>
            è¿‘å¹´ç„¡æ“”ä¿æ¯”ä¾‹æé«˜ï¼Œå¸‚å ´æ³¢å‹•åŠ å¤§ï¼Œé¸è‚¡éœ€æ›´è¬¹æ…è©•ä¼°ä¿¡ç”¨é¢¨éšªã€‚
        </div>
    </div>`;
    
    return html;
}

function renderGuaranteeCompare() {
    const overall = marketTrendData.guarantee.overall;
    const yearly = marketTrendData.guarantee.yearly;
    
    const g = overall.guaranteed;
    const u = overall.unguaranteed;
    
    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ“Š æ•´é«”æ“”ä¿æ¯”è¼ƒï¼ˆå…¨éƒ¨å¹´åº¦ï¼‰</div>
    <div class="trend-compare-grid">
        <div class="trend-compare-card">
            <h4>ğŸ›¡ï¸ æœ‰æ“”ä¿</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æª”æ•¸</span>
                <span class="trend-compare-value">${g.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡é«˜</span>
                <span class="trend-compare-value">${g.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡ä½</span>
                <span class="trend-compare-value">${g.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">å¹³å‡æŒ¯å¹…</span>
                <span class="trend-compare-value ${g.avgAmp > u.avgAmp ? 'positive' : ''}">${g.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
        <div class="trend-compare-card">
            <h4>ğŸ“‹ ç„¡æ“”ä¿</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æª”æ•¸</span>
                <span class="trend-compare-value">${u.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡é«˜</span>
                <span class="trend-compare-value">${u.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡ä½</span>
                <span class="trend-compare-value">${u.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">å¹³å‡æŒ¯å¹…</span>
                <span class="trend-compare-value ${u.avgAmp > g.avgAmp ? 'positive' : ''}">${u.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
    </div>`;
    
    // åŠ å…¥å¤šå¹´åº¦è¡¨æ ¼
    if (yearly && yearly.length > 0) {
        html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin:15px 0 10px 0;">ğŸ“ˆ å„å¹´åº¦ æœ‰æ“”ä¿ vs ç„¡æ“”ä¿ æŒ¯å¹…æ¯”è¼ƒ</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">å¹´åº¦</th>
            <th class="sortable">æœ‰æ“”ä¿</th>
            <th class="sortable">æŒ¯å¹…</th>
            <th class="sortable">ç„¡æ“”ä¿</th>
            <th class="sortable">æŒ¯å¹…</th>
            <th>å‹å‡º</th>
        </tr>`;
        
        yearly.forEach(y => {
            const winner = y.gAmp > y.uAmp ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
            const winnerColor = winner === 'æœ‰æ“”ä¿' ? '#2e7d32' : '#1565c0';
            html += `
        <tr>
            <td class="year-cell">${y.year}å¹´</td>
            <td>${y.gCount}</td>
            <td class="${y.gAmp > y.uAmp ? 'amp-high' : ''}">${y.gAmp.toFixed(1)}%</td>
            <td>${y.uCount}</td>
            <td class="${y.uAmp > y.gAmp ? 'amp-high' : ''}">${y.uAmp.toFixed(1)}%</td>
            <td style="color:${winnerColor}; font-weight:bold;">${winner}</td>
        </tr>`;
        });
        html += `</table>`;
    }
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            æ•´é«”<strong>æœ‰æ“”ä¿(77.0%)</strong>æŒ¯å¹…é«˜æ–¼ç„¡æ“”ä¿(63.4%)ã€‚
            ä½†å„å¹´åº¦è¡¨ç¾ä¸ä¸€ï¼Œ2020/2022/2024å¹´ç„¡æ“”ä¿åè€Œè¼ƒä½³ã€‚
            æœ‰æ“”ä¿æä¾›è¼ƒé«˜å®‰å…¨é‚Šéš›ï¼Œé©åˆç©©å¥å‹æŠ•è³‡äººã€‚
        </div>
    </div>`;
    
    return html;
}

function renderSizeCompare() {
    const ranges = marketTrendData.size.ranges;
    if (!ranges || ranges.length === 0) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ“Š ç™¼è¡Œè¦æ¨¡å€é–“çµ±è¨ˆï¼ˆå…¨éƒ¨å¹´åº¦ï¼Œä¾05å·¥ä½œè¡¨è¨­å®šï¼‰</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">è¦æ¨¡å€é–“</th>
            <th class="sortable">æª”æ•¸</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    const maxAmp = Math.max(...ranges.map(r => r.avgAmp));
    ranges.forEach(r => {
        const ampClass = r.avgAmp === maxAmp ? 'amp-high' : (r.avgAmp < 65 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh.toFixed(1)}</td>
            <td>${r.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${r.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            <strong>å°æ–¼2å„„(88.1%)</strong>æŒ¯å¹…æœ€é«˜ï¼Œ2~10å„„ç‚ºç”œèœœå€é–“(70-71%)ã€‚
            è¦æ¨¡è¶Šå¤§æŒ¯å¹…è¶Šä½ï¼Œä½†å¤§è¦æ¨¡(>20å„„)ä»æœ‰63.7%ï¼Œæµå‹•æ€§è¼ƒä½³ã€‚
            é¸è‚¡æ™‚å¯å„ªå…ˆè€ƒæ…®2~10å„„çš„ä¸­å°è¦æ¨¡CBã€‚
        </div>
    </div>`;
    
    return html;
}

function renderCapitalCompare() {
    const ranges = marketTrendData.capital.ranges;
    if (!ranges || ranges.length === 0) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ“Š è‚¡æœ¬å€é–“çµ±è¨ˆï¼ˆå…¨éƒ¨å¹´åº¦ï¼Œä¾05å·¥ä½œè¡¨è¨­å®šï¼‰</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">è‚¡æœ¬å€é–“</th>
            <th class="sortable">æª”æ•¸</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    const maxAmp = Math.max(...ranges.map(r => r.avgAmp));
    ranges.forEach(r => {
        const ampClass = r.avgAmp === maxAmp ? 'amp-high' : (r.avgAmp < 60 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh.toFixed(1)}</td>
            <td>${r.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${r.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            <strong>6~10å„„(79.8%)</strong>æŒ¯å¹…æœ€é«˜ï¼Œç‚ºæœ€ä½³è‚¡æœ¬å€é–“ã€‚
            å°è‚¡æœ¬(<6å„„)å› è‚¡åƒ¹æ³¢å‹•å¤§ï¼Œåè€ŒæŒ¯å¹…è¼ƒä½(55-58%)ã€‚
            å¤§è‚¡æœ¬(>20å„„)ä¼æ¥­é€šå¸¸è¼ƒç©©å®šï¼ŒæŒ¯å¹…é©ä¸­(66.9%)ã€‚
        </div>
    </div>`;
    
    return html;
}

// v3.59 æ–°å¢ï¼šè½‰æ›åƒ¹å€é–“åˆ†æ
function renderConversionCompare() {
    const ranges = marketTrendData.conversion.ranges;
    if (!ranges || ranges.length === 0) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ“Š è½‰æ›åƒ¹å€é–“çµ±è¨ˆï¼ˆå…¨éƒ¨å¹´åº¦ï¼Œä¾05å·¥ä½œè¡¨è¨­å®šï¼‰</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">è½‰æ›åƒ¹å€é–“</th>
            <th class="sortable">æª”æ•¸</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    const maxAmp = Math.max(...ranges.map(r => r.avgAmp));
    ranges.forEach(r => {
        const ampClass = r.avgAmp === maxAmp ? 'amp-high' : (r.avgAmp < 60 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh.toFixed(1)}</td>
            <td>${r.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${r.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            <strong>ä½è½‰æ›åƒ¹(<50å…ƒ)</strong>æŒ¯å¹…è¼ƒé«˜(74-77%)ï¼Œä¸»å› ä½åƒ¹è‚¡æ³¢å‹•ç©ºé–“å¤§ã€‚
            è½‰æ›åƒ¹150~200å…ƒæŒ¯å¹…æœ€ä½(52.7%)ï¼Œé«˜åƒ¹è‚¡ç›¸å°ç©©å®šã€‚
            è½‰æ›åƒ¹>200å…ƒåè€Œå›å‡è‡³57.2%ï¼Œå¯èƒ½å› å¤šç‚ºå„ªè³ªé«˜æˆé•·è‚¡ã€‚
        </div>
    </div>`;
    
    return html;
}

// v3.59 æ–°å¢ï¼šä¿¡è©•å€é–“åˆ†æ
function renderRatingCompare() {
    const ranges = marketTrendData.rating.ranges;
    if (!ranges || ranges.length === 0) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ“Š ä¿¡è©•å€é–“çµ±è¨ˆï¼ˆå¾00å·¥ä½œè¡¨Eæ¬„å‹•æ…‹è¨ˆç®—ï¼‰</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">ä¿¡è©•ç­‰ç´š</th>
            <th class="sortable">æª”æ•¸</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    const validRanges = ranges.filter(r => r.count > 0 && r.avgAmp > 0);
    const maxAmp = validRanges.length > 0 ? Math.max(...validRanges.map(r => r.avgAmp)) : 0;
    const minAmp = validRanges.length > 0 ? Math.min(...validRanges.map(r => r.avgAmp)) : 0;
    
    ranges.forEach(r => {
        if (r.count === 0) return;
        const ampClass = r.avgAmp === maxAmp ? 'amp-high' : (r.avgAmp === minAmp && r.avgAmp > 0 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh > 0 ? r.avgHigh.toFixed(1) : '-'}</td>
            <td>${r.avgLow > 0 ? r.avgLow.toFixed(1) : '-'}</td>
            <td class="${ampClass}">${r.avgAmp > 0 ? r.avgAmp.toFixed(1) + '%' : '-'}</td>
        </tr>`;
    });
    html += `</table>`;
    
    // å‹•æ…‹ç”Ÿæˆçµè«–
    let bestRange = validRanges.length > 0 ? validRanges.reduce((a, b) => a.avgAmp > b.avgAmp ? a : b) : null;
    let mostRange = validRanges.length > 0 ? validRanges.reduce((a, b) => a.count > b.count ? a : b) : null;
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            ${bestRange ? `<strong>${bestRange.label}(${bestRange.avgAmp.toFixed(1)}%)</strong>æŒ¯å¹…æœ€é«˜${bestRange.count < 30 ? 'ä½†æ¨£æœ¬è¼ƒå°‘(' + bestRange.count + 'æª”)' : '(' + bestRange.count + 'æª”)'}ã€‚` : ''}
            ${mostRange && mostRange !== bestRange ? `<strong>${mostRange.label}(${mostRange.avgAmp.toFixed(1)}%/${mostRange.count}æª”)</strong>æ¨£æœ¬æ•¸æœ€å¤šï¼Œå¯ä½œç‚ºä¸»è¦åƒè€ƒã€‚` : ''}
            ä¿¡è©•ç­‰ç´šè¶Šä½ï¼ˆæ•¸å­—è¶Šå¤§ï¼‰ï¼Œé€šå¸¸ä»£è¡¨ä¿¡ç”¨é¢¨éšªè¼ƒé«˜ï¼Œéœ€è¬¹æ…è©•ä¼°ã€‚
        </div>
    </div>`;
    
    return html;
}

// v3.59 æ–°å¢ï¼šç™¼è¡Œå¹´æœŸåˆ†æ
function renderYearPeriodCompare() {
    const ranges = marketTrendData.years.ranges;
    if (!ranges || ranges.length === 0) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ“Š ç™¼è¡Œå¹´æœŸçµ±è¨ˆï¼ˆå…¨éƒ¨å¹´åº¦ï¼Œä¾05å·¥ä½œè¡¨è¨­å®šï¼‰</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">ç™¼è¡Œå¹´æœŸ</th>
            <th class="sortable">æª”æ•¸</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    ranges.forEach(r => {
        const ampClass = r.avgAmp > 80 ? 'amp-high' : (r.avgAmp < 65 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh.toFixed(1)}</td>
            <td>${r.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${r.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            <strong>5å¹´æœŸ(86.9%)</strong>æŒ¯å¹…æœ€ä½³ï¼Œç‚ºCBç™¼è¡Œçš„é»ƒé‡‘å¹´æœŸã€‚
            3å¹´æœŸç‚ºä¸»æµ(1047æª”)ï¼ŒæŒ¯å¹…62.2%ç›¸å°ç©©å¥ã€‚
            7å¹´æœŸç›®å‰åƒ…1æª”(æ–°å”ä¸€)ï¼ŒæŒ¯å¹…363.9%ç‚ºç‰¹ä¾‹ï¼Œä¸å…·çµ±è¨ˆæ„ç¾©ã€‚
        </div>
    </div>`;
    
    return html;
}

function renderTypeCompare() {
    const a = marketTrendData.type.auction;
    const i = marketTrendData.type.inquiry;
    
    const winner = a.avgAmp > i.avgAmp ? 'ç«¶æ‹' : 'è©¢åœˆ';
    const diff = Math.abs(a.avgAmp - i.avgAmp).toFixed(1);
    
    let html = `
    <div class="trend-compare-grid">
        <div class="trend-compare-card">
            <h4>ğŸ¯ ç«¶æ‹</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æª”æ•¸</span>
                <span class="trend-compare-value">${a.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡é«˜</span>
                <span class="trend-compare-value">${a.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡ä½</span>
                <span class="trend-compare-value">${a.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">å¹³å‡æŒ¯å¹…</span>
                <span class="trend-compare-value ${a.avgAmp > i.avgAmp ? 'positive' : ''}">${a.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
        <div class="trend-compare-card">
            <h4>ğŸ“‹ è©¢åœˆ</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æª”æ•¸</span>
                <span class="trend-compare-value">${i.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡é«˜</span>
                <span class="trend-compare-value">${i.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡ä½</span>
                <span class="trend-compare-value">${i.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">å¹³å‡æŒ¯å¹…</span>
                <span class="trend-compare-value ${i.avgAmp > a.avgAmp ? 'positive' : ''}">${i.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
    </div>`;
    
    // v3.92 æ–°å¢ï¼šå¹´åº¦ç«¶æ‹VSè©¢åœˆæ¯”è¼ƒè¡¨æ ¼
    const yearly = marketTrendData.type.yearly;
    if (yearly && yearly.length > 0) {
        html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin:15px 0 10px 0;">ğŸ“ˆ å„å¹´åº¦ ç«¶æ‹ vs è©¢åœˆ æŒ¯å¹…æ¯”è¼ƒ</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">å¹´åº¦</th>
            <th class="sortable">ç«¶æ‹</th>
            <th class="sortable">æŒ¯å¹…</th>
            <th class="sortable">è©¢åœˆ</th>
            <th class="sortable">æŒ¯å¹…</th>
            <th>å‹å‡º</th>
        </tr>`;
        
        yearly.forEach(y => {
            const winner = y.aAmp > y.iAmp ? 'ç«¶æ‹' : (y.iAmp > y.aAmp ? 'è©¢åœˆ' : '-');
            const winnerColor = winner === 'ç«¶æ‹' ? '#e65100' : '#1565c0';
            html += `
        <tr>
            <td class="year-cell">${y.year}å¹´</td>
            <td style="color:#e65100;">${y.aCount > 0 ? y.aCount : '-'}</td>
            <td class="${y.aAmp > y.iAmp ? 'amp-high' : ''}">${y.aCount > 0 ? y.aAmp.toFixed(1) + '%' : '-'}</td>
            <td style="color:#1565c0;">${y.iCount > 0 ? y.iCount : '-'}</td>
            <td class="${y.iAmp > y.aAmp ? 'amp-high' : ''}">${y.iCount > 0 ? y.iAmp.toFixed(1) + '%' : '-'}</td>
            <td style="color:${winnerColor}; font-weight:bold;">${winner}</td>
        </tr>`;
        });
        html += `</table>`;
    }
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            <strong>${winner}</strong>æ•´é«”æŒ¯å¹…è¼ƒé«˜ï¼Œå·®è·${diff}%ã€‚
            ${winner === 'è©¢åœˆ' ? 'è©¢åœˆæ¡ˆä¾‹æ•¸æ“šé‡å¤§(æ¶µè“‹æ­·å¹´)ï¼Œè¡¨ç¾å„ªæ–¼ç«¶æ‹ã€‚ä½†2019å¹´å¾Œç«¶æ‹åˆ¶åº¦ä¸Šè·¯ï¼Œè¿‘å¹´æ•¸æ“šé ˆåˆ†é–‹è§€å¯Ÿã€‚' : 'ç«¶æ‹é€éå…¬é–‹æ‹è³£å–å¾—ç±Œç¢¼ï¼Œå¸‚å ´å°å…¶å®šåƒ¹è¼ƒç‚ºç†æ€§ã€‚'}
        </div>
    </div>`;
    
    return html;
}

// v3.59 æ–°å¢ï¼šç™¼è¡Œæ¬¡æ•¸åˆ†æ
function renderIssueNumAnalysis() {
    const data = marketTrendData.issueNum;
    if (!data) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ“Š å„ç™¼è¡Œæ¬¡æ•¸æ›ç‰Œè¡¨ç¾ï¼ˆå…¨éƒ¨å¹´åº¦ï¼Œå®Œæ•´åˆ°ç¬¬10æ¬¡ï¼‰</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">ç™¼è¡Œæ¬¡æ•¸</th>
            <th class="sortable">ç¸½æª”æ•¸</th>
            <th class="sortable">æœ‰æ›ç‰Œ</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    const byNum = data.byNumber;
    byNum.forEach(d => {
        const ampClass = d.avgAmp >= 80 ? 'amp-high' : (d.avgAmp < 65 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">ç¬¬${d.num}æ¬¡</td>
            <td>${d.total}</td>
            <td>${d.count}</td>
            <td>${d.avgHigh.toFixed(1)}</td>
            <td>${d.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${d.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;
    
    // å¹´åº¦é¦–ç™¼ vs å¤šæ¬¡ç™¼è¡Œæ¯”è¼ƒï¼ˆå¤šå¹´åº¦ï¼‰
    html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin:15px 0 10px 0;">ğŸ“ˆ å„å¹´åº¦ é¦–æ¬¡ç™¼è¡Œ vs å¤šæ¬¡ç™¼è¡Œï¼ˆ2010-2025ï¼‰</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">å¹´åº¦</th>
            <th class="sortable">é¦–ç™¼</th>
            <th class="sortable">é¦–ç™¼æŒ¯å¹…</th>
            <th class="sortable">å¤šæ¬¡</th>
            <th class="sortable">å¤šæ¬¡æŒ¯å¹…</th>
            <th>å‹å‡º</th>
        </tr>`;
    
    const yearly = data.yearly;
    yearly.forEach(y => {
        const winner = y.firstAmp > y.multiAmp ? 'é¦–ç™¼' : 'å¤šæ¬¡';
        const winnerColor = winner === 'é¦–ç™¼' ? '#2e7d32' : '#1565c0';
        html += `
        <tr>
            <td class="year-cell">${y.year}å¹´</td>
            <td>${y.first}</td>
            <td class="${y.firstAmp > y.multiAmp ? 'amp-high' : ''}">${y.firstAmp.toFixed(1)}%</td>
            <td>${y.multi}</td>
            <td class="${y.multiAmp > y.firstAmp ? 'amp-high' : ''}">${y.multiAmp.toFixed(1)}%</td>
            <td style="color:${winnerColor}; font-weight:bold;">${winner}</td>
        </tr>`;
    });
    html += `</table>`;
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            æ•´é«”è€Œè¨€ï¼Œ<strong>é¦–æ¬¡ç™¼è¡Œ(80.2%)</strong>æŒ¯å¹…ç•¥é«˜æ–¼å¤šæ¬¡ç™¼è¡Œã€‚
            ç¬¬9æ¬¡ç™¼è¡ŒæŒ¯å¹…æœ€é«˜(127.7%)ä½†åƒ…5æª”ï¼Œå±¬ç‰¹ä¾‹ã€‚
            ç™¼è¡Œæ¬¡æ•¸é”5æ¬¡ä»¥ä¸Šæ™‚æŒ¯å¹…ä¸‹é™è‡³63-69%å€é–“ã€‚
            è¿‘å¹´(2024-2025)å·®è·ç¸®å°ï¼Œå¸‚å ´å°ç™¼è¡Œæ¬¡æ•¸æ•æ„Ÿåº¦é™ä½ã€‚
        </div>
    </div>`;
    
    return html;
}

// v3.59 æ–°å¢ï¼šKYè‚¡åˆ†æï¼ˆå¤šå¹´åº¦ï¼‰
function renderKYAnalysis() {
    const data = marketTrendData.ky;
    if (!data) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    const ky = data.overall.ky;
    const nonKy = data.overall.nonKy;
    
    let html = `
    <div class="trend-compare-grid">
        <div class="trend-compare-card">
            <h4>ğŸŒ KYè‚¡ï¼ˆæµ·å¤–ä¼æ¥­ï¼‰</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æª”æ•¸</span>
                <span class="trend-compare-value">${ky.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡é«˜</span>
                <span class="trend-compare-value">${ky.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡ä½</span>
                <span class="trend-compare-value">${ky.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">å¹³å‡æŒ¯å¹…</span>
                <span class="trend-compare-value ${ky.avgAmp > nonKy.avgAmp ? 'positive' : 'negative'}">${ky.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
        <div class="trend-compare-card">
            <h4>ğŸ‡¹ğŸ‡¼ éKYè‚¡ï¼ˆæœ¬åœŸä¼æ¥­ï¼‰</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æª”æ•¸</span>
                <span class="trend-compare-value">${nonKy.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡é«˜</span>
                <span class="trend-compare-value">${nonKy.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">æ›ç‰Œå‡ä½</span>
                <span class="trend-compare-value">${nonKy.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">å¹³å‡æŒ¯å¹…</span>
                <span class="trend-compare-value ${nonKy.avgAmp > ky.avgAmp ? 'positive' : ''}">${nonKy.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
    </div>`;
    
    // å¹´åº¦KYè‚¡çµ±è¨ˆè¡¨ï¼ˆå¤šå¹´åº¦2010-2025ï¼‰
    html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin:15px 0 10px 0;">ğŸ“ˆ å„å¹´åº¦KYè‚¡ vs éKYè‚¡è¡¨ç¾ï¼ˆ2010-2025ï¼‰</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">å¹´åº¦</th>
            <th class="sortable">ç¸½æª”æ•¸</th>
            <th class="sortable">KYæª”æ•¸</th>
            <th class="sortable">KYæ¯”ä¾‹</th>
            <th class="sortable">KYæŒ¯å¹…</th>
            <th class="sortable">éKYæŒ¯å¹…</th>
            <th>å‹å‡º</th>
        </tr>`;
    
    const yearly = data.yearly;
    yearly.forEach(y => {
        if (y.ky === 0) return; // è·³éæ²’æœ‰KYè‚¡çš„å¹´åº¦
        const winner = y.kyAmp > y.nonKyAmp ? 'KY' : 'éKY';
        const winnerColor = winner === 'KY' ? '#9c27b0' : '#2e7d32';
        html += `
        <tr>
            <td class="year-cell">${y.year}å¹´</td>
            <td>${y.total}</td>
            <td>${y.ky}</td>
            <td>${y.kyRatio.toFixed(1)}%</td>
            <td class="${y.kyAmp > y.nonKyAmp ? 'amp-high' : ''}">${y.kyAmp.toFixed(1)}%</td>
            <td class="${y.nonKyAmp > y.kyAmp ? 'amp-high' : ''}">${y.nonKyAmp.toFixed(1)}%</td>
            <td style="color:${winnerColor}; font-weight:bold;">${winner}</td>
        </tr>`;
    });
    html += `</table>`;
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ†æçµè«–</div>
        <div class="insight-content">
            æ•´é«”è€Œè¨€ï¼Œ<strong>éKYè‚¡(77.6%)</strong>æŒ¯å¹…é«˜æ–¼KYè‚¡(63.5%)ã€‚
            ä½†2022å¹´KYè‚¡æŒ¯å¹…é«˜é”142.9%å¤§å¹…é ˜å…ˆï¼Œé¡¯ç¤ºKYè‚¡æ³¢å‹•è¼ƒå¤§ã€å€‹æ¡ˆå·®ç•°æ˜é¡¯ã€‚
            KYè‚¡æ¯”ä¾‹ç¶­æŒç´„7-15%ï¼Œ2025å¹´KYè‚¡è¡¨ç¾(14.1%)é ä½æ–¼éKYè‚¡(24.0%)ï¼Œ
            æŠ•è³‡KYè‚¡CBéœ€æ›´è¬¹æ…é¸è‚¡ã€‚
        </div>
    </div>`;
    
    return html;
}

// v3.92 æ–°å¢ï¼šç”¢æ¥­åˆ†ææ¸²æŸ“å‡½æ•¸
function renderIndustryAnalysis() {
    const data = marketTrendData.industry;
    if (!data || data.length === 0) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ­ ç”¢æ¥­åˆ†å¸ƒèˆ‡ç¸¾æ•ˆåˆ†æ</div>
    <div class="trend-table-wrapper">
    <table class="trend-year-table">
        <tr>
            <th class="sortable">ç”¢æ¥­</th>
            <th class="sortable">æª”æ•¸</th>
            <th class="sortable">å æ¯”</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    // åªé¡¯ç¤ºå‰15å€‹ç”¢æ¥­
    const topData = data.slice(0, 15);
    topData.forEach((d, idx) => {
        const ampClass = d.avgAmp >= 80 ? 'amp-high' : (d.avgAmp < 30 ? 'amp-low' : '');
        const rankIcon = idx < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][idx] : '';
        html += `
        <tr>
            <td style="text-align:left; font-weight:${idx < 3 ? 'bold' : 'normal'};">${rankIcon} ${d.name}</td>
            <td><b>${d.count}</b></td>
            <td>${d.ratio.toFixed(1)}%</td>
            <td style="color:#2e7d32;">${d.avgHigh > 0 ? d.avgHigh.toFixed(1) : '-'}</td>
            <td style="color:#c62828;">${d.avgLow > 0 ? d.avgLow.toFixed(1) : '-'}</td>
            <td class="${ampClass}">${d.avgAmp > 0 ? d.avgAmp.toFixed(1) + '%' : '-'}</td>
        </tr>`;
    });
    
    html += `</table></div>`;
    
    // åˆ†æçµè«–
    const best = data.filter(d => d.avgAmp > 0).sort((a, b) => b.avgAmp - a.avgAmp)[0];
    const worst = data.filter(d => d.avgAmp > 0 && d.count >= 5).sort((a, b) => a.avgAmp - b.avgAmp)[0];
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”ç”¢æ¥­è§€å¯Ÿ</div>
        <div class="insight-content">
            ${data[0] ? `ç™¼è¡Œé‡æœ€å¤§ç”¢æ¥­ç‚º<strong>${data[0].name}</strong>(${data[0].count}æª”ï¼Œå ${data[0].ratio.toFixed(1)}%)ã€‚` : ''}
            ${best ? `æŒ¯å¹…æœ€ä½³ç”¢æ¥­ç‚º<strong>${best.name}</strong>(${best.avgAmp.toFixed(1)}%)ã€‚` : ''}
            ${worst ? `æŒ¯å¹…è¼ƒä½ç”¢æ¥­ç‚º<strong>${worst.name}</strong>(${worst.avgAmp.toFixed(1)}%)ã€‚` : ''}
            ç”¢æ¥­é¸æ“‡å°CBç¸¾æ•ˆæœ‰é¡¯è‘—å½±éŸ¿ï¼Œå»ºè­°é—œæ³¨ç†±é–€ç”¢æ¥­çš„ä¾›çµ¦å£“åŠ›ã€‚
        </div>
    </div>`;
    
    return html;
}

// v3.92 æ–°å¢ï¼šåˆ¸å•†åˆ†ææ¸²æŸ“å‡½æ•¸
function renderBrokerAnalysis() {
    const data = marketTrendData.broker;
    if (!data || data.length === 0) return '<div>æš«ç„¡æ•¸æ“š</div>';
    
    let html = `
    <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ¦ æ‰¿éŠ·åˆ¸å•†åˆ†å¸ƒèˆ‡ç¸¾æ•ˆåˆ†æ</div>
    <div class="trend-table-wrapper">
    <table class="trend-year-table">
        <tr>
            <th class="sortable">åˆ¸å•†</th>
            <th class="sortable">æª”æ•¸</th>
            <th class="sortable">å æ¯”</th>
            <th class="sortable">æ›ç‰Œå‡é«˜</th>
            <th class="sortable">æ›ç‰Œå‡ä½</th>
            <th class="sortable">å¹³å‡æŒ¯å¹…</th>
        </tr>`;
    
    // åªé¡¯ç¤ºå‰15å€‹åˆ¸å•†
    const topData = data.slice(0, 15);
    topData.forEach((d, idx) => {
        const ampClass = d.avgAmp >= 80 ? 'amp-high' : (d.avgAmp < 30 ? 'amp-low' : '');
        const rankIcon = idx < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][idx] : '';
        html += `
        <tr>
            <td style="text-align:left; font-weight:${idx < 3 ? 'bold' : 'normal'};">${rankIcon} ${d.name}</td>
            <td><b>${d.count}</b></td>
            <td>${d.ratio.toFixed(1)}%</td>
            <td style="color:#2e7d32;">${d.avgHigh > 0 ? d.avgHigh.toFixed(1) : '-'}</td>
            <td style="color:#c62828;">${d.avgLow > 0 ? d.avgLow.toFixed(1) : '-'}</td>
            <td class="${ampClass}">${d.avgAmp > 0 ? d.avgAmp.toFixed(1) + '%' : '-'}</td>
        </tr>`;
    });
    
    html += `</table></div>`;
    
    // åˆ†æçµè«–
    const best = data.filter(d => d.avgAmp > 0 && d.count >= 5).sort((a, b) => b.avgAmp - a.avgAmp)[0];
    const worst = data.filter(d => d.avgAmp > 0 && d.count >= 5).sort((a, b) => a.avgAmp - b.avgAmp)[0];
    
    html += `
    <div class="trend-insight-box">
        <div class="insight-title">ğŸ“Š Rexå¤§å”åˆ¸å•†è§€å¯Ÿ</div>
        <div class="insight-content">
            ${data[0] ? `æ‰¿éŠ·é‡æœ€å¤§åˆ¸å•†ç‚º<strong>${data[0].name}</strong>(${data[0].count}æª”ï¼Œå¸‚å ${data[0].ratio.toFixed(1)}%)ã€‚` : ''}
            ${best ? `æŒ¯å¹…è¡¨ç¾æœ€ä½³åˆ¸å•†ç‚º<strong>${best.name}</strong>(${best.avgAmp.toFixed(1)}%)ã€‚` : ''}
            ${worst ? `æŒ¯å¹…è¼ƒä½åˆ¸å•†ç‚º<strong>${worst.name}</strong>(${worst.avgAmp.toFixed(1)}%)ã€‚` : ''}
            åˆ¸å•†é¸æ“‡å°CBç¸¾æ•ˆæœ‰ä¸€å®šå½±éŸ¿ï¼Œä½†å€‹æ¡ˆå·®ç•°ä»å¤§ï¼Œéœ€ç¶œåˆè©•ä¼°ã€‚
        </div>
    </div>`;
    
    return html;
}

function showDimensionTab(dimension, event) {
    // é˜²æ­¢é é¢è·³å‹•
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // v3.97z-s: ç¶­åº¦çµ±è¨ˆå·²ç§»é™¤ï¼Œæå‰è¿”å›
    const contentDiv = document.getElementById('dimensionContent');
    if (!contentDiv) return;
    
    contentDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">è¼‰å…¥ä¸­...</div>';
    
    // æ›´æ–°tabç‹€æ…‹
    document.querySelectorAll('.dimension-main-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        const targetTab = document.querySelector(`.dimension-main-tab[onclick*="${dimension}"]`);
        if (targetTab) targetTab.classList.add('active');
    }
    
    const data = dimensionData[dimension];
    if (!data) {
        contentDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æš«ç„¡è³‡æ–™</div>';
        console.log(`ç¶­åº¦çµ±è¨ˆ: ${dimension} ç„¡è³‡æ–™`);
        return;
    }
    
    let html = '';
    
    data.ranges.forEach((range, idx) => {
        const rangeId = `dim-${dimension}-${idx}`;
        html += `
        <div class="dimension-range-card">
            <div class="dimension-range-header" onclick="toggleDimensionRange('${rangeId}')">
                <div class="dimension-range-title">
                    <span>ğŸ“ ${range.label}</span>
                    <span style="font-weight:normal; font-size:10px; color:#666;">(${range.total}æª”)</span>
                </div>
                <div class="dimension-range-stats">
                    <span>ç«¶æ‹:<b>${range.auction}</b></span>
                    <span>è©¢åœˆ:<b>${range.inquiry}</b></span>
                    <span>å‡é«˜:<b>${range.avgHigh.toFixed(1)}</b></span>
                    <span>å‡ä½:<b>${range.avgLow.toFixed(1)}</b></span>
                    <span>æŒ¯å¹…:<b>${range.avgAmp.toFixed(1)}%</b></span>
                </div>
                <span class="dimension-range-toggle" id="${rangeId}-toggle">â–¼</span>
            </div>
            <div class="dimension-range-body" id="${rangeId}-body">
                <table class="dimension-detail-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ä»£è™Ÿ</th>
                            <th>åç¨±</th>
                            <th>é¡å‹</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ›ç‰Œé«˜</th>
                            <th>æ›ç‰Œä½</th>
                            <th>æŒ¯å¹…</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        range.items.forEach((item, i) => {
            const typeClass = item.type === 'ç«¶æ‹' ? 'auction' : 'inquiry';
            const ampClass = item.amp >= 100 ? 'dimension-amp-high' : (item.amp < 30 ? 'dimension-amp-low' : '');
            const statusClass = item.status === 'æ›ç‰Œä¸­' ? 'listed' : 'delisted';
            html += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${item.id || '-'}</td>
                            <td title="${item.name}">${item.name}</td>
                            <td><span class="dimension-type-badge ${typeClass}">${item.type}</span></td>
                            <td><span class="dimension-status-badge ${statusClass}">${item.status || 'å·²ä¸‹å¸‚'}</span></td>
                            <td>${item.high.toFixed(1)}</td>
                            <td>${item.low.toFixed(1)}</td>
                            <td class="${ampClass}">${item.amp.toFixed(1)}%</td>
                        </tr>`;
        });
        
        html += `
                    </tbody>
                </table>
                <div style="text-align:center; font-size:9px; color:#999; margin-top:6px;">
                    é¡¯ç¤ºæŒ¯å¹…TOP5ï¼Œå®Œæ•´è³‡æ–™è«‹åƒè€ƒè©•ä¼°çµæœ
                </div>
            </div>
        </div>`;
    });
    
    html += `
    <div class="dimension-summary">
        ğŸ“Œ <strong>${data.name}åˆ†æï¼š</strong>${data.summary}
    </div>`;
    
    const targetDiv = document.getElementById('dimensionContent');
    if (targetDiv) targetDiv.innerHTML = html;
}

function toggleDimensionRange(rangeId) {
    const body = document.getElementById(rangeId + '-body');
    const toggle = document.getElementById(rangeId + '-toggle');
    
    if (body.classList.contains('open')) {
        body.classList.remove('open');
        toggle.classList.remove('open');
    } else {
        body.classList.add('open');
        toggle.classList.add('open');
    }
}

function bindInputEvents() {
    const show = (id, html) => { 
        const el = document.getElementById(id); 
        el.innerHTML = html||''; 
        el.style.display = html?'block':'none'; 
    };
    
    // CBåç¨±æœå°‹
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim();
        
        // v3.97y: ç”¨æˆ¶æ‰‹å‹•è¼¸å…¥æ™‚æ¸…é™¤é–ƒé›»å¸¶å…¥çš„å…¨åŸŸè®Šæ•¸
        window.currentCBCode = '';
        window.currentCBName = '';
        window.currentActualIssueSize = 0;
        
        const histDiv = document.getElementById('historyResults');
        
        if(val.length >= 2) {
            const auctionMatches = auctionRawData.filter(d => {
                const idMatch = d.id && d.id.startsWith(val);
                const stockIdMatch = d.stockId && String(d.stockId).startsWith(val);
                const nameMatch = d.name && d.name.includes(val);
                // v3.90 æ–°å¢ï¼šæ”¯æ´ç”¨è‚¡ç¥¨ä»£è™Ÿæœå°‹ï¼ˆCBä»£è™Ÿé€šå¸¸æ˜¯"è‚¡ç¥¨ä»£è™Ÿ+ä¸€/äºŒ/ä¸‰"ï¼‰
                const stockCodeMatch = d.id && d.id.substring(0, 4) === val;
                return idMatch || stockIdMatch || nameMatch || stockCodeMatch;
            }).slice(0, 10);
            
            const inquiryMatches = inquiryRawData.filter(d => {
                const idMatch = d.id && d.id.startsWith(val);
                const nameMatch = d.name && d.name.includes(val);
                // v3.90 æ–°å¢ï¼šæ”¯æ´ç”¨è‚¡ç¥¨ä»£è™Ÿæœå°‹ï¼ˆCBä»£è™Ÿé€šå¸¸æ˜¯"è‚¡ç¥¨ä»£è™Ÿ+ä¸€/äºŒ/ä¸‰"ï¼‰
                const stockCodeMatch = d.id && d.id.substring(0, 4) === val;
                return idMatch || nameMatch || stockCodeMatch;
            }).slice(0, 10);
            
            let html = '';
            
            if(inquiryMatches.length > 0) {
                html += `<div class="history-results-title">ğŸ“‹ è©¢åœˆæ¡ˆä¾‹ (${inquiryMatches.length}ç­†)</div>`;
                inquiryMatches.forEach(d => {
                    html += generateInquiryCard(d);
                });
            }
            
            if(auctionMatches.length > 0) {
                html += `<div class="history-results-title" style="margin-top:${inquiryMatches.length > 0 ? '12px' : '0'}">ğŸ¯ ç«¶æ‹æ¡ˆä¾‹ (${auctionMatches.length}ç­†)</div>`;
                html += auctionMatches.map(d => generateHistoryCard(d)).join('');
            }
            
            if(html) {
                histDiv.innerHTML = html;
                histDiv.style.display = 'block';
            } else {
                histDiv.style.display = 'none';
            }
        } else {
            histDiv.style.display = 'none';
        }

        if (!val) { show('cbNameInfo', null); return; }
        const found = cbNameMap[val] || Object.values(cbDatabase).find(d => d.name && d.name === val);
        if (found) {
            show('cbNameInfo', generateStandardCard({
                'å¹³å‡æœ€ä½å¾—æ¨™åƒ¹': found.minBidPrice,
                'å¹³å‡æœ€ä½æº¢åƒ¹': found.lowPremium,
                'å¹³å‡å¾—æ¨™åƒ¹': found.avgBidPrice,
                'å¹³å‡æº¢åƒ¹': found.avgPremium,
                'å¹³å‡æ›ç‰Œæœ€é«˜': found.marketHigh,
                'å¹³å‡æ›ç‰Œæœ€ä½': found.marketLow,
                'æ¨£æœ¬æ•¸': 1
            }, `${found.name} æ­·å²ç´€éŒ„`));
        } else {
            show('cbNameInfo', null);
        }
    });

    // v3.52 ä¿®æ”¹ï¼šå…¶ä»–æ¬„ä½ç¶å®šï¼Œå‚³å…¥æ’é™¤å‰ä¸‰ + æ“”ä¿é¡å‹ç´°åˆ†
    // v3.74 æ–°å¢ï¼šå‚³å…¥æ’åè³‡è¨Š
    const bind = (id, cat) => {
        const handler = function() {
            const rawVal = this.value;
            const val = parseFloat(rawVal) || rawVal;
            if (val) {
                let displayTitle = val;
                if(['è‚¡æœ¬','ç™¼è¡Œè¦æ¨¡','è½‰æ›åƒ¹'].includes(cat)) displayTitle = getRangeLabel(cat, val);
                
                const smartResult = getStatsSmart(cat, val);
                
                // v3.74 æ–°å¢ï¼šå–å¾—æ’åè³‡è¨Š
                let rankingInfo = null;
                if (window.dimensionRankings && window.dimensionRankings[cat]) {
                    // å˜—è©¦ç”¨åŸå§‹å€¼æˆ–é¡¯ç¤ºæ¨™é¡ŒæŸ¥æ‰¾
                    rankingInfo = window.dimensionRankings[cat][rawVal] || window.dimensionRankings[cat][displayTitle] || window.dimensionRankings[cat][val];
                }
                
                // v3.52: å‚³å…¥æ’é™¤å‰ä¸‰ + æ“”ä¿é¡å‹ç´°åˆ†æ•¸æ“š + v3.74æ’å
                show(id+'Info', generateStandardCard(
                    smartResult.rawData, 
                    `å€é–“çµ±è¨ˆ: ${displayTitle}`, 
                    smartResult.inquiryData,
                    smartResult.excludeTop3Data,
                    smartResult.excludeTop3InquiryData,
                    smartResult.guaranteedAuctionData,
                    smartResult.guaranteedInquiryData,
                    smartResult.unguaranteedAuctionData,
                    smartResult.unguaranteedInquiryData,
                    rankingInfo
                ));
                if(cat==='è½‰æ›åƒ¹'||cat==='ä¿¡è©•') updateSmartReminders();
            }
        };
        const el = document.getElementById(id); 
        el.addEventListener('change', handler); 
        if(el.tagName==='INPUT') el.addEventListener('input', handler);
    };

    bind('capital','è‚¡æœ¬'); 
    bind('issueSize','ç™¼è¡Œè¦æ¨¡'); 
    bind('theoRange','ç†è«–åƒ¹');  // v3.72 æ”¹ç‚ºç†è«–åƒ¹å€é–“
    bind('industry','ç”¢æ¥­'); 
    bind('broker','ç™¼è¡Œåˆ¸å•†'); 
    bind('years','å¹´æœŸ'); 
    bind('guarantee','æ“”ä¿'); 
    bind('rating','ä¿¡è©•');
    
    document.getElementById('guarantee').addEventListener('change', function() {
        updateMarketSentiment();
        if (typeof updateAtmospherePanel === 'function') {
            updateAtmospherePanel();
        }
    });
    
    // ç”¢æ¥­ã€è¦æ¨¡ã€ä¿¡è©•è®Šæ›´æ™‚éƒ½è§¸ç™¼å¸‚å ´æ°›åœè¨ˆç®—
    document.getElementById('industry').addEventListener('change', updateMarketSentiment);
    document.getElementById('issueSize').addEventListener('change', updateMarketSentiment);
    document.getElementById('rating').addEventListener('change', updateMarketSentiment);
    
    document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
    document.getElementById('actualConversionPrice').addEventListener('input', updateSmartReminders); // v3.69 æ–°å¢
    document.getElementById('floorPrice').addEventListener('input', updateSmartReminders); // v3.69 æ–°å¢ï¼šåº•æ¨™åƒ¹æ ¼
    document.getElementById('theoRange').addEventListener('change', updateSmartReminders); // v3.72 æ”¹ç‚ºç†è«–åƒ¹å€é–“
    
    // v3.72 æ–°å¢ï¼šç«¶æ‹å‰è©•ä¼°è§¸ç™¼ï¼ˆåŸºæ–¼äº‹å‰å¯çŸ¥æ¢ä»¶ï¼‰
    // v3.73 ä¿®æ”¹ï¼šå¢åŠ yearså’ŒfloorPriceè§¸ç™¼
    const evalTriggers = ['stockPrice', 'actualConversionPrice', 'theoRange', 'guarantee', 'rating', 'issueSize', 'broker', 'industry', 'years', 'floorPrice'];
    evalTriggers.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', updateAuctionEvaluation);
            if (el.tagName === 'INPUT') el.addEventListener('input', debounce(updateAuctionEvaluation, 300));
        }
    });
}

// v3.72 æ–°å¢ï¼šé˜²æŠ–å‡½æ•¸
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// v3.69 æ›´æ–°ï¼šå¾å€é–“å­—ä¸²æå–ä¸­é–“å€¼
function getConversionMidValue(rangeStr) {
    if (typeof rangeStr === 'number' && !isNaN(rangeStr)) return rangeStr;
    const str = String(rangeStr || '');
    if (str.includes('å°æ–¼20')) return 15;
    if (str.includes('20~50')) return 35;
    if (str.includes('50~100')) return 75;
    if (str.includes('100~150')) return 125;
    if (str.includes('150~200')) return 175;
    if (str.includes('å¤§æ–¼200')) return 250;
    const num = parseFloat(str);
    return isNaN(num) ? 0 : num;
}

// v3.72 æ–°å¢ï¼šå¾ç†è«–åƒ¹å€é–“å­—ä¸²æå–ä¸­é–“å€¼
function getTheoRangeMidValue(rangeStr) {
    if (typeof rangeStr === 'number' && !isNaN(rangeStr)) return rangeStr;
    const str = String(rangeStr || '');
    if (str.includes('å°æ–¼90')) return 85;
    if (str.includes('90~95')) return 92.5;
    if (str.includes('95~100')) return 97.5;
    if (str.includes('100~105')) return 102.5;
    if (str.includes('105~110')) return 107.5;
    if (str.includes('110~115')) return 112.5;
    if (str.includes('å¤§æ–¼115')) return 120;
    const num = parseFloat(str);
    return isNaN(num) ? 0 : num;
}

// v3.69 ä¿®æ”¹ï¼šè¿‘æœŸå¸‚å ´æ°›åœä¸‰ç¶­åº¦åŠ æ¬Šè¨ˆç®—
// v3.72 æ–°å¢ï¼šå€åˆ†æœ‰æ“”ä¿/ç„¡æ“”ä¿ç¯©é¸
// v3.85 é‡å¤§æ›´æ–°ï¼šäº”ç¶­åº¦å¸‚å ´æ°›åœæ¬Šé‡ï¼ˆæ ¹æ“š2203æª”CBå¯¦è­‰æ•¸æ“šï¼‰
// æ¬Šé‡é…ç½®ï¼šç”¢æ¥­35%ã€åˆ¸å•†25%ã€ä¿¡è©•20%ã€è¦æ¨¡10%ã€ç†è«–åƒ¹10%
// é—œéµç™¼ç¾ï¼š(1) ç”¢æ¥­å½±éŸ¿æœ€å¤§ (2) åˆ¸å•†è¢«åš´é‡ä½ä¼° (3) ä¿¡è©•ä¸æ˜¯è¶Šä½è¶Šå¥½
function updateMarketSentiment() {
    const div = document.getElementById('marketSentiment');
    const industry = document.getElementById('industry').value;
    const issueSize = document.getElementById('issueSize').value;
    const rating = document.getElementById('rating').value;
    const guarantee = document.getElementById('guarantee').value;
    const broker = document.getElementById('broker').value;  // v3.84 æ–°å¢
    const theoRange = document.getElementById('theoRange').value;  // v3.84 æ–°å¢
    
    // v3.85 æ›´æ–°ï¼šäº”ç¶­åº¦å¸‚å ´æ°›åœï¼ˆç”¢æ¥­35%ã€åˆ¸å•†25%ã€ä¿¡è©•20%ã€è¦æ¨¡10%ã€ç†è«–åƒ¹10%ï¼‰
    const hasAnyDim = industry || issueSize || rating || broker || theoRange;
    
    // è‡³å°‘éœ€è¦ä¸€å€‹ç¶­åº¦
    if (!hasAnyDim) {
        div.innerHTML = `<div class="stat-row" style="color:#e65100;">âš ï¸ è«‹è‡³å°‘å¡«å¯«ä¸€å€‹ç¶­åº¦ï¼ˆç”¢æ¥­ã€åˆ¸å•†ã€ä¿¡è©•ã€è¦æ¨¡ã€ç†è«–åƒ¹ï¼‰ä»¥è¨ˆç®—å¸‚å ´æ°›åœ</div>`;
        return;
    }
    
    // v3.72 ä¿®æ”¹ï¼šå…ˆæŒ‰æ“”ä¿é¡å‹ç¯©é¸ï¼Œå†æŒ‰æˆªæ¨™æ—¥æ’åº
    let filteredData = [...auctionRawData].filter(d => d.openDate);
    
    // å¦‚æœæœ‰é¸æ“”ä¿é¡å‹ï¼Œå°±ç¯©é¸åŒé¡å‹
    if (guarantee) {
        filteredData = filteredData.filter(d => d.guarantee === guarantee);
    }
    
    const sortedData = filteredData.sort((a, b) => {
        const dateA = new Date(a.openDate);
        const dateB = new Date(b.openDate);
        return dateB - dateA;
    });
    
    // åŠ æ¬Šè¨ˆç®—å‡½æ•¸ï¼šæœ€è¿‘3æª”æ¬Šé‡5ï¼Œ4-6æª”æ¬Šé‡3ï¼Œ7-9æª”æ¬Šé‡2
    // v3.69 ä¿®æ­£ï¼šåŒæ™‚è¨ˆç®—æº¢åƒ¹ç‡å’Œå¾—æ¨™åƒ¹æ ¼
    function calcWeightedData(cases) {
        if (cases.length === 0) return { 
            lowPremium: null, avgPremium: null, 
            lowBidPrice: null, avgBidPrice: null,
            count: 0, detail: [] 
        };
        
        let totalWeight = 0;
        let weightedLowPremium = 0, weightedAvgPremium = 0;
        let weightedLowBid = 0, weightedAvgBid = 0;
        const detail = [];
        
        cases.slice(0, 9).forEach((c, idx) => {
            let weight = 0;
            if (idx < 3) weight = 5;      // æœ€è¿‘3æª”
            else if (idx < 6) weight = 3;  // 4-6æª”
            else weight = 2;               // 7-9æª”
            
            const lowP = c.lowPremium || 0;
            const avgP = c.avgPremium || 0;
            const lowB = c.minBidPrice || 0;
            const avgB = c.avgBidPrice || 0;
            
            weightedLowPremium += lowP * weight;
            weightedAvgPremium += avgP * weight;
            weightedLowBid += lowB * weight;
            weightedAvgBid += avgB * weight;
            totalWeight += weight;
            
            detail.push({
                name: c.name || c.id,
                lowPremium: lowP,
                avgPremium: avgP,
                lowBid: lowB,
                avgBid: avgB,
                weight: weight
            });
        });
        
        return {
            lowPremium: totalWeight > 0 ? (weightedLowPremium / totalWeight) : null,
            avgPremium: totalWeight > 0 ? (weightedAvgPremium / totalWeight) : null,
            lowBidPrice: totalWeight > 0 ? (weightedLowBid / totalWeight) : null,
            avgBidPrice: totalWeight > 0 ? (weightedAvgBid / totalWeight) : null,
            count: cases.length,
            detail: detail
        };
    }
    
    // v3.90 ä¿®æ­£ï¼šä¸‰ç¶­åº¦æ¬Šé‡ï¼ˆç”¢æ¥­35%ã€è¦æ¨¡25%ã€ä¿¡è©•40%ï¼‰
    // æŒ‰ç”¨æˆ¶è¨è«–èª¿æ•´ï¼Œç§»é™¤åˆ¸å•†å’Œç†è«–åƒ¹ç¶­åº¦
    const WEIGHTS = {
        industry: 0.35,
        size: 0.25,
        rating: 0.40
    };
    
    // 1. ç”¢æ¥­ç¶­åº¦ (35%)
    let industryResult = { lowPremium: null, avgPremium: null, lowBidPrice: null, avgBidPrice: null, count: 0 };
    if (industry) {
        const industryCases = sortedData.filter(d => industryMatches(d.industry, industry));
        industryResult = calcWeightedData(industryCases);
    }
    
    // 2. è¦æ¨¡ç¶­åº¦ (25%)
    let sizeResult = { lowPremium: null, avgPremium: null, lowBidPrice: null, avgBidPrice: null, count: 0 };
    if (issueSize) {
        const sizeCases = sortedData.filter(d => {
            const size = d.issueSize || 0;
            if (issueSize === 'å°æ–¼2å„„') return size > 0 && size < 2;
            if (issueSize === '2~5å„„') return size >= 2 && size < 5;
            if (issueSize === '5~10å„„') return size >= 5 && size < 10;
            if (issueSize === '10~15å„„') return size >= 10 && size < 15;
            if (issueSize === '15~20å„„') return size >= 15 && size < 20;
            if (issueSize === 'å¤§æ–¼20å„„') return size >= 20;
            return false;
        });
        sizeResult = calcWeightedData(sizeCases);
    }
    
    // 3. ä¿¡è©•ç¶­åº¦ (40%)
    let ratingResult = { lowPremium: null, avgPremium: null, lowBidPrice: null, avgBidPrice: null, count: 0 };
    if (rating) {
        const ratingCases = sortedData.filter(d => d.rating === rating);
        ratingResult = calcWeightedData(ratingCases);
    }
    
    // v3.90 è¨ˆç®—ç¸½åŠ æ¬Šï¼ˆä¸‰ç¶­åº¦ï¼šç”¢æ¥­35%ã€è¦æ¨¡25%ã€ä¿¡è©•40%ï¼‰
    let totalLowP = 0, totalAvgP = 0;
    let totalLowB = 0, totalAvgB = 0;
    let totalWeight = 0;
    let activeDims = [];
    
    if (industryResult.lowPremium !== null) {
        totalLowP += industryResult.lowPremium * WEIGHTS.industry;
        totalAvgP += industryResult.avgPremium * WEIGHTS.industry;
        totalLowB += industryResult.lowBidPrice * WEIGHTS.industry;
        totalAvgB += industryResult.avgBidPrice * WEIGHTS.industry;
        totalWeight += WEIGHTS.industry;
        activeDims.push({ name: 'ç”¢æ¥­', weight: WEIGHTS.industry });
    }
    if (sizeResult.lowPremium !== null) {
        totalLowP += sizeResult.lowPremium * WEIGHTS.size;
        totalAvgP += sizeResult.avgPremium * WEIGHTS.size;
        totalLowB += sizeResult.lowBidPrice * WEIGHTS.size;
        totalAvgB += sizeResult.avgBidPrice * WEIGHTS.size;
        totalWeight += WEIGHTS.size;
        activeDims.push({ name: 'è¦æ¨¡', weight: WEIGHTS.size });
    }
    if (ratingResult.lowPremium !== null) {
        totalLowP += ratingResult.lowPremium * WEIGHTS.rating;
        totalAvgP += ratingResult.avgPremium * WEIGHTS.rating;
        totalLowB += ratingResult.lowBidPrice * WEIGHTS.rating;
        totalAvgB += ratingResult.avgBidPrice * WEIGHTS.rating;
        totalWeight += WEIGHTS.rating;
        activeDims.push({ name: 'ä¿¡è©•', weight: WEIGHTS.rating });
    }
    
    // é‡æ–°æ­£è¦åŒ–ï¼ˆå¦‚æœåªæœ‰éƒ¨åˆ†ç¶­åº¦æœ‰è³‡æ–™ï¼‰
    const finalLowP = totalWeight > 0 ? (totalLowP / totalWeight) : 0;
    const finalAvgP = totalWeight > 0 ? (totalAvgP / totalWeight) : 0;
    const finalLowB = totalWeight > 0 ? (totalLowB / totalWeight) : 0;
    const finalAvgB = totalWeight > 0 ? (totalAvgB / totalWeight) : 0;
    
    // é¡¯ç¤ºçµæœ
    const guarLabel = guarantee ? `ã€${guarantee}ã€‘` : '';
    
    // v3.90 æ›´æ–°ï¼šå‹•æ…‹ç”Ÿæˆç¶­åº¦èªªæ˜ï¼ˆä¸‰ç¶­åº¦ï¼‰
    const dimensionDesc = activeDims.length > 0 ?
        activeDims.map(d => `${d.name}(${Math.round(d.weight/totalWeight*100)}%)`).join('+') :
        'ç„¡å¯ç”¨ç¶­åº¦';
    
    let html = `<div class="stats-header">ğŸŒ¡ï¸ v3.90 è¿‘æœŸå¸‚å ´æ°›åœ${guarLabel}ï¼ˆ${dimensionDesc}ï¼‰</div>`;
    
    // ç¸½çµ - åŒæ™‚é¡¯ç¤ºæº¢åƒ¹ç‡å’Œå¾—æ¨™åƒ¹æ ¼
    html += `<div style="background:#fff; padding:10px; border-radius:6px; margin-bottom:10px;">
        <div style="display:flex; gap:15px; flex-wrap:wrap;">
            <div style="flex:1; min-width:140px;">
                <div style="font-size:12px; color:#666;">åŠ æ¬Šæº¢åƒ¹ç‡</div>
                <div style="font-size:16px; font-weight:bold;">
                    <span style="color:#2e7d32;">${finalLowP.toFixed(2)}%</span> ~ <span style="color:#d32f2f;">${finalAvgP.toFixed(2)}%</span>
                </div>
            </div>
            <div style="flex:1; min-width:140px;">
                <div style="font-size:12px; color:#666;">åŠ æ¬Šå¾—æ¨™åƒ¹</div>
                <div style="font-size:16px; font-weight:bold;">
                    <span style="color:#2e7d32;">${finalLowB.toFixed(2)}</span> ~ <span style="color:#d32f2f;">${finalAvgB.toFixed(2)}</span> å…ƒ
                </div>
            </div>
        </div>
    </div>`;
    
    // v3.90 ä¸‰ç¶­åº¦æ˜ç´°ï¼ˆç”¢æ¥­35%ã€è¦æ¨¡25%ã€ä¿¡è©•40%ï¼‰
    html += `<div style="font-size:12px; line-height:1.8;">`;
    
    if (industry) {
        const normWeight = totalWeight > 0 ? Math.round(WEIGHTS.industry / totalWeight * 100) : 35;
        const status = industryResult.count > 0 ? 
            `æº¢åƒ¹ <span style="color:#2e7d32;">${industryResult.lowPremium?.toFixed(2) || '-'}%</span>~<span style="color:#d32f2f;">${industryResult.avgPremium?.toFixed(2) || '-'}%</span> (${Math.min(industryResult.count, 9)}ç­†)` : 
            `<span style="color:#999;">ç„¡æ¡ˆä¾‹</span>`;
        html += `<div>ğŸ“Œ ç”¢æ¥­[${industry}] ${normWeight}%ï¼š${status}</div>`;
    }
    
    if (issueSize) {
        const normWeight = totalWeight > 0 ? Math.round(WEIGHTS.size / totalWeight * 100) : 25;
        const status = sizeResult.count > 0 ? 
            `æº¢åƒ¹ <span style="color:#2e7d32;">${sizeResult.lowPremium?.toFixed(2) || '-'}%</span>~<span style="color:#d32f2f;">${sizeResult.avgPremium?.toFixed(2) || '-'}%</span> (${Math.min(sizeResult.count, 9)}ç­†)` : 
            `<span style="color:#999;">ç„¡æ¡ˆä¾‹</span>`;
        html += `<div>ğŸ“Œ è¦æ¨¡[${issueSize}] ${normWeight}%ï¼š${status}</div>`;
    }
    
    if (rating) {
        const normWeight = totalWeight > 0 ? Math.round(WEIGHTS.rating / totalWeight * 100) : 40;
        const ratingName = rating === 'BBB' ? 'BBB' : `TCRI ${rating}`;
        const status = ratingResult.count > 0 ? 
            `æº¢åƒ¹ <span style="color:#2e7d32;">${ratingResult.lowPremium?.toFixed(2) || '-'}%</span>~<span style="color:#d32f2f;">${ratingResult.avgPremium?.toFixed(2) || '-'}%</span> (${Math.min(ratingResult.count, 9)}ç­†)` : 
            `<span style="color:#999;">ç„¡æ¡ˆä¾‹</span>`;
        html += `<div>ğŸ“Œ ä¿¡è©•[${ratingName}] ${normWeight}%ï¼š${status}</div>`;
    }
    
    html += `</div>`;
    
    // v3.90 æ›´æ–°èªªæ˜ï¼ˆä¸‰ç¶­åº¦ï¼‰
    html += `<div style="font-size:11px; color:#666; margin-top:8px; border-top:1px solid #ddd; padding-top:6px;">
        ğŸ’¡ v3.90å…¨è‡ªå‹•æ™ºèƒ½ï¼šé€²å…¥å³é¡¯ç¤ºå»ºè­°ï¼Œé¸æ“‡æ¢ä»¶å¾Œè‡ªå‹•æ›´æ–°<br>
        ğŸ“Š ä¸‰ç¶­åº¦æ¬Šé‡ï¼šç”¢æ¥­35%+è¦æ¨¡25%+ä¿¡è©•40%
    </div>`;
    
    div.innerHTML = html;
    div.style.display = 'block';
}

function updateSmartReminders() {
    const s = parseFloat(document.getElementById('stockPrice').value);
    // v3.69 å„ªå…ˆä½¿ç”¨å¯¦éš›è½‰æ›åƒ¹æ ¼
    const actualC = parseFloat(document.getElementById('actualConversionPrice').value);
    // v3.72 ä¿®æ”¹ï¼šå¦‚æœæ²’æœ‰è¼¸å…¥è‚¡åƒ¹å’Œè½‰æ›åƒ¹ï¼Œå‰‡å¾ç†è«–åƒ¹å€é–“ç²å–ä¸­é–“å€¼
    const theoRangeVal = document.getElementById('theoRange').value;
    const theoAutoCalcInfo = document.getElementById('theoAutoCalcInfo');
    
    let t = 0;  // ç†è«–åƒ¹
    let c = actualC;  // è½‰æ›åƒ¹
    let autoCalcRange = '';  // è‡ªå‹•è¨ˆç®—çš„å€é–“
    
    if(s > 0 && actualC > 0) {
        // æ–¹å¼ä¸€ï¼šå¾è‚¡åƒ¹å’Œè½‰æ›åƒ¹è¨ˆç®—ç†è«–åƒ¹
        t = (s/actualC)*100;
        
        // v3.72 æ–°å¢ï¼šè‡ªå‹•åˆ¤æ–·ç†è«–åƒ¹å€é–“ä¸¦æ›´æ–°ä¸‹æ‹‰é¸å–®
        if (t < 90) autoCalcRange = 'å°æ–¼90å…ƒ';
        else if (t < 95) autoCalcRange = '90~95å…ƒ';
        else if (t < 100) autoCalcRange = '95~100å…ƒ';
        else if (t < 105) autoCalcRange = '100~105å…ƒ';
        else if (t < 110) autoCalcRange = '105~110å…ƒ';
        else if (t < 115) autoCalcRange = '110~115å…ƒ';
        else autoCalcRange = 'å¤§æ–¼115å…ƒ';
        
        // è‡ªå‹•æ›´æ–°ç†è«–åƒ¹å€é–“é¸é …
        document.getElementById('theoRange').value = autoCalcRange;
        
        // é¡¯ç¤ºè‡ªå‹•è¨ˆç®—æç¤º
        if (theoAutoCalcInfo) {
            document.getElementById('theoAutoValue').textContent = t.toFixed(2);
            document.getElementById('theoAutoRange').textContent = autoCalcRange;
            theoAutoCalcInfo.style.display = 'block';
        }
        
        // æ›´æ–°æ¨™ç±¤æç¤º
        const modeSpan = document.getElementById('theoRangeMode');
        if (modeSpan) {
            modeSpan.innerHTML = 'ï¼ˆ<span style="color:#2e7d32;">âœ… å·²è‡ªå‹•è¨ˆç®—</span>ï¼‰';
        }
        
    } else if(theoRangeVal && theoRangeVal !== '') {
        // æ–¹å¼äºŒï¼šå¾ç†è«–åƒ¹å€é–“ç²å–ä¸­é–“å€¼
        t = getTheoRangeMidValue(theoRangeVal);
        
        // éš±è—è‡ªå‹•è¨ˆç®—æç¤º
        if (theoAutoCalcInfo) {
            theoAutoCalcInfo.style.display = 'none';
        }
        
        // æ›´æ–°æ¨™ç±¤æç¤º
        const modeSpan = document.getElementById('theoRangeMode');
        if (modeSpan) {
            modeSpan.innerHTML = 'ï¼ˆ<span style="color:#ff9800;">ğŸ“ æ‰‹å‹•é¸æ“‡</span>ï¼‰';
        }
    } else {
        // éƒ½æ²’è¼¸å…¥
        if (theoAutoCalcInfo) {
            theoAutoCalcInfo.style.display = 'none';
        }
        const modeSpan = document.getElementById('theoRangeMode');
        if (modeSpan) {
            modeSpan.innerHTML = 'ï¼ˆè¼¸å…¥è‚¡åƒ¹/è½‰æ›åƒ¹å¾Œè‡ªå‹•è¨ˆç®—ï¼‰';
        }
    }
    
    const r = document.getElementById('rating').value;
    const floorPrice = parseFloat(document.getElementById('floorPrice').value) || 100;
    
    // v3.72 ä¿®æ”¹ï¼šå¦‚æœæœ‰ç†è«–åƒ¹ï¼ˆç„¡è«–æ˜¯è¨ˆç®—é‚„æ˜¯é¸æ“‡çš„ï¼‰
    if(t > 0) { 
        // å»ºç«‹æ¢åˆ—å¼æé†’
        let tips = [];
        
        // 1. åŸºæœ¬è³‡è¨Š
        let headerMsg;
        if(s > 0 && actualC > 0) {
            headerMsg = `<div style="margin-bottom:8px;">
                <div>ç›®å‰ç†è«–åƒ¹ï¼š<b style="color:#667eea; font-size:20px;">${t.toFixed(2)} å…ƒ</b></div>
                <div style="font-size:13px; color:#666;">è½‰æ›åƒ¹ ${actualC} å…ƒï½œåº•æ¨™ ${floorPrice} å…ƒ</div>
                <div style="font-size:12px; color:#1976d2; margin-top:4px;">ğŸ’¡ ç†è«–åƒ¹æ ¼æœƒéš¨è‚¡åƒ¹æ³¢å‹•ï¼Œå»ºè­°ä»¥æˆªæ¨™æ—¥13:30æ”¶ç›¤åƒ¹è¨ˆç®—çš„ç†è«–åƒ¹æ ¼ç‚ºæœ€çµ‚è©•ä¼°åŸºç¤</div>
            </div>`;
        } else {
            headerMsg = `<div style="margin-bottom:8px;">
                <div>ç†è«–åƒ¹å€é–“ä¸­å€¼ï¼š<b style="color:#667eea; font-size:20px;">${t.toFixed(2)} å…ƒ</b></div>
                <div style="font-size:13px; color:#666;">åº•æ¨™ ${floorPrice} å…ƒ</div>
                <div style="font-size:12px; color:#9c27b0; margin-top:4px;">ğŸ’¡ æ‚¨é¸æ“‡äº†ç†è«–åƒ¹å€é–“ï¼Œç³»çµ±ä»¥å€é–“ä¸­å€¼é€²è¡Œä¼°ç®—ã€‚å»ºè­°è¼¸å…¥å¯¦éš›è‚¡åƒ¹å’Œè½‰æ›åƒ¹ä»¥ç²å¾—ç²¾ç¢ºè¨ˆç®—ã€‚</div>
            </div>`;
        }
        
        // 2. åˆ†ææ³•é©ç”¨æ€§åˆ¤æ–·ï¼ˆä»¥95å…ƒç‚ºåˆ†ç•Œï¼‰
        if (t < 95) {
            const deviation = 95 - t;
            if (deviation > 15) {
                tips.push(`<b>ç†è«–åƒ¹ ${t.toFixed(2)} å…ƒï¼Œåé›¢95å…ƒåˆ†ç•Œé»é” ${deviation.toFixed(1)} å…ƒ</b>`);
                tips.push(`æº¢åƒ¹ç‡åˆ†ææ³•åœ¨ä½ç†è«–åƒ¹æ™‚èª¤å·®è¼ƒå¤§ï¼Œé ä¼°åƒ¹æ ¼å¯èƒ½å¤±æº–`);
                tips.push(`<b style="color:#d32f2f;">å¼·çƒˆå»ºè­°ä»¥ã€Œå¾—æ¨™åƒ¹æ ¼åˆ†ææ³•ã€ç‚ºä¸»è¦åƒè€ƒä¾æ“š</b>`);
            } else if (deviation > 5) {
                tips.push(`ç†è«–åƒ¹ ${t.toFixed(2)} å…ƒï¼Œä½æ–¼95å…ƒåˆ†ç•Œé»`);
                tips.push(`å¾—æ¨™åƒ¹æ ¼åˆ†ææ³•åœ¨æ­¤å€é–“è¼ƒèƒ½åæ˜ å¸‚å ´å¯¦éš›è¡Œæƒ…`);
                tips.push(`å»ºè­°é‡é»åƒè€ƒã€Œå¾—æ¨™åƒ¹æ ¼åˆ†ææ³•ã€ï¼Œæº¢åƒ¹ç‡æ³•å¯ä½œè¼”åŠ©`);
            } else {
                tips.push(`ç†è«–åƒ¹ ${t.toFixed(2)} å…ƒï¼Œæ¥è¿‘95å…ƒåˆ†ç•Œé»`);
                tips.push(`å…©ç¨®åˆ†ææ³•çš†æœ‰åƒè€ƒåƒ¹å€¼ï¼Œå¯äº¤å‰æ¯”å°`);
                tips.push(`è‹¥å…©è€…å·®ç•°å¤§ï¼Œå»ºè­°åå‘å¾—æ¨™åƒ¹æ ¼åˆ†ææ³•`);
            }
        } else {
            // 95ä»¥ä¸Š
            if (t > 120) {
                tips.push(`ç†è«–åƒ¹ ${t.toFixed(2)} å…ƒï¼Œè™•æ–¼è¼ƒé«˜æ°´ä½`);
                tips.push(`é«˜ç†è«–åƒ¹æ¨™çš„æº¢åƒ¹ç©ºé–“æœ‰é™ï¼Œç«¶æ‹ç†±åº¦å¯èƒ½è¼ƒä½`);
                tips.push(`å»ºè­°æ¡ä¿å®ˆç­–ç•¥ï¼Œæ³¨æ„æº¢åƒ¹é¢¨éšª`);
            } else if (t < 105) {
                tips.push(`ç†è«–åƒ¹ ${t.toFixed(2)} å…ƒï¼Œè™•æ–¼å…·å¸å¼•åŠ›å€é–“`);
                tips.push(`å…©ç¨®åˆ†ææ³•çš†é©ç”¨ï¼Œå¯äº¤å‰åƒè€ƒ`);
                tips.push(`æ­¤å€é–“é€šå¸¸ç«¶æ‹ç†±åº¦è¼ƒé«˜ï¼Œå¯é©åº¦ç©æ¥µ`);
            } else {
                tips.push(`ç†è«–åƒ¹ ${t.toFixed(2)} å…ƒï¼Œè™•æ–¼åˆç†å€é–“`);
                tips.push(`æº¢åƒ¹ç‡åˆ†ææ³•è¼ƒç‚ºé©ç”¨`);
                tips.push(`å¯åƒè€ƒæ­·å²åŒé¡å‹æ¨™çš„æº¢åƒ¹ç‡ä½œç‚ºæŠ•æ¨™ä¾æ“š`);
            }
        }
        
        // 3. åº•æ¨™ç›¸é—œæé†’
        if (t * 1.10 < floorPrice) {
            tips.push(`<span style="color:#e65100;">âš ï¸ ç†è«–åƒ¹åŠ 10%ä»ä½æ–¼åº•æ¨™ï¼Œæº¢åƒ¹ç‡æ³•å°‡è‡ªå‹•èª¿æ•´ç‚ºåº•æ¨™åŸºæº–æ¨¡å¼</span>`);
        }
        
        // 4. ä¿¡è©•æé†’
        if (r && ['7','8','9'].includes(r)) {
            tips.push(`<span style="color:#d32f2f;">âš ï¸ ä¿¡è©• TCRI ${r} è¼ƒä½ï¼Œå¸‚å ´æ¥å—åº¦å¯èƒ½å—é™ï¼Œå»ºè­°æ¡ä¿å®ˆç­–ç•¥</span>`);
        }
        
        // çµ„åˆè¼¸å‡º
        let msg = headerMsg;
        msg += `<div style="border-top:1px solid #e0e0e0; padding-top:8px; margin-top:4px;">`;
        tips.forEach((tip, idx) => {
            msg += `<div style="margin-bottom:4px;">${idx + 1}. ${tip}</div>`;
        });
        msg += `</div>`;
        
        document.getElementById('reminderContent').innerHTML = msg; 
        // v3.97g ç§»é™¤ï¼šè¼¸å…¥å€ä¸å†é¡¯ç¤ºRexå¤§å”æé†’ï¼Œå·²ç§»è‡³çµæœå€æ­¥é©Ÿå ±å‘Š
        // document.getElementById('smartReminders').style.display='block'; 
    }
}

function generateRexCommentary(r) { 
    // v3.69 ä¿®æ”¹ï¼šå„ªåŒ–Rexå¤§å”åˆ†æå…§å®¹ï¼Œå¢åŠ è½‰æ›åƒ¹å€¼èªªæ˜èˆ‡åˆ†ææ³•å»ºè­°
    const theo = parseFloat(r.theoreticalPrice);
    const floor = parseFloat(r.floorPrice);
    const premiumConservative = parseFloat(r.premiumBidPrices.conservative);
    const premiumBalanced = parseFloat(r.premiumBidPrices.balanced);
    const priceConservative = parseFloat(r.priceBidPrices.conservative);
    const priceBalanced = parseFloat(r.priceBidPrices.balanced);
    const belowFloor = r.premiumBelowFloor;
    const totalLowP = parseFloat(r.totalLowPremium);
    const totalAvgP = parseFloat(r.totalAvgPremium);
    const impliedLowP = parseFloat(r.impliedLowPremium);
    const impliedAvgP = parseFloat(r.impliedAvgPremium);
    const weightedLowBid = parseFloat(r.weightedLowBidPrice);
    const weightedAvgBid = parseFloat(r.weightedAvgBidPrice);
    
    // è¨ˆç®—é¢¨éšªç›¸é—œæ•¸æ“š
    const maxLossPercent = ((premiumConservative - 100) / premiumConservative * 100).toFixed(2);
    const premiumVsPrice = (premiumBalanced - priceBalanced).toFixed(2);
    
    // v3.69 æ–°å¢ï¼šè¨ˆç®—è½‰æ›åƒ¹å€¼ç›¸é—œæ•¸æ“š
    const conversionValuePercent = (theo - 100).toFixed(2); // ç›¸å°æ–¼100å…ƒçš„å·®è·
    const aboveOrBelow = theo >= 100 ? 'é«˜æ–¼' : 'ä½æ–¼';
    const conversionNote = theo >= 100 
        ? `ç›®å‰å¸‚åƒ¹é«˜æ–¼è½‰æ›åƒ¹æ ¼ ${conversionValuePercent}%ï¼Œå¯è½‰å‚µå°‡è·Ÿè‘—è‚¡åƒ¹é€£å‹•æ¼²è·Œ`
        : `ç›®å‰å¸‚åƒ¹ä½æ–¼è½‰æ›åƒ¹æ ¼ ${Math.abs(conversionValuePercent)}%ï¼Œå¯è½‰å‚µåƒ¹æ ¼è¼ƒä¸å—è‚¡åƒ¹å½±éŸ¿ï¼Œä¸»è¦ç”±ç´”å‚µåƒ¹å€¼æ”¯æ’`;
    
    // v3.69 æ–°å¢ï¼šæº¢åƒ¹ç‡æ›ç®—åƒ¹æ ¼ã€å¾—æ¨™åƒ¹æ›ç®—æº¢åƒ¹ç‡
    const premiumPriceLow = (theo * (1 + totalLowP/100)).toFixed(2);
    const premiumPriceAvg = (theo * (1 + totalAvgP/100)).toFixed(2);
    const pricePremiumLow = theo > 0 ? ((weightedLowBid/theo - 1) * 100).toFixed(2) : '0.00';
    const pricePremiumAvg = theo > 0 ? ((weightedAvgBid/theo - 1) * 100).toFixed(2) : '0.00';
    
    // v3.69 æ–°å¢ï¼šåˆ†ææ³•å»ºè­°
    let methodRecommendation = '';
    if (theo >= 95) {
        methodRecommendation = 'ä»¥ç›®å‰ç†è«–åƒ¹ç‹€æ³ï¼Œé¸æ“‡<b style="color:#1976d2;">æº¢åƒ¹ç‡åˆ†ææ³•</b>è¼ƒå…·åƒè€ƒåƒ¹å€¼';
    } else if (theo >= 85) {
        methodRecommendation = 'ç†è«–åƒ¹æ¥è¿‘åˆ†ç•Œé»ï¼Œå»ºè­°<b style="color:#e65100;">å…©ç¨®åˆ†ææ³•äº¤å‰æ¯”å°</b>åƒè€ƒ';
    } else {
        methodRecommendation = 'ä»¥ç›®å‰ç†è«–åƒ¹ç‹€æ³ï¼Œé¸æ“‡<b style="color:#e65100;">å¾—æ¨™åƒ¹æ ¼åˆ†ææ³•</b>è¼ƒå…·åƒè€ƒåƒ¹å€¼';
    }
    
    let title = "";
    let situation = "";
    let strategy = "";
    let risk = "";
    let reminder = "";
    
    // v3.69 æ–°å¢ï¼šå¸‚å ´æ°›åœèˆ‡æ­·å²çµ„åˆæ¢ä»¶å€é–“èªªæ˜
    const marketAtmosphere = `<div style="background:#e8f5e9; padding:10px 12px; border-radius:6px; margin:10px 0; font-size:13px;">
        <div style="margin-bottom:8px;"><b style="color:#2e7d32;">ğŸ“Š è¿‘æœŸå¸‚å ´æ°›åœï¼ˆæº¢åƒ¹ç‡åˆ†ææ³•ï¼‰</b></div>
        <div>åŠ æ¬Šæº¢åƒ¹ç‡å€é–“ï¼š<b>${totalLowP}% ~ ${totalAvgP}%</b></div>
        <div style="color:#666;">â†’ æ›ç®—æŠ•æ¨™åƒ¹å€é–“ï¼š<b style="color:#1976d2;">${premiumPriceLow} ~ ${premiumPriceAvg} å…ƒ</b></div>
    </div>
    <div style="background:#fff3e0; padding:10px 12px; border-radius:6px; margin:10px 0; font-size:13px;">
        <div style="margin-bottom:8px;"><b style="color:#e65100;">ğŸ“ˆ æ­·å²çµ„åˆæ¢ä»¶ï¼ˆå¾—æ¨™åƒ¹æ ¼åˆ†ææ³•ï¼‰</b></div>
        <div>åŠ æ¬Šå¾—æ¨™åƒ¹å€é–“ï¼š<b>${weightedLowBid} ~ ${weightedAvgBid} å…ƒ</b></div>
        <div style="color:#666;">â†’ æ›ç®—æº¢åƒ¹ç‡å€é–“ï¼š<b style="color:#e65100;">${pricePremiumLow}% ~ ${pricePremiumAvg}%</b></div>
    </div>`;
    
    if (belowFloor) {
        // æƒ…å¢ƒä¸€ï¼šæº¢åƒ¹ç‡æ³•ä½æ–¼åº•æ¨™
        title = "âš ï¸ ç‰¹æ®Šæƒ…å¢ƒï¼šæº¢åƒ¹ç‡è¨ˆç®—ä½æ–¼åº•æ¨™";
        situation = `æœ¬æª”ç†è«–åƒ¹ ${r.theoreticalPrice} å…ƒï¼Œ${conversionNote}ã€‚æ­·å²æº¢åƒ¹ç‡è¨ˆç®—å‡ºçš„æŠ•æ¨™åƒ¹ä½æ–¼åº•æ¨™ ${r.floorPrice} å…ƒï¼Œç³»çµ±å·²è‡ªå‹•åˆ‡æ›ç‚ºã€Œåº•æ¨™åŸºæº–æ¨¡å¼ã€ã€‚`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>ç­–ç•¥å»ºè­°ï¼š</b></div>
            <div>1. ä¿å®ˆç­–ç•¥ï¼šä»¥åº•æ¨™ ${r.floorPrice} å…ƒæŠ•æ¨™ï¼ˆç›¸ç•¶æ–¼æº¢åƒ¹ç‡ ${r.floorBasedPremium}%ï¼‰</div>
            <div>2. å¹³è¡¡ç­–ç•¥ï¼šåº•æ¨™åŠ 3%ç´„ ${r.premiumBidPrices.balanced} å…ƒ</div>
            <div>3. åŒæ™‚åƒè€ƒå¾—æ¨™åƒ¹æ ¼åˆ†ææ³•çš„åŠ æ¬Šå¹³å‡ ${priceBalanced} å…ƒä½œç‚ºå¦ä¸€åƒè€ƒé»</div>`;
        risk = `<b>é¢¨éšªè©•ä¼°ï¼š</b>ä»¥åº•æ¨™æŠ•æ¨™ï¼Œæœ€å¤§æå¤±ç‚ºæ‰‹çºŒè²»ç´„0.5%ï¼Œé¢¨éšªæ¥µä½ã€‚ä½†éœ€æ³¨æ„æ­¤é¡æ¨™çš„å¯èƒ½ç«¶çˆ­æ¿€çƒˆï¼Œå¾—æ¨™æ©Ÿç‡éœ€è©•ä¼°ã€‚`;
        reminder = "ç«¶æ‹çš„æ ¸å¿ƒæ˜¯æ§åˆ¶æˆæœ¬ï¼Œåœ¨é€™ç¨®æƒ…å¢ƒä¸‹ï¼Œç”¨åº•æ¨™æŠ•æ¨™æ˜¯æœ€ä¿å®ˆçš„é¸æ“‡ï¼Œè®“è‡ªå·±ç«‹æ–¼ä¸æ•—ä¹‹åœ°ã€‚";
        
    } else if (theo < 85) {
        // æƒ…å¢ƒäºŒï¼šç†è«–åƒ¹å¾ˆä½ï¼ˆ<85å…ƒï¼‰
        title = "ğŸ“Š ä½ç†è«–åƒ¹æƒ…å¢ƒåˆ†æ";
        situation = `ç†è«–åƒ¹ ${r.theoreticalPrice} å…ƒæ˜é¡¯åä½ï¼Œ${conversionNote}ã€‚<br><br>${methodRecommendation}ï¼Œæº¢åƒ¹ç‡åˆ†ææ³•çš„åƒè€ƒåƒ¹å€¼æœ‰é™ã€‚`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>ç­–ç•¥å»ºè­°ï¼š</b></div>
            <div>1. <b>å¼·çƒˆå»ºè­°ä»¥ã€Œå¾—æ¨™åƒ¹æ ¼åˆ†ææ³•ã€ç‚ºä¸»</b></div>
            <div>2. ä¿å®ˆåƒ¹åƒè€ƒï¼š${priceConservative} å…ƒï¼ˆåŠ æ¬Šæœ€ä½å¾—æ¨™åƒ¹ï¼‰</div>
            <div>3. å¹³è¡¡åƒ¹åƒè€ƒï¼š${priceBalanced} å…ƒï¼ˆåŠ æ¬Šå¹³å‡å¾—æ¨™åƒ¹ï¼‰</div>
            <div>4. æº¢åƒ¹ç‡æ³•åƒ…ä¾›è¼”åŠ©åƒè€ƒï¼Œä¸å»ºè­°ä½œç‚ºä¸»è¦ä¾æ“š</div>`;
        risk = `<b>é¢¨éšªè©•ä¼°ï¼š</b>ä½ç†è«–åƒ¹æ¨™çš„é€šå¸¸ä»£è¡¨è‚¡åƒ¹ç›¸å°è½‰æ›åƒ¹åä½ï¼Œéœ€ç‰¹åˆ¥é—œæ³¨å…¬å¸åŸºæœ¬é¢èˆ‡æœªä¾†è‚¡åƒ¹èµ°å‹¢ã€‚ä»¥ ${priceConservative} å…ƒæŠ•æ¨™ï¼Œæœ€å¤§æå¤±ç´„ ${((priceConservative-100)/priceConservative*100).toFixed(1)}%ã€‚`;
        reminder = "è¨˜ä½ï¼Œç«¶æ‹æœ€å¤§çš„å¥½è™•å°±æ˜¯ä½ å¯ä»¥æ§åˆ¶æŠ•å…¥æˆæœ¬ï¼Œåœ¨ä½ç†è«–åƒ¹æƒ…å¢ƒæ›´è¦è¬¹æ…è©•ä¼°æ˜¯å¦åƒèˆ‡ã€‚";
        
    } else if (theo < 95) {
        // æƒ…å¢ƒä¸‰ï¼šç†è«–åƒ¹åä½ï¼ˆ85-95å…ƒï¼‰
        title = "ğŸ’¡ ç†è«–åƒ¹æ¥è¿‘åˆ†ç•Œé»æƒ…å¢ƒ";
        situation = `ç†è«–åƒ¹ ${r.theoreticalPrice} å…ƒç•¥ä½æ–¼95å…ƒåˆ†ç•Œé»ï¼Œ${conversionNote}ã€‚<br><br>${methodRecommendation}ã€‚`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>ç­–ç•¥å»ºè­°ï¼š</b></div>
            <div>1. ä¸»è¦åƒè€ƒã€Œå¾—æ¨™åƒ¹æ ¼åˆ†ææ³•ã€ï¼š${priceConservative} ~ ${priceBalanced} å…ƒ</div>
            <div>2. è¼”åŠ©åƒè€ƒã€Œæº¢åƒ¹ç‡åˆ†ææ³•ã€ï¼š${premiumConservative} ~ ${premiumBalanced} å…ƒ</div>
            <div>3. å…©è€…å·®ç•° ${Math.abs(premiumVsPrice)} å…ƒï¼Œå»ºè­°å–è¼ƒä¿å®ˆçš„åƒ¹æ ¼</div>`;
        risk = `<b>é¢¨éšªè©•ä¼°ï¼š</b>ä»¥ä¿å®ˆåƒ¹ ${Math.min(premiumConservative, priceConservative).toFixed(2)} å…ƒæŠ•æ¨™ï¼Œæœ€å¤§æå¤±æ§åˆ¶åœ¨ ${maxLossPercent}% å·¦å³ï¼Œå±¬æ–¼å¯æ¥å—ç¯„åœã€‚`;
        reminder = "åœ¨åˆ†ç•Œé»é™„è¿‘ï¼Œäº¤å‰æ¯”å°å…©ç¨®åˆ†ææ³•èƒ½è®“ä½ çš„åˆ¤æ–·æ›´å®¢è§€ï¼Œä¸è¦åªçœ‹å–®ä¸€æ•¸æ“šã€‚";
        
    } else if (theo >= 95 && theo <= 105) {
        // æƒ…å¢ƒå››ï¼šç†è«–åƒ¹é©ä¸­ï¼ˆ95-105å…ƒï¼‰
        title = "âœ¨ ç†æƒ³æŠ•æ¨™å€é–“æƒ…å¢ƒ";
        situation = `ç†è«–åƒ¹ ${r.theoreticalPrice} å…ƒè™•æ–¼95-105å…ƒçš„ç†æƒ³å€é–“ï¼Œ${conversionNote}ã€‚<br><br>${methodRecommendation}ï¼Œæ­·å²è³‡æ–™åƒè€ƒåƒ¹å€¼é«˜ã€‚`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>ç­–ç•¥å»ºè­°ï¼š</b></div>
            <div>1. ä¿å®ˆç­–ç•¥ï¼š${premiumConservative} å…ƒï¼ˆæº¢åƒ¹ç‡ ${totalLowP}%ï¼‰</div>
            <div>2. å¹³è¡¡ç­–ç•¥ï¼š${premiumBalanced} å…ƒï¼ˆæº¢åƒ¹ç‡ ${totalAvgP}%ï¼‰</div>
            <div>3. æ­¤å€é–“é€šå¸¸ç«¶æ‹ç†±åº¦è¼ƒé«˜ï¼Œæƒ³å¾—æ¨™å¯è€ƒæ…®å¹³è¡¡æˆ–ç©æ¥µç­–ç•¥</div>`;
        risk = `<b>é¢¨éšªè©•ä¼°ï¼š</b>ä»¥ ${premiumConservative} å…ƒæŠ•æ¨™ï¼Œä¸‰å¹´æœ€å¤§æå¤±ç´„ ${maxLossPercent}%ï¼ˆç´„ ${(premiumConservative-100).toFixed(1)} å…ƒ/å¼µï¼‰ã€‚é€™å€‹é¢¨éšªæ˜¯ä½ é€²å ´å‰å°±èƒ½ç¢ºå®šçš„ï¼Œé€™å°±æ˜¯ç«¶æ‹æ§åˆ¶é¢¨éšªçš„ç²¾é«“ã€‚`;
        reminder = "é€™ç¨®ç†è«–åƒ¹çš„æ¨™çš„æ˜¯ç·´ç¿’ç«¶æ‹çš„å¥½æ©Ÿæœƒï¼Œé¢¨éšªå¯æ§ä¸”æœ‰ç²åˆ©ç©ºé–“ï¼Œå€¼å¾—èªçœŸè©•ä¼°åƒèˆ‡ã€‚";
        
    } else if (theo > 105 && theo <= 115) {
        // æƒ…å¢ƒäº”ï¼šç†è«–åƒ¹åé«˜ï¼ˆ105-115å…ƒï¼‰
        title = "ğŸ”¥ è¼ƒé«˜ç†è«–åƒ¹æƒ…å¢ƒ";
        situation = `ç†è«–åƒ¹ ${r.theoreticalPrice} å…ƒåé«˜ï¼Œ${conversionNote}ï¼Œå·²å…·å‚™è½‰æ›åƒ¹å€¼ã€‚<br><br>${methodRecommendation}ã€‚`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>ç­–ç•¥å»ºè­°ï¼š</b></div>
            <div>1. å»ºè­°æ¡ã€Œä¿å®ˆã€ç­–ç•¥ï¼š${premiumConservative} å…ƒ</div>
            <div>2. é«˜ç†è«–åƒ¹æ¨™çš„ä¸å®œè¿½é«˜ï¼Œåš´æ§æŠ•æ¨™æˆæœ¬</div>
            <div>3. å¦‚æœä¿å®ˆåƒ¹ä»è¦ºå¾—å¤ªé«˜ï¼Œå¯ä»¥è€ƒæ…®é™ä½æŠ•æ¨™å¼µæ•¸æˆ–æ”¾æ£„</div>`;
        risk = `<b>é¢¨éšªè©•ä¼°ï¼š</b>é«˜ç†è«–åƒ¹ä¸ä»£è¡¨æ²’é¢¨éšªï¼Œè‚¡åƒ¹å›æª”æ™‚å¯è½‰å‚µåƒ¹æ ¼ä¹Ÿæœƒä¸‹è·Œã€‚ä»¥ ${premiumConservative} å…ƒæŠ•æ¨™ï¼Œæœ€å¤§æå¤± ${maxLossPercent}%ã€‚`;
        reminder = "ä¸è¦å› ç‚ºæ¨™çš„ç†±é–€å°±è¡å‹•è¿½é«˜ï¼Œè¨˜ä½æˆ‘å€‘åƒèˆ‡ç«¶æ‹çš„æ ¸å¿ƒç›®çš„æ˜¯æ§åˆ¶æˆæœ¬ï¼Œä¸æ˜¯æ¶ç±Œç¢¼ã€‚";
        
    } else {
        // æƒ…å¢ƒå…­ï¼šç†è«–åƒ¹å¾ˆé«˜ï¼ˆ>115å…ƒï¼‰
        title = "âš¡ é«˜ç†è«–åƒ¹è­¦ç¤º";
        situation = `ç†è«–åƒ¹ ${r.theoreticalPrice} å…ƒå·²ç¶“ç›¸ç•¶é«˜ï¼Œ${conversionNote}ï¼Œå·²å…·å‚™æ˜é¡¯è½‰æ›åƒ¹å€¼ã€‚<br><br>${methodRecommendation}ï¼Œä½†å¸‚å ´ç«¶çˆ­å¯èƒ½è¼ƒæ¿€çƒˆã€‚`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>ç­–ç•¥å»ºè­°ï¼š</b></div>
            <div>1. åš´æ ¼æ¡ç”¨ã€Œä¿å®ˆã€ç­–ç•¥ï¼š${premiumConservative} å…ƒ</div>
            <div>2. èªçœŸè©•ä¼°æ˜¯å¦å€¼å¾—åƒèˆ‡ï¼Œé«˜åƒ¹å¾—æ¨™çš„é¢¨éšªä¸ä½</div>
            <div>3. å¦‚åŸ·æ„åƒèˆ‡ï¼Œå»ºè­°é™ä½æŠ•æ¨™å¼µæ•¸ï¼Œæ§åˆ¶æ•´é«”æ›éšª</div>`;
        risk = `<b>é¢¨éšªè©•ä¼°ï¼š</b>é«˜ç†è«–åƒ¹æ¨™çš„åœ¨è‚¡åƒ¹å›æª”æ™‚æå¤±å¯èƒ½è¼ƒå¤§ã€‚å»ºè­°å°‡æ­¤é¡æ¨™çš„çš„æŠ•æ¨™è³‡é‡‘æ§åˆ¶åœ¨ç¸½æŠ•è³‡éƒ¨ä½çš„è¼ƒå°æ¯”ä¾‹ã€‚`;
        reminder = "æœ‰æ™‚å€™æœ€å¥½çš„æŠ•è³‡æ±ºç­–æ˜¯ã€Œä¸åƒèˆ‡ã€ã€‚ä¸æ˜¯æ¯ä¸€æª”éƒ½è¦æ‹ï¼Œé¸æ“‡é©åˆè‡ªå·±é¢¨éšªæ‰¿å—åº¦çš„æ¨™çš„æ›´é‡è¦ã€‚";
    }
    
    // çµ„åˆè¼¸å‡º
    return `<div class="rex-analysis">
        <div class="rex-title">ğŸ§¢ Rexå¤§å”æé†’</div>
        <div class="rex-content">
            <div style="font-size:15px; font-weight:bold; color:#1565c0; margin-bottom:10px;">${title}</div>
            <div style="margin-bottom:12px;">${situation}</div>
            <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:12px;">${strategy}</div>
            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:12px;">${risk}</div>
            <div style="border-left:4px solid #667eea; padding-left:12px; font-style:italic; color:#555;">ğŸ’¬ ${reminder}</div>
        </div>
    </div>`; 
}

function calculateEvaluation(d) {
    // v3.69 ä¿®æ”¹ï¼šåŒæ™‚è¨ˆç®—å…©ç¨®åˆ†ææ³•ï¼Œéƒ½å‘ˆç¾çµ¦ç”¨æˆ¶åƒè€ƒ
    // å¾å€é–“å­—ä¸²æå–ä¸­é–“å€¼ç”¨æ–¼è¨ˆç®—
    function getRangeMidValue(rangeStr, type) {
        if (typeof rangeStr === 'number' && !isNaN(rangeStr)) return rangeStr;
        const str = String(rangeStr || '');
        // è½‰æ›åƒ¹å€é–“
        if (type === 'conversion') {
            if (str.includes('å°æ–¼20')) return 15;
            if (str.includes('20~50')) return 35;
            if (str.includes('50~100')) return 75;
            if (str.includes('100~150')) return 125;
            if (str.includes('150~200')) return 175;
            if (str.includes('å¤§æ–¼200')) return 250;
        }
        // è‚¡æœ¬å€é–“
        if (type === 'capital') {
            if (str.includes('å°æ–¼3')) return 2;
            if (str.includes('3~6')) return 4.5;
            if (str.includes('6~10')) return 8;
            if (str.includes('10~15')) return 12.5;
            if (str.includes('15~20')) return 17.5;
            if (str.includes('å¤§æ–¼20')) return 30;
        }
        // ç™¼è¡Œè¦æ¨¡å€é–“
        if (type === 'size') {
            if (str.includes('å°æ–¼2')) return 1.5;
            if (str.includes('2~5')) return 3.5;
            if (str.includes('5~10')) return 7.5;
            if (str.includes('10~15')) return 12.5;
            if (str.includes('15~20')) return 17.5;
            if (str.includes('å¤§æ–¼20')) return 30;
        }
        // å˜—è©¦è§£æç‚ºæ•¸å­—
        const num = parseFloat(str);
        return isNaN(num) ? 0 : num;
    }
    
    // v3.72 ä¿®æ”¹ï¼šç†è«–åƒ¹è¨ˆç®—æ”¯æ´å…©ç¨®æ–¹å¼
    // æ–¹å¼ä¸€ï¼šå¾è‚¡åƒ¹å’Œè½‰æ›åƒ¹è¨ˆç®—ï¼ˆå„ªå…ˆï¼‰
    // æ–¹å¼äºŒï¼šå¾ç†è«–åƒ¹å€é–“ç²å–ä¸­é–“å€¼ï¼ˆå‚™ç”¨ï¼‰
    const actualConvPrice = d.actualConversionPrice || 0;
    let theo = 0;
    
    if (d.stockPrice > 0 && actualConvPrice > 0) {
        // æ–¹å¼ä¸€ï¼šç²¾ç¢ºè¨ˆç®—
        theo = (d.stockPrice / actualConvPrice) * 100;
    } else if (d.theoRange) {
        // æ–¹å¼äºŒï¼šå¾å€é–“å–ä¸­é–“å€¼
        theo = getRangeMidValue(d.theoRange, 'theoRange');
    }
    
    const floorPrice = d.floorPrice || 100; // åº•æ¨™åƒ¹æ ¼ï¼Œé è¨­100å…ƒ
    const brokerName = d.broker || ""; 
    
    // v3.72 ä¿®æ”¹ï¼šæ ¹æ“š75æª”CBåˆ†æçµè«–ï¼Œé‡æ–°å„ªåŒ–ç¶­åº¦æ¬Šé‡
    // æŒ‰é¡¯è‘—æ€§æ’åºï¼šç†è«–åƒ¹(30%)>æ‰¿éŠ·å•†(18%)>è¦æ¨¡(12%)>ç”¢æ¥­(12%)>å¹´æœŸ(8%)>è‚¡æœ¬(5%)>ä¿¡è©•(3%)
    // æ“”ä¿ä½œç‚ºèª¿æ•´å› ç´ ï¼ˆä¸é€²ç¶­åº¦è¡¨ï¼‰
    // v3.90 ä¿®æ­£ï¼šæŒ‰å»ºè­°æ¬Šé‡é…ç½®èª¿æ•´
    // ç”¢æ¥­30%ã€ä¿¡è©•22%ã€ç†è«–åƒ¹15%ã€åˆ¸å•†13%ã€è¦æ¨¡10%ã€è‚¡æœ¬5%ã€å¹´æœŸ5%
    const allDims = [
        {k:'industry',c:'ç”¢æ¥­',baseW:0.30,v:d.industry},            // â˜…â˜…â˜…â˜…â˜… ç”¢æ¥­30% å¯¦è­‰å½±éŸ¿æœ€å¤§
        {k:'rating',c:'ä¿¡è©•',baseW:0.22,v:d.rating},                // â˜…â˜…â˜…â˜…â˜† ä¿¡è©•22% åŸæœ¬åš´é‡ä½ä¼°
        {k:'theoRange',c:'ç†è«–åƒ¹',baseW:0.15,v:d.theoRange},        // â˜…â˜…â˜…â˜†â˜† ç†è«–åƒ¹15% åŸæœ¬éé«˜
        {k:'broker',c:'ç™¼è¡Œåˆ¸å•†',baseW:0.13,v:brokerName},          // â˜…â˜…â˜…â˜†â˜† åˆ¸å•†13% é™ä½éåº¦æ“¬åˆ
        {k:'size',c:'ç™¼è¡Œè¦æ¨¡',baseW:0.10,v:d.issueSize},           // â˜…â˜…â˜†â˜†â˜† è¦æ¨¡10% ä¸­ç­‰å½±éŸ¿
        {k:'capital',c:'è‚¡æœ¬',baseW:0.05,v:d.capital},              // â˜…â˜†â˜†â˜†â˜† è‚¡æœ¬5% å½±éŸ¿è¼ƒå°
        {k:'years',c:'å¹´æœŸ',baseW:0.05,v:d.years}                   // â˜…â˜†â˜†â˜†â˜† å¹´æœŸ5% å½±éŸ¿æœ€å°
    ];
    
    // ç¯©é¸æœ‰å¡«å¯«çš„ç¶­åº¦
    const filledDims = allDims.filter(x => x.v && x.v !== '');
    
    // è¨ˆç®—æœ‰å¡«å¯«ç¶­åº¦çš„ç¸½æ¬Šé‡
    const totalBaseWeight = filledDims.reduce((sum, x) => sum + x.baseW, 0);
    
    // å‹•æ…‹èª¿æ•´æ¬Šé‡ï¼ˆæŒ‰æ¯”ä¾‹åˆ†é…åˆ°100%ï¼‰
    const dims = filledDims.map(x => ({
        ...x,
        w: totalBaseWeight > 0 ? x.baseW / totalBaseWeight : 0
    }));
    
    // === è¨ˆç®—å„ç¶­åº¦æ•¸æ“šï¼ˆå…©ç¨®æ–¹æ³•éƒ½è¦ï¼‰===
    let wL=0, wA=0, resDims={};
    let wLowBid=0, wAvgBid=0; // å¾—æ¨™åƒ¹æ ¼åˆ†ææ³•ç”¨
    
    dims.forEach(x=>{
        const s = getStatsSmart(x.c, x.v), coef = getWeightCoefficient(x.k, x.v);
        
        // æº¢åƒ¹ç‡æ•¸æ“š
        resDims[x.k] = { 
            ...s, 
            coefficient: coef, 
            weight: x.w, 
            range: x.v, 
            weightedLow: s.low*x.w*coef, 
            weightedAvg: s.avg*x.w*coef
        };
        
        // å¾—æ¨™åƒ¹æ ¼æ•¸æ“šï¼ˆå¾rawDataå–å¾—ï¼‰
        const lowBidPrice = s.rawData && s.rawData['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'] ? s.rawData['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'] : 0;
        const avgBidPrice = s.rawData && s.rawData['å¹³å‡å¾—æ¨™åƒ¹'] ? s.rawData['å¹³å‡å¾—æ¨™åƒ¹'] : 0;
        resDims[x.k].lowBidPrice = lowBidPrice;
        resDims[x.k].avgBidPrice = avgBidPrice;
        resDims[x.k].weightedLowBid = lowBidPrice * x.w * coef;
        resDims[x.k].weightedAvgBid = avgBidPrice * x.w * coef;
        
        if (s.rawData && s.rawData['å€é–“åç¨±']) resDims[x.k].displayRange = s.rawData['å€é–“åç¨±'];
        else resDims[x.k].displayRange = x.v;
        
        wL += resDims[x.k].weightedLow; 
        wA += resDims[x.k].weightedAvg;
        wLowBid += resDims[x.k].weightedLowBid;
        wAvgBid += resDims[x.k].weightedAvgBid;
    });
    
    const subR = (d.subjectiveWeight||0)/100, objR = 1-subR;
    let tL = (wL*objR)+((d.subjectiveLowPremium||0)*subR);
    let tA = (wA*objR)+((d.subjectiveAvgPremium||0)*subR);
    
    // v3.72 æ–°å¢ï¼šæ“”ä¿èª¿æ•´å› ç´ ï¼ˆä¸ä½œç‚ºç¶­åº¦ï¼Œè€Œæ˜¯æœ€çµ‚èª¿æ•´ï¼‰
    const guaranteeAdj = (d.guarantee === 'æœ‰æ“”ä¿') ? 1.0 : 0;
    tL += guaranteeAdj;
    tA += guaranteeAdj;
    
    const gap = tA-tL;
    
    // === æº¢åƒ¹ç‡åˆ†ææ³•è¨ˆç®— ===
    const rawPremiumP1 = theo*(1+tL/100);  // åŸå§‹è¨ˆç®—å€¼
    const rawPremiumP2 = theo*(1+tA/100);
    const rawPremiumP3 = theo*(1+(tA+gap)/100);
    const rawPremiumP4 = theo*(1+(tA+gap*2)/100);
    const premiumBelowFloor = rawPremiumP1 < floorPrice;
    
    // v3.69 ä¿®æ”¹ï¼šç•¶ä½æ–¼åº•æ¨™æ™‚ï¼Œä»¥åº•æ¨™ç‚ºåŸºæº–è¨ˆç®—
    let premiumP1, premiumP2, premiumP3, premiumP4;
    let floorBasedPremium = 0;  // ä»¥åº•æ¨™æŠ•æ¨™çš„æº¢åƒ¹ç‡
    
    if (premiumBelowFloor) {
        // ä¿å®ˆ=åº•æ¨™ï¼Œå¹³è¡¡=åº•æ¨™+3%ï¼Œç©æ¥µ=åº•æ¨™+5%ï¼Œæ¥µè‡´=åº•æ¨™+7%
        premiumP1 = floorPrice;
        premiumP2 = floorPrice * 1.03;
        premiumP3 = floorPrice * 1.05;
        premiumP4 = floorPrice * 1.07;
        // è¨ˆç®—ä»¥åº•æ¨™æŠ•æ¨™çš„éš±å«æº¢åƒ¹ç‡
        floorBasedPremium = theo > 0 ? ((floorPrice/theo) - 1) * 100 : 0;
    } else {
        premiumP1 = rawPremiumP1;
        premiumP2 = rawPremiumP2;
        premiumP3 = rawPremiumP3;
        premiumP4 = rawPremiumP4;
    }
    
    // === å¾—æ¨™åƒ¹æ ¼åˆ†ææ³•è¨ˆç®— ===
    const weightedLowBidPrice = wLowBid > 0 ? wLowBid : floorPrice;
    const weightedAvgBidPrice = wAvgBid > 0 ? wAvgBid : floorPrice + 2;
    const bidGap = weightedAvgBidPrice - weightedLowBidPrice;
    
    // ç¢ºä¿ä¸ä½æ–¼åº•æ¨™åƒ¹æ ¼
    const priceP1 = Math.max(weightedLowBidPrice, floorPrice);
    const priceP2 = Math.max(weightedAvgBidPrice, floorPrice);
    const priceP3 = Math.max(weightedAvgBidPrice + bidGap, floorPrice);
    const priceP4 = Math.max(weightedAvgBidPrice + bidGap * 2, floorPrice);
    
    // åæ¨æº¢åƒ¹ç‡ï¼ˆç›¸å°æ–¼ç†è«–åƒ¹ï¼‰
    const impliedLowPremium = theo > 0 ? ((priceP1/theo) - 1) * 100 : 0;
    const impliedAvgPremium = theo > 0 ? ((priceP2/theo) - 1) * 100 : 0;

    // === v3.70 æ–°å¢ï¼šç†±åº¦åˆ†æï¼ˆå›æ¸¬åŠŸèƒ½ï¼‰===
    const atmosphere = calcMarketAtmosphere(5);
    const atmosphereIndex = atmosphere ? atmosphere.atmosphereIndex : 50;
    const sizeMid = getRangeMidValue(d.issueSize, 'size');

    const heatResult = calcHeatIndex({
        issueSize: sizeMid,
        theoreticalPrice: theo,
        industry: d.industry,
        years: d.years || 3,
        atmosphereIndex: atmosphereIndex,
        rating: d.rating || '5',           // v3.82 æ–°å¢
        broker: d.broker || '',            // v3.82 æ–°å¢
        stockCap: getRangeMidValue(d.capital, 'capital') || 10  // v3.82 æ–°å¢
    });

    // v3.82 åŒé¡æ¡ˆä»¶çµ±è¨ˆï¼ˆç”¨æ–¼çµ±è¨ˆé¡¯ç¤ºï¼Œä¿æŒå‘å¾Œå…¼å®¹ï¼‰
    const similarCasesStats = findSimilarCasesForStats({
        theoreticalPrice: theo,
        issueSize: sizeMid,
        industry: d.industry
    });

    // === v3.72 æ–°å¢ï¼šä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹é æ¸¬ ===
    const estBidMultiple = d.estBidMultiple || (heatResult ? heatResult.expectedMultiple : 2.5);
    const guaranteeType = d.guarantee || '';
    const yearsNum = parseInt(d.years) || 3;
    const industryName = d.industry || '';
    
    const majorPlayerResult = predictMajorPlayerBid(
        theo,
        estBidMultiple,
        sizeMid,
        brokerName,
        guaranteeType,
        yearsNum,
        industryName  // v3.73 æ–°å¢ï¼šå‚³å…¥ç”¢æ¥­åƒæ•¸
    );

    return {
        cbName: d.cbName, 
        theoreticalPrice: safeFixed(theo), 
        floorPrice: floorPrice,
        dimensions: resDims, 
        filledDimCount: dims.length,  // v3.69 æ–°å¢ï¼šå·²å¡«å¯«ç¶­åº¦æ•¸é‡
        totalDimCount: allDims.length,  // v3.69 æ–°å¢ï¼šç¸½ç¶­åº¦æ•¸é‡
        
        // === æº¢åƒ¹ç‡åˆ†ææ³•çµæœ ===
        totalLowPremium: safeFixed(tL), 
        totalAvgPremium: safeFixed(tA),
        premiumBidPrices: { 
            conservative: safeFixed(premiumP1), 
            balanced: safeFixed(premiumP2), 
            aggressive: safeFixed(premiumP3), 
            ultimate: safeFixed(premiumP4) 
        },
        premiumBelowFloor: premiumBelowFloor,
        floorBasedPremium: safeFixed(floorBasedPremium),  // v3.69 ä»¥åº•æ¨™æŠ•æ¨™çš„éš±å«æº¢åƒ¹ç‡
        guaranteeAdj: guaranteeAdj,  // v3.72 æ–°å¢ï¼šæ“”ä¿èª¿æ•´å€¼
        
        // === å¾—æ¨™åƒ¹æ ¼åˆ†ææ³•çµæœ ===
        weightedLowBidPrice: safeFixed(weightedLowBidPrice),
        weightedAvgBidPrice: safeFixed(weightedAvgBidPrice),
        impliedLowPremium: safeFixed(impliedLowPremium),
        impliedAvgPremium: safeFixed(impliedAvgPremium),
        priceBidPrices: { 
            conservative: safeFixed(priceP1), 
            balanced: safeFixed(priceP2), 
            aggressive: safeFixed(priceP3), 
            ultimate: safeFixed(priceP4) 
        },
        
        inputData: d, 
        weightedSubjectiveLow: safeFixed(((d.subjectiveLowPremium||0)*subR)), 
        weightedSubjectiveAvg: safeFixed(((d.subjectiveAvgPremium||0)*subR)),
        
        // === v3.70 æ–°å¢ï¼šç†±åº¦åˆ†æçµæœ ===
        heatAnalysis: heatResult,
        similarCases: similarCasesStats,  // v3.82 ä¿æŒå‘å¾Œå…¼å®¹ï¼Œä½¿ç”¨çµ±è¨ˆç‰ˆæœ¬
        marketAtmosphere: atmosphere,
        
        // === v3.72 æ–°å¢ï¼šä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹çµæœ ===
        majorPlayerResult: majorPlayerResult,
        estBidMultiple: estBidMultiple,
        
        // === v3.97o æ–°å¢ï¼šæ•´é«”æ­·å²ç„¡åŠ æ¬Šæ•¸æ“šï¼ˆç”¨æ–¼Step 1å°æ¯”ï¼‰ ===
        overallLowPremium: window.OVERALL_STATS?.avgLowPremium || 6.5,
        overallAvgPremium: window.OVERALL_STATS?.avgAvgPremium || 8.0,
        overallLowBidPrice: window.OVERALL_STATS?.avgMinBid || 106.5,
        overallAvgBidPrice: window.OVERALL_STATS?.avgAvgBid || 108.0
    };
}

function displayResult(r) {
    document.getElementById('welcomeMsg').style.display = 'none';
    
    // v3.97j é¡¯ç¤ºæ­¥é©Ÿå¼å ±å‘Š
    document.getElementById('stepReport').style.display = 'block';
    
    // æ»¾å‹•åˆ°çµæœå€é ‚éƒ¨
    setTimeout(() => {
        const stepReport = document.getElementById('stepReport');
        if (stepReport) {
            stepReport.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 100);
    
    // Step 0: Rexå¤§å”æé†’
    const reminderContent = document.getElementById('reminderContent');
    if (reminderContent && reminderContent.innerHTML.trim()) {
        document.getElementById('step0Reminder').innerHTML = reminderContent.innerHTML;
    } else {
        document.getElementById('step0Reminder').innerHTML = `
            <div>â€¢ ç«¶æ‹æŠ•æ¨™åƒ¹æ ¼æ‡‰ä»¥<b>æˆªæ¨™æ—¥13:30æ”¶ç›¤åƒ¹</b>è¨ˆç®—çš„ç†è«–åƒ¹ç‚ºåŸºæº–</div>
            <div>â€¢ æº¢åƒ¹ç‡æœƒéš¨å¸‚å ´æ°›åœè®Šå‹•ï¼Œç†±é–€æ¨™çš„æº¢åƒ¹è¼ƒé«˜</div>
            <div>â€¢ å»ºè­°åƒ¹æ ¼åƒ…ä¾›åƒè€ƒï¼Œè«‹æ ¹æ“šè‡ªèº«é¢¨éšªæ‰¿å—åº¦èª¿æ•´</div>
        `;
    }
    
    // ========== Step 1: åŸºç¤æ•¸æ“šåˆ†æ ==========
    const stockPrice = r.inputData.stockPrice || 0;
    const convPrice = r.inputData.actualConversionPrice || 0;
    const theoPrice = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;
    const usePremiumMethod = theoPrice >= 97.5;
    
    // å¡«å……ç†è«–åƒ¹èˆ‡æ–¹æ³•
    document.getElementById('step1TheoPrice').textContent = theoPrice > 0 ? theoPrice.toFixed(2) + 'å…ƒ' : '--';
    const methodName = usePremiumMethod ? 'æº¢åƒ¹ç‡åˆ†ææ³•' : 'å¾—æ¨™å‡åƒ¹åˆ†ææ³•';
    document.getElementById('step1MethodName').textContent = methodName;
    document.getElementById('step1MethodLabel').textContent = methodName;
    
    // å¾ r ä¸­å–å¾—æ•¸æ“š
    const avgPremium = parseFloat(r.totalAvgPremium) || 0;  // åŠ æ¬Šå¹³å‡æº¢åƒ¹ç‡
    const lowPremium = parseFloat(r.totalLowPremium) || 0;  // åŠ æ¬Šæœ€ä½æº¢åƒ¹ç‡
    const weightedLowBid = parseFloat(r.weightedLowBidPrice) || 0;  // åŠ æ¬Šæœ€ä½å¾—æ¨™åƒ¹
    const weightedAvgBid = parseFloat(r.weightedAvgBidPrice) || 0;  // åŠ æ¬Šå¹³å‡å¾—æ¨™åƒ¹
    
    // ç„¡åŠ æ¬Šæ•¸æ“šï¼ˆæ•´é«”æ­·å²å¹³å‡ï¼‰
    const noWeightAvgPremium = parseFloat(r.overallAvgPremium) || avgPremium;
    const noWeightLowPremium = parseFloat(r.overallLowPremium) || lowPremium;
    const noWeightAvgBid = parseFloat(r.overallAvgBidPrice) || weightedAvgBid;
    const noWeightLowBid = parseFloat(r.overallLowBidPrice) || weightedLowBid;
    
    // è¨ˆç®—åƒ¹æ ¼å€é–“
    let noWeightLow, noWeightHigh, weightLow, weightHigh;
    
    if (usePremiumMethod) {
        // æº¢åƒ¹ç‡æ³•
        noWeightLow = theoPrice * (1 + noWeightLowPremium / 100);
        noWeightHigh = theoPrice * (1 + noWeightAvgPremium / 100);
        weightLow = theoPrice * (1 + lowPremium / 100);
        weightHigh = theoPrice * (1 + avgPremium / 100);
        
        document.getElementById('step1NoWeightPremium').textContent = 
            `${noWeightLowPremium.toFixed(2)}% ~ ${noWeightAvgPremium.toFixed(2)}%`;
        document.getElementById('step1WeightPremium').textContent = 
            `${lowPremium.toFixed(2)}% ~ ${avgPremium.toFixed(2)}%`;
    } else {
        // å¾—æ¨™å‡åƒ¹æ³•
        noWeightLow = noWeightLowBid > 0 ? noWeightLowBid : theoPrice * (1 + noWeightLowPremium / 100);
        noWeightHigh = noWeightAvgBid > 0 ? noWeightAvgBid : theoPrice * (1 + noWeightAvgPremium / 100);
        weightLow = weightedLowBid > 0 ? weightedLowBid : theoPrice * (1 + lowPremium / 100);
        weightHigh = weightedAvgBid > 0 ? weightedAvgBid : theoPrice * (1 + avgPremium / 100);
        
        document.getElementById('step1NoWeightPremium').textContent = 
            noWeightLowBid > 0 ? `${noWeightLowBid.toFixed(2)} ~ ${noWeightAvgBid.toFixed(2)}` : '--';
        document.getElementById('step1WeightPremium').textContent = 
            weightedLowBid > 0 ? `${weightedLowBid.toFixed(2)} ~ ${weightedAvgBid.toFixed(2)}` : '--';
    }
    
    document.getElementById('step1NoWeightRange').textContent = 
        (noWeightLow > 0 && noWeightHigh > 0) ? `${noWeightLow.toFixed(2)}~${noWeightHigh.toFixed(2)}å…ƒ` : '--';
    document.getElementById('step1WeightRange').textContent = 
        (weightLow > 0 && weightHigh > 0) ? `${weightLow.toFixed(2)}~${weightHigh.toFixed(2)}å…ƒ` : '--';
    
    // Step 1 è©³ç´°åˆ†æå…§å®¹ï¼ˆå„ç¶­åº¦åŠ æ¬Šæ˜ç´°ï¼‰
    const marketSentiment = document.getElementById('marketSentiment');
    if (marketSentiment) {
        document.getElementById('step1DetailContent').innerHTML = marketSentiment.innerHTML;
    }
    
    // ========== Step 2: å¸‚å ´æ°›åœèª¿æ•´ï¼ˆè¿‘æœŸç†±åº¦æ³•ï¼‰ ==========
    const momentum = document.getElementById('marketMomentumResult');
    if (momentum) {
        document.getElementById('step2Momentum').innerHTML = momentum.innerHTML;
    }
    
    // å¾å¸‚å ´å‹•èƒ½ä¸­æå–ç†±åº¦æ•¸æ“š
    const momentumText = momentum ? momentum.innerText : '';
    let heatLevel = 'ğŸ˜ æ™®é€š';
    
    if (momentumText.includes('ç†±çµ¡') || momentumText.includes('ç«ç†±') || momentumText.includes('ç©æ¥µ')) {
        heatLevel = 'ğŸ”¥ ç†±çµ¡';
    } else if (momentumText.includes('å†·æ¸…') || momentumText.includes('ä½è¿·') || momentumText.includes('ä¿å®ˆ')) {
        heatLevel = 'â„ï¸ å†·æ¸…';
    }
    
    document.getElementById('step2HeatLevel').textContent = heatLevel;
    
    // å¾è¿‘10æª”æ•¸æ“šè¨ˆç®—
    const recentPremium = parseFloat(r.recentAvgPremium) || avgPremium;
    const recentMultiple = parseFloat(r.recentAvgMultiple) || 0;
    
    document.getElementById('step2HeatPremium').textContent = recentPremium > 0 ? recentPremium.toFixed(2) + '%' : '--';
    document.getElementById('step2HeatMultiple').textContent = recentMultiple > 0 ? recentMultiple.toFixed(2) + 'x' : '--';
    
    // ç†±åº¦æ³•å»ºè­°å€é–“
    const heatLow = theoPrice * (1 + (recentPremium - 2) / 100);
    const heatHigh = theoPrice * (1 + recentPremium / 100);
    document.getElementById('step2HeatRange').textContent = 
        (heatLow > 0 && heatHigh > 0) ? `${heatLow.toFixed(2)}~${heatHigh.toFixed(2)}å…ƒ` : '--';
    
    // ========== Step 3: AIæ™ºèƒ½ç«¶æ‹é æ¸¬ï¼ˆå®Œæ•´v3.73å€å¡Šï¼‰ ==========
    // v3.97o ä¿®æ­£ï¼šä¸»å‹•èª¿ç”¨ updateLiveAIPrediction ç¢ºä¿ Step 3 æœ‰å®Œæ•´å…§å®¹
    // å¾ r.inputData ä¸­å–å¾—æ‰€éœ€åƒæ•¸
    const inputData = r.inputData || {};
    const aiTheoPrice = theoPrice > 0 ? theoPrice : 0;
    const aiIssueSize = parseFloat(inputData.issueSize) || 0;
    const aiGuarantee = inputData.guarantee || 'ç„¡æ“”ä¿';
    const aiBroker = inputData.broker || '';
    const aiIndustry = inputData.industry || '';
    const aiRating = inputData.rating || '';
    
    // å…ˆèª¿ç”¨ updateLiveAIPrediction ç¢ºä¿ liveAIPrediction æœ‰å…§å®¹
    if (typeof updateLiveAIPrediction === 'function' && aiTheoPrice > 0) {
        updateLiveAIPrediction(aiTheoPrice, aiIssueSize, aiGuarantee, aiBroker, aiIndustry, aiRating);
    }
    
    // ç„¶å¾Œå¾ liveAIPrediction è¤‡è£½å®Œæ•´å…§å®¹åˆ° Step 3
    const liveAIPredictionEl = document.getElementById('liveAIPrediction');
    const step3AIBlock = document.getElementById('step3AIBlock');
    if (liveAIPredictionEl && step3AIBlock && liveAIPredictionEl.innerHTML.trim()) {
        step3AIBlock.innerHTML = liveAIPredictionEl.innerHTML;
    } else if (step3AIBlock) {
        step3AIBlock.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">AIæ™ºèƒ½ç«¶æ‹é æ¸¬è¼‰å…¥ä¸­...</div>';
    }
    
    // ========== Step 4: æœ€å¼·å¤§è…¦åˆ†ææ³•ï¼ˆå››ç¶­åº¦æ»¾å‹•åŠ æ¬Šï¼‰ ==========
    // v3.97q å…¨æ–°è¨­è¨ˆï¼šç”¢æ¥­30% + å¸‚å ´æ°›åœ25% + ç†è«–åƒ¹20% + ä¿¡è©•25%
    
    // å–å¾—ç•¶å‰æ¨™çš„æ¢ä»¶
    const step4Guarantee = inputData.guarantee || 'ç„¡æ“”ä¿';
    
    // v3.97w: å„ªå…ˆä½¿ç”¨é–ƒé›»å¸¶å…¥çš„å¯¦éš›è¦æ¨¡æ•¸å­—
    let step4Size = window.currentActualIssueSize || 0;
    if (step4Size <= 0) {
        // å¾ä¸‹æ‹‰é¸å–®å€é–“æ¨ç®—ä¸­é–“å€¼
        const sizeRange = inputData.issueSize || '';
        if (sizeRange === 'å°æ–¼2å„„') step4Size = 1;
        else if (sizeRange === '2~5å„„') step4Size = 3.5;
        else if (sizeRange === '5~10å„„') step4Size = 7.5;
        else if (sizeRange === '10~15å„„') step4Size = 12.5;
        else if (sizeRange === '15~20å„„') step4Size = 17.5;
        else if (sizeRange === 'å¤§æ–¼20å„„') step4Size = 25;
        else step4Size = 5; // é è¨­
    }
    
    const step4Industry = (inputData.industry || '').split(' ')[0];  // å–ä¸»åˆ†é¡
    const step4Rating = String(inputData.rating || '').replace(/[^0-9]/g, '');  // åªå–æ•¸å­—
    
    // v3.97w: Debug è¼¸å‡º
    console.log('ğŸ§  Step4 ç¯©é¸æ¢ä»¶:', { step4Guarantee, step4Size, step4Industry, step4Rating });
    
    // è¦æ¨¡ç¯„åœ 50%-150% (v3.97s æ”¾å¯¬æ¢ä»¶å¢åŠ æ¨£æœ¬æ•¸)
    const sizeMin = step4Size * 0.5;
    const sizeMax = step4Size * 1.5;
    
    // ç†è«–åƒ¹å€é–“å®šç¾©
    const priceZones = [
        { min: 0, max: 90, label: '<90' },
        { min: 90, max: 95, label: '90~95' },
        { min: 95, max: 100, label: '95~100' },
        { min: 100, max: 105, label: '100~105' },
        { min: 105, max: 110, label: '105~110' },
        { min: 110, max: 120, label: '110~120' },
        { min: 120, max: 140, label: '120~140' },
        { min: 140, max: 9999, label: '>140' }
    ];
    const currentZone = priceZones.find(z => theoPrice >= z.min && theoPrice < z.max) || priceZones[priceZones.length - 1];
    
    // é¡¯ç¤ºç¯©é¸æ¢ä»¶
    document.getElementById('step4Guarantee').textContent = step4Guarantee;
    document.getElementById('step4SizeRange').textContent = `${sizeMin.toFixed(1)}~${sizeMax.toFixed(1)}å„„`;
    document.getElementById('step4TheoPrice').textContent = theoPrice > 0 ? theoPrice.toFixed(2) + 'å…ƒ' : '--';
    
    // æ»¾å‹•è¨ˆç®—å‡½æ•¸
    const calcRolling = (data) => {
        if (!data || data.length < 3) return null;
        
        // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€è¿‘åœ¨å‰ï¼‰
        const sorted = [...data].sort((a, b) => new Date(b['æˆªæ¨™æ—¥']) - new Date(a['æˆªæ¨™æ—¥']));
        const n = sorted.length;
        
        const recent3 = sorted.slice(0, Math.min(3, n));
        const recent6 = sorted.slice(0, Math.min(6, n));
        const recent9 = sorted.slice(0, Math.min(9, n));
        
        // è¨ˆç®—æº¢åƒ¹ç‡ï¼ˆå¾åƒ¹æ ¼å’Œç†è«–åƒ¹è¨ˆç®—ï¼‰
        const getPremium = (item, priceFields) => {
            const theo = parseFloat(item['ç†è«–åƒ¹']) || 0;
            if (theo <= 0) return NaN;
            for (const f of priceFields) {
                const price = parseFloat(item[f]);
                if (!isNaN(price) && price > 0) {
                    return ((price / theo) - 1) * 100;
                }
            }
            return NaN;
        };
        
        const calcGroupAvg = (arr, priceFields) => {
            const valid = arr.map(x => getPremium(x, priceFields)).filter(x => !isNaN(x));
            return valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : NaN;
        };
        
        const lowFields = ['æœ€ä½å¾—æ¨™', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼'];
        const avgFields = ['åŠ æ¬Šå‡åƒ¹', 'å¹³å‡å¾—æ¨™', 'å¹³å‡å¾—æ¨™åƒ¹æ ¼', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼'];
        
        const w3 = 0.5, w6 = 0.3, w9 = 0.2;
        
        const low3 = calcGroupAvg(recent3, lowFields);
        const low6 = calcGroupAvg(recent6, lowFields);
        const low9 = calcGroupAvg(recent9, lowFields);
        
        const avg3 = calcGroupAvg(recent3, avgFields);
        const avg6 = calcGroupAvg(recent6, avgFields);
        const avg9 = calcGroupAvg(recent9, avgFields);
        
        const rollingLow = (!isNaN(low3) ? low3 * w3 : 0) + (!isNaN(low6) ? low6 * w6 : 0) + (!isNaN(low9) ? low9 * w9 : 0);
        const rollingAvg = (!isNaN(avg3) ? avg3 * w3 : 0) + (!isNaN(avg6) ? avg6 * w6 : 0) + (!isNaN(avg9) ? avg9 * w9 : 0);
        
        // v3.97t: è¨ˆç®—Top3ï¼ˆæŒ‰æº¢åƒ¹ç‡æ’åºå–æœ€é«˜çš„3æª”ï¼‰
        const withPremium = data.map(item => {
            const prem = getPremium(item, avgFields);
            return { item, prem };
        }).filter(x => !isNaN(x.prem));
        
        const top3 = withPremium
            .sort((a, b) => b.prem - a.prem)
            .slice(0, 3)
            .map(x => ({
                name: x.item['åç¨±'] || x.item['å¯è½‰å‚µåç¨±'] || x.item['CBåç¨±'] || '-',
                prem: x.prem
            }));
        
        return {
            lowPrem: rollingLow,
            avgPrem: rollingAvg,
            count: n,
            samples: sorted.slice(0, 9),
            top3: top3
        };
    };
    
    // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²æ•¸æ“š
    if (typeof window.auctionDataCache !== 'undefined' && window.auctionDataCache.length > 0) {
        const allData = window.auctionDataCache;
        
        // v3.97v: æ“”ä¿æ¯”å°å‡½æ•¸ï¼ˆæ”¯æ´å¤šç¨®æ ¼å¼ï¼‰
        const matchGuarantee = (itemGuar, targetGuar) => {
            const item = String(itemGuar || '').trim();
            const target = String(targetGuar || '').trim();
            if (target === 'ç„¡æ“”ä¿' || target === 'ç„¡') {
                return item === 'ç„¡' || item === 'ç„¡æ“”ä¿' || item === '';
            }
            if (target === 'æœ‰æ“”ä¿' || target === 'æœ‰') {
                return item === 'æœ‰' || item === 'æœ‰æ“”ä¿';
            }
            return item === target;
        };
        
        // å…±åŒç¯©é¸æ¢ä»¶ï¼šåŒæ“”ä¿ + è¦æ¨¡50-150%ï¼ˆç”¨æ–¼å¸‚å ´æ°›åœå’Œç†è«–åƒ¹ï¼‰
        const baseFilterWithSize = (item) => {
            const itemGuar = item['æ“”ä¿'] || '';
            const itemSize = parseFloat(item['ç™¼è¡Œè¦æ¨¡']) || 0;
            const guarMatch = matchGuarantee(itemGuar, step4Guarantee);
            const sizeMatch = itemSize >= sizeMin && itemSize <= sizeMax;
            return guarMatch && sizeMatch;
        };
        
        // åƒ…æ“”ä¿ç¯©é¸ï¼ˆç”¨æ–¼ç”¢æ¥­å’Œä¿¡è©•ï¼Œä¸é™è¦æ¨¡ï¼‰
        const baseFilterNoSize = (item) => {
            const itemGuar = item['æ“”ä¿'] || '';
            return matchGuarantee(itemGuar, step4Guarantee);
        };
        
        // å››ç¶­åº¦ç¯©é¸
        // 1. ç”¢æ¥­ç¶­åº¦ï¼ˆ30%ï¼‰- v3.97v: ä¸é™è¦æ¨¡ï¼Œç”¨åŒ…å«æ¯”å°
        const industryData = allData.filter(item => {
            if (!baseFilterNoSize(item)) return false;
            const itemInd = (item['ç”¢æ¥­åˆ†é¡'] || item['ç”¢æ¥­'] || '');
            // åŒ…å«æ¯”å°ï¼šè¼¸å…¥ã€ŒåŠå°é«”ã€å¯åŒ¹é…ã€ŒåŠå°é«”æ¥­ã€
            return step4Industry !== '' && itemInd.includes(step4Industry);
        });
        
        // 2. å¸‚å ´æ°›åœç¶­åº¦ï¼ˆ25%ï¼‰- åŒæ“”ä¿+åŒè¦æ¨¡ç¯„åœ
        const marketData = allData.filter(baseFilterWithSize);
        
        // 3. ç†è«–åƒ¹å€é–“ç¶­åº¦ï¼ˆ20%ï¼‰- åŒæ“”ä¿+åŒè¦æ¨¡+åŒç†è«–åƒ¹å€é–“
        const theoData = allData.filter(item => {
            if (!baseFilterWithSize(item)) return false;
            const itemTheo = parseFloat(item['ç†è«–åƒ¹']) || 0;
            return itemTheo >= currentZone.min && itemTheo < currentZone.max;
        });
        
        // 4. ä¿¡è©•ç¶­åº¦ï¼ˆ25%ï¼‰- v3.97v: ä¸é™è¦æ¨¡ï¼Œåªçœ‹åŒæ“”ä¿+åŒä¿¡è©•
        const ratingData = allData.filter(item => {
            if (!baseFilterNoSize(item)) return false;
            const itemRating = String(item['ä¿¡ç”¨è©•ç­‰'] || item['TCRI'] || item['ä¿¡è©•'] || '').replace(/[^0-9]/g, '');
            return itemRating === step4Rating && step4Rating !== '';
        });
        
        // v3.97u: Debug è¼¸å‡ºç¯©é¸çµæœ
        console.log('ğŸ§  Step4 ç¯©é¸çµæœ:', {
            ç¸½æ•¸æ“š: allData.length,
            ç”¢æ¥­: industryData.length,
            å¸‚å ´æ°›åœ: marketData.length,
            ç†è«–åƒ¹: theoData.length,
            ä¿¡è©•: ratingData.length
        });
        
        // è¨ˆç®—å„ç¶­åº¦æ»¾å‹•çµæœ
        const industryResult = calcRolling(industryData);
        const marketResult = calcRolling(marketData);
        const theoResult = calcRolling(theoData);
        const ratingResult = calcRolling(ratingData);
        
        // å‹•æ…‹æ¬Šé‡åˆ†é…
        let weights = { industry: 0.30, market: 0.25, theo: 0.20, rating: 0.25 };
        let validDims = [];
        
        if (industryResult) validDims.push({ key: 'industry', result: industryResult, baseWeight: 0.30 });
        if (marketResult) validDims.push({ key: 'market', result: marketResult, baseWeight: 0.25 });
        if (theoResult) validDims.push({ key: 'theo', result: theoResult, baseWeight: 0.20 });
        if (ratingResult) validDims.push({ key: 'rating', result: ratingResult, baseWeight: 0.25 });
        
        // é‡æ–°åˆ†é…æ¬Šé‡
        const totalValidWeight = validDims.reduce((sum, d) => sum + d.baseWeight, 0);
        validDims.forEach(d => {
            d.weight = totalValidWeight > 0 ? d.baseWeight / totalValidWeight : 0;
        });
        
        // v3.97t: Top3æ ¼å¼åŒ–å‡½æ•¸
        const formatTop3 = (top3) => {
            if (!top3 || top3.length === 0) return '--';
            return top3.map((t, i) => `${i+1}.${t.name.replace(/ä¸€|äºŒ|ä¸‰|å››|äº”/, '')} ${t.prem.toFixed(1)}%`).join('<br>');
        };
        
        // é¡¯ç¤ºå„ç¶­åº¦çµæœ
        // ç”¢æ¥­
        if (industryResult) {
            document.getElementById('step4IndustryLabel').textContent = step4Industry || 'æœªæŒ‡å®š';
            document.getElementById('step4IndustryPrem').textContent = industryResult.avgPrem.toFixed(2) + '%';
            document.getElementById('step4IndustryCount').textContent = industryResult.count;
            const indWeight = validDims.find(d => d.key === 'industry')?.weight || 0;
            document.getElementById('step4IndustryWeight').textContent = (indWeight * 100).toFixed(0) + '%';
            document.getElementById('step4IndustryTop3').innerHTML = formatTop3(industryResult.top3);
        } else {
            document.getElementById('step4IndustryLabel').textContent = step4Industry || 'æœªæŒ‡å®š';
            document.getElementById('step4IndustryPrem').textContent = 'æ¨£æœ¬ä¸è¶³';
            document.getElementById('step4IndustryCount').textContent = industryData.length;
            document.getElementById('step4IndustryWeight').textContent = '0%';
            document.getElementById('step4IndustryTop3').innerHTML = '--';
        }
        
        // å¸‚å ´æ°›åœ
        if (marketResult) {
            document.getElementById('step4MarketPrem').textContent = marketResult.avgPrem.toFixed(2) + '%';
            document.getElementById('step4MarketCount').textContent = marketResult.count;
            const mktWeight = validDims.find(d => d.key === 'market')?.weight || 0;
            document.getElementById('step4MarketWeight').textContent = (mktWeight * 100).toFixed(0) + '%';
            document.getElementById('step4MarketTop3').innerHTML = formatTop3(marketResult.top3);
        } else {
            document.getElementById('step4MarketPrem').textContent = 'æ¨£æœ¬ä¸è¶³';
            document.getElementById('step4MarketCount').textContent = marketData.length;
            document.getElementById('step4MarketWeight').textContent = '0%';
            document.getElementById('step4MarketTop3').innerHTML = '--';
        }
        
        // ç†è«–åƒ¹
        document.getElementById('step4TheoZone').textContent = currentZone.label;
        if (theoResult) {
            document.getElementById('step4TheoPrem').textContent = theoResult.avgPrem.toFixed(2) + '%';
            document.getElementById('step4TheoCount').textContent = theoResult.count;
            const theoWeight = validDims.find(d => d.key === 'theo')?.weight || 0;
            document.getElementById('step4TheoWeight').textContent = (theoWeight * 100).toFixed(0) + '%';
            document.getElementById('step4TheoTop3').innerHTML = formatTop3(theoResult.top3);
        } else {
            document.getElementById('step4TheoPrem').textContent = 'æ¨£æœ¬ä¸è¶³';
            document.getElementById('step4TheoCount').textContent = theoData.length;
            document.getElementById('step4TheoWeight').textContent = '0%';
            document.getElementById('step4TheoTop3').innerHTML = '--';
        }
        
        // ä¿¡è©•
        if (ratingResult) {
            document.getElementById('step4RatingLabel').textContent = step4Rating || 'æœªæŒ‡å®š';
            document.getElementById('step4RatingPrem').textContent = ratingResult.avgPrem.toFixed(2) + '%';
            document.getElementById('step4RatingCount').textContent = ratingResult.count;
            const ratWeight = validDims.find(d => d.key === 'rating')?.weight || 0;
            document.getElementById('step4RatingWeight').textContent = (ratWeight * 100).toFixed(0) + '%';
            document.getElementById('step4RatingTop3').innerHTML = formatTop3(ratingResult.top3);
        } else {
            document.getElementById('step4RatingLabel').textContent = step4Rating || 'æœªæŒ‡å®š';
            document.getElementById('step4RatingPrem').textContent = 'æ¨£æœ¬ä¸è¶³';
            document.getElementById('step4RatingCount').textContent = ratingData.length;
            document.getElementById('step4RatingWeight').textContent = '0%';
            document.getElementById('step4RatingTop3').innerHTML = '--';
        }
        
        // åˆæˆæœ€çµ‚çµæœ
        if (validDims.length > 0) {
            let finalLowPrem = 0, finalAvgPrem = 0;
            validDims.forEach(d => {
                finalLowPrem += d.result.lowPrem * d.weight;
                finalAvgPrem += d.result.avgPrem * d.weight;
            });
            
            const finalLowPrice = theoPrice * (1 + finalLowPrem / 100);
            const finalAvgPrice = theoPrice * (1 + finalAvgPrem / 100);
            
            document.getElementById('step4FinalLowPrem').textContent = finalLowPrem.toFixed(2) + '%';
            document.getElementById('step4FinalAvgPrem').textContent = finalAvgPrem.toFixed(2) + '%';
            document.getElementById('step4FinalLowPrice').textContent = finalLowPrice.toFixed(2);
            document.getElementById('step4FinalAvgPrice').textContent = finalAvgPrice.toFixed(2);
            document.getElementById('step4PriceRange').textContent = `${finalLowPrice.toFixed(2)} ~ ${finalAvgPrice.toFixed(2)}å…ƒ`;
            
            // è©³ç´°å…§å®¹
            let detailHTML = `<div style="margin-bottom:15px;">
                <b>å››ç¶­åº¦æ»¾å‹•åˆ†ææ˜ç´°</b>
                <div style="font-size:11px; color:#666; margin-top:5px;">
                    å…±åŒç¯©é¸ï¼š${step4Guarantee} + è¦æ¨¡${sizeMin.toFixed(1)}~${sizeMax.toFixed(1)}å„„
                </div>
            </div>`;
            
            // å„ç¶­åº¦è¡¨æ ¼
            validDims.forEach(d => {
                const dimName = { industry: 'ğŸ­ ç”¢æ¥­', market: 'ğŸ“ˆ å¸‚å ´æ°›åœ', theo: 'ğŸ’° ç†è«–åƒ¹å€é–“', rating: 'â­ ä¿¡è©•' }[d.key];
                const dimLabel = { 
                    industry: step4Industry, 
                    market: 'æœ€è¿‘Næª”', 
                    theo: currentZone.label, 
                    rating: step4Rating 
                }[d.key];
                
                detailHTML += `<div style="margin-bottom:12px;">
                    <div style="font-weight:bold; margin-bottom:5px;">${dimName}ï¼ˆ${dimLabel}ï¼‰- æ¬Šé‡${(d.weight*100).toFixed(0)}%</div>
                    <table style="width:100%; border-collapse:collapse; font-size:10px;">
                        <tr style="background:#f5f5f5;">
                            <th style="padding:3px; border:1px solid #ddd;">æ¨™çš„</th>
                            <th style="padding:3px; border:1px solid #ddd;">æˆªæ¨™æ—¥</th>
                            <th style="padding:3px; border:1px solid #ddd;">ç†è«–åƒ¹</th>
                            <th style="padding:3px; border:1px solid #ddd;">æœ€ä½å¾—æ¨™</th>
                            <th style="padding:3px; border:1px solid #ddd;">æ¬Šé‡</th>
                        </tr>`;
                
                d.result.samples.slice(0, 9).forEach((item, idx) => {
                    const bgColor = idx < 3 ? '#fff3e0' : (idx < 6 ? '#fff8e1' : '#ffffff');
                    const weight = idx < 3 ? '50%' : (idx < 6 ? '30%' : '20%');
                    const minBid = parseFloat(item['æœ€ä½å¾—æ¨™'] || item['æœ€ä½å¾—æ¨™åƒ¹æ ¼']) || 0;
                    const itemTheo = parseFloat(item['ç†è«–åƒ¹']) || 0;
                    
                    // v3.97x: ä¿®æ­£æ¨™çš„åç¨±æ¬„ä½
                    const cbName = item['åç¨±'] || item['å¯è½‰å‚µåç¨±'] || item['CBåç¨±'] || '-';
                    
                    // v3.97x: ä¿®æ­£æ—¥æœŸæ ¼å¼ï¼ˆExcelåºè™Ÿè½‰æ—¥æœŸï¼‰
                    let dateStr = '-';
                    const rawDate = item['æˆªæ¨™æ—¥'];
                    if (rawDate) {
                        if (typeof rawDate === 'number') {
                            // Excelåºè™Ÿè½‰æ—¥æœŸ
                            const excelEpoch = new Date(1899, 11, 30);
                            const jsDate = new Date(excelEpoch.getTime() + rawDate * 86400000);
                            dateStr = jsDate.toISOString().split('T')[0];
                        } else if (rawDate instanceof Date) {
                            dateStr = rawDate.toISOString().split('T')[0];
                        } else {
                            dateStr = String(rawDate).split('T')[0];
                        }
                    }
                    
                    detailHTML += `<tr style="background:${bgColor};">
                        <td style="padding:3px; border:1px solid #ddd;">${cbName}</td>
                        <td style="padding:3px; border:1px solid #ddd;">${dateStr}</td>
                        <td style="padding:3px; border:1px solid #ddd;">${itemTheo > 0 ? itemTheo.toFixed(1) : '-'}</td>
                        <td style="padding:3px; border:1px solid #ddd;">${minBid > 0 ? minBid.toFixed(2) : '-'}</td>
                        <td style="padding:3px; border:1px solid #ddd;">${weight}</td>
                    </tr>`;
                });
                detailHTML += `</table>
                    <div style="font-size:10px; color:#666; margin-top:3px;">
                        æ»¾å‹•æº¢åƒ¹ç‡ï¼šæœ€ä½ ${d.result.lowPrem.toFixed(2)}% / å¹³å‡ ${d.result.avgPrem.toFixed(2)}%
                    </div>
                </div>`;
            });
            
            document.getElementById('step4DetailContent').innerHTML = detailHTML;
        } else {
            // æ‰€æœ‰ç¶­åº¦éƒ½æ¨£æœ¬ä¸è¶³
            document.getElementById('step4FinalLowPrem').textContent = '--%';
            document.getElementById('step4FinalAvgPrem').textContent = '--%';
            document.getElementById('step4FinalLowPrice').textContent = '--';
            document.getElementById('step4FinalAvgPrice').textContent = '--';
            document.getElementById('step4PriceRange').textContent = 'æ¨£æœ¬ä¸è¶³';
            document.getElementById('step4DetailContent').innerHTML = '<div style="color:#999;">æ‰€æœ‰ç¶­åº¦æ¨£æœ¬æ•¸å‡ä¸è¶³3æª”ï¼Œç„¡æ³•é€²è¡Œæ»¾å‹•åˆ†æ</div>';
        }
    } else {
        // ç„¡æ­·å²æ•¸æ“š
        document.getElementById('step4IndustryPrem').textContent = '--';
        document.getElementById('step4MarketPrem').textContent = '--';
        document.getElementById('step4TheoPrem').textContent = '--';
        document.getElementById('step4RatingPrem').textContent = '--';
        document.getElementById('step4FinalLowPrem').textContent = '--%';
        document.getElementById('step4FinalAvgPrem').textContent = '--%';
        document.getElementById('step4FinalLowPrice').textContent = '--';
        document.getElementById('step4FinalAvgPrice').textContent = '--';
        document.getElementById('step4PriceRange').textContent = 'ç„¡æ­·å²æ•¸æ“š';
        document.getElementById('step4DetailContent').innerHTML = '<div style="color:#999;">ç„¡æ³•å–å¾—æ­·å²ç«¶æ‹æ•¸æ“š</div>';
    }
    
    // ========== Step 5: åŒæ¥­ç±Œç¢¼ç¨€ç¼ºåº¦åˆ†ææ³• ==========
    // v3.97z æ–°å¢ï¼šé›™æ–¹æ³•äº¤å‰é©—è­‰é æ¸¬
    
    // å–å¾—ç•¶å‰æ¨™çš„æ¢ä»¶
    const step5ConvPrice = parseFloat(inputData.conversionPrice) || 0;
    const step5Capital = parseFloat(inputData.capital) || 0;
    const step5PricingPremium = parseFloat(inputData.pricingPremium) || 1.0;
    const step5Industry = (inputData.industry || '').split(' ')[0];
    const step5Rating = String(inputData.rating || '').replace(/[^0-9]/g, '');
    const step5IssueSize = window.currentActualIssueSize || parseFloat(inputData.issueSize) || 0;
    
    // è¨ˆç®—ç±Œç¢¼ç¨€ç¼ºåº¦
    const step5Scarcity = step5Capital > 0 ? step5ConvPrice / step5Capital : 0;
    
    // è¨ˆç®—è¨‚åƒ¹åŸºæº–è‚¡åƒ¹
    const step5BasePrice = step5PricingPremium > 0 ? step5ConvPrice / step5PricingPremium : 0;
    
    console.log('ğŸ”¬ Step5 æ¢ä»¶:', { step5ConvPrice, step5Capital, step5Scarcity, step5BasePrice, theoPrice });
    
    if (typeof window.auctionDataCache !== 'undefined' && window.auctionDataCache.length > 0 && step5ConvPrice > 0 && step5Capital > 0) {
        const allData = window.auctionDataCache;
        
        // è¨ˆç®—æ¯å€‹æ¡ˆä¾‹çš„ç±Œç¢¼ç¨€ç¼ºåº¦å’Œç›¸é—œæŒ‡æ¨™
        const dataWithMetrics = allData.map(item => {
            const convPrice = parseFloat(item['è½‰æ›åƒ¹']) || 0;
            const capital = parseFloat(item['è‚¡æœ¬']) || 0;
            const pricingPrem = parseFloat(item['è¨‚åƒ¹æº¢åƒ¹ç‡']) || 1.0;
            const minBid = parseFloat(item['æœ€ä½å¾—æ¨™'] || item['æœ€ä½å¾—æ¨™åƒ¹æ ¼']) || 0;
            const itemTheo = parseFloat(item['ç†è«–åƒ¹']) || 0;
            
            const scarcity = capital > 0 ? convPrice / capital : 0;
            const basePrice = pricingPrem > 0 ? convPrice / pricingPrem : 0;
            const convRatio = convPrice > 0 ? 100000 / convPrice : 0;
            const swapCost = convRatio > 0 ? (minBid * 1000) / convRatio : 0;
            const totalPremium = basePrice > 0 ? swapCost / basePrice : 0;
            const cvPremium = itemTheo > 0 ? minBid / itemTheo : 0;
            
            return {
                ...item,
                scarcity,
                basePrice,
                swapCost,
                totalPremium,
                cvPremium,
                convPrice,
                capital,
                minBid,
                itemTheo
            };
        }).filter(d => d.scarcity > 0 && d.totalPremium > 0 && d.cvPremium > 0);
        
        // æŒ‰ç±Œç¢¼ç¨€ç¼ºåº¦æ’åº
        const sortedByScarcity = [...dataWithMetrics].sort((a, b) => b.scarcity - a.scarcity);
        
        // è¨ˆç®—ç•¶å‰æ¨™çš„çš„æ’å
        const scarcityRank = sortedByScarcity.filter(d => d.scarcity > step5Scarcity).length + 1;
        const totalCount = sortedByScarcity.length;
        
        // é¡¯ç¤ºç±Œç¢¼ç¨€ç¼ºåº¦
        document.getElementById('step5ScarcityIndex').textContent = step5Scarcity.toFixed(1);
        document.getElementById('step5ScarcityRank').textContent = `ç¬¬${scarcityRank}/${totalCount}`;
        
        // æ‰¾ç±Œç¢¼ç¨€ç¼ºåƒç…§æ¡ˆä¾‹ï¼ˆè‚¡æœ¬<5å„„ + è½‰æ›åƒ¹>500ï¼‰
        const rareRefs = dataWithMetrics.filter(d => d.capital < 5 && d.convPrice > 500);
        document.getElementById('step5RefCount').textContent = rareRefs.length + 'æª”';
        
        // é¡¯ç¤ºåƒç…§æ¡ˆä¾‹
        if (rareRefs.length > 0) {
            const refHTML = rareRefs
                .sort((a, b) => b.scarcity - a.scarcity)
                .slice(0, 5)
                .map(d => {
                    const name = d['åç¨±'] || d['å¯è½‰å‚µåç¨±'] || '-';
                    return `<div style="display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px solid #eee;">
                        <span>${name}</span>
                        <span>ç¨€ç¼ºåº¦${d.scarcity.toFixed(1)} | å…¨ç¨‹æº¢åƒ¹${((d.totalPremium-1)*100).toFixed(1)}% | å°CVæº¢åƒ¹${((d.cvPremium-1)*100).toFixed(1)}%</span>
                    </div>`;
                }).join('');
            document.getElementById('step5RefCases').innerHTML = refHTML || 'ç„¡åƒç…§æ¡ˆä¾‹';
        } else {
            document.getElementById('step5RefCases').innerHTML = 'ç„¡ç±Œç¢¼ç¨€ç¼ºåƒç…§æ¡ˆä¾‹ï¼ˆè‚¡æœ¬<5å„„+è½‰æ›åƒ¹>500ï¼‰';
        }
        
        // ===== æ–¹æ³•ä¸€ï¼šæ›è‚¡æˆæœ¬æº¢åƒ¹æ³• =====
        // ç”¨ç±Œç¢¼ç¨€ç¼ºæ¡ˆä¾‹çš„å¹³å‡å…¨ç¨‹æº¢åƒ¹ç‡
        let method1Premium = 0;
        let method1Price = 0;
        let method1Cost = 0;
        
        if (rareRefs.length > 0) {
            method1Premium = rareRefs.reduce((sum, d) => sum + d.totalPremium, 0) / rareRefs.length;
            method1Cost = step5BasePrice * method1Premium;
            method1Price = method1Cost / step5ConvPrice * 100;
        } else {
            // ç„¡ç±Œç¢¼ç¨€ç¼ºæ¡ˆä¾‹ï¼Œç”¨æ•´é«”å¹³å‡
            method1Premium = dataWithMetrics.reduce((sum, d) => sum + d.totalPremium, 0) / dataWithMetrics.length;
            method1Cost = step5BasePrice * method1Premium;
            method1Price = method1Cost / step5ConvPrice * 100;
        }
        
        document.getElementById('step5Method1Premium').textContent = ((method1Premium - 1) * 100).toFixed(2) + '%';
        document.getElementById('step5Method1Cost').textContent = method1Cost.toFixed(2) + 'å…ƒ';
        document.getElementById('step5Method1Price').textContent = method1Price.toFixed(2) + 'å…ƒ';
        
        // ===== æ–¹æ³•äºŒï¼šå››ç¶­åº¦åŠ æ¬Šæ³• =====
        // ç¶­åº¦1ï¼šç±Œç¢¼ç¨€ç¼º 30%
        const dim1Data = rareRefs.length > 0 ? rareRefs : dataWithMetrics.filter(d => d.scarcity > 100);
        const dim1Premium = dim1Data.length > 0 ? dim1Data.reduce((sum, d) => sum + d.cvPremium, 0) / dim1Data.length : 1;
        
        // ç¶­åº¦2ï¼šå¤§å‹æ¡ˆä»¶ 25%ï¼ˆç«¶æ‹å¼µæ•¸>=15000ï¼‰
        const dim2Data = dataWithMetrics.filter(d => {
            const bidQty = parseFloat(d['ç«¶æ‹å¼µæ•¸']) || 0;
            return bidQty >= 15000;
        });
        const dim2Premium = dim2Data.length > 0 ? dim2Data.reduce((sum, d) => sum + d.cvPremium, 0) / dim2Data.length : 1;
        
        // ç¶­åº¦3ï¼šä¿¡è©• 25%
        const dim3Data = dataWithMetrics.filter(d => {
            const rating = String(d['ä¿¡ç”¨è©•ç­‰'] || d['TCRI'] || '').replace(/[^0-9]/g, '');
            return rating === step5Rating;
        });
        const dim3Premium = dim3Data.length > 0 ? dim3Data.reduce((sum, d) => sum + d.cvPremium, 0) / dim3Data.length : 1;
        
        // ç¶­åº¦4ï¼šç”¢æ¥­ 20%
        const dim4Data = dataWithMetrics.filter(d => {
            const ind = d['ç”¢æ¥­åˆ†é¡'] || d['ç”¢æ¥­'] || '';
            return step5Industry && ind.includes(step5Industry);
        });
        const dim4Premium = dim4Data.length > 0 ? dim4Data.reduce((sum, d) => sum + d.cvPremium, 0) / dim4Data.length : 1;
        
        // åŠ æ¬Šè¨ˆç®—
        const w1 = 0.30, w2 = 0.25, w3 = 0.25, w4 = 0.20;
        const method2PremiumRate = (dim1Premium - 1) * w1 + (dim2Premium - 1) * w2 + (dim3Premium - 1) * w3 + (dim4Premium - 1) * w4;
        const method2Price = theoPrice * (1 + method2PremiumRate);
        
        document.getElementById('step5Method2Premium').textContent = (method2PremiumRate * 100).toFixed(2) + '%';
        document.getElementById('step5Method2CV').textContent = theoPrice.toFixed(2);
        document.getElementById('step5Method2Price').textContent = method2Price.toFixed(2) + 'å…ƒ';
        
        // ç¶œåˆçµæœ
        document.getElementById('step5Pred1').textContent = method1Price.toFixed(2) + 'å…ƒ';
        document.getElementById('step5Pred2').textContent = method2Price.toFixed(2) + 'å…ƒ';
        document.getElementById('step5Diff').textContent = Math.abs(method1Price - method2Price).toFixed(2) + 'å…ƒ';
        
        // å»ºè­°å€é–“ï¼ˆæ ¹æ“šå›æ¸¬ï¼Œç±Œç¢¼ç¨€ç¼ºé¡å‹æ–¹æ³•äºŒè¼ƒæº–ï¼‰
        const step5Low = Math.min(method1Price, method2Price);
        const step5High = Math.max(method1Price, method2Price);
        document.getElementById('step5PriceRange').textContent = `${step5Low.toFixed(2)} ~ ${step5High.toFixed(2)}å…ƒ`;
        
        console.log('ğŸ”¬ Step5 çµæœ:', { method1Price, method2Price, dim1Premium, dim2Premium, dim3Premium, dim4Premium });
        
    } else {
        // æ•¸æ“šä¸è¶³æˆ–æ¢ä»¶ä¸å®Œæ•´
        document.getElementById('step5ScarcityIndex').textContent = step5Scarcity > 0 ? step5Scarcity.toFixed(1) : '--';
        document.getElementById('step5ScarcityRank').textContent = '--';
        document.getElementById('step5RefCount').textContent = '--';
        document.getElementById('step5RefCases').innerHTML = 'ç„¡æ³•è¨ˆç®—ï¼ˆç¼ºå°‘è½‰æ›åƒ¹æˆ–è‚¡æœ¬æ•¸æ“šï¼‰';
        document.getElementById('step5Method1Premium').textContent = '--%';
        document.getElementById('step5Method1Cost').textContent = '--å…ƒ';
        document.getElementById('step5Method1Price').textContent = '--';
        document.getElementById('step5Method2Premium').textContent = '--%';
        document.getElementById('step5Method2CV').textContent = '--';
        document.getElementById('step5Method2Price').textContent = '--';
        document.getElementById('step5Pred1').textContent = '--å…ƒ';
        document.getElementById('step5Pred2').textContent = '--å…ƒ';
        document.getElementById('step5Diff').textContent = '--å…ƒ';
        document.getElementById('step5PriceRange').textContent = 'æ•¸æ“šä¸è¶³';
    }
    
    const div = document.getElementById('evaluationResult'); 
    div.className = 'evaluation-result active';
    
    const nm={'theoRange':'ç†è«–åƒ¹','broker':'åˆ¸å•†','size':'è¦æ¨¡','industry':'ç”¢æ¥­','years':'å¹´æœŸ','capital':'è‚¡æœ¬','rating':'ä¿¡è©•'};
    
    // === æº¢åƒ¹ç‡åˆ†ææ³•è¡¨æ ¼ ===
    let premiumRows = '';
    let sumLow = 0, sumAvg = 0, dimCount = 0;
    for(const[k,d] of Object.entries(r.dimensions)) {
        premiumRows+=`<tr>
            <td>${nm[k] || k}</td>
            <td>${d.displayRange || d.range}</td>
            <td>${safeFixed(d.low)}%</td>
            <td>${safeFixed(d.avg)}%</td>
            <td>${safeFixed(d.weight*100,0)}%</td>
            <td>${safeFixed(d.weightedLow)}</td>
            <td>${safeFixed(d.weightedAvg)}</td>
        </tr>`;
        if(d.low !== null && !isNaN(d.low)) { sumLow += d.low; }
        if(d.avg !== null && !isNaN(d.avg)) { sumAvg += d.avg; }
        dimCount++;
    }
    
    if(r.inputData.subjectiveWeight > 0) {
        premiumRows+=`<tr style="background:#fff3e0">
            <td>ä¸»è§€</td><td>è‡ªè¨‚</td>
            <td>${r.inputData.subjectiveLowPremium}%</td>
            <td>${r.inputData.subjectiveAvgPremium}%</td>
            <td>${r.inputData.subjectiveWeight}%</td>
            <td>${r.weightedSubjectiveLow}</td>
            <td>${r.weightedSubjectiveAvg}</td>
        </tr>`;
    }
    
    // v3.72 æ–°å¢ï¼šæ“”ä¿èª¿æ•´è¡Œ
    if(r.guaranteeAdj > 0) {
        premiumRows+=`<tr style="background:#e8f5e9">
            <td>ğŸ›¡ï¸ æ“”ä¿</td><td>æœ‰æ“”ä¿</td>
            <td colspan="3" style="text-align:center; color:#2e7d32;">ç±Œç¢¼é›†ä¸­æ•ˆæ‡‰èª¿æ•´</td>
            <td>+${r.guaranteeAdj.toFixed(1)}</td>
            <td>+${r.guaranteeAdj.toFixed(1)}</td>
        </tr>`;
    }
    
    // v3.73 ä¿®æ­£ï¼šåˆè¨ˆè¡Œå¢åŠ åŸå§‹æ•¸å€¼çš„ç°¡å–®å¹³å‡
    const avgLow = dimCount > 0 ? (sumLow / dimCount).toFixed(2) : '-';
    const avgAvgPrem = dimCount > 0 ? (sumAvg / dimCount).toFixed(2) : '-';
    premiumRows+=`<tfoot><tr>
        <td></td><td style="text-align:right"><b>åˆè¨ˆ</b></td>
        <td><b>${avgLow}%</b></td><td><b>${avgAvgPrem}%</b></td><td>100%</td>
        <td><b>${r.totalLowPremium}%</b></td>
        <td><b>${r.totalAvgPremium}%</b></td>
    </tr></tfoot>`;
    
    // === å¾—æ¨™åƒ¹æ ¼åˆ†ææ³•è¡¨æ ¼ ===
    let priceRows = '';
    let sumLowBid = 0, sumAvgBid = 0, priceDimCount = 0;
    for(const[k,d] of Object.entries(r.dimensions)) {
        priceRows+=`<tr>
            <td>${nm[k] || k}</td>
            <td>${d.displayRange || d.range}</td>
            <td>${safeFixed(d.lowBidPrice || 0, 2)}</td>
            <td>${safeFixed(d.avgBidPrice || 0, 2)}</td>
            <td>${safeFixed(d.weight*100,0)}%</td>
            <td>${safeFixed(d.weightedLowBid || 0, 2)}</td>
            <td>${safeFixed(d.weightedAvgBid || 0, 2)}</td>
        </tr>`;
        if(d.lowBidPrice > 0) { sumLowBid += d.lowBidPrice; priceDimCount++; }
        if(d.avgBidPrice > 0) { sumAvgBid += d.avgBidPrice; }
    }
    
    // v3.73 ä¿®æ­£ï¼šåˆè¨ˆè¡Œå¢åŠ åŸå§‹æ•¸å€¼çš„ç°¡å–®å¹³å‡
    const avgLowBid = priceDimCount > 0 ? (sumLowBid / priceDimCount).toFixed(2) : '-';
    const avgAvgBid = priceDimCount > 0 ? (sumAvgBid / priceDimCount).toFixed(2) : '-';
    priceRows+=`<tfoot><tr>
        <td></td><td style="text-align:right"><b>åŠ æ¬Šå¾—æ¨™åƒ¹</b></td>
        <td><b>${avgLowBid}</b></td><td><b>${avgAvgBid}</b></td><td>100%</td>
        <td><b>${r.weightedLowBidPrice}</b></td>
        <td><b>${r.weightedAvgBidPrice}</b></td>
    </tr></tfoot>`;
    
    // æª¢æŸ¥æº¢åƒ¹ç‡æ³•æ˜¯å¦ä½æ–¼åº•æ¨™ï¼Œä¸¦ç”Ÿæˆå°æ‡‰çš„èªªæ˜
    const premiumWarning = r.premiumBelowFloor 
        ? `<div style="background:#fff3e0; border-left:4px solid #ff9800; padding:10px 12px; margin-top:10px; border-radius:0 8px 8px 0; font-size:13px; color:#e65100;">
            âš ï¸ æ­·å²æº¢åƒ¹ç‡è¨ˆç®—çµæœä½æ–¼åº•æ¨™ï¼Œå·²è‡ªå‹•èª¿æ•´ç‚ºåº•æ¨™åŸºæº–æ¨¡å¼<br>
            <span style="font-size:12px;">ğŸ’¡ ä»¥åº•æ¨™åƒ¹ ${r.floorPrice} å…ƒæŠ•æ¨™ = ç›¸ç•¶æ–¼æº¢åƒ¹ç‡ <b>${r.floorBasedPremium}%</b></span>
           </div>` 
        : '';
    
    // æ ¹æ“šæ˜¯å¦ä½æ–¼åº•æ¨™æ±ºå®šç­–ç•¥å¡ç‰‡èªªæ˜
    const conservativeDesc = r.premiumBelowFloor 
        ? `åº•æ¨™åƒ¹` 
        : `ç†è«–åƒ¹Ã—(1+${r.totalLowPremium}%)`;
    const balancedDesc = r.premiumBelowFloor 
        ? `åº•æ¨™åƒ¹Ã—1.03` 
        : `ç†è«–åƒ¹Ã—(1+${r.totalAvgPremium}%)`;
    const aggressiveDesc = r.premiumBelowFloor 
        ? `åº•æ¨™åƒ¹Ã—1.05` 
        : ``;
    const ultimateDesc = r.premiumBelowFloor 
        ? `åº•æ¨™åƒ¹Ã—1.07` 
        : ``;
    
    // v3.69 æ–°å¢ï¼šç¶­åº¦å¡«å¯«ç‹€æ…‹æç¤º
    const dimWarning = r.filledDimCount < r.totalDimCount 
        ? `<div style="background:#fff3e0; border-left:4px solid #ff9800; padding:10px 12px; margin-top:10px; border-radius:0 8px 8px 0; font-size:13px; color:#e65100;">
            âš ï¸ æ‚¨ç›®å‰å¡«å¯«äº† <b>${r.filledDimCount}</b> å€‹ç¶­åº¦ï¼ˆå…± ${r.totalDimCount} å€‹ï¼‰ï¼Œç³»çµ±å·²æŒ‰æ¯”ä¾‹èª¿æ•´æ¬Šé‡è¨ˆç®—ã€‚å¡«å¯«è¶Šå¤šç¶­åº¦ï¼Œè©•ä¼°çµæœè¶Šç²¾æº–ã€‚
           </div>` 
        : '';
    
    // v3.97y: çµ„åˆæ¨™é¡Œï¼ˆå„ªå…ˆç”¨é–ƒé›»å¸¶å…¥çš„CBä»£è™Ÿ+åç¨±ï¼‰
    let resultTitle = r.cbName || 'æœªå‘½åæ¨™çš„';
    if (window.currentCBCode && window.currentCBName) {
        resultTitle = `${window.currentCBCode} ${window.currentCBName}`;
    } else if (window.currentCBName) {
        resultTitle = window.currentCBName;
    }
    
    div.innerHTML = `
    <div class="result-header"><h2>${resultTitle}</h2><div>AI è©•ä¼°çµæœ</div></div>
    
    <!-- ========== åŸºæœ¬è³‡è¨Š ========== -->
    <div class="detail-section" style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);">
        <h3>ğŸ“‹ åŸºæœ¬è³‡è¨Š</h3>
        <div style="display:flex; gap:30px; flex-wrap:wrap; font-size:16px;">
            <div><span style="color:#666;">ç†è«–åƒ¹æ ¼ï¼š</span><b style="color:#667eea; font-size:24px;">${r.theoreticalPrice || 0}</b> å…ƒ</div>
            <div><span style="color:#666;">åº•æ¨™åƒ¹æ ¼ï¼š</span><b style="font-size:20px;">${r.floorPrice}</b> å…ƒ</div>
            <div><span style="color:#666;">å·²å¡«å¯«ç¶­åº¦ï¼š</span><b style="color:#1976d2;">${r.filledDimCount}</b> / ${r.totalDimCount}</div>
        </div>
        ${dimWarning}
    </div>

    <!-- ========== æº¢åƒ¹ç‡åˆ†ææ³• ========== -->
    <div class="detail-section" style="border: 2px solid #1976d2; border-radius: 12px;">
        <h3 style="color:#1976d2;">ğŸ“ˆ åˆ†ææ³•ä¸€ï¼šæº¢åƒ¹ç‡åˆ†ææ³•</h3>
        <p style="color:#666; font-size:13px; margin-bottom:10px;">
            é©ç”¨æƒ…å¢ƒï¼šç†è«–åƒ¹ â‰¥ 95å…ƒæ™‚ï¼Œåœ¨ç†è«–åƒ¹åŸºç¤ä¸ŠåŠ ä¸Šæ­·å²å¹³å‡æº¢åƒ¹ç‡è¨ˆç®—æŠ•æ¨™åƒ¹
        </p>
        
        <!-- æº¢åƒ¹ç‡æ³•æ ¸å¿ƒæ•¸æ“š -->
        <div style="background:#e3f2fd; padding:12px 15px; border-radius:8px; margin-bottom:15px;">
            <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                <div style="flex:1; min-width:150px;">
                    <div style="color:#1565c0; font-size:13px;">é ä¼°æº¢åƒ¹å€é–“</div>
                    <div style="font-size:20px; font-weight:bold; color:#0d47a1;">${r.totalLowPremium}% ~ ${r.totalAvgPremium}%</div>
                </div>
                <div style="flex:1; min-width:150px;">
                    <div style="color:#1565c0; font-size:13px;">ä¿å®ˆæŠ•æ¨™åƒ¹</div>
                    <div style="font-size:20px; font-weight:bold; color:#2e7d32;">${r.premiumBidPrices.conservative} å…ƒ</div>
                </div>
                <div style="flex:1; min-width:150px;">
                    <div style="color:#1565c0; font-size:13px;">å¹³è¡¡æŠ•æ¨™åƒ¹</div>
                    <div style="font-size:20px; font-weight:bold; color:#1565c0;">${r.premiumBidPrices.balanced} å…ƒ</div>
                </div>
            </div>
        </div>
        
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead><tr>
                    <th>ç¶­åº¦</th><th>æ¢ä»¶</th>
                    <th>æœ€ä½<br>æº¢åƒ¹</th><th>å¹³å‡<br>æº¢åƒ¹</th>
                    <th>æ¬Šé‡</th><th>åŠ æ¬Š<br>æœ€ä½</th><th>åŠ æ¬Š<br>å¹³å‡</th>
                </tr></thead>
                <tbody>${premiumRows}</tbody>
            </table>
        </div>
        ${premiumWarning}
        <div class="price-grid" style="margin-top:15px;">
            <div class="strategy-card conservative">
                <h4>ğŸ›¡ï¸ ä¿å®ˆ</h4>
                <div class="price">${r.premiumBidPrices.conservative}</div>
                <div style="font-size:11px; color:#666;">${conservativeDesc}</div>
            </div>
            <div class="strategy-card balanced">
                <h4>âš–ï¸ å¹³è¡¡</h4>
                <div class="price">${r.premiumBidPrices.balanced}</div>
                <div style="font-size:11px; color:#666;">${balancedDesc}</div>
            </div>
            <div class="strategy-card aggressive">
                <h4>ğŸš€ ç©æ¥µ</h4>
                <div class="price">${r.premiumBidPrices.aggressive}</div>
                <div style="font-size:11px; color:#666;">${aggressiveDesc}</div>
            </div>
            <div class="strategy-card ultimate">
                <h4>ğŸ”¥ æ¥µè‡´</h4>
                <div class="price">${r.premiumBidPrices.ultimate}</div>
                <div style="font-size:11px; color:#666;">${ultimateDesc}</div>
            </div>
        </div>
    </div>

    <!-- ========== å¾—æ¨™åƒ¹æ ¼åˆ†ææ³• ========== -->
    <div class="detail-section" style="border: 2px solid #e65100; border-radius: 12px;">
        <h3 style="color:#e65100;">ğŸ“Š åˆ†ææ³•äºŒï¼šå¾—æ¨™åƒ¹æ ¼åˆ†ææ³•</h3>
        <p style="color:#666; font-size:13px; margin-bottom:10px;">
            é©ç”¨æƒ…å¢ƒï¼šç†è«–åƒ¹ < 95å…ƒ æˆ– æº¢åƒ¹ç‡æ³•ä½æ–¼åº•æ¨™æ™‚ï¼Œç›´æ¥ç”¨æ­·å²å¹³å‡å¾—æ¨™åƒ¹æ ¼åŠ æ¬Šè¨ˆç®—
        </p>
        
        <!-- å¾—æ¨™åƒ¹æ ¼æ³•æ ¸å¿ƒæ•¸æ“š -->
        <div style="background:#fff3e0; padding:12px 15px; border-radius:8px; margin-bottom:15px;">
            <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                <div style="flex:1; min-width:150px;">
                    <div style="color:#e65100; font-size:13px;">åŠ æ¬Šæœ€ä½å¾—æ¨™åƒ¹</div>
                    <div style="font-size:20px; font-weight:bold; color:#2e7d32;">${r.weightedLowBidPrice} å…ƒ</div>
                    <div style="font-size:12px; color:#666;">â‰ˆ æº¢åƒ¹ç‡ ${r.impliedLowPremium}%</div>
                </div>
                <div style="flex:1; min-width:150px;">
                    <div style="color:#e65100; font-size:13px;">åŠ æ¬Šå¹³å‡å¾—æ¨™åƒ¹</div>
                    <div style="font-size:20px; font-weight:bold; color:#bf360c;">${r.weightedAvgBidPrice} å…ƒ</div>
                    <div style="font-size:12px; color:#666;">â‰ˆ æº¢åƒ¹ç‡ ${r.impliedAvgPremium}%</div>
                </div>
                <div style="flex:1; min-width:150px;">
                    <div style="color:#e65100; font-size:13px;">åº•æ¨™åƒ¹æ ¼</div>
                    <div style="font-size:20px; font-weight:bold; color:#333;">${r.floorPrice} å…ƒ</div>
                </div>
            </div>
        </div>
        
        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead><tr>
                    <th>ç¶­åº¦</th><th>æ¢ä»¶</th>
                    <th>æœ€ä½<br>å¾—æ¨™åƒ¹</th><th>å¹³å‡<br>å¾—æ¨™åƒ¹</th>
                    <th>æ¬Šé‡</th><th>åŠ æ¬Š<br>æœ€ä½</th><th>åŠ æ¬Š<br>å¹³å‡</th>
                </tr></thead>
                <tbody>${priceRows}</tbody>
            </table>
        </div>
        <div class="price-grid" style="margin-top:15px;">
            <div class="strategy-card conservative" style="border-color:#e65100;">
                <h4>ğŸ›¡ï¸ ä¿å®ˆ</h4>
                <div class="price">${r.priceBidPrices.conservative}</div>
                <div style="font-size:11px; color:#666;">åŠ æ¬Šæœ€ä½å¾—æ¨™åƒ¹</div>
            </div>
            <div class="strategy-card balanced" style="border-color:#e65100;">
                <h4>âš–ï¸ å¹³è¡¡</h4>
                <div class="price">${r.priceBidPrices.balanced}</div>
                <div style="font-size:11px; color:#666;">åŠ æ¬Šå¹³å‡å¾—æ¨™åƒ¹</div>
            </div>
            <div class="strategy-card aggressive" style="border-color:#e65100;">
                <h4>ğŸš€ ç©æ¥µ</h4>
                <div class="price">${r.priceBidPrices.aggressive}</div>
            </div>
            <div class="strategy-card ultimate" style="border-color:#e65100;">
                <h4>ğŸ”¥ æ¥µè‡´</h4>
                <div class="price">${r.priceBidPrices.ultimate}</div>
            </div>
        </div>
    </div>

    ${generateRexCommentary(r)}
    
    ${generateConditionSummaryHTML(r)}
    
    ${r.majorPlayerResult ? generateMajorPlayerHTML(r.majorPlayerResult, r.floorPrice, r.theoreticalPrice, r.guarantee) : ''}
    
    <div style="text-align:center;margin-top:25px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button onclick="location.reload()" class="calculate-btn" style="width:180px; background:#555;">ğŸ”„ é‡æ–°è©•ä¼°</button>
        <button onclick="window.print()" class="calculate-btn" style="width:180px;">ğŸ–¨ï¸ åˆ—å°å ±å‘Š</button>
    </div>`;
    
    div.scrollIntoView({ behavior: 'smooth' });
    
    // v3.72: åˆå§‹åŒ–å‡ºåƒ¹é¢¨éšªè©•ä¼°
    if (r.majorPlayerResult && r.theoreticalPrice) {
        setTimeout(() => {
            const bidInput = document.getElementById('mpUserBidPrice');
            if (bidInput) {
                const bidPrice = parseFloat(bidInput.value) || r.floorPrice;
                const basePrice = Math.max(r.theoreticalPrice, r.floorPrice);
                const userPremium = ((bidPrice / basePrice) - 1) * 100;
                updateBidRiskAssessment(userPremium, r.theoreticalPrice, r.guarantee);
            }
        }, 100);
    }
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // v3.72 ä¿®æ”¹ï¼šç¶­åº¦æ¬Šé‡é‡æ–°å„ªåŒ–
    const cbName = document.getElementById('cbName').value;
    const industry = document.getElementById('industry').value;
    const issueSize = document.getElementById('issueSize').value;
    const years = document.getElementById('years').value;
    const guarantee = document.getElementById('guarantee').value;
    const rating = document.getElementById('rating').value;
    const capital = document.getElementById('capital').value;
    const stockPrice = document.getElementById('stockPrice').value;
    const actualConversionPrice = document.getElementById('actualConversionPrice').value;
    const theoRange = document.getElementById('theoRange').value;  // v3.72 æ”¹ç‚ºç†è«–åƒ¹å€é–“
    const broker = document.getElementById('broker').value;
    
    // v3.72 æ–°å¢ï¼šé ä¼°æŠ•æ¨™å€æ•¸
    const estBidMultiple = parseFloat(document.getElementById('estBidMultiple')?.value) || 0;
    
    // æª¢æŸ¥æ˜¯å¦è‡³å°‘å¡«å¯«ä¸€å€‹æ¢ä»¶
    const hasAnyCondition = industry || issueSize || years || guarantee || rating || capital || theoRange || broker;
    
    if (!hasAnyCondition) {
        alert("âš ï¸ è«‹è‡³å°‘å¡«å¯«ä¸€å€‹ç¯©é¸æ¢ä»¶ï¼ˆç”¢æ¥­ã€è¦æ¨¡ã€å¹´æœŸã€æ“”ä¿ã€ä¿¡è©•ã€è‚¡æœ¬ã€ç†è«–åƒ¹ã€åˆ¸å•†å…¶ä¸­ä¹‹ä¸€ï¼‰");
        return;
    }
    
    try {
        displayResult(calculateEvaluation({
            cbName: cbName, 
            industry: industry, 
            issueSize: issueSize,
            years: years, 
            guarantee: guarantee, 
            rating: rating,
            capital: capital,
            stockPrice: parseFloat(stockPrice) || 0, 
            actualConversionPrice: parseFloat(actualConversionPrice) || 0,
            floorPrice: parseFloat(document.getElementById('floorPrice').value) || 100,
            theoRange: theoRange,  // v3.72 æ”¹ç‚ºç†è«–åƒ¹å€é–“
            subjectiveWeight: parseFloat(document.getElementById('subjectiveWeight').value)||0, 
            subjectiveLowPremium: parseFloat(document.getElementById('subjectiveLowPremium').value)||0, 
            subjectiveAvgPremium: parseFloat(document.getElementById('subjectiveAvgPremium').value)||0,
            broker: broker,
            estBidMultiple: estBidMultiple
        }));
    } catch (err) {
        alert("âš ï¸ è¨ˆç®—éŒ¯èª¤ï¼š\n" + err.message);
        console.error(err);
    }
});

// ==========================================
// å¯æ‹–æ›³åˆ†éš”ç·šåŠŸèƒ½
// ==========================================
function initResizer() {
    const resizer = document.getElementById('resizer');
    const container = document.querySelector('.evaluation-container');
    const inputPanel = document.getElementById('inputPanel');
    
    if (!resizer || !container || !inputPanel) return;
    
    let isResizing = false;
    let startX, startWidth;
    
    resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        startX = e.clientX;
        startWidth = inputPanel.offsetWidth;
        
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        const diff = e.clientX - startX;
        let newWidth = startWidth + diff;
        
        // é™åˆ¶æœ€å°å’Œæœ€å¤§å¯¬åº¦
        newWidth = Math.max(280, Math.min(600, newWidth));
        
        container.style.gridTemplateColumns = newWidth + 'px 8px 1fr';
    });
    
    document.addEventListener('mouseup', function() {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });
    
    // è§¸æ§è£ç½®æ”¯æ´
    resizer.addEventListener('touchstart', function(e) {
        isResizing = true;
        startX = e.touches[0].clientX;
        startWidth = inputPanel.offsetWidth;
        e.preventDefault();
    });
    
    document.addEventListener('touchmove', function(e) {
        if (!isResizing) return;
        
        const diff = e.touches[0].clientX - startX;
        let newWidth = startWidth + diff;
        newWidth = Math.max(280, Math.min(600, newWidth));
        
        container.style.gridTemplateColumns = newWidth + 'px 8px 1fr';
    });
    
    document.addEventListener('touchend', function() {
        isResizing = false;
    });
}

// ==========================================
// v3.69 é–ƒé›»å¸¶å…¥åŠŸèƒ½ - æ‰¿éŠ·ä¸­æ¡ˆä»¶è³‡æ–™ï¼ˆå«ç‹€æ…‹åˆ¤æ–·ï¼‰
// v3.72 ä¿®æ”¹ï¼šæ”¹ç‚ºå¾06å·¥ä½œè¡¨å‹•æ…‹è¼‰å…¥
// v3.94 ä¿®æ”¹ï¼šé‡æ–°åˆ†çµ„é‚è¼¯
//   - å³å°‡ç«¶æ‹/è©¢åœˆï¼šæœ‰æ™‚ç¨‹ä¸”æ™‚ç¨‹ >= ä»Šå¤©ï¼ˆå°šæœªå®Œæˆï¼‰
//   - æ‰¿éŠ·ä¸­ï¼šå°šæœªç¢ºå®šæ™‚ç¨‹
// v3.93 å„ªåŒ–é–ƒé›»å¸¶å…¥åŠŸèƒ½
// åˆ†çµ„ï¼š
//   - å³å°‡ç«¶æ‹/è©¢åœˆï¼šæœ‰æ™‚ç¨‹ä¸”æœªå®Œæˆ
//   - æ‰¿éŠ·ä¸­ï¼šå°šæœªç¢ºå®šæ™‚ç¨‹
// ==========================================
let pendingCases = [];
let recentCompletedCases = []; // v3.93 æ–°å¢ï¼šè¿‘æœŸå®Œæˆæ¡ˆä¾‹

// åˆå§‹åŒ–é–ƒé›»å¸¶å…¥é¸å–®ï¼ˆæŒ‰ç‹€æ…‹åˆ†çµ„ï¼‰
function initQuickSelect() {
    const select = document.getElementById('quickSelect');
    const upcomingAuctionGroup = document.getElementById('upcomingAuctionGroup');
    const upcomingInquiryGroup = document.getElementById('upcomingInquiryGroup');
    const pendingAuctionGroup = document.getElementById('pendingAuctionGroup');
    const pendingInquiryGroup = document.getElementById('pendingInquiryGroup');
    const recentAuctionGroup = document.getElementById('recentAuctionGroup');
    const recentInquiryGroup = document.getElementById('recentInquiryGroup');
    
    if (!select) return;
    
    // æ¸…ç©ºå„åˆ†çµ„
    if (upcomingAuctionGroup) upcomingAuctionGroup.innerHTML = '';
    if (upcomingInquiryGroup) upcomingInquiryGroup.innerHTML = '';
    if (pendingAuctionGroup) pendingAuctionGroup.innerHTML = '';
    if (pendingInquiryGroup) pendingInquiryGroup.innerHTML = '';
    if (recentAuctionGroup) recentAuctionGroup.innerHTML = '';
    if (recentInquiryGroup) recentInquiryGroup.innerHTML = '';
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const currentYear = today.getFullYear();
    
    // v3.97 ä¿®æ­£ï¼šè¼”åŠ©å‡½æ•¸ - è§£ææŠ•æ¨™æœŸé–“ä¸¦åˆ¤æ–·æ˜¯å¦å·²å®Œæˆ
    function parseBidPeriodAndCheck(bidPeriodStr) {
        if (!bidPeriodStr || bidPeriodStr === 'æœªå®š' || bidPeriodStr.includes('æœªå®š')) {
            return { hasSchedule: false, isCompleted: false };
        }
        
        // è§£æçµæŸæ—¥æœŸï¼Œæ ¼å¼å¦‚ "11/25-11/27" æˆ– "12/17-12/19"
        const parts = bidPeriodStr.split('-');
        if (parts.length >= 2) {
            const endPart = parts[1].trim();
            const match = endPart.match(/(\d+)\/(\d+)/);
            if (match) {
                const endMonth = parseInt(match[1]);
                const endDay = parseInt(match[2]);
                
                // åˆ¤æ–·å¹´ä»½ï¼šæ‰¿éŠ·ä¸­æ¡ˆä»¶æ™‚ç¨‹ä¸æœƒè·¨å¹´å¤ªé ï¼Œè¦–ç‚ºç•¶å¹´åº¦
                const endDateObj = new Date(currentYear, endMonth - 1, endDay);
                endDateObj.setHours(0, 0, 0, 0);
                
                const isCompleted = endDateObj < today;
                return { hasSchedule: true, isCompleted: isCompleted, endDate: endDateObj };
            }
        }
        
        // æœ‰æ™‚ç¨‹å­—ä¸²ä½†ç„¡æ³•è§£æï¼Œè¦–ç‚ºæœ‰æ™‚ç¨‹ä½†æœªå®Œæˆ
        return { hasSchedule: true, isCompleted: false };
    }
    
    // 1. è™•ç†06å·¥ä½œè¡¨æ¡ˆä¾‹ï¼ˆpendingCasesï¼‰- åˆ†ç‚ºå³å°‡é€²è¡Œã€æ‰¿éŠ·ä¸­ã€è¿‘æœŸå®Œæˆ
    pendingCases.forEach((c, idx) => {
        // è·³éå·²æ›ç‰Œçš„
        if (c.status === 'listed') return;
        
        const option = document.createElement('option');
        option.value = 'pending_' + idx;
        
        // v3.97 ä¿®æ­£ï¼šä½¿ç”¨è¼”åŠ©å‡½æ•¸åˆ¤æ–·æ™‚ç¨‹ç‹€æ…‹
        const scheduleStatus = parseBidPeriodAndCheck(c.bidPeriod);
        const hasSchedule = scheduleStatus.hasSchedule;
        const isCompleted = scheduleStatus.isCompleted;
        
        // æº–å‚™é¡¯ç¤ºå…§å®¹
        let priceLabel = '';
        if (c.auctionType === 'ç«¶æ‹') {
            if (c.isPriceRange) {
                priceLabel = `åº•æ¨™${Math.round(c.floorPrice)}~${Math.round(c.highPrice)}`;
            } else {
                priceLabel = `åº•æ¨™${Math.round(c.floorPrice)}`;
            }
        } else {
            // è©¢åœˆé¡¯ç¤ºæ‰¿éŠ·åƒ¹
            if (c.floorPrice && c.floorPrice !== 100) {
                priceLabel = `æ‰¿éŠ·${Math.round(c.floorPrice)}`;
            } else {
                priceLabel = 'æ‰¿éŠ·åƒ¹å¾…å®š';
            }
        }
        
        const convInfo = c.convPrice > 0 ? ` | è½‰${c.convPrice}` : '';
        const scheduleInfo = c.bidPeriod ? ` | ${c.bidPeriod}` : '';
        
        // v3.97 ä¿®æ­£ï¼šä½¿ç”¨includesåˆ¤æ–·ç«¶æ‹/è©¢åœˆ
        const isAuction = c.auctionType && (c.auctionType.includes('ç«¶æ‹') || c.auctionType === 'ç«¶æ‹');
        const isInquiry = c.auctionType && (c.auctionType.includes('è©¢åœˆ') || c.auctionType === 'è©¢åœˆ');
        
        if (isAuction) {
            if (isCompleted) {
                // âœ… å·²å®Œæˆç«¶æ‹ â†’ æ”¾åˆ°ã€Œè¿‘æœŸå®Œæˆç«¶æ‹ã€åˆ†çµ„
                option.textContent = `âœ… ${c.cbName} | ${c.industry} | ${priceLabel}${convInfo}${scheduleInfo}`;
                if (recentAuctionGroup) recentAuctionGroup.appendChild(option);
            } else if (hasSchedule) {
                // ğŸ”¥ å³å°‡ç«¶æ‹
                option.textContent = `ğŸ”¥ ${c.cbName} | ${c.industry} | ${priceLabel}${convInfo}${scheduleInfo}`;
                if (upcomingAuctionGroup) upcomingAuctionGroup.appendChild(option);
            } else {
                // â³ æ‰¿éŠ·ä¸­-ç«¶æ‹ï¼ˆå°šæœªç¢ºå®šæ™‚ç¨‹ï¼‰
                option.textContent = `â³ ${c.cbName} | ${c.industry} | ${priceLabel}${convInfo}`;
                if (pendingAuctionGroup) pendingAuctionGroup.appendChild(option);
            }
        } else if (isInquiry) {
            // è©¢åœˆ
            if (isCompleted) {
                // âœ… å·²å®Œæˆè©¢åœˆ â†’ æ”¾åˆ°ã€Œè¿‘æœŸå®Œæˆè©¢åœˆã€åˆ†çµ„
                option.textContent = `âœ… ${c.cbName} | ${c.industry} | ${c.guarantee || '-'}${scheduleInfo}`;
                if (recentInquiryGroup) recentInquiryGroup.appendChild(option);
            } else if (hasSchedule) {
                // ğŸ“‹ å³å°‡è©¢åœˆ
                option.textContent = `ğŸ“‹ ${c.cbName} | ${c.industry} | ${c.guarantee || '-'}${scheduleInfo}`;
                if (upcomingInquiryGroup) upcomingInquiryGroup.appendChild(option);
            } else {
                // â³ æ‰¿éŠ·ä¸­-è©¢åœˆï¼ˆå°šæœªç¢ºå®šæ™‚ç¨‹ï¼‰
                option.textContent = `â³ ${c.cbName} | ${c.industry} | ${c.guarantee || '-'}`;
                if (pendingInquiryGroup) pendingInquiryGroup.appendChild(option);
            }
        } else {
            // æœªè¨­å®šé¡å‹çš„ï¼Œé è¨­æ”¾åˆ°ç«¶æ‹æ‰¿éŠ·ä¸­
            option.textContent = `â³ ${c.cbName} | ${c.industry} | ${priceLabel}${convInfo}`;
            if (pendingAuctionGroup) pendingAuctionGroup.appendChild(option);
        }
    });
    
    // ç›£è¯é¸æ“‡äº‹ä»¶
    select.addEventListener('change', handleQuickSelect);
}

// è™•ç†é–ƒé›»å¸¶å…¥é¸æ“‡
// v3.93 ä¿®æ”¹ï¼šæ”¯æ´pending_Xå’Œrecent_Xå…©ç¨®æ ¼å¼
function handleQuickSelect() {
    const select = document.getElementById('quickSelect');
    const infoDiv = document.getElementById('quickSelectInfo');
    const compareDiv = document.getElementById('modelCompareResult');
    const val = select.value;
    
    if (val === '' || val === null) {
        infoDiv.style.display = 'none';
        if (compareDiv) compareDiv.style.display = 'none';
        return;
    }
    
    let c = null;
    let isRecentCase = false;
    
    // åˆ¤æ–·æ˜¯pendingé‚„æ˜¯recentæ¡ˆä¾‹
    if (val.startsWith('pending_')) {
        const idx = parseInt(val.replace('pending_', ''));
        c = pendingCases[idx];
    } else if (val.startsWith('recent_')) {
        const idx = parseInt(val.replace('recent_', ''));
        c = recentCompletedCases[idx];
        isRecentCase = true;
    } else {
        // å…¼å®¹èˆŠæ ¼å¼
        c = pendingCases[parseInt(val)];
    }
    
    if (!c) return;
    
    // v3.97y: ä¿å­˜å®Œæ•´æ¨™çš„è³‡è¨Šä¾›çµæœæ¨™é¡Œä½¿ç”¨
    window.currentCBCode = c.cbCode || '';
    window.currentCBName = c.cbName || '';
    console.log('âš¡ é–ƒé›»å¸¶å…¥æ¨™çš„:', window.currentCBCode, window.currentCBName);
    
    // å¸¶å…¥å„æ¬„ä½
    // v3.74 ä¿®æ­£ï¼šåªå¸¶å…¥è‚¡ç¥¨ä»£è™Ÿï¼Œé€™æ¨£å¯ä»¥æœå°‹è©²å…¬å¸æ‰€æœ‰æ­·å²ç«¶æ‹/è©¢åœˆç´€éŒ„
    document.getElementById('cbName').value = c.stockCode || c.cbCode || '';
    
    // è‚¡æœ¬å€é–“
    if (c.capitalRange) {
        document.getElementById('capital').value = c.capitalRange;
    } else if (c.capital > 0) {
        // å¾capitalè¨ˆç®—å€é–“
        const cap = c.capital;
        let capRange = '';
        if (cap < 3) capRange = 'å°æ–¼3å„„';
        else if (cap < 6) capRange = '3~6å„„';
        else if (cap < 10) capRange = '6~10å„„';
        else if (cap < 15) capRange = '10~15å„„';
        else if (cap < 20) capRange = '15~20å„„';
        else capRange = 'å¤§æ–¼20å„„';
        document.getElementById('capital').value = capRange;
    }
    
    // ç”¢æ¥­åˆ†é¡
    const industrySelect = document.getElementById('industry');
    if (c.industry) {
        let found = false;
        for (let opt of industrySelect.options) {
            if (opt.value === c.industry || opt.textContent.includes(c.industry)) {
                industrySelect.value = opt.value;
                found = true;
                break;
            }
        }
        if (!found) {
            const newOpt = document.createElement('option');
            newOpt.value = c.industry;
            newOpt.textContent = c.industry;
            industrySelect.appendChild(newOpt);
            industrySelect.value = c.industry;
        }
    }
    
    // ç™¼è¡Œåˆ¸å•†
    const brokerSelect = document.getElementById('broker');
    if (c.broker) {
        let found = false;
        for (let opt of brokerSelect.options) {
            if (opt.value === c.broker || opt.textContent.includes(c.broker)) {
                brokerSelect.value = opt.value;
                found = true;
                break;
            }
        }
        if (!found && c.broker) {
            const newOpt = document.createElement('option');
            newOpt.value = c.broker;
            newOpt.textContent = c.broker;
            brokerSelect.appendChild(newOpt);
            brokerSelect.value = c.broker;
        }
    }
    
    // ç™¼è¡Œè¦æ¨¡å€é–“
    // v3.97w: åŒæ™‚å­˜å¯¦éš›æ•¸å­—ä¾› Step 4 ä½¿ç”¨
    if (c.issueSize > 0) {
        window.currentActualIssueSize = c.issueSize;
        console.log('âš¡ é–ƒé›»å¸¶å…¥å¯¦éš›è¦æ¨¡:', c.issueSize, 'å„„');
    }
    if (c.sizeRange) {
        document.getElementById('issueSize').value = c.sizeRange;
    } else if (c.issueSize > 0) {
        const size = c.issueSize;
        let sizeRange = '';
        if (size < 2) sizeRange = 'å°æ–¼2å„„';
        else if (size < 5) sizeRange = '2~5å„„';
        else if (size < 10) sizeRange = '5~10å„„';
        else if (size < 15) sizeRange = '10~15å„„';
        else if (size < 20) sizeRange = '15~20å„„';
        else sizeRange = 'å¤§æ–¼20å„„';
        document.getElementById('issueSize').value = sizeRange;
    }
    
    // v3.81 æ”¹é€²ï¼šæœ‰è‚¡åƒ¹/è½‰æ›åƒ¹æ‰è¨ˆç®—ç†è«–åƒ¹ï¼Œæ²’æœ‰å°±ç•™ç©ºè®“ç”¨æˆ¶è¼¸å…¥
    if (c.theoRange) {
        // å¦‚æœcaseObjå·²æœ‰theoRangeï¼Œç›´æ¥ä½¿ç”¨
        document.getElementById('theoRange').value = c.theoRange;
    } else if (c.auctionType !== 'è©¢åœˆ' && c.stockPrice > 0 && c.convPrice > 0) {
        // åªæœ‰ç«¶æ‹æ¡ˆä¾‹æ‰å¾è‚¡åƒ¹å’Œè½‰æ›åƒ¹è¨ˆç®—ç†è«–åƒ¹
        const theoPrice = (c.stockPrice / c.convPrice) * 100;
        let theoRange = '';
        if (theoPrice < 90) theoRange = 'å°æ–¼90å…ƒ';
        else if (theoPrice < 95) theoRange = '90~95å…ƒ';
        else if (theoPrice < 100) theoRange = '95~100å…ƒ';
        else if (theoPrice < 105) theoRange = '100~105å…ƒ';
        else if (theoPrice < 110) theoRange = '105~110å…ƒ';
        else if (theoPrice < 115) theoRange = '110~115å…ƒ';
        else theoRange = 'å¤§æ–¼115å…ƒ';
        document.getElementById('theoRange').value = theoRange;
    }
    // è©¢åœˆæ¡ˆä¾‹ä¸è‡ªå‹•å¸¶å…¥ç†è«–åƒ¹å€é–“
    
    // ç™¼è¡Œå¹´æœŸ
    if (c.years) document.getElementById('years').value = c.years;
    
    // æ“”ä¿æƒ…æ³
    if (c.guarantee) document.getElementById('guarantee').value = c.guarantee;
    
    // ä¿¡ç”¨è©•ç­‰
    if (c.rating) document.getElementById('rating').value = c.rating;
    
    // åº•æ¨™åƒ¹æ ¼ - åªæœ‰ç«¶æ‹æ¡ˆä¾‹æ‰å¸¶å…¥
    if (c.auctionType !== 'è©¢åœˆ' && c.floorPrice) {
        document.getElementById('floorPrice').value = Math.round(c.floorPrice);
    }
    
    // è‚¡åƒ¹ - åªæœ‰ç«¶æ‹æ¡ˆä¾‹æ‰å¸¶å…¥
    if (c.auctionType !== 'è©¢åœˆ' && c.stockPrice > 0) {
        document.getElementById('stockPrice').value = c.stockPrice;
    }
    
    // å¯¦éš›è½‰æ›åƒ¹æ ¼ - åªæœ‰ç«¶æ‹æ¡ˆä¾‹æ‰å¸¶å…¥
    if (c.auctionType !== 'è©¢åœˆ' && c.convPrice > 0) {
        document.getElementById('actualConversionPrice').value = c.convPrice;
    }
    
    // ç‹€æ…‹æ¨™ç±¤ - å€åˆ†ç«¶æ‹å’Œè©¢åœˆ
    const auctionStatusInfo = {
        'pending': {label: 'â³ å°šæœªå…¬å‘ŠæŠ•æ¨™æ—¥æœŸ', color: '#9e9e9e'},
        'bidding': {label: 'ğŸ”¥ æŠ•æ¨™é€²è¡Œä¸­', color: '#ff5722'},
        'closed': {label: 'â±ï¸ å·²æˆªæ¨™å¾…é–‹æ¨™', color: '#ff9800'},
        'opened': {label: 'ğŸ“Š å·²é–‹æ¨™æœªæ›ç‰Œ', color: '#4caf50'},
        'listed': {label: 'âœ… å·²æ›ç‰Œ', color: '#2196f3'},
        'completed': {label: 'âœ… å·²å®Œæˆ', color: '#4caf50'}
    };
    
    const inquiryStatusInfo = {
        'pending': {label: 'â³ å°šæœªå…¬å‘Šè©¢åœˆæ—¥æœŸ', color: '#9e9e9e'},
        'bidding': {label: 'ğŸ“‹ è©¢åœˆé€²è¡Œä¸­', color: '#1976d2'},
        'closed': {label: 'â±ï¸ è©¢åœˆçµæŸå¾…å®šåƒ¹', color: '#ff9800'},
        'opened': {label: 'ğŸ“Š å·²å®šåƒ¹æœªæ›ç‰Œ', color: '#4caf50'},
        'listed': {label: 'âœ… å·²æ›ç‰Œ', color: '#2196f3'},
        'completed': {label: 'âœ… å·²å®Œæˆ', color: '#4caf50'}
    };
    
    const statusInfo = c.auctionType === 'è©¢åœˆ' ? inquiryStatusInfo : auctionStatusInfo;
    const status = statusInfo[c.status] || {label: 'æœªçŸ¥', color: '#666'};
    const theoPrice = c.convPrice > 0 && c.stockPrice > 0 ? ((c.stockPrice / c.convPrice) * 100).toFixed(2) : 'å¾…è¨ˆç®—';
    const priceDisplay = c.isPriceRange ? `${Math.round(c.floorPrice)}~${Math.round(c.highPrice)}` : Math.round(c.floorPrice);
    
    // åŸºæœ¬è³‡è¨Š - æ ¹æ“šæ¡ˆä¾‹é¡å‹é¡¯ç¤ºä¸åŒå…§å®¹
    if (isRecentCase) {
        // å·²å®Œæˆæ¡ˆä¾‹çš„é¡¯ç¤º
        const marketInfo = (c.marketHigh > 0 && c.marketLow > 0) 
            ? `æ›ç‰Œé«˜: <b style="color:#2e7d32;">${safeFixed(c.marketHigh, 1)}</b> | æ›ç‰Œä½: <b style="color:#c62828;">${safeFixed(c.marketLow, 1)}</b> | æŒ¯å¹…: <b style="color:#E91E63;">${(((c.marketHigh - c.marketLow) / c.marketLow) * 100).toFixed(1)}%</b>`
            : '';
        
        if (c.auctionType === 'ç«¶æ‹') {
            // ç«¶æ‹æ¡ˆä¾‹é¡¯ç¤ºå¾—æ¨™è³‡è¨Š
            const bidInfo = c.minBidPrice > 0 
                ? `æœ€ä½å¾—æ¨™: <b>${safeFixed(c.minBidPrice, 2)}</b> | åŠ æ¬Šå‡åƒ¹: <b>${safeFixed(c.avgBidPrice, 2)}</b>`
                : '';
            
            infoDiv.innerHTML = `
                <div style="font-weight:bold; color:#2e7d32; margin-bottom:5px;">âœ… å·²å¸¶å…¥ã€Œ${c.cbName}ã€ç«¶æ‹æ­·å²è³‡æ–™</div>
                <div style="display:inline-block; padding:2px 8px; border-radius:4px; background:#9c27b0; color:#fff; font-size:12px; margin-bottom:5px;">ç«¶æ‹</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; font-size:13px;">
                    <span>ğŸ­ ${c.industry}</span>
                    <span>ğŸ’° ${c.issueSize > 0 ? c.issueSize + 'å„„' : '-'}</span>
                    ${c.convPrice > 0 ? `<span>ğŸ¯ è½‰æ›åƒ¹${c.convPrice}</span>` : ''}
                    <span>ğŸ“‹ ${c.guarantee || '-'}</span>
                </div>
                ${bidInfo ? `<div style="margin-top:5px; color:#9c27b0; font-size:13px;">ğŸ¯ ${bidInfo}</div>` : ''}
                ${marketInfo ? `<div style="margin-top:5px; color:#1565c0; font-size:13px;">ğŸ“Š ${marketInfo}</div>` : ''}
                <div style="margin-top:5px; color:#795548; font-size:12px;">
                    ğŸ’¡ æ­¤ç‚ºå·²å®Œæˆç«¶æ‹æ¡ˆä¾‹ï¼Œå¯ä½œç‚ºé¡ä¼¼æ¡ˆä»¶åƒè€ƒ
                </div>
            `;
        } else {
            // è©¢åœˆæ¡ˆä¾‹åªé¡¯ç¤ºæ›ç‰Œè¡¨ç¾
            infoDiv.innerHTML = `
                <div style="font-weight:bold; color:#1976d2; margin-bottom:5px;">âœ… å·²å¸¶å…¥ã€Œ${c.cbName}ã€è©¢åœˆæ­·å²è³‡æ–™</div>
                <div style="display:inline-block; padding:2px 8px; border-radius:4px; background:#1976d2; color:#fff; font-size:12px; margin-bottom:5px;">è©¢åœˆ</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; font-size:13px;">
                    <span>ğŸ­ ${c.industry}</span>
                    <span>ğŸ’° ${c.issueSize > 0 ? c.issueSize + 'å„„' : '-'}</span>
                    <span>ğŸ“‹ ${c.guarantee || '-'}</span>
                    <span>ğŸ“… ${c.years || 3}å¹´æœŸ</span>
                </div>
                ${marketInfo ? `<div style="margin-top:5px; color:#1565c0; font-size:13px;">ğŸ“Š ${marketInfo}</div>` : ''}
                <div style="margin-top:5px; color:#795548; font-size:12px;">
                    ğŸ’¡ æ­¤ç‚ºå·²å®Œæˆè©¢åœˆæ¡ˆä¾‹ï¼Œä»¥æ›ç‰Œè¡¨ç¾ä½œç‚ºåƒè€ƒ
                </div>
            `;
        }
    } else {
        // å³å°‡é€²è¡Œæ¡ˆä¾‹çš„é¡¯ç¤º
        if (c.auctionType === 'ç«¶æ‹') {
            // ç«¶æ‹æ¡ˆä¾‹é¡¯ç¤ºå®Œæ•´è³‡è¨Š
            infoDiv.innerHTML = `
                <div style="font-weight:bold; color:#e65100; margin-bottom:5px;">âœ… å·²å¸¶å…¥ã€Œ${c.cbName}ã€ç«¶æ‹è³‡æ–™</div>
                <div style="display:inline-block; padding:2px 8px; border-radius:4px; background:${status.color}; color:#fff; font-size:12px; margin-bottom:5px;">${status.label}</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; font-size:13px;">
                    <span>ğŸ­ ${c.industry}</span>
                    <span>ğŸ’° è¦æ¨¡${c.issueSize}å„„</span>
                    <span>ğŸ“ˆ è‚¡æœ¬${(c.capital || 0).toFixed(2)}å„„</span>
                    ${c.convPrice > 0 ? `<span>ğŸ¯ è½‰æ›åƒ¹${c.convPrice}</span>` : ''}
                    <span>â­ TCRI${c.rating || 'æœªçŸ¥'}</span>
                </div>
                <div style="margin-top:5px; color:#1565c0; font-size:13px;">
                    ğŸ“Œ åƒè€ƒè‚¡åƒ¹ï¼š<b>${c.stockPrice}</b> å…ƒ | åº•æ¨™ï¼š<b>${priceDisplay}</b> å…ƒ 
                    ${c.convPrice > 0 ? `| ç†è«–åƒ¹ç´„ï¼š<b>${theoPrice}</b> å…ƒ` : ''}
                </div>
                ${c.bidPeriod ? `<div style="margin-top:3px; color:#666; font-size:12px;">ğŸ“… æŠ•æ¨™æœŸé–“ï¼š${c.bidPeriod} | é–‹æ¨™ï¼š${c.openDate} ${c.listingDate ? `| æ›ç‰Œï¼š${c.listingDate}` : ''}</div>` : ''}
                <div style="margin-top:5px; color:#795548; font-size:12px;">
                    âš ï¸ è‚¡åƒ¹ç‚ºåƒè€ƒå€¼ï¼Œè«‹æ–¼æˆªæ¨™æ—¥13:30å‰ç¢ºèªæœ€æ–°æ”¶ç›¤åƒ¹
                </div>
            `;
        } else {
            // è©¢åœˆæ¡ˆä¾‹é¡¯ç¤ºç°¡åŒ–è³‡è¨Š
            infoDiv.innerHTML = `
                <div style="font-weight:bold; color:#1976d2; margin-bottom:5px;">âœ… å·²å¸¶å…¥ã€Œ${c.cbName}ã€è©¢åœˆè³‡æ–™</div>
                <div style="display:inline-block; padding:2px 8px; border-radius:4px; background:${status.color}; color:#fff; font-size:12px; margin-bottom:5px;">${status.label}</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; font-size:13px;">
                    <span>ğŸ­ ${c.industry}</span>
                    <span>ğŸ’° è¦æ¨¡${c.issueSize}å„„</span>
                    <span>ğŸ“ˆ è‚¡æœ¬${(c.capital || 0).toFixed(2)}å„„</span>
                    <span>ğŸ“‹ ${c.guarantee || '-'}</span>
                    <span>ğŸ“… ${c.years || 3}å¹´æœŸ</span>
                </div>
                ${c.floorPrice && c.floorPrice !== 100 ? `<div style="margin-top:5px; color:#1565c0; font-size:13px;">ğŸ“Œ æ‰¿éŠ·åƒ¹ï¼š<b>${priceDisplay}</b> å…ƒ</div>` : ''}
                ${c.bidPeriod ? `<div style="margin-top:3px; color:#666; font-size:12px;">ğŸ“… è©¢åœˆæœŸé–“ï¼š${c.bidPeriod} ${c.listingDate ? `| é è¨ˆæ›ç‰Œï¼š${c.listingDate}` : ''}</div>` : ''}
                <div style="margin-top:5px; color:#795548; font-size:12px;">
                    ğŸ’¡ è©¢åœˆå®Œæˆå¾Œ1-4æ—¥å…§å°‡æ±ºå®šè½‰æ›åƒ¹æ ¼
                </div>
            `;
        }
    }
    infoDiv.style.display = 'block';
    
    // v3.94 é‡å¯«ï¼šæ ¹æ“šç«¶æ‹/è©¢åœˆåˆ†åˆ¥è™•ç†
    if (c.auctionType === 'è©¢åœˆ') {
        // === è©¢åœˆæ¡ˆä¾‹ï¼šé¡¯ç¤ºæ­·å²ç™¼è¡Œæ¢ä»¶åˆ†æï¼ˆæ›ç‰Œè¡¨ç¾çµ±è¨ˆï¼‰===
        if (compareDiv) {
            // è¨ˆç®—å„æ¢ä»¶çš„è©¢åœˆæ›ç‰Œçµ±è¨ˆ
            const inquiryStats = calculateInquiryConditionStats(c);
            
            if (inquiryStats) {
                let statsHtml = `
                    <div style="font-weight:bold; color:#1976d2; margin-bottom:10px; font-size:14px;">ğŸ“Š æ­·å²ç™¼è¡Œæ¢ä»¶åˆ†æï¼ˆè©¢åœˆæ›ç‰Œè¡¨ç¾ï¼‰</div>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <tr style="background:#e3f2fd;">
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:left;">æ¢ä»¶</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">ç¯©é¸å€¼</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">æ¨£æœ¬æ•¸</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">å¹³å‡é«˜</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">å¹³å‡ä½</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">å¹³å‡æŒ¯å¹…</th>
                        </tr>`;
                
                inquiryStats.conditions.forEach(cond => {
                    if (cond.count > 0) {
                        statsHtml += `
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">${cond.name}</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:#1565c0;">${cond.value}</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">${cond.count}æª”</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:#2e7d32; font-weight:bold;">${safeFixed(cond.avgHigh, 1)}</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:#c62828; font-weight:bold;">${safeFixed(cond.avgLow, 1)}</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:#E91E63; font-weight:bold;">${safeFixed(cond.avgAmp, 1)}%</td>
                        </tr>`;
                    }
                });
                
                // ç¶œåˆçµ±è¨ˆ
                if (inquiryStats.overall.count > 0) {
                    statsHtml += `
                        <tr style="background:#fff3e0;">
                            <td style="padding:6px; border:1px solid #e0e0e0; font-weight:bold;" colspan="2">å…¨éƒ¨è©¢åœˆå¹³å‡</td>
                            <td style="padding:6px; border:1px solid #e0e0e0; text-align:center; font-weight:bold;">${inquiryStats.overall.count}æª”</td>
                            <td style="padding:6px; border:1px solid #e0e0e0; text-align:center; color:#2e7d32; font-weight:bold;">${safeFixed(inquiryStats.overall.avgHigh, 1)}</td>
                            <td style="padding:6px; border:1px solid #e0e0e0; text-align:center; color:#c62828; font-weight:bold;">${safeFixed(inquiryStats.overall.avgLow, 1)}</td>
                            <td style="padding:6px; border:1px solid #e0e0e0; text-align:center; color:#E91E63; font-weight:bold;">${safeFixed(inquiryStats.overall.avgAmp, 1)}%</td>
                        </tr>`;
                }
                
                statsHtml += `</table>`;
                
                // å¦‚æœæœ‰ç•¶å‰æ¡ˆä¾‹çš„æ›ç‰Œè¡¨ç¾ï¼Œä¹Ÿé¡¯ç¤º
                if (c.marketHigh > 0 && c.marketLow > 0) {
                    const caseAmp = ((c.marketHigh - c.marketLow) / c.marketLow * 100);
                    statsHtml += `
                        <div style="margin-top:10px; padding:10px; background:#e8f5e9; border-radius:6px;">
                            <div style="font-weight:bold; color:#2e7d32; margin-bottom:5px;">ğŸ“Œ æ­¤æ¡ˆä¾‹å¯¦éš›è¡¨ç¾</div>
                            <div style="display:flex; gap:20px; font-size:14px;">
                                <span>æ›ç‰Œæœ€é«˜: <b style="color:#2e7d32;">${safeFixed(c.marketHigh, 1)}</b></span>
                                <span>æ›ç‰Œæœ€ä½: <b style="color:#c62828;">${safeFixed(c.marketLow, 1)}</b></span>
                                <span>æŒ¯å¹…: <b style="color:#E91E63;">${safeFixed(caseAmp, 1)}%</b></span>
                            </div>
                        </div>`;
                }
                
                statsHtml += `
                    <div style="margin-top:8px; font-size:12px; color:#666;">
                        ğŸ’¡ è©¢åœˆæ¡ˆä¾‹ä»¥æ›ç‰Œè¡¨ç¾ç‚ºåƒè€ƒä¾æ“šï¼Œå„æ¢ä»¶ç¯©é¸å¯å¹«åŠ©è©•ä¼°é¡ä¼¼æ¡ˆä¾‹è¡¨ç¾
                    </div>`;
                
                compareDiv.innerHTML = statsHtml;
                compareDiv.style.display = 'block';
            } else {
                compareDiv.innerHTML = `
                    <div style="padding:10px; background:#fff3e0; border-radius:6px;">
                        <div style="color:#e65100;">âš ï¸ å°šç„¡è¶³å¤ è©¢åœˆæ­·å²æ•¸æ“šé€²è¡Œåˆ†æ</div>
                    </div>`;
                compareDiv.style.display = 'block';
            }
        }
        
        // è©¢åœˆæ¡ˆä¾‹åªè§¸ç™¼æ¢ä»¶æ¬„ä½çš„changeäº‹ä»¶ï¼ˆä¸è§¸ç™¼ç«¶æ‹ç›¸é—œï¼‰
        ['capital', 'industry', 'issueSize', 'years', 'guarantee', 'rating', 'broker'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.dispatchEvent(new Event('change'));
        });
        
        // è©¢åœˆæ¡ˆä¾‹ï¼šæ¸…ç©ºAIè©•ä¼°å€åŸŸï¼Œé¡¯ç¤ºè©¢åœˆå°ˆç”¨æç¤º
        setTimeout(() => {
            const evalContainer = document.getElementById('auctionEvaluation');
            if (evalContainer) {
                evalContainer.innerHTML = `
                    <div style="padding:15px; background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius:10px; border:2px solid #1976d2;">
                        <div style="font-weight:bold; color:#1565c0; margin-bottom:10px; font-size:15px;">ğŸ“‹ è©¢åœˆæ¡ˆä¾‹èªªæ˜</div>
                        <div style="font-size:13px; color:#444; line-height:1.7;">
                            æ­¤ç‚º<b>è©¢åœˆ</b>ç™¼è¡Œæ¡ˆä¾‹ï¼Œèˆ‡ç«¶æ‹æ©Ÿåˆ¶ä¸åŒï¼š<br>
                            â€¢ è©¢åœˆç„¡åº•æ¨™åƒ¹æ ¼ï¼Œç”±æ‰¿éŠ·å•†å‘æ³•äººè©¢åƒ¹<br>
                            â€¢ è©¢åœˆå®Œæˆå¾Œ1-4æ—¥å…§æ±ºå®šè½‰æ›åƒ¹æ ¼<br>
                            â€¢ åƒè€ƒæŒ‡æ¨™ä»¥<b>æ›ç‰Œè¡¨ç¾</b>ï¼ˆé«˜/ä½/æŒ¯å¹…ï¼‰ç‚ºä¸»<br><br>
                            ä¸Šæ–¹ã€Œæ­·å²ç™¼è¡Œæ¢ä»¶åˆ†æã€å·²ä¾æ“šé¸å–æ¢ä»¶ï¼Œ<br>
                            çµ±è¨ˆç›¸ä¼¼è©¢åœˆæ¡ˆä¾‹çš„æ›ç‰Œè¡¨ç¾ä¾›åƒè€ƒã€‚
                        </div>
                    </div>`;
            }
            
            // æ¸…ç©ºå³æ™‚é æ¸¬å€
            const liveContainer = document.getElementById('liveAIPrediction');
            if (liveContainer) {
                liveContainer.innerHTML = `
                    <div style="padding:10px; text-align:center; color:#1976d2;">
                        ğŸ“‹ è©¢åœˆæ¡ˆä¾‹è«‹åƒè€ƒä¸Šæ–¹ã€Œæ­·å²ç™¼è¡Œæ¢ä»¶åˆ†æã€
                    </div>`;
            }
        }, 100);
        
    } else {
        // === ç«¶æ‹æ¡ˆä¾‹ï¼šåŸæœ‰é‚è¼¯ ===
        if (compareDiv && (c.status === 'opened' || c.status === 'listed' || c.status === 'completed')) {
            const theoVal = c.convPrice > 0 && c.stockPrice > 0 ? (c.stockPrice / c.convPrice) * 100 : 0;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦éš›ç«¶æ‹çµæœ
            const actualMinBid = c.actualMinBid || c.minBidPrice || 0;
            const actualAvgBid = c.actualAvgBid || c.avgBidPrice || 0;
            const hasActualResult = actualMinBid > 0 || actualAvgBid > 0;
            
            if (hasActualResult) {
                const ds = window.DYNAMIC_STATS || {};
                const modelEstMinBid = ds.avgMinBid || 106.10;
                const modelEstAvgBid = ds.avgBid || 107.92;
                
                const minBidError = actualMinBid > 0 ? (actualMinBid - modelEstMinBid).toFixed(2) : '-';
                const avgBidError = actualAvgBid > 0 ? (actualAvgBid - modelEstAvgBid).toFixed(2) : '-';
                
                compareDiv.innerHTML = `
                    <div style="font-weight:bold; color:#2e7d32; margin-bottom:8px;">ğŸ“Š ç«¶æ‹çµæœ vs æ¨¡å‹é ä¼°æ¯”å°</div>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <tr style="background:#e8f5e9;">
                            <th style="padding:6px; border:1px solid #c8e6c9; text-align:left;">æŒ‡æ¨™</th>
                            <th style="padding:6px; border:1px solid #c8e6c9; text-align:center;">å¯¦éš›çµæœ</th>
                            <th style="padding:6px; border:1px solid #c8e6c9; text-align:center;">æ¨¡å‹é ä¼°</th>
                            <th style="padding:6px; border:1px solid #c8e6c9; text-align:center;">èª¤å·®</th>
                        </tr>
                        ${actualMinBid > 0 ? `
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">æœ€ä½å¾—æ¨™åƒ¹</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; font-weight:bold; color:#1565c0;">${actualMinBid.toFixed(2)}å…ƒ</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">${modelEstMinBid.toFixed(2)}å…ƒ</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:${parseFloat(minBidError) > 0 ? '#e65100' : '#2e7d32'};">${minBidError}å…ƒ</td>
                        </tr>` : ''}
                        ${actualAvgBid > 0 ? `
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">åŠ æ¬Šå‡åƒ¹</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; font-weight:bold; color:#1565c0;">${actualAvgBid.toFixed(2)}å…ƒ</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">${modelEstAvgBid.toFixed(2)}å…ƒ</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:${parseFloat(avgBidError) > 0 ? '#e65100' : '#2e7d32'};">${avgBidError}å…ƒ</td>
                        </tr>` : ''}
                        ${theoVal > 0 ? `
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">ç†è«–åƒ¹</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">${theoVal.toFixed(2)}å…ƒ</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">-</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">-</td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">å¯¦éš›æº¢åƒ¹ç‡</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; font-weight:bold; color:#e65100;">${actualMinBid > 0 ? ((actualMinBid/theoVal - 1) * 100).toFixed(2) : '-'}%</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">-</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">-</td>
                        </tr>` : ''}
                    </table>
                    <div style="margin-top:8px; font-size:12px; color:#666;">
                        ğŸ’¡ æ¨¡å‹é ä¼°åŸºæ–¼${ds.count || '--'}æª”æ­·å²å¹³å‡å€¼ï¼Œé¸æ“‡æ¢ä»¶å¾Œå¯ç²å¾—å°ˆå±¬é ä¼°
                    </div>
                `;
                compareDiv.style.display = 'block';
            } else {
                compareDiv.style.display = 'none';
            }
        } else {
            if (compareDiv) compareDiv.style.display = 'none';
        }
        
        // ç«¶æ‹æ¡ˆä¾‹ï¼šè§¸ç™¼æ‰€æœ‰æ¬„ä½äº‹ä»¶
        ['capital', 'industry', 'issueSize', 'theoRange', 'years', 'guarantee', 'rating', 'broker'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.dispatchEvent(new Event('change'));
        });
        
        ['stockPrice', 'actualConversionPrice', 'floorPrice'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.dispatchEvent(new Event('input'));
        });
        
        // ç«¶æ‹æ¡ˆä¾‹ï¼šè§¸ç™¼AIè©•ä¼°
        setTimeout(() => {
            if (typeof updateAuctionEvaluation === 'function') {
                updateAuctionEvaluation();
            }
        }, 100);
    }
    
    // è§¸ç™¼ cbName çš„ input äº‹ä»¶ï¼Œé¡¯ç¤ºæ­·å²è³‡æ–™å¡
    const cbNameEl = document.getElementById('cbName');
    if (cbNameEl) {
        cbNameEl.dispatchEvent(new Event('input'));
    }
}

// v3.94 æ–°å¢ï¼šè¨ˆç®—è©¢åœˆæ¢ä»¶çµ±è¨ˆ
function calculateInquiryConditionStats(caseData) {
    if (!window.inquiryRawData || inquiryRawData.length === 0) {
        return null;
    }
    
    const conditions = [];
    
    // ç¯©é¸æœ‰æ›ç‰Œæ•¸æ“šçš„è©¢åœˆæ¡ˆä¾‹
    const validInquiries = inquiryRawData.filter(d => d.marketHigh > 0 && d.marketLow > 0);
    if (validInquiries.length === 0) return null;
    
    // è¨ˆç®—å…¨éƒ¨å¹³å‡
    const overallStats = calculateInquiryAvg(validInquiries);
    
    // 1. ç”¢æ¥­ç¯©é¸
    if (caseData.industry) {
        const industryFiltered = validInquiries.filter(d => d.industry === caseData.industry);
        if (industryFiltered.length > 0) {
            const stats = calculateInquiryAvg(industryFiltered);
            conditions.push({
                name: 'ç”¢æ¥­',
                value: caseData.industry,
                count: industryFiltered.length,
                avgHigh: stats.avgHigh,
                avgLow: stats.avgLow,
                avgAmp: stats.avgAmp
            });
        }
    }
    
    // 2. æ“”ä¿ç¯©é¸
    if (caseData.guarantee) {
        const guaranteeVal = caseData.guarantee.includes('æœ‰') ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
        const guaranteeFiltered = validInquiries.filter(d => {
            const g = d.guarantee || '';
            return guaranteeVal === 'æœ‰æ“”ä¿' ? g.includes('æœ‰') : g.includes('ç„¡');
        });
        if (guaranteeFiltered.length > 0) {
            const stats = calculateInquiryAvg(guaranteeFiltered);
            conditions.push({
                name: 'æ“”ä¿',
                value: guaranteeVal,
                count: guaranteeFiltered.length,
                avgHigh: stats.avgHigh,
                avgLow: stats.avgLow,
                avgAmp: stats.avgAmp
            });
        }
    }
    
    // 3. ç™¼è¡Œè¦æ¨¡ç¯©é¸
    if (caseData.issueSize > 0) {
        const size = caseData.issueSize;
        let sizeRange = '';
        let filterFn = null;
        if (size < 2) { sizeRange = 'å°æ–¼2å„„'; filterFn = d => d.issueSize < 2; }
        else if (size < 5) { sizeRange = '2~5å„„'; filterFn = d => d.issueSize >= 2 && d.issueSize < 5; }
        else if (size < 10) { sizeRange = '5~10å„„'; filterFn = d => d.issueSize >= 5 && d.issueSize < 10; }
        else if (size < 15) { sizeRange = '10~15å„„'; filterFn = d => d.issueSize >= 10 && d.issueSize < 15; }
        else if (size < 20) { sizeRange = '15~20å„„'; filterFn = d => d.issueSize >= 15 && d.issueSize < 20; }
        else { sizeRange = 'å¤§æ–¼20å„„'; filterFn = d => d.issueSize >= 20; }
        
        if (filterFn) {
            const sizeFiltered = validInquiries.filter(filterFn);
            if (sizeFiltered.length > 0) {
                const stats = calculateInquiryAvg(sizeFiltered);
                conditions.push({
                    name: 'ç™¼è¡Œè¦æ¨¡',
                    value: sizeRange,
                    count: sizeFiltered.length,
                    avgHigh: stats.avgHigh,
                    avgLow: stats.avgLow,
                    avgAmp: stats.avgAmp
                });
            }
        }
    }
    
    // 4. å¹´æœŸç¯©é¸
    if (caseData.years) {
        const yearsFiltered = validInquiries.filter(d => d.years == caseData.years);
        if (yearsFiltered.length > 0) {
            const stats = calculateInquiryAvg(yearsFiltered);
            conditions.push({
                name: 'å¹´æœŸ',
                value: caseData.years + 'å¹´',
                count: yearsFiltered.length,
                avgHigh: stats.avgHigh,
                avgLow: stats.avgLow,
                avgAmp: stats.avgAmp
            });
        }
    }
    
    // 5. åˆ¸å•†ç¯©é¸
    if (caseData.broker) {
        const brokerFiltered = validInquiries.filter(d => d.broker === caseData.broker);
        if (brokerFiltered.length > 0) {
            const stats = calculateInquiryAvg(brokerFiltered);
            conditions.push({
                name: 'æ‰¿éŠ·å•†',
                value: caseData.broker,
                count: brokerFiltered.length,
                avgHigh: stats.avgHigh,
                avgLow: stats.avgLow,
                avgAmp: stats.avgAmp
            });
        }
    }
    
    return {
        conditions: conditions,
        overall: overallStats
    };
}

// v3.94 æ–°å¢ï¼šè¨ˆç®—è©¢åœˆæ›ç‰Œå¹³å‡å€¼
function calculateInquiryAvg(dataArray) {
    if (!dataArray || dataArray.length === 0) {
        return { count: 0, avgHigh: 0, avgLow: 0, avgAmp: 0 };
    }
    
    let sumHigh = 0, sumLow = 0, sumAmp = 0, count = 0;
    
    dataArray.forEach(d => {
        if (d.marketHigh > 0 && d.marketLow > 0) {
            sumHigh += d.marketHigh;
            sumLow += d.marketLow;
            sumAmp += ((d.marketHigh - d.marketLow) / d.marketLow * 100);
            count++;
        }
    });
    
    return {
        count: count,
        avgHigh: count > 0 ? sumHigh / count : 0,
        avgLow: count > 0 ? sumLow / count : 0,
        avgAmp: count > 0 ? sumAmp / count : 0
    };
}

// ==========================================
// v3.70 å›æ¸¬åˆ†æåŠŸèƒ½æ¨¡çµ„
// ==========================================

/**
 * å¾å€é–“å­—ä¸²æå–ä¸­é–“å€¼ï¼ˆå…¨å±€ç‰ˆæœ¬ï¼‰
 */
function getRangeMidValue(rangeStr, type) {
    if (typeof rangeStr === 'number' && !isNaN(rangeStr)) return rangeStr;
    const str = String(rangeStr || '');
    // è½‰æ›åƒ¹å€é–“
    if (type === 'conversion') {
        if (str.includes('å°æ–¼20')) return 15;
        if (str.includes('20~50')) return 35;
        if (str.includes('50~100')) return 75;
        if (str.includes('100~150')) return 125;
        if (str.includes('150~200')) return 175;
        if (str.includes('å¤§æ–¼200')) return 250;
    }
    // v3.72 æ–°å¢ï¼šç†è«–åƒ¹å€é–“
    if (type === 'theoRange') {
        if (str.includes('å°æ–¼90')) return 85;
        if (str.includes('90~95')) return 92.5;
        if (str.includes('95~100')) return 97.5;
        if (str.includes('100~105')) return 102.5;
        if (str.includes('105~110')) return 107.5;
        if (str.includes('110~115')) return 112.5;
        if (str.includes('å¤§æ–¼115')) return 120;
    }
    // è‚¡æœ¬å€é–“
    if (type === 'capital') {
        if (str.includes('å°æ–¼3')) return 2;
        if (str.includes('3~6')) return 4.5;
        if (str.includes('6~10')) return 8;
        if (str.includes('10~15')) return 12.5;
        if (str.includes('15~20')) return 17.5;
        if (str.includes('å¤§æ–¼20')) return 30;
    }
    // ç™¼è¡Œè¦æ¨¡å€é–“
    if (type === 'size') {
        if (str.includes('å°æ–¼2')) return 1.5;
        if (str.includes('2~5')) return 3.5;
        if (str.includes('5~10')) return 7.5;
        if (str.includes('10~15')) return 12.5;
        if (str.includes('15~20')) return 17.5;
        if (str.includes('å¤§æ–¼20')) return 30;
    }
    // å˜—è©¦è§£æç‚ºæ•¸å­—
    const num = parseFloat(str);
    return isNaN(num) ? 0 : num;
}

/**
 * è¨ˆç®—è¿‘Næª”ç«¶æ‹çš„å¸‚å ´æ°›åœ
 * @param {number} n - è¦è¨ˆç®—çš„è¿‘æœŸæ¡ˆä¾‹æ•¸é‡ï¼ˆé è¨­5ï¼‰
 * @returns {Object|null} å¸‚å ´æ°›åœæ•¸æ“š
 */
function calcMarketAtmosphere(n = 5, guarantee = null) {
    if (!auctionRawData || auctionRawData.length === 0) return null;
    
    // v3.81 ä¿®æ”¹ï¼šå…ˆæŒ‰æ“”ä¿é¡å‹ç¯©é¸ï¼Œå†æ’åº
    let filteredData = [...auctionRawData]
        .filter(d => d.openDate && d.avgPremium !== null && d.avgPremium !== undefined && d.bidMultiple > 0);
    
    // å¦‚æœæŒ‡å®šæ“”ä¿é¡å‹ï¼Œç¯©é¸åŒé¡å‹
    if (guarantee) {
        filteredData = filteredData.filter(d => d.guarantee === guarantee);
    }
    
    const sortedData = filteredData.sort((a, b) => {
            // v3.90 ä¿®æ­£ï¼šæ­£ç¢ºè§£ææ—¥æœŸå­—ä¸²ï¼ˆæ ¼å¼ï¼šYYYY/MM/DDï¼‰
            const parseDate = (dateStr) => {
                if (!dateStr || dateStr === '-') return new Date(0);
                if (typeof dateStr === 'number') {
                    // Excel serial number
                    return new Date((dateStr - 25569) * 86400 * 1000);
                }
                // å­—ä¸²æ ¼å¼ï¼šYYYY/MM/DD æˆ– YYYY-MM-DD
                const parts = String(dateStr).split(/[\/\-]/);
                if (parts.length >= 3) {
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
                return new Date(dateStr);
            };
            const dateA = parseDate(a.openDate);
            const dateB = parseDate(b.openDate);
            return dateB - dateA;  // é™åºï¼šæœ€æ–°çš„åœ¨å‰
        });
    
    if (sortedData.length === 0) return null;
    
    // v3.81 é‡å¤§æ”¹é€²ï¼š3ã€6ã€9æª”åŠ æ¬Šè¨ˆç®—ï¼ˆæ¬Šé‡5ã€3ã€2ï¼‰
    // åˆ†åˆ¥è¨ˆç®—æœ€ä½æº¢åƒ¹å’Œå¹³å‡æº¢åƒ¹
    const recent3 = sortedData.slice(0, Math.min(3, sortedData.length));
    const recent6 = sortedData.slice(0, Math.min(6, sortedData.length));
    const recent9 = sortedData.slice(0, Math.min(9, sortedData.length));
    
    // è¨ˆç®—å„å€é–“çš„å¹³å‡å€¼ï¼ˆæœ€ä½æº¢åƒ¹å’Œå¹³å‡æº¢åƒ¹ï¼‰
    function calcAvg(cases, field) {
        const valid = cases.filter(d => d[field] !== null && !isNaN(d[field]));
        return valid.length > 0 ? valid.reduce((s, d) => s + d[field], 0) / valid.length : 0;
    }
    
    // æœ€ä½æº¢åƒ¹åŠ æ¬Šï¼š3æª”Ã—5 + 6æª”Ã—3 + 9æª”Ã—2 / 10
    const minPrem3 = calcAvg(recent3, 'minPremium');
    const minPrem6 = calcAvg(recent6, 'minPremium');
    const minPrem9 = calcAvg(recent9, 'minPremium');
    const weightedMinPremium = (minPrem3 * 5 + minPrem6 * 3 + minPrem9 * 2) / 10;
    
    // å¹³å‡æº¢åƒ¹åŠ æ¬Šï¼š3æª”Ã—5 + 6æª”Ã—3 + 9æª”Ã—2 / 10
    const avgPrem3 = calcAvg(recent3, 'avgPremium');
    const avgPrem6 = calcAvg(recent6, 'avgPremium');
    const avgPrem9 = calcAvg(recent9, 'avgPremium');
    const weightedAvgPremium = (avgPrem3 * 5 + avgPrem6 * 3 + avgPrem9 * 2) / 10;
    
    // æŠ•æ¨™å€æ•¸åŠ æ¬Š
    const mult3 = calcAvg(recent3, 'bidMultiple');
    const mult6 = calcAvg(recent6, 'bidMultiple');
    const mult9 = calcAvg(recent9, 'bidMultiple');
    const weightedMultiple = (mult3 * 5 + mult6 * 3 + mult9 * 2) / 10;
    
    // å–è¿‘Næª”ç”¨æ–¼é¡¯ç¤º
    const recentCases = sortedData.slice(0, Math.min(n, sortedData.length));
    
    // è¨ˆç®—æ°›åœæŒ‡æ•¸ (0~100) - ä½¿ç”¨åŠ æ¬Šå¹³å‡æº¢åƒ¹
    // æº¢åƒ¹ç‡è²¢ç» (60%): 0%=30åˆ†, 5%=50åˆ†, 10%=70åˆ†, 15%+=90åˆ†
    // æŠ•æ¨™å€æ•¸è²¢ç» (40%): 1x=20åˆ†, 2x=40åˆ†, 3x=60åˆ†, 4x+=80åˆ†
    let premiumScore = Math.min(90, Math.max(10, 30 + weightedAvgPremium * 4));
    let multipleScore = Math.min(80, Math.max(20, weightedMultiple * 20));
    const atmosphereIndex = Math.round(premiumScore * 0.6 + multipleScore * 0.4);
    
    // åˆ¤æ–·æ°›åœç­‰ç´š
    let level, levelColor, suggestion;
    if (atmosphereIndex >= 75) {
        level = 'æ¥µç†±';
        levelColor = '#d32f2f';
        suggestion = 'å¸‚å ´ç«¶çˆ­æ¿€çƒˆï¼Œå»ºè­°æº¢åƒ¹ç‡ +3~4%';
    } else if (atmosphereIndex >= 60) {
        level = 'åç†±';
        levelColor = '#ff5722';
        suggestion = 'å¸‚å ´åç†±ï¼Œå»ºè­°æº¢åƒ¹ç‡ +1~2%';
    } else if (atmosphereIndex >= 45) {
        level = 'æ™®é€š';
        levelColor = '#ff9800';
        suggestion = 'å¸‚å ´æ­£å¸¸ï¼ŒæŒ‰æ­·å²å‡å€¼æŠ•æ¨™';
    } else if (atmosphereIndex >= 30) {
        level = 'åå†·';
        levelColor = '#2196f3';
        suggestion = 'å¸‚å ´åå†·ï¼Œå¯è€ƒæ…®æº¢åƒ¹ç‡ -1~2%';
    } else {
        level = 'æ¥µå†·';
        levelColor = '#1565c0';
        suggestion = 'å¸‚å ´å†·æ¸…ï¼Œå¯å¤§è†½é™ä½æº¢åƒ¹ç‡ -2~3%';
    }
    
    return {
        recentCases: recentCases,
        // v3.81 æ–°å¢ï¼šåˆ†é–‹çš„æœ€ä½æº¢åƒ¹å’Œå¹³å‡æº¢åƒ¹
        weightedMinPremium: weightedMinPremium,
        weightedAvgPremium: weightedAvgPremium,
        avgPremium: weightedAvgPremium,  // å‘å¾Œå…¼å®¹
        avgMultiple: weightedMultiple,
        // v3.81 æ–°å¢ï¼šå„å€é–“åŸå§‹æ•¸æ“š
        breakdown: {
            recent3: { minPremium: minPrem3, avgPremium: avgPrem3, multiple: mult3, count: recent3.length },
            recent6: { minPremium: minPrem6, avgPremium: avgPrem6, multiple: mult6, count: recent6.length },
            recent9: { minPremium: minPrem9, avgPremium: avgPrem9, multiple: mult9, count: recent9.length }
        },
        atmosphereIndex: atmosphereIndex,
        level: level,
        levelColor: levelColor,
        suggestion: suggestion,
        caseCount: recentCases.length,
        guarantee: guarantee
    };
}

/**
 * v3.81 æ–°å¢ï¼šè¨ˆç®—ç”¢æ¥­æ°›åœï¼ˆåŒç”¢æ¥­3ã€6ã€9æª”åŠ æ¬Šï¼‰
 * @param {string} industry - ç”¢æ¥­é¡åˆ¥
 * @param {string} guarantee - æ“”ä¿é¡å‹ï¼ˆå¯é¸ï¼‰
 * @returns {Object} ç”¢æ¥­æ°›åœçµæœ
 */
function calcIndustryAtmosphere(industry, guarantee = null) {
    if (!auctionRawData || auctionRawData.length === 0 || !industry) return null;
    
    // ç¯©é¸åŒç”¢æ¥­æ¡ˆä¾‹
    let filteredData = [...auctionRawData]
        .filter(d => d.openDate && d.avgPremium !== null && d.avgPremium !== undefined && d.bidMultiple > 0)
        .filter(d => d.industry === industry);
    
    // å¦‚æœæŒ‡å®šæ“”ä¿é¡å‹ï¼Œå†ç¯©é¸
    if (guarantee) {
        filteredData = filteredData.filter(d => d.guarantee === guarantee);
    }
    
    const sortedData = filteredData.sort((a, b) => {
        const dateA = new Date(a.openDate);
        const dateB = new Date(b.openDate);
        return dateB - dateA;
    });
    
    if (sortedData.length === 0) return null;
    
    // 3ã€6ã€9æª”åŠ æ¬Šè¨ˆç®—ï¼ˆæ¬Šé‡5ã€3ã€2ï¼‰
    const recent3 = sortedData.slice(0, Math.min(3, sortedData.length));
    const recent6 = sortedData.slice(0, Math.min(6, sortedData.length));
    const recent9 = sortedData.slice(0, Math.min(9, sortedData.length));
    
    function calcAvg(cases, field) {
        const valid = cases.filter(d => d[field] !== null && !isNaN(d[field]));
        return valid.length > 0 ? valid.reduce((s, d) => s + d[field], 0) / valid.length : 0;
    }
    
    // æœ€ä½æº¢åƒ¹åŠ æ¬Š
    const minPrem3 = calcAvg(recent3, 'minPremium');
    const minPrem6 = calcAvg(recent6, 'minPremium');
    const minPrem9 = calcAvg(recent9, 'minPremium');
    const weightedMinPremium = (minPrem3 * 5 + minPrem6 * 3 + minPrem9 * 2) / 10;
    
    // å¹³å‡æº¢åƒ¹åŠ æ¬Š
    const avgPrem3 = calcAvg(recent3, 'avgPremium');
    const avgPrem6 = calcAvg(recent6, 'avgPremium');
    const avgPrem9 = calcAvg(recent9, 'avgPremium');
    const weightedAvgPremium = (avgPrem3 * 5 + avgPrem6 * 3 + avgPrem9 * 2) / 10;
    
    // æŠ•æ¨™å€æ•¸åŠ æ¬Š
    const mult3 = calcAvg(recent3, 'bidMultiple');
    const mult6 = calcAvg(recent6, 'bidMultiple');
    const mult9 = calcAvg(recent9, 'bidMultiple');
    const weightedMultiple = (mult3 * 5 + mult6 * 3 + mult9 * 2) / 10;
    
    console.log(`ğŸ“Š ç”¢æ¥­æ°›åœ[${industry}]: æœ€ä½æº¢åƒ¹=${weightedMinPremium.toFixed(2)}%, å¹³å‡æº¢åƒ¹=${weightedAvgPremium.toFixed(2)}%, å€æ•¸=${weightedMultiple.toFixed(2)}x (${sortedData.length}æª”)`);
    
    return {
        industry: industry,
        caseCount: sortedData.length,
        weightedMinPremium: weightedMinPremium,
        weightedAvgPremium: weightedAvgPremium,
        weightedMultiple: weightedMultiple,
        breakdown: {
            recent3: { minPremium: minPrem3, avgPremium: avgPrem3, multiple: mult3, count: recent3.length },
            recent6: { minPremium: minPrem6, avgPremium: avgPrem6, multiple: mult6, count: recent6.length },
            recent9: { minPremium: minPrem9, avgPremium: avgPrem9, multiple: mult9, count: recent9.length }
        },
        recentCases: sortedData.slice(0, 5)
    };
}

/**
 * v3.81 æ–°å¢ï¼šè¨ˆç®—åŒæœŸç™¼è¡Œé‡ï¼ˆå«è©¢åœˆå’Œç«¶æ‹ï¼‰
 * åŒæœŸç™¼è¡Œå¤š â†’ è³‡é‡‘åˆ†æ•£ â†’ æº¢åƒ¹é™ä½
 * @param {string} targetDate - ç›®æ¨™é–‹æ¨™æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
 * @param {number} daysBefore - å¾€å‰ç®—å¹¾å¤©ï¼ˆé è¨­14å¤©ï¼‰
 * @param {number} daysAfter - å¾€å¾Œç®—å¹¾å¤©ï¼ˆé è¨­14å¤©ï¼‰
 * @param {string} excludeCbName - æ’é™¤çš„CBåç¨±ï¼ˆè‡ªå·±ï¼‰
 * @returns {Object} åŒæœŸç™¼è¡Œåˆ†æçµæœ
 */
function calcConcurrentIssue(targetDate, daysBefore = 14, daysAfter = 14, excludeCbName = '') {
    if (!targetDate) return null;
    
    const targetDateObj = new Date(targetDate);
    const startDate = new Date(targetDateObj);
    startDate.setDate(startDate.getDate() - daysBefore);
    const endDate = new Date(targetDateObj);
    endDate.setDate(endDate.getDate() + daysAfter);
    
    // å¾pendingCaseså’Œå·²é–‹æ¨™è³‡æ–™ä¸­æ‰¾åŒæœŸæ¡ˆä»¶
    let concurrentCases = [];
    
    // 1. å¾pendingCasesæ‰¾ï¼ˆå°šæœªé–‹æ¨™çš„æ¡ˆä»¶ï¼‰
    if (pendingCases && pendingCases.length > 0) {
        pendingCases.forEach(c => {
            if (c.cbName === excludeCbName) return;  // æ’é™¤è‡ªå·±
            
            // å–å¾—è©²æ¡ˆä»¶çš„æ—¥æœŸï¼ˆå„ªå…ˆç”¨é–‹æ¨™æ—¥ï¼Œæ²’æœ‰å°±ç”¨æˆªæ¨™æ—¥+2å¤©ä¼°ç®—ï¼‰
            let caseDate = null;
            if (c.openDate) {
                caseDate = new Date(c.openDate);
            } else if (c.bidEndDate) {
                caseDate = new Date(c.bidEndDate);
                caseDate.setDate(caseDate.getDate() + 2);  // ä¼°ç®—é–‹æ¨™æ—¥
            } else if (c.listingDate) {
                // ç”¨æ›ç‰Œæ—¥åæ¨é–‹æ¨™æ—¥ï¼ˆæ›ç‰Œæ—¥é€šå¸¸åœ¨é–‹æ¨™å¾Œ5-7å¤©ï¼‰
                caseDate = new Date(c.listingDate);
                caseDate.setDate(caseDate.getDate() - 6);
            }
            
            if (caseDate && caseDate >= startDate && caseDate <= endDate) {
                concurrentCases.push({
                    name: c.cbName,
                    type: c.auctionType || 'æœªçŸ¥',
                    size: c.issueSize || 0,
                    date: caseDate.toISOString().split('T')[0],
                    status: c.status || 'pending',
                    source: 'pending'
                });
            }
        });
    }
    
    // 2. å¾å·²é–‹æ¨™è³‡æ–™æ‰¾ï¼ˆæœ€è¿‘å·²é–‹æ¨™çš„æ¡ˆä»¶ï¼‰
    if (auctionRawData && auctionRawData.length > 0) {
        auctionRawData.forEach(d => {
            if (d.name === excludeCbName) return;  // æ’é™¤è‡ªå·±
            if (!d.openDate) return;
            
            const caseDate = new Date(d.openDate);
            if (caseDate >= startDate && caseDate <= endDate) {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨pendingCasesä¸­ï¼ˆé¿å…é‡è¤‡ï¼‰
                const exists = concurrentCases.some(c => c.name === d.name);
                if (!exists) {
                    concurrentCases.push({
                        name: d.name,
                        type: 'ç«¶æ‹',  // auctionRawDataéƒ½æ˜¯ç«¶æ‹
                        size: d.issueSize || 0,
                        date: d.openDate,
                        status: 'opened',
                        source: 'auction'
                    });
                }
            }
        });
    }
    
    // çµ±è¨ˆ
    const auctionCases = concurrentCases.filter(c => c.type === 'ç«¶æ‹');
    const inquiryCases = concurrentCases.filter(c => c.type === 'è©¢åœˆ');
    const totalSize = concurrentCases.reduce((s, c) => s + (c.size || 0), 0);
    const auctionSize = auctionCases.reduce((s, c) => s + (c.size || 0), 0);
    const inquirySize = inquiryCases.reduce((s, c) => s + (c.size || 0), 0);
    
    // è¨ˆç®—åŒæœŸç™¼è¡Œå£“åŠ›æŒ‡æ•¸ï¼ˆ0-100ï¼‰
    // åŸºæº–ï¼šåŒæœŸ20å„„ä»¥ä¸‹=æ­£å¸¸ï¼Œ20-40å„„=åå¤šï¼Œ40å„„ä»¥ä¸Š=å¾ˆå¤š
    let pressureIndex = 0;
    if (totalSize <= 10) pressureIndex = 10;
    else if (totalSize <= 20) pressureIndex = 30;
    else if (totalSize <= 30) pressureIndex = 50;
    else if (totalSize <= 40) pressureIndex = 70;
    else if (totalSize <= 50) pressureIndex = 85;
    else pressureIndex = 100;
    
    // è¨ˆç®—èª¿æ•´å€¼
    // åŒæœŸç™¼è¡Œå°‘ â†’ ä¸èª¿æ•´
    // åŒæœŸç™¼è¡Œå¤š â†’ ä¸‹èª¿æº¢åƒ¹é æ¸¬
    let adjustment = 0;
    let note = '';
    if (totalSize <= 10) {
        adjustment = 0;
        note = 'åŒæœŸç™¼è¡Œé‡æ­£å¸¸';
    } else if (totalSize <= 20) {
        adjustment = -0.5;
        note = 'åŒæœŸç™¼è¡Œé‡åå¤š';
    } else if (totalSize <= 30) {
        adjustment = -1;
        note = 'åŒæœŸç™¼è¡Œé‡è¼ƒå¤šï¼Œè³‡é‡‘åˆ†æ•£';
    } else if (totalSize <= 40) {
        adjustment = -1.5;
        note = 'âš ï¸ åŒæœŸç™¼è¡Œé‡å¤§ï¼Œè³‡é‡‘æ˜é¡¯åˆ†æ•£';
    } else {
        adjustment = -2;
        note = 'âš ï¸ åŒæœŸç™¼è¡Œé‡éå¸¸å¤§ï¼Œæ³¨æ„ç«¶çˆ­å£“åŠ›';
    }
    
    console.log(`ğŸ“¦ åŒæœŸç™¼è¡Œåˆ†æ(${daysBefore}å¤©å‰~${daysAfter}å¤©å¾Œ):`);
    console.log(`  ç¸½è¨ˆ: ${concurrentCases.length}æª”, ${totalSize.toFixed(1)}å„„`);
    console.log(`  ç«¶æ‹: ${auctionCases.length}æª”, ${auctionSize.toFixed(1)}å„„`);
    console.log(`  è©¢åœˆ: ${inquiryCases.length}æª”, ${inquirySize.toFixed(1)}å„„`);
    console.log(`  å£“åŠ›æŒ‡æ•¸: ${pressureIndex}, èª¿æ•´: ${adjustment}%`);
    
    return {
        cases: concurrentCases,
        summary: {
            totalCount: concurrentCases.length,
            totalSize: totalSize,
            auctionCount: auctionCases.length,
            auctionSize: auctionSize,
            inquiryCount: inquiryCases.length,
            inquirySize: inquirySize
        },
        pressureIndex: pressureIndex,
        adjustment: adjustment,
        note: note,
        dateRange: {
            start: startDate.toISOString().split('T')[0],
            end: endDate.toISOString().split('T')[0],
            target: targetDate
        }
    };
}

/**
 * è¨ˆç®—ç†±åº¦æŒ‡æ•¸
 * @param {Object} params - è¨ˆç®—åƒæ•¸
 * @returns {Object} ç†±åº¦åˆ†æçµæœ
 */
function calcHeatIndex(params) {
    const { issueSize, theoreticalPrice, industry, years, atmosphereIndex, rating, stockCap, broker } = params;
    
    let totalScore = 0;
    const breakdown = [];
    
    // v3.85 å¸‚å ´æ°›åœæ¬Šé‡å„ªåŒ–ï¼šäº”ç¶­åº¦ç²¾ç°¡ç‰ˆ
    // ç”¢æ¥­35% + åˆ¸å•†25% + ä¿¡è©•20% + è¦æ¨¡10% + ç†è«–åƒ¹10% = 100åˆ†
    // æ ¹æ“š2203æª”CBå¯¦è­‰æ•¸æ“šé‡æ–°è¨­è¨ˆ
    
    // 1. ç”¢æ¥­è©•åˆ† (æ»¿åˆ†35) - å¯¦è­‰å½±éŸ¿æœ€å¤§ï¼Œå„ªè‰¯ç‡å·®è·36%
    let industryScore = 21;  // åŸºæº–åˆ†
    const industryStr = String(industry || '');
    // æ ¹æ“š2203æª”å¯¦è­‰çš„ç”¢æ¥­ä¿‚æ•¸
    if (industryStr.includes('é›»å­é€šè·¯')) {
        industryScore = 35;  // ä¿‚æ•¸1.14ï¼Œå„ªè‰¯ç‡72%
    } else if (industryStr.includes('é›»å­é›¶çµ„ä»¶')) {
        industryScore = 35;  // ä¿‚æ•¸1.14ï¼Œå„ªè‰¯ç‡72%
    } else if (industryStr.includes('å…¶ä»–') && industryStr.includes('é›»å­')) {
        industryScore = 34;  // ä¿‚æ•¸1.13ï¼Œå„ªè‰¯ç‡71%
    } else if (industryStr.includes('åŒ–å­¸')) {
        industryScore = 34;  // ä¿‚æ•¸1.12ï¼Œå„ªè‰¯ç‡71%
    } else if (industryStr.includes('é›»è…¦') || industryStr.includes('é€±é‚Š')) {
        industryScore = 34;  // ä¿‚æ•¸1.13ï¼Œå„ªè‰¯ç‡71%
    } else if (industryStr.includes('ç”ŸæŠ€') || industryStr.includes('é†«ç™‚')) {
        industryScore = 33;  // ä¿‚æ•¸1.11ï¼Œå„ªè‰¯ç‡70%ï¼ˆå¯¦è­‰ç¿»è½‰ï¼ï¼‰
    } else if (industryStr.includes('åŠå°é«”')) {
        industryScore = 32;  // ä¿‚æ•¸1.09ï¼Œå„ªè‰¯ç‡69%
    } else if (industryStr.includes('é€šä¿¡') || industryStr.includes('ç¶²è·¯')) {
        industryScore = 28;  // ä¿‚æ•¸1.04ï¼Œå„ªè‰¯ç‡66%
    } else if (industryStr.includes('é‹å‹•') || industryStr.includes('ä¼‘é–’')) {
        industryScore = 26;  // ä¿‚æ•¸1.01ï¼Œå„ªè‰¯ç‡64%
    } else if (industryStr.includes('é‹¼éµ')) {
        industryScore = 25;  // ä¿‚æ•¸1.00ï¼Œå„ªè‰¯ç‡63%ï¼ˆåŸºæº–ï¼‰
    } else if (industryStr.includes('è§€å…‰') || industryStr.includes('é¤æ—…')) {
        industryScore = 22;  // ä¿‚æ•¸0.95ï¼Œå„ªè‰¯ç‡60%
    } else if (industryStr.includes('èˆªé‹')) {
        industryScore = 21;  // ä¿‚æ•¸0.93ï¼Œå„ªè‰¯ç‡59%
    } else if (industryStr.includes('å…‰é›»')) {
        industryScore = 20;  // ä¿‚æ•¸0.91ï¼Œå„ªè‰¯ç‡58%
    } else if (industryStr.includes('é›»æ©Ÿ') || industryStr.includes('æ©Ÿæ¢°')) {
        industryScore = 20;  // ä¿‚æ•¸0.92ï¼Œå„ªè‰¯ç‡58%
    } else if (industryStr.includes('å»ºæ') || industryStr.includes('ç‡Ÿé€ ')) {
        industryScore = 19;  // ä¿‚æ•¸0.89ï¼Œå„ªè‰¯ç‡56%
    } else if (industryStr.includes('æ±½è»Š')) {
        industryScore = 16;  // ä¿‚æ•¸0.82ï¼Œå„ªè‰¯ç‡52%
    } else if (industryStr.includes('ç¶ èƒ½') || industryStr.includes('ç’°ä¿')) {
        industryScore = 15;  // ä¿‚æ•¸0.79ï¼Œå„ªè‰¯ç‡50%
    } else if (industryStr.includes('ç´¡ç¹”') || industryStr.includes('çº–ç¶­')) {
        industryScore = 13;  // ä¿‚æ•¸0.74ï¼Œå„ªè‰¯ç‡47%
    } else if (industryStr.includes('å±…å®¶') || industryStr.includes('ç”Ÿæ´»')) {
        industryScore = 8;   // ä¿‚æ•¸0.57ï¼Œå„ªè‰¯ç‡36%ï¼ˆâ˜…æœ€å·®ï¼‰
    } else {
        industryScore = 21;  // å…¶ä»–ç”¢æ¥­çµ¦åŸºæº–åˆ†
    }
    totalScore += industryScore;
    breakdown.push({ dim: 'ç”¢æ¥­é¡åˆ¥', value: industry || 'æœªæŒ‡å®š', score: industryScore, max: 35 });
    
    // 2. åˆ¸å•†è©•åˆ† (æ»¿åˆ†25) - åŸæœ¬è¢«å¿½ç•¥ï¼å„ªè‰¯ç‡å·®è·30%
    let brokerScore = 15;  // é è¨­åŸºæº–åˆ†
    const brokerStr = String(broker || '');
    // å¯¦è­‰ç™¼ç¾ï¼šçµ±ä¸€ã€å°æ–°æœ€ä½³ï¼›åœ‹ç¥¨ã€åœ‹æ³°è¼ƒå·®
    if (brokerStr.includes('çµ±ä¸€')) brokerScore = 25;         // ä¿‚æ•¸1.14ï¼Œå„ªè‰¯ç‡72.4%ï¼ˆâ˜…æœ€ä½³ï¼‰
    else if (brokerStr.includes('å°æ–°')) brokerScore = 23;    // ä¿‚æ•¸1.04ï¼Œå„ªè‰¯ç‡65.6%
    else if (brokerStr.includes('å¯Œé‚¦')) brokerScore = 19;    // ä¿‚æ•¸0.97ï¼Œå„ªè‰¯ç‡61.7%
    else if (brokerStr.includes('å‡±åŸº')) brokerScore = 19;    // ä¿‚æ•¸0.97ï¼Œå„ªè‰¯ç‡61.6%
    else if (brokerStr.includes('ä¸­ä¿¡')) brokerScore = 18;    // ä¿‚æ•¸0.96ï¼Œå„ªè‰¯ç‡60.7%
    else if (brokerStr.includes('ç¾¤ç›Š')) brokerScore = 18;    // ä¿‚æ•¸0.95ï¼Œå„ªè‰¯ç‡60.0%
    else if (brokerStr.includes('ç¦é‚¦')) brokerScore = 17;    // ä¿‚æ•¸0.93ï¼Œå„ªè‰¯ç‡58.7%
    else if (brokerStr.includes('æ°¸è±')) brokerScore = 16;    // ä¿‚æ•¸0.91ï¼Œå„ªè‰¯ç‡57.8%
    else if (brokerStr.includes('è¯å—')) brokerScore = 15;    // ä¿‚æ•¸0.88ï¼Œå„ªè‰¯ç‡56.0%
    else if (brokerStr.includes('å…ƒå¯Œ')) brokerScore = 14;    // ä¿‚æ•¸0.86ï¼Œå„ªè‰¯ç‡54.6%
    else if (brokerStr.includes('å…ƒå¤§')) brokerScore = 12;    // ä¿‚æ•¸0.83ï¼Œå„ªè‰¯ç‡52.5%
    else if (brokerStr.includes('å…†è±')) brokerScore = 11;    // ä¿‚æ•¸0.79ï¼Œå„ªè‰¯ç‡50.0%
    else if (brokerStr.includes('åˆåº«')) brokerScore = 10;    // ä¿‚æ•¸0.77ï¼Œå„ªè‰¯ç‡48.8%
    else if (brokerStr.includes('å®é ')) brokerScore = 9;     // ä¿‚æ•¸0.75ï¼Œå„ªè‰¯ç‡47.6%
    else if (brokerStr.includes('åœ‹ç¥¨')) brokerScore = 8;     // ä¿‚æ•¸0.73ï¼Œå„ªè‰¯ç‡46.0%
    else if (brokerStr.includes('åœ‹æ³°')) brokerScore = 6;     // ä¿‚æ•¸0.67ï¼Œå„ªè‰¯ç‡42.2%ï¼ˆâ˜…æœ€å·®ï¼‰
    totalScore += brokerScore;
    breakdown.push({ dim: 'æ‰¿éŠ·åˆ¸å•†', value: broker || 'æœªæŒ‡å®š', score: brokerScore, max: 25 });
    
    // 3. ä¿¡ç”¨è©•ç­‰è©•åˆ† (æ»¿åˆ†20) - é‡è¦ç™¼ç¾ï¼šTCRI 4-5æœ€ä½³ï¼Œä¸æ˜¯è¶Šä½è¶Šå¥½ï¼
    let ratingScore = 12;
    const ratingNum = parseInt(rating) || 5;
    if (ratingNum === 5) ratingScore = 20;        // â˜…æœ€ä½³ï¼šTCRI 5ï¼Œä¿‚æ•¸1.04ï¼Œå„ªè‰¯ç‡66%
    else if (ratingNum === 4) ratingScore = 19;   // å„ªè‰¯ï¼šTCRI 4ï¼Œä¿‚æ•¸1.03ï¼Œå„ªè‰¯ç‡65%
    else if (ratingNum === 6) ratingScore = 13;   // ä¸­æ€§ï¼šTCRI 6ï¼Œä¿‚æ•¸0.87ï¼Œå„ªè‰¯ç‡55%
    else if (ratingNum === 3) ratingScore = 12;   // ä¸­æ€§ï¼šTCRI 3ï¼Œä¿‚æ•¸0.85ï¼Œå„ªè‰¯ç‡54%
    else if (ratingNum === 8) ratingScore = 11;   // è­¦æˆ’ï¼šTCRI 8ï¼Œä¿‚æ•¸0.82ï¼Œå„ªè‰¯ç‡52%
    else if (ratingNum === 7) ratingScore = 8;    // â˜…æœ€å·®ï¼šTCRI 7ï¼Œä¿‚æ•¸0.69ï¼Œå„ªè‰¯ç‡44%
    else if (ratingNum <= 2) ratingScore = 12;    // TCRI 1-2ï¼šæ¨£æœ¬å°‘ï¼Œçµ¦ä¸­æ€§åˆ†
    totalScore += ratingScore;
    breakdown.push({ dim: 'ä¿¡ç”¨è©•ç­‰', value: `TCRI ${ratingNum}`, score: ratingScore, max: 20 });
    
    // 4. ç™¼è¡Œè¦æ¨¡è©•åˆ† (æ»¿åˆ†10) - å°å‹æœ€ä½³ï¼Œå¤§å‹æœ€å·®
    let sizeScore = 6;
    if (issueSize < 3) sizeScore = 10;            // ä¿‚æ•¸0.99ï¼Œå„ªè‰¯ç‡62.8%ï¼ˆâ˜…æœ€ä½³ï¼‰
    else if (issueSize < 5) sizeScore = 8;        // ä¿‚æ•¸0.94ï¼Œå„ªè‰¯ç‡59.7%
    else if (issueSize < 10) sizeScore = 9;       // ä¿‚æ•¸0.99ï¼Œå„ªè‰¯ç‡62.4%
    else if (issueSize < 20) sizeScore = 8;       // ä¿‚æ•¸0.97ï¼Œå„ªè‰¯ç‡61.3%
    else sizeScore = 5;                            // ä¿‚æ•¸0.79ï¼Œå„ªè‰¯ç‡49.7%ï¼ˆâ˜…æœ€å·®ï¼‰
    totalScore += sizeScore;
    breakdown.push({ dim: 'ç™¼è¡Œè¦æ¨¡', value: `${issueSize}å„„`, score: sizeScore, max: 10 });
    
    // 5. ç†è«–åƒ¹ä½è©•åˆ† (æ»¿åˆ†10) - ç«¶æ‹å®‰å…¨é‚Šéš›
    let theoScore = 6;
    if (theoreticalPrice < 95) theoScore = 10;          // ä¿‚æ•¸1.15ï¼Œæ¥µä½³å®‰å…¨é‚Šéš›
    else if (theoreticalPrice < 100) theoScore = 9;     // ä¿‚æ•¸1.10ï¼Œè‰¯å¥½å®‰å…¨é‚Šéš›
    else if (theoreticalPrice < 105) theoScore = 7;     // ä¿‚æ•¸1.00ï¼ŒåŸºæº–å€é–“
    else if (theoreticalPrice < 110) theoScore = 5;     // ä¿‚æ•¸0.90ï¼Œå®‰å…¨é‚Šéš›æ”¶çª„
    else if (theoreticalPrice < 115) theoScore = 3;     // ä¿‚æ•¸0.75ï¼Œè¿½åƒ¹é¢¨éšªæé«˜
    else theoScore = 2;                                  // ä¿‚æ•¸0.60ï¼Œé«˜é¢¨éšªå€é–“
    totalScore += theoScore;
    
    let theoLabel = 'é«˜é¢¨éšª';
    if (theoreticalPrice < 95) theoLabel = 'æ¥µä½³å®‰å…¨é‚Šéš›';
    else if (theoreticalPrice < 100) theoLabel = 'è‰¯å¥½å®‰å…¨é‚Šéš›';
    else if (theoreticalPrice < 105) theoLabel = 'åŸºæº–å€é–“';
    else if (theoreticalPrice < 110) theoLabel = 'å®‰å…¨é‚Šéš›æ”¶çª„';
    else if (theoreticalPrice < 115) theoLabel = 'è¿½åƒ¹é¢¨éšª';
    breakdown.push({ dim: 'ç†è«–åƒ¹ä½', value: `${theoreticalPrice}å…ƒ(${theoLabel})`, score: theoScore, max: 10 });
    
    // è¨ˆç®—ç†±åº¦ç­‰ç´šå’Œå»ºè­°èª¿æ•´ï¼ˆæ»¿åˆ†100ï¼‰
    let heatLevel, heatColor, premiumAdjust;
    if (totalScore >= 80) {
        heatLevel = 'æ¥µç†±';
        heatColor = '#d32f2f';
        premiumAdjust = 4;
    } else if (totalScore >= 65) {
        heatLevel = 'ç†±';
        heatColor = '#ff5722';
        premiumAdjust = 2;
    } else if (totalScore >= 50) {
        heatLevel = 'æ™®é€š';
        heatColor = '#ff9800';
        premiumAdjust = 0;
    } else if (totalScore >= 35) {
        heatLevel = 'å†·';
        heatColor = '#2196f3';
        premiumAdjust = -2;
    } else {
        heatLevel = 'æ¥µå†·';
        heatColor = '#1565c0';
        premiumAdjust = -3;
    }
    
    // é æœŸæŠ•æ¨™å€æ•¸ï¼ˆæ ¹æ“šç†±åº¦ä¼°ç®—ï¼‰
    let expectedMultiple = 1.5;
    if (totalScore >= 80) expectedMultiple = 4.0;
    else if (totalScore >= 65) expectedMultiple = 3.0;
    else if (totalScore >= 50) expectedMultiple = 2.2;
    else if (totalScore >= 35) expectedMultiple = 1.5;
    else expectedMultiple = 1.2;
    
    return {
        totalScore: totalScore,
        maxScore: 100,  // 100åˆ†åˆ¶
        heatLevel: heatLevel,
        heatColor: heatColor,
        premiumAdjust: premiumAdjust,
        expectedMultiple: expectedMultiple,
        breakdown: breakdown
    };
}

/**
 * v3.92 æ–°å¢ï¼šè¨ˆç®—ç†±åº¦åé›¢å’Œé¢¨éšªæé†’
 * æ¯”è¼ƒè¿‘æœŸå¸‚å ´æ°›åœèˆ‡æ­·å²å¹³å‡çš„åé›¢ç¨‹åº¦
 */
function getHeatDeviation(recentMult, historyMult) {
    if (historyMult === 0) return { pct: 0, level: 'normal', icon: 'â˜€ï¸', msg: 'è³‡æ–™ä¸è¶³' };
    const pct = ((recentMult - historyMult) / historyMult) * 100;
    
    if (pct < -20) return { pct, level: 'frozen', icon: 'â„ï¸', msg: 'å¸‚å ´æ¥µå†·ï¼Œå¯ä¿å®ˆå‡ºåƒ¹ï¼Œä½†éœ€ç•™æ„æ˜¯å¦æœ‰ç³»çµ±æ€§é¢¨éšª' };
    if (pct < -10) return { pct, level: 'cool', icon: 'ğŸŒ¤', msg: 'å¸‚å ´åå†·ï¼Œç«¶çˆ­è¼ƒç·©å’Œ' };
    if (pct <= 10) return { pct, level: 'normal', icon: 'â˜€ï¸', msg: 'å¸‚å ´æ­£å¸¸ï¼Œç¬¦åˆæ­·å²å¹³å‡' };
    if (pct <= 20) return { pct, level: 'warm', icon: 'ğŸ”¥', msg: 'å¸‚å ´åç†±ï¼Œå»ºè­°é©åº¦æé«˜å‡ºåƒ¹' };
    return { pct, level: 'hot', icon: 'ğŸ”¥ğŸ”¥', msg: 'å¸‚å ´éç†±ï¼Œæ¥è¿‘æ­·å²é«˜é»ï¼Œé¢¨éšªå ±é…¬æ¯”ä¸‹é™' };
}

// ==========================================
// v3.72 ä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹é æ¸¬æ¨¡çµ„
// ========================================
// v3.73 æ–°å¢ï¼šåŸºæ–¼${totalAuctionCount}æª”ç«¶æ‹çµ±è¨ˆçš„å®Œæ•´æŸ¥è¡¨ç³»çµ±
// æ•¸æ“šä¾†æºï¼šRexå¤§å”ç«¶æ‹è³‡æ–™åº«å®Œæ•´çµ±è¨ˆåˆ†æå ±å‘Š
// ========================================

// æŠ•æ¨™å€æ•¸ â†’ æœ€ä½å¾—æ¨™/å¹³å‡å¾—æ¨™å°ç…§è¡¨ï¼ˆæ ¸å¿ƒï¼ç›¸é—œä¿‚æ•¸+0.7301ï¼‰
// v3.75 æ”¹ç”¨ä¸­ä½æ•¸ï¼Œæ›´ç©©å¥åœ°æŠµæŠ—æ¥µç«¯å€¼ï¼ˆå¦‚å…‰è–ä¸‰123å…ƒç­‰ç•°å¸¸æ¨™çš„ï¼‰
// åˆç†å€é–“ = minPrice ~ avgPriceï¼Œå·®è·ç´„1.5-2å…ƒ
const BIDMULT_TO_PRICE_TABLE = {
    'under1': { min: 0, max: 1, minPrice: 101.00, avgPrice: 102.07, gap: 1.07, avgPremium: 7.0, count: 23 },
    '1to1.5': { min: 1, max: 1.5, minPrice: 101.00, avgPrice: 102.54, gap: 1.54, avgPremium: 4.6, count: 43 },
    '1.5to2': { min: 1.5, max: 2, minPrice: 102.66, avgPrice: 104.82, gap: 2.16, avgPremium: 6.1, count: 36 },
    '2to3': { min: 2, max: 3, minPrice: 106.10, avgPrice: 108.30, gap: 2.20, avgPremium: 8.7, count: 74 },
    '3to5': { min: 3, max: 5, minPrice: 109.91, avgPrice: 111.60, gap: 1.69, avgPremium: 10.5, count: 87 },
    'over5': { min: 5, max: 99, minPrice: 112.87, avgPrice: 114.74, gap: 1.87, avgPremium: 12.4, count: 41 }
};

// ç™¼è¡Œè¦æ¨¡ â†’ æŠ•æ¨™å€æ•¸ï¼ˆç›¸é—œä¿‚æ•¸-0.2467ï¼‰
// v3.74 æ”¹ç‚ºå‹•æ…‹è®Šæ•¸ï¼Œå¾Excelè¨ˆç®—å¾Œè¦†è“‹
// é è¨­å€¼ï¼ˆExcelæœªè¼‰å…¥æ™‚ä½¿ç”¨ï¼‰
window.SIZE_MULT_TABLE = {
    'under3': { label: '<3å„„', avgMult: 3.62, avgPrice: 107.52, count: 96 },
    '3to5': { label: '3-5å„„', avgMult: 3.02, avgPrice: 107.18, count: 68 },
    '5to10': { label: '5-10å„„', avgMult: 2.77, avgPrice: 106.81, count: 85 },
    '10to15': { label: '10-15å„„', avgMult: 2.29, avgPrice: 106.60, count: 29 },
    'over15': { label: '>15å„„', avgMult: 1.76, avgPrice: 105.23, count: 22 }
};

// å¹´æœŸ+æ“”ä¿çµ„åˆ â†’ æŠ•æ¨™å€æ•¸
window.TERM_GUAR_TABLE = {
    'æœ‰æ“”ä¿_3': { avgMult: 3.30, avgPrice: 108.65, avgPremium: 11.1, count: 82 },
    'æœ‰æ“”ä¿_5': { avgMult: 2.51, avgPrice: 108.01, avgPremium: 11.1, count: 17 },
    'ç„¡æ“”ä¿_3': { avgMult: 3.08, avgPrice: 106.39, avgPremium: 8.6, count: 152 },
    'ç„¡æ“”ä¿_5': { avgMult: 2.32, avgPrice: 105.80, avgPremium: 4.6, count: 48 }
};

// è½‰æ›åƒ¹å€¼å€é–“ â†’ æŠ•æ¨™å€æ•¸
window.CONV_VALUE_TABLE = {
    'deep_out': { label: 'æ·±åº¦åƒ¹å¤–(<90)', avgMult: 2.51, avgPrice: 105.03, count: 33 },
    'out': { label: 'åƒ¹å¤–(90-100)', avgMult: 2.74, avgPrice: 105.20, count: 155 },
    'par': { label: 'åƒ¹å¹³(100-110)', avgMult: 3.50, avgPrice: 109.41, count: 92 },
    'in': { label: 'åƒ¹å…§(110-130)', avgMult: 3.01, avgPrice: 111.23, count: 17 },
    'deep_in': { label: 'æ·±åº¦åƒ¹å…§(>130)', avgMult: 4.08, avgPrice: 122.30, count: 3 }
};

// ç”¢æ¥­ â†’ æŠ•æ¨™å€æ•¸ï¼ˆæ¨£æœ¬æ•¸â‰¥5ï¼‰
window.INDUSTRY_MULT_TABLE = {
    'é›»å™¨é›»çºœ': { avgMult: 4.57, avgPrice: 108.16, avgPremium: 11.5, count: 5 },
    'å…¶ä»–é›»å­æ¥­': { avgMult: 4.00, avgPrice: 110.35, avgPremium: 11.3, count: 20 },
    'å±…å®¶ç”Ÿæ´»': { avgMult: 3.57, avgPrice: 107.74, avgPremium: 9.6, count: 5 },
    'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­': { avgMult: 3.40, avgPrice: 106.43, avgPremium: 7.3, count: 16 },
    'é›»å­é›¶çµ„ä»¶æ¥­': { avgMult: 3.36, avgPrice: 108.93, avgPremium: 8.0, count: 43 },
    'åŠå°é«”æ¥­': { avgMult: 3.07, avgPrice: 108.60, avgPremium: 9.5, count: 21 },
    'é‹å‹•ä¼‘é–’': { avgMult: 3.05, avgPrice: 108.51, avgPremium: 9.8, count: 12 },
    'å…‰é›»æ¥­': { avgMult: 3.01, avgPrice: 107.58, avgPremium: 6.5, count: 20 },
    'é€šä¿¡ç¶²è·¯æ¥­': { avgMult: 2.86, avgPrice: 108.79, avgPremium: 10.3, count: 12 },
    'ç”ŸæŠ€é†«ç™‚æ¥­': { avgMult: 2.79, avgPrice: 105.63, avgPremium: 5.2, count: 15 },
    'é›»æ©Ÿæ©Ÿæ¢°': { avgMult: 2.74, avgPrice: 106.20, avgPremium: 8.8, count: 26 },
    'ç¶ èƒ½ç’°ä¿': { avgMult: 2.58, avgPrice: 106.00, avgPremium: 9.6, count: 10 },
    'æ±½è»Šå·¥æ¥­': { avgMult: 2.52, avgPrice: 103.33, avgPremium: 10.5, count: 9 },
    'é‹¼éµå·¥æ¥­': { avgMult: 2.18, avgPrice: 106.16, avgPremium: 18.0, count: 9 },
    'èˆªé‹æ¥­': { avgMult: 2.06, avgPrice: 102.75, avgPremium: 8.6, count: 7 },
    'å»ºæç‡Ÿé€ æ¥­': { avgMult: 1.95, avgPrice: 103.93, avgPremium: 9.5, count: 16 },
    'ç´¡ç¹”çº–ç¶­': { avgMult: 1.73, avgPrice: 102.12, avgPremium: 6.1, count: 6 }
};

// åˆ¸å•† â†’ æŠ•æ¨™å€æ•¸ï¼ˆæ¨£æœ¬æ•¸â‰¥5ï¼‰
window.BROKER_MULT_TABLE = {
    'å…†è±è­‰åˆ¸': { avgMult: 4.33, avgPrice: 109.22, avgPremium: 10.2, count: 10 },
    'ä¸­ä¿¡è­‰åˆ¸': { avgMult: 3.85, avgPrice: 109.22, avgPremium: 8.0, count: 23 },
    'å…ƒå¤§è­‰åˆ¸': { avgMult: 3.71, avgPrice: 107.85, avgPremium: 8.3, count: 22 },
    'åœ‹ç¥¨è­‰åˆ¸': { avgMult: 3.49, avgPrice: 110.78, avgPremium: 14.5, count: 12 },
    'å‡±åŸºè­‰åˆ¸': { avgMult: 3.48, avgPrice: 108.29, avgPremium: 9.9, count: 54 },
    'æ°¸è±é‡‘è­‰': { avgMult: 3.04, avgPrice: 106.17, avgPremium: 7.7, count: 13 },
    'åˆåº«è­‰åˆ¸': { avgMult: 2.92, avgPrice: 105.52, avgPremium: 12.6, count: 9 },
    'çµ±ä¸€è­‰åˆ¸': { avgMult: 2.77, avgPrice: 106.44, avgPremium: 6.5, count: 11 },
    'ç¦é‚¦è­‰åˆ¸': { avgMult: 2.71, avgPrice: 104.87, avgPremium: 5.7, count: 15 },
    'å°æ–°è­‰åˆ¸': { avgMult: 2.59, avgPrice: 106.31, avgPremium: 7.0, count: 41 },
    'å¯Œé‚¦è­‰åˆ¸': { avgMult: 2.57, avgPrice: 107.01, avgPremium: 10.9, count: 41 },
    'ç¬¬ä¸€é‡‘è­‰': { avgMult: 2.40, avgPrice: 106.35, avgPremium: 9.7, count: 9 },
    'åœ‹æ³°è­‰åˆ¸': { avgMult: 2.06, avgPrice: 104.86, avgPremium: 6.5, count: 5 },
    'å®é è­‰åˆ¸': { avgMult: 1.97, avgPrice: 103.43, avgPremium: 1.8, count: 6 },
    'ç¾¤ç›Šè­‰åˆ¸': { avgMult: 1.95, avgPrice: 104.18, avgPremium: 4.7, count: 9 }
};

// æ•´é«”çµ±è¨ˆæ•¸æ“š
window.OVERALL_STATS = {
    avgBidMult: 2.98,
    medianBidMult: 2.69,
    avgMinBid: 106.99,
    medianMinBid: 106.10,
    avgTheoretical: 98.86,
    avgPremium: 8.73,
    avgQualified: 474,
    avgBidShares: 34.5,
    get totalSamples() { return totalAuctionCount || 300; }  // v3.81 å‹•æ…‹å–å€¼
};

// ä¿¡è©•ç­‰ç´š â†’ æŠ•æ¨™å€æ•¸
window.RATING_MULT_TABLE = {
    '1': { avgMult: 1.34, avgPrice: 100.00, avgShares: 114.3, count: 1 },
    '2': { avgMult: 1.34, avgPrice: 100.00, avgShares: 114.3, count: 1 },
    '3': { avgMult: 2.63, avgPrice: 109.75, avgShares: 55.4, count: 6 },
    '4': { avgMult: 2.76, avgPrice: 105.71, avgShares: 41.2, count: 39 },
    '5': { avgMult: 3.56, avgPrice: 108.32, avgShares: 34.1, count: 60 },
    '6': { avgMult: 2.95, avgPrice: 106.74, avgShares: 32.1, count: 108 },
    '7': { avgMult: 2.74, avgPrice: 106.66, avgShares: 32.4, count: 55 },
    '8': { avgMult: 2.65, avgPrice: 106.10, avgShares: 30.7, count: 22 },
    '9': { avgMult: 3.27, avgPrice: 110.20, avgShares: 33.2, count: 7 }
};

// å¹´åº¦çµ±è¨ˆ
window.YEAR_STATS_TABLE = {
    '2019': { count: 5, avgMult: 2.52, avgPrice: 103.89, avgPremium: 6.8 },
    '2020': { count: 25, avgMult: 2.36, avgPrice: 104.11, avgPremium: 4.6 },
    '2021': { count: 48, avgMult: 3.17, avgPrice: 108.05, avgPremium: 9.8 },
    '2022': { count: 51, avgMult: 2.77, avgPrice: 106.11, avgPremium: 9.7 },
    '2023': { count: 44, avgMult: 3.14, avgPrice: 107.00, avgPremium: 7.2 },
    '2024': { count: 75, avgMult: 3.49, avgPrice: 109.88, avgPremium: 11.8 },
    '2025': { count: 52, avgMult: 2.46, avgPrice: 104.35, avgPremium: 5.9 }
};

// ========================================
// v3.73 æ™ºæ…§æç¤ºç³»çµ±
// åœ¨å„è¼¸å…¥æ¬„ä½æ—å³æ™‚é¡¯ç¤ºæ­·å²çµ±è¨ˆæç¤º
// ========================================

/**
 * é¡¯ç¤ºç”¢æ¥­çµ±è¨ˆæç¤ºï¼ˆè¿½åŠ åˆ°åŸæœ‰çµ±è¨ˆå¡ç‰‡ä¸‹æ–¹ï¼‰
 */
function showIndustryTip(industry) {
    const tipBox = document.getElementById('industryTip300');
    if (!tipBox) return;
    
    // å˜—è©¦åŒ¹é…ç”¢æ¥­åç¨±ï¼ˆç§»é™¤æ‹¬è™Ÿå¾Œç¶´ï¼‰
    const indName = industry ? industry.split(' ')[0] : '';
    const data = window.INDUSTRY_MULT_TABLE[indName];
    
    if (!data) {
        tipBox.style.display = 'none';
        return;
    }
    
    const heatLevel = data.avgMult >= 3.5 ? 'ğŸ”¥ç†±é–€' : (data.avgMult >= 2.5 ? 'âš¡ä¸€èˆ¬' : 'â„ï¸å†·é–€');
    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
    
    tipBox.innerHTML = `
        <div class="tip-title">
            <span style="color:${heatColor};">${heatLevel}</span> 
            ğŸ“Š ${totalAuctionCount}æª”çµ±è¨ˆï¼š${indName}ï¼ˆ${data.count}æª”ï¼‰
        </div>
        <div class="tip-stats">
            <span>æŠ•æ¨™å€æ•¸ï¼š<b style="color:#6366f1;">${data.avgMult.toFixed(2)}x</b></span>
            <span>å¹³å‡å¾—æ¨™ï¼š<b style="color:#059669;">${data.avgPrice.toFixed(1)}å…ƒ</b></span>
            <span>å¹³å‡æº¢åƒ¹ï¼š<b>${data.avgPremium.toFixed(1)}%</b></span>
        </div>
    `;
    tipBox.style.display = 'block';
}

/**
 * é¡¯ç¤ºåˆ¸å•†çµ±è¨ˆæç¤ºï¼ˆè¿½åŠ åˆ°åŸæœ‰çµ±è¨ˆå¡ç‰‡ä¸‹æ–¹ï¼‰
 */
function showBrokerTip(broker) {
    const tipBox = document.getElementById('brokerTip300');
    if (!tipBox) return;
    
    // å˜—è©¦åŒ¹é…åˆ¸å•†åç¨±
    const brokerName = broker ? broker.split(' ')[0] : '';
    let data = window.BROKER_MULT_TABLE[brokerName];
    if (!data) {
        for (const [name, d] of Object.entries(window.BROKER_MULT_TABLE)) {
            if (brokerName.includes(name.replace('è­‰åˆ¸', '')) || name.includes(brokerName.replace('è­‰åˆ¸', ''))) {
                data = d;
                break;
            }
        }
    }
    
    if (!data) {
        tipBox.style.display = 'none';
        return;
    }
    
    const heatLevel = data.avgMult >= 3.5 ? 'ğŸ”¥é«˜ç†±åº¦' : (data.avgMult >= 2.5 ? 'âš¡ä¸­ç†±åº¦' : 'â„ï¸ä½ç†±åº¦');
    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
    
    tipBox.innerHTML = `
        <div class="tip-title">
            <span style="color:${heatColor};">${heatLevel}</span> 
            ğŸ¦ ${totalAuctionCount}æª”çµ±è¨ˆï¼š${brokerName}ï¼ˆ${data.count}æª”ï¼‰
        </div>
        <div class="tip-stats">
            <span>æŠ•æ¨™å€æ•¸ï¼š<b style="color:#6366f1;">${data.avgMult.toFixed(2)}x</b></span>
            <span>å¹³å‡å¾—æ¨™ï¼š<b style="color:#059669;">${data.avgPrice.toFixed(1)}å…ƒ</b></span>
            <span>å¹³å‡æº¢åƒ¹ï¼š<b>${data.avgPremium.toFixed(1)}%</b></span>
        </div>
    `;
    tipBox.style.display = 'block';
}

/**
 * é¡¯ç¤ºç™¼è¡Œè¦æ¨¡çµ±è¨ˆæç¤ºï¼ˆè¿½åŠ åˆ°åŸæœ‰çµ±è¨ˆå¡ç‰‡ä¸‹æ–¹ï¼‰
 */
function showSizeTip(sizeRange) {
    const tipBox = document.getElementById('issueSizeTip300');
    if (!tipBox) return;
    
    // æ˜ å°„é¸é …å€¼åˆ°çµ±è¨ˆè¡¨key
    const sizeMap = {
        'å°æ–¼2å„„': 'under3',
        '2~5å„„': '3to5',
        '5~10å„„': '5to10',
        '10~15å„„': '10to15',
        '15~20å„„': 'over15',
        'å¤§æ–¼20å„„': 'over15'
    };
    
    const key = sizeMap[sizeRange];
    const data = key ? window.SIZE_MULT_TABLE[key] : null;
    
    if (!data) {
        tipBox.style.display = 'none';
        return;
    }
    
    const heatLevel = data.avgMult >= 3.5 ? 'ğŸ”¥ç«¶çˆ­æ¿€çƒˆ' : (data.avgMult >= 2.5 ? 'âš¡é©ä¸­ç«¶çˆ­' : 'â„ï¸ç«¶çˆ­è¼ƒä½');
    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
    
    // é¡å¤–æç¤º
    let tip = '';
    if (data.avgMult >= 3.5) {
        tip = '<span style="color:#dc2626;">ğŸ’¡ å°è¦æ¨¡CBç«¶çˆ­æ¿€çƒˆï¼Œå»ºè­°å‡ºåƒ¹ä¿å®ˆ</span>';
    } else if (data.avgMult < 2) {
        tip = '<span style="color:#16a34a;">ğŸ’¡ å¤§è¦æ¨¡CBç«¶çˆ­è¼ƒä½ï¼Œæœ‰æ©Ÿæœƒä½åƒ¹å¾—æ¨™</span>';
    }
    
    tipBox.innerHTML = `
        <div class="tip-title">
            <span style="color:${heatColor};">${heatLevel}</span> 
            ğŸ“¦ ${totalAuctionCount}æª”çµ±è¨ˆï¼š${data.label}ï¼ˆ${data.count}æª”ï¼Œä½”${(data.count/totalAuctionCount*100).toFixed(1)}%ï¼‰
        </div>
        <div class="tip-stats">
            <span>æŠ•æ¨™å€æ•¸ï¼š<b style="color:#6366f1;">${data.avgMult.toFixed(2)}x</b></span>
            <span>å¹³å‡å¾—æ¨™ï¼š<b style="color:#059669;">${data.avgPrice.toFixed(1)}å…ƒ</b></span>
        </div>
        ${tip ? `<div style="margin-top:4px;">${tip}</div>` : ''}
    `;
    tipBox.style.display = 'block';
}

/**
 * é¡¯ç¤ºå¹´æœŸ+æ“”ä¿çµ„åˆçµ±è¨ˆæç¤ºï¼ˆè¿½åŠ åˆ°åŸæœ‰çµ±è¨ˆå¡ç‰‡ä¸‹æ–¹ï¼‰
 */
function showTermGuaranteeTip() {
    const years = document.getElementById('years')?.value;
    const guarantee = document.getElementById('guarantee')?.value;
    
    // æ›´æ–°å¹´æœŸæç¤º
    const yearsTipBox = document.getElementById('yearsTip300');
    if (yearsTipBox && years) {
        const yearData = {
            '3': { label: '3å¹´æœŸ', pct: 78.0, avgMult: 3.15, avgPrice: 107.18, avgPremium: 9.4 },
            '5': { label: '5å¹´æœŸ', pct: 21.7, avgMult: 2.37, avgPrice: 106.38, avgPremium: 6.3 },
            '7': { label: '7å¹´æœŸ', pct: 0.3, avgMult: 1.00, avgPrice: 100.00, avgPremium: 1.9 }
        }[years];
        
        if (yearData) {
            const heatColor = yearData.avgMult >= 3 ? '#ef4444' : (yearData.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            yearsTipBox.innerHTML = `
                <div class="tip-title">ğŸ“… ${totalAuctionCount}æª”çµ±è¨ˆï¼š${yearData.label}ï¼ˆä½”${yearData.pct}%ï¼‰</div>
                <div class="tip-stats">
                    <span>æŠ•æ¨™å€æ•¸ï¼š<b style="color:${heatColor};">${yearData.avgMult.toFixed(2)}x</b></span>
                    <span>å¹³å‡å¾—æ¨™ï¼š<b>${yearData.avgPrice.toFixed(1)}å…ƒ</b></span>
                    <span>å¹³å‡æº¢åƒ¹ï¼š<b>${yearData.avgPremium.toFixed(1)}%</b></span>
                </div>
            `;
            yearsTipBox.style.display = 'block';
        }
    } else if (yearsTipBox) {
        yearsTipBox.style.display = 'none';
    }
    
    // æ›´æ–°æ“”ä¿æç¤º
    const guarTipBox = document.getElementById('guaranteeTip300');
    if (guarTipBox && guarantee) {
        const guarData = {
            'æœ‰æ“”ä¿': { pct: 33.0, avgMult: 3.16, avgPrice: 108.54, avgPremium: 11.1 },
            'ç„¡æ“”ä¿': { pct: 67.0, avgMult: 2.88, avgPrice: 106.22, avgPremium: 7.6 }
        }[guarantee];
        
        if (guarData) {
            const heatColor = guarData.avgMult >= 3 ? '#ef4444' : '#eab308';
            
            // å¦‚æœå¹´æœŸå’Œæ“”ä¿éƒ½æœ‰é¸æ“‡ï¼Œé¡¯ç¤ºçµ„åˆçµ±è¨ˆ
            if (years && guarantee) {
                const comboKey = `${guarantee}_${years}`;
                const comboData = window.TERM_GUAR_TABLE[comboKey];
                
                if (comboData) {
                    const comboColor = comboData.avgMult >= 3 ? '#ef4444' : (comboData.avgMult >= 2.5 ? '#eab308' : '#22c55e');
                    guarTipBox.innerHTML = `
                        <div class="tip-title">
                            <span style="color:${comboColor};">ğŸ¯ ${totalAuctionCount}æª”çµ±è¨ˆï¼š${guarantee}+${years}å¹´çµ„åˆ</span>ï¼ˆ${comboData.count}æª”ï¼‰
                        </div>
                        <div class="tip-stats">
                            <span>æŠ•æ¨™å€æ•¸ï¼š<b style="color:#6366f1;">${comboData.avgMult.toFixed(2)}x</b></span>
                            <span>å¹³å‡å¾—æ¨™ï¼š<b style="color:#059669;">${comboData.avgPrice.toFixed(1)}å…ƒ</b></span>
                            <span>å¹³å‡æº¢åƒ¹ï¼š<b>${comboData.avgPremium.toFixed(1)}%</b></span>
                        </div>
                    `;
                    guarTipBox.style.display = 'block';
                    return;
                }
            }
            
            // åªæœ‰æ“”ä¿
            guarTipBox.innerHTML = `
                <div class="tip-title">ğŸ›¡ï¸ ${totalAuctionCount}æª”çµ±è¨ˆï¼š${guarantee}ï¼ˆä½”${guarData.pct}%ï¼‰</div>
                <div class="tip-stats">
                    <span>æŠ•æ¨™å€æ•¸ï¼š<b style="color:${heatColor};">${guarData.avgMult.toFixed(2)}x</b></span>
                    <span>å¹³å‡æº¢åƒ¹ï¼š<b>${guarData.avgPremium.toFixed(1)}%</b></span>
                </div>
            `;
            guarTipBox.style.display = 'block';
        }
    } else if (guarTipBox) {
        guarTipBox.style.display = 'none';
    }
}

/**
 * é¡¯ç¤ºç†è«–åƒ¹å€é–“çµ±è¨ˆæç¤ºï¼ˆè¿½åŠ åˆ°åŸæœ‰çµ±è¨ˆå¡ç‰‡ä¸‹æ–¹ï¼‰
 */
function showTheoPriceTip(theoRange) {
    const tipBox = document.getElementById('theoRangeTip300');
    if (!tipBox) return;
    
    // æ˜ å°„é¸é …å€¼åˆ°çµ±è¨ˆè¡¨key
    const theoMap = {
        'å°æ–¼90å…ƒ': 'deep_out',
        '90~95å…ƒ': 'out',
        '95~100å…ƒ': 'out',
        '100~105å…ƒ': 'par',
        '105~110å…ƒ': 'par',
        '110~115å…ƒ': 'in',
        'å¤§æ–¼115å…ƒ': 'deep_in'
    };
    
    const key = theoMap[theoRange];
    const data = key ? window.CONV_VALUE_TABLE[key] : null;
    
    if (!data) {
        tipBox.style.display = 'none';
        return;
    }
    
    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
    
    // é¡å¤–èªªæ˜
    let explanation = '';
    if (key === 'deep_out') {
        explanation = '<span style="color:#9333ea;">æ·±åº¦åƒ¹å¤–ï¼šè½‰æ›åƒ¹å€¼ä½ï¼ŒCBè¼ƒä¸å…·è½‰æ›å¸å¼•åŠ›</span>';
    } else if (key === 'out') {
        explanation = '<span style="color:#2563eb;">åƒ¹å¤–ï¼šæ¥è¿‘è½‰æ›åƒ¹å€¼ï¼Œæœ‰æ½›åœ¨è½‰æ›æ©Ÿæœƒ</span>';
    } else if (key === 'par') {
        explanation = '<span style="color:#dc2626;">ğŸ”¥ åƒ¹å¹³å€é–“ï¼šæŠ•æ¨™æœ€ç†±çµ¡ï¼Œç«¶çˆ­æ¿€çƒˆï¼</span>';
    } else if (key === 'in' || key === 'deep_in') {
        explanation = '<span style="color:#16a34a;">åƒ¹å…§ï¼šå…·æœ‰è½‰æ›åƒ¹å€¼ï¼Œå¾—æ¨™åƒ¹é€šå¸¸è¼ƒé«˜</span>';
    }
    
    tipBox.innerHTML = `
        <div class="tip-title">ğŸ“ˆ ${totalAuctionCount}æª”çµ±è¨ˆï¼š${data.label}ï¼ˆ${data.count}æª”ï¼Œä½”${(data.count/totalAuctionCount*100).toFixed(1)}%ï¼‰</div>
        <div class="tip-stats">
            <span>æŠ•æ¨™å€æ•¸ï¼š<b style="color:${heatColor};">${data.avgMult.toFixed(2)}x</b></span>
            <span>å¹³å‡å¾—æ¨™ï¼š<b style="color:#059669;">${data.avgPrice.toFixed(1)}å…ƒ</b></span>
        </div>
        <div style="margin-top:4px;">${explanation}</div>
    `;
    tipBox.style.display = 'block';
}

/**
 * é¡¯ç¤ºä¿¡è©•çµ±è¨ˆæç¤ºï¼ˆè¿½åŠ åˆ°åŸæœ‰çµ±è¨ˆå¡ç‰‡ä¸‹æ–¹ï¼‰
 */
function showRatingTip(rating) {
    const tipBox = document.getElementById('ratingTip300');
    if (!tipBox) return;
    
    const data = window.RATING_MULT_TABLE[rating];
    if (!data || data.count < 3) {
        if (data && data.count < 3) {
            tipBox.innerHTML = `<div class="tip-title" style="color:#d97706;">âš ï¸ TCRI ${rating} æ¨£æœ¬æ•¸éå°‘ï¼ˆ${data.count}æª”ï¼‰ï¼Œåƒè€ƒåƒ¹å€¼æœ‰é™</div>`;
            tipBox.style.display = 'block';
        } else {
            tipBox.style.display = 'none';
        }
        return;
    }
    
    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
    
    // ä¿¡è©•åˆ†é¡èªªæ˜
    let riskLevel = '';
    let riskColor = '#666';
    if (parseInt(rating) <= 4) {
        riskLevel = 'å„ªè³ªï¼ˆä½é¢¨éšªï¼‰';
        riskColor = '#16a34a';
    } else if (parseInt(rating) <= 6) {
        riskLevel = 'é¢¨éšªé©ä¸­';
        riskColor = '#eab308';
    } else {
        riskLevel = 'é«˜é¢¨éšª';
        riskColor = '#dc2626';
    }
    
    tipBox.innerHTML = `
        <div class="tip-title">
            â­ ${totalAuctionCount}æª”çµ±è¨ˆï¼šTCRI ${rating} - <span style="color:${riskColor};">${riskLevel}</span>ï¼ˆ${data.count}æª”ï¼Œä½”${(data.count/totalAuctionCount*100).toFixed(1)}%ï¼‰
        </div>
        <div class="tip-stats">
            <span>æŠ•æ¨™å€æ•¸ï¼š<b style="color:${heatColor};">${data.avgMult.toFixed(2)}x</b></span>
            <span>å¹³å‡å¾—æ¨™ï¼š<b style="color:#059669;">${data.avgPrice.toFixed(1)}å…ƒ</b></span>
            <span>å¹³å‡æŠ•æ¨™å¼µæ•¸ï¼š<b>${data.avgShares.toFixed(1)}å¼µ</b></span>
        </div>
        <div style="margin-top:4px; color:#7c3aed;">
            ğŸ’¡ ä¿¡è©•èˆ‡æŠ•æ¨™å€æ•¸ç›¸é—œæ€§æ¥µä½ï¼ˆr=-0.04ï¼‰ï¼Œä¿¡è©•éæŠ•æ¨™ç†±åº¦æ±ºå®šå› ç´ 
        </div>
    `;
    tipBox.style.display = 'block';
}

/**
 * åˆå§‹åŒ–æ™ºæ…§æç¤ºäº‹ä»¶ç›£è½
 */
function initSmartTips() {
    // ç”¢æ¥­é¸æ“‡
    const industrySelect = document.getElementById('industry');
    if (industrySelect) {
        industrySelect.addEventListener('change', function() {
            showIndustryTip(this.value);
        });
    }
    
    // åˆ¸å•†é¸æ“‡
    const brokerSelect = document.getElementById('broker');
    if (brokerSelect) {
        brokerSelect.addEventListener('change', function() {
            showBrokerTip(this.value);
        });
    }
    
    // ç™¼è¡Œè¦æ¨¡é¸æ“‡
    const sizeSelect = document.getElementById('issueSize');
    if (sizeSelect) {
        sizeSelect.addEventListener('change', function() {
            showSizeTip(this.value);
        });
    }
    
    // å¹´æœŸé¸æ“‡
    const yearsSelect = document.getElementById('years');
    if (yearsSelect) {
        yearsSelect.addEventListener('change', function() {
            showTermGuaranteeTip();
        });
    }
    
    // æ“”ä¿é¸æ“‡
    const guaranteeSelect = document.getElementById('guarantee');
    if (guaranteeSelect) {
        guaranteeSelect.addEventListener('change', function() {
            showTermGuaranteeTip();
        });
    }
    
    // ç†è«–åƒ¹å€é–“é¸æ“‡
    const theoSelect = document.getElementById('theoRange');
    if (theoSelect) {
        theoSelect.addEventListener('change', function() {
            showTheoPriceTip(this.value);
        });
    }
    
    // ä¿¡è©•é¸æ“‡
    const ratingSelect = document.getElementById('rating');
    if (ratingSelect) {
        ratingSelect.addEventListener('change', function() {
            showRatingTip(this.value);
        });
    }
    
    console.log('âœ… æ™ºæ…§æç¤ºç³»çµ±åˆå§‹åŒ–å®Œæˆ');
}

/**
 * v3.73 ç”Ÿæˆæ¢ä»¶çµ±è¨ˆæ‘˜è¦HTML
 * åœ¨è©•ä¼°çµæœä¸­é¡¯ç¤ºæ‰€é¸æ¢ä»¶çš„æ­·å²çµ±è¨ˆ
 */
function generateConditionSummaryHTML(r) {
    if (!r) return '';
    
    let items = [];
    
    // 1. ç™¼è¡Œè¦æ¨¡çµ±è¨ˆ
    if (r.issueSize) {
        const sizeMap = {
            'å°æ–¼2å„„': 'under3', '2~5å„„': '3to5', '5~10å„„': '5to10',
            '10~15å„„': '10to15', '15~20å„„': 'over15', 'å¤§æ–¼20å„„': 'over15'
        };
        const key = sizeMap[r.issueSize];
        const data = key ? window.SIZE_MULT_TABLE[key] : null;
        if (data) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: 'ğŸ“¦',
                label: 'ç™¼è¡Œè¦æ¨¡',
                value: data.label,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}å…ƒ`,
                color: heatColor,
                count: data.count,
                tip: data.avgMult >= 3.5 ? 'ç«¶çˆ­æ¿€çƒˆ' : (data.avgMult < 2 ? 'ç«¶çˆ­è¼ƒä½' : 'é©ä¸­')
            });
        }
    }
    
    // 2. å¹´æœŸ+æ“”ä¿çµ„åˆ
    if (r.years && r.guarantee) {
        const comboKey = `${r.guarantee}_${r.years}`;
        const data = window.TERM_GUAR_TABLE[comboKey];
        if (data) {
            const heatColor = data.avgMult >= 3 ? '#ef4444' : '#eab308';
            items.push({
                icon: 'ğŸ›¡ï¸',
                label: 'å¹´æœŸæ“”ä¿',
                value: `${r.guarantee}+${r.years}å¹´`,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}å…ƒ`,
                color: heatColor,
                count: data.count,
                tip: `æº¢åƒ¹${data.avgPremium.toFixed(1)}%`
            });
        }
    }
    
    // 3. ç†è«–åƒ¹å€é–“
    if (r.theoRange || r.theoreticalPrice) {
        const theoMap = {
            'å°æ–¼90å…ƒ': 'deep_out', '90~95å…ƒ': 'out', '95~100å…ƒ': 'out',
            '100~105å…ƒ': 'par', '105~110å…ƒ': 'par', '110~115å…ƒ': 'in', 'å¤§æ–¼115å…ƒ': 'deep_in'
        };
        let key = theoMap[r.theoRange];
        if (!key && r.theoreticalPrice) {
            const tp = parseFloat(r.theoreticalPrice);
            if (tp < 90) key = 'deep_out';
            else if (tp < 100) key = 'out';
            else if (tp < 110) key = 'par';
            else if (tp < 130) key = 'in';
            else key = 'deep_in';
        }
        const data = key ? window.CONV_VALUE_TABLE[key] : null;
        if (data) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: 'ğŸ“ˆ',
                label: 'è½‰æ›åƒ¹å€¼',
                value: data.label,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}å…ƒ`,
                color: heatColor,
                count: data.count,
                tip: key === 'par' ? 'æœ€ç†±é–€å€é–“' : ''
            });
        }
    }
    
    // 4. ç”¢æ¥­çµ±è¨ˆ
    if (r.industry) {
        const indName = r.industry.split(' ')[0]; // ç§»é™¤ (n) å¾Œç¶´
        const data = window.INDUSTRY_MULT_TABLE[indName];
        if (data) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: 'ğŸ­',
                label: 'ç”¢æ¥­',
                value: indName,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}å…ƒ`,
                color: heatColor,
                count: data.count,
                tip: data.avgMult >= 3.5 ? 'ç†±é–€ç”¢æ¥­' : (data.avgMult < 2 ? 'å†·é–€ç”¢æ¥­' : '')
            });
        }
    }
    
    // 5. åˆ¸å•†çµ±è¨ˆ
    if (r.broker) {
        const brokerName = r.broker.split(' ')[0];
        let data = window.BROKER_MULT_TABLE[brokerName];
        if (!data) {
            for (const [name, d] of Object.entries(window.BROKER_MULT_TABLE)) {
                if (brokerName.includes(name.replace('è­‰åˆ¸', '')) || name.includes(brokerName.replace('è­‰åˆ¸', ''))) {
                    data = d;
                    break;
                }
            }
        }
        if (data) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: 'ğŸ¦',
                label: 'åˆ¸å•†',
                value: brokerName,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}å…ƒ`,
                color: heatColor,
                count: data.count,
                tip: ''
            });
        }
    }
    
    // 6. ä¿¡è©•çµ±è¨ˆ
    if (r.rating) {
        const data = window.RATING_MULT_TABLE[r.rating];
        if (data && data.count >= 3) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: 'â­',
                label: 'ä¿¡è©•',
                value: `TCRI ${r.rating}`,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}å…ƒ`,
                color: heatColor,
                count: data.count,
                tip: parseInt(r.rating) <= 4 ? 'å„ªè³ª' : (parseInt(r.rating) >= 7 ? 'é«˜é¢¨éšª' : '')
            });
        }
    }
    
    if (items.length === 0) return '';
    
    // è¨ˆç®—ç¶œåˆé ä¼°
    let totalMult = 0;
    let totalWeight = 0;
    items.forEach(item => {
        const mult = parseFloat(item.stats.split('x')[0]);
        if (mult > 0) {
            totalMult += mult;
            totalWeight++;
        }
    });
    const avgMult = totalWeight > 0 ? (totalMult / totalWeight) : 2.98;
    const heatLevel = avgMult >= 3.5 ? 'ğŸ”¥ç†±é–€' : (avgMult >= 2.5 ? 'âš¡ä¸€èˆ¬' : 'â„ï¸å†·é–€');
    const heatColor = avgMult >= 3.5 ? '#ef4444' : (avgMult >= 2.5 ? '#eab308' : '#22c55e');
    
    // ç”ŸæˆHTML
    const itemsHTML = items.map(item => `
        <div style="display:flex; align-items:center; padding:8px 12px; background:#f8fafc; border-radius:6px; gap:10px;">
            <span style="font-size:18px;">${item.icon}</span>
            <div style="flex:1;">
                <div style="font-size:11px; color:#999;">${item.label}</div>
                <div style="font-weight:bold; color:#333;">${item.value}</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:12px; color:${item.color}; font-weight:bold;">${item.stats}</div>
                <div style="font-size:10px; color:#999;">${item.count}æª”${item.tip ? ' Â· ' + item.tip : ''}</div>
            </div>
        </div>
    `).join('');
    
    return `
    <div class="result-card" style="background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border:2px solid #94a3b8;">
        <h3 style="color:#334155; border-bottom:2px solid #94a3b8;">
            ğŸ“Š æ¢ä»¶çµ±è¨ˆæ‘˜è¦
            <span style="float:right; font-size:14px; font-weight:normal; background:${heatColor}; color:white; padding:3px 12px; border-radius:12px;">
                ${heatLevel} é ä¼° ${avgMult.toFixed(2)}x
            </span>
        </h3>
        <div style="padding:5px 0 10px;">
            <div style="font-size:12px; color:#64748b; margin-bottom:12px;">
                ğŸ’¡ ä»¥ä¸‹ç‚ºæ‚¨æ‰€é¸æ¢ä»¶åœ¨${totalAuctionCount}æª”æ­·å²ç«¶æ‹ä¸­çš„çµ±è¨ˆæ•¸æ“šï¼ˆå€æ•¸/å¾—æ¨™åƒ¹ï¼‰
            </div>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                ${itemsHTML}
            </div>
            <div style="margin-top:15px; padding:10px; background:#fffbeb; border-radius:8px; border-left:4px solid #f59e0b;">
                <div style="font-size:12px; color:#92400e;">
                    <b>ğŸ“Œ è§£è®€æç¤ºï¼š</b>
                    æŠ•æ¨™å€æ•¸èˆ‡æœ€ä½å¾—æ¨™å¼·æ­£ç›¸é—œï¼ˆr=+0.73ï¼‰ï¼Œå€æ•¸æ¯å¢åŠ 1å€ï¼Œå¾—æ¨™ç´„å¢åŠ 2-3å…ƒã€‚
                    ${avgMult >= 3.5 ? 'æœ¬æ¡ˆæ¢ä»¶è¼ƒç†±é–€ï¼Œå»ºè­°å‡ºåƒ¹ä¿å®ˆäº›ä»¥æ§åˆ¶æˆæœ¬ã€‚' : 
                      avgMult < 2 ? 'æœ¬æ¡ˆæ¢ä»¶è¼ƒå†·é–€ï¼Œæœ‰æ©Ÿæœƒä»¥è¼ƒä½åƒ¹å¾—æ¨™ã€‚' : 
                      'æœ¬æ¡ˆæ¢ä»¶ç«¶çˆ­é©ä¸­ï¼Œå¯åƒè€ƒå¹³è¡¡å‹å‡ºåƒ¹ç­–ç•¥ã€‚'}
                </div>
            </div>
        </div>
    </div>`;
}

// ==========================================
// v3.74 å‹•æ…‹å¸‚å ´å›é¥‹åŠŸèƒ½
// ==========================================

// å…¨å±€è®Šæ•¸ï¼šå„²å­˜å¸‚å ´å‹•èƒ½èª¿æ•´ä¿‚æ•¸
window.marketMomentum = {
    adjustment: 0,          // å€æ•¸èª¿æ•´å€¼ï¼ˆæ­£æ•¸=å¸‚å ´åç†±ï¼Œè² æ•¸=å¸‚å ´åå†·ï¼‰
    priceAdjustment: 0,     // åƒ¹æ ¼èª¿æ•´å€¼
    trend: 'ä¸­æ€§',           // è¶¨å‹¢æè¿°
    sampleCount: 0,         // æ¨£æœ¬æ•¸
    lastUpdated: null,      // æœ€å¾Œæ›´æ–°æ™‚é–“
    details: []             // è©³ç´°è³‡æ–™
};

/**
 * v3.74 æ”¹é€²ï¼šè‡ªå‹•å¾Excelè¨ˆç®—å¸‚å ´å‹•èƒ½
 * å¾04å·¥ä½œè¡¨æŠ“å–æœ€è¿‘Næª”é–‹æ¨™çµæœï¼Œè‡ªå‹•è¨ˆç®—å¸‚å ´æ°›åœ
 */
function calculateMarketMomentum() {
    const resultDiv = document.getElementById('marketMomentumResult');
    const detailsDiv = document.getElementById('recentAuctionDetails');
    
    // å¾window.recentAuctionDataå–å¾—è³‡æ–™ï¼ˆåœ¨loadStatisticsä¸­å·²å»ºç«‹ï¼‰
    const validData = window.recentAuctionData || [];
    
    if (validData.length === 0) {
        resultDiv.innerHTML = `
            <div style="background:#fff3cd; padding:10px; border-radius:6px; color:#856404; font-size:12px;">
                âš ï¸ å°šæœªè¼‰å…¥è¿‘æœŸç«¶æ‹è³‡æ–™ï¼Œè«‹ç¢ºèªExcelæª”æ¡ˆå·²è¼‰å…¥
            </div>`;
        return;
    }
    
    // è¨ˆç®—èˆ‡æ­·å²å¹³å‡çš„å·®ç•°
    const historyAvgMult = window.OVERALL_STATS.avgBidMult || 2.98;
    const historyAvgPrice = window.OVERALL_STATS.avgMinBid || 106.99;
    
    let totalMultDiff = 0;
    let totalPriceDiff = 0;
    let details = [];
    
    validData.forEach(d => {
        const multDiff = (d.mult - historyAvgMult) / historyAvgMult; // ç™¾åˆ†æ¯”å·®ç•°
        const priceDiff = d.price > 0 ? (d.price - historyAvgPrice) : 0;
        
        totalMultDiff += multDiff;
        if (d.price > 0) totalPriceDiff += priceDiff;
        
        details.push({
            name: d.name || 'æœªå‘½å',
            date: d.date,
            mult: d.mult,
            price: d.price,
            multDiff: multDiff,
            multDiffPct: (multDiff * 100).toFixed(1)
        });
    });
    
    const avgMultDiff = totalMultDiff / validData.length;
    const avgPriceDiff = totalPriceDiff / validData.filter(d => d.price > 0).length || 0;
    const recentAvgMult = validData.reduce((s, d) => s + d.mult, 0) / validData.length;
    
    // åˆ¤æ–·è¶¨å‹¢
    let trend = 'ä¸­æ€§';
    let trendColor = '#666';
    let trendIcon = 'ğŸ˜';
    
    if (avgMultDiff > 0.3) { trend = 'éå¸¸ç†±çµ¡'; trendColor = '#dc2626'; trendIcon = 'ğŸ”¥ğŸ”¥'; }
    else if (avgMultDiff > 0.15) { trend = 'åç†±'; trendColor = '#ea580c'; trendIcon = 'ğŸ”¥'; }
    else if (avgMultDiff > 0.05) { trend = 'ç•¥åç†±'; trendColor = '#f59e0b'; trendIcon = 'â¬†ï¸'; }
    else if (avgMultDiff < -0.3) { trend = 'éå¸¸å†·æ¸…'; trendColor = '#0d9488'; trendIcon = 'â„ï¸â„ï¸'; }
    else if (avgMultDiff < -0.15) { trend = 'åå†·'; trendColor = '#0891b2'; trendIcon = 'â„ï¸'; }
    else if (avgMultDiff < -0.05) { trend = 'ç•¥åå†·'; trendColor = '#06b6d4'; trendIcon = 'â¬‡ï¸'; }
    
    // è¨ˆç®—èª¿æ•´å€¼ï¼ˆèª¿æ•´å¹…åº¦ = å¹³å‡å·®ç•° Ã— èª¿æ•´æ¬Šé‡0.5ï¼Œé¿å…éåº¦èª¿æ•´ï¼‰
    const adjustmentWeight = 0.5;
    const multAdjustment = avgMultDiff * adjustmentWeight;
    const priceAdjustment = avgPriceDiff * 0.3;
    
    // æ›´æ–°å…¨å±€è®Šæ•¸
    window.marketMomentum = {
        adjustment: multAdjustment,
        priceAdjustment: priceAdjustment,
        trend: trend,
        sampleCount: validData.length,
        lastUpdated: new Date().toLocaleString('zh-TW'),
        details: details,
        avgMultDiff: avgMultDiff,
        avgPriceDiff: avgPriceDiff,
        recentAvgMult: recentAvgMult
    };
    
    // ç”Ÿæˆå¸‚å ´å‹•èƒ½æ‘˜è¦HTML
    resultDiv.innerHTML = `
        <div style="background:linear-gradient(135deg, ${trendColor}20 0%, ${trendColor}10 100%); border:2px solid ${trendColor}; border-radius:8px; padding:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:11px; color:#666;">ç•¶å‰å¸‚å ´æ°›åœ</div>
                    <div style="font-size:22px; font-weight:bold; color:${trendColor};">
                        ${trendIcon} ${trend}
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:11px; color:#666;">é æ¸¬èª¿æ•´</div>
                    <div style="font-size:18px; font-weight:bold; color:${trendColor};">
                        ${multAdjustment >= 0 ? '+' : ''}${(multAdjustment * 100).toFixed(0)}%
                    </div>
                </div>
            </div>
            <div style="margin-top:8px; font-size:11px; color:#666; display:flex; justify-content:space-between;">
                <span>è¿‘ ${validData.length} æª”å¹³å‡ï¼š<b>${recentAvgMult.toFixed(2)}x</b></span>
                <span>æ­·å²å¹³å‡ï¼š<b>${historyAvgMult.toFixed(2)}x</b></span>
                <span style="color:${trendColor};">${avgMultDiff >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(avgMultDiff * 100).toFixed(1)}%</span>
            </div>
        </div>
    `;
    
    // ç”Ÿæˆè¿‘æœŸé–‹æ¨™æ˜ç´°HTML
    if (detailsDiv) {
        let detailsHTML = details.map((d, idx) => {
            const diffColor = parseFloat(d.multDiffPct) > 0 ? '#dc2626' : (parseFloat(d.multDiffPct) < 0 ? '#0891b2' : '#666');
            const diffSign = parseFloat(d.multDiffPct) >= 0 ? '+' : '';
            return `
                <div style="display:flex; justify-content:space-between; padding:6px 8px; background:${idx % 2 === 0 ? '#fff' : '#fafafa'}; border-radius:4px; margin-bottom:2px; font-size:11px;">
                    <span style="flex:1;">${d.name}</span>
                    <span style="width:80px; text-align:center; color:#666;">${d.date || '-'}</span>
                    <span style="width:50px; text-align:right;"><b>${d.mult.toFixed(2)}x</b></span>
                    <span style="width:55px; text-align:right;"><b>${d.price.toFixed(1)}</b></span>
                    <span style="width:50px; text-align:right; color:${diffColor};">${diffSign}${d.multDiffPct}%</span>
                </div>`;
        }).join('');
        
        detailsDiv.innerHTML = `
            <div style="display:flex; justify-content:space-between; padding:4px 8px; background:#e2e8f0; border-radius:4px; margin-bottom:4px; font-size:10px; font-weight:bold; color:#64748b;">
                <span style="flex:1;">åç¨±</span>
                <span style="width:80px; text-align:center;">é–‹æ¨™æ—¥</span>
                <span style="width:50px; text-align:right;">å€æ•¸</span>
                <span style="width:55px; text-align:right;">æœ€ä½å¾—æ¨™</span>
                <span style="width:50px; text-align:right;">vsæ­·å²</span>
            </div>
            ${detailsHTML}
        `;
    }
    
    console.log('å¸‚å ´å‹•èƒ½è¨ˆç®—å®Œæˆ:', window.marketMomentum);
}

/**
 * v3.73 æŠ•æ¨™å€æ•¸é ä¼°å‡½æ•¸ï¼ˆé‡æ–°è¨­è¨ˆï¼‰
 * æ ¸å¿ƒæ”¹é€²ï¼š
 * 1. ä»¥ã€Œå¹´æœŸ+æ“”ä¿ã€çµ„åˆç‚ºåŸºæº–ï¼ˆå€åˆ†æœ‰æ“”ä¿/ç„¡æ“”ä¿ï¼‰
 * 2. åƒè€ƒå¸‚å ´æ°›åœä¸‰æ¢ä»¶åŠ æ¬Šï¼ˆç”¢æ¥­35%ã€è¦æ¨¡25%ã€ä¿¡è©•15%ï¼‰
 * 3. åŠ å…¥ç†è«–åƒ¹å€é–“èª¿æ•´ï¼ˆ15%ï¼‰å’Œåˆ¸å•†èª¿æ•´ï¼ˆ10%ï¼‰
 */
function estimateBidMultiple(params) {
    const { issueSize, guarantee, years, theoreticalPrice, industry, broker, rating } = params;
    
    // ===== Step 1: ç¢ºå®šåŸºæº–ï¼ˆæ ¹æ“šå¹´æœŸ+æ“”ä¿çµ„åˆï¼‰=====
    const guarType = guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    const yrs = parseInt(years) || 3;
    const baseKey = `${guarType}_${yrs}`;
    const baseData = window.TERM_GUAR_TABLE[baseKey] || window.TERM_GUAR_TABLE[`${guarType}_3`];
    
    // åŸºæº–å€æ•¸å’Œæº¢åƒ¹ç‡
    let baseMult = baseData ? baseData.avgMult : (guarType === 'æœ‰æ“”ä¿' ? 3.16 : 2.88);
    let basePremium = baseData ? baseData.avgPremium : (guarType === 'æœ‰æ“”ä¿' ? 11.1 : 7.6);
    let basePrice = baseData ? baseData.avgPrice : (guarType === 'æœ‰æ“”ä¿' ? 108.54 : 106.22);
    const baseSampleCount = baseData ? baseData.count : 0;
    
    // åŒæ“”ä¿é¡å‹çš„æ•´é«”å¹³å‡ï¼ˆä½œç‚ºèª¿æ•´åƒè€ƒåŸºæº–ï¼‰
    const guarAvgMult = guarType === 'æœ‰æ“”ä¿' ? 3.16 : 2.88;
    const guarAvgPremium = guarType === 'æœ‰æ“”ä¿' ? 11.1 : 7.6;
    
    let adjustments = [];
    let totalWeight = 0;
    let confidenceScore = baseSampleCount;
    
    // ===== v3.90 æ–°å¢ï¼šæ“”ä¿é¡å‹èª¿æ•´ï¼ˆç¨ç«‹é¡¯ç¤ºï¼‰=====
    // æœ‰æ“”ä¿vsç„¡æ“”ä¿çš„æ­·å²å·®ç•°ä½œç‚ºèª¿æ•´å› å­
    const guarDiff = guarType === 'æœ‰æ“”ä¿' ? 0.28 : -0.10;  // æœ‰æ“”ä¿å¹³å‡æ¯”æ•´é«”é«˜0.28x
    adjustments.push({
        factor: 'ğŸ›¡ï¸ æ“”ä¿é¡å‹',
        label: guarType,
        value: guarDiff * 0.2,  // æ¬Šé‡20%
        ref: guarAvgMult,
        count: baseSampleCount,
        weight: '20%',
        note: guarType === 'æœ‰æ“”ä¿' ? 'æœ‰æ“”ä¿ç«¶çˆ­è¼ƒæ¿€çƒˆ' : 'ç„¡æ“”ä¿ç«¶çˆ­è¼ƒæº«å’Œ'
    });
    baseMult += guarDiff * 0.2;
    totalWeight += 0.20;
    
    // ===== Step 2: ç”¢æ¥­èª¿æ•´ï¼ˆæ¬Šé‡30%ï¼Œåƒè€ƒå¸‚å ´æ°›åœï¼‰=====
    const indName = industry ? industry.split(' ')[0] : '';
    if (indName && window.INDUSTRY_MULT_TABLE[indName]) {
        const indData = window.INDUSTRY_MULT_TABLE[indName];
        // èª¿æ•´é‡ = (ç”¢æ¥­å¹³å‡ - æ•´é«”å¹³å‡) Ã— æ¬Šé‡
        const indAdj = (indData.avgMult - window.OVERALL_STATS.avgBidMult) * 0.30;
        adjustments.push({ 
            factor: 'ç”¢æ¥­', 
            label: indName, 
            value: indAdj, 
            ref: indData.avgMult, 
            count: indData.count,
            weight: '30%'
        });
        baseMult += indAdj;
        confidenceScore += indData.count;
        totalWeight += 0.30;
    }
    
    // ===== Step 3: ç™¼è¡Œè¦æ¨¡èª¿æ•´ï¼ˆv3.81 å„ªåŒ–ï¼šæ¬Šé‡40%ï¼Œå°è¦æ¨¡é¡å¤–åŠ æˆï¼‰=====
    // å›æ¸¬ç™¼ç¾ï¼šå°è¦æ¨¡(<3å„„)ä½ä¼°0.66xï¼Œå¤§è¦æ¨¡(>15å„„)é«˜ä¼°0.42x
    if (issueSize > 0) {
        let sizeKey = 'over15';
        if (issueSize < 3) sizeKey = 'under3';
        else if (issueSize < 5) sizeKey = '3to5';
        else if (issueSize < 10) sizeKey = '5to10';
        else if (issueSize < 15) sizeKey = '10to15';
        
        const sizeData = window.SIZE_MULT_TABLE[sizeKey];
        if (sizeData) {
            // v3.81: æ¬Šé‡å¾25%æé«˜åˆ°40%
            let sizeWeight = 0.40;
            let sizeAdj = (sizeData.avgMult - window.OVERALL_STATS.avgBidMult) * sizeWeight;
            
            // v3.81: å°è¦æ¨¡é¡å¤–åŠ æˆï¼ˆå› ç‚ºå›æ¸¬é¡¯ç¤ºä½ä¼°åš´é‡ï¼‰
            if (sizeKey === 'under3') {
                sizeAdj += 0.3;  // é¡å¤–+0.3å€è£œå„Ÿ
            } else if (sizeKey === 'over15') {
                sizeAdj -= 0.2;  // å¤§è¦æ¨¡é¡å¤–æ‰£æ¸›
            }
            
            adjustments.push({ 
                factor: 'ç™¼è¡Œè¦æ¨¡', 
                label: sizeData.label, 
                value: sizeAdj, 
                ref: sizeData.avgMult, 
                count: sizeData.count,
                weight: '40%'
            });
            baseMult += sizeAdj;
            confidenceScore += sizeData.count;
            totalWeight += 0.40;
        }
    }
    
    // ===== Step 4: ä¿¡è©•èª¿æ•´ï¼ˆv3.90æå‡æ¬Šé‡20%ï¼‰=====
    // ä¿¡è©•å½±éŸ¿é¢¨éšªåå¥½ï¼Œé«˜ä¿¡è©•å¸å¼•æ›´å¤šæŠ•æ¨™
    if (rating && window.RATING_MULT_TABLE[rating]) {
        const ratingData = window.RATING_MULT_TABLE[rating];
        if (ratingData.count >= 3) { // v3.90 é™ä½é–€æª»å¾5æ”¹ç‚º3
            const ratingAdj = (ratingData.avgMult - window.OVERALL_STATS.avgBidMult) * 0.20;
            adjustments.push({ 
                factor: 'â­ ä¿¡è©•', 
                label: `TCRI ${rating}`, 
                value: ratingAdj, 
                ref: ratingData.avgMult, 
                count: ratingData.count,
                weight: '20%'
            });
            baseMult += ratingAdj;
            confidenceScore += ratingData.count;
            totalWeight += 0.20;
        }
    }
    
    // ===== Step 5: ç†è«–åƒ¹å€é–“èª¿æ•´ï¼ˆæ¬Šé‡15%ï¼‰=====
    if (theoreticalPrice > 0) {
        let convKey = 'out';
        if (theoreticalPrice < 90) convKey = 'deep_out';
        else if (theoreticalPrice < 100) convKey = 'out';
        else if (theoreticalPrice < 110) convKey = 'par';
        else if (theoreticalPrice < 130) convKey = 'in';
        else convKey = 'deep_in';
        
        const convData = window.CONV_VALUE_TABLE[convKey];
        if (convData) {
            const convAdj = (convData.avgMult - window.OVERALL_STATS.avgBidMult) * 0.15;
            adjustments.push({ 
                factor: 'ç†è«–åƒ¹å€é–“', 
                label: convData.label, 
                value: convAdj, 
                ref: convData.avgMult, 
                count: convData.count,
                weight: '15%'
            });
            baseMult += convAdj;
            confidenceScore += convData.count;
            totalWeight += 0.15;
        }
    }
    
    // ===== Step 6: åˆ¸å•†èª¿æ•´ï¼ˆæ¬Šé‡10%ï¼‰=====
    const brokerName = broker ? broker.split(' ')[0] : '';
    if (brokerName) {
        let brokerData = window.BROKER_MULT_TABLE[brokerName];
        if (!brokerData) {
            // å˜—è©¦éƒ¨åˆ†åŒ¹é…
            for (const [name, data] of Object.entries(window.BROKER_MULT_TABLE)) {
                if (brokerName.includes(name.replace('è­‰åˆ¸', '')) || name.includes(brokerName.replace('è­‰åˆ¸', ''))) {
                    brokerData = data;
                    break;
                }
            }
        }
        if (brokerData) {
            const brokerAdj = (brokerData.avgMult - window.OVERALL_STATS.avgBidMult) * 0.10;
            adjustments.push({ 
                factor: 'åˆ¸å•†', 
                label: brokerName, 
                value: brokerAdj, 
                ref: brokerData.avgMult, 
                count: brokerData.count,
                weight: '10%'
            });
            baseMult += brokerAdj;
            confidenceScore += brokerData.count;
            totalWeight += 0.10;
        }
    }
    
    // ===== Step 7: å‹•æ…‹å¸‚å ´å›é¥‹èª¿æ•´ï¼ˆv3.74æ–°å¢ï¼‰=====
    let momentumAdj = 0;
    let momentumInfo = null;
    if (window.marketMomentum && window.marketMomentum.adjustment !== 0 && window.marketMomentum.sampleCount > 0) {
        // å‹•æ…‹èª¿æ•´ = åŸºæº–å€æ•¸ Ã— å‹•èƒ½èª¿æ•´æ¯”ä¾‹
        momentumAdj = baseMult * window.marketMomentum.adjustment;
        adjustments.push({
            factor: 'ğŸ“¡ å¸‚å ´å‹•èƒ½',
            label: window.marketMomentum.trend + 'ï¼ˆ' + window.marketMomentum.sampleCount + 'æª”ï¼‰',
            value: momentumAdj,
            ref: baseMult,
            count: window.marketMomentum.sampleCount,
            weight: 'å‹•æ…‹'
        });
        baseMult += momentumAdj;
        
        momentumInfo = {
            trend: window.marketMomentum.trend,
            adjustment: window.marketMomentum.adjustment,
            sampleCount: window.marketMomentum.sampleCount
        };
    }
    
    // é™åˆ¶ç¯„åœï¼ˆæ­·å²æœ€ä½0.18ï¼Œæœ€é«˜11.04ï¼‰
    baseMult = Math.max(0.5, Math.min(8, baseMult));
    
    // ä¿¡å¿ƒåº¦è©•ä¼°
    let confidenceLevel = 'ä½';
    if (confidenceScore >= 150 && totalWeight >= 0.6) confidenceLevel = 'é«˜';
    else if (confidenceScore >= 80 && totalWeight >= 0.4) confidenceLevel = 'ä¸­';
    
    return {
        estimatedMult: baseMult,
        basePremium: basePremium,
        basePrice: basePrice,
        adjustments: adjustments,
        confidence: confidenceLevel,
        totalSamples: confidenceScore,
        totalWeight: totalWeight,
        guarType: guarType,
        baseKey: baseKey,
        baseSampleCount: baseSampleCount,
        momentumInfo: momentumInfo  // v3.74 æ–°å¢ï¼šå‹•æ…‹å¸‚å ´å›é¥‹è³‡è¨Š
    };
}

/**
 * v3.73 æ ¹æ“šæŠ•æ¨™å€æ•¸æŸ¥è¡¨å¾—åˆ°é ä¼°å¾—æ¨™åƒ¹
 */
function getExpectedPriceByMult(bidMult) {
    // v3.75 é‡æ–°è¨­è¨ˆï¼šè¿”å›æœ€ä½å¾—æ¨™(minPrice)å’Œå¹³å‡å¾—æ¨™(avgPrice)
    // v3.81 åŠ å…¥è‡ªé©æ‡‰å­¸ç¿’ï¼šæ ¹æ“šæ­·å²èª¤å·®å‹•æ…‹èª¿æ•´
    // åˆç†å€é–“ = minPrice ~ avgPrice
    
    // åŸºç¤æŸ¥è¡¨å€¼
    let baseResult = { 
        range: '', 
        minPrice: 106.10,
        avgPrice: 108.30,
        gap: 2.20,
        avgPremium: 8.73, 
        count: totalAuctionCount || 300
    };
    
    let multKey = 'over5';
    if (bidMult < 1) {
        baseResult = { range: '<1å€ï¼ˆæœªè¶³é¡ï¼‰', minPrice: 101.00, avgPrice: 102.07, gap: 1.07, avgPremium: 0.95, count: 23 };
        multKey = 'under1';
    } else if (bidMult < 1.5) {
        baseResult = { range: '1-1.5å€', minPrice: 101.00, avgPrice: 102.54, gap: 1.54, avgPremium: 1.32, count: 43 };
        multKey = '1to1.5';
    } else if (bidMult < 2) {
        baseResult = { range: '1.5-2å€', minPrice: 102.66, avgPrice: 104.82, gap: 2.16, avgPremium: 3.56, count: 36 };
        multKey = '1.5to2';
    } else if (bidMult < 3) {
        baseResult = { range: '2-3å€', minPrice: 106.10, avgPrice: 108.30, gap: 2.20, avgPremium: 6.43, count: 74 };
        multKey = '2to3';
    } else if (bidMult < 5) {
        baseResult = { range: '3-5å€', minPrice: 109.91, avgPrice: 111.60, gap: 1.69, avgPremium: 10.15, count: 87 };
        multKey = '3to5';
    } else {
        baseResult = { range: '>5å€', minPrice: 112.87, avgPrice: 114.74, gap: 1.87, avgPremium: 13.91, count: 41 };
        multKey = 'over5';
    }
    
    return baseResult;
}


// v3.72 ä¿®æ”¹ï¼šæ”¹ç”¨å‹•æ…‹è¨ˆç®—çš„çµ±è¨ˆæ•¸æ“š
// ==========================================

/**
 * ä¸»åŠ›å‡ºåƒ¹é æ¸¬å‡½æ•¸
 * @param {number} theoPrice - ç†è«–åƒ¹æ ¼
 * @param {number} bidMultiple - é ä¼°æŠ•æ¨™å€æ•¸
 * @param {number} issueSize - ç™¼è¡Œè¦æ¨¡ï¼ˆå„„å…ƒï¼‰
 * @param {string} broker - æ‰¿éŠ·å•†åç¨±
 * @param {string} guarantee - æ“”ä¿é¡å‹ï¼ˆ'æœ‰æ“”ä¿' æˆ– 'ç„¡æ“”ä¿'ï¼‰
 * @param {number} years - ç™¼è¡Œå¹´æœŸï¼ˆ3 æˆ– 5ï¼‰
 * @returns {object} é æ¸¬çµæœ
 */
function predictMajorPlayerBid(theoPrice, bidMultiple, issueSize, broker, guarantee, years = 3, industry = '') {
    
    // ========================================
    // v3.73 é‡æ–°è¨­è¨ˆï¼šåŸºæ–¼${totalAuctionCount}æª”ç«¶æ‹çµ±è¨ˆçš„æ™ºèƒ½é æ¸¬
    // æ ¸å¿ƒé‚è¼¯ï¼š
    // 1. é ä¼°æŠ•æ¨™å€æ•¸ï¼ˆå¤šå› å­åŠ æ¬Šï¼‰
    // 2. æŸ¥è¡¨å¾—åˆ°é æœŸå¾—æ¨™åƒ¹å€é–“
    // 3. è¨ˆç®—å»ºè­°å‡ºåƒ¹ï¼ˆåŸºæ–¼ç†è«–åƒ¹ï¼‰
    // ========================================
    
    // Step 1ï¼šé ä¼°æŠ•æ¨™å€æ•¸
    const multEstimate = estimateBidMultiple({
        issueSize: issueSize,
        guarantee: guarantee,
        years: years,
        theoreticalPrice: theoPrice,
        industry: industry,
        broker: broker
    });
    
    const estimatedMult = multEstimate.estimatedMult;
    
    // Step 2ï¼šæ ¹æ“šé ä¼°å€æ•¸æŸ¥è¡¨å¾—åˆ°é æœŸå¾—æ¨™åƒ¹å€é–“
    const priceExpect = getExpectedPriceByMult(estimatedMult);
    
    // v3.75 æ ¸å¿ƒä¿®æ­£ï¼šå»ºè­°å‡ºåƒ¹ç›´æ¥åŸºæ–¼æŸ¥è¡¨çµæœï¼Œä¸å†ç”¨ç†è«–åƒ¹Ã—æº¢åƒ¹ç‡
    // åˆç†å€é–“ = minPriceï¼ˆæœ€ä½å¾—æ¨™ï¼‰~ avgPriceï¼ˆå¹³å‡å¾—æ¨™ï¼‰
    const expectedMinBid = priceExpect.minPrice;   // é æœŸæœ€ä½å¾—æ¨™ï¼ˆä¿å®ˆåŸºæº–ï¼‰
    const expectedAvgBid = priceExpect.avgPrice;   // é æœŸå¹³å‡å¾—æ¨™ï¼ˆç©æ¥µåŸºæº–ï¼‰
    const priceGap = priceExpect.gap;              // å€é–“å·®è·
    
    // Step 3ï¼šä¸‰ç¨®ç­–ç•¥è¨ˆç®—
    // v3.81 ä¿®æ­£ï¼šæ™ºèƒ½è™•ç†ä¸åŒç†è«–åƒ¹æƒ…æ³
    let conservativePrice, balancedPrice, aggressivePrice;
    
    if (expectedMinBid >= theoPrice || theoPrice <= 100) {
        // æ­£å¸¸æƒ…æ³ï¼šæŸ¥è¡¨åƒ¹æ ¼ >= ç†è«–åƒ¹ï¼Œæˆ–ç†è«–åƒ¹ <= 100
        conservativePrice = expectedMinBid;
        balancedPrice = (expectedMinBid + expectedAvgBid) / 2;
        aggressivePrice = expectedAvgBid;
    } else {
        // é«˜ç†è«–åƒ¹æƒ…æ³ï¼šæŸ¥è¡¨åƒ¹æ ¼ < ç†è«–åƒ¹
        // ä»¥ç†è«–åƒ¹ç‚ºåŸºæº–ï¼ŒåŠ ä¸Šç¸®æ¸›å¾Œçš„æº¢åƒ¹ç‡ï¼Œä¸¦ç¶­æŒåˆç†å€é–“
        const scaleFactor = 0.5;  // é«˜ç†è«–åƒ¹æ¨™çš„æº¢åƒ¹ç‡è¼ƒä½
        const histMinPremium = ((expectedMinBid / 100) - 1) * 100 * scaleFactor;
        const histAvgPremium = ((expectedAvgBid / 100) - 1) * 100 * scaleFactor;
        const minSpread = priceGap * 0.8;  // ç¢ºä¿å€é–“å·®è·
        
        conservativePrice = Math.max(theoPrice * (1 + histMinPremium / 100), theoPrice);
        aggressivePrice = Math.max(
            theoPrice * (1 + histAvgPremium / 100), 
            conservativePrice + minSpread
        );
        balancedPrice = (conservativePrice + aggressivePrice) / 2;
    }
    
    // è¨ˆç®—æº¢åƒ¹ç‡ï¼ˆç›¸å°æ–¼ç†è«–åƒ¹ï¼‰
    const conservativePremium = theoPrice > 0 ? ((conservativePrice / theoPrice) - 1) * 100 : 0;
    const balancedPremium = theoPrice > 0 ? ((balancedPrice / theoPrice) - 1) * 100 : 0;
    const aggressivePremium = theoPrice > 0 ? ((aggressivePrice / theoPrice) - 1) * 100 : 0;
    
    // æŸ¥è©¢åŒæ¢ä»¶æ­·å²æ•¸æ“šï¼ˆä½œç‚ºåƒè€ƒï¼Œä½†ä¸å†ä½œç‚ºä¸»è¦è¨ˆç®—ä¾æ“šï¼‰
    const condStats = window.conditionStats || {};
    let theoKey = '>=110';
    if (theoPrice < 95) theoKey = '<95';
    else if (theoPrice < 100) theoKey = '95-100';
    else if (theoPrice < 105) theoKey = '100-105';
    else if (theoPrice < 110) theoKey = '105-110';
    
    const guarKey = (guarantee === 'æœ‰æ“”ä¿') ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    const condKey = `${theoKey}_${guarKey}`;
    const histData = condStats[condKey] || {};
    
    // æ­·å²æº¢åƒ¹ç‡ï¼ˆä½œç‚ºåƒè€ƒé¡¯ç¤ºï¼‰
    const useRecent = histData.recentAvgLowPremium !== null && histData.recentAvgLowPremium !== undefined;
    const histLowPremium = useRecent ? histData.recentAvgLowPremium : (histData.avgLowPremium || 5);
    const histAvgPremium = useRecent ? histData.recentAvgAvgPremium : (histData.avgAvgPremium || 7);
    const histSampleCount = histData.count || 0;
    
    // ç†±åº¦ç­‰ç´šåˆ¤æ–·
    let heatLevel = 'ä¸€èˆ¬';
    let heatColor = '#eab308';
    if (estimatedMult < 1.5) { heatLevel = 'å†·é–€'; heatColor = '#22c55e'; }
    else if (estimatedMult < 2) { heatLevel = 'åå†·'; heatColor = '#84cc16'; }
    else if (estimatedMult < 3) { heatLevel = 'ä¸€èˆ¬'; heatColor = '#eab308'; }
    else if (estimatedMult < 4) { heatLevel = 'åç†±'; heatColor = '#f97316'; }
    else { heatLevel = 'ç†±é–€'; heatColor = '#ef4444'; }
    
    // ä¿¡å¿ƒåº¦ï¼ˆåŸºæ–¼æ¨£æœ¬æ•¸ï¼‰
    let confidence = 'ä½';
    if (multEstimate.totalSamples >= 100) confidence = 'é«˜';
    else if (multEstimate.totalSamples >= 50) confidence = 'ä¸­';
    
    return {
        // === æ ¸å¿ƒé æ¸¬çµæœ ===
        estimatedMult: estimatedMult,           // é ä¼°æŠ•æ¨™å€æ•¸
        expectedMinBid: expectedMinBid,         // é æœŸæœ€ä½å¾—æ¨™
        expectedAvgBid: expectedAvgBid,         // é æœŸå¹³å‡å¾—æ¨™ï¼ˆv3.75æ–°å¢ï¼‰
        priceGap: priceGap,                     // å€é–“å·®è·ï¼ˆv3.75æ–°å¢ï¼‰
        multRange: priceExpect.range,           // å€æ•¸å€é–“
        
        // === å»ºè­°å‡ºåƒ¹ï¼ˆåŸºæ–¼æŸ¥è¡¨çµæœ minPrice ~ avgPriceï¼‰===
        theoPrice: theoPrice,
        aggressivePrice: aggressivePrice,       // ç©æ¥µå‹ = å¹³å‡å¾—æ¨™
        balancedPrice: balancedPrice,           // å¹³è¡¡å‹ = ä¸­é–“å€¼
        conservativePrice: conservativePrice,   // ä¿å®ˆå‹ = æœ€ä½å¾—æ¨™
        aggressivePremium: aggressivePremium,   // ç©æ¥µå‹æº¢åƒ¹%
        balancedPremium: balancedPremium,       // å¹³è¡¡å‹æº¢åƒ¹%
        conservativePremium: conservativePremium, // ä¿å®ˆå‹æº¢åƒ¹%
        
        // === ç†±åº¦èˆ‡ä¿¡å¿ƒåº¦ ===
        heatLevel: heatLevel,
        heatColor: heatColor,
        confidence: confidence,
        
        // === å› å­åˆ†ææ˜ç´° ===
        adjustments: multEstimate.adjustments,
        methodology: multEstimate.methodology,
        
        // === æ­·å²æ•¸æ“šåƒè€ƒ ===
        histLowPremium: histLowPremium,
        histAvgPremium: histAvgPremium,
        histSampleCount: histSampleCount,
        useRecent: useRecent,
        condKey: condKey,
        theoKey: theoKey,
        guarKey: guarKey,
        
        // === çµ±è¨ˆä¾†æºèªªæ˜ ===
        dataSource: `åŸºæ–¼${totalAuctionCount}æª”ç«¶æ‹çµ±è¨ˆï¼ˆ${priceExpect.count}æª”åŒå€æ•¸å€é–“ï¼‰`
    };
}

/**
 * å¾—æ¨™æ©Ÿç‡ä¼°ç®—å‡½æ•¸
 * @param {number} inputPremium - ç”¨æˆ¶è¼¸å…¥çš„æº¢åƒ¹%
 * @param {number} predictedPremium - é æ¸¬çš„æº¢åƒ¹%
 * @returns {object} æ©Ÿç‡è©•ä¼°çµæœ
 */
function estimateWinRate(inputPremium, predictedPremium) {
    const diff = inputPremium - predictedPremium;
    
    if (diff < -1) return { rate: '<20%', level: 'ä½', color: '#ef4444' };
    if (diff < 0) return { rate: '20-35%', level: 'åä½', color: '#f97316' };
    if (diff < 0.5) return { rate: '35-50%', level: 'ä¸­ç­‰', color: '#eab308' };
    if (diff < 1) return { rate: '50-62%', level: 'åé«˜', color: '#84cc16' };
    if (diff < 1.5) return { rate: '62-72%', level: 'é«˜', color: '#22c55e' };
    if (diff < 2.5) return { rate: '72-88%', level: 'å¾ˆé«˜', color: '#10b981' };
    return { rate: '>88%', level: 'æ¥µé«˜', color: '#059669' };
}

/**
 * v3.72 æ–°å¢ï¼šç«¶æ‹å‰ç¶œåˆè©•ä¼°å‡½æ•¸
 * åŸºæ–¼æ­·å²æ•¸æ“šè©•ä¼°æ˜¯å¦å€¼å¾—åƒèˆ‡é€™æª”ç«¶æ‹
 * @param {object} params - è©•ä¼°åƒæ•¸
 * @returns {object} è©•ä¼°çµæœ
 */
function evaluateAuctionOpportunity(params) {
    const { 
        theoPrice,      // ç†è«–åƒ¹
        guarantee,      // æ“”ä¿é¡å‹
        tcri,           // ä¿¡ç”¨è©•ç­‰
        issueSize,      // ç™¼è¡Œè¦æ¨¡ï¼ˆå„„å…ƒï¼‰
        broker,         // æ‰¿éŠ·å•†
        industry        // ç”¢æ¥­åˆ†é¡
    } = params;
    
    let totalScore = 0;
    let maxScore = 100;
    const factors = [];
    
    // åˆ¤æ–·ç†è«–åƒ¹å€é–“
    let theoKey = '>=110';
    if (theoPrice < 95) theoKey = '<95';
    else if (theoPrice < 100) theoKey = '95-100';
    else if (theoPrice < 105) theoKey = '100-105';
    else if (theoPrice < 110) theoKey = '105-110';
    
    // å–å¾—åŒæ¢ä»¶æ­·å²çµ±è¨ˆ
    const guarKey = guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    const condKey = `${theoKey}_${guarKey}`;
    const condStats = window.conditionStats?.[condKey] || null;
    
    // å„ªå…ˆä½¿ç”¨è¿‘æœŸæ•¸æ“šï¼Œæ²’æœ‰å‰‡ç”¨å…¨éƒ¨æ•¸æ“š
    const useRecent = condStats?.recentCount >= 5;
    const estBidMultiple = useRecent && condStats.recentAvgBidMultiple ? condStats.recentAvgBidMultiple : (condStats?.avgBidMultiple || 2.5);
    const estGain = useRecent && condStats.recentAvgGain !== null ? condStats.recentAvgGain : (condStats?.avgGain || 30);
    const estWinRate = useRecent && condStats.recentWinRate !== null ? condStats.recentWinRate : (condStats?.winRate || 0.7);
    const sampleCount = condStats?.count || 0;
    const recentCount = condStats?.recentCount || 0;
    
    // ========================================
    // 1. åŒæ¢ä»¶æ­·å²ç²åˆ©è©•åˆ†ï¼ˆæ¬Šé‡30åˆ†ï¼‰
    // ========================================
    let gainScore = 0;
    let gainNote = '';
    const condLabel = `${theoKey}Ã—${guarKey}`;
    const dataSource = useRecent ? `è¿‘${recentCount}æª”` : `${sampleCount}æª”`;
    
    if (estGain >= 50) {
        gainScore = 30;
        gainNote = `${condLabel}æ­·å²å¹³å‡ç²åˆ©${estGain.toFixed(0)}å…ƒï¼Œè¡¨ç¾å„ªç•°`;
    } else if (estGain >= 30) {
        gainScore = 25;
        gainNote = `${condLabel}æ­·å²å¹³å‡ç²åˆ©${estGain.toFixed(0)}å…ƒï¼Œè¡¨ç¾è‰¯å¥½`;
    } else if (estGain >= 20) {
        gainScore = 18;
        gainNote = `${condLabel}æ­·å²å¹³å‡ç²åˆ©${estGain.toFixed(0)}å…ƒï¼Œè¡¨ç¾ä¸€èˆ¬`;
    } else if (estGain >= 10) {
        gainScore = 12;
        gainNote = `${condLabel}æ­·å²å¹³å‡ç²åˆ©${estGain.toFixed(0)}å…ƒï¼Œç²åˆ©ç©ºé–“æœ‰é™`;
    } else {
        gainScore = 5;
        gainNote = `${condLabel}æ­·å²å¹³å‡ç²åˆ©åƒ…${estGain.toFixed(0)}å…ƒï¼Œé¢¨éšªè¼ƒé«˜`;
    }
    
    totalScore += gainScore;
    factors.push({
        name: 'åŒæ¢ä»¶æ­·å²ç²åˆ©',
        score: gainScore,
        maxScore: 30,
        value: `${estGain.toFixed(0)}å…ƒ`,
        note: `${gainNote}ï¼ˆ${dataSource}ï¼‰`,
        positive: gainScore >= 18
    });
    
    // ========================================
    // 2. åŒæ¢ä»¶æ­·å²å‹ç‡è©•åˆ†ï¼ˆæ¬Šé‡25åˆ†ï¼‰
    // ========================================
    let winScore = 0;
    let winNote = '';
    const winPct = estWinRate * 100;
    
    if (winPct >= 80) {
        winScore = 25;
        winNote = `${condLabel}æ­·å²å‹ç‡${winPct.toFixed(0)}%ï¼Œéå¸¸å„ªç§€`;
    } else if (winPct >= 70) {
        winScore = 20;
        winNote = `${condLabel}æ­·å²å‹ç‡${winPct.toFixed(0)}%ï¼Œè¡¨ç¾è‰¯å¥½`;
    } else if (winPct >= 60) {
        winScore = 15;
        winNote = `${condLabel}æ­·å²å‹ç‡${winPct.toFixed(0)}%ï¼Œä¸­ç­‰æ°´æº–`;
    } else if (winPct >= 50) {
        winScore = 10;
        winNote = `${condLabel}æ­·å²å‹ç‡${winPct.toFixed(0)}%ï¼Œç•¥ä½æ–¼å¹³å‡`;
    } else {
        winScore = 5;
        winNote = `${condLabel}æ­·å²å‹ç‡åƒ…${winPct.toFixed(0)}%ï¼Œéœ€è¬¹æ…è©•ä¼°`;
    }
    
    totalScore += winScore;
    factors.push({
        name: 'åŒæ¢ä»¶æ­·å²å‹ç‡',
        score: winScore,
        maxScore: 25,
        value: `${winPct.toFixed(0)}%`,
        note: `${winNote}ï¼ˆ${dataSource}ï¼‰`,
        positive: winScore >= 15
    });
    
    // ========================================
    // 3. ç†è«–åƒ¹æœ¬èº«è©•åˆ†ï¼ˆæ¬Šé‡20åˆ†ï¼‰
    // ========================================
    let theoScore = 0;
    let theoNote = '';
    
    if (theoPrice < 95) {
        theoScore = 18;
        theoNote = 'ç†è«–åƒ¹<95ï¼Œè½‰æ›åƒ¹å€¼ä½ä½†ä¸‹æª”æœ‰å‚µåˆ¸ä¿è­·';
    } else if (theoPrice < 100) {
        theoScore = 20;
        theoNote = 'ç†è«–åƒ¹95-100ï¼Œé¢¨éšªå ±é…¬æ¯”æœ€ä½³å€é–“';
    } else if (theoPrice < 105) {
        theoScore = 18;
        theoNote = 'ç†è«–åƒ¹100-105ï¼Œå…·è½‰æ›åƒ¹å€¼ï¼Œé¢¨éšªå¯æ§';
    } else if (theoPrice < 110) {
        theoScore = 12;
        theoNote = 'ç†è«–åƒ¹105-110ï¼Œè‚¡åƒ¹å·²é«˜æ–¼è½‰æ›åƒ¹ï¼Œéœ€ç•™æ„å›æª”';
    } else {
        theoScore = 6;
        theoNote = 'ç†è«–åƒ¹>=110ï¼Œé«˜åº¦ä¾è³´è‚¡åƒ¹ç¶­æŒï¼Œé¢¨éšªè¼ƒé«˜';
    }
    
    totalScore += theoScore;
    factors.push({
        name: 'ç†è«–åƒ¹',
        score: theoScore,
        maxScore: 20,
        value: `${theoPrice?.toFixed(1) || '-'}å…ƒ`,
        note: theoNote,
        positive: theoScore >= 15
    });
    
    // ========================================
    // 4. å®‰å…¨æ€§è©•åˆ†ï¼ˆæ¬Šé‡15åˆ†ï¼‰- æ“”ä¿+ä¿¡è©•
    // ========================================
    let safeScore = 0;
    let safeNote = '';
    
    // æ“”ä¿ (8åˆ†)
    if (guarantee === 'æœ‰æ“”ä¿') {
        safeScore += 8;
        safeNote = 'æœ‰æ“”ä¿';
    } else {
        safeScore += 4;
        safeNote = 'ç„¡æ“”ä¿';
    }
    
    // ä¿¡è©• (7åˆ†)
    const tcriNum = parseInt(tcri) || 6;
    if (tcriNum <= 4) {
        safeScore += 7;
        safeNote += ' + å„ªè‰¯ä¿¡è©•TCRI' + tcriNum;
    } else if (tcriNum <= 6) {
        safeScore += 5;
        safeNote += ' + ä¸€èˆ¬ä¿¡è©•TCRI' + tcriNum;
    } else {
        safeScore += 2;
        safeNote += ' + è¼ƒå·®ä¿¡è©•TCRI' + tcriNum;
    }
    
    totalScore += safeScore;
    factors.push({
        name: 'å®‰å…¨æ€§',
        score: safeScore,
        maxScore: 15,
        value: `${guarantee || 'ç„¡æ“”ä¿'} / TCRI${tcriNum}`,
        note: safeNote,
        positive: safeScore >= 10
    });
    
    // ========================================
    // 5. å¸‚å ´ç’°å¢ƒè©•åˆ†ï¼ˆæ¬Šé‡10åˆ†ï¼‰
    // ========================================
    let timeScore = 0;
    let timeNote = '';
    
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentHalf = now.getMonth() < 6 ? 'H1' : 'H2';
    const currentPeriod = `${currentYear}${currentHalf}`;
    
    // åŸºæ–¼æ­·å²æ•¸æ“šï¼š2024H2å¾Œæ•´é«”å‹ç‡ä¸‹é™
    if (currentYear < 2024 || (currentYear === 2024 && currentHalf === 'H1')) {
        timeScore = 10;
        timeNote = 'å¸‚å ´ç’°å¢ƒè‰¯å¥½æœŸ';
    } else if (currentYear === 2024 && currentHalf === 'H2') {
        timeScore = 5;
        timeNote = '2024H2ä¾›çµ¦é‡å¤§å¢ï¼Œæ•´é«”å‹ç‡ç´„62%';
    } else {
        timeScore = 4;
        timeNote = `${currentPeriod}ä¾›çµ¦æŒçºŒé«˜ä½ï¼Œæ•´é«”å‹ç‡ç´„55%`;
    }
    
    totalScore += timeScore;
    factors.push({
        name: 'å¸‚å ´ç’°å¢ƒ',
        score: timeScore,
        maxScore: 10,
        value: currentPeriod,
        note: timeNote,
        positive: timeScore >= 6
    });
    
    // ========================================
    // åŒæ¢ä»¶æ­·å²æ•¸æ“šåƒè€ƒï¼ˆåƒ…ä¾›åƒè€ƒï¼Œä¸è¨ˆåˆ†ï¼‰
    // ========================================
    factors.push({
        name: 'åŒæ¢ä»¶æ­·å²æŠ•æ¨™å€æ•¸',
        score: '-',
        maxScore: '-',
        value: `${estBidMultiple.toFixed(1)}å€`,
        note: `æ¢ä»¶ï¼š${condLabel}ï¼Œ${dataSource}å¹³å‡ï¼Œä¾›å‡ºåƒ¹ç­–ç•¥åƒè€ƒ`,
        positive: true,
        isReference: true
    });
    
    // ========================================
    // ç¶œåˆè©•åƒ¹
    // ========================================
    let recommendation = '';
    let recommendColor = '';
    let recommendIcon = '';
    let summaryNote = '';
    
    const scorePercent = (totalScore / maxScore) * 100;
    
    if (scorePercent >= 75) {
        recommendation = 'å»ºè­°åƒèˆ‡';
        recommendColor = '#22c55e';
        recommendIcon = 'ğŸŸ¢';
        summaryNote = 'æ­·å²æ•¸æ“šé¡¯ç¤ºåŒæ¢ä»¶æ¡ˆä»¶è¡¨ç¾å„ªç•°ï¼Œå»ºè­°ç©æ¥µåƒèˆ‡';
    } else if (scorePercent >= 60) {
        recommendation = 'å¯è€ƒæ…®åƒèˆ‡';
        recommendColor = '#84cc16';
        recommendIcon = 'ğŸŸ¡';
        summaryNote = 'æ¢ä»¶å°šå¯ï¼Œå¯æ ¹æ“šå€‹äººé¢¨éšªåå¥½åŠè³‡é‡‘é…ç½®æ±ºå®š';
    } else if (scorePercent >= 45) {
        recommendation = 'è¬¹æ…è©•ä¼°';
        recommendColor = '#f97316';
        recommendIcon = 'ğŸŸ ';
        summaryNote = 'éƒ¨åˆ†æ¢ä»¶ä¸åˆ©ï¼Œæ­·å²è¡¨ç¾ä¸€èˆ¬ï¼Œéœ€å¯©æ…è€ƒé‡';
    } else {
        recommendation = 'å»ºè­°è§€æœ›';
        recommendColor = '#ef4444';
        recommendIcon = 'ğŸ”´';
        summaryNote = 'å¤šé …æ¢ä»¶ä¸åˆ©ï¼Œæ­·å²å‹ç‡åä½ï¼Œå»ºè­°æš«æ™‚è§€æœ›';
    }
    
    // æ‰¾å‡ºä¸»è¦åˆ©å¤šå’Œåˆ©ç©º
    const scoredFactors = factors.filter(f => f.score !== '-');
    const positiveFactors = scoredFactors.filter(f => f.positive && f.score >= f.maxScore * 0.7);
    const negativeFactors = scoredFactors.filter(f => !f.positive && f.score < f.maxScore * 0.5);
    
    return {
        totalScore,
        maxScore,
        scorePercent: Math.round(scorePercent),
        recommendation,
        recommendColor,
        recommendIcon,
        summaryNote,
        factors,
        positiveFactors,
        negativeFactors,
        theoKey,
        condKey,
        estimates: {
            bidMultiple: estBidMultiple,
            gain: estGain,
            winRate: estWinRate,
            sampleCount,
            recentCount,
            useRecent
        },
        // v3.81: åŠ å…¥å¿«ç…§IDä¾›è¿½è¹¤
        snapshotId: predictionSnapshot.id
    };
}

/**
 * æ›´æ–°ç«¶æ‹è©•ä¼°é¡¯ç¤º
 */
function updateAuctionEvaluation() {
    const container = document.getElementById('auctionEvaluation');
    if (!container) return;
    
    // å–å¾—ç•¶å‰è¼¸å…¥å€¼
    const stockPrice = safeFloat(document.getElementById('stockPrice')?.value);
    const convPrice = safeFloat(document.getElementById('actualConversionPrice')?.value);
    const guarantee = document.getElementById('guarantee')?.value || 'ç„¡æ“”ä¿';
    const tcri = document.getElementById('rating')?.value || '6';
    const broker = document.getElementById('broker')?.value || '';
    const industry = document.getElementById('industry')?.value || '';
    
    // å¾ç™¼è¡Œè¦æ¨¡å€é–“è§£ææ•¸å€¼
    const issueSizeStr = document.getElementById('issueSize')?.value || '';
    let issueSize = 5; // é è¨­
    if (issueSizeStr.includes('å°æ–¼2å„„')) issueSize = 1.5;
    else if (issueSizeStr.includes('2~5å„„')) issueSize = 3.5;
    else if (issueSizeStr.includes('5~10å„„')) issueSize = 7.5;
    else if (issueSizeStr.includes('10~15å„„')) issueSize = 12.5;
    else if (issueSizeStr.includes('15~20å„„')) issueSize = 17.5;
    else if (issueSizeStr.includes('å¤§æ–¼20å„„')) issueSize = 25;
    
    // è¨ˆç®—ç†è«–åƒ¹
    let theoPrice = 0;
    let theoPriceSource = '';
    
    if (stockPrice > 0 && convPrice > 0) {
        theoPrice = (stockPrice / convPrice) * 100;
        theoPriceSource = 'è‚¡åƒ¹/è½‰æ›åƒ¹è¨ˆç®—';
    } else {
        // å˜—è©¦å¾ç†è«–åƒ¹å€é–“ç²å–
        const theoRangeStr = document.getElementById('theoRange')?.value || '';
        theoPrice = getTheoRangeMidValue(theoRangeStr);
        if (theoPrice > 0) {
            theoPriceSource = 'ç†è«–åƒ¹å€é–“ä¼°ç®—';
        }
    }
    
    // v3.81 ä¿®æ­£ï¼šæ²’æœ‰ç†è«–åƒ¹å°±æé†’ç”¨æˆ¶è¼¸å…¥ï¼Œä¸ç”¨é è¨­å€¼
    if (!theoPrice || theoPrice <= 0) {
        container.innerHTML = `
            <div style="padding:15px; background:#fff9e6; border-radius:8px; border-left:4px solid #ff9800;">
                <div style="font-weight:bold; color:#e65100; margin-bottom:8px;">âš ï¸ è«‹è£œå……è‚¡åƒ¹å’Œè½‰æ›åƒ¹</div>
                <div style="font-size:12px; color:#666;">
                    ç³»çµ±éœ€è¦è‚¡åƒ¹å’Œè½‰æ›åƒ¹ä¾†è¨ˆç®—ç†è«–åƒ¹æ ¼ï¼Œæ‰èƒ½é€²è¡ŒAIè©•ä¼°ã€‚<br><br>
                    <b>æ–¹å¼ä¸€ï¼š</b>åœ¨ä¸Šæ–¹ã€Œç«¶æ‹è³‡æ–™ã€å€å¡Šè¼¸å…¥ï¼š<br>
                    ã€€â€¢ æˆªæ¨™æ—¥13:30æ”¶ç›¤åƒ¹<br>
                    ã€€â€¢ å¯¦éš›è½‰æ›åƒ¹æ ¼<br><br>
                    <b>æ–¹å¼äºŒï¼š</b>ç›´æ¥é¸æ“‡ã€Œç†è«–åƒ¹å€é–“ã€
                </div>
                <div style="margin-top:10px; padding:8px; background:#e3f2fd; border-radius:6px; font-size:11px; color:#1565c0;">
                    ğŸ’¡ æé†’ï¼šç†è«–åƒ¹ = (è‚¡åƒ¹ Ã· è½‰æ›åƒ¹) Ã— 100
                </div>
            </div>
        `;
        const liveContainer = document.getElementById('liveAIPrediction');
        if (liveContainer) {
            liveContainer.innerHTML = '<div style="color:#999; padding:10px; text-align:center;">ç­‰å¾…è¼¸å…¥è‚¡åƒ¹/è½‰æ›åƒ¹...</div>';
        }
        return;
    }
    
    // æª¢æŸ¥æ˜¯å¦æœ‰çµ±è¨ˆæ•¸æ“š
    if (!window.conditionStats || Object.keys(window.conditionStats).length === 0) {
        container.innerHTML = '<div style="color:#666;padding:10px;">çµ±è¨ˆæ•¸æ“šè¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>';
        // v3.73ï¼šçµ±è¨ˆæ•¸æ“šè¼‰å…¥ä¸­æ™‚ï¼Œä»ç„¶å˜—è©¦é¡¯ç¤ºåŸºæ–¼${totalAuctionCount}æª”çµ±è¨ˆçš„é æ¸¬
        updateLiveAIPrediction(theoPrice, issueSize, guarantee, broker, industry, tcri);
        return;
    }
    
    const result = evaluateAuctionOpportunity({
        theoPrice,
        guarantee,
        tcri,
        issueSize,
        broker,
        industry
    });
    
    // v3.81 æ–°å¢ï¼šåŸ·è¡Œè¶…ç´šé æ¸¬å¼•æ“ï¼ˆKNN + è’™åœ°å¡ç¾…ï¼‰
    try {
        const years = parseInt(document.getElementById('years')?.value) || 3;
        runSuperPredictionEngine({
            theoPrice,
            issueSize,
            guarantee,
            years,
            industry,
            rating: tcri
        });
    } catch (e) {
        console.warn('è¶…ç´šé æ¸¬å¼•æ“åŸ·è¡Œå¤±æ•—:', e);
    }
    
    // ç”Ÿæˆè©•ä¼°HTML
    let html = `
    <div style="background:linear-gradient(135deg, ${result.recommendColor}15, ${result.recommendColor}05); border:2px solid ${result.recommendColor}; border-radius:12px; padding:15px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-size:1.3em; font-weight:bold; color:${result.recommendColor};">
                ${result.recommendIcon} ${result.recommendation}
            </div>
            <div style="font-size:1.5em; font-weight:bold; color:${result.recommendColor};">
                ${result.totalScore}/${result.maxScore}åˆ†
            </div>
        </div>
        <div style="color:#666; font-size:0.9em;">${result.summaryNote}</div>
    </div>
    
    <div style="font-weight:bold; margin-bottom:8px; color:#333;">ğŸ“Š å„é …è©•ä¼°æ˜ç´°</div>
    <table style="width:100%; border-collapse:collapse; font-size:0.85em;">
        <thead>
            <tr style="background:#f5f5f5;">
                <th style="padding:8px; text-align:left; border-bottom:1px solid #ddd;">è©•ä¼°é …ç›®</th>
                <th style="padding:8px; text-align:center; border-bottom:1px solid #ddd;">æ•¸å€¼</th>
                <th style="padding:8px; text-align:center; border-bottom:1px solid #ddd;">å¾—åˆ†</th>
                <th style="padding:8px; text-align:left; border-bottom:1px solid #ddd;">èªªæ˜</th>
            </tr>
        </thead>
        <tbody>`;
    
    result.factors.forEach(f => {
        const isRef = f.isReference;
        const scoreColor = isRef ? '#666' : (f.positive ? '#22c55e' : (f.score < f.maxScore * 0.5 ? '#ef4444' : '#f97316'));
        const icon = isRef ? 'ğŸ“Œ' : (f.positive ? 'âœ“' : (f.score < f.maxScore * 0.5 ? 'âœ—' : 'â–³'));
        const scoreText = isRef ? 'åƒè€ƒ' : `${f.score}/${f.maxScore}`;
        html += `
        <tr style="${isRef ? 'background:#f9fafb;' : ''}">
            <td style="padding:6px 8px; border-bottom:1px solid #eee;">${f.name}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #eee; text-align:center; font-weight:bold;">${f.value}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #eee; text-align:center; color:${scoreColor}; font-weight:bold;">
                ${icon} ${scoreText}
            </td>
            <td style="padding:6px 8px; border-bottom:1px solid #eee; color:#666; font-size:0.9em;">${f.note}</td>
        </tr>`;
    });
    
    html += `</tbody></table>`;
    
    // åˆ©å¤šåˆ©ç©ºæ‘˜è¦
    if (result.positiveFactors.length > 0 || result.negativeFactors.length > 0) {
        html += `<div style="margin-top:12px; display:flex; gap:15px; flex-wrap:wrap;">`;
        
        if (result.positiveFactors.length > 0) {
            html += `<div style="flex:1; min-width:140px; background:#dcfce7; padding:10px; border-radius:8px;">
                <div style="font-weight:bold; color:#16a34a; margin-bottom:5px;">âœ… åˆ©å¤šå› ç´ </div>
                <ul style="margin:0; padding-left:18px; color:#166534; font-size:0.85em;">
                    ${result.positiveFactors.map(f => `<li>${f.name}ï¼š${f.value}</li>`).join('')}
                </ul>
            </div>`;
        }
        
        if (result.negativeFactors.length > 0) {
            html += `<div style="flex:1; min-width:140px; background:#fee2e2; padding:10px; border-radius:8px;">
                <div style="font-weight:bold; color:#dc2626; margin-bottom:5px;">âš ï¸ åˆ©ç©ºå› ç´ </div>
                <ul style="margin:0; padding-left:18px; color:#991b1b; font-size:0.85em;">
                    ${result.negativeFactors.map(f => `<li>${f.name}ï¼š${f.value}</li>`).join('')}
                </ul>
            </div>`;
        }
        
        html += `</div>`;
    }
    
    // æ•¸æ“šä¾†æºèªªæ˜
    const est = result.estimates;
    html += `
    <div style="margin-top:12px; padding:10px; background:#f8fafc; border-radius:8px; font-size:0.8em; color:#64748b;">
        ğŸ“ˆ <strong>æ•¸æ“šä¾†æºï¼š</strong>
        ç†è«–åƒ¹${result.theoKey} + ${result.condKey.includes('æœ‰æ“”ä¿') ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿'}ï¼Œ
        å…±${est.sampleCount}ç­†æ­·å²æ¡ˆä¾‹${est.useRecent ? `ï¼ˆå„ªå…ˆæ¡ç”¨è¿‘æœŸ${est.recentCount}ç­†ï¼‰` : ''}ã€‚
        çµ±è¨ˆæ¨¡å‹åŸºæ–¼${window.overallStats?.totalSamples || totalAuctionCount}ç­†ç«¶æ‹æ•¸æ“šã€‚
    </div>`;
    
    container.innerHTML = html;
    
    // v3.73 æ–°å¢ï¼šå³æ™‚æ›´æ–°AIæ™ºèƒ½é æ¸¬å€å¡Š
    updateLiveAIPrediction(theoPrice, issueSize, guarantee, broker, industry, tcri);
}

/**
 * v3.73 å³æ™‚æ›´æ–°AIæ™ºèƒ½é æ¸¬å€å¡Šï¼ˆé‡æ–°è¨­è¨ˆï¼‰
 * æ ¸å¿ƒæ”¹é€²ï¼š
 * 1. ä»¥ã€Œå¹´æœŸ+æ“”ä¿ã€çµ„åˆç‚ºåŸºæº–
 * 2. åƒè€ƒå¸‚å ´æ°›åœä¸‰æ¢ä»¶åŠ æ¬Šï¼ˆç”¢æ¥­35%ã€è¦æ¨¡25%ã€ä¿¡è©•15%ï¼‰
 * 3. æ™ºèƒ½åˆ¤åˆ¥ï¼šç†è«–åƒ¹<100æ™‚æ”¹ç”¨ã€Œåƒ¹æ ¼æ³•ã€ï¼Œ>=100æ™‚ç”¨ã€Œæº¢åƒ¹ç‡æ³•ã€
 * 4. ç¢ºä¿å»ºè­°å‡ºåƒ¹èˆ‡é æœŸæœ€ä½å¾—æ¨™ä¸€è‡´
 */
function updateLiveAIPrediction(theoPrice, issueSize, guarantee, broker, industry, tcri) {
    const container = document.getElementById('liveAIPrediction');
    if (!container) return;
    
    if (!theoPrice || theoPrice <= 0) {
        container.innerHTML = '<div style="color:#666; padding:10px;">è«‹å¡«å¯«æ¢ä»¶å¾Œå³æ™‚é¡¯ç¤ºé æ¸¬çµæœ</div>';
        return;
    }
    
    // å–å¾—åº•æ¨™åƒ¹æ ¼å’Œå¹´æœŸ
    const floorPrice = safeFloat(document.getElementById('floorPrice')?.value) || 100;
    const years = parseInt(document.getElementById('years')?.value) || 3;
    const rating = tcri || document.getElementById('rating')?.value || '';
    
    // ç¢ºå®šæ“”ä¿é¡å‹
    const guarType = guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    
    // èª¿ç”¨æŠ•æ¨™å€æ•¸é ä¼°å‡½æ•¸ï¼ˆå·²åŒ…å«æ“”ä¿é¡å‹åŸºæº–ï¼‰
    const multResult = estimateBidMultiple({
        issueSize: issueSize,
        guarantee: guarType,
        years: years,
        theoreticalPrice: theoPrice,
        industry: industry ? industry.split(' ')[0] : '',
        broker: broker ? broker.split(' ')[0] : '',
        rating: rating
    });
    
    // æŸ¥è¡¨å–å¾—é æœŸå¾—æ¨™åƒ¹ï¼ˆé€™æ˜¯æ ¸å¿ƒé æ¸¬ï¼‰
    const priceExpect = getExpectedPriceByMult(multResult.estimatedMult);
    
    // ===== æ™ºèƒ½åˆ¤åˆ¥ï¼šé¸æ“‡è¨ˆç®—æ–¹æ³• =====
    // v3.75 é‡æ–°è¨­è¨ˆï¼šä¸‰ç¨®ç­–ç•¥åŸºæ–¼ã€Œæœ€ä½å¾—æ¨™~å¹³å‡å¾—æ¨™ã€å€é–“
    // ä¿å®ˆå‹ = é æœŸæœ€ä½å¾—æ¨™ï¼ˆé–€æª»åƒ¹ï¼Œæœ‰æ©Ÿæœƒå¾—æ¨™ï¼‰
    // å¹³è¡¡å‹ = (æœ€ä½+å¹³å‡)/2ï¼ˆæœ€ä½³æ€§åƒ¹æ¯”ï¼‰
    // ç©æ¥µå‹ = é æœŸå¹³å‡å¾—æ¨™ï¼ˆç©©å®šå¾—æ¨™ï¼‰
    
    let aggressivePrice, balancedPrice, conservativePrice;
    let aggressivePremium, balancedPremium, conservativePremium;
    let calcMethod = '';
    let methodNote = '';
    
    // æ ¸å¿ƒæ•¸æ“šï¼šå¾æŠ•æ¨™å€æ•¸æŸ¥è¡¨å–å¾—åˆç†å€é–“
    const expectedMinBid = priceExpect.minPrice;  // é æœŸæœ€ä½å¾—æ¨™ï¼ˆä¿å®ˆåŸºæº–ï¼‰
    const expectedAvgBid = priceExpect.avgPrice;  // é æœŸå¹³å‡å¾—æ¨™ï¼ˆç©æ¥µåŸºæº–ï¼‰
    const priceGap = priceExpect.gap;             // å·®è·ï¼ˆç´„1.5-2å…ƒï¼‰
    
    // v3.81 ä¿®æ­£ï¼šæ™ºèƒ½è™•ç†ä¸åŒç†è«–åƒ¹æƒ…æ³
    // æ ¸å¿ƒåŸå‰‡ï¼šå»ºè­°å‡ºåƒ¹ >= max(åº•æ¨™, ç†è«–åƒ¹)ï¼Œä¸”ä¸‰ç¨®ç­–ç•¥è¦æœ‰åˆç†å·®è·
    const minBidFloor = Math.max(floorPrice, theoPrice);
    
    // ä¸‰ç¨®ç­–ç•¥å®šç¾©
    if (expectedMinBid >= theoPrice) {
        // æ­£å¸¸æƒ…æ³ï¼šæŸ¥è¡¨åƒ¹æ ¼ >= ç†è«–åƒ¹ï¼Œç›´æ¥ä½¿ç”¨æŸ¥è¡¨çµæœ
        conservativePrice = Math.max(expectedMinBid, floorPrice);
        aggressivePrice = Math.max(expectedAvgBid, floorPrice);
        balancedPrice = (conservativePrice + aggressivePrice) / 2;
        
        calcMethod = 'æŸ¥è¡¨æ³•';
        methodNote = `æŠ•æ¨™å€æ•¸${multResult.estimatedMult.toFixed(2)}xå°æ‡‰æ­·å²å€é–“`;
    } else {
        // é«˜ç†è«–åƒ¹æƒ…æ³ï¼šæŸ¥è¡¨åƒ¹æ ¼ < ç†è«–åƒ¹
        // v3.81 å„ªåŒ–ï¼šå›æ¸¬ç™¼ç¾100-110å…ƒå€é–“å¾—æ¨™ç‡åªæœ‰58.9%ï¼Œéœ€è¦æ›´ç©æ¥µ
        
        // æ ¹æ“šç†è«–åƒ¹å€é–“èª¿æ•´ç¸®æ¸›ä¿‚æ•¸
        let scaleFactor = 0.5;  // åŸºç¤ç¸®æ¸›ä¿‚æ•¸
        let extraPremium = 0;   // é¡å¤–æº¢åƒ¹è£œå„Ÿ
        
        if (theoPrice >= 100 && theoPrice < 110) {
            // 100-110å…ƒå€é–“ï¼šå›æ¸¬å¾—æ¨™ç‡æœ€ä½ï¼Œéœ€è¦æ›´ç©æ¥µ
            scaleFactor = 0.7;  // æé«˜ç¸®æ¸›ä¿‚æ•¸
            extraPremium = 1.5; // é¡å¤–+1.5å…ƒ
        } else if (theoPrice >= 110 && theoPrice < 115) {
            scaleFactor = 0.6;
            extraPremium = 1.0;
        } else if (theoPrice >= 115) {
            scaleFactor = 0.5;  // è¶…é«˜ç†è«–åƒ¹ç¶­æŒåŸé‚è¼¯
        }
        
        const histMinPremium = ((expectedMinBid / 100) - 1) * 100 * scaleFactor;
        const histAvgPremium = ((expectedAvgBid / 100) - 1) * 100 * scaleFactor;
        
        // ç¢ºä¿å€é–“å·®è·è‡³å°‘æ˜¯ priceGap * 0.8
        const minSpread = priceGap * 0.8;
        
        conservativePrice = Math.max(theoPrice * (1 + histMinPremium / 100) + extraPremium, theoPrice, floorPrice);
        aggressivePrice = Math.max(
            theoPrice * (1 + histAvgPremium / 100) + extraPremium, 
            conservativePrice + minSpread,
            floorPrice
        );
        balancedPrice = (conservativePrice + aggressivePrice) / 2;
        
        calcMethod = 'æº¢åƒ¹ç‡æ³•';
        methodNote = `ç†è«–åƒ¹${theoPrice.toFixed(1)}å…ƒè¼ƒé«˜ï¼Œå¥—ç”¨å„ªåŒ–æº¢åƒ¹ç‡`;
    }
    
    // è¨ˆç®—æº¢åƒ¹ç‡ï¼ˆç›¸å°æ–¼åº•æ¨™æˆ–ç†è«–åƒ¹ï¼‰
    const basePrice = Math.max(theoPrice, floorPrice);
    conservativePremium = ((conservativePrice / basePrice) - 1) * 100;
    balancedPremium = ((balancedPrice / basePrice) - 1) * 100;
    aggressivePremium = ((aggressivePrice / basePrice) - 1) * 100;
    
    // v3.75 ä¿ç•™æ’åºç¢ºä¿é †åºæ­£ç¢ºï¼ˆä¿å®ˆ < å¹³è¡¡ < ç©æ¥µï¼‰
    const priceArray = [
        { type: 'conservative', price: conservativePrice, premium: conservativePremium },
        { type: 'balanced', price: balancedPrice, premium: balancedPremium },
        { type: 'aggressive', price: aggressivePrice, premium: aggressivePremium }
    ].sort((a, b) => a.price - b.price);
    
    conservativePrice = priceArray[0].price;
    conservativePremium = priceArray[0].premium;
    balancedPrice = priceArray[1].price;
    balancedPremium = priceArray[1].premium;
    aggressivePrice = priceArray[2].price;
    aggressivePremium = priceArray[2].premium;
    
    // ç†±åº¦æ¨™ç±¤
    const heatLevel = multResult.estimatedMult >= 3.5 ? 'ğŸ”¥ç†±é–€' : (multResult.estimatedMult >= 2.5 ? 'âš¡åç†±' : (multResult.estimatedMult >= 1.5 ? 'ğŸ˜ä¸€èˆ¬' : 'â„ï¸å†·é–€'));
    const heatColor = multResult.estimatedMult >= 3.5 ? '#ef4444' : (multResult.estimatedMult >= 2.5 ? '#f97316' : (multResult.estimatedMult >= 1.5 ? '#eab308' : '#22c55e'));
    
    // æ“”ä¿é¡å‹æ¨™ç±¤é¡è‰²
    const guarColor = guarType === 'æœ‰æ“”ä¿' ? '#16a34a' : '#ea580c';
    const guarBg = guarType === 'æœ‰æ“”ä¿' ? '#dcfce7' : '#ffedd5';
    
    // ç”Ÿæˆå› å­åˆ†æHTMLï¼ˆåŒ…å«æ¬Šé‡ï¼‰
    let factorHTML = '';
    if (multResult.adjustments && multResult.adjustments.length > 0) {
        factorHTML = multResult.adjustments.map(adj => {
            const valueColor = adj.value > 0.1 ? '#16a34a' : (adj.value < -0.1 ? '#dc2626' : '#666');
            const sign = adj.value >= 0 ? '+' : '';
            return `
                <div style="display:flex; justify-content:space-between; padding:4px 8px; background:#f8fafc; border-radius:4px; margin-bottom:3px; font-size:11px;">
                    <span style="color:#666;">
                        <b>${adj.factor}</b>ï¼ˆ${adj.weight}ï¼‰ï¼š${adj.label}
                    </span>
                    <span style="color:${valueColor}; font-weight:bold;">
                        ${sign}${adj.value.toFixed(2)}å€
                        <span style="color:#999; font-size:10px;">(åƒè€ƒ${adj.ref.toFixed(2)}x, n=${adj.count})</span>
                    </span>
                </div>`;
        }).join('');
    }
    
    // è¨ˆç®—æ–¹æ³•èªªæ˜
    const methodColor = calcMethod === 'åƒ¹æ ¼æ³•' ? '#7c3aed' : '#059669';
    
    // å‹•æ…‹å¸‚å ´å›é¥‹æç¤º
    let momentumBadge = '';
    if (multResult.momentumInfo) {
        const mColor = multResult.momentumInfo.adjustment > 0 ? '#dc2626' : '#0891b2';
        const mSign = multResult.momentumInfo.adjustment >= 0 ? '+' : '';
        momentumBadge = `
            <div style="background:${mColor}; padding:2px 8px; border-radius:10px; font-size:10px; margin-left:6px;">
                ğŸ“¡ ${multResult.momentumInfo.trend}
            </div>`;
    }
    
    // ç”ŸæˆHTML
    container.innerHTML = `
    ${multResult.momentumInfo ? `
    <!-- å‹•æ…‹å¸‚å ´å›é¥‹æç¤º -->
    <div style="background:linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); border:1px solid #e91e63; border-radius:8px; padding:8px 12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:11px; color:#880e4f;">
            ğŸ“¡ <b>å‹•æ…‹å›é¥‹å·²å•Ÿç”¨</b>ï¼šæ ¹æ“šè¿‘ ${multResult.momentumInfo.sampleCount} æª”é–‹æ¨™çµæœï¼Œå¸‚å ´æ°›åœ <b>${multResult.momentumInfo.trend}</b>
        </div>
        <div style="font-size:12px; font-weight:bold; color:#c2185b;">
            ${multResult.momentumInfo.adjustment >= 0 ? 'â†‘' : 'â†“'} ${Math.abs(multResult.momentumInfo.adjustment * 100).toFixed(0)}%
        </div>
    </div>
    ` : ''}
    
    <!-- é ä¼°æŠ•æ¨™å€æ•¸å€å¡Š -->
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:10px; padding:14px; margin-bottom:12px; color:white;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-size:13px; opacity:0.9;">ğŸ“Š é ä¼°æŠ•æ¨™å€æ•¸</div>
            <div style="display:flex; align-items:center;">
                <div style="background:rgba(255,255,255,0.2); padding:3px 10px; border-radius:15px; font-size:11px;">
                    ${priceExpect.range}
                </div>
                ${momentumBadge}
            </div>
        </div>
        <div style="display:flex; align-items:baseline; gap:6px;">
            <span style="font-size:36px; font-weight:bold;">${multResult.estimatedMult.toFixed(2)}</span>
            <span style="font-size:16px; opacity:0.8;">å€</span>
            <span style="background:${heatColor}; padding:2px 8px; border-radius:10px; font-size:12px; margin-left:8px;">
                ${heatLevel}
            </span>
        </div>
        <div style="font-size:12px; opacity:0.9; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.2);">
            åˆç†å€é–“ï¼š<b style="font-size:16px;">${expectedMinBid.toFixed(2)}</b> ~ <b style="font-size:16px;">${expectedAvgBid.toFixed(2)}</b> å…ƒ
            <span style="opacity:0.7; font-size:10px;">ï¼ˆ${priceExpect.range}ï¼Œå·®è·${priceGap.toFixed(1)}å…ƒï¼Œn=${priceExpect.count}ï¼‰</span>
        </div>
    </div>
    
    <!-- å› å­èª¿æ•´åˆ†æ -->
    <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-size:12px; font-weight:bold; color:#334155;">
                ğŸ”¬ æŠ•æ¨™å€æ•¸é ä¼°å› å­åˆ†æ
            </div>
            <div style="font-size:10px; color:#666;">
                åŸºæº–ï¼š<b style="color:${guarColor};">${guarType}+${years}å¹´</b>
            </div>
        </div>
        ${factorHTML || '<div style="color:#999; font-size:11px;">å¡«å¯«æ›´å¤šæ¢ä»¶ï¼ˆç”¢æ¥­ã€è¦æ¨¡ã€ä¿¡è©•ç­‰ï¼‰ä»¥ç²å¾—æ›´æº–ç¢ºé ä¼°</div>'}
        <div style="border-top:1px solid #e2e8f0; margin-top:8px; padding-top:8px; font-size:10px; color:#64748b;">
            åŸºæº– <b>${window.TERM_GUAR_TABLE[multResult.baseKey]?.avgMult.toFixed(2) || '2.98'}</b>
            â†’ èª¿æ•´å¾Œ <b style="color:#6366f1;">${multResult.estimatedMult.toFixed(2)}</b> å€
            <span style="float:right;">ä¿¡å¿ƒåº¦ï¼š${multResult.confidence}</span>
        </div>
    </div>
    
    <!-- å»ºè­°å‡ºåƒ¹ -->
    <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-size:12px; color:#166534;">
                <b>ğŸ’° å»ºè­°å‡ºåƒ¹å€é–“</b>
            </div>
            <div style="font-size:10px; padding:2px 8px; background:${methodColor}20; color:${methodColor}; border-radius:10px;">
                ${calcMethod}
            </div>
        </div>
        <div style="font-size:10px; color:#666; margin-bottom:8px;">
            åˆç†å€é–“ï¼š<b>${expectedMinBid.toFixed(2)}</b> ~ <b>${expectedAvgBid.toFixed(2)}</b> å…ƒï¼ˆå·®è· ${priceGap.toFixed(2)} å…ƒï¼‰
            <span style="color:${methodColor};">ï½œ${methodNote}</span>
        </div>
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">
            <div style="text-align:center; padding:8px; background:#fef3c7; border-radius:6px;">
                <div style="font-size:10px; color:#b45309;">ğŸ›¡ï¸ ä¿å®ˆå‹</div>
                <div style="font-size:18px; font-weight:bold; color:#b45309;">${conservativePrice.toFixed(2)}</div>
                <div style="font-size:9px; color:#666;">æº¢åƒ¹ ${conservativePremium.toFixed(1)}%</div>
                <div style="font-size:9px; color:#b45309;">â‰ˆæœ€ä½å¾—æ¨™</div>
            </div>
            <div style="text-align:center; padding:8px; background:#dbeafe; border-radius:6px; border:2px solid #3b82f6;">
                <div style="font-size:10px; color:#1d4ed8;">âš–ï¸ å¹³è¡¡å‹ â­</div>
                <div style="font-size:18px; font-weight:bold; color:#1d4ed8;">${balancedPrice.toFixed(2)}</div>
                <div style="font-size:9px; color:#666;">æº¢åƒ¹ ${balancedPremium.toFixed(1)}%</div>
                <div style="font-size:9px; color:#1d4ed8;">æœ€ä½³æ€§åƒ¹æ¯”</div>
            </div>
            <div style="text-align:center; padding:8px; background:#dcfce7; border-radius:6px;">
                <div style="font-size:10px; color:#166534;">ğŸ¯ ç©æ¥µå‹</div>
                <div style="font-size:18px; font-weight:bold; color:#15803d;">${aggressivePrice.toFixed(2)}</div>
                <div style="font-size:9px; color:#666;">æº¢åƒ¹ ${aggressivePremium.toFixed(1)}%</div>
                <div style="font-size:9px; color:#16a34a;">â‰ˆå¹³å‡å¾—æ¨™</div>
            </div>
        </div>
        <div style="margin-top:10px; padding:8px; background:#eff6ff; border-radius:6px; font-size:10px; color:#1e40af;">
            ğŸ’¡ <b>ç­–ç•¥é‚è¼¯</b>ï¼šä¿å®ˆ=æœ€ä½å¾—æ¨™é–€æª» / å¹³è¡¡=ä¸­é–“å€¼ï¼ˆæ¨è–¦ï¼‰ / ç©æ¥µ=å¹³å‡å¾—æ¨™ï½œ
            å€é–“å·® ${priceGap.toFixed(2)} å…ƒå¯ä½œç‚ºå­¸ç¿’åƒè€ƒ
        </div>
        ${window.SPREAD_STATS ? `
        <div style="margin-top:8px; padding:8px; background:linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius:6px; font-size:10px; color:#2e7d32;">
            ğŸ“Š <b>åƒ¹å·®åƒè€ƒ</b>ï¼šæ­·å²${window.SPREAD_STATS.total}æª”å¹³å‡åƒ¹å·® <b>${window.SPREAD_STATS.avgSpread.toFixed(2)}å…ƒ</b>ï¼ˆä¸­ä½æ•¸${window.SPREAD_STATS.medianSpread.toFixed(2)}å…ƒï¼‰
            ${(() => {
                const ss = window.SPREAD_STATS;
                let sizeKey = 'over15';
                if (issueSize < 3) sizeKey = 'under3';
                else if (issueSize < 5) sizeKey = '3to5';
                else if (issueSize < 10) sizeKey = '5to10';
                else if (issueSize < 15) sizeKey = '10to15';
                const sizeSpread = ss.bySize[sizeKey];
                if (sizeSpread && sizeSpread.avg) {
                    return `ï½œåŒè¦æ¨¡(${sizeSpread.label})ï¼š<b>${sizeSpread.avg.toFixed(2)}å…ƒ</b>(n=${sizeSpread.count})`;
                }
                return '';
            })()}
        </div>
        ` : ''}
    </div>
    `;
    
    // v3.97m æ–°å¢ï¼šåŒæ­¥æ›´æ–° Step 3 çš„ AI æ™ºèƒ½ç«¶æ‹é æ¸¬å€å¡Š
    const step3AIBlock = document.getElementById('step3AIBlock');
    if (step3AIBlock) {
        step3AIBlock.innerHTML = container.innerHTML;
    }
    
    // v3.75 æ–°å¢ï¼šåŒæ­¥æ›´æ–°ä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹ï¼ˆå‚³å…¥å®Œæ•´æ¢ä»¶åƒæ•¸ï¼‰
    updateMajorPlayerSimulation({
        theoPrice: theoPrice,
        expectedMinBid: expectedMinBid,
        expectedAvgBid: expectedAvgBid,
        priceGap: priceGap,
        estimatedMult: multResult.estimatedMult,
        issueSize: issueSize,
        guarantee: guarType,
        industry: industry,
        broker: broker,
        rating: rating,
        years: years,
        adjustments: multResult.adjustments  // å‚³å…¥å› å­èª¿æ•´æ˜ç´°
    });
}

/**
 * v3.75 é‡æ–°è¨­è¨ˆï¼šæ™ºèƒ½ä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹ï¼ˆæ ¹æ“šæ¢ä»¶å‹•æ…‹èª¿æ•´ï¼‰
 * æ ¸å¿ƒç™¼ç¾ï¼š
 * 1. 94%æƒ…æ³ä¸‹ï¼Œä¸»åŠ›æœ€ä½å‡ºåƒ¹èˆ‡æœ€ä½å¾—æ¨™å·®è· <0.5å…ƒ
 * 2. ä¸»åŠ›ä¹‹é–“åƒ¹å·®èˆ‡ä¸»åŠ›æ•¸é‡ç›¸é—œï¼š1-2ç­†â†’0.76å…ƒ, 3-5ç­†â†’1.58å…ƒ, 6-10ç­†â†’2.73å…ƒ, 10+â†’4.70å…ƒ
 * 3. ç™¼è¡Œè¦æ¨¡ã€ç”¢æ¥­ã€ç†è«–åƒ¹ç­‰æ¢ä»¶æœƒå½±éŸ¿ä¸»åŠ›ç«¶çˆ­ç¨‹åº¦
 */
function updateMajorPlayerSimulation(params) {
    const container = document.getElementById('majorPlayerSimulation');
    if (!container) return;
    
    // è§£æ§‹åƒæ•¸
    const {
        theoPrice = 0,
        expectedMinBid = 0,
        expectedAvgBid = 0,
        priceGap = 2,
        estimatedMult = 2.5,
        issueSize = 0,
        guarantee = 'ç„¡æ“”ä¿',
        industry = '',
        broker = '',
        rating = '',
        years = 3,
        adjustments = []
    } = params || {};
    
    if (!theoPrice || theoPrice <= 0 || !expectedMinBid || expectedMinBid <= 0) {
        container.innerHTML = '<div style="color:#666; padding:10px; text-align:center;">è«‹å…ˆè¼¸å…¥ç†è«–åƒ¹å€é–“æˆ–è‚¡åƒ¹/è½‰æ›åƒ¹</div>';
        return;
    }
    
    // è¨ˆç®—å¯¦éš›å¹³å‡å¾—æ¨™ï¼ˆå¦‚æœæ²’å‚³å…¥å°±ç”¨æœ€ä½å¾—æ¨™+2ï¼‰
    const actualAvgBid = expectedAvgBid > 0 ? expectedAvgBid : expectedMinBid + 2;
    
    // ===== ä¸»åŠ›å‡ºåƒ¹åŸºç¤æ¨¡å‹ï¼ˆåŸºæ–¼75æª”æ­·å²æ•¸æ“šï¼‰=====
    const MAJOR_MODEL = {
        minBidOffset: { mean: 0.18, median: 0.03, pct94: 0.5 },
        priceSpread: {
            low: { range: '1-2ç­†', spread: 0.76, avgQty: 305, label: 'å†·é–€' },
            mid: { range: '3-5ç­†', spread: 1.58, avgQty: 1390, label: 'ä¸€èˆ¬' },
            high: { range: '6-10ç­†', spread: 2.73, avgQty: 1835, label: 'ç†±é–€' },
            veryHigh: { range: '10+ç­†', spread: 4.70, avgQty: 6694, label: 'è¶…ç†±é–€' }
        }
    };
    
    // ===== æ ¹æ“šå„ç¶­åº¦æ¢ä»¶å‹•æ…‹èª¿æ•´ä¸»åŠ›æ•¸é‡é æ¸¬ =====
    let baseLevel = 'mid';  // åŸºæº–ï¼šä¸€èˆ¬ç†±åº¦
    let adjustmentFactors = [];
    let spreadAdjustment = 0;  // åƒ¹å·®èª¿æ•´ï¼ˆå…ƒï¼‰
    let qtyAdjustment = 1.0;   // æ•¸é‡èª¿æ•´ä¿‚æ•¸
    
    // 1. ç™¼è¡Œè¦æ¨¡å½±éŸ¿ï¼ˆå°è¦æ¨¡æ›´ç†±é–€ï¼‰
    if (issueSize > 0) {
        if (issueSize < 5) {
            adjustmentFactors.push({ factor: 'ç™¼è¡Œè¦æ¨¡', label: `${issueSize}å„„ï¼ˆå°è¦æ¨¡ï¼‰`, effect: '+ç†±åº¦', color: '#ef4444' });
            spreadAdjustment += 0.5;
            qtyAdjustment *= 1.3;
        } else if (issueSize >= 5 && issueSize < 10) {
            adjustmentFactors.push({ factor: 'ç™¼è¡Œè¦æ¨¡', label: `${issueSize}å„„ï¼ˆä¸­è¦æ¨¡ï¼‰`, effect: 'ä¸­æ€§', color: '#f59e0b' });
        } else if (issueSize >= 10) {
            adjustmentFactors.push({ factor: 'ç™¼è¡Œè¦æ¨¡', label: `${issueSize}å„„ï¼ˆå¤§è¦æ¨¡ï¼‰`, effect: '-ç†±åº¦', color: '#22c55e' });
            spreadAdjustment -= 0.3;
            qtyAdjustment *= 0.8;
        }
    }
    
    // 2. ç†è«–åƒ¹å½±éŸ¿ï¼ˆé«˜ç†è«–åƒ¹æ›´ç†±é–€ï¼‰
    if (theoPrice >= 130) {
        adjustmentFactors.push({ factor: 'ç†è«–åƒ¹', label: `${theoPrice.toFixed(1)}ï¼ˆæ·±åº¦åƒ¹å…§ï¼‰`, effect: '+ç†±åº¦', color: '#ef4444' });
        spreadAdjustment += 0.8;
        qtyAdjustment *= 1.4;
    } else if (theoPrice >= 110) {
        adjustmentFactors.push({ factor: 'ç†è«–åƒ¹', label: `${theoPrice.toFixed(1)}ï¼ˆåƒ¹å…§ï¼‰`, effect: '+ç†±åº¦', color: '#f97316' });
        spreadAdjustment += 0.4;
        qtyAdjustment *= 1.2;
    } else if (theoPrice < 95) {
        adjustmentFactors.push({ factor: 'ç†è«–åƒ¹', label: `${theoPrice.toFixed(1)}ï¼ˆåƒ¹å¤–ï¼‰`, effect: '-ç†±åº¦', color: '#22c55e' });
        spreadAdjustment -= 0.4;
        qtyAdjustment *= 0.7;
    } else {
        adjustmentFactors.push({ factor: 'ç†è«–åƒ¹', label: `${theoPrice.toFixed(1)}ï¼ˆå¹³åƒ¹å€ï¼‰`, effect: 'ä¸­æ€§', color: '#f59e0b' });
    }
    
    // 3. ç”¢æ¥­å½±éŸ¿
    const hotIndustries = ['é›»å­', 'åŠå°é«”', 'ICè¨­è¨ˆ', 'AI', 'ç¶²é€š'];
    const coldIndustries = ['å‚³ç”¢', 'ç‡Ÿå»º', 'é‡‘è', 'èˆªé‹'];
    const industryName = industry ? industry.split(' ')[0] : '';
    
    if (industryName && hotIndustries.some(h => industryName.includes(h))) {
        adjustmentFactors.push({ factor: 'ç”¢æ¥­', label: `${industryName}ï¼ˆç†±é–€ç”¢æ¥­ï¼‰`, effect: '+ç†±åº¦', color: '#ef4444' });
        spreadAdjustment += 0.3;
        qtyAdjustment *= 1.15;
    } else if (industryName && coldIndustries.some(c => industryName.includes(c))) {
        adjustmentFactors.push({ factor: 'ç”¢æ¥­', label: `${industryName}ï¼ˆå†·é–€ç”¢æ¥­ï¼‰`, effect: '-ç†±åº¦', color: '#22c55e' });
        spreadAdjustment -= 0.2;
        qtyAdjustment *= 0.9;
    } else if (industryName) {
        adjustmentFactors.push({ factor: 'ç”¢æ¥­', label: `${industryName}`, effect: 'ä¸­æ€§', color: '#f59e0b' });
    }
    
    // 4. æ“”ä¿é¡å‹å½±éŸ¿
    if (guarantee === 'æœ‰æ“”ä¿') {
        adjustmentFactors.push({ factor: 'æ“”ä¿', label: 'æœ‰æ“”ä¿', effect: '-ç†±åº¦', color: '#22c55e' });
        spreadAdjustment -= 0.2;
        qtyAdjustment *= 0.85;
    } else {
        adjustmentFactors.push({ factor: 'æ“”ä¿', label: 'ç„¡æ“”ä¿', effect: 'ä¸­æ€§', color: '#f59e0b' });
    }
    
    // ===== æ ¹æ“šæŠ•æ¨™å€æ•¸ç¢ºå®šåŸºç¤ç†±åº¦ç´šåˆ¥ =====
    if (estimatedMult < 1.5) {
        baseLevel = 'low';
    } else if (estimatedMult < 2.5) {
        baseLevel = 'mid';
    } else if (estimatedMult < 4) {
        baseLevel = 'high';
    } else {
        baseLevel = 'veryHigh';
    }
    
    const baseSpreadInfo = MAJOR_MODEL.priceSpread[baseLevel];
    
    // ===== è¨ˆç®—èª¿æ•´å¾Œçš„ä¸»åŠ›å‡ºåƒ¹å€é–“ =====
    const adjustedSpread = Math.max(0.5, baseSpreadInfo.spread + spreadAdjustment);
    const adjustedAvgQty = Math.round(baseSpreadInfo.avgQty * qtyAdjustment);
    
    const majorLowBid = expectedMinBid + MAJOR_MODEL.minBidOffset.median;
    const majorHighBid = majorLowBid + adjustedSpread;
    const majorMidBid = (majorLowBid + majorHighBid) / 2;
    
    const lowPremium = ((majorLowBid / theoPrice) - 1) * 100;
    const highPremium = ((majorHighBid / theoPrice) - 1) * 100;
    const midPremium = ((majorMidBid / theoPrice) - 1) * 100;
    
    // ç«¶çˆ­ç¨‹åº¦é¡è‰²
    let heatColor, heatBg, heatLabel;
    if (estimatedMult < 1.5) {
        heatColor = '#22c55e'; heatBg = '#dcfce7'; heatLabel = 'å†·é–€';
    } else if (estimatedMult < 2.5) {
        heatColor = '#f59e0b'; heatBg = '#fef3c7'; heatLabel = 'ä¸€èˆ¬';
    } else if (estimatedMult < 4) {
        heatColor = '#f97316'; heatBg = '#fed7aa'; heatLabel = 'ç†±é–€';
    } else {
        heatColor = '#dc2626'; heatBg = '#fee2e2'; heatLabel = 'è¶…ç†±é–€';
    }
    
    // ç”Ÿæˆæ¢ä»¶å½±éŸ¿å› å­HTML
    let factorHTML = adjustmentFactors.map(f => `
        <div style="display:flex; justify-content:space-between; padding:4px 8px; background:#f8fafc; border-radius:4px; margin-bottom:3px;">
            <span style="color:#666;"><b>${f.factor}</b>ï¼š${f.label}</span>
            <span style="color:${f.color}; font-weight:bold;">${f.effect}</span>
        </div>
    `).join('');
    
    container.innerHTML = `
    <!-- ä¸»åŠ›å‡ºåƒ¹å€é–“åœ–ç¤º -->
    <div style="background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color:white; padding:12px; border-radius:8px; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div>
                <div style="font-size:11px; opacity:0.9;">é ä¼°ä¸»åŠ›æ•¸é‡</div>
                <div style="font-size:14px; font-weight:bold;">${baseSpreadInfo.range}ï¼ˆ${heatLabel}ï¼‰</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:11px; opacity:0.9;">é ä¼°ä¸»åŠ›ç¸½å¼µæ•¸</div>
                <div style="font-size:14px; font-weight:bold;">${adjustedAvgQty.toLocaleString()} å¼µ</div>
            </div>
        </div>
        <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:6px;">
            <div style="font-size:11px; opacity:0.8; margin-bottom:6px;">ğŸ¯ ä¸»åŠ›å‡ºåƒ¹å€é–“ï¼ˆæ ¹æ“šæœ¬æª”æ¢ä»¶å‹•æ…‹èª¿æ•´ï¼‰</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:center;">
                    <div style="font-size:10px; opacity:0.7;">æœ€ä½å‡ºåƒ¹</div>
                    <div style="font-size:20px; font-weight:bold;">${majorLowBid.toFixed(2)}</div>
                    <div style="font-size:10px; opacity:0.7;">æº¢åƒ¹ ${lowPremium.toFixed(1)}%</div>
                </div>
                <div style="flex:1; padding:0 15px;">
                    <div style="height:8px; background:linear-gradient(to right, #8e24aa, #e91e63); border-radius:4px; position:relative;">
                        <div style="position:absolute; left:50%; transform:translateX(-50%); top:-15px; font-size:9px; white-space:nowrap;">
                            åƒ¹å·® ${adjustedSpread.toFixed(2)}å…ƒ
                        </div>
                    </div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:10px; opacity:0.7;">æœ€é«˜å‡ºåƒ¹</div>
                    <div style="font-size:20px; font-weight:bold;">${majorHighBid.toFixed(2)}</div>
                    <div style="font-size:10px; opacity:0.7;">æº¢åƒ¹ ${highPremium.toFixed(1)}%</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- v3.75 æ–°å¢ï¼šæ¢ä»¶å½±éŸ¿å› å­ -->
    <div style="background:#f3e5f5; border:1px solid #ce93d8; border-radius:8px; padding:10px; margin-bottom:10px;">
        <div style="font-size:12px; font-weight:bold; color:#7b1fa2; margin-bottom:8px;">ğŸ“Š æ¢ä»¶å½±éŸ¿å› å­ï¼ˆå‹•æ…‹èª¿æ•´ä¾æ“šï¼‰</div>
        ${factorHTML}
        <div style="margin-top:6px; padding-top:6px; border-top:1px dashed #ce93d8; font-size:10px; color:#666;">
            ğŸ’¡ åŸºç¤åƒ¹å·®ï¼š${baseSpreadInfo.spread.toFixed(2)}å…ƒ â†’ èª¿æ•´å¾Œï¼š${adjustedSpread.toFixed(2)}å…ƒï¼ˆ${spreadAdjustment >= 0 ? '+' : ''}${spreadAdjustment.toFixed(2)}å…ƒï¼‰
        </div>
    </div>
    
    <!-- ä¸»åŠ›è¡Œç‚ºè§£è®€ -->
    <div style="background:${heatBg}; border:1px solid ${heatColor}40; border-radius:8px; padding:10px; margin-bottom:10px;">
        <div style="font-size:12px; font-weight:bold; color:${heatColor}; margin-bottom:6px;">ğŸ“ˆ ä¸»åŠ›è¡Œç‚ºè§£è®€</div>
        <div style="font-size:11px; color:#333; line-height:1.6;">
            â€¢ <b>æ ¸å¿ƒç™¼ç¾</b>ï¼šä¸»åŠ›æœ€ä½å‡ºåƒ¹ â‰ˆ æœ€ä½å¾—æ¨™åƒ¹ï¼ˆ94%å·®è·<0.5å…ƒï¼‰<br>
            â€¢ <b>ç«¶çˆ­é‚è¼¯</b>ï¼šå°è¦æ¨¡ã€é«˜ç†è«–åƒ¹ã€ç†±é–€ç”¢æ¥­ â†’ ä¸»åŠ›ç«¶çˆ­æ¿€çƒˆ â†’ åƒ¹å·®è¼ƒå¤§<br>
            â€¢ <b>æœ¬æª”é æ¸¬</b>ï¼š${heatLabel}æ¨™çš„ï¼Œèª¿æ•´å¾Œåƒ¹å·®ç´„ ${adjustedSpread.toFixed(2)} å…ƒ
        </div>
    </div>
    
    <!-- æ•£æˆ¶ç­–ç•¥å»ºè­° -->
    <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px;">
        <div style="font-size:12px; font-weight:bold; color:#475569; margin-bottom:6px;">ğŸ’¡ æ•£æˆ¶ç­–ç•¥å»ºè­°</div>
        <div style="font-size:11px; color:#666; line-height:1.6;">
            ${estimatedMult < 2 ? 
            `â€¢ å†·é–€æ¨™çš„ï¼šä¸»åŠ›å°‘ã€åƒ¹å·®å°ï¼Œå¯è€ƒæ…®å‡ºåƒ¹æ¥è¿‘ <b style="color:#9c27b0;">${majorLowBid.toFixed(2)}</b> å…ƒ<br>
             â€¢ è½æ¨™é¢¨éšªè¼ƒä½ï¼Œåƒ¹æ ¼æ§åˆ¶ç©ºé–“è¼ƒå¤§` :
            estimatedMult < 3.5 ?
            `â€¢ ä¸­ç­‰ç†±åº¦ï¼šå»ºè­°å‡ºåƒ¹åœ¨ <b style="color:#9c27b0;">${majorMidBid.toFixed(2)}</b> å…ƒå·¦å³<br>
             â€¢ ä¸»åŠ›ç«¶çˆ­é©ä¸­ï¼Œéœ€é ç•™åƒ¹å·®ç©ºé–“` :
            `â€¢ è¶…ç†±é–€æ¨™çš„ï¼šä¸»åŠ›ç«¶çˆ­æ¿€çƒˆï¼Œå»ºè­°å‡ºåƒ¹æ¥è¿‘ <b style="color:#9c27b0;">${majorHighBid.toFixed(2)}</b> å…ƒ<br>
             â€¢ è‹¥å …æŒä½åƒ¹å¯èƒ½è½æ¨™ï¼Œéœ€è©•ä¼°æ˜¯å¦å€¼å¾—è¿½é«˜`}
        </div>
        <div style="margin-top:8px; padding-top:8px; border-top:1px dashed #e2e8f0; font-size:10px; color:#94a3b8;">
            ğŸ“ˆ åˆç†å€é–“ï¼š${expectedMinBid.toFixed(2)} ~ ${actualAvgBid.toFixed(2)} å…ƒ ï½œ é ä¼°å€æ•¸ï¼š${estimatedMult.toFixed(2)}x
        </div>
    </div>
    `;
}

/**
 * å–å¾—ç†è«–åƒ¹å€é–“key
 */
function getTheoPriceKey(theoPrice) {
    if (theoPrice < 90) return 'å°æ–¼90å…ƒ';
    if (theoPrice < 95) return '90~95å…ƒ';
    if (theoPrice < 100) return '95~100å…ƒ';
    if (theoPrice < 105) return '100~105å…ƒ';
    if (theoPrice < 110) return '105~110å…ƒ';
    if (theoPrice < 115) return '110~115å…ƒ';
    return 'å¤§æ–¼115å…ƒ';
}

/**
 * æ ¹æ“šåŸºç¤åƒ¹æ ¼è¨ˆç®—å¯¦éš›æŠ•æ¨™åƒ¹æ ¼
 * v3.72 ä¿®æ­£ï¼šåŸºç¤åƒ¹æ ¼ = max(åº•æ¨™, ç†è«–åƒ¹)
 * @param {number} theoPrice - ç†è«–åƒ¹æ ¼
 * @param {number} premium - æº¢åƒ¹%ï¼ˆç›¸å°æ–¼åŸºç¤åƒ¹ï¼‰
 * @param {number} floorPrice - åº•æ¨™åƒ¹æ ¼
 * @returns {number} æŠ•æ¨™åƒ¹æ ¼
 */
function calcMajorBidPrice(theoPrice, premium, floorPrice) {
    // åŸºç¤åƒ¹ = max(ç†è«–åƒ¹, åº•æ¨™)
    const basePrice = Math.max(theoPrice, floorPrice);
    // æŠ•æ¨™åƒ¹ = åŸºç¤åƒ¹ Ã— (1 + æº¢åƒ¹%)
    const bidPrice = basePrice * (1 + premium / 100);
    return Math.round(bidPrice * 100) / 100;
}

/**
 * ç”Ÿæˆä¸»åŠ›æ¨¡æ“¬å‡ºåƒ¹é¢æ¿HTML
 * v3.73 é‡å¯«ï¼šåŸºæ–¼ç†è«–åƒ¹çš„ä¸»åŠ›æ¨¡æ“¬
 * @param {object} mpResult - ä¸»åŠ›é æ¸¬çµæœ
 * @param {number} floorPrice - åº•æ¨™åƒ¹æ ¼
 * @param {number} theoPrice - ç†è«–åƒ¹æ ¼
 * @returns {string} HTMLå­—ä¸²
 */
function generateMajorPlayerHTML(mpResult, floorPrice, theoPrice, guarantee) {
    if (!mpResult) return '';
    
    const fp = parseFloat(floorPrice) || 100;
    const tp = parseFloat(theoPrice) || mpResult.theoPrice || 100;
    
    // v3.75ï¼šç¢ºä¿åƒ¹æ ¼é †åºæ­£ç¢ºï¼ˆä¿å®ˆ < å¹³è¡¡ < ç©æ¥µï¼‰
    let rawPrices = [
        { type: 'conservative', price: Math.max(mpResult.conservativePrice || fp, fp), premium: mpResult.conservativePremium || 0 },
        { type: 'balanced', price: Math.max(mpResult.balancedPrice || fp, fp), premium: mpResult.balancedPremium || 0 },
        { type: 'aggressive', price: Math.max(mpResult.aggressivePrice || fp, fp), premium: mpResult.aggressivePremium || 0 }
    ].sort((a, b) => a.price - b.price);
    
    // æ’åºå¾Œé‡æ–°è³¦å€¼ï¼šæœ€ä½=ä¿å®ˆï¼Œä¸­é–“=å¹³è¡¡ï¼Œæœ€é«˜=ç©æ¥µ
    const conservativePrice = rawPrices[0].price;
    const conservativePremium = rawPrices[0].premium;
    const balancedPrice = rawPrices[1].price;
    const balancedPremium = rawPrices[1].premium;
    const aggressivePrice = rawPrices[2].price;
    const aggressivePremium = rawPrices[2].premium;
    
    // ä¿¡å¿ƒåº¦æ¨£å¼
    const confClass = mpResult.confidence === 'é«˜' ? 'high' : (mpResult.confidence === 'ä¸­' ? 'medium' : 'low');
    const confIcon = mpResult.confidence === 'é«˜' ? 'â­â­â­' : (mpResult.confidence === 'ä¸­' ? 'â­â­' : 'â­');
    
    // ç†±åº¦æ¨™ç±¤é¡è‰²
    const heatColor = mpResult.heatColor || '#eab308';
    
    // ç”Ÿæˆå› å­åˆ†æHTML
    let factorHTML = '';
    if (mpResult.adjustments && mpResult.adjustments.length > 0) {
        factorHTML = mpResult.adjustments.map(adj => {
            const valueColor = adj.value > 0.1 ? '#22c55e' : (adj.value < -0.1 ? '#ef4444' : '#666');
            const sign = adj.value >= 0 ? '+' : '';
            return `
                <div style="display:flex; justify-content:space-between; padding:4px 8px; background:#f8fafc; border-radius:4px; margin-bottom:4px;">
                    <span style="color:#666;">${adj.factor}ï¼š<b>${adj.label}</b></span>
                    <span style="color:${valueColor}; font-weight:bold;">${sign}${adj.value.toFixed(2)}å€ <span style="color:#999; font-size:10px;">(åƒè€ƒ${adj.ref?.toFixed(2) || '-'}x, n=${adj.count})</span></span>
                </div>`;
        }).join('');
    }
    
    const html = `
    <div class="major-player-panel">
        <div class="major-player-header">
            ğŸ¯ v3.73 AIæ™ºèƒ½ç«¶æ‹é æ¸¬
            <span style="float:right; font-size:12px; font-weight:normal;">${mpResult.dataSource || 'åŸºæ–¼${totalAuctionCount}æª”ç«¶æ‹çµ±è¨ˆ'}</span>
        </div>
        <div class="major-player-content">
            <!-- æŠ•æ¨™å€æ•¸é ä¼°å€å¡Šï¼ˆæ ¸å¿ƒæ–°åŠŸèƒ½ï¼‰ -->
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; padding:16px; margin-bottom:15px; color:white;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="font-size:14px; opacity:0.9;">ğŸ“Š é ä¼°æŠ•æ¨™å€æ•¸</div>
                    <div style="background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:20px; font-size:12px;">
                        ${mpResult.multRange || '2-3å€'}
                    </div>
                </div>
                <div style="display:flex; align-items:baseline; gap:8px;">
                    <span style="font-size:42px; font-weight:bold;">${mpResult.estimatedMult?.toFixed(2) || '2.98'}</span>
                    <span style="font-size:20px; opacity:0.8;">å€</span>
                    <span style="background:${heatColor}; padding:3px 10px; border-radius:12px; font-size:13px; margin-left:10px;">
                        ${mpResult.heatLevel || 'ä¸€èˆ¬'}
                    </span>
                </div>
                <div style="font-size:12px; opacity:0.8; margin-top:8px;">
                    åˆç†å€é–“ï¼š<b style="font-size:16px;">${mpResult.expectedMinBid?.toFixed(2) || '106.43'}</b> ~ <b style="font-size:16px;">${mpResult.expectedAvgBid?.toFixed(2) || '108.51'}</b> å…ƒ
                    <span style="opacity:0.7;">ï¼ˆå·®è· ${mpResult.priceGap?.toFixed(2) || '2'}å…ƒï¼‰</span>
                </div>
            </div>
            
            <!-- å› å­åˆ†ææ˜ç´° -->
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:12px; margin-bottom:15px;">
                <div style="font-size:13px; font-weight:bold; color:#334155; margin-bottom:10px;">
                    ğŸ”¬ æŠ•æ¨™å€æ•¸é ä¼°å› å­åˆ†æ
                </div>
                ${factorHTML || '<div style="color:#999; font-size:12px;">ç„¡å¯ç”¨å› å­æ•¸æ“š</div>'}
                <div style="border-top:1px solid #e2e8f0; margin-top:8px; padding-top:8px; font-size:11px; color:#64748b;">
                    åŸºæº–å€æ•¸ 2.98ï¼ˆ${totalAuctionCount}æª”å¹³å‡ï¼‰â†’ é ä¼° <b style="color:#6366f1;">${mpResult.estimatedMult?.toFixed(2) || '2.98'}</b> å€
                </div>
            </div>
            
            <!-- å»ºè­°å‡ºåƒ¹å€å¡Šï¼ˆv3.75 é‡æ–°è¨­è¨ˆï¼‰-->
            <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:12px; margin-bottom:15px;">
                <div style="font-size:13px; color:#166534; margin-bottom:8px;">
                    <b>ğŸ’° å»ºè­°å‡ºåƒ¹å€é–“</b>ï¼ˆåŸºæ–¼ ${mpResult.multRange || '2-3å€'} æ­·å²æ•¸æ“šï¼Œn=${mpResult.histSampleCount || '-'}ï¼‰
                </div>
                <div style="display:flex; gap:20px; flex-wrap:wrap; font-size:12px; margin-bottom:10px;">
                    <div>
                        <span style="color:#666;">æœ€ä½å¾—æ¨™ï¼š</span>
                        <b style="color:#b45309;">${mpResult.expectedMinBid?.toFixed(2) || '-'} å…ƒ</b>
                    </div>
                    <div>
                        <span style="color:#666;">å¹³å‡å¾—æ¨™ï¼š</span>
                        <b style="color:#16a34a;">${mpResult.expectedAvgBid?.toFixed(2) || '-'} å…ƒ</b>
                    </div>
                    <div>
                        <span style="color:#666;">å€é–“å·®è·ï¼š</span>
                        <b style="color:#7c3aed;">${mpResult.priceGap?.toFixed(2) || '-'} å…ƒ</b>
                    </div>
                </div>
            </div>
            
            <div class="major-player-main">
                <div class="major-player-strategies" style="width:100%;">
                    <div class="mp-strategy-grid">
                        <div class="mp-strategy-card safe">
                            <h5>ğŸ›¡ï¸ ä¿å®ˆå‹</h5>
                            <div class="mp-price">${conservativePrice.toFixed(2)}</div>
                            <div class="mp-rate">æº¢åƒ¹ ${conservativePremium.toFixed(2)}%</div>
                            <div class="mp-rate" style="color:#f59e0b; font-size:11px;">â‰ˆæœ€ä½å¾—æ¨™</div>
                        </div>
                        <div class="mp-strategy-card stable">
                            <h5>âš–ï¸ å¹³è¡¡å‹</h5>
                            <div class="mp-price">${balancedPrice.toFixed(2)}</div>
                            <div class="mp-rate">æº¢åƒ¹ ${balancedPremium.toFixed(2)}%</div>
                            <div class="mp-rate" style="color:#3b82f6; font-size:11px;">æœ€ä½³æ€§åƒ¹æ¯”</div>
                        </div>
                        <div class="mp-strategy-card sniper">
                            <h5>ğŸ¯ ç©æ¥µå‹</h5>
                            <div class="mp-price">${aggressivePrice.toFixed(2)}</div>
                            <div class="mp-rate">æº¢åƒ¹ ${aggressivePremium.toFixed(2)}%</div>
                            <div class="mp-rate" style="color:#22c55e; font-size:11px;">â‰ˆå¹³å‡å¾—æ¨™</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mp-confidence-bar ${confClass}">
                <span style="font-weight:bold;">é æ¸¬ä¿¡å¿ƒåº¦ï¼š${mpResult.confidence} ${confIcon}</span>
                <span style="margin-left:15px; font-size:12px;">
                    ${mpResult.confidence === 'é«˜' ? 'å¤šå› å­æ¨£æœ¬å……è¶³ï¼Œé æ¸¬è¼ƒå¯é ' : 
                      mpResult.confidence === 'ä¸­' ? 'éƒ¨åˆ†å› å­æ¨£æœ¬è¼ƒå°‘ï¼Œå¯ä½œåƒè€ƒ' : 
                      'æ¨£æœ¬ä¸è¶³ï¼Œå»ºè­°è¬¹æ…åƒè€ƒ'}
                </span>
            </div>
            
            <div style="background:#fef3c7; border-radius:8px; padding:12px; margin-top:12px;">
                <div style="font-size:13px; font-weight:bold; color:#92400e; margin-bottom:8px;">ğŸ’¡ ç­–ç•¥é‚è¼¯èªªæ˜</div>
                <ul style="margin:0; padding-left:18px; color:#78350f; font-size:12px; line-height:1.6;">
                    <li><b>ä¿å®ˆå‹</b> = é æœŸæœ€ä½å¾—æ¨™ï¼ˆé–€æª»åƒ¹ï¼Œæœ‰æ©Ÿæœƒå¾—æ¨™ä½†å¯èƒ½è½æ¨™ï¼‰</li>
                    <li><b>å¹³è¡¡å‹</b> = (æœ€ä½+å¹³å‡)/2ï¼ˆæœ€ä½³æ€§åƒ¹æ¯”ï¼Œæ¨è–¦ï¼‰</li>
                    <li><b>ç©æ¥µå‹</b> = é æœŸå¹³å‡å¾—æ¨™ï¼ˆç©©å®šå¾—æ¨™ï¼Œæˆæœ¬è¼ƒé«˜ï¼‰</li>
                    <li>å€é–“å·®è·ç´„ ${mpResult.priceGap?.toFixed(1) || '1.5-2'} å…ƒï¼Œå¯ä½œç‚ºå‹•æ…‹å­¸ç¿’åƒè€ƒ</li>
                </ul>
            </div>
        </div>
    </div>`;
    
    return html;
}

/**
 * æ›´æ–°å¾—æ¨™æ©Ÿç‡è¨ˆç®—å™¨
 * v3.72 ä¿®æ­£ï¼šä»¥ç†è«–åƒ¹ç‚ºåŸºç¤è¨ˆç®—æº¢åƒ¹ï¼Œå€åˆ†æœ‰æ“”ä¿/ç„¡æ“”ä¿
 */
function updateWinRateCalc(theoPrice, floorPrice, predictedPremium, guarantee) {
    const bidPrice = parseFloat(document.getElementById('mpUserBidPrice').value) || floorPrice;
    const basePrice = Math.max(theoPrice, floorPrice);
    // æº¢åƒ¹æ˜¯ç›¸å°æ–¼åŸºç¤åƒ¹è¨ˆç®—çš„
    const userPremium = ((bidPrice / basePrice) - 1) * 100;
    const result = estimateWinRate(userPremium, predictedPremium);
    
    const resultEl = document.getElementById('mpWinRateResult');
    if (resultEl) {
        resultEl.style.background = result.color;
        resultEl.textContent = `é ä¼°æ©Ÿç‡: ${result.rate}`;
    }
    
    // æ›´æ–°å‡ºåƒ¹é¢¨éšªè©•ä¼°ï¼ˆå€åˆ†æœ‰æ“”ä¿/ç„¡æ“”ä¿ï¼‰
    updateBidRiskAssessment(userPremium, theoPrice, guarantee || 'ç„¡æ“”ä¿');
}

/**
 * å‡ºåƒ¹é¢¨éšªè©•ä¼°å‡½æ•¸
 * v3.72 ä¿®æ”¹ï¼šæ”¹ç”¨å‹•æ…‹è¨ˆç®—çš„çµ±è¨ˆæ•¸æ“š
 * åŸºæ–¼æ­·å²CBç«¶æ‹çµ±è¨ˆï¼Œå€åˆ†æœ‰æ“”ä¿/ç„¡æ“”ä¿ï¼Œè¨ˆç®—ç”¨æˆ¶å‡ºåƒ¹åœ¨æ­·å²æ•¸æ“šä¸­çš„ä½ç½®
 * @param {number} userPremium - ç”¨æˆ¶çš„æº¢åƒ¹%
 * @param {number} theoPrice - ç†è«–åƒ¹æ ¼
 * @param {string} guarantee - æ“”ä¿é¡å‹ï¼ˆæœ‰æ“”ä¿/ç„¡æ“”ä¿ï¼‰
 */
function updateBidRiskAssessment(userPremium, theoPrice, guarantee) {
    // v3.72 ä½¿ç”¨å‹•æ…‹è¨ˆç®—çš„çµ±è¨ˆæ•¸æ“š
    const guaranteedStats = window.guaranteedStats || {};
    const unguaranteedStats = window.unguaranteedStats || {};
    
    // åˆ¤æ–·ç†è«–åƒ¹å€é–“
    let theoKey = '>=110';
    if (theoPrice < 95) theoKey = '<95';
    else if (theoPrice < 100) theoKey = '95-100';
    else if (theoPrice < 105) theoKey = '100-105';
    else if (theoPrice < 110) theoKey = '105-110';
    
    // æ ¹æ“šæ“”ä¿é¡å‹é¸æ“‡çµ±è¨ˆè¡¨
    const isGuaranteed = guarantee === 'æœ‰æ“”ä¿';
    const statsTable = isGuaranteed ? guaranteedStats : unguaranteedStats;
    
    // é è¨­çµ±è¨ˆå€¼ï¼ˆç•¶æ²’æœ‰å‹•æ…‹æ•¸æ“šæ™‚ä½¿ç”¨ï¼‰
    const defaultStats = { mean: 5.0, std: 5.0, n: 0, p10: 0, p25: 1, p50: 5, p75: 9, p90: 12 };
    const stats = statsTable[theoKey] || defaultStats;
    const guarLabel = isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    
    // è¨ˆç®—Z-scoreï¼ˆåé›¢å‡å€¼å¹¾å€‹æ¨™æº–å·®ï¼‰
    const zScore = (userPremium - stats.mean) / stats.std;
    const absZ = Math.abs(zScore);
    
    // è¨ˆç®—ç™¾åˆ†ä½ä½ç½®
    let percentile = 50;
    let riskLevel = 'ä¸­ç­‰';
    let riskColor = '#eab308';
    let riskIcon = 'âš–ï¸';
    let riskNote = '';
    
    if (userPremium <= stats.p10) {
        percentile = 10;
        riskLevel = 'æ¥µä½';
        riskColor = '#22c55e';
        riskIcon = 'âœ…';
        riskNote = 'å‡ºåƒ¹ä½æ–¼æ­·å²æœ€ä½10%ï¼Œå¾—æ¨™æ©Ÿç‡è¼ƒä½ä½†é¢¨éšªå¯æ§';
    } else if (userPremium <= stats.p25) {
        percentile = 25;
        riskLevel = 'åä½';
        riskColor = '#84cc16';
        riskIcon = 'ğŸ‘';
        riskNote = 'å‡ºåƒ¹ä½æ–¼æ­·å²25%åˆ†ä½ï¼Œå¾—æ¨™æ©Ÿç‡ä¸­ä½';
    } else if (userPremium <= stats.p50) {
        percentile = 50;
        riskLevel = 'ä¸­ç­‰åä½';
        riskColor = '#eab308';
        riskIcon = 'âš–ï¸';
        riskNote = 'å‡ºåƒ¹æ¥è¿‘æ­·å²ä¸­ä½æ•¸ï¼Œé¢¨éšªèˆ‡æ©Ÿæœƒå‡è¡¡';
    } else if (userPremium <= stats.p75) {
        percentile = 75;
        riskLevel = 'ä¸­ç­‰åé«˜';
        riskColor = '#f97316';
        riskIcon = 'âš ï¸';
        riskNote = 'å‡ºåƒ¹é«˜æ–¼75%çš„æ­·å²æ¡ˆä¾‹ï¼Œå¾—æ¨™æ©Ÿç‡è¼ƒé«˜ä½†é¢¨éšªå¢åŠ ';
    } else if (userPremium <= stats.p90) {
        percentile = 90;
        riskLevel = 'åé«˜';
        riskColor = '#ef4444';
        riskIcon = 'ğŸ”º';
        riskNote = 'å‡ºåƒ¹ä½æ–¼æ­·å²å‰10%é«˜ä½ï¼Œé¢¨éšªè¼ƒé«˜';
    } else {
        percentile = 95;
        riskLevel = 'æ¥µé«˜';
        riskColor = '#dc2626';
        riskIcon = 'ğŸš¨';
        riskNote = 'å‡ºåƒ¹è¶…é90%çš„æ­·å²æ¡ˆä¾‹ï¼æ¥µé«˜é¢¨éšªï¼Œè«‹å¯©æ…è©•ä¼°';
    }
    
    // Z-scoreé¢¨éšªè£œå……èªªæ˜
    let zScoreNote = '';
    if (absZ > 2) {
        zScoreNote = `<div style="background:#fef2f2; padding:6px 10px; border-radius:4px; margin-top:8px; font-size:11px; color:#dc2626;">
            <strong>âš ï¸ æ¥µç«¯åé›¢è­¦ç¤ºï¼š</strong>åé›¢å‡å€¼ ${absZ.toFixed(1)} å€‹æ¨™æº–å·®ï¼ˆ${zScore > 0 ? 'é«˜æ–¼' : 'ä½æ–¼'}å‡å€¼ ${Math.abs(userPremium - stats.mean).toFixed(1)}%ï¼‰
        </div>`;
    } else if (absZ > 1.5) {
        zScoreNote = `<div style="background:#fffbeb; padding:6px 10px; border-radius:4px; margin-top:8px; font-size:11px; color:#d97706;">
            <strong>âš¡ æ³¨æ„ï¼š</strong>åé›¢å‡å€¼ ${absZ.toFixed(1)} å€‹æ¨™æº–å·®ï¼Œåƒ¹æ ¼${zScore > 0 ? 'åé«˜' : 'åä½'}
        </div>`;
    }
    
    // æ›´æ–°UI
    const riskEl = document.getElementById('mpRiskAssessment');
    if (riskEl) {
        riskEl.innerHTML = `
            <div style="display:flex; align-items:flex-start; gap:10px;">
                <span style="font-size:24px;">${riskIcon}</span>
                <div style="flex:1;">
                    <div style="font-weight:bold; color:${riskColor}; font-size:14px;">
                        åƒ¹æ ¼ä½ç½®ï¼š${riskLevel}ï¼ˆç¬¬${percentile}ç™¾åˆ†ä½ï¼‰
                    </div>
                    <div style="font-size:12px; color:#666; margin-top:4px;">
                        ${riskNote}
                    </div>
                    <div style="font-size:11px; color:#888; margin-top:6px; padding:6px 0; border-top:1px solid #e5e7eb;">
                        ğŸ“Š åŒæ¢ä»¶ï¼ˆ${guarLabel}ï¼Œ${theoKey}ï¼Œ${stats.n}æª”ï¼‰ï¼šå‡å€¼ ${stats.mean.toFixed(1)}% Â± ${stats.std.toFixed(1)}%
                        <br>
                        ğŸ“ˆ ç™¾åˆ†ä½ï¼šP25=${stats.p25.toFixed(1)}% | P50=${stats.p50.toFixed(1)}% | P75=${stats.p75.toFixed(1)}% | P90=${stats.p90.toFixed(1)}%
                    </div>
                    ${zScoreNote}
                </div>
            </div>
        `;
        riskEl.style.borderLeft = `4px solid ${riskColor}`;
    }
}

/**
 * æŸ¥æ‰¾åŒé¡æ¡ˆä»¶ï¼ˆç”¨æ–¼çµ±è¨ˆé¡¯ç¤ºï¼‰
 * æ³¨æ„ï¼šé€™æ˜¯èˆŠç‰ˆå‡½æ•¸ï¼Œç”¨æ–¼ç”ŸæˆåŒé¡æ¡ˆä»¶çµ±è¨ˆHTML
 * @param {Object} params - æŸ¥è©¢åƒæ•¸
 * @returns {Object} åŒé¡æ¡ˆä»¶çµ±è¨ˆ
 */
function findSimilarCasesForStats(params) {
    const { theoreticalPrice, issueSize, industry } = params;
    
    if (!auctionRawData || auctionRawData.length === 0) {
        return { cases: [], stats: null };
    }
    
    // å®šç¾©ç†è«–åƒ¹å€é–“
    let theoMin, theoMax;
    if (theoreticalPrice >= 105) {
        theoMin = 105; theoMax = 999;
    } else if (theoreticalPrice >= 95) {
        theoMin = 95; theoMax = 105;
    } else if (theoreticalPrice >= 85) {
        theoMin = 85; theoMax = 95;
    } else {
        theoMin = 0; theoMax = 85;
    }
    
    // å®šç¾©ç™¼è¡Œè¦æ¨¡å€é–“
    let sizeMin, sizeMax;
    if (issueSize < 5) {
        sizeMin = 0; sizeMax = 5;
    } else if (issueSize < 10) {
        sizeMin = 5; sizeMax = 10;
    } else if (issueSize < 15) {
        sizeMin = 10; sizeMax = 15;
    } else {
        sizeMin = 15; sizeMax = 999;
    }
    
    // ç¯©é¸åŒé¡æ¡ˆä»¶
    let similarCases = auctionRawData.filter(d => {
        const theo = d.theoreticalPrice || 0;
        const size = d.issueSize || 0;
        const matchTheo = theo >= theoMin && theo < theoMax;
        const matchSize = size >= sizeMin && size < sizeMax;
        return matchTheo && matchSize && d.avgPremium !== null && d.avgPremium !== undefined;
    });
    
    // å¦‚æœæœ‰ç”¢æ¥­æ¢ä»¶ï¼Œé€²ä¸€æ­¥ç¯©é¸
    let industryMatchCases = [];
    if (industry) {
        industryMatchCases = similarCases.filter(d => industryMatches(d.industry, industry));
    }
    
    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    const calcStats = (cases) => {
        if (cases.length === 0) return null;
        
        const premiums = cases.map(d => d.avgPremium).filter(p => p !== null && !isNaN(p));
        const multiples = cases.map(d => d.bidMultiple).filter(m => m > 0);
        
        if (premiums.length === 0) return null;
        
        const avgPremium = premiums.reduce((a, b) => a + b, 0) / premiums.length;
        const minPremium = Math.min(...premiums);
        const maxPremium = Math.max(...premiums);
        
        // è¨ˆç®—æ¨™æº–å·®
        const variance = premiums.reduce((sum, p) => sum + Math.pow(p - avgPremium, 2), 0) / premiums.length;
        const stdDev = Math.sqrt(variance);
        
        const avgMultiple = multiples.length > 0 ? multiples.reduce((a, b) => a + b, 0) / multiples.length : 0;
        
        return {
            count: cases.length,
            avgPremium: avgPremium,
            minPremium: minPremium,
            maxPremium: maxPremium,
            stdDev: stdDev,
            avgMultiple: avgMultiple
        };
    };
    
    return {
        allCases: similarCases,
        allStats: calcStats(similarCases),
        industryCases: industryMatchCases,
        industryStats: calcStats(industryMatchCases),
        theoRange: `${theoMin}~${theoMax === 999 ? 'âˆ' : theoMax}`,
        sizeRange: `${sizeMin}~${sizeMax === 999 ? 'âˆ' : sizeMax}å„„`
    };
}



/**
 * æ›´æ–°å¸‚å ´æ°›åœé¢æ¿
 * v3.72 ä¿®æ”¹ï¼šæ ¹æ“šç”¨æˆ¶é¸æ“‡çš„æ“”ä¿é¡å‹ç¯©é¸
 */
function updateAtmospherePanel() {
    const panel = document.getElementById('atmospherePanel');
    const content = document.getElementById('atmosphereContent');
    
    if (!panel || !content) return;
    
    // v3.72 æ–°å¢ï¼šå–å¾—ç”¨æˆ¶é¸æ“‡çš„æ“”ä¿é¡å‹
    const guaranteeEl = document.getElementById('guarantee');
    const guarantee = guaranteeEl ? guaranteeEl.value : null;
    
    const atmosphere = calcMarketAtmosphere(5, guarantee);
    
    if (!atmosphere || atmosphere.caseCount === 0) {
        panel.style.display = 'none';
        return;
    }
    
    panel.style.display = 'block';
    
    // v3.72 æ–°å¢ï¼šæ¨™é¡ŒåŠ å…¥æ“”ä¿é¡å‹
    const guarLabel = guarantee ? `ã€${guarantee}ã€‘` : '';
    
    // ç”Ÿæˆè¿‘æœŸæ¡ˆä¾‹åˆ—è¡¨
    let caseList = '';
    atmosphere.recentCases.slice(0, 5).forEach((d, i) => {
        // v3.73 ä¿®æ­£ï¼šä½¿ç”¨çµ±ä¸€çš„ formatDate å‡½æ•¸è™•ç†æ—¥æœŸ
        const dateStr = formatDate(d.openDate);
        caseList += `
        <div style="display: flex; gap: 8px; padding: 4px 0; border-bottom: 1px dashed #c8e6c9; font-size: 11px;">
            <span style="color: #666; min-width: 70px;">${dateStr}</span>
            <span style="font-weight: 600; min-width: 80px;">${d.name || '-'}</span>
            <span style="color: #1565c0;">æº¢${d.avgPremium !== null ? d.avgPremium.toFixed(2) : '-'}%</span>
            <span style="color: #e65100;">${d.bidMultiple > 0 ? d.bidMultiple.toFixed(2) + 'x' : '-'}</span>
        </div>`;
    });
    
    content.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
            <div style="flex: 1;">
                <div style="font-size: 11px; color: #666;">è¿‘${atmosphere.caseCount}æª”${guarLabel}å¹³å‡æº¢åƒ¹</div>
                <div style="font-size: 22px; font-weight: bold; color: #2e7d32;">${atmosphere.avgPremium.toFixed(2)}%</div>
            </div>
            <div style="flex: 1;">
                <div style="font-size: 11px; color: #666;">å¹³å‡æŠ•æ¨™å€æ•¸</div>
                <div style="font-size: 22px; font-weight: bold; color: #1565c0;">${atmosphere.avgMultiple.toFixed(2)}x</div>
            </div>
            <div style="flex: 0 0 auto;">
                <div style="padding: 6px 12px; border-radius: 15px; background: ${atmosphere.levelColor}; color: white; font-weight: bold; font-size: 14px;">
                    ${atmosphere.level}
                </div>
            </div>
        </div>
        <div style="background: #fff; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">ğŸ“‹ è¿‘æœŸ${guarLabel}é–‹æ¨™æ¡ˆä¾‹</div>
            ${caseList}
        </div>
        <div style="font-size: 11px; color: #2e7d32; background: #fff; padding: 8px; border-radius: 6px;">
            ğŸ’¡ ${atmosphere.suggestion}
        </div>
    `;
}

// ==================== v3.97z-s æ–°å¢ï¼šåŸºæœ¬è³‡æ–™æŸ¥è©¢æ¨¡çµ„ï¼ˆå«ç¯©é¸åŠŸèƒ½ï¼‰ ====================

// å…¨åŸŸè®Šæ•¸ - CBå®Œæ•´è³‡æ–™åº«
window.cbDatabase = {
    allCB: [],           // æ‰€æœ‰CBæ¸…å–®ï¼ˆæ•´åˆå¾Œï¼‰
    basic: {},           // 01å·¥ä½œè¡¨ - åŸºæœ¬è³‡æ–™ (ä»¥CBä»£è™Ÿç‚ºkey)
    schedule: {},        // 02å·¥ä½œè¡¨ - ç™¼è¡Œæ™‚ç¨‹
    putback: {},         // 03å·¥ä½œè¡¨ - è³£å›æ¢ä»¶
    auction: {},         // 04å·¥ä½œè¡¨ - ç«¶æ‹è³‡æ–™
    listed: {},          // 08å·¥ä½œè¡¨ - æ›ç‰Œä¸­æ¸…å–®
    quote: {},           // 09å·¥ä½œè¡¨ - æœ€æ–°è¡Œæƒ…
    balance: {},         // 10å·¥ä½œè¡¨ - é¤˜é¡è®ŠåŒ–
    listedCodes: new Set(), // æ›ç‰Œä¸­çš„CBä»£è™Ÿé›†åˆ
    auctionCodes: new Set() // ç«¶æ‹ç™¼è¡Œçš„CBä»£è™Ÿé›†åˆ
};

// ç¯©é¸å¾Œçš„CBæ¸…å–®
let filteredCBList = [];
let currentBasicInfoCB = null;
let currentPriceTrendCB = null;

/**
 * åˆå§‹åŒ–åŸºæœ¬è³‡æ–™æŸ¥è©¢æ¨¡çµ„
 */
function initBasicInfoModule() {
    console.log('åˆå§‹åŒ–åŸºæœ¬è³‡æ–™æŸ¥è©¢æ¨¡çµ„...');
    buildCBDatabase();
    populateBasicInfoCBList();
}

/**
 * å»ºç«‹CBå®Œæ•´è³‡æ–™åº«ï¼ˆæ•´åˆå¤šå€‹å·¥ä½œè¡¨ï¼‰
 */
function buildCBDatabase() {
    const db = window.cbDatabase;
    
    // å¾04å·¥ä½œè¡¨ï¼ˆç«¶æ‹è³‡æ–™ï¼‰å»ºç«‹ç«¶æ‹ä»£è™Ÿé›†åˆ
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        window.auctionDataCache.forEach(row => {
            const code = String(row['CBä»£è™Ÿ'] || '').trim();
            if (code) {
                db.auctionCodes.add(code);
                db.auction[code] = row;
            }
        });
    }
    
    // å¾auctionRawDataè£œå……ç«¶æ‹è³‡æ–™
    if (window.auctionRawData && window.auctionRawData.length > 0) {
        window.auctionRawData.forEach(row => {
            const code = String(row.cbCode || '').trim();
            if (code && !db.auctionCodes.has(code)) {
                db.auctionCodes.add(code);
                // è½‰æ›æ¬„ä½åç¨±
                db.auction[code] = {
                    'CBä»£è™Ÿ': code,
                    'åç¨±': row.name,
                    'é–‹æ¨™æ—¥æœŸ': row.openDate,
                    'æœ€ä½å¾—æ¨™': row.minBid,
                    'å¹³å‡å¾—æ¨™': row.avgBid,
                    'ç†è«–åƒ¹': row.theoPrice,
                    'æŠ•æ¨™å€æ•¸': row.bidMultiple,
                    'æœ€ä½æº¢åƒ¹': row.minPremium,
                    'ç™¼è¡Œè¦æ¨¡': row.issueSize,
                    'è½‰æ›åƒ¹': row.convPrice,
                    'æˆªæ¨™æ”¶ç›¤': row.stockPrice,
                    'ç™¼è¡Œåˆ¸å•†': row.broker,
                    'TCRI': row.tcri,
                    'æ“”ä¿': row.guarantee,
                    'ç”¢æ¥­åˆ†é¡': row.industry,
                    'å¹´æœŸ': row.term,
                    'ç«¶æ‹å¼µæ•¸': row.auctionShares,
                    'æŠ•æ¨™å¼µæ•¸': row.bidShares
                };
            }
        });
    }
    
    // å‡è¨­01ã€02ã€03ã€08ã€09ã€10å·¥ä½œè¡¨è³‡æ–™æœƒåœ¨Excelè¼‰å…¥æ™‚ä¸€ä½µè™•ç†
    // é€™è£¡å…ˆå¾å·²æœ‰çš„è³‡æ–™å»ºç«‹åŸºç¤æ¸…å–®
    
    // å»ºç«‹æ‰€æœ‰CBæ¸…å–®
    const cbMap = new Map();
    
    // å¾ç«¶æ‹è³‡æ–™åŠ å…¥
    db.auctionCodes.forEach(code => {
        const auctionData = db.auction[code];
        if (auctionData) {
            cbMap.set(code, {
                code: code,
                name: auctionData['åç¨±'] || '',
                isAuction: true,
                isListed: false, // é è¨­ç‚ºå·²ä¸‹å¸‚ï¼Œå¾Œé¢æœƒæ›´æ–°
                issueMethod: 'ç«¶æ‹',
                status: 'å·²ä¸‹å¸‚'
            });
        }
    });
    
    // å¾å…¶ä»–ä¾†æºè£œå……ï¼ˆå¦‚æœæœ‰è¼‰å…¥01å·¥ä½œè¡¨ï¼‰
    if (window.sheet01Data && window.sheet01Data.length > 0) {
        window.sheet01Data.forEach(row => {
            const code = String(row['CBä»£è™Ÿ'] || '').trim();
            const name = String(row['åç¨±'] || '');
            const method = String(row['è©¢åœˆç«¶æ‹'] || '').trim();
            
            if (code) {
                if (!cbMap.has(code)) {
                    cbMap.set(code, {
                        code: code,
                        name: name,
                        isAuction: method === 'ç«¶æ‹',
                        isListed: false,
                        issueMethod: method || (db.auctionCodes.has(code) ? 'ç«¶æ‹' : 'è©¢åœˆ'),
                        status: 'å·²ä¸‹å¸‚'
                    });
                } else {
                    const existing = cbMap.get(code);
                    existing.issueMethod = method || existing.issueMethod;
                    existing.isAuction = method === 'ç«¶æ‹' || existing.isAuction;
                }
                
                // å„²å­˜åŸºæœ¬è³‡æ–™
                db.basic[code] = row;
            }
        });
    }
    
    // å¾08å·¥ä½œè¡¨åˆ¤æ–·æ›ç‰Œä¸­
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        window.sheet08Data.forEach(row => {
            const code = String(row['ä»£è™Ÿ'] || '').trim();
            if (code) {
                db.listedCodes.add(code);
                db.listed[code] = row;
                
                if (cbMap.has(code)) {
                    const cb = cbMap.get(code);
                    cb.isListed = true;
                    cb.status = 'æ›ç‰Œä¸­';
                }
            }
        });
    }
    
    // è½‰æ›ç‚ºé™£åˆ—
    db.allCB = Array.from(cbMap.values());
    
    console.log(`CBè³‡æ–™åº«å»ºç«‹å®Œæˆ: ç¸½è¨ˆ ${db.allCB.length} æª”, ç«¶æ‹ ${db.auctionCodes.size} æª”, æ›ç‰Œä¸­ ${db.listedCodes.size} æª”`);
}

/**
 * ç¯©é¸CBæ¸…å–®
 */
function filterCBList() {
    const methodFilter = document.querySelector('input[name="issueMethod"]:checked')?.value || 'all';
    const statusFilter = document.querySelector('input[name="listingStatus"]:checked')?.value || 'all';
    
    const db = window.cbDatabase;
    
    // ç¯©é¸
    filteredCBList = db.allCB.filter(cb => {
        // ç™¼è¡Œæ–¹å¼ç¯©é¸
        if (methodFilter === 'auction' && !cb.isAuction) return false;
        if (methodFilter === 'inquiry' && cb.isAuction) return false;
        
        // äº¤æ˜“ç‹€æ…‹ç¯©é¸
        if (statusFilter === 'listed' && !cb.isListed) return false;
        if (statusFilter === 'delisted' && cb.isListed) return false;
        
        return true;
    });
    
    // æ›´æ–°ä¸‹æ‹‰é¸å–®
    updateCBSelectOptions();
    
    // æ›´æ–°è¨ˆæ•¸é¡¯ç¤º
    const listCountEl = document.getElementById('cbListCount');
    if (listCountEl) {
        listCountEl.textContent = `é¡¯ç¤º ${filteredCBList.length} æª”`;
    }
}

/**
 * æ›´æ–°CBä¸‹æ‹‰é¸å–®é¸é …
 */
function updateCBSelectOptions() {
    const select = document.getElementById('basicInfoCBSelect');
    const priceTrendSelect = document.getElementById('priceTrendCBSelect');
    if (!select) return;
    
    // æ’åºï¼ˆä¾ä»£è™Ÿå€’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢ï¼‰
    const sortedList = [...filteredCBList].sort((a, b) => {
        return String(b.code).localeCompare(String(a.code));
    });
    
    // ç”Ÿæˆé¸é …HTML
    let optionsHTML = '<option value="">-- è«‹é¸æ“‡CBä»£è™Ÿ --</option>';
    
    sortedList.forEach(cb => {
        const statusIcon = cb.isListed ? 'ğŸŸ¢' : 'âš«';
        const methodIcon = cb.isAuction ? 'ğŸ¯' : 'ğŸ“‹';
        optionsHTML += `<option value="${cb.code}">${statusIcon}${methodIcon} ${cb.code} ${cb.name}</option>`;
    });
    
    select.innerHTML = optionsHTML;
    
    // åŒæ­¥åˆ°åƒ¹æ ¼èµ°å‹¢é¸å–®
    if (priceTrendSelect) {
        priceTrendSelect.innerHTML = optionsHTML;
    }
}

/**
 * å¡«å……åŸºæœ¬è³‡æ–™CBé¸æ“‡æ¸…å–®ï¼ˆåˆå§‹åŒ–ç”¨ï¼‰
 */
function populateBasicInfoCBList() {
    const db = window.cbDatabase;
    
    // å¦‚æœè³‡æ–™åº«ç‚ºç©ºï¼Œå¾ç¾æœ‰è³‡æ–™å»ºç«‹
    if (db.allCB.length === 0) {
        buildCBDatabase();
    }
    
    // v3.97z-s æ–°å¢ï¼šèƒŒæ™¯è¼‰å…¥yuantaæ­·å²è³‡æ–™ï¼ˆéé˜»å¡ï¼‰
    if (!window.yuantaHistoryData.loaded && !window.yuantaHistoryData.loading) {
        loadYuantaHistoryData().then(() => {
            console.log('ğŸ“‚ yuantaæ­·å²è³‡æ–™å·²èƒŒæ™¯è¼‰å…¥å®Œæˆ');
        }).catch(err => {
            console.warn('yuantaæ­·å²è³‡æ–™è¼‰å…¥å¤±æ•—:', err);
        });
    }
    
    // åˆå§‹åŒ–ç¯©é¸æ¸…å–®ï¼ˆå…¨éƒ¨ï¼‰
    filteredCBList = [...db.allCB];
    
    // æ›´æ–°çµ±è¨ˆæ•¸å­—
    const auctionCount = db.allCB.filter(cb => cb.isAuction).length;
    const inquiryCount = db.allCB.filter(cb => !cb.isAuction).length;
    const listedCount = db.allCB.filter(cb => cb.isListed).length;
    const delistedCount = db.allCB.filter(cb => !cb.isListed).length;
    
    // æ›´æ–°UIé¡¯ç¤º
    const auctionCountEl = document.getElementById('auctionCount');
    const inquiryCountEl = document.getElementById('inquiryCount');
    const listedCountEl = document.getElementById('listedCount');
    const delistedCountEl = document.getElementById('delistedCount');
    
    if (auctionCountEl) auctionCountEl.textContent = `(${auctionCount})`;
    if (inquiryCountEl) inquiryCountEl.textContent = `(${inquiryCount})`;
    if (listedCountEl) listedCountEl.textContent = `(${listedCount})`;
    if (delistedCountEl) delistedCountEl.textContent = `(${delistedCount})`;
    
    // æ›´æ–°ä¸‹æ‹‰é¸å–®
    updateCBSelectOptions();
    
    const listCountEl = document.getElementById('cbListCount');
    if (listCountEl) {
        listCountEl.textContent = `å…± ${db.allCB.length} æª”`;
    }
    
    console.log(`åŸºæœ¬è³‡æ–™æŸ¥è©¢æ¨¡çµ„åˆå§‹åŒ–å®Œæˆï¼Œå…± ${db.allCB.length} æª”CBå¯æŸ¥è©¢ (ç«¶æ‹${auctionCount}/è©¢åœˆ${inquiryCount}, æ›ç‰Œä¸­${listedCount}/å·²ä¸‹å¸‚${delistedCount})`);
}

/**
 * é‡æ•´åŸºæœ¬è³‡æ–™æ¸…å–®
 */
function refreshBasicInfoList() {
    buildCBDatabase();
    populateBasicInfoCBList();
    filterCBList();
    document.getElementById('basicInfoStatus').textContent = 'âœ… æ¸…å–®å·²é‡æ•´';
}

/**
 * è¼‰å…¥æŒ‡å®šCBçš„åŸºæœ¬è³‡æ–™
 */
function loadBasicInfo(cbCode) {
    if (!cbCode) {
        document.getElementById('basicInfoContent').innerHTML = `
            <div style="text-align:center; color:#999; padding:40px;">
                ğŸ‘† è«‹å…ˆé¸æ“‡ä¸€æª”å¯è½‰å‚µ
            </div>`;
        document.getElementById('basicInfoStatus').textContent = 'æç¤ºï¼šè«‹é¸æ“‡ä¸€æª”å¯è½‰å‚µæŸ¥çœ‹è©³ç´°è³‡æ–™';
        return;
    }
    
    currentBasicInfoCB = cbCode;
    
    // å–å¾—CBç‹€æ…‹è³‡è¨Š
    const db = window.cbDatabase;
    const cbInfo = db.allCB.find(cb => cb.code === cbCode);
    
    const methodLabel = cbInfo?.isAuction ? 'ğŸ¯ç«¶æ‹ç™¼è¡Œ' : 'ğŸ“‹è©¢åœˆç™¼è¡Œ';
    const statusLabel = cbInfo?.isListed ? 'ğŸŸ¢æ›ç‰Œä¸­' : 'âš«å·²ä¸‹å¸‚';
    
    document.getElementById('basicInfoStatus').textContent = `âœ… å·²è¼‰å…¥ ${cbCode} â”‚ ${methodLabel} â”‚ ${statusLabel}`;
    
    // é¡¯ç¤ºé è¨­æ¨™ç±¤ï¼ˆåŸºæœ¬è³‡æ–™ï¼‰
    showBasicInfoTab('overview');
}

/**
 * é¡¯ç¤ºåŸºæœ¬è³‡æ–™æ¨™ç±¤é 
 */
function showBasicInfoTab(tabName, event) {
    // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
    document.querySelectorAll('.basic-info-tab').forEach(tab => tab.classList.remove('active'));
    if (event) event.target.classList.add('active');
    else document.querySelector('.basic-info-tab').classList.add('active');
    
    const content = document.getElementById('basicInfoContent');
    const cbCode = currentBasicInfoCB;
    
    if (!cbCode) {
        content.innerHTML = `<div style="text-align:center; color:#999; padding:40px;">ğŸ‘† è«‹å…ˆé¸æ“‡ä¸€æª”å¯è½‰å‚µ</div>`;
        return;
    }
    
    // æ ¹æ“šæ¨™ç±¤é¡¯ç¤ºä¸åŒå…§å®¹
    switch(tabName) {
        case 'overview':
            renderBasicInfoOverview(cbCode, content);
            break;
        case 'schedule':
            renderBasicInfoSchedule(cbCode, content);
            break;
        case 'putback':
            renderBasicInfoPutback(cbCode, content);
            break;
        case 'auction':
            renderBasicInfoAuction(cbCode, content);
            break;
        case 'quote':
            renderBasicInfoQuote(cbCode, content);
            break;
        case 'balance':
            renderBasicInfoBalance(cbCode, content);
            break;
        default:
            content.innerHTML = `<div style="color:#999;">æœªçŸ¥æ¨™ç±¤ï¼š${tabName}</div>`;
    }
}

/**
 * æ¸²æŸ“åŸºæœ¬è³‡æ–™ç¸½è¦½
 * v3.97z-s ä¿®æ”¹ï¼šèª¿æ•´æŸ¥è©¢å„ªå…ˆé †åº
 * - æ›ç‰Œä¸­CBï¼š08å·¥ä½œè¡¨(æœ€æ–°) â†’ ç«¶æ‹è³‡æ–™ â†’ yuantaæ­·å² â†’ 01å·¥ä½œè¡¨
 * - å·²ä¸‹å¸‚CBï¼šç«¶æ‹è³‡æ–™ â†’ yuantaæ­·å² â†’ 01å·¥ä½œè¡¨
 */
function renderBasicInfoOverview(cbCode, container) {
    let data = null;
    let dataSource = '';
    const searchCode = String(cbCode).trim();
    
    // å…ˆåˆ¤æ–·æ˜¯å¦æ›ç‰Œä¸­
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);
    
    // ========== æ›ç‰Œä¸­CBï¼šå„ªå…ˆä½¿ç”¨08å·¥ä½œè¡¨ï¼ˆæœ€æ–°è³‡æ–™ï¼‰==========
    if (isListed) {
        // 1. å„ªå…ˆå¾ 08å·¥ä½œè¡¨ï¼ˆæ›ç‰Œä¸­ï¼‰å°‹æ‰¾
        if (!data && window.sheet08Data && window.sheet08Data.length > 0) {
            const sheet08Row = window.sheet08Data.find(r => String(r['ä»£è™Ÿ']).trim() === searchCode);
            if (sheet08Row) {
                data = {
                    'CBä»£è™Ÿ': sheet08Row['ä»£è™Ÿ'],
                    'åç¨±': sheet08Row['åç¨±'],
                    'è‚¡ç¥¨ä»£è™Ÿ': sheet08Row['è½‰æ›æ¨™çš„ä»£ç¢¼'],
                    'è½‰æ›æ¨™çš„åç¨±': sheet08Row['è½‰æ›æ¨™çš„åç¨±'],
                    'è½‰æ›åƒ¹': sheet08Row['è½‰æ›åƒ¹æ ¼(å…ƒ)'],
                    'ç™¼è¡Œè¦æ¨¡': sheet08Row['å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)'],
                    'å¹´æœŸ': sheet08Row['é‚„æœ¬å¹´é™'],
                    'ç™¼è¡Œåˆ¸å•†': sheet08Row['æ‰¿éŠ·æ©Ÿæ§‹'],
                    'åº•æ¨™åƒ¹': sheet08Row['ç™¼è¡Œåƒ¹æ ¼(å…ƒ)'] || 100,
                    'åˆ°æœŸé‚„æœ¬åƒ¹æ ¼': sheet08Row['åˆ°æœŸåƒ¹æ ¼'],
                    'æ›ç‰Œæ—¥æœŸ': sheet08Row['æ›ç‰Œæ—¥æœŸ'],
                    'åˆ°æœŸæ—¥æœŸ': sheet08Row['åˆ°æœŸæ—¥'],
                    'æ“”ä¿': sheet08Row['å‚µåˆ¸æ“”ä¿æƒ…å½¢'],
                    'æœ€æ–°é¤˜é¡': sheet08Row['æœ€æ–°é¤˜é¡(ç™¾è¬)'],
                    'ç™¼è¡Œæ™‚è½‰æ›åƒ¹': sheet08Row['ç™¼è¡Œæ™‚è½‰æ›åƒ¹æ ¼(å…ƒ)'],
                    'è½‰æ›æ—¥æœŸèµ·': sheet08Row['è½‰æ›æ—¥æœŸèµ·'],
                    'è½‰æ›æ—¥æœŸè¿„': sheet08Row['è½‰æ›æ—¥æœŸè¿„'],
                    'æå‰å„Ÿé‚„æ—¥1': sheet08Row['æå‰å„Ÿé‚„æ—¥1'],
                    'æå‰å„Ÿé‚„åƒ¹æ ¼1': sheet08Row['æå‰å„Ÿé‚„åƒ¹æ ¼1'],
                    'æœ€è¿‘æå‰å„Ÿé‚„æ—¥': sheet08Row['æœ€è¿‘æå‰å„Ÿé‚„æ—¥'],
                    'æœ€è¿‘æå‰å„Ÿé‚„åƒ¹æ ¼': sheet08Row['æœ€è¿‘æå‰å„Ÿé‚„åƒ¹æ ¼']
                };
                dataSource = 'sheet08Data';
            }
        }
    }
    
    // ========== ç«¶æ‹è³‡æ–™ï¼ˆä¸è«–æ›ç‰Œä¸­æˆ–å·²ä¸‹å¸‚ï¼‰==========
    // 2. å¾auctionDataCacheå°‹æ‰¾ï¼ˆç«¶æ‹å®Œæ•´è³‡æ–™ï¼‰
    if (!data && window.auctionDataCache && window.auctionDataCache.length > 0) {
        const auctionRow = window.auctionDataCache.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
        if (auctionRow) {
            data = auctionRow;
            dataSource = 'auctionDataCache';
        }
    }
    
    // 3. å¾ auctionRawData å°‹æ‰¾
    if (!data && window.auctionRawData && window.auctionRawData.length > 0) {
        const rawData = window.auctionRawData.find(r => String(r.cbCode).trim() === searchCode);
        if (rawData) {
            data = {
                'CBä»£è™Ÿ': rawData.cbCode,
                'åç¨±': rawData.name,
                'è‚¡ç¥¨ä»£è™Ÿ': rawData.stockCode,
                'ç”¢æ¥­åˆ†é¡': rawData.industry,
                'ä¿¡ç”¨è©•ç­‰': rawData.tcri,
                'TCRI': rawData.tcri,
                'æ“”ä¿': rawData.guarantee,
                'ç™¼è¡Œè¦æ¨¡': rawData.issueSize,
                'å¹´æœŸ': rawData.term,
                'è‚¡æœ¬(å„„)': rawData.capitalBillion,
                'ç«¶æ‹å¼µæ•¸': rawData.auctionShares,
                'ç™¼è¡Œåˆ¸å•†': rawData.broker,
                'è½‰æ›åƒ¹': rawData.convPrice,
                'æˆªæ¨™æ”¶ç›¤': rawData.stockPrice,
                'ç†è«–åƒ¹': rawData.theoPrice,
                'è½‰æ›æ¯”ç‡': rawData.convRatio,
                'å¹´åŒ–æ³¢å‹•': rawData.volatility,
                'PBR': rawData.pbr,
                'é–‹æ¨™æ—¥æœŸ': rawData.openDate,
                'æˆªæ¨™æ—¥': rawData.bidDeadline,
                'æœ€ä½å¾—æ¨™': rawData.minBid,
                'å¹³å‡å¾—æ¨™': rawData.avgBid,
                'æŠ•æ¨™å€æ•¸': rawData.bidMultiple,
                'åˆæ ¼ä»¶æ•¸': rawData.validBids
            };
            dataSource = 'auctionRawData';
        }
    }
    
    // ========== å·²ä¸‹å¸‚CBï¼šå„ªå…ˆä½¿ç”¨yuantaæ­·å²è³‡æ–™ ==========
    // 4. å¾ yuantaæ­·å²è³‡æ–™ å°‹æ‰¾ï¼ˆå·²ä¸‹å¸‚CBçš„ä¸»è¦è³‡æ–™ä¾†æºï¼‰
    if (!data && window.yuantaHistoryData?.loaded) {
        const yuantaRow = window.yuantaHistoryData.data[searchCode];
        if (yuantaRow) {
            data = {
                'CBä»£è™Ÿ': yuantaRow['ä»£è™Ÿ'],
                'åç¨±': yuantaRow['åç¨±'],
                'è‚¡ç¥¨ä»£è™Ÿ': yuantaRow['è½‰æ›æ¨™çš„ä»£ç¢¼'],
                'è½‰æ›æ¨™çš„åç¨±': yuantaRow['è½‰æ›æ¨™çš„åç¨±'],
                'è½‰æ›åƒ¹': yuantaRow['è½‰æ›åƒ¹æ ¼(å…ƒ)'],
                'ç™¼è¡Œè¦æ¨¡': yuantaRow['å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)'],
                'å¹´æœŸ': yuantaRow['é‚„æœ¬å¹´é™'],
                'ç™¼è¡Œåˆ¸å•†': yuantaRow['æ‰¿éŠ·æ©Ÿæ§‹'],
                'åº•æ¨™åƒ¹': yuantaRow['ç™¼è¡Œåƒ¹æ ¼(å…ƒ)'] || 100,
                'åˆ°æœŸé‚„æœ¬åƒ¹æ ¼': yuantaRow['åˆ°æœŸåƒ¹æ ¼'],
                'æ›ç‰Œæ—¥æœŸ': yuantaRow['æ›ç‰Œæ—¥æœŸ'],
                'åˆ°æœŸæ—¥æœŸ': yuantaRow['åˆ°æœŸæ—¥'],
                'æ“”ä¿': yuantaRow['å‚µåˆ¸æ“”ä¿æƒ…å½¢'],
                'æœ€æ–°é¤˜é¡': yuantaRow['æœ€æ–°é¤˜é¡(ç™¾è¬)'],
                'ç™¼è¡Œæ™‚è½‰æ›åƒ¹': yuantaRow['ç™¼è¡Œæ™‚è½‰æ›åƒ¹æ ¼(å…ƒ)'],
                'ä¿¡ç”¨è©•ç­‰': yuantaRow['ä¿¡ç”¨è©•ç­‰'],
                '_sheetDate': yuantaRow['_sheetDate']
            };
            dataSource = 'yuantaHistory';
        }
    }
    
    // 5. å¾ sheet01Dataï¼ˆ01å·¥ä½œè¡¨ï¼‰å°‹æ‰¾ï¼ˆæ‰‹å·¥æ”¶é›†è³‡æ–™ï¼‰
    if (!data && window.sheet01Data && window.sheet01Data.length > 0) {
        const sheet01Row = window.sheet01Data.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
        if (sheet01Row) {
            data = {
                'CBä»£è™Ÿ': sheet01Row['CBä»£è™Ÿ'],
                'åç¨±': sheet01Row['åç¨±'],
                'è‚¡ç¥¨ä»£è™Ÿ': sheet01Row['è‚¡ç¥¨ä»£è™Ÿ'],
                'ç”¢æ¥­åˆ†é¡': sheet01Row['ç”¢æ¥­åˆ†é¡'],
                'ä¿¡ç”¨è©•ç­‰': sheet01Row['ä¿¡ç”¨è©•ç­‰'],
                'TCRI': sheet01Row['ä¿¡ç”¨è©•ç­‰'],
                'æ“”ä¿': sheet01Row['æ“”ä¿'],
                'ç™¼è¡Œè¦æ¨¡': sheet01Row['ç™¼è¡Œè¦æ¨¡'],
                'å¹´æœŸ': sheet01Row['ç™¼è¡Œå¹´æœŸ'],
                'è‚¡æœ¬(å„„)': sheet01Row['è‚¡æœ¬å¤§å°'],
                'ç™¼è¡Œåˆ¸å•†': sheet01Row['ç™¼è¡Œåˆ¸å•†'],
                'è½‰æ›åƒ¹': sheet01Row['è½‰æ›åƒ¹æ ¼'],
                'åº•æ¨™åƒ¹': sheet01Row['ç™¼è¡Œåƒ¹æ ¼'] || 100,
                'ç”¢æ¥­åœ°ä½': sheet01Row['ç”¢æ¥­åœ°ä½'],
                'åˆ°æœŸé‚„æœ¬åƒ¹æ ¼': sheet01Row['åˆ°æœŸé‚„æœ¬åƒ¹æ ¼'],
                'è¨‚åƒ¹æº¢åƒ¹ç‡': sheet01Row['è¨‚åƒ¹æº¢åƒ¹ç‡'],
                'æ›ç‰Œæ—¥æœŸ': sheet01Row['æ›ç‰Œæ—¥æœŸ'],
                'åˆ°æœŸæ—¥æœŸ': sheet01Row['åˆ°æœŸæ—¥æœŸ'],
                'æ›ç‰Œæœ€é«˜': sheet01Row['æ›ç‰Œæœ€é«˜'],
                'æ›ç‰Œæœ€ä½': sheet01Row['æ›ç‰Œæœ€ä½'],
                'ç™¼è¡Œæ–¹å¼': sheet01Row['è©¢åœˆç«¶æ‹']
            };
            dataSource = 'sheet01Data';
        }
    }
    
    // 6. å¾ cbDatabase.basic è£œå……è³‡æ–™
    if (!data && window.cbDatabase && window.cbDatabase.basic[searchCode]) {
        const basicRow = window.cbDatabase.basic[searchCode];
        data = {
            'CBä»£è™Ÿ': basicRow['CBä»£è™Ÿ'],
            'åç¨±': basicRow['åç¨±'],
            'è‚¡ç¥¨ä»£è™Ÿ': basicRow['è‚¡ç¥¨ä»£è™Ÿ'],
            'ç”¢æ¥­åˆ†é¡': basicRow['ç”¢æ¥­åˆ†é¡'],
            'ä¿¡ç”¨è©•ç­‰': basicRow['ä¿¡ç”¨è©•ç­‰'],
            'æ“”ä¿': basicRow['æ“”ä¿'],
            'ç™¼è¡Œè¦æ¨¡': basicRow['ç™¼è¡Œè¦æ¨¡'],
            'å¹´æœŸ': basicRow['ç™¼è¡Œå¹´æœŸ'],
            'ç™¼è¡Œæ–¹å¼': basicRow['è©¢åœˆç«¶æ‹']
        };
        dataSource = 'cbDatabase.basic';
    }
    
    if (!data) {
        container.innerHTML = `<div style="color:#e65100; padding:20px; text-align:center;">
            <div style="font-size:32px; margin-bottom:10px;">âš ï¸</div>
            <div>æ‰¾ä¸åˆ° <strong>${cbCode}</strong> çš„åŸºæœ¬è³‡æ–™</div>
            <div style="font-size:12px; color:#999; margin-top:8px;">
                è«‹ç¢ºèªCBä»£è™Ÿæ˜¯å¦æ­£ç¢º<br>
                è‹¥ç‚ºè¼ƒæ—©æœŸå·²ä¸‹å¸‚CBï¼Œå¯èƒ½éœ€è¦è¼‰å…¥yuantaæ­·å²è³‡æ–™
            </div>
        </div>`;
        document.getElementById('basicInfoStatus').innerHTML = `<span style="color:#e65100;">âš ï¸ ${cbCode} ç„¡è³‡æ–™</span>`;
        return;
    }
    
    // åˆ¤æ–·æ˜¯ç«¶æ‹é‚„æ˜¯è©¢åœˆ
    const isAuction = window.cbDatabase?.auctionCodes?.has(searchCode) || dataSource === 'auctionDataCache' || dataSource === 'auctionRawData';
    const methodLabel = isAuction ? 'ğŸ¯ ç«¶æ‹ç™¼è¡Œ' : 'ğŸ“‹ è©¢åœˆç™¼è¡Œ';
    const statusLabel = isListed ? 'ğŸŸ¢ æ›ç‰Œä¸­' : 'âš« å·²ä¸‹å¸‚';
    
    // è³‡æ–™ä¾†æºæ¨™ç±¤
    const sourceLabels = {
        'sheet08Data': 'ğŸ“Š 08å·¥ä½œè¡¨(æ›ç‰Œä¸­)',
        'auctionDataCache': 'ğŸ¯ ç«¶æ‹è³‡æ–™åº«',
        'auctionRawData': 'ğŸ¯ ç«¶æ‹åŸå§‹è³‡æ–™',
        'yuantaHistory': 'ğŸ“‚ å…ƒå¤§æ­·å²è³‡æ–™',
        'sheet01Data': 'ğŸ“‹ 01å·¥ä½œè¡¨(æ‰‹å·¥)',
        'cbDatabase.basic': 'ğŸ’¾ åŸºæœ¬è³‡æ–™åº«'
    };
    const sourceLabel = sourceLabels[dataSource] || dataSource;
    
    // ========== v3.97z-s æ–°å¢ï¼šå³æ™‚è¨ˆç®—æ¬„ä½ ==========
    const today = new Date();
    
    // è§£æåˆ°æœŸæ—¥æœŸ
    let maturityDate = null;
    const maturityRaw = data['åˆ°æœŸæ—¥æœŸ'] || data['åˆ°æœŸæ—¥'];
    if (maturityRaw) {
        if (typeof maturityRaw === 'number') {
            // Excelæ—¥æœŸæ•¸å­—
            maturityDate = new Date((maturityRaw - 25569) * 86400 * 1000);
        } else if (typeof maturityRaw === 'string') {
            maturityDate = new Date(maturityRaw);
        } else if (maturityRaw instanceof Date) {
            maturityDate = maturityRaw;
        }
    }
    
    // è¨ˆç®—å‰©é¤˜å¹´æœŸ
    let remainYears = null;
    let remainYearsDisplay = '-';
    if (maturityDate && !isNaN(maturityDate.getTime())) {
        const diffMs = maturityDate.getTime() - today.getTime();
        remainYears = diffMs / (365.25 * 24 * 60 * 60 * 1000);
        if (remainYears > 0) {
            remainYearsDisplay = remainYears.toFixed(2) + ' å¹´';
        } else {
            remainYearsDisplay = 'å·²åˆ°æœŸ';
        }
    }
    
    // å–å¾—è½‰æ›åƒ¹
    const convPrice = parseFloat(data['è½‰æ›åƒ¹']) || 0;
    
    // è¨ˆç®—å¼·åˆ¶è´–å›è§¸ç™¼åƒ¹ (130%)
    const callTrigger130 = convPrice > 0 ? (convPrice * 1.3).toFixed(2) : '-';
    
    // è¨ˆç®—æ¯å¼µå¯è½‰æ›è‚¡æ•¸ (é¢é¡100,000 Ã· è½‰æ›åƒ¹)
    const sharesPerBond = convPrice > 0 ? Math.floor(100000 / convPrice) : '-';
    
    // å¾09å·¥ä½œè¡¨å–å¾—æœ€æ–°é¤˜é¡è³‡è¨Šï¼ˆè¨ˆç®—å·²è½‰æ›æ¯”ä¾‹ï¼‰
    let quoteData09 = null;
    if (window.sheet09Data && window.sheet09Data.length > 0) {
        quoteData09 = window.sheet09Data.find(r => String(r['ä»£ç¢¼']).trim() === searchCode);
    }
    
    // ç™¼è¡Œå¼µæ•¸èˆ‡å‰©é¤˜å¼µæ•¸
    const issueSize = parseFloat(data['ç™¼è¡Œè¦æ¨¡']) || 0;
    const totalShares = issueSize > 0 ? issueSize * 10 : 0; // ç™¾è¬ â†’ å¼µæ•¸
    const outstandingShares = quoteData09 ? parseFloat(quoteData09['æµé€šåœ¨å¤–é¤˜é¡(å¼µ)']) : null;
    const remainRatio = quoteData09 ? parseFloat(quoteData09['å‰©é¤˜æœªè½‰æ›æ¯”ç‡%']) : null;
    
    // è¨ˆç®—å·²è½‰æ›æ¯”ä¾‹
    let convertedRatio = null;
    let convertedShares = null;
    if (remainRatio !== null && !isNaN(remainRatio)) {
        convertedRatio = (100 - remainRatio).toFixed(2);
        if (totalShares > 0) {
            convertedShares = Math.round(totalShares * (100 - remainRatio) / 100);
        }
    } else if (outstandingShares !== null && totalShares > 0) {
        convertedShares = totalShares - outstandingShares;
        convertedRatio = ((convertedShares / totalShares) * 100).toFixed(2);
    }
    
    document.getElementById('basicInfoStatus').innerHTML = `âœ… å·²è¼‰å…¥ ${cbCode} â”‚ ${methodLabel} â”‚ ${statusLabel} â”‚ <span style="font-size:11px; color:#666;">${sourceLabel}</span>`;
    
    // å»ºç«‹è³‡è¨Šå¡ç‰‡
    const html = `
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:15px;">
            <!-- åŸºæœ¬è³‡è¨Šå¡ -->
            <div style="background:#e3f2fd; padding:15px; border-radius:8px; border-left:4px solid #1976d2;">
                <div style="font-weight:bold; color:#1565c0; margin-bottom:10px;">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
                <table style="width:100%; font-size:13px;">
                    <tr><td style="color:#666; width:40%;">ä»£è™Ÿ</td><td style="font-weight:bold;">${data['CBä»£è™Ÿ'] || cbCode}</td></tr>
                    <tr><td style="color:#666;">åç¨±</td><td>${data['åç¨±'] || '-'}</td></tr>
                    <tr><td style="color:#666;">è½‰æ›æ¨™çš„</td><td>${data['è‚¡ç¥¨ä»£è™Ÿ'] || '-'}</td></tr>
                    <tr><td style="color:#666;">ç”¢æ¥­åˆ†é¡</td><td>${data['ç”¢æ¥­åˆ†é¡'] || '-'}</td></tr>
                    <tr><td style="color:#666;">ä¿¡ç”¨è©•ç­‰</td><td>TCRI ${data['ä¿¡ç”¨è©•ç­‰'] || data['TCRI'] || '-'}</td></tr>
                    <tr><td style="color:#666;">æ“”ä¿æƒ…å½¢</td><td>${data['æ“”ä¿'] || '-'}</td></tr>
                    <tr><td style="color:#666;">ç™¼è¡Œæ–¹å¼</td><td style="color:${isAuction ? '#e65100' : '#1565c0'}; font-weight:bold;">${isAuction ? 'ç«¶æ‹' : 'è©¢åœˆ'}</td></tr>
                </table>
            </div>
            
            <!-- ç™¼è¡Œæ¢ä»¶å¡ -->
            <div style="background:#fff3e0; padding:15px; border-radius:8px; border-left:4px solid #ff9800;">
                <div style="font-weight:bold; color:#e65100; margin-bottom:10px;">ğŸ’° ç™¼è¡Œæ¢ä»¶</div>
                <table style="width:100%; font-size:13px;">
                    <tr><td style="color:#666; width:40%;">ç™¼è¡Œè¦æ¨¡</td><td style="font-weight:bold;">${formatNumber(data['ç™¼è¡Œè¦æ¨¡'])} ç™¾è¬</td></tr>
                    <tr><td style="color:#666;">åº•æ¨™åƒ¹</td><td>${data['åº•æ¨™åƒ¹'] || '100'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">ç™¼è¡Œå¹´æœŸ</td><td>${data['å¹´æœŸ'] || '-'}å¹´</td></tr>
                    <tr><td style="color:#666;">å‰©é¤˜å¹´æœŸ</td><td style="color:${remainYears !== null && remainYears < 1 ? '#c62828' : '#333'}; font-weight:bold;">${remainYearsDisplay}</td></tr>
                    <tr><td style="color:#666;">ç™¼è¡Œåˆ¸å•†</td><td style="font-size:11px;">${data['ç™¼è¡Œåˆ¸å•†'] || '-'}</td></tr>
                    <tr><td style="color:#666;">è‚¡æœ¬è¦æ¨¡</td><td>${formatNumber(data['è‚¡æœ¬(å„„)'])} å„„</td></tr>
                </table>
            </div>
            
            <!-- è½‰æ›è³‡è¨Šå¡ -->
            <div style="background:#e8f5e9; padding:15px; border-radius:8px; border-left:4px solid #4caf50;">
                <div style="font-weight:bold; color:#2e7d32; margin-bottom:10px;">ğŸ”„ è½‰æ›è³‡è¨Š</div>
                <table style="width:100%; font-size:13px;">
                    <tr><td style="color:#666; width:40%;">è½‰æ›åƒ¹</td><td style="font-weight:bold; color:#c62828;">${convPrice || '-'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">å¼·è´–è§¸ç™¼åƒ¹</td><td style="color:#9c27b0; font-weight:bold;">${callTrigger130}å…ƒ <span style="font-size:10px; color:#999;">(130%)</span></td></tr>
                    <tr><td style="color:#666;">æ¯å¼µå¯æ›è‚¡æ•¸</td><td style="font-weight:bold;">${sharesPerBond} è‚¡</td></tr>
                    <tr><td style="color:#666;">æˆªæ¨™æ”¶ç›¤åƒ¹</td><td>${data['æˆªæ¨™æ”¶ç›¤'] || '-'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">ç†è«–åƒ¹</td><td style="color:#1976d2; font-weight:bold;">${data['ç†è«–åƒ¹'] || '-'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">å¹´åŒ–æ³¢å‹•</td><td>${data['å¹´åŒ–æ³¢å‹•'] ? (data['å¹´åŒ–æ³¢å‹•'] * 100).toFixed(2) + '%' : '-'}</td></tr>
                </table>
            </div>
            
            <!-- ç¬¬å››å¡ç‰‡ï¼šç«¶æ‹é¡¯ç¤ºçµæœï¼Œè©¢åœˆé¡¯ç¤ºæ›ç‰Œè¡¨ç¾ -->
            ${isAuction ? `
            <div style="background:#f3e5f5; padding:15px; border-radius:8px; border-left:4px solid #9c27b0;">
                <div style="font-weight:bold; color:#7b1fa2; margin-bottom:10px;">ğŸ¯ ç«¶æ‹çµæœ</div>
                <table style="width:100%; font-size:13px;">
                    <tr><td style="color:#666; width:40%;">é–‹æ¨™æ—¥æœŸ</td><td>${formatDate(data['é–‹æ¨™æ—¥æœŸ'])}</td></tr>
                    <tr><td style="color:#666;">æˆªæ¨™æ—¥</td><td>${formatDate(data['æˆªæ¨™æ—¥'])}</td></tr>
                    <tr><td style="color:#666;">æœ€ä½å¾—æ¨™</td><td style="font-weight:bold; color:#2e7d32;">${data['æœ€ä½å¾—æ¨™'] || '-'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">å¹³å‡å¾—æ¨™</td><td style="font-weight:bold; color:#e65100;">${data['å¹³å‡å¾—æ¨™'] || '-'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">æŠ•æ¨™å€æ•¸</td><td>${data['æŠ•æ¨™å€æ•¸'] ? data['æŠ•æ¨™å€æ•¸'].toFixed(2) + 'x' : '-'}</td></tr>
                    <tr><td style="color:#666;">åˆæ ¼ä»¶æ•¸</td><td>${data['åˆæ ¼ä»¶æ•¸'] || '-'} ä»¶</td></tr>
                </table>
            </div>
            ` : `
            <div style="background:#e0f7fa; padding:15px; border-radius:8px; border-left:4px solid #00bcd4;">
                <div style="font-weight:bold; color:#00838f; margin-bottom:10px;">ğŸ“Š æ›ç‰Œè¡¨ç¾</div>
                <table style="width:100%; font-size:13px;">
                    <tr><td style="color:#666; width:40%;">æ›ç‰Œæ—¥æœŸ</td><td>${formatDate(data['æ›ç‰Œæ—¥æœŸ'])}</td></tr>
                    <tr><td style="color:#666;">åˆ°æœŸæ—¥æœŸ</td><td>${formatDate(data['åˆ°æœŸæ—¥æœŸ'])}</td></tr>
                    <tr><td style="color:#666;">æ›ç‰Œæœ€é«˜</td><td style="font-weight:bold; color:#c62828;">${data['æ›ç‰Œæœ€é«˜'] || '-'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">æ›ç‰Œæœ€ä½</td><td style="font-weight:bold; color:#2e7d32;">${data['æ›ç‰Œæœ€ä½'] || '-'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">åˆ°æœŸé‚„æœ¬åƒ¹</td><td>${data['åˆ°æœŸé‚„æœ¬åƒ¹æ ¼'] || '-'}å…ƒ</td></tr>
                    <tr><td style="color:#666;">äº¤æ˜“ç‹€æ…‹</td><td style="color:${isListed ? '#2e7d32' : '#666'};">${isListed ? 'ğŸŸ¢ æ›ç‰Œä¸­' : 'âš« å·²ä¸‹å¸‚'}</td></tr>
                </table>
            </div>
            `}
        </div>
        
        <!-- v3.97z-s æ–°å¢ï¼šè½‰æ›é€²åº¦å€å¡Šï¼ˆåƒ…æ›ç‰Œä¸­ä¸”æœ‰è³‡æ–™æ™‚é¡¯ç¤ºï¼‰-->
        ${isListed && (convertedRatio !== null || remainRatio !== null) ? `
        <div style="margin-top:15px; background:#fafafa; padding:15px; border-radius:8px; border:1px solid #e0e0e0;">
            <div style="font-weight:bold; color:#555; margin-bottom:12px;">ğŸ“Š è½‰æ›é€²åº¦</div>
            <div style="display:flex; align-items:center; gap:20px; flex-wrap:wrap;">
                <div style="flex:1; min-width:200px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:4px;">
                        <span>å·²è½‰æ› ${convertedRatio || 0}%</span>
                        <span>å‰©é¤˜ ${remainRatio !== null ? remainRatio.toFixed(2) : '-'}%</span>
                    </div>
                    <div style="background:#e0e0e0; height:12px; border-radius:6px; overflow:hidden;">
                        <div style="background:linear-gradient(90deg, #4caf50, #8bc34a); height:100%; width:${convertedRatio || 0}%; transition:width 0.3s;"></div>
                    </div>
                </div>
                <div style="display:flex; gap:15px; font-size:12px;">
                    <div style="text-align:center;">
                        <div style="color:#999;">ç™¼è¡Œå¼µæ•¸</div>
                        <div style="font-weight:bold; color:#1976d2;">${formatNumber(totalShares)}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color:#999;">å·²è½‰æ›</div>
                        <div style="font-weight:bold; color:#4caf50;">${convertedShares !== null ? formatNumber(convertedShares) : '-'}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color:#999;">å‰©é¤˜å¼µæ•¸</div>
                        <div style="font-weight:bold; color:#e65100;">${outstandingShares !== null ? formatNumber(outstandingShares) : '-'}</div>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    `;
    
    container.innerHTML = html;
}

/**
 * æ¸²æŸ“ç™¼è¡Œæ™‚ç¨‹
 */
function renderBasicInfoSchedule(cbCode, container) {
    const searchCode = String(cbCode).trim();
    
    // å¾02å·¥ä½œè¡¨å–å¾—ç™¼è¡Œæ™‚ç¨‹
    let scheduleData = null;
    if (window.sheet02Data && window.sheet02Data.length > 0) {
        scheduleData = window.sheet02Data.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾08å·¥ä½œè¡¨å–å¾—è©³ç´°æ—¥æœŸ
    let sheet08Row = null;
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        sheet08Row = window.sheet08Data.find(r => String(r['ä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾ç«¶æ‹è³‡æ–™è£œå……
    let auctionData = null;
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        auctionData = window.auctionDataCache.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾01å·¥ä½œè¡¨è£œå……
    let sheet01Row = null;
    if (window.sheet01Data && window.sheet01Data.length > 0) {
        sheet01Row = window.sheet01Data.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    
    if (!scheduleData && !sheet08Row && !auctionData && !sheet01Row) {
        container.innerHTML = `<div style="color:#999; padding:20px; text-align:center;">âš ï¸ æ‰¾ä¸åˆ° ${cbCode} çš„ç™¼è¡Œæ™‚ç¨‹è³‡æ–™</div>`;
        return;
    }
    
    // æ•´åˆå„ä¾†æºè³‡æ–™
    const getValue = (...sources) => {
        for (const v of sources) {
            if (v !== undefined && v !== null && v !== '' && v !== '-') return v;
        }
        return '-';
    };
    
    const html = `
        <div style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding:20px; border-radius:8px;">
            <div style="font-weight:bold; color:#1565c0; margin-bottom:15px; font-size:16px;">ğŸ“… ${cbCode} ${getValue(scheduleData?.['åç¨±'], sheet08Row?.['åç¨±'], auctionData?.['åç¨±'])} ç™¼è¡Œæ™‚ç¨‹</div>
            
            <!-- é‡è¦æ—¥æœŸæ™‚é–“è»¸ -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:15px;">
                <div style="background:white; padding:12px 8px; border-radius:6px; text-align:center; border-left:3px solid #9c27b0;">
                    <div style="font-size:11px; color:#666;">è‘£äº‹æœƒå…¬å‘Š</div>
                    <div style="font-size:14px; font-weight:bold; color:#9c27b0;">${formatDate(getValue(scheduleData?.['è‘£äº‹æœƒå…¬å‘Š']))}</div>
                </div>
                <div style="background:white; padding:12px 8px; border-radius:6px; text-align:center; border-left:3px solid #673ab7;">
                    <div style="font-size:11px; color:#666;">é€ä»¶æ—¥æœŸ</div>
                    <div style="font-size:14px; font-weight:bold; color:#673ab7;">${formatDate(getValue(scheduleData?.['é€ä»¶æ—¥æœŸ']))}</div>
                </div>
                <div style="background:white; padding:12px 8px; border-radius:6px; text-align:center; border-left:3px solid #3f51b5;">
                    <div style="font-size:11px; color:#666;">ç”Ÿæ•ˆæ—¥æœŸ</div>
                    <div style="font-size:14px; font-weight:bold; color:#3f51b5;">${formatDate(getValue(scheduleData?.['ç”Ÿæ•ˆæ—¥æœŸ']))}</div>
                </div>
                <div style="background:white; padding:12px 8px; border-radius:6px; text-align:center; border-left:3px solid #2196f3;">
                    <div style="font-size:11px; color:#666;">è©¢åœˆ/ç«¶æ‹æ—¥</div>
                    <div style="font-size:14px; font-weight:bold; color:#2196f3;">${getValue(scheduleData?.['è©¢åœˆç«¶æ‹æ—¥æœŸ'], formatDate(auctionData?.['æˆªæ¨™æ—¥']))}</div>
                </div>
                <div style="background:white; padding:12px 8px; border-radius:6px; text-align:center; border-left:3px solid #009688;">
                    <div style="font-size:11px; color:#666;">ä»£æ”¶åƒ¹æ¬¾å…¬å‘Š</div>
                    <div style="font-size:14px; font-weight:bold; color:#009688;">${formatDate(getValue(scheduleData?.['ä»£æ”¶åƒ¹æ¬¾å…¬å‘Š']))}</div>
                </div>
                <div style="background:white; padding:12px 8px; border-radius:6px; text-align:center; border-left:3px solid #4caf50;">
                    <div style="font-size:11px; color:#666;">æ›ç‰Œæ—¥æœŸ</div>
                    <div style="font-size:14px; font-weight:bold; color:#4caf50;">${formatDate(getValue(scheduleData?.['æ›ç‰Œæ—¥æœŸ'], sheet08Row?.['æ›ç‰Œæ—¥æœŸ'], auctionData?.['æ›ç‰Œæ—¥æœŸ'], sheet01Row?.['æ›ç‰Œæ—¥æœŸ']))}</div>
                </div>
            </div>
            
            <!-- è½‰æ›æœŸé–“èˆ‡åˆ°æœŸè³‡è¨Š -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px; margin-bottom:15px;">
                <div style="background:rgba(255,255,255,0.9); padding:12px; border-radius:6px;">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">ğŸ”„ è½‰æ›æœŸé–“</div>
                    <div style="font-size:13px; color:#333;">
                        ${formatDate(getValue(sheet08Row?.['è½‰æ›æ—¥æœŸèµ·']))} ~ ${formatDate(getValue(sheet08Row?.['è½‰æ›æ—¥æœŸè¿„']))}
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.9); padding:12px; border-radius:6px;">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">ğŸ“… åˆ°æœŸæ—¥æœŸ</div>
                    <div style="font-size:13px; font-weight:bold; color:#d32f2f;">
                        ${formatDate(getValue(scheduleData?.['åˆ°æœŸæ—¥æœŸ'], sheet08Row?.['åˆ°æœŸæ—¥'], auctionData?.['åˆ°æœŸæ—¥æœŸ'], sheet01Row?.['åˆ°æœŸæ—¥æœŸ']))}
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.9); padding:12px; border-radius:6px;">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">ğŸ“† ç™¼è¡Œå¹´æœŸ</div>
                    <div style="font-size:13px; font-weight:bold; color:#7b1fa2;">
                        ${getValue(sheet08Row?.['é‚„æœ¬å¹´é™'], auctionData?.['å¹´æœŸ'], sheet01Row?.['ç™¼è¡Œå¹´æœŸ'])} å¹´
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.9); padding:12px; border-radius:6px;">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">ğŸ”§ CBASæ‹†è§£æ—¥</div>
                    <div style="font-size:13px; color:#333;">
                        ${formatDate(getValue(scheduleData?.['CBASæ‹†è§£æ—¥']))}
                    </div>
                </div>
            </div>
            
            <!-- åœæ­¢è½‰æ›ç™»è¨˜ -->
            ${sheet08Row?.['åœæ­¢å—ç†è½‰æ›ç™»è¨˜æ—¥æœŸèµ·'] ? `
            <div style="background:rgba(255,193,7,0.2); padding:10px 12px; border-radius:6px; border-left:3px solid #ffc107;">
                <div style="font-size:12px; color:#666;">âš ï¸ åœæ­¢å—ç†è½‰æ›ç™»è¨˜æœŸé–“</div>
                <div style="font-size:13px; color:#f57c00; font-weight:bold;">
                    ${formatDate(sheet08Row['åœæ­¢å—ç†è½‰æ›ç™»è¨˜æ—¥æœŸèµ·'])} ~ ${formatDate(sheet08Row['åœæ­¢å—ç†è½‰æ›ç™»è¨˜æ—¥æœŸè¨–'])}
                </div>
            </div>
            ` : ''}
        </div>
    `;
    
    container.innerHTML = html;
}

/**
 * æ¸²æŸ“è³£å›æ¢ä»¶ï¼ˆæ•´åˆ03å·¥ä½œè¡¨å’Œ08å·¥ä½œè¡¨ï¼‰
 */
function renderBasicInfoPutback(cbCode, container) {
    const searchCode = String(cbCode).trim();
    
    // å¾03å·¥ä½œè¡¨å–å¾—è³£å›æ¢ä»¶
    let putbackData = null;
    if (window.sheet03Data && window.sheet03Data.length > 0) {
        putbackData = window.sheet03Data.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾08å·¥ä½œè¡¨å–å¾—æå‰å„Ÿé‚„è³‡è¨Š
    let sheet08Row = null;
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        sheet08Row = window.sheet08Data.find(r => String(r['ä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾ç«¶æ‹è³‡æ–™è£œå……
    let auctionData = null;
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        auctionData = window.auctionDataCache.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾01å·¥ä½œè¡¨è£œå……
    let sheet01Row = null;
    if (window.sheet01Data && window.sheet01Data.length > 0) {
        sheet01Row = window.sheet01Data.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    
    if (!putbackData && !sheet08Row && !auctionData && !sheet01Row) {
        container.innerHTML = `<div style="color:#999; padding:20px; text-align:center;">âš ï¸ æ‰¾ä¸åˆ° ${cbCode} çš„è³£å›æ¢ä»¶è³‡æ–™</div>`;
        return;
    }
    
    const getValue = (...sources) => {
        for (const v of sources) {
            if (v !== undefined && v !== null && v !== '' && v !== '-') return v;
        }
        return '-';
    };
    
    // æ“”ä¿ç‹€æ…‹åˆ¤æ–·
    const guaranteeRaw = getValue(sheet08Row?.['å‚µåˆ¸æ“”ä¿æƒ…å½¢'], auctionData?.['æ“”ä¿'], sheet01Row?.['æ“”ä¿']);
    const isGuaranteed = guaranteeRaw && guaranteeRaw !== 'ç„¡' && guaranteeRaw !== '-';
    const guaranteeColor = isGuaranteed ? '#2e7d32' : '#757575';
    const guaranteeIcon = isGuaranteed ? 'ğŸ›¡ï¸' : 'ğŸ“';
    
    const html = `
        <div style="background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding:20px; border-radius:8px;">
            <div style="font-weight:bold; color:#e65100; margin-bottom:15px; font-size:16px;">ğŸ’° ${cbCode} ${getValue(putbackData?.['åç¨±'], sheet08Row?.['åç¨±'])} è³£å›æ¢ä»¶</div>
            
            <!-- æŠ•è³‡äººè³£å›æ¬Š -->
            <div style="background:white; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #ff9800;">
                <div style="font-size:13px; color:#666; margin-bottom:8px;">ğŸ“‹ æŠ•è³‡äººæå‰è³£å›æ¬Š</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
                    <div>
                        <div style="font-size:11px; color:#999;">è³£å›æ¢ä»¶</div>
                        <div style="font-size:14px; font-weight:bold; color:#e65100;">${getValue(putbackData?.['æŠ•è³‡äººæå‰è³£å›'])}</div>
                    </div>
                    <div>
                        <div style="font-size:11px; color:#999;">è³£å›æ—¥æœŸ1</div>
                        <div style="font-size:14px; font-weight:bold; color:#1976d2;">${formatDate(getValue(putbackData?.['è³£å›æ—¥æœŸ1']))}</div>
                    </div>
                    <div>
                        <div style="font-size:11px; color:#999;">è³£å›æ—¥æœŸ2</div>
                        <div style="font-size:14px; font-weight:bold; color:#1976d2;">${formatDate(getValue(putbackData?.['è³£å›æ—¥æœŸ2']))}</div>
                    </div>
                </div>
                ${putbackData?.['è³£å›æ¢ä»¶'] ? `
                <div style="margin-top:10px; padding:8px; background:#fff8e1; border-radius:4px; font-size:12px; color:#f57c00;">
                    <strong>è³£å›å…¬å¼ï¼š</strong>${putbackData['è³£å›æ¢ä»¶']}
                </div>
                ` : ''}
            </div>
            
            <!-- ç™¼è¡Œäººæå‰å„Ÿé‚„ï¼ˆå¾08å·¥ä½œè¡¨ï¼‰-->
            ${sheet08Row ? `
            <div style="background:white; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #9c27b0;">
                <div style="font-size:13px; color:#666; margin-bottom:8px;">ğŸ¢ ç™¼è¡Œäººæå‰å„Ÿé‚„æ¬Š</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                    <div>
                        <div style="font-size:11px; color:#999;">æå‰å„Ÿé‚„æ¢ä»¶</div>
                        <div style="font-size:13px; color:#333;">${getValue(sheet08Row['æå‰å„Ÿé‚„æ—¥'])}</div>
                    </div>
                    <div>
                        <div style="font-size:11px; color:#999;">æœ€è¿‘æå‰å„Ÿé‚„æ—¥</div>
                        <div style="font-size:14px; font-weight:bold; color:#9c27b0;">${formatDate(getValue(sheet08Row['æœ€è¿‘æå‰å„Ÿé‚„æ—¥']))}</div>
                    </div>
                    <div>
                        <div style="font-size:11px; color:#999;">æœ€è¿‘æå‰å„Ÿé‚„åƒ¹æ ¼</div>
                        <div style="font-size:14px; font-weight:bold; color:#e65100;">${getValue(sheet08Row['æœ€è¿‘æå‰å„Ÿé‚„åƒ¹æ ¼'])} å…ƒ</div>
                    </div>
                </div>
                
                <!-- å„æœŸæå‰å„Ÿé‚„æ˜ç´° -->
                ${sheet08Row['æå‰å„Ÿé‚„æ—¥1'] ? `
                <div style="margin-top:12px; padding-top:12px; border-top:1px dashed #ddd;">
                    <div style="font-size:11px; color:#999; margin-bottom:8px;">å„æœŸæå‰å„Ÿé‚„åƒ¹æ ¼</div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        ${sheet08Row['æå‰å„Ÿé‚„æ—¥1'] ? `<span style="background:#f3e5f5; padding:4px 8px; border-radius:4px; font-size:12px;">ç¬¬1æœŸ ${formatDate(sheet08Row['æå‰å„Ÿé‚„æ—¥1'])} @ ${sheet08Row['æå‰å„Ÿé‚„åƒ¹æ ¼1']}å…ƒ</span>` : ''}
                        ${sheet08Row['æå‰å„Ÿé‚„æ—¥2'] ? `<span style="background:#f3e5f5; padding:4px 8px; border-radius:4px; font-size:12px;">ç¬¬2æœŸ ${formatDate(sheet08Row['æå‰å„Ÿé‚„æ—¥2'])} @ ${sheet08Row['æå‰å„Ÿé‚„åƒ¹æ ¼2']}å…ƒ</span>` : ''}
                        ${sheet08Row['æå‰å„Ÿé‚„æ—¥3'] ? `<span style="background:#f3e5f5; padding:4px 8px; border-radius:4px; font-size:12px;">ç¬¬3æœŸ ${formatDate(sheet08Row['æå‰å„Ÿé‚„æ—¥3'])} @ ${sheet08Row['æå‰å„Ÿé‚„åƒ¹æ ¼3']}å…ƒ</span>` : ''}
                        ${sheet08Row['æå‰å„Ÿé‚„æ—¥4'] ? `<span style="background:#f3e5f5; padding:4px 8px; border-radius:4px; font-size:12px;">ç¬¬4æœŸ ${formatDate(sheet08Row['æå‰å„Ÿé‚„æ—¥4'])} @ ${sheet08Row['æå‰å„Ÿé‚„åƒ¹æ ¼4']}å…ƒ</span>` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
            ` : ''}
            
            <!-- åˆ°æœŸé‚„æœ¬èˆ‡æ“”ä¿ -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">åˆ°æœŸé‚„æœ¬åƒ¹æ ¼</div>
                    <div style="font-size:18px; font-weight:bold; color:#d32f2f;">
                        ${getValue(sheet08Row?.['åˆ°æœŸåƒ¹æ ¼'], sheet01Row?.['åˆ°æœŸé‚„æœ¬åƒ¹æ ¼'])} å…ƒ
                    </div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">åˆ°æœŸæ®–åˆ©ç‡</div>
                    <div style="font-size:18px; font-weight:bold; color:#1976d2;">
                        ${getValue(sheet08Row?.['åˆ°æœŸæ®–åˆ©ç‡'])}%
                    </div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">${guaranteeIcon} æ“”ä¿ç‹€æ…‹</div>
                    <div style="font-size:14px; font-weight:bold; color:${guaranteeColor};">
                        ${isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿'}
                    </div>
                </div>
            </div>
            
            ${isGuaranteed && guaranteeRaw.length > 5 ? `
            <div style="margin-top:10px; padding:8px 12px; background:rgba(46,125,50,0.1); border-radius:6px; font-size:12px; color:#2e7d32;">
                <strong>æ“”ä¿æ©Ÿæ§‹ï¼š</strong>${guaranteeRaw.replace('æœ‰ï¼Œ', '')}
            </div>
            ` : ''}
        </div>
    `;
    
    container.innerHTML = html;
}

/**
 * æ¸²æŸ“ç«¶æ‹è³‡æ–™
 */
function renderBasicInfoAuction(cbCode, container) {
    let data = null;
    const searchCode = String(cbCode).trim();
    
    // å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºç«¶æ‹ç™¼è¡Œ
    const db = window.cbDatabase;
    const cbInfo = db.allCB.find(cb => cb.code === searchCode);
    const isAuction = cbInfo?.isAuction || db.auctionCodes.has(searchCode);
    
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        data = window.auctionDataCache.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    if (!data && window.auctionRawData && window.auctionRawData.length > 0) {
        data = window.auctionRawData.find(r => String(r.cbCode).trim() === searchCode);
    }
    if (!data && db.auction[searchCode]) {
        data = db.auction[searchCode];
    }
    
    if (!data || !isAuction) {
        // è©¢åœˆç™¼è¡Œ - é¡¯ç¤ºèªªæ˜
        container.innerHTML = `
            <div style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding:25px; border-radius:8px; text-align:center;">
                <div style="font-size:48px; margin-bottom:15px;">ğŸ“‹</div>
                <div style="font-weight:bold; color:#1976d2; font-size:18px; margin-bottom:10px;">æœ¬æª”ç‚ºè©¢åœˆç™¼è¡Œ</div>
                <div style="color:#666; font-size:14px; line-height:1.8;">
                    ${cbCode} æ¡ç”¨è©¢åœˆæ–¹å¼ç™¼è¡Œï¼Œç„¡å…¬é–‹ç«¶æ‹è³‡æ–™ã€‚<br>
                    è©¢åœˆç™¼è¡Œç”±æ‰¿éŠ·å•†å‘ç‰¹å®šæ³•äººè©¢åƒ¹åœˆè³¼ï¼Œ<br>
                    ä¸ç¶“ç”±å…¬é–‹ç«¶æ¨™ç¨‹åºã€‚
                </div>
                <div style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.8); border-radius:6px;">
                    <div style="font-size:12px; color:#666;">ğŸ’¡ æç¤º</div>
                    <div style="font-size:13px; color:#333; margin-top:5px;">
                        å¯åˆ‡æ›è‡³ã€ŒåŸºæœ¬è³‡æ–™ã€æˆ–ã€Œç™¼è¡Œæ™‚ç¨‹ã€æŸ¥çœ‹å…¶ä»–ç™¼è¡Œæ¢ä»¶
                    </div>
                </div>
            </div>`;
        return;
    }
    
    const html = `
        <div style="background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding:20px; border-radius:8px;">
            <div style="font-weight:bold; color:#2e7d32; margin-bottom:15px; font-size:16px;">ğŸ¯ ${cbCode} ç«¶æ‹è³‡æ–™</div>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">é–‹æ¨™æ—¥æœŸ</div>
                    <div style="font-size:14px; font-weight:bold; color:#2e7d32;">${formatDate(data['é–‹æ¨™æ—¥æœŸ'])}</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">æˆªæ¨™æ—¥</div>
                    <div style="font-size:14px; font-weight:bold;">${formatDate(data['æˆªæ¨™æ—¥'])}</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">ç«¶æ‹å¼µæ•¸</div>
                    <div style="font-size:14px; font-weight:bold;">${formatNumber(data['ç«¶æ‹å¼µæ•¸'])}å¼µ</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">åº•æ¨™åƒ¹</div>
                    <div style="font-size:14px; font-weight:bold; color:#c62828;">${data['åº•æ¨™åƒ¹'] || '-'}å…ƒ</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">æˆªæ¨™æ”¶ç›¤åƒ¹</div>
                    <div style="font-size:14px; font-weight:bold;">${data['æˆªæ¨™æ”¶ç›¤'] || '-'}å…ƒ</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">è½‰æ›åƒ¹</div>
                    <div style="font-size:14px; font-weight:bold;">${data['è½‰æ›åƒ¹'] || '-'}å…ƒ</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">ç†è«–åƒ¹</div>
                    <div style="font-size:14px; font-weight:bold; color:#1976d2;">${data['ç†è«–åƒ¹'] || '-'}å…ƒ</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center; border:2px solid #4caf50;">
                    <div style="font-size:11px; color:#666;">æœ€ä½å¾—æ¨™</div>
                    <div style="font-size:16px; font-weight:bold; color:#2e7d32;">${data['æœ€ä½å¾—æ¨™'] || '-'}å…ƒ</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">æœ€ä½æº¢åƒ¹</div>
                    <div style="font-size:14px; font-weight:bold; color:#e65100;">${data['æœ€ä½æº¢åƒ¹'] ? (data['æœ€ä½æº¢åƒ¹'] * 100).toFixed(2) + '%' : '-'}</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center; border:2px solid #ff9800;">
                    <div style="font-size:11px; color:#666;">å¹³å‡å¾—æ¨™</div>
                    <div style="font-size:16px; font-weight:bold; color:#e65100;">${data['å¹³å‡å¾—æ¨™'] || '-'}å…ƒ</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">å¹³å‡æº¢åƒ¹</div>
                    <div style="font-size:14px; font-weight:bold;">${data['å¹³å‡æº¢åƒ¹'] ? (data['å¹³å‡æº¢åƒ¹'] * 100).toFixed(2) + '%' : '-'}</div>
                </div>
                <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">æŠ•æ¨™å€æ•¸</div>
                    <div style="font-size:14px; font-weight:bold; color:#7b1fa2;">${data['æŠ•æ¨™å€æ•¸'] ? data['æŠ•æ¨™å€æ•¸'].toFixed(2) + 'x' : '-'}</div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

/**
 * æ¸²æŸ“æœ€æ–°è¡Œæƒ…ï¼ˆæ•´åˆ09å·¥ä½œè¡¨ï¼‰
 */
function renderBasicInfoQuote(cbCode, container) {
    const searchCode = String(cbCode).trim();
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);
    
    // å¾09å·¥ä½œè¡¨å–å¾—æœ€æ–°è¡Œæƒ…ï¼ˆæ›ç‰Œä¸­CBï¼‰
    let quoteData = null;
    if (window.sheet09Data && window.sheet09Data.length > 0) {
        quoteData = window.sheet09Data.find(r => String(r['ä»£ç¢¼']).trim() === searchCode);
    }
    
    // å¾ç«¶æ‹è³‡æ–™å–å¾—æˆªæ¨™æ—¥è³‡è¨Š
    let auctionData = null;
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        auctionData = window.auctionDataCache.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾08å·¥ä½œè¡¨è£œå……
    let sheet08Row = null;
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        sheet08Row = window.sheet08Data.find(r => String(r['ä»£è™Ÿ']).trim() === searchCode);
    }
    
    if (!quoteData && !auctionData && !sheet08Row) {
        container.innerHTML = `<div style="color:#999; padding:20px; text-align:center;">âš ï¸ æ‰¾ä¸åˆ° ${cbCode} çš„è¡Œæƒ…è³‡æ–™</div>`;
        return;
    }
    
    // å¦‚æœæ˜¯æ›ç‰Œä¸­ä¸”æœ‰09å·¥ä½œè¡¨è³‡æ–™ï¼Œé¡¯ç¤ºæœ€æ–°è¡Œæƒ…
    if (isListed && quoteData) {
        const cbPrice = parseFloat(quoteData['CBæ”¶ç›¤åƒ¹']) || 0;
        const stockPrice = parseFloat(quoteData['è‚¡åƒ¹']) || 0;
        const convPrice = parseFloat(quoteData['è½‰æ›åƒ¹æ ¼']) || 0;
        const convValue = parseFloat(quoteData['è½‰æ›åƒ¹å€¼']) || 0;
        const premium = parseFloat(quoteData['æº¢(æŠ˜)åƒ¹%']) || 0;
        const premiumColor = premium >= 0 ? '#d32f2f' : '#2e7d32';
        const premiumSign = premium >= 0 ? '+' : '';
        
        const html = `
            <div style="background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding:20px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div style="font-weight:bold; color:#2e7d32; font-size:16px;">ğŸ“Š ${cbCode} ${quoteData['åç¨±  '] || ''} æœ€æ–°è¡Œæƒ…</div>
                    <div style="font-size:11px; color:#666; background:white; padding:4px 8px; border-radius:4px;">ğŸŸ¢ æ›ç‰Œä¸­</div>
                </div>
                
                <!-- ä¸»è¦å ±åƒ¹ -->
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-bottom:15px;">
                    <div style="background:white; padding:15px 10px; border-radius:6px; text-align:center; border:2px solid #4caf50;">
                        <div style="font-size:11px; color:#666;">CBæ”¶ç›¤åƒ¹</div>
                        <div style="font-size:20px; font-weight:bold; color:#2e7d32;">${cbPrice || '-'}</div>
                    </div>
                    <div style="background:white; padding:15px 10px; border-radius:6px; text-align:center;">
                        <div style="font-size:11px; color:#666;">è‚¡ç¥¨æ”¶ç›¤</div>
                        <div style="font-size:18px; font-weight:bold; color:#1976d2;">${stockPrice || '-'}</div>
                    </div>
                    <div style="background:white; padding:15px 10px; border-radius:6px; text-align:center;">
                        <div style="font-size:11px; color:#666;">è½‰æ›åƒ¹æ ¼</div>
                        <div style="font-size:16px; font-weight:bold;">${convPrice || '-'}</div>
                    </div>
                    <div style="background:white; padding:15px 10px; border-radius:6px; text-align:center;">
                        <div style="font-size:11px; color:#666;">è½‰æ›åƒ¹å€¼</div>
                        <div style="font-size:16px; font-weight:bold; color:#7b1fa2;">${convValue ? convValue.toFixed(2) : '-'}</div>
                    </div>
                    <div style="background:white; padding:15px 10px; border-radius:6px; text-align:center; border:2px solid ${premiumColor};">
                        <div style="font-size:11px; color:#666;">æº¢(æŠ˜)åƒ¹ç‡</div>
                        <div style="font-size:18px; font-weight:bold; color:${premiumColor};">${premiumSign}${premium.toFixed(2)}%</div>
                    </div>
                </div>
                
                <!-- è©³ç´°è³‡è¨Š -->
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:8px; margin-bottom:15px;">
                    <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                        <div style="font-size:10px; color:#999;">æˆäº¤é‡(å¼µ)</div>
                        <div style="font-size:13px; font-weight:bold;">${quoteData['æˆäº¤é‡'] || '-'}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                        <div style="font-size:10px; color:#999;">YTM</div>
                        <div style="font-size:13px; font-weight:bold;">${quoteData['YTM'] || '-'}%</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                        <div style="font-size:10px; color:#999;">YTP</div>
                        <div style="font-size:13px; font-weight:bold;">${quoteData['YTP'] || '-'}%</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                        <div style="font-size:10px; color:#999;">TCRI</div>
                        <div style="font-size:13px; font-weight:bold;">${quoteData['TCRI'] || '-'}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                        <div style="font-size:10px; color:#999;">120æ—¥æ³¢å‹•</div>
                        <div style="font-size:13px; font-weight:bold;">${quoteData['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©(%)'] || '-'}%</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                        <div style="font-size:10px; color:#999;">240æ—¥æ³¢å‹•</div>
                        <div style="font-size:13px; font-weight:bold;">${quoteData['è‚¡åƒ¹æ³¢å‹•ç‡240å¤©(%)'] || '-'}%</div>
                    </div>
                </div>
                
                <!-- æ³•äººå‹•å‘ -->
                <div style="background:rgba(255,255,255,0.9); padding:12px; border-radius:6px;">
                    <div style="font-size:12px; color:#666; margin-bottom:8px;">ğŸ“ˆ æ³•äººè²·è³£è¶…</div>
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; text-align:center;">
                        <div>
                            <div style="font-size:10px; color:#999;">è‡ªç‡Ÿå•†è²·</div>
                            <div style="font-size:13px; font-weight:bold; color:#d32f2f;">${quoteData['è‡ªç‡Ÿå•†è²·å¼µæ•¸'] || 0}</div>
                        </div>
                        <div>
                            <div style="font-size:10px; color:#999;">è‡ªç‡Ÿå•†è³£</div>
                            <div style="font-size:13px; font-weight:bold; color:#2e7d32;">${quoteData['è‡ªç‡Ÿå•†è³£å¼µæ•¸'] || 0}</div>
                        </div>
                        <div>
                            <div style="font-size:10px; color:#999;">å¤–è³‡è²·</div>
                            <div style="font-size:13px; font-weight:bold; color:#d32f2f;">${quoteData['å¤–è³‡è²·å¼µæ•¸'] || 0}</div>
                        </div>
                        <div>
                            <div style="font-size:10px; color:#999;">å¤–è³‡è³£</div>
                            <div style="font-size:13px; font-weight:bold; color:#2e7d32;">${quoteData['å¤–è³‡è³£å¼µæ•¸'] || 0}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = html;
        return;
    }
    
    // å·²ä¸‹å¸‚CBæˆ–ç„¡09è³‡æ–™ï¼Œé¡¯ç¤ºæˆªæ¨™æ—¥è¡Œæƒ…
    if (auctionData) {
        const stockPrice = parseFloat(auctionData['æˆªæ¨™æ”¶ç›¤']) || 0;
        const convPrice = parseFloat(auctionData['è½‰æ›åƒ¹']) || 0;
        const theoPrice = parseFloat(auctionData['ç†è«–åƒ¹']) || 0;
        const convValue = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;
        
        const html = `
            <div style="background:linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); padding:20px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div style="font-weight:bold; color:#c2185b; font-size:16px;">ğŸ“Š ${cbCode} æˆªæ¨™æ—¥è¡Œæƒ…</div>
                    <div style="font-size:11px; color:#666; background:white; padding:4px 8px; border-radius:4px;">âš« ${isListed ? 'æ›ç‰Œä¸­(ç„¡å³æ™‚å ±åƒ¹)' : 'å·²ä¸‹å¸‚'}</div>
                </div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
                    <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                        <div style="font-size:11px; color:#666;">æˆªæ¨™æ—¥è‚¡åƒ¹</div>
                        <div style="font-size:16px; font-weight:bold; color:#c2185b;">${stockPrice || '-'}å…ƒ</div>
                    </div>
                    <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                        <div style="font-size:11px; color:#666;">è½‰æ›åƒ¹æ ¼</div>
                        <div style="font-size:14px; font-weight:bold;">${convPrice || '-'}å…ƒ</div>
                    </div>
                    <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                        <div style="font-size:11px; color:#666;">è½‰æ›åƒ¹å€¼</div>
                        <div style="font-size:14px; font-weight:bold; color:#1976d2;">${convValue ? convValue.toFixed(2) : '-'}å…ƒ</div>
                    </div>
                    <div style="background:white; padding:12px; border-radius:6px; text-align:center; border:2px solid #9c27b0;">
                        <div style="font-size:11px; color:#666;">ç†è«–åƒ¹</div>
                        <div style="font-size:16px; font-weight:bold; color:#7b1fa2;">${theoPrice || '-'}å…ƒ</div>
                    </div>
                    <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                        <div style="font-size:11px; color:#666;">å¹´åŒ–æ³¢å‹•ç‡</div>
                        <div style="font-size:14px; font-weight:bold;">${auctionData['å¹´åŒ–æ³¢å‹•'] ? (auctionData['å¹´åŒ–æ³¢å‹•'] * 100).toFixed(2) + '%' : '-'}</div>
                    </div>
                    <div style="background:white; padding:12px; border-radius:6px; text-align:center;">
                        <div style="font-size:11px; color:#666;">æŠ•æ¨™å€æ•¸</div>
                        <div style="font-size:14px; font-weight:bold; color:#e65100;">${auctionData['æŠ•æ¨™å€æ•¸'] ? auctionData['æŠ•æ¨™å€æ•¸'].toFixed(2) + 'x' : '-'}</div>
                    </div>
                </div>
                <div style="margin-top:15px; padding:10px; background:rgba(255,255,255,0.8); border-radius:6px; font-size:12px; color:#666;">
                    ğŸ’¡ ä»¥ä¸Šç‚ºæˆªæ¨™æ—¥ä¹‹è¡Œæƒ…è³‡æ–™${isListed ? 'ï¼Œå¦‚éœ€æœ€æ–°å ±åƒ¹è«‹æ›´æ–°09å·¥ä½œè¡¨' : ''}
                </div>
            </div>
        `;
        container.innerHTML = html;
        return;
    }
    
    // è©¢åœˆç™¼è¡Œï¼Œç„¡è¡Œæƒ…è³‡æ–™
    container.innerHTML = `
        <div style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding:25px; border-radius:8px; text-align:center;">
            <div style="font-size:48px; margin-bottom:15px;">ğŸ“‹</div>
            <div style="font-weight:bold; color:#1976d2; font-size:16px; margin-bottom:10px;">${cbCode} è©¢åœˆç™¼è¡Œ</div>
            <div style="color:#666; font-size:13px;">ç„¡ç«¶æ‹æˆªæ¨™æ—¥è¡Œæƒ…è³‡æ–™</div>
            ${isListed ? `<div style="margin-top:10px; font-size:12px; color:#999;">å¦‚éœ€æœ€æ–°å ±åƒ¹ï¼Œè«‹ç¢ºèª09å·¥ä½œè¡¨å·²æ›´æ–°</div>` : ''}
        </div>
    `;
}

/**
 * æ¸²æŸ“é¤˜é¡è®ŠåŒ–ï¼ˆæ•´åˆ09/10å·¥ä½œè¡¨å’Œ08å·¥ä½œè¡¨ï¼‰
 */
function renderBasicInfoBalance(cbCode, container) {
    const searchCode = String(cbCode).trim();
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);
    
    // å¾10å·¥ä½œè¡¨å–å¾—é¤˜é¡è®ŠåŒ–ï¼ˆæ›ç‰Œä¸­CBï¼‰
    let balanceData = null;
    if (window.sheet10Data && window.sheet10Data.length > 0) {
        balanceData = window.sheet10Data.find(r => String(r['è­‰åˆ¸ä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾09å·¥ä½œè¡¨å–å¾—é¤˜é¡è³‡è¨Š
    let quoteData = null;
    if (window.sheet09Data && window.sheet09Data.length > 0) {
        quoteData = window.sheet09Data.find(r => String(r['ä»£ç¢¼']).trim() === searchCode);
    }
    
    // å¾08å·¥ä½œè¡¨å–å¾—ç™¼è¡Œè³‡è¨Š
    let sheet08Row = null;
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        sheet08Row = window.sheet08Data.find(r => String(r['ä»£è™Ÿ']).trim() === searchCode);
    }
    
    // å¾ç«¶æ‹è³‡æ–™è£œå……
    let auctionData = null;
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        auctionData = window.auctionDataCache.find(r => String(r['CBä»£è™Ÿ']).trim() === searchCode);
    }
    
    if (!balanceData && !quoteData && !sheet08Row && !auctionData) {
        container.innerHTML = `<div style="color:#999; padding:20px; text-align:center;">âš ï¸ æ‰¾ä¸åˆ° ${cbCode} çš„é¤˜é¡è³‡æ–™</div>`;
        return;
    }
    
    const getValue = (...sources) => {
        for (const v of sources) {
            if (v !== undefined && v !== null && v !== '' && v !== '-') return v;
        }
        return null;
    };
    
    // ç™¼è¡Œè¦æ¨¡ï¼ˆç™¾è¬è½‰æ›ï¼‰
    const issueSize = getValue(sheet08Row?.['å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)'], auctionData?.['ç™¼è¡Œè¦æ¨¡']);
    const issueSizeDisplay = issueSize ? formatNumber(issueSize) + ' ç™¾è¬' : '-';
    
    // æœ€æ–°é¤˜é¡
    const latestBalance = getValue(sheet08Row?.['æœ€æ–°é¤˜é¡(ç™¾è¬)']);
    const latestBalanceDisplay = latestBalance ? formatNumber(latestBalance) + ' ç™¾è¬' : '-';
    
    // å‰©é¤˜æ¯”ç‡
    const remainRatio = getValue(quoteData?.['å‰©é¤˜æœªè½‰æ›æ¯”ç‡%']);
    const remainRatioDisplay = remainRatio ? parseFloat(remainRatio).toFixed(2) + '%' : '-';
    const remainColor = remainRatio ? (parseFloat(remainRatio) > 50 ? '#2e7d32' : parseFloat(remainRatio) > 20 ? '#ff9800' : '#d32f2f') : '#666';
    
    // æµé€šå¼µæ•¸
    const outstandingShares = getValue(quoteData?.['æµé€šåœ¨å¤–é¤˜é¡(å¼µ)']);
    const totalShares = getValue(quoteData?.['ç™¼è¡Œç¸½é‡(å¼µ)']);
    
    // æœ¬é€±è®ŠåŒ–ï¼ˆå¾10å·¥ä½œè¡¨ï¼‰
    const weekChange = balanceData ? parseFloat(balanceData['å¢æ¸›æ•¸é¡']) || 0 : null;
    const weekChangeRatio = balanceData ? parseFloat(balanceData['å¢æ¸›æ¯”ç‡']) || 0 : null;
    const weekChangeColor = weekChange > 0 ? '#d32f2f' : weekChange < 0 ? '#2e7d32' : '#666';
    const weekChangeSign = weekChange > 0 ? '+' : '';
    
    const html = `
        <div style="background:linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); padding:20px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-weight:bold; color:#00838f; font-size:16px;">ğŸ“ˆ ${cbCode} é¤˜é¡è®ŠåŒ–</div>
                <div style="font-size:11px; color:#666; background:white; padding:4px 8px; border-radius:4px;">
                    ${isListed ? 'ğŸŸ¢ æ›ç‰Œä¸­' : 'âš« å·²ä¸‹å¸‚'}
                </div>
            </div>
            
            <!-- ä¸»è¦é¤˜é¡è³‡è¨Š -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:15px;">
                <div style="background:white; padding:15px 10px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">åŸå§‹ç™¼è¡Œè¦æ¨¡</div>
                    <div style="font-size:16px; font-weight:bold; color:#00838f;">${issueSizeDisplay}</div>
                    ${totalShares ? `<div style="font-size:10px; color:#999;">${formatNumber(totalShares)} å¼µ</div>` : ''}
                </div>
                <div style="background:white; padding:15px 10px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">æœ€æ–°é¤˜é¡</div>
                    <div style="font-size:16px; font-weight:bold; color:#1976d2;">${latestBalanceDisplay}</div>
                    ${outstandingShares ? `<div style="font-size:10px; color:#999;">${formatNumber(outstandingShares)} å¼µ</div>` : ''}
                </div>
                <div style="background:white; padding:15px 10px; border-radius:6px; text-align:center; border:2px solid ${remainColor};">
                    <div style="font-size:11px; color:#666;">å‰©é¤˜æ¯”ç‡</div>
                    <div style="font-size:18px; font-weight:bold; color:${remainColor};">${remainRatioDisplay}</div>
                </div>
            </div>
            
            ${isListed && balanceData ? `
            <!-- æœ¬é€±è®ŠåŒ–ï¼ˆæ›ç‰Œä¸­CBï¼‰-->
            <div style="background:white; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid ${weekChangeColor};">
                <div style="font-size:12px; color:#666; margin-bottom:8px;">ğŸ“Š æœ¬é€±é¤˜é¡è®ŠåŒ–</div>
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px; text-align:center;">
                    <div>
                        <div style="font-size:10px; color:#999;">æœ¬é€±è‚¡é¡</div>
                        <div style="font-size:14px; font-weight:bold;">${formatNumber(balanceData['æœ¬é€±è‚¡é¡'])}</div>
                    </div>
                    <div>
                        <div style="font-size:10px; color:#999;">ä¸Šé€±è‚¡é¡</div>
                        <div style="font-size:14px; font-weight:bold;">${formatNumber(balanceData['ä¸Šé€±è‚¡é¡'])}</div>
                    </div>
                    <div>
                        <div style="font-size:10px; color:#999;">å¢æ¸›æ•¸é¡</div>
                        <div style="font-size:14px; font-weight:bold; color:${weekChangeColor};">
                            ${weekChangeSign}${formatNumber(weekChange)}
                            ${weekChangeRatio ? `<span style="font-size:11px;">(${weekChangeSign}${weekChangeRatio.toFixed(2)}%)</span>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- ç™¼è¡Œè³‡è¨Š -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:10px;">
                <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                    <div style="font-size:10px; color:#999;">ç™¼è¡Œåˆ¸å•†</div>
                    <div style="font-size:12px; font-weight:bold; color:#7b1fa2;">${getValue(sheet08Row?.['æ‰¿éŠ·æ©Ÿæ§‹'], auctionData?.['ç™¼è¡Œåˆ¸å•†']) || '-'}</div>
                </div>
                ${auctionData ? `
                <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                    <div style="font-size:10px; color:#999;">ç«¶æ‹å¼µæ•¸</div>
                    <div style="font-size:12px; font-weight:bold;">${formatNumber(auctionData['ç«¶æ‹å¼µæ•¸'])} å¼µ</div>
                </div>
                <div style="background:rgba(255,255,255,0.8); padding:10px; border-radius:4px; text-align:center;">
                    <div style="font-size:10px; color:#999;">æŠ•æ¨™å€æ•¸</div>
                    <div style="font-size:12px; font-weight:bold; color:#e65100;">${auctionData['æŠ•æ¨™å€æ•¸'] ? auctionData['æŠ•æ¨™å€æ•¸'].toFixed(2) + 'x' : '-'}</div>
                </div>
                ` : ''}
            </div>
            
            ${!isListed ? `
            <div style="margin-top:15px; padding:10px; background:rgba(255,255,255,0.8); border-radius:6px; font-size:12px; color:#666;">
                âš« æœ¬æª”å·²ä¸‹å¸‚ï¼Œé¤˜é¡è³‡æ–™åƒ…ä¾›åƒè€ƒ
            </div>
            ` : ''}
        </div>
    `;
    
    container.innerHTML = html;
}

// ==================== v3.97z-s æ–°å¢ï¼šåƒ¹æ ¼èµ°å‹¢åˆ†ææ¨¡çµ„ ====================

/**
 * è¼‰å…¥åƒ¹æ ¼èµ°å‹¢è³‡æ–™
 */
function loadPriceTrend(cbCode) {
    if (!cbCode) {
        document.getElementById('priceTrendContent').innerHTML = `
            <div style="text-align:center; color:#999; padding:40px;">
                ğŸ‘† è«‹å…ˆé¸æ“‡ä¸€æª”å¯è½‰å‚µæŸ¥çœ‹åƒ¹æ ¼èµ°å‹¢
            </div>`;
        return;
    }
    
    currentPriceTrendCB = cbCode;
    showPriceTrendTab('stockPrice');
}

/**
 * æ›´æ–°åƒ¹æ ¼èµ°å‹¢æœŸé–“
 */
function updatePriceTrendPeriod() {
    if (currentPriceTrendCB) {
        const activeTab = document.querySelector('.price-trend-tab.active');
        if (activeTab) {
            const tabName = activeTab.textContent.includes('è‚¡åƒ¹') ? 'stockPrice' :
                           activeTab.textContent.includes('ç†è«–åƒ¹å€¼') ? 'cbPrice' : 'balance';
            showPriceTrendTab(tabName);
        }
    }
}

/**
 * é¡¯ç¤ºåƒ¹æ ¼èµ°å‹¢æ¨™ç±¤é 
 */
function showPriceTrendTab(tabName, event) {
    // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
    document.querySelectorAll('.price-trend-tab').forEach(tab => tab.classList.remove('active'));
    if (event) event.target.classList.add('active');
    else document.querySelector(`.price-trend-tab:nth-child(${tabName === 'stockPrice' ? 1 : tabName === 'cbPrice' ? 2 : 3})`).classList.add('active');
    
    const content = document.getElementById('priceTrendContent');
    const cbCode = currentPriceTrendCB;
    
    if (!cbCode) {
        content.innerHTML = `<div style="text-align:center; color:#999; padding:40px;">ğŸ‘† è«‹å…ˆé¸æ“‡ä¸€æª”å¯è½‰å‚µ</div>`;
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    content.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">â³ è¼‰å…¥ ${cbCode} åƒ¹æ ¼èµ°å‹¢ä¸­...</div>`;
    
    // å–å¾—æœŸé–“è¨­å®š
    const period = document.getElementById('priceTrendPeriod')?.value || '90';
    
    // è¼‰å…¥kanbanè³‡æ–™ä¸¦ç¹ªè£½åœ–è¡¨
    loadKanbanAndRender(cbCode, tabName, period, content);
}

// ==================== v3.97z-s æ–°å¢ï¼šCB_kanbanè³‡æ–™è¼‰å…¥èˆ‡åœ–è¡¨ç¹ªè£½ ====================

// å…¨åŸŸè®Šæ•¸ - kanbanæ™‚é–“åºåˆ—è³‡æ–™
window.kanbanData = {
    loaded: false,
    loading: false,
    data: {},  // { cbCode: [{ date, stockPrice, cbPrice, convPrice, balance }] }
    dates: []  // æ‰€æœ‰æ—¥æœŸæ¸…å–®
};

// Chart.js å¯¦ä¾‹å­˜å„²ï¼ˆç”¨æ–¼éŠ·æ¯€èˆŠåœ–è¡¨ï¼‰
let priceChartInstance = null;

// v3.97z-s æ–°å¢ï¼šå…ƒå¤§æ­·å²è³‡æ–™ï¼ˆyuanta_data1.xlsx + yuanta_data2.xlsxï¼‰
window.yuantaHistoryData = {
    loaded: false,
    loading: false,
    data: {}  // { cbCode: { æœ€æ–°ä¸€ç­†çš„å®Œæ•´è³‡æ–™ } }
};

/**
 * v3.97z-s è¼‰å…¥å…ƒå¤§æ­·å²åŸºæœ¬è³‡æ–™
 * å¾ yuanta_data1.xlsx å’Œ yuanta_data2.xlsx è¼‰å…¥æ­·å¹´æ¯é€±åŸºæœ¬è³‡æ–™
 */
async function loadYuantaHistoryData() {
    if (window.yuantaHistoryData.loaded || window.yuantaHistoryData.loading) return;
    window.yuantaHistoryData.loading = true;
    
    console.log('ğŸ“‚ é–‹å§‹è¼‰å…¥å…ƒå¤§æ­·å²è³‡æ–™...');
    const startTime = Date.now();
    
    // æ¬„ä½åç¨±æ¨™æº–åŒ–ï¼ˆå»æ‰æ—¥æœŸå‰ç¶´ YYYYMMï¼‰
    function normalizeFieldName(field) {
        if (!field) return '';
        return String(field).replace(/^\d{6}/, '').trim();
    }
    
    // æ¨™æº–æ¬„ä½å°ç…§è¡¨ï¼ˆ08å·¥ä½œè¡¨æ¬„ä½åç¨±ï¼‰
    const standardFields = [
        'ä»£è™Ÿ', 'åç¨±', 'è‹±æ–‡åç¨±', 'ç¥¨é¢åˆ©ç‡', 'è½‰æ›åƒ¹æ ¼(å…ƒ)', 'è½‰æ›åƒ¹æ ¼ç”Ÿæ•ˆæ—¥æœŸ',
        'è½‰æ›æ¨™çš„ä»£ç¢¼', 'è½‰æ›æ¨™çš„åç¨±', 'è½‰æ›æ—¥æœŸèµ·', 'è½‰æ›æ—¥æœŸè¿„', 'ç™¼è¡Œæ—¥æœŸ', 'æ›ç‰Œæ—¥æœŸ',
        'åˆ°æœŸæ—¥', 'åˆ°æœŸåƒ¹æ ¼', 'åˆ°æœŸæ®–åˆ©ç‡', 'ç”³è«‹ç™¼è¡Œç¸½é¡(ç™¾è¬)', 'å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)',
        'ç™¼è¡Œåƒ¹æ ¼(å…ƒ)', 'æœ€æ–°é¤˜é¡(ç™¾è¬)', 'é‚„æœ¬å¹´é™', 'ç™¼è¡Œæ™‚è½‰æ›åƒ¹æ ¼(å…ƒ)', 'æ‰¿éŠ·æ©Ÿæ§‹',
        'éæˆ¶æ©Ÿæ§‹', 'æå‰å„Ÿé‚„æ—¥', 'æå‰å„Ÿé‚„æ—¥1', 'æå‰å„Ÿé‚„åƒ¹æ ¼1', 'æå‰å„Ÿé‚„æ®–åˆ©ç‡1',
        'æå‰å„Ÿé‚„æ—¥2', 'æå‰å„Ÿé‚„åƒ¹æ ¼2', 'æå‰å„Ÿé‚„æ®–åˆ©ç‡2', 'æå‰å„Ÿé‚„æ—¥3', 'æå‰å„Ÿé‚„åƒ¹æ ¼3',
        'æå‰å„Ÿé‚„æ®–åˆ©ç‡3', 'æå‰å„Ÿé‚„æ—¥4', 'æå‰å„Ÿé‚„åƒ¹æ ¼4', 'æå‰å„Ÿé‚„æ®–åˆ©ç‡4',
        'æœ€è¿‘æå‰å„Ÿé‚„æ—¥', 'æœ€è¿‘æå‰å„Ÿé‚„åƒ¹æ ¼', 'æœ€è¿‘æå‰å„Ÿé‚„æ®–åˆ©ç‡', 'å‚µåˆ¸æ“”ä¿æƒ…å½¢',
        'é‡è¨­å¹³å‡å¤©æ•¸3', 'é‡è¨­è½‰æ›åƒ¹æ ¼å…¬å¼', 'åœæ­¢å—ç†è½‰æ›ç™»è¨˜æ—¥æœŸèµ·', 'åœæ­¢å—ç†è½‰æ›ç™»è¨˜æ—¥æœŸè¨–', 'å¼·åˆ¶è´–å›æ—¥'
    ];
    
    // é¡å¤–æ¬„ä½ï¼ˆyuanta_data1ç‰¹æœ‰ï¼‰
    const extraFields = ['æœ¬æœˆè³£å›å¼µæ•¸', 'æœ¬æœˆè²·å›å¼µæ•¸', 'æœ¬æœˆè½‰æ›å¼µæ•¸', 'ä¿¡ç”¨è©•ç­‰', 
        'é‡è¨­è½‰æ›åƒ¹æ ¼é–‰é–æœŸ', 'éœæ…‹é‡è¨­åŸºæº–æ—¥1', 'éœæ…‹é‡è¨­åŸºæº–æ—¥2', 'å‹•æ…‹é‡è¨­åŸºæº–æ—¥',
        'é‡è¨­æº¢åƒ¹ç‡(%)', 'é‡è¨­ä¸Šé™(%)', 'é‡è¨­å¹³å‡å¤©æ•¸1', 'é‡è¨­å¹³å‡å¤©æ•¸2'];
    
    const allData = {};
    
    // è¼‰å…¥æª”æ¡ˆæ¸…å–®ï¼ˆå…ˆè¼‰å…¥èˆŠçš„ï¼Œå†è¼‰å…¥æ–°çš„ï¼Œæ–°çš„æœƒè¦†è“‹èˆŠçš„ï¼‰
    const files = [
        { name: 'data/kanban/yuanta_data1.xlsx', datePrefix: 6 },  // èˆŠæ ¼å¼
        { name: 'data/kanban/yuanta_data2.xlsx', datePrefix: 6 }   // æ–°æ ¼å¼
    ];
    
    for (const fileInfo of files) {
        try {
            const response = await fetch(fileInfo.name);
            if (!response.ok) {
                console.warn(`æ‰¾ä¸åˆ° ${fileInfo.name}ï¼Œè·³é`);
                continue;
            }
            
            const workbook = XLSX.read(await response.arrayBuffer(), { type: 'array' });
            console.log(`è¼‰å…¥ ${fileInfo.name}: ${workbook.SheetNames.length} å€‹å·¥ä½œè¡¨`);
            
            // éæ¿¾å‡ºæœ‰æ•ˆçš„æ—¥æœŸå·¥ä½œè¡¨ï¼ˆæ°‘åœ‹å¹´æ ¼å¼ YYYMMDDï¼‰
            const validSheets = workbook.SheetNames.filter(name => /^\d{7}$/.test(name));
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆèˆŠåˆ°æ–°ï¼‰
            validSheets.sort((a, b) => parseInt(a) - parseInt(b));
            
            for (const sheetName of validSheets) {
                const sheet = workbook.Sheets[sheetName];
                const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                
                if (rawData.length < 2) continue;
                
                const headers = rawData[0];
                // å»ºç«‹æ¬„ä½åç¨±åˆ°ç´¢å¼•çš„æ˜ å°„ï¼ˆæ¨™æº–åŒ–å¾Œï¼‰
                const fieldMap = {};
                headers.forEach((h, idx) => {
                    const normalized = normalizeFieldName(h);
                    if (normalized) fieldMap[normalized] = idx;
                });
                
                // è™•ç†æ¯ä¸€åˆ—è³‡æ–™
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    const code = String(row[fieldMap['ä»£è™Ÿ']] || '').trim();
                    if (!code || code === 'undefined') continue;
                    
                    // å»ºç«‹æ¨™æº–åŒ–çš„è³‡æ–™ç‰©ä»¶
                    const record = { _sheetDate: sheetName };
                    
                    // æ¨™æº–æ¬„ä½
                    standardFields.forEach(field => {
                        if (fieldMap[field] !== undefined) {
                            record[field] = row[fieldMap[field]];
                        }
                    });
                    
                    // é¡å¤–æ¬„ä½
                    extraFields.forEach(field => {
                        if (fieldMap[field] !== undefined) {
                            record[field] = row[fieldMap[field]];
                        }
                    });
                    
                    // å„²å­˜ï¼ˆæ–°çš„æœƒè¦†è“‹èˆŠçš„ï¼Œä¿ç•™æœ€æ–°è³‡æ–™ï¼‰
                    allData[code] = record;
                }
            }
        } catch (err) {
            console.warn(`è¼‰å…¥ ${fileInfo.name} å¤±æ•—:`, err);
        }
    }
    
    window.yuantaHistoryData.data = allData;
    window.yuantaHistoryData.loaded = true;
    window.yuantaHistoryData.loading = false;
    
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
    console.log(`âœ… å…ƒå¤§æ­·å²è³‡æ–™è¼‰å…¥å®Œæˆ: ${Object.keys(allData).length} æª”CBï¼Œè€—æ™‚ ${elapsed} ç§’`);
}

/**
 * è¼‰å…¥kanbanè³‡æ–™ä¸¦æ¸²æŸ“åœ–è¡¨
 */
async function loadKanbanAndRender(cbCode, tabName, period, container) {
    try {
        // æª¢æŸ¥æ˜¯å¦å·²è¼‰å…¥è³‡æ–™
        if (!window.kanbanData.loaded && !window.kanbanData.loading) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">â³ é¦–æ¬¡è¼‰å…¥æ­·å²è³‡æ–™ä¸­ï¼Œè«‹ç¨å€™...</div>`;
            await loadAllKanbanData();
        }
        
        // ç­‰å¾…è¼‰å…¥å®Œæˆ
        while (window.kanbanData.loading) {
            await new Promise(r => setTimeout(r, 100));
        }
        
        // å–å¾—è©²CBçš„æ™‚é–“åºåˆ—è³‡æ–™ï¼ˆåŒæ™‚å˜—è©¦å­—ä¸²å’Œæ•¸å­—æ ¼å¼ï¼‰
        const searchCode = String(cbCode).trim();
        let cbTimeSeries = window.kanbanData.data[searchCode] || [];
        
        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦ç´”æ•¸å­—æ ¼å¼ï¼ˆå»æ‰å‰å°é›¶ï¼‰
        if (cbTimeSeries.length === 0) {
            const numCode = parseInt(searchCode, 10);
            if (!isNaN(numCode)) {
                cbTimeSeries = window.kanbanData.data[String(numCode)] || [];
            }
        }
        
        // é™¤éŒ¯è¼¸å‡º
        console.log(`[kanban] æŸ¥è©¢ ${searchCode}, æ‰¾åˆ° ${cbTimeSeries.length} ç­†è³‡æ–™`);
        
        if (cbTimeSeries.length === 0) {
            // æª¢æŸ¥kanbanä¸­æ˜¯å¦æœ‰è©²CBï¼ˆåˆ—å‡ºå‰10å€‹keyä½œç‚ºåƒè€ƒï¼‰
            const keys = Object.keys(window.kanbanData.data).slice(0, 10);
            console.log(`[kanban] è³‡æ–™åº«ä¸­å‰10å€‹CBä»£è™Ÿ:`, keys);
            
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:#999;">
                    <div style="font-size:48px; margin-bottom:15px;">ğŸ“­</div>
                    <div style="font-size:14px;">æ‰¾ä¸åˆ° <strong>${cbCode}</strong> çš„æ­·å²åƒ¹æ ¼è³‡æ–™</div>
                    <div style="font-size:12px; margin-top:10px; color:#aaa;">
                        å¯èƒ½åŸå› ï¼š<br>
                        â€¢ æ–°ç™¼è¡Œçš„CBï¼Œå°šç„¡æ­·å²è¡Œæƒ…<br>
                        â€¢ å·²ä¸‹å¸‚è¼ƒä¹…çš„CBï¼Œä¸åœ¨kanbanè³‡æ–™ä¸­<br>
                        â€¢ è«‹ç¢ºèªCB_kanbanæª”æ¡ˆæ˜¯å¦åœ¨åŒä¸€ç›®éŒ„
                    </div>
                </div>`;
            return;
        }
        
        // ä¾æœŸé–“ç¯©é¸è³‡æ–™
        const filteredData = filterDataByPeriod(cbTimeSeries, period);
        
        // æ¸²æŸ“å°æ‡‰çš„åœ–è¡¨
        switch(tabName) {
            case 'stockPrice':
                renderStockPriceChart(cbCode, filteredData, container, period);
                break;
            case 'cbPrice':
                renderCBPriceChart(cbCode, filteredData, container, period);
                break;
            case 'balance':
                renderBalanceChart(cbCode, filteredData, container, period);
                break;
        }
        
    } catch (err) {
        console.error('è¼‰å…¥kanbanè³‡æ–™å¤±æ•—:', err);
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#c62828;">âŒ è¼‰å…¥è³‡æ–™å¤±æ•—: ${err.message}</div>`;
    }
}

/**
 * è¼‰å…¥æ‰€æœ‰kanbanæª”æ¡ˆè³‡æ–™
 * v3.97z-s å„ªåŒ–ï¼šä¸¦è¡Œè¼‰å…¥ + é€²åº¦é¡¯ç¤º + å„ªå…ˆè¼‰å…¥è¿‘å¹´è³‡æ–™
 */
async function loadAllKanbanData() {
    if (window.kanbanData.loading) return;
    window.kanbanData.loading = true;
    
    console.log('é–‹å§‹è¼‰å…¥CB_kanbanè³‡æ–™ï¼ˆè‡ªå‹•åµæ¸¬å¹´ä»½ï¼‰...');
    const startTime = Date.now();
    
    // æ›´æ–°è¼‰å…¥ç‹€æ…‹é¡¯ç¤º
    const updateProgress = (msg) => {
        const container = document.getElementById('priceTrendContent');
        if (container) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
                <div style="font-size:24px; margin-bottom:10px;">â³</div>
                <div>${msg}</div>
                <div style="margin-top:15px; width:200px; height:6px; background:#e0e0e0; border-radius:3px; margin:15px auto;">
                    <div id="kanbanProgress" style="height:100%; background:linear-gradient(90deg, #667eea, #764ba2); border-radius:3px; width:0%; transition:width 0.3s;"></div>
                </div>
            </div>`;
        }
    };
    
    const setProgress = (pct) => {
        const bar = document.getElementById('kanbanProgress');
        if (bar) bar.style.width = pct + '%';
    };
    
    try {
        // è‡ªå‹•ç”Ÿæˆå¹´ä»½åˆ—è¡¨ï¼ˆå¾ç•¶å‰å¹´ä»½å¾€å›åˆ°2017å¹´ï¼‰
        const currentYear = new Date().getFullYear();
        const startYear = 2017; // kanban è³‡æ–™æœ€æ—©å¹´ä»½
        
        // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æª”æ¡ˆè·¯å¾‘
        const allPossibleFiles = [];
        for (let year = currentYear; year >= startYear; year--) {
            allPossibleFiles.push(`data/kanban/CB_kanban_${year}.xlsx`);
        }
        
        console.log(`ğŸ“‚ è¼‰å…¥ ${startYear}-${currentYear} å¹´çš„ kanban æª”æ¡ˆ...`);
        
        const allData = {};
        const allDates = [];
        const loadedYears = [];
        
        // è™•ç†å–®å€‹æª”æ¡ˆçš„å‡½æ•¸
        const processFile = async (filename) => {
            try {
                const response = await fetch(filename);
                if (!response.ok) return null;
                
                const workbook = XLSX.read(await response.arrayBuffer(), { type: 'array' });
                const result = { filename, sheets: 0, records: 0 };
                
                // å¾æª”åå–å¾—å¹´ä»½
                const yearMatch = filename.match(/CB_kanban_(\d{4})\.xlsx/);
                if (yearMatch) loadedYears.push(parseInt(yearMatch[1]));
                
                for (const sheetName of workbook.SheetNames) {
                    if (!/^\d{8}$/.test(sheetName)) continue;
                    
                    const year = sheetName.substring(0, 4);
                    const month = sheetName.substring(4, 6);
                    const day = sheetName.substring(6, 8);
                    const dateFormatted = `${year}/${month}/${day}`;
                    allDates.push(dateFormatted);
                    
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    result.sheets++;
                    
                    for (const row of rows) {
                        const code = String(row['å‚µåˆ¸ä»£ç¢¼'] || '').trim();
                        if (!code) continue;
                        
                        if (!allData[code]) allData[code] = [];
                        
                        const convPrice = parseFloat(row['è½‰æ›åƒ¹æ ¼']) || 0;
                        const cbPrice = parseFloat(row['è½‰å‚µåƒè€ƒåƒ¹æ ¼']) || 0;
                        const stockPrice = parseFloat(row['è½‰æ›æ¨™çš„è‚¡ç¥¨åƒ¹æ ¼']) || 0;
                        const balance = parseFloat(row['ä¸Šæœˆåº•ç™¼è¡Œé¤˜é¡']) || 0;
                        const originalBalance = parseFloat(row['åŸå§‹ç™¼è¡Œç¸½é¡']) || 0;
                        
                        const convValue = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;
                        const premium = convValue > 0 && cbPrice > 0 ? ((cbPrice - convValue) / convValue * 100) : 0;
                        const remainRatio = originalBalance > 0 ? (balance / originalBalance * 100) : 100;
                        
                        allData[code].push({
                            date: dateFormatted,
                            dateNum: parseInt(sheetName),
                            stockPrice, cbPrice, convPrice, convValue, premium,
                            balance: balance / 100000000,
                            originalBalance: originalBalance / 100000000,
                            remainRatio
                        });
                        result.records++;
                    }
                }
                return result;
            } catch (err) {
                // æª”æ¡ˆä¸å­˜åœ¨æ˜¯æ­£å¸¸çš„ï¼Œä¸éœ€è¦è­¦å‘Š
                return null;
            }
        };
        
        // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰æª”æ¡ˆï¼ˆè‡ªå‹•åµæ¸¬å­˜åœ¨çš„å¹´ä»½ï¼‰
        updateProgress('è‡ªå‹•åµæ¸¬ä¸¦è¼‰å…¥æ­·å²è³‡æ–™...');
        
        let loadedCount = 0;
        const totalFiles = allPossibleFiles.length;
        
        // åˆ†æ‰¹ä¸¦è¡Œè¼‰å…¥ï¼ˆæ¯æ‰¹5å€‹æª”æ¡ˆï¼Œé¿å…åŒæ™‚è«‹æ±‚å¤ªå¤šï¼‰
        const batchSize = 5;
        for (let i = 0; i < allPossibleFiles.length; i += batchSize) {
            const batch = allPossibleFiles.slice(i, i + batchSize);
            const results = await Promise.all(batch.map(f => processFile(f)));
            
            loadedCount += results.filter(r => r).length;
            setProgress((i + batchSize) / totalFiles * 100);
        }
        
        // æ’åºæ¯å€‹ CB çš„æ™‚é–“åºåˆ—
        for (const code in allData) {
            allData[code].sort((a, b) => a.dateNum - b.dateNum);
        }
        
        window.kanbanData.data = allData;
        window.kanbanData.dates = [...new Set(allDates)].sort();
        window.kanbanData.loaded = true;
        
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        loadedYears.sort((a, b) => a - b);
        const yearRange = loadedYears.length > 0 ? `${loadedYears[0]}-${loadedYears[loadedYears.length-1]}` : 'ç„¡';
        
        console.log(`âœ… Kanbanè¼‰å…¥å®Œæˆ: ${Object.keys(allData).length} æª”CBï¼Œ${window.kanbanData.dates.length} å€‹äº¤æ˜“æ—¥`);
        console.log(`   å¹´ä»½ç¯„åœ: ${yearRange} (å…± ${loadedYears.length} å€‹å¹´ä»½æª”æ¡ˆ)`);
        console.log(`   è€—æ™‚: ${elapsed} ç§’`);
        
    } catch (err) {
        console.error('è¼‰å…¥kanbanè³‡æ–™å¤±æ•—:', err);
    } finally {
        window.kanbanData.loading = false;
    }
}

/**
 * ä¾æœŸé–“ç¯©é¸è³‡æ–™
 */
function filterDataByPeriod(data, period) {
    if (period === 'all' || !data || data.length === 0) return data;
    
    const days = parseInt(period) || 90;
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    const cutoffNum = parseInt(cutoffDate.toISOString().slice(0, 10).replace(/-/g, ''));
    
    return data.filter(d => d.dateNum >= cutoffNum);
}

/**
 * æ¸²æŸ“è‚¡åƒ¹èˆ‡è½‰æ›åƒ¹èµ°å‹¢åœ–
 */
function renderStockPriceChart(cbCode, data, container, period) {
    const periodLabel = getPeriodLabel(period);
    
    // æº–å‚™åœ–è¡¨è³‡æ–™
    const labels = data.map(d => d.date);
    const stockPrices = data.map(d => d.stockPrice);
    const convPrices = data.map(d => d.convPrice);
    
    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    const latestData = data[data.length - 1] || {};
    const isInMoney = latestData.stockPrice > latestData.convPrice;
    const stockPrice = latestData.stockPrice || 0;
    const convPrice = latestData.convPrice || 0;
    
    // è¨ˆç®—æƒ…å¢ƒåˆ†ææ•¸æ“š
    const cbPrice = latestData.cbPrice || 100;
    const holdingCost = cbPrice * 1000; // æŒè‚¡æˆæœ¬ï¼ˆ1å¼µCB = 10è¬é¢é¡ï¼Œä½†ç”¨å¸‚åƒ¹è¨ˆç®—ï¼‰
    
    container.innerHTML = `
        <div style="background:#fff; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-weight:bold; color:#1976d2; font-size:16px;">
                    ğŸ“ˆ ${cbCode} è‚¡åƒ¹èˆ‡è½‰æ›åƒ¹èµ°å‹¢ <span style="font-size:12px; color:#666; font-weight:normal;">(${periodLabel})</span>
                </div>
                <div style="font-size:12px; padding:4px 10px; border-radius:12px; background:${isInMoney ? '#e8f5e9' : '#fff3e0'}; color:${isInMoney ? '#2e7d32' : '#e65100'};">
                    ${isInMoney ? 'âœ… åƒ¹å…§ï¼ˆè‚¡ç¥¨ç‰¹æ€§ï¼‰' : 'âš ï¸ åƒ¹å¤–ï¼ˆå‚µåˆ¸ç‰¹æ€§ï¼‰'}
                </div>
            </div>
            
            <!-- æ•¸æ“šæ‘˜è¦ -->
            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-bottom:15px;">
                <div style="background:#e3f2fd; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">æœ€æ–°è‚¡åƒ¹</div>
                    <div style="font-size:18px; font-weight:bold; color:#1976d2;">${stockPrice.toFixed(2)}</div>
                </div>
                <div style="background:#fff3e0; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">è½‰æ›åƒ¹</div>
                    <div style="font-size:18px; font-weight:bold; color:#e65100;">${convPrice.toFixed(2)}</div>
                </div>
            </div>
            
            <!-- åœ–è¡¨å€åŸŸ -->
            <div style="height:220px; position:relative;">
                <canvas id="stockPriceChart"></canvas>
            </div>
            
            <!-- æƒ…å¢ƒåˆ†æèªªæ˜ -->
            <div style="margin-top:15px; padding:12px; background:${isInMoney ? '#e8f5e9' : '#fff8e1'}; border-radius:8px; border-left:4px solid ${isInMoney ? '#4caf50' : '#ff9800'};">
                <div style="font-weight:bold; color:#333; margin-bottom:8px; font-size:13px;">
                    ${isInMoney ? 'ğŸ“ˆ ä¸Šæ¼²æƒ…å¢ƒåˆ†æï¼ˆåƒ¹å…§ï¼è‚¡ç¥¨ç‰¹æ€§ï¼‰' : 'ğŸ“‰ ä¸‹è·Œæƒ…å¢ƒåˆ†æï¼ˆåƒ¹å¤–ï¼å‚µåˆ¸ç‰¹æ€§ï¼‰'}
                </div>
                ${isInMoney ? `
                <div style="font-size:12px; color:#555; line-height:1.6;">
                    <div style="margin-bottom:6px;">ç•¶ç¾è‚¡æ”¶ç›¤åƒ¹æ ¼<span style="color:#2e7d32; font-weight:bold;">è¶…éè½‰æ›åƒ¹æ ¼</span>ï¼Œå¯è½‰å‚µèˆ‡ç¾è‚¡è‚¡åƒ¹å°‡æœƒåŒæ­¥ï¼Œå…·æœ‰<span style="color:#2e7d32; font-weight:bold;">è‚¡ç¥¨ç‰¹æ€§</span>ã€‚</div>
                    <div style="margin-bottom:6px;">è²·é€²å¯è½‰å‚µçš„äº¤å‰²æ–¹å¼èˆ‡ä¸€èˆ¬è²·è³£è‚¡ç¥¨ä¸€æ¨£ï¼ŒT+2å…¨é¡äº¤å‰²ã€‚</div>
                    <div style="background:#fff; padding:8px; border-radius:4px; margin:8px 0;">
                        <span style="font-weight:bold;">çµè«–ï¼š</span>ç•¶è‚¡åƒ¹è¶…éè½‰æ›åƒ¹ï¼Œå¯è½‰å‚µå°‡æœƒç™¼æ®è‚¡ç¥¨çš„ç‰¹æ€§ï¼Œ<span style="color:#d32f2f;">æ¼²è¶Šå¤šç²åˆ©è¶Šå¤š</span>ã€‚
                    </div>
                </div>
                ` : `
                <div style="font-size:12px; color:#555; line-height:1.6;">
                    <div style="margin-bottom:6px;">ç•¶ç¾è‚¡æ”¶ç›¤åƒ¹æ ¼<span style="color:#e65100; font-weight:bold;">ä½æ–¼è½‰æ›åƒ¹æ ¼</span>ï¼Œå¯è½‰å‚µèˆ‡ç¾è‚¡è‚¡åƒ¹å°‡ä¸æœƒåŒæ­¥ï¼Œå…·æœ‰<span style="color:#e65100; font-weight:bold;">å‚µåˆ¸ç‰¹æ€§</span>ã€‚</div>
                    <div style="margin-bottom:6px;">åœ¨å…¬å¸æ²’æœ‰å€’é–‰çš„å‰æä¸‹ï¼Œç•¶è‚¡åƒ¹è·Œç ´è½‰æ›åƒ¹æ™‚ï¼Œå¯è½‰å‚µå°±æœƒå……åˆ†ç™¼æ®å‚µåˆ¸åˆ°æœŸé‚„æœ¬ç‰¹æ€§ã€‚</div>
                    <div style="background:#fff; padding:8px; border-radius:4px; margin:8px 0;">
                        <span style="font-weight:bold;">çµè«–ï¼š</span>ç„¡æ“”ä¿æ™‚ç‚ºç¬¬ä¸€é †ä½æ±‚å„Ÿäººï¼Œæœ‰æ“”ä¿æ™‚æœ‰å…¬å¸å¯¦é«”è³‡ç”¢ç•¶åšæŠµæŠ¼æ“”ä¿ï¼Œ<span style="color:#2e7d32;">ä¸‹æª”é¢¨éšªæœ‰é™</span>ã€‚
                    </div>
                </div>
                `}
            </div>
        </div>
    `;
    
    // éŠ·æ¯€èˆŠåœ–è¡¨
    if (priceChartInstance) {
        priceChartInstance.destroy();
        priceChartInstance = null;
    }
    
    // ç¹ªè£½Chart.jsåœ–è¡¨ï¼ˆåªæœ‰è‚¡åƒ¹å’Œè½‰æ›åƒ¹å…©æ¢ç·šï¼‰
    const ctx = document.getElementById('stockPriceChart').getContext('2d');
    priceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'è‚¡åƒ¹',
                    data: stockPrices,
                    borderColor: '#1976d2',
                    backgroundColor: 'rgba(25, 118, 210, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 2
                },
                {
                    label: 'è½‰æ›åƒ¹',
                    data: convPrices,
                    borderColor: '#e65100',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0,
                    pointRadius: 0,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top', labels: { font: { size: 11 }, boxWidth: 12 } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { font: { size: 10 }, maxRotation: 45, maxTicksLimit: 10 },
                    grid: { display: false }
                },
                y: {
                    ticks: { font: { size: 10 } },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                }
            }
        }
    });
}

/**
 * æ¸²æŸ“ç†è«–åƒ¹å€¼åˆ†æåœ–ï¼ˆCBåƒ¹æ ¼ vs ç†è«–åƒ¹æ ¼ + æŠ˜æº¢åƒ¹æ¯”ç‡ï¼‰
 */
function renderCBPriceChart(cbCode, data, container, period) {
    const periodLabel = getPeriodLabel(period);
    
    const labels = data.map(d => d.date);
    const cbPrices = data.map(d => d.cbPrice);
    const convValues = data.map(d => d.convValue);  // ç†è«–åƒ¹æ ¼ï¼ˆè½‰æ›åƒ¹å€¼ï¼‰
    const premiums = data.map(d => d.premium);
    
    const latestData = data[data.length - 1] || {};
    const cbPrice = latestData.cbPrice || 0;
    const convValue = latestData.convValue || 0;
    const premium = latestData.premium || 0;
    const hasConvValue = convValue > 0;
    const stockPrice = latestData.stockPrice || 0;
    const convPrice = latestData.convPrice || 0;
    
    container.innerHTML = `
        <div style="background:#fff; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-weight:bold; color:#7b1fa2; font-size:16px;">
                    ğŸ’¹ ${cbCode} ç†è«–åƒ¹å€¼åˆ†æ <span style="font-size:12px; color:#666; font-weight:normal;">(${periodLabel})</span>
                </div>
                <div style="font-size:12px; padding:4px 10px; border-radius:12px; background:${hasConvValue ? '#e8f5e9' : '#fff3e0'}; color:${hasConvValue ? '#2e7d32' : '#e65100'};">
                    ${hasConvValue ? 'æœ‰è½‰æ›åƒ¹å€¼' : 'é‚„æ²’æœ‰è½‰æ›åƒ¹å€¼'}
                </div>
            </div>
            
            <!-- æ•¸æ“šæ‘˜è¦ -->
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:15px;">
                <div style="background:#e8f5e9; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">ç†è«–åƒ¹å€¼</div>
                    <div style="font-size:18px; font-weight:bold; color:#2e7d32;">${convValue > 100 ? convValue.toFixed(2) : '-'}</div>
                </div>
                <div style="background:#f3e5f5; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">CBæ”¶ç›¤åƒ¹</div>
                    <div style="font-size:18px; font-weight:bold; color:#7b1fa2;">${cbPrice.toFixed(2)}</div>
                </div>
                <div style="background:#fff3e0; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">æº¢åƒ¹ï¼ˆè²´äº†ï¼‰</div>
                    <div style="font-size:18px; font-weight:bold; color:#e65100;">${premium.toFixed(2)}%</div>
                </div>
            </div>
            
            <!-- åœ–è¡¨å€åŸŸ -->
            <div style="height:200px; position:relative;">
                <canvas id="cbPriceChart"></canvas>
            </div>
            
            <!-- ç†è«–åƒ¹å€¼åˆ†æèªªæ˜ -->
            <div style="margin-top:15px; padding:12px; background:#f3e5f5; border-radius:8px; border-left:4px solid #7b1fa2;">
                <div style="font-weight:bold; color:#333; margin-bottom:8px; font-size:13px;">
                    ğŸ“Š å¯è½‰æ›å…¬å¸å‚µåƒ¹å€¼åˆ†æ
                </div>
                <div style="font-size:12px; color:#555; line-height:1.6;">
                    <div style="margin-bottom:6px;">
                        ${hasConvValue ? 
                            `ç†è«–åƒ¹å€¼ <span style="color:#2e7d32; font-weight:bold;">${convValue.toFixed(2)}</span> å…ƒï¼ŒCBæ”¶ç›¤åƒ¹ <span style="color:#7b1fa2; font-weight:bold;">${cbPrice.toFixed(2)}</span> å…ƒï¼Œä»£è¡¨è²·é€²çš„å¯è½‰å‚µ<span style="color:#e65100; font-weight:bold;">æº¢åƒ¹ï¼ˆè²´äº†ï¼‰${premium.toFixed(2)}%</span>ã€‚` :
                            `å¯è½‰å‚µçš„æ¼²è·Œå°‡<span style="color:#e65100; font-weight:bold;">ä¸èˆ‡æ¨™çš„è‚¡ç¥¨åŒæ­¥</span>ï¼Œæ›´å¤šæ˜¯å‚µåˆ¸çš„æŠ—è·Œæ€§åŠåˆ°æœŸçš„ä¿æœ¬ç‰¹æ€§ã€‚`
                        }
                    </div>
                    <div style="margin-bottom:6px;">
                        <span style="color:#7b1fa2;">ğŸ’¡ æº¢åƒ¹</span>é€šå¸¸æ˜¯æŒ‡è²·å¯è½‰å‚µè¦è²´å¤šå°‘%ï¼Œé€šå¸¸è¶Šçœ‹å¥½è©²æ¨™çš„æœªä¾†çš„çˆ†ç™¼æ€§ï¼Œè¶Šèƒ½æ¥å—è¶Šé«˜çš„æº¢åƒ¹ç‡ã€‚
                    </div>
                    <div style="background:#fff; padding:8px; border-radius:4px; margin:8px 0;">
                        <span style="font-weight:bold;">æ›å¥è©±èªªï¼š</span>é€šå¸¸è¶Šæ²’æœ‰è½‰æ›åƒ¹å€¼çš„æ¨™çš„æº¢åƒ¹ç‡å°±è¶Šé«˜ï¼Œç›¸å°çš„é¸æ“‡æ¬Šçš„<span style="color:#2e7d32;">æ¬Šåˆ©é‡‘æå¤±ä¹Ÿæ˜¯æœ€å°çš„</span>ã€‚
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (priceChartInstance) {
        priceChartInstance.destroy();
        priceChartInstance = null;
    }
    
    const ctx = document.getElementById('cbPriceChart').getContext('2d');
    priceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'CBåƒ¹æ ¼',
                    data: cbPrices,
                    borderColor: '#7b1fa2',
                    backgroundColor: 'rgba(123, 31, 162, 0.1)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'ç†è«–åƒ¹æ ¼',
                    data: convValues,
                    borderColor: '#2e7d32',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'æŠ˜æº¢åƒ¹%',
                    data: premiums,
                    type: 'bar',
                    backgroundColor: premiums.map(p => p >= 0 ? 'rgba(255, 152, 0, 0.4)' : 'rgba(76, 175, 80, 0.4)'),
                    borderColor: premiums.map(p => p >= 0 ? '#ff9800' : '#4caf50'),
                    borderWidth: 1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top', labels: { font: { size: 11 }, boxWidth: 12 } }
            },
            scales: {
                x: {
                    ticks: { font: { size: 10 }, maxRotation: 45, maxTicksLimit: 10 },
                    grid: { display: false }
                },
                y: {
                    type: 'linear', display: true, position: 'left',
                    ticks: { font: { size: 10 } },
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    title: { display: true, text: 'åƒ¹æ ¼', font: { size: 10 } }
                },
                y1: {
                    type: 'linear', display: true, position: 'right',
                    ticks: { font: { size: 10 }, callback: function(value) { return value + '%'; } },
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'æŠ˜æº¢åƒ¹ç‡', font: { size: 10 } }
                }
            }
        }
    });
}

/**
 * æ¸²æŸ“ç±Œç¢¼è½‰æ›åˆ†æåœ–ï¼ˆCBå¼µæ•¸ã€ç´„ç•¶è‚¡ç¥¨å¼µæ•¸ã€ä½”è‚¡æœ¬æ¯”ï¼‰
 */
function renderBalanceChart(cbCode, data, container, period) {
    const periodLabel = getPeriodLabel(period);
    
    const labels = data.map(d => d.date);
    const latestData = data[data.length - 1] || {};
    const firstData = data[0] || {};
    
    // å–å¾—è½‰æ›åƒ¹æ ¼
    const convPrice = latestData.convPrice || 0;
    
    // å–å¾—è‚¡æœ¬è³‡æ–™ï¼ˆå„ªå…ˆå¾ cbSupplementMap æŸ¥è©¢ï¼Œå†å¾ sheet01Data æŸ¥è©¢ï¼‰
    let stockCapital = 0; // è‚¡æœ¬ï¼ˆå„„ï¼‰
    
    // æ–¹æ³•1: å¾ cbSupplementMap æŸ¥è©¢ï¼ˆåœ¨ loadStatistics ä¸­å·²å»ºç«‹ï¼‰
    if (window.cbSupplementMap && window.cbSupplementMap[cbCode]) {
        stockCapital = window.cbSupplementMap[cbCode].capital || 0;
    }
    
    // æ–¹æ³•2: å¦‚æœæ²’æœ‰ï¼Œå¾ sheet01Data æŸ¥è©¢
    if (stockCapital <= 0 && window.sheet01Data && window.sheet01Data.length > 0) {
        const cbInfo = window.sheet01Data.find(row => {
            const code = String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').replace('.0', '').trim();
            return code === cbCode;
        });
        if (cbInfo) {
            // Næ¬„å¯èƒ½çš„æ¬„ä½åç¨±
            stockCapital = parseFloat(cbInfo['è‚¡æœ¬å¤§å°'] || cbInfo['è‚¡æœ¬'] || cbInfo['è‚¡æœ¬(å„„)'] || cbInfo['è‚¡æœ¬(å„„å…ƒ)'] || 0);
        }
    }
    
    console.log(`ğŸ“Š ${cbCode} è‚¡æœ¬è³‡æ–™: ${stockCapital} å„„`);
    
    // è¨ˆç®—å¼µæ•¸è³‡æ–™ï¼ˆæ¯å¼µCBé¢é¡10è¬å…ƒï¼‰
    // CBå¼µæ•¸ = é¤˜é¡(å„„) Ã— 1å„„ / 10è¬ = é¤˜é¡(å„„) Ã— 1000
    // ç´„ç•¶è‚¡ç¥¨å¼µæ•¸ = CBå¼µæ•¸ Ã— (10è¬/è½‰æ›åƒ¹) / 1000 = é¤˜é¡(å„„) Ã— 1000 Ã— 100000 / è½‰æ›åƒ¹ / 1000 = é¤˜é¡ Ã— 100000 / è½‰æ›åƒ¹
    const cbShares = data.map(d => d.balance * 1000); // CBå¼µæ•¸
    const stockShares = data.map(d => convPrice > 0 ? d.balance * 100000 / convPrice : 0); // ç´„ç•¶è‚¡ç¥¨å¼µæ•¸
    
    const latestCBShares = latestData.balance ? latestData.balance * 1000 : 0;
    const latestStockShares = convPrice > 0 ? latestData.balance * 100000 / convPrice : 0;
    const originalCBShares = latestData.originalBalance ? latestData.originalBalance * 1000 : 0;
    const originalStockShares = convPrice > 0 ? latestData.originalBalance * 100000 / convPrice : 0;
    
    // å·²è½‰æ›å¼µæ•¸
    const convertedCBShares = originalCBShares - latestCBShares;
    const convertedStockShares = originalStockShares - latestStockShares;
    
    // ä½”è‚¡æœ¬æ¯”ï¼ˆè‚¡æœ¬ä»¥å„„å…ƒç‚ºå–®ä½ï¼Œè‚¡ç¥¨é¢é¡10å…ƒï¼Œ1å„„å…ƒ=1000è¬è‚¡=1è¬å¼µï¼‰
    const stockCapitalShares = stockCapital * 10000; // è‚¡æœ¬å¼µæ•¸
    const stockCapitalPct = stockCapitalShares > 0 ? (latestStockShares / stockCapitalShares * 100) : 0;
    
    // è½‰æ›æ¯”ç‡ï¼ˆæ¯å¼µCBå¯æ›å¹¾è‚¡ï¼‰
    const convRatio = convPrice > 0 ? (100000 / convPrice) : 0;
    
    // è¨ˆç®—CBASæ¬Šåˆ©é‡‘ï¼ˆç°¡åŒ–è¨ˆç®—ï¼šæº¢åƒ¹éƒ¨åˆ†å°±æ˜¯æ¬Šåˆ©é‡‘æ¦‚å¿µï¼‰
    const cbPrice = latestData.cbPrice || 100;
    const premium = latestData.premium || 0;
    const premiumCost = cbPrice > 100 ? (cbPrice - 100) * 1000 : 0; // æº¢åƒ¹éƒ¨åˆ†çš„æˆæœ¬
    const bondValue = 100 * 1000; // å‚µåˆ¸éƒ¨åˆ†åƒ¹å€¼ï¼ˆ100å…ƒ Ã— 1000ï¼‰
    const totalCost = cbPrice * 1000; // ç¸½æˆæœ¬
    
    container.innerHTML = `
        <div style="background:#fff; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-weight:bold; color:#2e7d32; font-size:16px;">
                    ğŸ“Š ${cbCode} ç±Œç¢¼è½‰æ›åˆ†æ <span style="font-size:12px; color:#666; font-weight:normal;">(${periodLabel})</span>
                </div>
                <div style="font-size:12px; padding:4px 10px; border-radius:12px; background:#e8f5e9; color:#2e7d32;">
                    è½‰æ›æ¯”ç‡ ${convRatio.toFixed(0)}è‚¡/å¼µ
                </div>
            </div>
            
            <!-- æ•¸æ“šæ‘˜è¦ -->
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:15px;">
                <div style="background:#e3f2fd; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">å‰©é¤˜CBå¼µæ•¸</div>
                    <div style="font-size:16px; font-weight:bold; color:#1976d2;">${latestCBShares.toLocaleString()}</div>
                    <div style="font-size:9px; color:#999;">å¼µ</div>
                </div>
                <div style="background:#e8f5e9; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">ç´„ç•¶è‚¡ç¥¨</div>
                    <div style="font-size:16px; font-weight:bold; color:#2e7d32;">${latestStockShares.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    <div style="font-size:9px; color:#999;">å¼µ</div>
                </div>
                <div style="background:#fff3e0; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">å·²è½‰æ›è‚¡ç¥¨</div>
                    <div style="font-size:16px; font-weight:bold; color:#e65100;">${convertedStockShares.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    <div style="font-size:9px; color:#999;">å¼µ</div>
                </div>
                <div style="background:#f3e5f5; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">ä½”è‚¡æœ¬æ¯”</div>
                    <div style="font-size:16px; font-weight:bold; color:#7b1fa2;">${stockCapitalPct.toFixed(2)}%</div>
                    <div style="font-size:9px; color:#999;">${stockCapital > 0 ? 'è‚¡æœ¬' + stockCapital.toFixed(1) + 'å„„' : 'ç„¡è‚¡æœ¬è³‡æ–™'}</div>
                </div>
            </div>
            
            <!-- åœ–è¡¨å€åŸŸ -->
            <div style="height:180px; position:relative;">
                <canvas id="balanceChart"></canvas>
            </div>
            
            <!-- CBASæ‹†è§£èªªæ˜ -->
            <div style="margin-top:15px; padding:12px; background:#e3f2fd; border-radius:8px; border-left:4px solid #1976d2;">
                <div style="font-weight:bold; color:#333; margin-bottom:8px; font-size:13px;">
                    ğŸ¯ CBASé¸æ“‡æ¬Šæ‹†è§£æ¦‚å¿µ
                </div>
                <div style="font-size:12px; color:#555; line-height:1.6;">
                    <div style="margin-bottom:6px;">
                        å¦‚æœè²·é€² <span style="color:#7b1fa2; font-weight:bold;">æº¢åƒ¹ç‡ ${premium.toFixed(2)}%</span> çš„å¯è½‰å‚µ <span style="color:#1976d2; font-weight:bold;">${cbPrice.toFixed(2)}</span> å…ƒï¼Œ
                        ç­‰æ–¼ç¥¨é¢æŒè‚¡æˆæœ¬ <span style="color:#e65100; font-weight:bold;">${(cbPrice * convPrice / 100).toFixed(2)}</span> å…ƒã€‚
                    </div>
                    <div style="margin-bottom:6px;">
                        æœƒæ‹†è§£çš„ä¸»è¦ç”¨æ„åœ¨æ–¼ï¼Œç©æ¥µçœ‹å¥½çš„å®¢æˆ¶åªæƒ³åƒèˆ‡è‚¡ç¥¨ä¸Šæ¼²æ©Ÿæœƒï¼Œæ‰€ä»¥æœƒé¸æ“‡<span style="color:#d32f2f; font-weight:bold;">åªä»˜å‡ºæ¬Šåˆ©é‡‘</span>ï¼ŒåªæŒæœ‰è‚¡ç¥¨ä¸Šæ¼²é¸æ“‡æ¬Šéƒ¨ä½ã€‚
                    </div>
                    <div style="background:#fff; padding:8px; border-radius:4px; margin:8px 0;">
                        <div style="font-weight:bold; margin-bottom:4px;">çµè«–ï¼š</div>
                        åœ¨æœ€å¤šæå¤± <span style="color:#d32f2f; font-weight:bold;">${premiumCost.toLocaleString()}</span> å…ƒçš„æƒ…æ³ä¸‹ï¼ˆæŠŠé¢¨éšªæ§åˆ¶åœ¨å¯ä»¥æ¥å—çš„ç¯„åœå…§ï¼Œå…ˆæ±‚å°‘è¼¸ï¼‰ï¼Œ<br>
                        å†è²·ä¸€å€‹<span style="color:#2e7d32; font-weight:bold;">æœªä¾†è‚¡åƒ¹ä¸Šæ¼²çš„å¤¢æƒ³</span>ã€‚
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (priceChartInstance) {
        priceChartInstance.destroy();
        priceChartInstance = null;
    }
    
    const ctx = document.getElementById('balanceChart').getContext('2d');
    priceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'CBå¼µæ•¸',
                    data: cbShares,
                    borderColor: '#1976d2',
                    backgroundColor: 'rgba(25, 118, 210, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 2,
                    yAxisID: 'y'
                },
                {
                    label: 'ç´„ç•¶è‚¡ç¥¨å¼µæ•¸',
                    data: stockShares,
                    borderColor: '#2e7d32',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 2,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top', labels: { font: { size: 11 }, boxWidth: 12 } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' å¼µ';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { font: { size: 10 }, maxRotation: 45, maxTicksLimit: 10 },
                    grid: { display: false }
                },
                y: {
                    type: 'linear', display: true, position: 'left',
                    ticks: { font: { size: 10 }, callback: function(value) { return value.toLocaleString(); } },
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    title: { display: true, text: 'CBå¼µæ•¸', font: { size: 10 } }
                },
                y1: {
                    type: 'linear', display: true, position: 'right',
                    ticks: { font: { size: 10 }, callback: function(value) { return value.toLocaleString(); } },
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'ç´„ç•¶è‚¡ç¥¨å¼µæ•¸', font: { size: 10 } }
                }
            }
        }
    });
}

/**
 * å–å¾—æœŸé–“æ¨™ç±¤
 */
function getPeriodLabel(period) {
    const labels = {
        '30': 'è¿‘30å¤©',
        '60': 'è¿‘60å¤©',
        '90': 'è¿‘90å¤©',
        '180': 'è¿‘180å¤©',
        'all': 'å…¨éƒ¨æœŸé–“'
    };
    return labels[period] || period;
}

/**
 * æ ¼å¼åŒ–æ•¸å­—
 */
function formatNumber(num) {
    if (num === null || num === undefined || num === '' || isNaN(num)) return '-';
    return Number(num).toLocaleString();
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸ
 */
function formatDate(date) {
    if (!date) return '-';
    if (typeof date === 'string') return date;
    if (date instanceof Date) {
        return date.toLocaleDateString('zh-TW');
    }
    // Excelæ—¥æœŸæ•¸å­—è½‰æ›
    if (typeof date === 'number') {
        const excelEpoch = new Date(1899, 11, 30);
        const jsDate = new Date(excelEpoch.getTime() + date * 86400000);
        return jsDate.toLocaleDateString('zh-TW');
    }
    return String(date);
}

// ç³»çµ±å•Ÿå‹•
window.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    initResizer();
    // v3.73 ä¿®æ­£ï¼šinitQuickSelect ç§»åˆ° initializeUI ä¸­ï¼Œç¢ºä¿è³‡æ–™å·²è¼‰å…¥
});
</script>

</body>
</html>
