<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.30 (CSVæ•¸æ“šé©…å‹•ç‰ˆ) - Rexå¤§å”</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; display: none; } /* é è¨­éš±è— */
        .header {
            background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .header .subtitle { color: #666; font-size: 16px; }
        .version-badge { display: inline-block; background: #e91e63; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }
        .evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        .input-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px;
        }
        .input-panel h2 { color: #667eea; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }
        .form-section { margin-bottom: 25px; }
        .form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .info-box {
            background: #e8f5e9; padding: 15px; border-radius: 8px;
            border-left: 5px solid #4CAF50; margin-top: 10px; display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
        .stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
        .stat-label { color: #555; font-weight: 500; }
        .stat-value { font-weight: bold; color: #333; }
        .calculate-btn {
            width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s; margin-top: 20px;
        }
        .calculate-btn:hover { transform: translateY(-2px); }
        .result-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px;
        }
        .welcome-message { text-align: center; padding: 60px 20px; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .evaluation-result { display: none; }
        .evaluation-result.active { display: block; animation: fadeIn 0.5s; }
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
        }
        .detail-section {
            background: white; border-radius: 12px; padding: 30px;
            margin-bottom: 25px; border: 2px solid #e0e0e0;
        }
        .detail-section h3 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; }
        .strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
        .strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
        .strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
        .strategy-card.ultimate { border-color: #9C27B0; background: #f3e5f5; }
        .strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .data-table th {
            background-color: #1A237E; color: white; padding: 15px 10px;
            text-align: center; font-weight: bold; border: 1px solid #0d1b5e;
        }
        .data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
        .data-table tr:nth-child(even) { background-color: #f8f9fa; }
        .data-table tr:hover { background-color: #e8eaf6; }
        .val-pos { color: #d32f2f; font-weight: bold; }
        .val-neg { color: #388e3c; font-weight: bold; }
        .val-neu { color: #333; }
        .rex-analysis {
            background: linear-gradient(to right, #fff3e0, #ffe0b2);
            border-left: 6px solid #ff9800;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .rex-title { font-size: 20px; font-weight: bold; color: #e65100; margin-bottom: 15px; display: flex; align-items: center; }
        .rex-content { color: #5d4037; line-height: 1.8; font-size: 15px; }
        @media (max-width: 1200px) {
            .evaluation-container { grid-template-columns: 1fr; }
            .input-panel { position: relative; top: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold;">
        <div>ğŸ”„ æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</div>
        <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æ­£åœ¨è§£æå¤§æ•¸æ“š CSV...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.30 æ•¸æ“šé©…å‹•ç‰ˆ</span></h1>
            <p class="subtitle" id="headerSubtitle">è¼‰å…¥ä¸­...</p>
        </div>

        <div class="evaluation-container">
            <div class="input-panel">
                <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
                <form id="evaluationForm">
                    <div class="form-section">
                        <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                        <div class="form-group">
                            <label>CBåç¨± / ä»£è™Ÿ *</label>
                            <input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ (æ”¯æ´æ¨¡ç³Šæœå°‹)">
                            <div id="cbNameInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>è‚¡æœ¬ (å„„å…ƒ) *</label>
                            <input type="number" id="capital" step="0.01" required placeholder="ç³»çµ±è‡ªå‹•å¸¶å…¥">
                            <div id="capitalInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç”¢æ¥­åˆ†é¡ *</label>
                            <select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select>
                            <div id="industryInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œåˆ¸å•†</label>
                            <select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select>
                            <div id="brokerInfo" class="info-box"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                        <div class="form-group">
                            <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label>
                            <input type="number" id="issueSize" step="0.1" required placeholder="ç³»çµ±è‡ªå‹•å¸¶å…¥">
                            <div id="issueSizeInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                            <input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š450">
                            <div id="conversionPriceInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ç™¼è¡Œå¹´æœŸ *</label>
                            <select id="years" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="3">3å¹´æœŸ</option>
                                <option value="5">5å¹´æœŸ</option>
                                <option value="7">7å¹´æœŸ</option>
                            </select>
                            <div id="yearsInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>æ“”ä¿æƒ…æ³ *</label>
                            <select id="guarantee" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                                <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                            </select>
                            <div id="guaranteeInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                            <select id="rating" required>
                                <option value="">è«‹é¸æ“‡...</option>
                                <option value="1">TCRI 1</option>
                                <option value="2">TCRI 2</option>
                                <option value="3">TCRI 3</option>
                                <option value="4">TCRI 4</option>
                                <option value="5">TCRI 5</option>
                                <option value="6">TCRI 6</option>
                                <option value="7">TCRI 7</option>
                                <option value="8">TCRI 8</option>
                                <option value="9">TCRI 9</option>
                                <option value="BBB">BBBç´š</option>
                            </select>
                            <div id="ratingInfo" class="info-box"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                        <div class="form-group">
                            <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                            <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                        </div>
                    </div>

                    <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 20px; margin: 25px 0;">
                        <h3 style="color: #e65100; display: flex; align-items: center; gap: 8px;">âš–ï¸ ä¸»è§€æ¬Šé‡èª¿æ•´ï¼ˆé¸å¡«ï¼‰</h3>
                        <div class="form-group">
                            <label>ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label>
                            <input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0" placeholder="0-100ï¼Œé è¨­0">
                            <small style="color: #666; font-size: 12px;">ç¯„åœï¼š0-100ï¼Œé è¨­0è¡¨ç¤ºå®Œå…¨ä¾æ“šæ­·å²è³‡æ–™</small>
                        </div>
                    </div>

                    <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 14px;">ğŸ’¡ Rexå¤§å”çš„æ™ºæ…§æé†’</div>
                        <div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div>
                    </div>

                    <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
                </form>
            </div>

            <div class="result-panel">
                <div id="welcomeMsg" class="welcome-message">
                    <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
                    <p>âœ… v3.30 CSVæ•¸æ“šç‰ˆ<br>å·²è®€å–æ‚¨ä¸Šå‚³çš„å®Œæ•´è³‡æ–™åº«</p>
                    <div class="stats-summary" id="statsSummary"></div>
                </div>
                <div id="evaluationResult" class="evaluation-result"></div>
            </div>
        </div>
    </div>

    <script id="csv_basic" type="text/csv">
åºè™Ÿ,è‚¡ç¥¨ä»£è™Ÿ,CBä»£è™Ÿ,åç¨±,ä¿¡ç”¨è©•ç­‰,æ“”ä¿,ç™¼è¡Œè¦æ¨¡,è½‰æ›åƒ¹æ ¼,ç™¼è¡Œå¹´æœŸ,è©¢åœˆç«¶æ‹,ç™¼è¡Œåˆ¸å•†,ç”¢æ¥­åˆ†é¡,ç”¢æ¥­åœ°ä½,è‚¡æœ¬å¤§å°,ç™¼è¡Œåƒ¹æ ¼,åˆ°æœŸé‚„æœ¬åƒ¹æ ¼,è¨‚åƒ¹æº¢åƒ¹ç‡,æ›ç‰Œæ—¥æœŸ,åˆ°æœŸæ—¥æœŸ,æ›ç‰Œæœ€é«˜,æ›ç‰Œæœ€ä½
1,1101,11011,å°æ³¥ä¸€æ°¸,TCRI4,ç„¡æ“”ä¿,80,36.5,5,è©¢åœˆ,å…ƒå¤§è­‰åˆ¸,æ°´æ³¥å·¥æ¥­,å°ç£æœ€å¤§æ°´æ³¥å» ,775,100,100,1.0918,2024-12-10,2029-12-10,108.1,95
12,1316,13161,ä¸Šæ›œä¸€,æ¿ä¿¡å•†éŠ€,æœ‰æ“”ä¿,3,24.9,3,è©¢åœˆ,å…ƒå¤§è­‰åˆ¸,å»ºæç‡Ÿé€ æ¥­,ä¸Šæ›œé›†åœ˜æ——ä¸‹è±ªå®…å“ç‰Œ,27.9,,,1.01,2011-08-02,2014/07/23,122,99.65
17,1316,13166,ä¸Šæ›œå…­,æ¿ä¿¡éŠ€è¡Œ,æœ‰æ“”ä¿,4,17.8,3,ç«¶æ‹,å…ƒå¯Œè­‰åˆ¸,,,,100,100,1.1995,2024-12-27,2027-12-27,125.5,102.8
23,1341,13411,å¯Œæ—ä¸€K,TCRI6,ç„¡æ“”ä¿,1.5,75.8,3,ç«¶æ‹,ä¸­ä¿¡è­‰åˆ¸,å¡‘è† å·¥æ¥­,è¶Šå—ç¬¬ä¸€å¤§PVCäººé€ çš®é©ç”Ÿç”¢å•†,5.17,115,101.51,1.0218,2021-05-13,2024/05/13,116.9,100.8
24,1342,13421,å…«è²«ä¸€,è¯å—éŠ€è¡Œ,æœ‰æ“”ä¿,2,72,3,ç«¶æ‹,å…ƒå¤§è­‰åˆ¸,å…¶ä»–æ¥­,å°ç£æ©Ÿèƒ½æ€§çš®å¸ƒæ–™åŠè–„è†œè£½é€ å•†,7.13,112.93,100,1.0381,2022-06-02,2025/06/02,243,106.5
298,2025-11-14,2368,23683,é‡‘åƒé›»ä¸‰,50.63,90,5,ç„¡æ“”ä¿,3,76836,107,2025-11-10,482,450,1.0345,107.11111111111111,111,0.036307053941908585,112.88,0.053858921161825668,å¯Œé‚¦è­‰åˆ¸,é›»å­é›¶çµ„ä»¶æ¥­,1852,156043,2.0308579311780934,84.256479481641463,0,0
299,2025-11-14,3032,30322,å‰è¨“äºŒ,11.33,10,5,ç„¡æ“”ä¿,6,8567,101,2025-11-12,92.2,101.9,1.02,90.480863591756616,102.66,0.13460455531453364,104.73,0.15748232104121485,çµ±ä¸€è­‰åˆ¸,é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­,428,14701,1.716003268355317,34.348130841121495,0,0
    </script>

    <script id="csv_auction" type="text/csv">
åºè™Ÿ,é–‹æ¨™æ—¥æœŸ,è‚¡ç¥¨ä»£è™Ÿ,CBä»£è™Ÿ,åç¨±,è‚¡æœ¬,ç™¼è¡Œè¦æ¨¡,å¹´æœŸ,æ“”ä¿,ä¿¡è©•,ç«¶æ‹å¼µæ•¸,åº•æ¨™åƒ¹,æˆªæ¨™æ—¥,æˆªæ¨™æ”¶ç›¤,è½‰æ›åƒ¹,è¨‚åƒ¹æº¢åƒ¹ç‡,ç†è«–åƒ¹,æœ€ä½å¾—æ¨™,æœ€ä½æº¢åƒ¹,å¹³å‡å¾—æ¨™,å¹³å‡æº¢åƒ¹,ç™¼è¡Œåˆ¸å•†,ç”¢æ¥­åˆ†é¡,åˆæ ¼ä»¶æ•¸,æŠ•æ¨™å¼µæ•¸,æŠ•æ¨™å€æ•¸,æŠ•æ¨™å‡å¼µ,æ›ç‰Œæœ€é«˜,æ›ç‰Œæœ€ä½
1,2019-03-22,4943,49431,åº·æ§ä¸€KY,15.7,15,3,ç„¡æ“”ä¿,9,13500,100,2019-03-20,124.5,121.1,1.02,102.80759702725022,100.5,-0.022445783132530317,102.07,-0.00717453815261071,ä¸­ä¿¡è­‰åˆ¸,é›»å­é›¶çµ„ä»¶æ¥­,829,19751,1.4630370370370371,23.82509047044632,180,97.3
2,2019-09-02,4736,47363,æ³°åšä¸‰,9.22,15,5,æœ‰æ“”ä¿,4,12752,100,2019-08-07,126,140,1.0566,90,107.17,0.19077777777777771,108.46,0.20511111111111102,å‡±åŸºè­‰åˆ¸,ç”ŸæŠ€é†«ç™‚æ¥­,1559,54356,4.2625470514429109,34.865939704939066,238,111
3,2019-11-04,8028,80281,æ˜‡é™½ä¸€,13.2,10,3,ç„¡æ“”ä¿,6,8732,102,2019-10-31,76.8,76.1,1.02,100.9198423127464,108.45,0.07461523437499995,109.92,0.08918124999999999,å¯Œé‚¦è­‰åˆ¸,åŠå°é«”æ¥­,1063,31398,3.5957398076042142,29.537158984007526,120.8,96.9
24,2020-10-21,6477,64772,å®‰é›†äºŒ,11.4,3,5,ç„¡æ“”ä¿,6,2550,100,2020-10-19,59.5,42.1,1.02,141.33016627078385,115.2,-0.18488739495798323,120.18,-0.149650756302521,åœ‹æ³°è­‰åˆ¸,å…‰é›»æ¥­,599,8781,3.4435294117647057,14.659432387312187,176,99.75
177,2024-01-17,4967,49673,åéŠ“ä¸‰,7.15,12,3,æœ‰æ“”ä¿,6,10800,102,2024-01-15,85.2,81,1.0214,105.18518518518518,114.16,0.085323943661971935,116.16,0.10433802816901405,æ°¸è±é‡‘è­‰,åŠå°é«”æ¥­,885,31244,2.892962962962963,35.303954802259888,214,114
299,2025-11-14,3032,30322,å‰è¨“äºŒ,11.33,10,5,ç„¡æ“”ä¿,6,8567,101,2025-11-12,92.2,101.9,1.02,90.480863591756616,102.66,0.13460455531453364,104.73,0.15748232104121485,çµ±ä¸€è­‰åˆ¸,é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­,428,14701,1.716003268355317,34.348130841121495,0,0
    </script>

    <script>
        /* Rexå¤§å”è³‡æ–™åº«æ ¸å¿ƒé‚è¼¯ 
           åŒ…å« CSV è§£æã€è‡ªå‹•çµ±è¨ˆã€æ¬Šé‡è¨ˆç®—
        */
        
        // æ¨¡æ“¬è³‡æ–™åº«å„²å­˜ç‰©ä»¶
        const Database = {
            basic: [],
            auction: [],
            stats: {},
            cbMap: {} // åç¨±/ä»£è™Ÿ å°ç…§è¡¨
        };

        // 1. CSV è§£æå™¨
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const currentline = lines[i].split(',');
                if (currentline.length < 2) continue; // è·³éç©ºè¡Œ
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    let val = currentline[j] ? currentline[j].trim() : '';
                    // å˜—è©¦è½‰æ•¸å­—
                    if (!isNaN(val) && val !== '') val = parseFloat(val);
                    obj[headers[j]] = val;
                }
                result.push(obj);
            }
            return result;
        }

        // 2. æ•¸æ“šåˆå§‹åŒ–èˆ‡çµ±è¨ˆ
        function initData() {
            // è®€å– HTML ä¸­åµŒå…¥çš„ CSV (é€™è£¡ä½¿ç”¨æ‚¨æä¾›çš„å®Œæ•´æ•¸æ“šçš„å­é›†ä½œç‚ºç¯„ä¾‹ï¼Œå¯¦éš›é‹ä½œæ™‚è«‹ç¢ºä¿ script tag å…§æœ‰å®Œæ•´è³‡æ–™)
            // ç‚ºäº†è®“åŠŸèƒ½æ­£å¸¸ï¼Œæˆ‘å°‡æ¨¡æ“¬è®€å–æ‚¨è²¼ä¸Šçš„å…©å¤§æ®µè³‡æ–™ã€‚å¯¦éš›æ‡‰ç”¨æ™‚ï¼Œæ‚¨åªéœ€æŠŠå®Œæ•´ CSV è²¼å…¥ä¸Šé¢çš„ script æ¨™ç±¤å³å¯ã€‚
            
            // è®€å–åŸºæœ¬è³‡æ–™
            let basicText = document.getElementById('csv_basic').textContent;
            // è®€å–ç«¶æ‹è³‡æ–™
            let auctionText = document.getElementById('csv_auction').textContent;

            // è§£æ
            Database.basic = parseCSV(basicText);
            Database.auction = parseCSV(auctionText);

            // å»ºç«‹ç´¢å¼• (CBåç¨± -> åŸºæœ¬è³‡æ–™)
            Database.basic.forEach(row => {
                if(row['åç¨±']) Database.cbMap[row['åç¨±']] = row;
                if(row['CBä»£è™Ÿ']) Database.cbMap[row['CBä»£è™Ÿ']] = row;
                if(row['è‚¡ç¥¨ä»£è™Ÿ']) Database.cbMap[row['è‚¡ç¥¨ä»£è™Ÿ']] = row; // æ–¹ä¾¿æŸ¥è©¢
            });

            // é€²è¡Œçµ±è¨ˆåˆ†æ (è¨ˆç®—å„ç¶­åº¦çš„å¹³å‡æº¢åƒ¹ç‡)
            calculateStatistics();
            
            // æ›´æ–° UI
            updateSelectOptions();
            document.getElementById('loading').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | æ•´åˆ ${Database.basic.length} æª”CBåŸºæœ¬è³‡æ–™èˆ‡ ${Database.auction.length} ç­†ç«¶æ‹å¯¦ç¸¾`;
            
            // é¡¯ç¤ºæ‘˜è¦
            document.getElementById('statsSummary').innerHTML = `
                <div class="stat-box"><div class="number">${Database.basic.length}</div><div class="label">CBè³‡æ–™åº«</div></div>
                <div class="stat-box"><div class="number">${Database.auction.length}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
                <div class="stat-box"><div class="number">${(Database.stats.globalAvg || 0).toFixed(2)}%</div><div class="label">å¹³å‡æº¢åƒ¹ç‡</div></div>
            `;
        }

        // 3. çµ±è¨ˆé‹ç®—æ ¸å¿ƒ
        function calculateStatistics() {
            const buckets = {
                'ç”¢æ¥­åˆ†é¡': {}, 'ç™¼è¡Œåˆ¸å•†': {}, 'ä¿¡ç”¨è©•ç­‰': {}, 'æ“”ä¿': {}, 
                'è‚¡æœ¬': { '<5å„„':[], '5~10å„„':[], '10~20å„„':[], '>20å„„':[] },
                'ç™¼è¡Œè¦æ¨¡': { '<5å„„':[], '5~10å„„':[], '10~20å„„':[], '>20å„„':[] },
                'ç™¼è¡Œå¹´æœŸ': {}
            };

            let totalPremium = 0;
            let count = 0;

            Database.auction.forEach(row => {
                // å¿…é ˆæœ‰å¹³å‡æº¢åƒ¹è³‡æ–™
                if (row['å¹³å‡æº¢åƒ¹'] === undefined || row['å¹³å‡æº¢åƒ¹'] === '') return;
                
                // è™•ç†æº¢åƒ¹ç‡ï¼šå¦‚æœå°æ–¼2 (ä¾‹å¦‚ 0.05)ï¼Œè¦–ç‚º 5%ã€‚å¦‚æœå¤§æ–¼2 (ä¾‹å¦‚ 105)ï¼Œè¦–ç‚º 5%ã€‚
                // æ ¹æ“šæ‚¨æä¾›çš„ CSVï¼Œå¹³å‡æº¢åƒ¹æ¬„ä½åƒæ˜¯ "0.05" æˆ– "5.0"ï¼Œæˆ–æ˜¯å¾—æ¨™åƒ¹ "105"ã€‚
                // é€™è£¡åšå€‹ç°¡å–®åˆ¤æ–·ï¼š
                let premium = parseFloat(row['å¹³å‡æº¢åƒ¹']);
                let bidPrice = parseFloat(row['å¹³å‡å¾—æ¨™']);
                
                let finalPremium = 0;
                
                // é‚è¼¯ä¿®æ­£ï¼šä½¿ç”¨ (å¹³å‡å¾—æ¨™ - 100) ä½œç‚ºæº¢åƒ¹ç‡ä¼°ç®—ï¼Œæˆ–è€…ç›´æ¥ç”¨ CSV çš„æº¢åƒ¹æ¬„ä½
                // è§€å¯Ÿ CSV: å¹³å‡å¾—æ¨™ 102.07, å¹³å‡æº¢åƒ¹ -0.007? ä¼¼ä¹ä¸ä¸€è‡´ï¼Œæˆ‘å€‘çµ±ä¸€ç”¨ (å¹³å‡å¾—æ¨™ - 100)
                if (bidPrice > 0) {
                    finalPremium = bidPrice - 100; 
                } else {
                    // å‚™ç”¨
                    finalPremium = premium < 1 ? premium * 100 : premium; 
                }

                totalPremium += finalPremium;
                count++;

                const addVal = (cat, key) => {
                    if(!key) return;
                    if(!buckets[cat][key]) buckets[cat][key] = [];
                    buckets[cat][key].push(finalPremium);
                };

                addVal('ç”¢æ¥­åˆ†é¡', row['ç”¢æ¥­åˆ†é¡']);
                addVal('ç™¼è¡Œåˆ¸å•†', row['ç™¼è¡Œåˆ¸å•†']);
                addVal('ä¿¡ç”¨è©•ç­‰', row['ä¿¡è©•']);
                
                // æ“”ä¿è™•ç† (æœ‰æ“”ä¿/ç„¡æ“”ä¿)
                let guarantee = row['æ“”ä¿'] || 'ç„¡æ“”ä¿';
                if(guarantee.includes('æ“”ä¿') && !guarantee.includes('ç„¡')) guarantee = 'æœ‰æ“”ä¿';
                addVal('æ“”ä¿', guarantee);

                addVal('ç™¼è¡Œå¹´æœŸ', row['å¹´æœŸ']);

                // æ•¸å€¼åˆ†çµ„
                let cap = parseFloat(row['è‚¡æœ¬']);
                if(cap < 5) buckets['è‚¡æœ¬']['<5å„„'].push(finalPremium);
                else if(cap < 10) buckets['è‚¡æœ¬']['5~10å„„'].push(finalPremium);
                else if(cap < 20) buckets['è‚¡æœ¬']['10~20å„„'].push(finalPremium);
                else buckets['è‚¡æœ¬']['>20å„„'].push(finalPremium);

                let size = parseFloat(row['ç™¼è¡Œè¦æ¨¡']);
                if(size < 5) buckets['ç™¼è¡Œè¦æ¨¡']['<5å„„'].push(finalPremium);
                else if(size < 10) buckets['ç™¼è¡Œè¦æ¨¡']['5~10å„„'].push(finalPremium);
                else if(size < 20) buckets['ç™¼è¡Œè¦æ¨¡']['10~20å„„'].push(finalPremium);
                else buckets['ç™¼è¡Œè¦æ¨¡']['>20å„„'].push(finalPremium);
            });

            // è¨ˆç®—å¹³å‡å€¼
            const stats = {};
            for(let cat in buckets) {
                stats[cat] = {};
                for(let key in buckets[cat]) {
                    const arr = buckets[cat][key];
                    if(arr.length > 0) {
                        const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
                        const min = Math.min(...arr);
                        // è¨ˆç®—ä¿‚æ•¸ (è©²é¡åˆ¥å¹³å‡ / å…¨å±€å¹³å‡)
                        const globalAvg = count > 0 ? totalPremium / count : 5; 
                        const coef = avg / globalAvg;
                        
                        stats[cat][key] = {
                            avg: avg,
                            min: min,
                            count: arr.length,
                            coef: coef
                        };
                    }
                }
            }
            
            Database.stats = stats;
            Database.stats.globalAvg = count > 0 ? totalPremium / count : 5;
        }

        // 4. UI äº’å‹•é‚è¼¯
        function updateSelectOptions() {
            const populate = (id, data) => {
                const sel = document.getElementById(id);
                // ä¿ç•™ç¬¬ä¸€å€‹é¸é …
                while (sel.options.length > 1) sel.remove(1);
                
                // æ’åºï¼šç­†æ•¸å¤šçš„åœ¨å‰
                const keys = Object.keys(data).sort((a,b) => data[b].count - data[a].count);
                
                keys.forEach(k => {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.textContent = `${k} (${data[k].count}ç­†)`;
                    sel.appendChild(opt);
                });
            };

            if(Database.stats['ç”¢æ¥­åˆ†é¡']) populate('industry', Database.stats['ç”¢æ¥­åˆ†é¡']);
            if(Database.stats['ç™¼è¡Œåˆ¸å•†']) populate('broker', Database.stats['ç™¼è¡Œåˆ¸å•†']);
        }

        // è‡ªå‹•å¸¶å…¥åŠŸèƒ½
        document.getElementById('cbName').addEventListener('input', function() {
            const val = this.value.trim();
            const infoBox = document.getElementById('cbNameInfo');
            
            // æ¨¡ç³Šæœå°‹
            const foundKey = Object.keys(Database.cbMap).find(k => k.includes(val));
            const data = Database.cbMap[foundKey];

            if (data) {
                infoBox.style.display = 'block';
                infoBox.innerHTML = `<div class="stats-header">âœ… å·²æ‰¾åˆ°ï¼š${data['åç¨±']} (${data['CBä»£è™Ÿ']})</div>`;
                
                // è‡ªå‹•å¡«å…¥
                if(data['è‚¡æœ¬å¤§å°']) document.getElementById('capital').value = data['è‚¡æœ¬å¤§å°'];
                if(data['ç”¢æ¥­åˆ†é¡']) document.getElementById('industry').value = data['ç”¢æ¥­åˆ†é¡'].trim(); // éœ€ç¢ºä¿ä¸‹æ‹‰é¸å–®æœ‰æ­¤å€¼
                // å¦‚æœä¸‹æ‹‰é¸å–®æ²’æœ‰ï¼Œå¯èƒ½éœ€è¦å‹•æ…‹æ–°å¢æˆ–è¨­ç‚º"å…¶ä»–"
                
                if(data['ç™¼è¡Œåˆ¸å•†']) document.getElementById('broker').value = data['ç™¼è¡Œåˆ¸å•†'].trim();
                if(data['ç™¼è¡Œè¦æ¨¡']) document.getElementById('issueSize').value = data['ç™¼è¡Œè¦æ¨¡'];
                if(data['è½‰æ›åƒ¹æ ¼']) document.getElementById('conversionPrice').value = data['è½‰æ›åƒ¹æ ¼'];
                if(data['ç™¼è¡Œå¹´æœŸ']) document.getElementById('years').value = parseInt(data['ç™¼è¡Œå¹´æœŸ']);
                if(data['æ“”ä¿']) document.getElementById('guarantee').value = data['æ“”ä¿'].includes('ç„¡') ? 'ç„¡æ“”ä¿' : 'æœ‰æ“”ä¿';
                
                // è™•ç†ä¿¡è©• (æ ¼å¼å¯èƒ½ä¸åŒï¼Œç°¡å–®å°æ‡‰)
                let rating = data['ä¿¡ç”¨è©•ç­‰'] ? data['ä¿¡ç”¨è©•ç­‰'].replace('TCRI', '').trim() : '';
                const ratingSel = document.getElementById('rating');
                for(let i=0; i<ratingSel.options.length; i++) {
                    if(ratingSel.options[i].value == rating) {
                        ratingSel.selectedIndex = i;
                        break;
                    }
                }

                triggerInfoUpdate('capital');
                triggerInfoUpdate('industry');
            } else {
                infoBox.style.display = 'none';
            }
        });

        // é¡¯ç¤ºçµ±è¨ˆæ•¸æ“šå°å¡
        function triggerInfoUpdate(id) {
            const el = document.getElementById(id);
            const infoEl = document.getElementById(id + 'Info');
            let cat = '';
            let val = el.value;

            if(id === 'industry') cat = 'ç”¢æ¥­åˆ†é¡';
            if(id === 'broker') cat = 'ç™¼è¡Œåˆ¸å•†';
            if(id === 'capital') {
                cat = 'è‚¡æœ¬';
                val = parseFloat(val);
                if(val < 5) val = '<5å„„';
                else if(val < 10) val = '5~10å„„';
                else if(val < 20) val = '10~20å„„';
                else val = '>20å„„';
            }
            if(id === 'issueSize') {
                cat = 'ç™¼è¡Œè¦æ¨¡';
                val = parseFloat(val);
                if(val < 5) val = '<5å„„';
                else if(val < 10) val = '5~10å„„';
                else if(val < 20) val = '10~20å„„';
                else val = '>20å„„';
            }
            // ... å…¶ä»–æ¬„ä½é¡æ¨

            if(cat && val && Database.stats[cat] && Database.stats[cat][val]) {
                const s = Database.stats[cat][val];
                infoEl.style.display = 'block';
                infoEl.innerHTML = `
                    <div class="stats-header">ğŸ“Š æ­·å²å¤§æ•¸æ“š (${val})</div>
                    <div class="stat-row"><span>æ¨£æœ¬æ•¸:</span><span class="stat-value">${s.count} ç­†</span></div>
                    <div class="stat-row"><span>å¹³å‡æº¢åƒ¹:</span><span class="stat-value">${s.avg.toFixed(2)}%</span></div>
                `;
            } else {
                infoEl.style.display = 'none';
            }
        }

        ['capital', 'issueSize', 'industry', 'broker', 'rating', 'guarantee', 'years'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => triggerInfoUpdate(id));
            document.getElementById(id).addEventListener('input', () => triggerInfoUpdate(id));
        });

        // è¨ˆç®—ä¸»ç¨‹å¼
        document.getElementById('evaluationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const stockPrice = parseFloat(document.getElementById('stockPrice').value);
            const convPrice = parseFloat(document.getElementById('conversionPrice').value);
            const theoPrice = (stockPrice / convPrice) * 100;

            // æ”¶é›†å„ç¶­åº¦ä¿‚æ•¸
            let totalCoef = 0;
            let factors = 0;
            const factorsList = [];

            const getCoef = (cat, val) => {
                if(Database.stats[cat] && Database.stats[cat][val]) {
                    return Database.stats[cat][val].coef;
                }
                return 1.0;
            };

            // 1. ç”¢æ¥­
            const ind = document.getElementById('industry').value;
            const indCoef = getCoef('ç”¢æ¥­åˆ†é¡', ind);
            totalCoef += indCoef * 0.3; // æ¬Šé‡ 30%
            factorsList.push({name: 'ç”¢æ¥­', val: ind, coef: indCoef, weight: '30%'});

            // 2. è‚¡æœ¬
            let cap = parseFloat(document.getElementById('capital').value);
            let capKey = cap < 5 ? '<5å„„' : (cap < 10 ? '5~10å„„' : (cap < 20 ? '10~20å„„' : '>20å„„'));
            const capCoef = getCoef('è‚¡æœ¬', capKey);
            totalCoef += capCoef * 0.2; // æ¬Šé‡ 20%
            factorsList.push({name: 'è‚¡æœ¬', val: capKey, coef: capCoef, weight: '20%'});

            // 3. è¦æ¨¡
            let size = parseFloat(document.getElementById('issueSize').value);
            let sizeKey = size < 5 ? '<5å„„' : (size < 10 ? '5~10å„„' : (size < 20 ? '10~20å„„' : '>20å„„'));
            const sizeCoef = getCoef('ç™¼è¡Œè¦æ¨¡', sizeKey);
            totalCoef += sizeCoef * 0.1; // æ¬Šé‡ 10%
            factorsList.push({name: 'è¦æ¨¡', val: sizeKey, coef: sizeCoef, weight: '10%'});

            // 4. ä¿¡è©•
            const rat = document.getElementById('rating').value;
            const ratCoef = getCoef('ä¿¡ç”¨è©•ç­‰', rat);
            totalCoef += ratCoef * 0.2; // æ¬Šé‡ 20%
            factorsList.push({name: 'ä¿¡è©•', val: rat, coef: ratCoef, weight: '20%'});

            // 5. æ“”ä¿
            const guar = document.getElementById('guarantee').value;
            const guarCoef = getCoef('æ“”ä¿', guar);
            totalCoef += guarCoef * 0.2; // æ¬Šé‡ 20%
            factorsList.push({name: 'æ“”ä¿', val: guar, coef: guarCoef, weight: '20%'});

            // åŸºç¤æº¢åƒ¹ç‡ (å…¨å±€å¹³å‡)
            const basePremium = Database.stats.globalAvg; 
            
            // è¨ˆç®—é æ¸¬æº¢åƒ¹
            let predPremium = basePremium * totalCoef;

            // ä¸»è§€æ¬Šé‡
            const subWeight = parseFloat(document.getElementById('subjectiveWeight').value) || 0;
            if (subWeight > 0) {
                // ç°¡å–®æ¨¡å‹ï¼šè‹¥ä½¿ç”¨è€…æœ‰å¡«å¯«ï¼Œæ­¤è™•åƒ…åšç¤ºç¯„ï¼Œå¯¦éš›å¯åŠ å…¥ä¸»è§€æº¢åƒ¹æ¬„ä½
                // é€™è£¡å‡è¨­ä½¿ç”¨è€…å¿ƒä¸­å·²æœ‰å®šè¦‹ï¼Œå‰‡æ‹‰è¿‘ 100 + é è¨­æº¢åƒ¹
            }

            // è¨ˆç®—å¾—æ¨™åƒ¹
            // é€™è£¡ä½¿ç”¨æ··åˆæ¨¡å‹ï¼š ç†è«–åƒ¹ * (1 + é æ¸¬æº¢åƒ¹ç‡/100) 
            // ä½†å¦‚æœç†è«–åƒ¹å¾ˆä½ (ä¾‹å¦‚80)ï¼Œç«¶æ‹é€šå¸¸æœ‰ä¿åº• (ä¾‹å¦‚ 100~102)ã€‚
            // å¦‚æœç†è«–åƒ¹å¾ˆé«˜ (ä¾‹å¦‚140)ï¼Œæº¢åƒ¹ç‡é€šå¸¸æœƒæ”¶æ–‚ã€‚
            
            // ä¿®æ­£æ¨¡å‹ï¼š
            // 1. åŸºæº– = Max(ç†è«–åƒ¹, 100)
            // 2. åŠ ä¸Š é æ¸¬æº¢åƒ¹
            
            let base = Math.max(theoPrice, 98); // åœ°æ¿åƒ¹é™„è¿‘
            // ç°¡å–®ç®—æ³•ï¼šé æ¸¬å¾—æ¨™ = ç†è«–åƒ¹ + æº¢åƒ¹çµ•å°å€¼ (è‹¥æ˜¯åƒ¹å…§)
            // æˆ–è€… é æ¸¬å¾—æ¨™ = ç†è«–åƒ¹ * (1 + æº¢åƒ¹ç‡)
            
            // æ¡ç”¨ï¼šé ä¼°å¾—æ¨™åƒ¹ = ç†è«–åƒ¹ * (1 + é æ¸¬æº¢åƒ¹/100)
            // ä½†éœ€è€ƒæ…® CB ç‰¹æ€§ï¼Œåƒ¹å¤–æ™‚æº¢åƒ¹ç‡é«˜ï¼Œåƒ¹å…§æ™‚æº¢åƒ¹ç‡ä½ (æ”¶æ–‚åˆ°è‚¡åƒ¹)
            
            // é€™è£¡ç‚ºäº†å±•ç¤º "æ•¸æ“šé©…å‹•"ï¼Œç›´æ¥ä½¿ç”¨çµ±è¨ˆå‡ºä¾†çš„ premium ç–ŠåŠ 
            let predictedBid = base * (1 + (predPremium * 0.01)); 

            // é¡¯ç¤ºçµæœ
            const resultDiv = document.getElementById('evaluationResult');
            document.getElementById('welcomeMsg').style.display = 'none';
            resultDiv.style.display = 'block';
            
            let tableRows = factorsList.map(f => `
                <tr>
                    <td>${f.name}</td>
                    <td>${f.val}</td>
                    <td>${(Database.stats[f.name === 'ç”¢æ¥­' ? 'ç”¢æ¥­åˆ†é¡' : (f.name === 'è‚¡æœ¬' ? 'è‚¡æœ¬' : (f.name === 'è¦æ¨¡' ? 'ç™¼è¡Œè¦æ¨¡' : (f.name === 'ä¿¡è©•' ? 'ä¿¡ç”¨è©•ç­‰' : 'æ“”ä¿')))][f.val]?.avg || 0).toFixed(2)}%</td>
                    <td>${f.coef.toFixed(2)}</td>
                    <td>${f.weight}</td>
                </tr>
            `).join('');

            resultDiv.innerHTML = `
                <div class="result-header">
                    <h2>${document.getElementById('cbName').value}</h2>
                    <div class="subtitle">ç†è«–åƒ¹æ ¼ï¼š${theoPrice.toFixed(2)} å…ƒ</div>
                </div>
                <div class="detail-section">
                    <h3>ğŸ” æ•¸æ“šé©…å‹•åˆ†æ</h3>
                    <table class="data-table">
                        <thead><tr><th>ç¶­åº¦</th><th>æ¢ä»¶</th><th>æ­·å²å¹³å‡æº¢åƒ¹</th><th>å½±éŸ¿ä¿‚æ•¸</th><th>æ¬Šé‡</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
                <div class="rex-analysis">
                    <div class="rex-title">ğŸ§¢ Rexå¤§å” æ•¸æ“šé»è©•</div>
                    <div class="rex-content">
                        <p>æ ¹æ“šè³‡æ–™åº« <strong>${Database.auction.length}</strong> ç­†æ­·å²ç«¶æ‹æ•¸æ“šåˆ†æï¼š</p>
                        <p>æ­¤æ¨™çš„ç¶œåˆè©•åˆ†ä¿‚æ•¸ç‚º <strong>${totalCoef.toFixed(2)}</strong>ï¼Œé¡¯ç¤ºå…¶æ¢ä»¶ ${(totalCoef > 1 ? 'å„ªæ–¼' : 'ç•¥ä½æ–¼')} å¸‚å ´å¹³å‡æ°´æº–ã€‚</p>
                        <p>å…¨å¸‚å ´å¹³å‡æº¢åƒ¹ç‡ç´„ç‚º <strong>${basePremium.toFixed(2)}%</strong>ã€‚</p>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>ğŸ’¡ å»ºè­°æŠ•æ¨™åƒ¹æ ¼</h3>
                    <div class="price-grid">
                        <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆ</h4><div class="price">${(predictedBid * 0.98).toFixed(2)}</div></div>
                        <div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡</h4><div class="price">${predictedBid.toFixed(2)}</div></div>
                        <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µ</h4><div class="price">${(predictedBid * 1.02).toFixed(2)}</div></div>
                        <div class="strategy-card ultimate"><h4>ğŸ”¥ æ¥µè‡´</h4><div class="price">${(predictedBid * 1.04).toFixed(2)}</div></div>
                    </div>
                </div>
                <div style="text-align:center;margin-top:30px;">
                    <button onclick="location.reload()" style="padding:15px 40px;background:#667eea;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:bold;">ğŸ”„ é‡æ–°è©•ä¼°</button>
                </div>
            `;
            
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        });

        // å•Ÿå‹•
        window.addEventListener('DOMContentLoaded', initData);
    </script>
</body>
</html>
