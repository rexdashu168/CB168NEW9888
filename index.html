<!DOCTYPE html>

<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI智能可轉債競拍系統 v3.98c (集成預測引擎版)</title>
<!-- v3.98c: 修正集成預測引擎的m.value.toFixed錯誤，加強所有數值運算的安全檢查 -->
<!-- v3.98b: 修正step0Reminder的null錯誤 -->
<!-- v3.98a: 集成預測引擎優化版 - 基於304筆歷史資料統計分析優化 -->
<!-- 核心優化：
     1. 新增集成預測引擎 v2.0 (Ensemble Engine) - 整合4種預測方法，MAE≈3.4元
     2. 新增MA10市場熱度指標 - 追蹤近10檔競拍趨勢
     3. 新增分層模型 - 按理論價區間+擔保類型分層預測，訓練MAE=3.19元
     4. 新增市場熱度儀表板 - 可視化近期市場冷熱狀態
     5. 策略價格採用黃金比例係數 (0.618σ / 1.236σ)
     研究發現：投標倍數為最強預測因子(相關係數0.736)，但截標前無法取得
     集成方法可有效降低單一方法的預測風險
-->
<!-- v3.97-cw: 第五區塊改為「台股熱門交易」- 漲跌幅排行/計量強勢/計量弱勢 -->
<!-- v3.97-cu: 精簡為三大核心模組 - Step1基礎數據 + Step2最強大腦 + Step3 AI智能預測 -->
<!-- v3.97-ct: 新增AI智慧核心模組 - 異常值處理、信心度量化、氛圍偏離警示、雙軌整合預測 -->
<!-- v3.97-as-cs: 得標均價法加入歷史落差調整係數（理論價<90:+5%, <95:+3%, <97.5:+2%）-->
<!-- v3.97-as-cr: Step 1 明細動態跟隨標籤切換 -->

<!-- v3.97-as-ca: 改為從 data/00_cb/ 載入 CSV 檔案 -->

<!-- v3.97-as-bz: 新增載入 12_call_execute.csv，修正強制贖回資料來源 -->

<!-- v3.97-as-by: 修正強制贖回資料從 kanbanData 讀取，優化週餘額圖表尺寸 -->

<!-- v3.97-as-bx: 程式碼清理，移除重複函數與未使用程式碼 -->

<!-- v3.97-as-bw: 新增「漲跌幅排行」區塊，支援多時間區間切換 -->

<!-- v3.97-as-bv: 修正期間過濾邏輯，改為從資料最新日期往前推算 -->

<!-- v3.97-as-bu: 優化 CB 價格走勢區塊佈局，標題/按鈕/統計數據分列顯示 -->

<!-- v3.97-as-bt: 修正 SVG 圖表手機版太小的問題，增加高度和字體 -->

<!-- v3.97-as-bs: 將三個 Canvas 圖表轉換為 SVG（股價走勢、理論價值、籌碼轉換）-->

<!-- v3.97-zs-br: 改用 SQLite 資料庫載入 kanban 資料 -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

<!-- v3.97-dp: 加入 SheetJS 用於讀取 Excel 檔案 -->

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
/* ================= 風格設定 ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
/* v3.97-zs-bt: 防止手機版溢出 */
html, body { overflow-x: hidden; max-width: 100vw; }
body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1600px; margin: 0 auto; }
.header { background: white; border-radius: 15px; padding: 25px 30px; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 2px solid rgba(102, 126, 234, 0.3); border-left: 6px solid #E91E63; width: 100%; box-sizing: border-box; }
.header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; font-weight: 900; }
.header .subtitle { color: #666; font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; flex-wrap: wrap; }
.version-badge { display: inline-block; background: #7B1FA2; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; margin: 8px 0 12px 0; }

.evaluation-container { display: grid; grid-template-columns: 1fr 8px 3fr; gap: 0; width: 100%; }
.resizer { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: col-resize; position: relative; border-radius: 4px; transition: background 0.2s; }
.resizer:hover { background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%); }
.resizer::before { content: "⋮"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 18px; font-weight: bold; }
.input-panel { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); position: sticky; top: 20px; border: 2px solid rgba(102, 126, 234, 0.3); border-left: 6px solid #667eea; box-sizing: border-box; max-height: calc(100vh - 40px); overflow-y: auto; min-width: 280px; }
.input-panel::-webkit-scrollbar { width: 8px; }
.input-panel::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
.input-panel::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; }
.input-panel::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%); }
.input-panel h2 { color: #667eea; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid #667eea; font-weight: 800; }
.form-section { margin-bottom: 20px; }
.form-section h3 { color: #333; font-size: 15px; margin-bottom: 12px; font-weight: bold; border-left: 4px solid #667eea; padding-left: 10px; }
.form-group { margin-bottom: 10px; }
.form-group label { display: block; color: #555; font-size: 12px; margin-bottom: 4px; font-weight: 700; }
.form-group input, .form-group select { width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; transition: border-color 0.3s; font-weight: 600; color:#333; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; background: #fcfdff; }

/* ===== v3.81 新增：三大功能區塊分隔樣式 ===== */
.zone-divider {
    display: flex;
    align-items: center;
    margin: 25px 0 20px 0;
    gap: 10px;
}
.zone-divider::before,
.zone-divider::after {
    content: "";
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, transparent, #667eea, transparent);
}
.zone-title {
    font-size: 16px;
    font-weight: 900;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    white-space: nowrap;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}
.zone-title.zone-input { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.zone-title.zone-ai { background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); }
.zone-title.zone-market { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }

/* 區塊容器樣式 */
.zone-container {
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}
.zone-container.zone-input-box {
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
    border: 1px solid rgba(102, 126, 234, 0.2);
}
.zone-container.zone-ai-box {
    background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
    border: 2px solid #00bcd4;
}
.zone-container.zone-market-box {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 2px solid #ff9800;
}

/* 右側面板區塊標題 */
.panel-zone-header {
    font-size: 18px;
    font-weight: 900;
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    margin: 25px 0 15px 0;
    display: flex;
    align-items: center;
    gap: 10px;
}
.panel-zone-header.trend-zone { background: linear-gradient(135deg, #3f51b5 0%, #303f9f 100%); }
.panel-zone-header.stats-zone { background: linear-gradient(135deg, #009688 0%, #00796b 100%); }
.panel-zone-header.perf-zone { background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); }

/* ===== v3.81 新增：主區塊分隔樣式 ===== */
.main-section {
    margin-bottom: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
}
.main-section-header {
    padding: 12px 15px;
    font-size: 16px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s;
}
.main-section-header:hover {
    filter: brightness(0.95);
}
.main-section-header .toggle-icon {
    margin-left: auto;
    font-size: 12px;
    transition: transform 0.3s;
}
.main-section-header.collapsed .toggle-icon {
    transform: rotate(-90deg);
}
.main-section-content {
    padding: 15px;
    background: white;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    overflow: hidden;
}
.main-section-content.collapsed {
    max-height: 0 !important;
    padding-top: 0;
    padding-bottom: 0;
}

/* 區塊一：競拍條件輸入 - 藍色系 */
.section-input { border-color: #667eea; }
.section-input .main-section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

/* 區塊二：AI智能評估 - 紫色系 */
.section-ai { border-color: #9c27b0; }
.section-ai .main-section-header {
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    color: white;
}

/* 區塊三：市場溫度計 - 綠色系 */
.section-market { border-color: #4caf50; }
.section-market .main-section-header {
    background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
    color: white;
}

/* 右側面板區塊樣式 */
.right-section {
    margin-bottom: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    overflow: hidden;
    background: white;
}
.right-section-header {
    padding: 15px 20px;
    font-size: 16px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s;
}
.right-section-header:hover {
    filter: brightness(0.95);
}
.right-section-header .toggle-icon {
    margin-left: auto;
    font-size: 14px;
    transition: transform 0.3s;
}
.right-section-header.collapsed .toggle-icon {
    transform: rotate(-90deg);
}
.right-section-content {
    padding: 20px;
    background: white;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    overflow-y: auto;
    max-height: 800px; /* 展開後的最大高度，可滾動 */
}
.right-section-content.collapsed {
    max-height: 0 !important;
    padding-top: 0;
    padding-bottom: 0;
    overflow: hidden;
}

/* 右側區塊一：市場趨勢分析 - 藍色系 */
.section-trend { border-color: #1976d2; }
.section-trend .right-section-header {
    background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
    color: white;
}

/* 右側區塊二：績效分析 - 綠色系 */
.section-performance { border-color: #4caf50; }
.section-performance .right-section-header {
    background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
    color: white;
}

/* 右側區塊三：基本資料查詢 - 橘色系 */
.section-basic-info { border-color: #ff9800; }
.section-basic-info .right-section-header {
    background: linear-gradient(135deg, #ff9800 0%, #e65100 100%);
    color: white;
}

/* 右側區塊四：價格走勢分析 - 紫色系 */
.section-price-trend { border-color: #9c27b0; }
.section-price-trend .right-section-header {
    background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    color: white;
}

/* 右側區塊五：漲跌幅排行 - 紅綠系 */
.section-ranking { border-color: #e91e63; }
.section-ranking .right-section-header {
    background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
    color: white;
}

/* v3.97-as-ce: 移除舊的 ranking-period CSS，改用 inline style */

/* 基本資料查詢標籤樣式 */
.basic-info-tabs {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 0;
    background: #fff3e0;
    padding: 8px;
    border-radius: 8px 8px 0 0;
    border: 1px solid #ffcc80;
    border-bottom: none;
}
.basic-info-tab {
    padding: 8px 12px;
    border: none;
    background: #ffe0b2;
    color: #e65100;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}
.basic-info-tab:hover {
    background: #ffcc80;
}
.basic-info-tab.active {
    background: #ff9800;
    color: white;
}

/* 價格走勢標籤樣式 */
.price-trend-tabs {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 0;
    background: #f3e5f5;
    padding: 8px;
    border-radius: 8px 8px 0 0;
    border: 1px solid #ce93d8;
    border-bottom: none;
}
.price-trend-tab {
    padding: 8px 12px;
    border: none;
    background: #e1bee7;
    color: #7b1fa2;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s;
    -webkit-tap-highlight-color: rgba(156, 39, 176, 0.3);
    touch-action: manipulation;
    user-select: none;
    min-height: 36px;
}
.price-trend-tab:hover, .price-trend-tab:active {
    background: #ce93d8;
}
.price-trend-tab.active {
    background: #9c27b0;
    color: white;
}

/* 資訊卡片 */
.info-box { background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 5px solid #4CAF50; margin-top: 8px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); animation: slideDown 0.3s ease-out; }
.tip-300 { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); padding: 10px 12px; border-radius: 8px; border-left: 4px solid #8b5cf6; margin-top: 6px; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); animation: slideDown 0.3s ease-out; }
.tip-300 .tip-title { font-weight: bold; color: #6d28d9; margin-bottom: 4px; }
.tip-300 .tip-stats { display: flex; gap: 12px; flex-wrap: wrap; color: #4c1d95; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* ===== 歷史搜尋結果卡片 (v3.52 條件評估版) ===== */
.history-results {
    margin-top: 10px;
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border: 2px solid #9c27b0;
    border-radius: 12px;
    padding: 12px;
    display: none;
    max-height: 620px;
    overflow-y: auto;
}
.history-results-title {
    font-size: 16px;
    font-weight: bold;
    color: #6a1b9a;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* 詢圈案例簡單卡片 - 單行緊湊版 */
.inquiry-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 1px solid #64b5f6;
    border-radius: 8px;
    margin-bottom: 8px;
    padding: 10px 14px;
    font-size: 14px;
}
.inquiry-card .hc-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}
.inquiry-card .hc-badge {
    background: #1976d2;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.inquiry-card .hc-name {
    font-weight: 700;
    color: #1565c0;
    font-size: 15px;
}
.inquiry-card .hc-line {
    display: flex;
    flex-wrap: wrap;
    gap: 5px 14px;
    margin-bottom: 8px;
}
.inquiry-card .hc-info {
    font-size: 13px;
    color: #444;
    white-space: nowrap;
}
.inquiry-card .hc-info b {
    color: #222;
}
.inquiry-card .hc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 8px;
}
.inquiry-card .hc-table th {
    background: #e3f2fd;
    color: #1565c0;
    padding: 6px 5px;
    font-size: 12px;
    font-weight: 700;
}
.inquiry-card .hc-table td {
    padding: 6px 5px;
    text-align: center;
    border-bottom: 1px solid #bbdefb;
    font-size: 13px;
}
.inquiry-badge {
    background: #1976d2;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.inquiry-name {
    font-weight: 700;
    color: #1565c0;
    font-size: 15px;
}
.inquiry-info {
    color: #444;
    white-space: nowrap;
    font-size: 13px;
}
.inquiry-info b {
    color: #222;
}
.inquiry-info b.pink {
    color: #E91E63;
}

/* 單筆歷史卡片(競拍) - 緊湊版 */
.history-card {
    background: #f3e5f5;
    padding: 10px 14px;
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid #ba68c8;
    font-size: 14px;
}
.history-card:last-child { margin-bottom: 0; }

/* 卡片標題列 */
.hc-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}
.hc-badge {
    background: #9C27B0;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.hc-name {
    font-weight: 700;
    color: #6a1b9a;
    flex: 1;
    font-size: 15px;
}
.hc-date {
    font-size: 13px;
    color: #888;
}

/* 資訊列 - 橫向緊湊排列 */
.hc-line {
    display: flex;
    flex-wrap: wrap;
    gap: 5px 12px;
    margin-bottom: 8px;
}
.hc-info {
    color: #444;
    font-size: 13px;
    white-space: nowrap;
}
.hc-info b {
    color: #222;
    margin-left: 1px;
}

/* 卡片內表格 - 得標+掛牌合併 */
.hc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 8px;
    background: white;
    border-radius: 4px;
    overflow: hidden;
}
.hc-table th {
    background: #7B1FA2;
    color: white;
    padding: 7px 5px;
    font-weight: 700;
    text-align: center;
    font-size: 12px;
}
.hc-table td {
    padding: 7px 5px;
    text-align: center;
    border: 1px solid #e0e0e0;
    font-weight: 600;
    font-size: 13px;
}
.td-label {
    background: #f3e5f5;
    color: #6a1b9a;
    font-weight: 700;
    font-size: 12px;
}
.val-red { color: #d32f2f; font-weight: 700; }
.val-pink { color: #E91E63; font-weight: 900; }

/* 警示語 */
.warning-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-top: 6px; font-size: 14px; color: #e65100; font-weight: bold; border-radius: 4px; }

/* 綠色卡片內的掛牌表格 */
.card-market-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 10px;
    border-radius: 4px;
    overflow: hidden;
}
.card-market-table th {
    background: #2e7d32;
    color: white;
    padding: 8px 6px;
    font-weight: 700;
    font-size: 13px;
    text-align: center;
}
.card-market-table td {
    padding: 8px 6px;
    text-align: center;
    border-bottom: 1px solid #c8e6c9;
    background: #f1f8e9;
    font-size: 14px;
}
.card-market-table .type-label {
    font-weight: 700;
    color: #1b5e20;
    text-align: left;
    padding-left: 10px;
    font-size: 13px;
}
.card-market-table .type-label .count {
    font-size: 12px;
    color: #666;
    margin-left: 4px;
}
.card-market-table .val-blue { font-weight: 700; color: #1565c0; }
.card-market-table .val-pink { font-weight: 700; color: #E91E63; }
.card-market-table .total-row td {
    background: #c8e6c9;
    font-weight: 900;
    border-top: 2px solid #4CAF50;
}
/* v3.52 新增：排除前三的淺色底 */
.card-market-table .exclude-row td {
    background: #e3f2fd;
    font-style: italic;
}

/* v3.53 新增：競拍得標表格 */
.card-bid-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 8px;
    border-radius: 4px;
    overflow: hidden;
}
.card-bid-table th {
    background: #2e7d32;
    color: white;
    padding: 8px 5px;
    font-weight: 700;
    font-size: 13px;
    text-align: center;
}
.card-bid-table td {
    padding: 8px 5px;
    text-align: center;
    border-bottom: 1px solid #c8e6c9;
    background: #f1f8e9;
    font-weight: 600;
    font-size: 14px;
}
.card-bid-table .type-label {
    font-weight: 700;
    color: #1b5e20;
    text-align: left;
    padding-left: 8px;
    white-space: nowrap;
    font-size: 13px;
}
.card-bid-table .type-label .count {
    font-size: 11px;
    color: #666;
    margin-left: 3px;
}
.card-bid-table .val-green { font-weight: 700; color: #2e7d32; }
.card-bid-table .val-red { font-weight: 700; color: #d32f2f; }
.card-bid-table .total-row td {
    background: #c8e6c9;
    font-weight: 900;
    border-top: 2px solid #4CAF50;
}

/* v3.58 市場趨勢分析模組 */
.market-trend-section {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 2px solid #ffa000;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.market-trend-header {
    font-size: 16px;
    font-weight: bold;
    color: #e65100;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.market-trend-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.market-trend-tab {
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #ffcc80;
    color: #e65100;
}
.market-trend-tab:hover {
    background: #ffb74d;
}
.market-trend-tab.active {
    background: #ff9800;
    color: white;
}
.market-trend-content {
    background: white;
    border-radius: 8px;
    padding: 15px;
    max-height: 500px;
    overflow-y: auto;
}
.trend-table-wrapper {
    overflow-x: auto;
    margin-bottom: 12px;
}
.trend-year-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-bottom: 12px;
    min-width: 550px;
}
.trend-year-table th {
    background: #ff9800;
    color: white;
    padding: 10px 6px;
    font-weight: 600;
    text-align: center;
    font-size: 13px;
}
/* v3.96 新增：可排序表頭樣式 */
.trend-year-table th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 18px;
}
.trend-year-table th.sortable:hover {
    background: #f57c00;
}
.trend-year-table th.sortable::after {
    content: '⇅';
    position: absolute;
    right: 4px;
    font-size: 10px;
    opacity: 0.6;
}
.trend-year-table th.sortable.sort-asc::after {
    content: '▲';
    opacity: 1;
}
.trend-year-table th.sortable.sort-desc::after {
    content: '▼';
    opacity: 1;
}
.trend-year-table td {
    padding: 10px 6px;
    text-align: center;
    border-bottom: 1px solid #f0f0f0;
    font-size: 13px;
}
.trend-year-table tr:hover {
    background: #f5f5f5;
}
.trend-year-table .year-cell {
    font-weight: 700;
    color: #e65100;
}
.trend-year-table .amp-high {
    color: #2e7d32;
    font-weight: 700;
}
.trend-year-table .amp-low {
    color: #c62828;
    font-weight: 700;
}
.trend-year-table .total-row {
    background: #fff3e0;
    font-weight: 900;
    border-top: 2px solid #ff9800;
}
.trend-compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
}
@media (max-width: 600px) {
    .trend-compare-grid {
        grid-template-columns: 1fr;
    }
}
.trend-compare-card {
    background: #fff8e1;
    border: 1px solid #ffcc80;
    border-radius: 8px;
    padding: 14px;
}
.trend-compare-card h4 {
    font-size: 15px;
    color: #e65100;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.trend-compare-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed #ffe0b2;
    font-size: 14px;
}
.trend-compare-row:last-child {
    border-bottom: none;
}
.trend-compare-label {
    color: #555;
    font-size: 14px;
}
.trend-compare-value {
    font-weight: 700;
    font-size: 15px;
}
.trend-compare-value.positive {
    color: #2e7d32;
}
.trend-compare-value.negative {
    color: #c62828;
}
.trend-insight-box {
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
    border-left: 4px solid #e91e63;
    padding: 14px;
    margin-top: 12px;
    border-radius: 0 8px 8px 0;
    font-size: 14px;
    line-height: 1.8;
}
.trend-insight-box .insight-title {
    font-weight: 700;
    color: #ad1457;
    margin-bottom: 8px;
    font-size: 15px;
}
.trend-insight-box .insight-content {
    color: #880e4f;
    font-size: 14px;
}

/* 主觀權重說明 */
.subjective-note { background: #f5f5f5; padding: 12px; border-radius: 6px; font-size: 14px; color: #444; margin-bottom: 12px; border: 1px solid #ddd; line-height: 1.6; }

/* Footer 版權宣告 */
.site-footer {
    margin-top: 30px;
    padding: 20px;
    background: rgba(255,255,255,0.95);
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.footer-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.visitor-count {
    font-size: 13px;
    color: #666;
    display: flex;
    align-items: center;
    gap: 5px;
}
.copyright {
    font-size: 12px;
    color: #888;
    line-height: 1.6;
}

.stats-header { font-size: 13px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 14px; color: #333; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.stat-label { color: #555; font-weight: 500; }
.stat-value { font-weight: bold; color: #333; }

/* v3.54 市場供給分析區塊 */
.supply-analysis {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 2px solid #ffc107;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.supply-header {
    font-size: 15px;
    font-weight: bold;
    color: #e65100;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.supply-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    min-width: 450px;
}
.supply-table th {
    background: #ff9800;
    color: white;
    padding: 10px 4px;
    font-weight: 600;
    text-align: center;
    font-size: 13px;
    white-space: nowrap;
}
.supply-table td {
    padding: 10px 4px;
    text-align: center;
    border-bottom: 1px solid #f0f0f0;
    font-weight: 500;
    font-size: 14px;
}
.supply-table tr:hover {
    background: #f5f5f5;
}
.supply-table .period-cell {
    font-weight: 700;
    color: #e65100;
    text-align: left;
    padding-left: 6px;
}
.supply-table .highlight-row {
    background: #ffebee !important;
}
.supply-table .highlight-row td {
    color: #c62828;
}
.supply-table .current-row {
    background: #e3f2fd !important;
}
.supply-table .val-high { color: #d32f2f; font-weight: 900; }
.supply-table .val-low { color: #2e7d32; font-weight: 700; }
.supply-table .val-warn { color: #ff6f00; font-weight: 700; }

.supply-warning {
    margin-top: 10px;
    padding: 10px;
    background: #ffebee;
    border-left: 4px solid #f44336;
    border-radius: 4px;
    font-size: 12px;
    color: #c62828;
    line-height: 1.5;
}
.supply-note {
    margin-top: 8px;
    font-size: 11px;
    color: #666;
    line-height: 1.4;
}

/* v3.55 年度績效排行區塊 */
.ranking-section {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border: 2px solid #4CAF50;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.ranking-header {
    font-size: 15px;
    font-weight: bold;
    color: #2e7d32;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.ranking-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.ranking-tab {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #a5d6a7;
    color: #1b5e20;
}
.ranking-tab:hover {
    background: #81c784;
}
.ranking-tab.active {
    background: #2e7d32;
    color: white;
}
.ranking-content {
    display: none;
}
.ranking-content.active {
    display: block;
}
.ranking-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.ranking-box {
    background: white;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #c8e6c9;
}
.ranking-box.top {
    border-left: 4px solid #4CAF50;
}
.ranking-box.bottom {
    border-left: 4px solid #f44336;
}
.ranking-box-title {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.ranking-box.top .ranking-box-title {
    color: #2e7d32;
}
.ranking-box.bottom .ranking-box-title {
    color: #c62828;
}
.ranking-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
.ranking-table th {
    background: #f8f9fa;
    color: #2e7d32;
    padding: 10px 6px;
    font-weight: 600;
    text-align: center;
    border-bottom: 2px solid #e0e0e0;
    font-size: 13px;
    white-space: nowrap;
}
.ranking-box.bottom .ranking-table th {
    background: #f8f9fa;
    color: #c62828;
}
.ranking-table td {
    padding: 10px 6px;
    text-align: center;
    border-bottom: 1px solid #f0f0f0;
    font-weight: 500;
    white-space: nowrap;
}
.ranking-table td:first-child {
    text-align: center;
    font-weight: 600;
}
.ranking-table td:nth-child(3) {
    text-align: left;
}
.ranking-table tr:hover {
    background: #f5f5f5;
}
.ranking-table .rank-num {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 900;
}
.ranking-box.top .rank-num {
    background: #c8e6c9;
    color: #2e7d32;
}
.ranking-box.bottom .rank-num {
    background: #ffcdd2;
    color: #c62828;
}
.ranking-type {
    font-size: 10px;
    padding: 3px 5px;
    border-radius: 3px;
}
.ranking-type.auction {
    background: #ff9800;
    color: white;
}
.ranking-type.inquiry {
    background: #9c27b0;
    color: white;
}
.ranking-box.top .val-gain {
    color: #2e7d32;
    font-weight: 700;
}
.ranking-box.bottom .val-gain {
    color: #c62828;
    font-weight: 700;
}
.val-amp {
    color: #1565c0;
    font-weight: 600;
}
.ranking-summary {
    margin-top: 12px;
    padding: 10px;
    background: #f1f8e9;
    border-radius: 6px;
    font-size: 13px;
    color: #558b2f;
    line-height: 1.6;
}

/* v3.56 月均成交績效區塊 */
.realperf-section {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #2196F3;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.realperf-header {
    font-size: 16px;
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.realperf-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}
.realperf-tab {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #90caf9;
    color: #0d47a1;
}
.realperf-tab:hover {
    background: #64b5f6;
}
.realperf-tab.active {
    background: #1565c0;
    color: white;
}
.realperf-stats {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
    margin-bottom: 12px;
}
@media (max-width: 500px) {
    .realperf-stats {
        grid-template-columns: repeat(3, 1fr);
    }
}
.realperf-stat-box {
    background: white;
    border-radius: 6px;
    padding: 10px 8px;
    text-align: center;
    border: 1px solid #90caf9;
}
.realperf-stat-box.highlight {
    border: 2px solid #1565c0;
}
.realperf-stat-label {
    font-size: 12px;
    color: #555;
    margin-bottom: 4px;
}
.realperf-stat-value {
    font-size: 17px;
    font-weight: 900;
}
.realperf-stat-value.green { color: #2e7d32; }
.realperf-stat-value.blue { color: #1565c0; }
.realperf-stat-value.gray { color: #666; }
.realperf-stat-value.orange { color: #e65100; }
.realperf-stat-value.red { color: #c62828; }

.realperf-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.realperf-box {
    background: white;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #90caf9;
}
.realperf-box.top {
    border-left: 4px solid #2e7d32;
}
.realperf-box.bottom {
    border-left: 4px solid #c62828;
}
.realperf-box-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.realperf-box.top .realperf-box-title { color: #2e7d32; }
.realperf-box.bottom .realperf-box-title { color: #c62828; }

.realperf-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
.realperf-table th {
    background: #f8f9fa;
    color: #1565c0;
    padding: 10px 6px;
    font-weight: 600;
    text-align: center;
    border-bottom: 2px solid #e0e0e0;
    font-size: 13px;
}
.realperf-box.top .realperf-table th { background: #f8f9fa; color: #2e7d32; }
.realperf-box.bottom .realperf-table th { background: #f8f9fa; color: #c62828; }
.realperf-table td {
    padding: 10px 6px;
    text-align: center;
    border-bottom: 1px solid #f0f0f0;
    font-weight: 500;
    font-size: 13px;
}
.realperf-table tr:hover {
    background: #f5f5f5;
}
.realperf-table td:nth-child(2) {
    text-align: left;
    max-width: 70px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.realperf-pos {
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 13px;
}
.realperf-pos.high { background: #ffcdd2; color: #c62828; }
.realperf-pos.low { background: #c8e6c9; color: #2e7d32; }

.realperf-summary {
    margin-top: 12px;
    padding: 14px;
    background: #e1f5fe;
    border-radius: 6px;
    font-size: 15px;
    color: #0277bd;
    line-height: 1.7;
}

/* v3.59 新增：競拍盈虧勝率分析 */
.profitloss-section {
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
    border: 2px solid #e91e63;
    border-radius: 12px;
    padding: 12px;
    margin-top: 15px;
}
.profitloss-header {
    font-size: 16px;
    font-weight: bold;
    color: #ad1457;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.profitloss-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}
.profitloss-tab {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    background: #f48fb1;
    color: #880e4f;
}
.profitloss-tab:hover {
    background: #f06292;
}
.profitloss-tab.active {
    background: #c2185b;
    color: white;
}
.profitloss-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}
@media (max-width: 500px) {
    .profitloss-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
.profitloss-stat-box {
    background: white;
    border-radius: 8px;
    padding: 12px 10px;
    text-align: center;
    border: 1px solid #f48fb1;
}
.profitloss-stat-label {
    font-size: 12px;
    color: #555;
    margin-bottom: 5px;
}
.profitloss-stat-value {
    font-size: 18px;
    font-weight: 900;
}
.profitloss-stat-value.win { color: #c62828; }
.profitloss-stat-value.lose { color: #2e7d32; }
.profitloss-stat-value.neutral { color: #1565c0; }
.profitloss-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    margin-top: 10px;
    min-width: 450px;
}
.profitloss-table th {
    background: #c2185b;
    color: white;
    padding: 10px 4px;
    font-weight: 600;
    text-align: center;
    font-size: 13px;
    white-space: nowrap;
}
.profitloss-table td {
    padding: 10px 4px;
    text-align: center;
    border-bottom: 1px solid #f0f0f0;
    font-weight: 500;
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
}
.profitloss-table tr:hover {
    background: #f5f5f5;
}
.profitloss-table .year-cell {
    font-weight: 700;
    color: #ad1457;
}
.profitloss-table .val-win { color: #c62828; font-weight: 700; }
.profitloss-table .val-lose { color: #2e7d32; font-weight: 700; }
.profitloss-insight {
    margin-top: 10px;
    padding: 12px;
    background: white;
    border-left: 4px solid #e91e63;
    border-radius: 0 8px 8px 0;
    font-size: 14px;
    line-height: 1.7;
    color: #880e4f;
}


.calculate-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-top: 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }

.result-panel { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); min-height: 600px; border: 2px solid rgba(102, 126, 234, 0.3); border-left: 6px solid #667eea; font-size: 15px; }
.welcome-message { text-align: center; padding: 50px 20px; }
.welcome-message h2 { font-size: 26px; margin-bottom: 15px; }
.welcome-message p { font-size: 16px !important; line-height: 1.8; }
.stats-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
.stat-box { background: #f8f9fa; padding: 12px 15px; border-radius: 8px; text-align: center; border: 1px solid #eee; transition: transform 0.3s; }
.stat-box:hover { transform: translateY(-3px); border-color: #b39ddb; }
.stat-box .number { font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 4px; }
.stat-box .label { font-size: 12px; color: #666; }

.evaluation-result { display: none; }
.evaluation-result.active { display: block; animation: fadeIn 0.5s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
.detail-section { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 2px solid #e0e0e0; }
.detail-section h3 { color: #667eea; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 20px; transition: transform 0.3s; }
.strategy-card:hover { transform: translateY(-5px); }
.strategy-card h4 { font-size: 16px; margin-bottom: 10px; }
.strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
.strategy-card.conservative h4 { color: #2e7d32; }
.strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
.strategy-card.balanced h4 { color: #e65100; }
.strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
.strategy-card.aggressive h4 { color: #c62828; }
.strategy-card.ultimate { border-color: #9C27B0; background: #f3e5f5; }
.strategy-card.ultimate h4 { color: #6a1b9a; }
.strategy-card .price { font-size: 28px; font-weight: bold; margin: 8px 0; color: #333; }

/* 表格 */
.data-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
.data-table th { background-color: #1A237E; color: white; padding: 12px 6px; text-align: center; font-weight: 900; border: 1px solid #0d1b5e; vertical-align: bottom; line-height: 1.3; }
.data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #000; font-weight: 600; }
.data-table td:nth-child(n+3) { text-align: right; font-family: 'Segoe UI', monospace; }
.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tr:hover { background-color: #e8eaf6; }
.data-table tfoot td { background-color: #e8eaf6; font-weight: 900; color: #1A237E; border-top: 2px solid #3f51b5; }

.rex-analysis { background: linear-gradient(to right, #fff3e0, #ffe0b2); border-left: 6px solid #ff9800; padding: 22px; border-radius: 8px; margin-top: 25px; }
.rex-title { font-size: 20px; font-weight: bold; color: #e65100; margin-bottom: 14px; }
.rex-content { color: #5d4037; line-height: 1.9; font-size: 15px; }

@media (max-width: 1200px) {
    .evaluation-container { grid-template-columns: 1fr !important; display: block; }
    .resizer { display: none; }
    .input-panel { position: relative; top: 0; max-height: none !important; overflow-y: visible !important; height: auto !important; }
}

@media (max-width: 768px) {
    body { padding: 8px; }
    .container { width: 100%; max-width: 100%; padding: 0; margin: 0; }
    .header { padding: 15px; margin-bottom: 10px; border-radius: 12px; }
    .header h1 { font-size: 22px; margin-bottom: 8px; }
    .header .subtitle { font-size: 12px; line-height: 1.4; }
    .version-badge { font-size: 11px; padding: 4px 10px; margin: 6px 0 10px 0; }
    .evaluation-container { display: block; }
    .input-panel { padding: 15px; border-radius: 12px; }
    .result-panel { padding: 15px; border-radius: 12px; margin-top: 10px; }
    .supply-analysis, .ranking-section, .realperf-section, .profitloss-section, .market-trend-section { padding: 10px; margin-top: 10px; }
    
    /* v3.97-el: 表格優化 */
    table { font-size: 12px; }
    th, td { padding: 6px 4px; }
    
    /* v3.97-el: 圖表高度調整 */
    canvas { max-height: 250px !important; }
}

@media (max-width: 500px) {
    body { padding: 6px; }
    .header { padding: 14px; margin-bottom: 8px; border-radius: 10px; }
    .header h1 { font-size: 20px; margin-bottom: 6px; }
    .header .subtitle { font-size: 11px; }
    .version-badge { font-size: 10px; padding: 3px 8px; margin: 5px 0 8px 0; }
    .input-panel { padding: 12px; border-radius: 10px; }
    .result-panel { padding: 12px; border-radius: 10px; }
    .history-info-line { gap: 2px 8px; }
    .history-bid-row { flex-direction: column; gap: 6px; }
    .supply-analysis, .ranking-section, .realperf-section, .profitloss-section, .market-trend-section { padding: 8px; }

    /* v3.97-el: 手機版字體和間距優化 */
    .form-group { margin-bottom: 8px; }
    .form-group label { font-size: 11px; margin-bottom: 3px; }
    .form-group input, .form-group select { padding: 8px; font-size: 13px; }
    
    /* v3.97-el: 統計方塊手機版優化 */
    .stat-box { padding: 8px 6px; }
    .stat-box .number { font-size: 18px; }
    .stat-box .label { font-size: 10px; }

    /* v3.97 讓三個分析區塊對齊上方按鈕 */
    .right-section {
        margin-left: -12px;
        margin-right: -12px;
    }
    .right-section-content {
        padding: 10px;
    }
    .right-section-header {
        padding: 10px 12px;
        font-size: 14px;
    }
    .right-section-header span:first-child {
        font-size: 16px !important;
    }

    /* v3.97d 手機版表格橫向滾動 */
    .ranking-box {
        padding: 6px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .ranking-table {
        min-width: 480px;
        font-size: 11px;
    }
    .ranking-table th,
    .ranking-table td {
        padding: 5px 2px;
    }

    /* v3.97d 月均成交績效表格也要橫向滾動 */
    .realperf-section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .realperf-section table {
        min-width: 450px;
    }

    /* v3.97-zs-bt: 手機版三欄 grid 改為雙欄 */
    .balance-grid-3col {
        grid-template-columns: 1fr 1fr !important;
        gap: 6px !important;
    }
    .balance-grid-3col > div:nth-child(3) {
        grid-column: 1 / -1;  /* 第三個佔滿整行 */
    }
    .balance-number {
        font-size: 15px !important;
    }

    /* v3.97-dk: 套利追蹤按鈕 */
    .arb-filter-tab {
        padding: 5px 10px !important;
        font-size: 11px !important;
    }
    .arb-period-btn {
        padding: 4px 8px !important;
        font-size: 10px !important;
    }
    
    /* v3.97-el: 市場趨勢標籤按鈕 */
    .market-trend-tabs {
        gap: 4px !important;
        flex-wrap: wrap !important;
    }
    .market-trend-tab {
        padding: 6px 8px !important;
        font-size: 11px !important;
        flex: 0 0 auto !important;
    }
    
    /* v3.97-el: 供給分析標籤 */
    #supplyTab-pending, #supplyTab-board {
        padding: 8px 6px !important;
        font-size: 11px !important;
    }
    
    /* v3.97-el: 表格字體縮小 */
    .supply-table {
        font-size: 11px !important;
    }
    .supply-table th, .supply-table td {
        padding: 6px 3px !important;
    }
    
    /* v3.97-el: Step報告手機版優化 */
    .step-section {
        padding: 10px !important;
        margin-bottom: 10px !important;
    }
    
    /* v3.97-el: 歡迎訊息 */
    .welcome-message { padding: 30px 15px; }
    .welcome-message h2 { font-size: 20px; }
    .welcome-message p { font-size: 12px !important; }
    
    /* v3.97-el: 統計摘要改為單欄 */
    .stats-summary {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 6px !important;
    }
}

/* v3.97-dk: 套利追蹤區間按鈕樣式 */
.arb-period-btn {
    padding: 6px 14px;
    border: 1px solid #9c27b0;
    border-radius: 6px;
    background: white;
    color: #7b1fa2;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

/* v3.97-el: 超小螢幕優化（400px以下） */
@media (max-width: 400px) {
    body { padding: 4px; }
    .header { padding: 10px; }
    .header h1 { font-size: 18px; }
    .header .subtitle { font-size: 10px; }
    .input-panel, .result-panel { padding: 10px; }
    
    /* 表單更緊湊 */
    .form-group { margin-bottom: 6px; }
    .form-group label { font-size: 10px; }
    .form-group input, .form-group select { padding: 6px; font-size: 12px; }
    
    /* 統計方塊單欄顯示 */
    .stats-summary {
        grid-template-columns: 1fr !important;
    }
    
    /* 標籤按鈕更小 */
    .market-trend-tab, .ranking-tab, .realperf-tab, .profitloss-tab {
        padding: 5px 6px !important;
        font-size: 10px !important;
    }
    
    /* 供給分析標籤 */
    #supplyTab-pending, #supplyTab-board {
        padding: 6px 4px !important;
        font-size: 10px !important;
    }
    
    /* 套利追蹤 */
    .arb-filter-tab {
        padding: 4px 8px !important;
        font-size: 10px !important;
    }
    
    /* 右側區塊標題 */
    .right-section-header {
        padding: 8px 10px;
        font-size: 13px;
    }
}
.arb-period-btn:hover {
    background: #f3e5f5;
}
.arb-period-btn.active {
    background: #9c27b0;
    color: white;
}

/* 熱門榜表格可排序標頭 */
.arb-sortable {
    cursor: pointer;
    user-select: none;
}
.arb-sortable:hover {
    background: #e8e8e8 !important;
}

@media (max-width: 768px) {
    /* 主力模擬出價 grid */
    .mp-strategy-grid {
        grid-template-columns: 1fr 1fr !important;
    }

    /* 統計摘要 */
    .stats-summary {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 8px !important;
    }

    /* 防止內容溢出 */
    .right-section-content {
        overflow-x: hidden !important;
    }
    .right-section-content > div {
        max-width: 100% !important;
        overflow-x: auto !important;
    }
    
    /* v3.97-el: 基本資料標籤按鈕 */
    .basic-info-tabs {
        flex-wrap: wrap !important;
        gap: 4px !important;
    }
    .basic-info-tab {
        padding: 6px 10px !important;
        font-size: 11px !important;
    }
    
    /* v3.97-el: 套利追蹤區塊 */
    #arbitrageSection select {
        font-size: 12px !important;
    }
}

/* ================= v3.72 主力模擬出價面板 ================= */
.major-player-panel {
    border: 2px solid #6a1b9a;
    border-radius: 12px;
    margin-top: 20px;
    overflow: hidden;
}
.major-player-header {
    background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);
    color: white;
    padding: 12px 18px;
    font-size: 16px;
    font-weight: bold;
}
.major-player-content {
    padding: 18px;
    background: linear-gradient(135deg, #fafafa 0%, #f3e5f5 100%);
}
.major-player-main {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}
.major-player-gauge {
    flex: 0 0 140px;
    text-align: center;
}
.major-player-gauge .gauge-value {
    font-size: 42px;
    font-weight: bold;
    color: #6a1b9a;
}
.major-player-gauge .gauge-label {
    font-size: 12px;
    color: #666;
}
.major-player-strategies {
    flex: 1;
    min-width: 280px;
}
.mp-strategy-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}
.mp-strategy-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    border: 2px solid #e0e0e0;
    transition: all 0.2s;
}
.mp-strategy-card:hover {
    border-color: #9c27b0;
    box-shadow: 0 3px 10px rgba(156, 39, 176, 0.2);
}
.mp-strategy-card.sniper { border-left: 4px solid #f44336; }
.mp-strategy-card.stable { border-left: 4px solid #4caf50; }
.mp-strategy-card.safe { border-left: 4px solid #2196f3; }
.mp-strategy-card h5 {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
}
.mp-strategy-card .mp-price {
    font-size: 22px;
    font-weight: bold;
    color: #333;
}
.mp-strategy-card .mp-rate {
    font-size: 11px;
    color: #999;
    margin-top: 3px;
}
.mp-confidence-bar {
    margin-top: 12px;
    padding: 10px 12px;
    border-radius: 6px;
}
.mp-confidence-bar.high { background: #e8f5e9; border-left: 4px solid #4caf50; }
.mp-confidence-bar.medium { background: #fff3e0; border-left: 4px solid #ff9800; }
.mp-confidence-bar.low { background: #ffebee; border-left: 4px solid #f44336; }
.mp-adjustments {
    margin-top: 15px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}
.mp-adjustments-title {
    font-size: 13px;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
}
.mp-adj-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.mp-adj-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 12px;
    background: #f5f5f5;
}
.mp-adj-item.positive { background: #e8f5e9; color: #2e7d32; }
.mp-adj-item.negative { background: #ffebee; color: #c62828; }
.mp-adj-item.neutral { background: #f5f5f5; color: #666; }
.mp-win-rate-calc {
    margin-top: 15px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}
.mp-win-rate-input {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}
.mp-win-rate-input input {
    width: 100px;
    padding: 8px;
    border: 2px solid #9c27b0;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
}
.mp-win-rate-result {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
}
</style>

</head>

<body>
<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 22px; font-weight: bold;">
    <div>🔄 系統啟動中 (v3.97-cw 台股熱門交易版)...</div>
    <div id="loading-detail" style="font-size: 15px; margin-top: 10px; font-weight: normal; opacity: 0.9;">正在整合競拍資料庫...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>🤖 AI智能可轉債競拍系統</h1>
        <span class="version-badge">v3.97-cw 台股熱門交易版</span>
        <div class="subtitle">
            <span>Rex大叔的168台股投資教室</span>
            <span style="color:#ddd">|</span>
            <span id="headerSubtitle">載入中...</span>
            <span style="color:#ddd">|</span>
            <span id="aiCoreStatus" style="color:#4caf50; font-weight:bold;">🧠 AI核心載入中...</span>
        </div>
    </div>

<div class="evaluation-container">
    <div class="input-panel" id="inputPanel">

```
<!-- ========== 第一區塊：競拍條件輸入 ========== -->
<div class="panel-section" style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border: 2px solid #667eea; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
    <div class="section-header" style="display:flex; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #667eea;">
        <span style="font-size:20px; margin-right:8px;">📋</span>
        <span style="font-size:16px; font-weight:bold; color:#667eea;">一、競拍條件輸入</span>
        <span style="font-size:11px; color:#666; margin-left:auto;">填寫標的資料</span>
    </div>

<form id="evaluationForm">
    <!-- ⚡ 閃電帶入 -->
    <div class="form-section" style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
        <h3 style="color: #f57c00; border-left-color: #ff9800;">⚡ 閃電帶入</h3>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="color: #e65100;">選擇案件，自動帶入所有條件</label>
            <select id="quickSelect" style="border: 2px solid #ffc107; font-weight: bold;">
                <option value="">-- 請選擇案件 --</option>
                <optgroup label="🔥 即將競拍（有時程且未完成）" id="upcomingAuctionGroup"></optgroup>
                <optgroup label="📋 即將詢圈（有時程且未完成）" id="upcomingInquiryGroup"></optgroup>
                <optgroup label="⏳ 承銷中-競拍（尚未確定時程）" id="pendingAuctionGroup"></optgroup>
                <optgroup label="⏳ 承銷中-詢圈（尚未確定時程）" id="pendingInquiryGroup"></optgroup>
                <optgroup label="✅ 近期完成競拍（1-3個月參考）" id="recentAuctionGroup"></optgroup>
                <optgroup label="✅ 近期完成詢圈（1-3個月參考）" id="recentInquiryGroup"></optgroup>
            </select>
        </div>
        <div id="quickSelectInfo" style="display:none; background:#fff; padding:10px; border-radius:6px; margin-top:8px; font-size:13px; border-left:4px solid #ff9800;"></div>
        <div id="modelCompareResult" style="display:none; background:#e8f5e9; padding:10px; border-radius:6px; margin-top:8px; font-size:13px; border-left:4px solid #4caf50;"></div>
        <div style="font-size:12px; color:#795548; margin-top:8px;">
            💡 選擇後自動帶入條件，競拍案件請於截標日13:30前確認收盤價
        </div>
    </div>

    <!-- 📌 基本資料 -->
    <div class="form-section">
        <h3>📌 基本資料</h3>
        <div class="form-group">
            <label>CB名稱 / 代號 *</label>
            <input type="text" id="cbName" placeholder="輸入代號(如2383)或名稱搜尋歷史">
            <div id="historyResults" class="history-results"></div>
            <div id="cbNameInfo" class="info-box"></div>
        </div>
        <div class="form-group"><label>股本區間 *</label><select id="capital"><option value="">請選擇...</option><option value="小於3億">小於3億</option><option value="3~6億">3~6億</option><option value="6~10億">6~10億</option><option value="10~15億">10~15億</option><option value="15~20億">15~20億</option><option value="大於20億">大於20億</option></select><div id="capitalInfo" class="info-box"></div></div>
        <div class="form-group"><label>產業分類 *</label><select id="industry"><option value="">載入中...</option></select><div id="industryInfo" class="info-box"></div><div id="industryTip300" class="tip-300" style="display:none;"></div></div>
        <div class="form-group"><label>發行券商</label><select id="broker"><option value="">載入中...</option></select><div id="brokerInfo" class="info-box"></div><div id="brokerTip300" class="tip-300" style="display:none;"></div></div>
    </div>

    <!-- 💰 發行條件 -->
    <div class="form-section">
        <h3>💰 發行條件</h3>
        <div class="form-group"><label>發行規模區間 *</label><select id="issueSize"><option value="">請選擇...</option><option value="小於2億">小於2億</option><option value="2~5億">2~5億</option><option value="5~10億">5~10億</option><option value="10~15億">10~15億</option><option value="15~20億">15~20億</option><option value="大於20億">大於20億</option></select><div id="issueSizeInfo" class="info-box"></div><div id="issueSizeTip300" class="tip-300" style="display:none;"></div></div>
        <div class="form-group">
            <label>理論價區間 * <span id="theoRangeMode" style="font-size:11px; color:#1976d2; font-weight:normal;">（輸入股價/轉換價後自動計算）</span></label>
            <select id="theoRange"><option value="">請選擇或由下方自動計算...</option><option value="小於90元">小於90元</option><option value="90~95元">90~95元</option><option value="95~100元">95~100元</option><option value="100~105元">100~105元</option><option value="105~110元">105~110元</option><option value="110~115元">110~115元</option><option value="大於115元">大於115元</option></select>
            <div id="theoRangeInfo" class="info-box"></div>
            <div id="theoRangeTip300" class="tip-300" style="display:none;"></div>
            <div id="theoAutoCalcInfo" style="display:none; background:#e3f2fd; padding:8px 12px; border-radius:6px; margin-top:5px; font-size:12px;">
                <span style="color:#1565c0;">✅ 已自動計算：理論價 <b id="theoAutoValue">0</b> 元 → 區間 <b id="theoAutoRange">-</b></span>
            </div>
        </div>
        <div class="form-group"><label>發行年期 *</label><select id="years"><option value="">請選擇...</option><option value="3">3年期</option><option value="5">5年期</option><option value="7">7年期</option></select><div id="yearsInfo" class="info-box"></div><div id="yearsTip300" class="tip-300" style="display:none;"></div></div>
        <div class="form-group"><label>擔保情況 *</label><select id="guarantee" onchange="updateAtmospherePanel(); updateMarketSentiment();"><option value="">請選擇...</option><option value="有擔保">有擔保</option><option value="無擔保">無擔保</option></select><div id="guaranteeInfo" class="info-box"></div><div id="guaranteeTip300" class="tip-300" style="display:none;"></div></div>
        <div class="form-group"><label>信用評等 (TCRI) *</label><select id="rating"><option value="">請選擇...</option><option value="1">TCRI 1</option><option value="2">TCRI 2</option><option value="3">TCRI 3</option><option value="4">TCRI 4</option><option value="5">TCRI 5</option><option value="6">TCRI 6</option><option value="7">TCRI 7</option><option value="8">TCRI 8</option></select><div id="ratingInfo" class="info-box"></div><div id="ratingTip300" class="tip-300" style="display:none;"></div></div>
    </div>

    <!-- 🎯 競拍資料 -->
    <div class="form-section">
        <h3>🎯 競拍資料</h3>
        <div class="form-group">
            <label>競拍截止日1:30收盤價格 (元) *</label>
            <input type="number" id="stockPrice" step="0.01" placeholder="例如：461.5">
        </div>
        <div class="form-group">
            <label>實際轉換價格 (元) *</label>
            <input type="number" id="actualConversionPrice" step="0.01" placeholder="例如：450">
        </div>
        <div class="form-group">
            <label>底標價格 (元)</label>
            <input type="number" id="floorPrice" step="0.1" value="100" placeholder="預設：100">
            <div class="warning-box">⚠️ 理論價格隨股價變動，建議於 13:30 截標前再進行最終試算</div>
        </div>
    </div>

    <!-- ⚖️ 主觀權重 -->
    <details style="margin-top:10px;">
        <summary style="cursor:pointer; font-size:13px; color:#e65100; font-weight:bold; padding:8px; background:#fff9e6; border-radius:6px;">
            ⚖️ 主觀權重（選填，點擊展開）
        </summary>
        <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 1px solid #ff9800; border-radius: 8px; padding: 12px; margin-top:8px;">
            <div class="subjective-note" style="font-size:11px; color:#666; margin-bottom:10px;">
                💡 預設為 0 表示完全依據歷史數據；若您有獨到見解，可調整此處注入主觀判斷。
            </div>
            <div class="form-group"><label>主觀權重 (%)</label><input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0"></div>
            <div class="form-group"><label>主觀最低溢價 (%)</label><input type="number" id="subjectiveLowPremium" step="0.1" value="0"></div>
            <div class="form-group"><label>主觀平均溢價 (%)</label><input type="number" id="subjectiveAvgPremium" step="0.1" value="0"></div>
        </div>
    </details>

</div><!-- 第一區塊結束 -->

<!-- ========== 第二區塊：AI智能評估（v3.97e 預設隱藏，按下按鈕後在結果區顯示） ========== -->
<div id="inputAISection" class="panel-section" style="display:none; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 2px solid #9c27b0; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
    <div class="section-header" style="display:flex; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #9c27b0;">
        <span style="font-size:20px; margin-right:8px;">🤖</span>
        <span style="font-size:16px; font-weight:bold; color:#7b1fa2;">二、AI智能評估</span>
        <span style="font-size:11px; color:#666; margin-left:auto;">即時計算建議出價</span>
    </div>

    <!-- 🎯 主力模擬出價 -->
    <div class="form-section" style="background: white; border: 1px solid #ce93d8; border-radius: 10px; padding: 12px; margin-bottom: 12px;">
        <div style="font-size:13px; font-weight:bold; color:#6a1b9a; margin-bottom:8px;">🎯 主力模擬出價</div>
        <div style="font-size:11px; color:#666; margin-bottom:8px;">
            💡 基於75檔CB得標明細，根據您的條件動態調整<br>
            📊 核心發現：94%情況下，主力最低出價與最低得標差距 <0.5元
        </div>
        <div id="majorPlayerSimulation">
            <!-- v3.90 改為動態載入，不寫死數據 -->
            <div style="background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color:white; padding:12px; border-radius:8px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:6px;">📍 歷史數據 → 整體主力出價區間</div>
                <div style="display:flex; justify-content:space-around; align-items:center;">
                    <div style="text-align:center;">
                        <div style="font-size:10px; opacity:0.8;">主力最低出價</div>
                        <div style="font-size:22px; font-weight:bold;" id="initMajorLow">載入中...</div>
                    </div>
                    <div style="font-size:20px; opacity:0.5;">~</div>
                    <div style="text-align:center;">
                        <div style="font-size:10px; opacity:0.8;">主力最高出價</div>
                        <div style="font-size:22px; font-weight:bold;" id="initMajorHigh">載入中...</div>
                    </div>
                </div>
                <div style="margin-top:8px; font-size:10px; opacity:0.8; text-align:center;">
                    選擇條件後自動更新為您的專屬建議
                </div>
            </div>
        </div>
    </div>

    <!-- 🎯 AI智能預測 -->
    <div class="form-section" style="background: white; border: 1px solid #ce93d8; border-radius: 10px; padding: 12px; margin-bottom: 12px;">
        <div style="font-size:13px; font-weight:bold; color:#667eea; margin-bottom:8px;">📊 AI預測結果</div>
        <div style="font-size:11px; color:#666; margin-bottom:8px;">
            💡 基於<span id="auctionCountLabel">--</span>檔競拍統計，即時預估投標倍數與建議出價
        </div>
        <div id="liveAIPrediction">
            <!-- v3.90 改為動態載入，不寫死數據 -->
            <div style="background:linear-gradient(135deg, #667eea 0%, #5567d8 100%); color:white; padding:12px; border-radius:8px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:6px;">📍 歷史數據 → 整體市場預測</div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; text-align:center;">
                    <div>
                        <div style="font-size:10px; opacity:0.8;">平均投標倍數</div>
                        <div style="font-size:18px; font-weight:bold;" id="initAvgMult">載入中...</div>
                    </div>
                    <div>
                        <div style="font-size:10px; opacity:0.8;">平均最低得標</div>
                        <div style="font-size:18px; font-weight:bold;" id="initAvgMinBid">載入中...</div>
                    </div>
                    <div>
                        <div style="font-size:10px; opacity:0.8;">平均得標均價</div>
                        <div style="font-size:18px; font-weight:bold;" id="initAvgBid">載入中...</div>
                    </div>
                </div>
                <div style="margin-top:8px; font-size:10px; opacity:0.8; text-align:center;">
                    選擇條件後自動更新為您的專屬預測
                </div>
            </div>
        </div>
    </div>

    <!-- 📋 競拍前綜合評估 -->
    <div class="form-section" style="background: white; border: 1px solid #ce93d8; border-radius: 10px; padding: 12px;">
        <div style="font-size:13px; font-weight:bold; color:#0d47a1; margin-bottom:8px;">📋 競拍前綜合評估</div>
        <div style="font-size:11px; color:#666; margin-bottom:8px;">
            💡 基於歷史競拍數據，綜合評估是否值得參與
        </div>
        <div id="auctionEvaluation">
            <!-- v3.90 改為動態載入，不寫死數據 -->
            <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:white; padding:12px; border-radius:8px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:6px;">📍 歷史數據 → 整體參與建議</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; text-align:center;">
                    <div>
                        <div style="font-size:10px; opacity:0.8;">整體得標率</div>
                        <div style="font-size:20px; font-weight:bold;" id="initWinRate">載入中...</div>
                        <div style="font-size:9px; opacity:0.7;" id="initWinRateNote">-</div>
                    </div>
                    <div>
                        <div style="font-size:10px; opacity:0.8;">平均首日報酬</div>
                        <div style="font-size:20px; font-weight:bold;" id="initFirstDayReturn">載入中...</div>
                        <div style="font-size:9px; opacity:0.7;">掛牌日收盤vs得標價</div>
                    </div>
                </div>
                <div style="margin-top:10px; padding:8px; background:rgba(255,255,255,0.15); border-radius:6px; font-size:11px;">
                    <div style="margin-bottom:4px;">📌 <b>合理出價區間：<span id="initPriceRange">載入中...</span></b></div>
                    <div style="opacity:0.9;">此區間為歷史平均最低得標~加權均價，得標機率較高</div>
                </div>
                <div style="margin-top:6px; font-size:10px; opacity:0.8; text-align:center;">
                    選擇條件後自動更新為您的專屬評估
                </div>
            </div>
        </div>
    </div>
</div><!-- 第二區塊結束 -->

<!-- ========== 第三區塊：市場溫度計（v3.97e 預設隱藏，按下按鈕後在結果區顯示） ========== -->
<div id="inputMarketSection" class="panel-section" style="display:none; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
    <div class="section-header" style="display:flex; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #4caf50;">
        <span style="font-size:20px; margin-right:8px;">🌡️</span>
        <span style="font-size:16px; font-weight:bold; color:#2e7d32;">三、市場溫度計</span>
        <span style="font-size:11px; color:#666; margin-left:auto;">近期市場熱度參考</span>
    </div>

    <!-- 📡 即時市場動能 -->
    <div class="form-section" style="background: white; border: 1px solid #81c784; border-radius: 10px; padding: 12px; margin-bottom: 12px;">
        <div style="font-size:13px; font-weight:bold; color:#c2185b; margin-bottom:8px;">📡 即時市場動能（近10檔開標）</div>
        <div id="marketMomentumResult">
            <div style="color:#666; padding:10px; text-align:center; font-size:12px;">⏳ 載入中...</div>
        </div>
        <details style="margin-top:8px;">
            <summary style="cursor:pointer; font-size:11px; color:#2e7d32; font-weight:bold;">📋 查看近期開標明細</summary>
            <div id="recentAuctionDetails" style="margin-top:8px; max-height:200px; overflow-y:auto; font-size:11px;"></div>
        </details>
    </div>

    <!-- 🌡️ 市場氛圍儀表板 -->
    <div id="atmospherePanel" class="form-section" style="display:none; background: white; border: 1px solid #81c784; border-radius: 10px; padding: 12px; margin-bottom: 12px;">
        <div style="font-size:13px; font-weight:bold; color:#2e7d32; margin-bottom:8px;">🌡️ 市場氛圍儀表板</div>
        <div id="atmosphereContent" style="font-size: 12px;">載入中...</div>
    </div>

    <!-- 📊 近期市場氛圍 -->
    <div class="form-section" style="background: white; border: 1px solid #81c784; border-radius: 10px; padding: 12px;">
        <div style="font-size:13px; font-weight:bold; color:#1565c0; margin-bottom:8px;">📊 同條件歷史統計</div>
        <div style="font-size:10px; color:#666; margin-bottom:8px;">
            ⚠️ 需填寫條件才能計算<br>
            五維度權重：產業35%+券商25%+信評20%+規模10%+理論價10%
        </div>
        <div id="marketSentiment" class="info-box" style="display: block; background:#f5f5f5; border-left: 4px solid #2196F3; padding:10px; font-size:12px;">
            <div class="stat-row" style="color:#e65100;">⚠️ 請先填寫：產業、發行規模、信評</div>
        </div>
    </div>
</div><!-- 第三區塊結束 -->

<!-- 開始評估按鈕 - 確保在手機上可見 -->
<div style="margin-top:20px; padding-bottom:20px;">
    <button type="submit" class="calculate-btn" style="display:block !important; visibility:visible !important;">🎯 開始AI評估</button>
</div>
</form>
```

</div><!-- input-panel結束 -->

<div class="resizer" id="resizer"></div>

<div class="result-panel" id="resultPanel">
    <!-- ========== v3.97j 步驟式AI評估報告（三階段分析） ========== -->
    <div id="stepReport" style="display:none;">

```
<!-- Step 1: 基礎數據分析（溢價率法/得標均價法 × 無加權/有加權） -->
<div class="step-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
    <div style="display:flex; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid #2196f3;">
        <span style="background:#2196f3; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">1</span>
        <span style="font-size:16px; font-weight:bold; color:#1565c0;">基礎數據分析</span>
        <span style="font-size:11px; color:#666; margin-left:auto;" id="step1MethodLabel">--</span>
    </div>
    <div id="step1Content">
        <!-- 理論價顯示 -->
        <div style="background:linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color:white; padding:12px; border-radius:10px; margin-bottom:12px;">
            <div style="display:flex; align-items:center; justify-content:center; gap:15px; flex-wrap:wrap;">
                <div style="text-align:center;">
                    <div style="font-size:10px; opacity:0.8;">截標日理論價</div>
                    <div style="font-size:22px; font-weight:bold;" id="step1TheoPrice">--</div>
                </div>
                <div style="font-size:18px; opacity:0.5;">→</div>
                <div style="text-align:center; background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:6px;">
                    <div style="font-size:10px; opacity:0.8;">系統採用</div>
                    <div style="font-size:14px; font-weight:bold;" id="step1MethodName">--</div>
                </div>
            </div>
            <div style="text-align:center; margin-top:8px; font-size:10px; opacity:0.8;">
                理論價≥97.5採用溢價率法，&lt;97.5採用得標均價法
            </div>
        </div>

        <!-- 標籤切換區 -->
        <div style="margin-bottom:12px;">
            <!-- 方法切換標籤 -->
            <div style="display:flex; gap:8px; margin-bottom:8px;">
                <button id="step1TabPremium" onclick="switchStep1Tab('premium')" 
                    style="flex:1; padding:10px; border:2px solid #1976d2; border-radius:8px; background:#1976d2; color:white; font-weight:bold; font-size:13px; cursor:pointer; transition:all 0.3s;">
                    📈 溢價率分析法
                </button>
                <button id="step1TabPrice" onclick="switchStep1Tab('price')" 
                    style="flex:1; padding:10px; border:2px solid #e65100; border-radius:8px; background:white; color:#e65100; font-weight:bold; font-size:13px; cursor:pointer; transition:all 0.3s;">
                    📊 得標均價法
                </button>
            </div>
            <!-- 加權切換標籤 -->
            <div style="display:flex; gap:8px;">
                <button id="step1TabNoWeight" onclick="switchStep1Weight('noweight')" 
                    style="flex:1; padding:8px; border:2px solid #666; border-radius:6px; background:#666; color:white; font-size:12px; cursor:pointer; transition:all 0.3s;">
                    📊 無加權（純歷史平均）
                </button>
                <button id="step1TabWeight" onclick="switchStep1Weight('weight')" 
                    style="flex:1; padding:8px; border:2px solid #7b1fa2; border-radius:6px; background:white; color:#7b1fa2; font-size:12px; cursor:pointer; transition:all 0.3s;">
                    ⚖️ 有加權（維度加權）
                </button>
            </div>
        </div>

        <!-- 溢價率法 - 無加權 -->
        <div id="step1PremiumNoWeight" class="step1-panel" style="display:block;">
            <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:white; padding:12px; border-radius:10px; margin-bottom:10px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">📈 溢價率分析法（無加權）</div>
                <div style="text-align:center; margin-bottom:6px;">
                    <div style="font-size:10px; opacity:0.8;">歷史平均溢價率</div>
                    <div style="font-size:18px; font-weight:bold;" id="step1PremNoWeightRate">--</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.2); padding:8px; border-radius:6px;">
                    <div style="font-size:10px; opacity:0.8;">建議區間</div>
                    <div style="font-size:16px; font-weight:bold;" id="step1PremNoWeightRange">--</div>
                </div>
            </div>
        </div>

        <!-- 溢價率法 - 有加權 -->
        <div id="step1PremiumWeight" class="step1-panel" style="display:none;">
            <div style="background:linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); color:white; padding:12px; border-radius:10px; margin-bottom:10px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">📈 溢價率分析法（有加權）</div>
                <div style="text-align:center; margin-bottom:6px;">
                    <div style="font-size:10px; opacity:0.8;">加權平均溢價率</div>
                    <div style="font-size:18px; font-weight:bold;" id="step1PremWeightRate">--</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.2); padding:8px; border-radius:6px;">
                    <div style="font-size:10px; opacity:0.8;">建議區間</div>
                    <div style="font-size:16px; font-weight:bold;" id="step1PremWeightRange">--</div>
                </div>
            </div>
        </div>

        <!-- 得標均價法 - 無加權 -->
        <div id="step1PriceNoWeight" class="step1-panel" style="display:none;">
            <div style="background:linear-gradient(135deg, #e65100 0%, #bf360c 100%); color:white; padding:12px; border-radius:10px; margin-bottom:10px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">📊 得標均價法（無加權）</div>
                <div style="text-align:center; margin-bottom:6px;">
                    <div style="font-size:10px; opacity:0.8;">歷史平均得標價 <span id="step1PriceNoWeightAdj" style="background:rgba(255,255,255,0.3); padding:1px 6px; border-radius:4px; font-size:9px;"></span></div>
                    <div style="font-size:18px; font-weight:bold;" id="step1PriceNoWeightRate">--</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.2); padding:8px; border-radius:6px;">
                    <div style="font-size:10px; opacity:0.8;">建議區間</div>
                    <div style="font-size:16px; font-weight:bold;" id="step1PriceNoWeightRange">--</div>
                </div>
            </div>
        </div>

        <!-- 得標均價法 - 有加權 -->
        <div id="step1PriceWeight" class="step1-panel" style="display:none;">
            <div style="background:linear-gradient(135deg, #c62828 0%, #b71c1c 100%); color:white; padding:12px; border-radius:10px; margin-bottom:10px;">
                <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">📊 得標均價法（有加權）</div>
                <div style="text-align:center; margin-bottom:6px;">
                    <div style="font-size:10px; opacity:0.8;">加權平均得標價 <span id="step1PriceWeightAdj" style="background:rgba(255,255,255,0.3); padding:1px 6px; border-radius:4px; font-size:9px;"></span></div>
                    <div style="font-size:18px; font-weight:bold;" id="step1PriceWeightRate">--</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.2); padding:8px; border-radius:6px;">
                    <div style="font-size:10px; opacity:0.8;">建議區間</div>
                    <div style="font-size:16px; font-weight:bold;" id="step1PriceWeightRange">--</div>
                </div>
                <!-- 調整說明 -->
                <div id="step1PriceAdjustmentNote" style="margin-top:8px; font-size:10px; opacity:0.9; text-align:center; background:rgba(255,255,255,0.15); padding:6px; border-radius:4px;"></div>
            </div>
        </div>

        <div style="text-align:center; font-size:11px; color:#1565c0; margin-bottom:10px;">
            💡 無加權為整體歷史平均，有加權考量產業、信評、規模、券商等維度<br>
            <span style="color:#e65100;">⚠️ 加權目的：避免單一標的異常值影響整體判斷</span>
        </div>

        <!-- 可收合的詳細分析 -->
        <details style="background:white; border-radius:8px; overflow:hidden;">
            <summary style="padding:12px; cursor:pointer; font-size:13px; font-weight:bold; color:#1565c0; background:#e3f2fd; display:flex; align-items:center; gap:8px;">
                <span>📊</span>
                <span>查看各維度加權明細</span>
                <span style="margin-left:auto; font-size:11px; color:#666; font-weight:normal;">點擊展開</span>
            </summary>
            <div style="padding:12px; font-size:12px;">
                <div id="step1DetailContent">載入中...</div>
            </div>
        </details>
    </div>
</div>

<!-- Step 2: 最強大腦分析法（四維度滾動加權）- 原Step 4 -->
<div class="step-section" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
    <div style="display:flex; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid #ff9800;">
        <span style="background:#ff9800; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">2</span>
        <span style="font-size:16px; font-weight:bold; color:#e65100;">🧠 最強大腦分析法</span>
        <span style="font-size:11px; color:#666; margin-left:auto;">四維度滾動加權分析</span>
    </div>
    <div id="step4Content">
        <!-- 篩選條件顯示 -->
        <div style="background:linear-gradient(135deg, #f57c00 0%, #e65100 100%); color:white; padding:12px; border-radius:10px; margin-bottom:12px;">
            <div style="font-size:11px; opacity:0.9; margin-bottom:8px; text-align:center;">🔍 共同篩選條件</div>
            <div style="display:flex; align-items:center; justify-content:center; gap:15px; flex-wrap:wrap;">
                <div style="text-align:center; background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:6px;">
                    <div style="font-size:10px; opacity:0.8;">擔保類型</div>
                    <div style="font-size:14px; font-weight:bold;" id="step4Guarantee">--</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:6px;">
                    <div style="font-size:10px; opacity:0.8;">規模範圍(50-150%)</div>
                    <div style="font-size:14px; font-weight:bold;" id="step4SizeRange">--</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:10px; opacity:0.8;">當前理論價</div>
                    <div style="font-size:16px; font-weight:bold;" id="step4TheoPrice">--</div>
                </div>
            </div>
        </div>

        <!-- 四維度滾動結果 -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
            <!-- 產業維度 30% -->
            <div style="background:linear-gradient(135deg, #43a047 0%, #2e7d32 100%); color:white; padding:10px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                    <span style="font-size:11px;">🏭 產業</span>
                    <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;" id="step4IndustryWeight">30%</span>
                </div>
                <div style="font-size:11px; opacity:0.8;" id="step4IndustryLabel">--</div>
                <div style="font-size:16px; font-weight:bold;" id="step4IndustryPrem">--%</div>
                <div style="font-size:9px; opacity:0.7; margin-bottom:4px;">n=<span id="step4IndustryCount">0</span></div>
                <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:4px; font-size:9px; line-height:1.4;" id="step4IndustryTop3">--</div>
            </div>

            <!-- 市場氛圍 25% -->
            <div style="background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color:white; padding:10px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                    <span style="font-size:11px;">📈 市場氛圍</span>
                    <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;" id="step4MarketWeight">25%</span>
                </div>
                <div style="font-size:11px; opacity:0.8;">最近N檔整體</div>
                <div style="font-size:16px; font-weight:bold;" id="step4MarketPrem">--%</div>
                <div style="font-size:9px; opacity:0.7; margin-bottom:4px;">n=<span id="step4MarketCount">0</span></div>
                <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:4px; font-size:9px; line-height:1.4;" id="step4MarketTop3">--</div>
            </div>

            <!-- 理論價 20% -->
            <div style="background:linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); color:white; padding:10px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                    <span style="font-size:11px;">💰 理論價區間</span>
                    <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;" id="step4TheoWeight">20%</span>
                </div>
                <div style="font-size:11px; opacity:0.8;" id="step4TheoZone">--</div>
                <div style="font-size:16px; font-weight:bold;" id="step4TheoPrem">--%</div>
                <div style="font-size:9px; opacity:0.7; margin-bottom:4px;">n=<span id="step4TheoCount">0</span></div>
                <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:4px; font-size:9px; line-height:1.4;" id="step4TheoTop3">--</div>
            </div>

            <!-- 信評 25% -->
            <div style="background:linear-gradient(135deg, #f57c00 0%, #ef6c00 100%); color:white; padding:10px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                    <span style="font-size:11px;">⭐ 信評</span>
                    <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px;" id="step4RatingWeight">25%</span>
                </div>
                <div style="font-size:11px; opacity:0.8;" id="step4RatingLabel">--</div>
                <div style="font-size:16px; font-weight:bold;" id="step4RatingPrem">--%</div>
                <div style="font-size:9px; opacity:0.7; margin-bottom:4px;">n=<span id="step4RatingCount">0</span></div>
                <div style="background:rgba(255,255,255,0.15); padding:4px; border-radius:4px; font-size:9px; line-height:1.4;" id="step4RatingTop3">--</div>
            </div>
        </div>

        <!-- 合成結果 -->
        <div style="background:linear-gradient(135deg, #e65100 0%, #bf360c 100%); color:white; padding:14px; border-radius:10px; margin-bottom:12px;">
            <div style="font-size:12px; opacity:0.9; margin-bottom:10px; text-align:center;">
                🧠 四維度加權合成（近3檔50% + 近6檔30% + 近9檔20%）
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:10px;">
                <div style="text-align:center; background:rgba(255,255,255,0.15); padding:10px; border-radius:8px;">
                    <div style="font-size:10px; opacity:0.8;">合成最低溢價率</div>
                    <div style="font-size:18px; font-weight:bold;" id="step4FinalLowPrem">--%</div>
                    <div style="font-size:12px; opacity:0.9;">→ <span id="step4FinalLowPrice">--</span>元</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.15); padding:10px; border-radius:8px;">
                    <div style="font-size:10px; opacity:0.8;">合成平均溢價率</div>
                    <div style="font-size:18px; font-weight:bold;" id="step4FinalAvgPrem">--%</div>
                    <div style="font-size:12px; opacity:0.9;">→ <span id="step4FinalAvgPrice">--</span>元</div>
                </div>
            </div>
            <div style="text-align:center; background:rgba(255,255,255,0.25); padding:10px; border-radius:6px;">
                <div style="font-size:11px; margin-bottom:4px;">🧠 <b>最強大腦建議區間</b></div>
                <div style="font-size:22px; font-weight:bold;" id="step4PriceRange">--</div>
            </div>
        </div>

        <div style="text-align:center; font-size:11px; color:#e65100; margin-bottom:10px;">
            💡 四維度獨立滾動後加權合成，樣本不足時自動重分配權重<br>
            <span style="color:#795548;">⚠️ 同擔保+同規模範圍為共同篩選條件</span>
        </div>

        <!-- 可收合的詳細分析 -->
        <details style="background:white; border-radius:8px; overflow:hidden;">
            <summary style="padding:12px; cursor:pointer; font-size:13px; font-weight:bold; color:#e65100; background:#fff3e0; display:flex; align-items:center; gap:8px;">
                <span>🧠</span>
                <span>查看四維度滾動明細</span>
                <span style="margin-left:auto; font-size:11px; color:#666; font-weight:normal;">點擊展開</span>
            </summary>
            <div style="padding:12px; font-size:12px;">
                <div id="step4DetailContent">載入中...</div>
            </div>
        </details>
    </div>
</div>

<!-- Step 3: AI智能預測模組（整合近期氛圍+雙軌預測+信心度+集成引擎） -->
<!-- v3.98a: 新增集成預測引擎、MA10市場熱度、分層模型 -->
<div class="step-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
    <div style="display:flex; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:2px solid #2196f3;">
        <span style="background:#2196f3; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:10px;">3</span>
        <span style="font-size:16px; font-weight:bold; color:#1565c0;">🤖 AI智能預測模組</span>
        <span style="font-size:11px; color:#666; margin-left:auto;">集成引擎 v2.0 + 信心度量化</span>
    </div>
    <div id="step3AIContent">
        <!-- v3.98a 新增：市場熱度儀表板 -->
        <div id="step3MarketHeat" style="background:white; border:2px solid #ff9800; border-radius:10px; padding:12px; margin-bottom:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div style="font-size:13px; font-weight:bold; color:#e65100;">🌡️ 市場熱度指數</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:18px;" id="step3HeatIcon">⚖️</span>
                    <span style="font-size:14px; font-weight:bold;" id="step3HeatText">正常</span>
                    <span style="font-size:12px; color:#666;">(<span id="step3HeatIndex">50</span>/100)</span>
                </div>
            </div>
            <div style="margin-top:8px; background:#fff3e0; border-radius:6px; height:10px; overflow:hidden; position:relative;">
                <div style="position:absolute; width:100%; height:100%; background:linear-gradient(90deg, #01579b 0%, #0277bd 25%, #2196f3 50%, #ff9800 75%, #c62828 100%);"></div>
                <div id="step3HeatIndicator" style="position:absolute; width:4px; height:100%; background:#333; left:50%; transform:translateX(-50%); transition:left 0.5s;"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:9px; color:#888;">
                <span>冷淡</span><span>偏冷</span><span>正常</span><span>偏熱</span><span>過熱</span>
            </div>
            <div style="font-size:10px; color:#666; margin-top:6px; text-align:center;" id="step3HeatDetail">
                近10檔投標倍數 --倍 | 近10檔平均溢價 --%
            </div>
        </div>
        
        <!-- v3.98a 新增：集成預測引擎結果 -->
        <div id="step3EnsembleResult" style="background:linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color:white; padding:15px; border-radius:10px; margin-bottom:12px;">
            <div style="font-size:12px; opacity:0.9; margin-bottom:12px; text-align:center;">🧠 集成預測引擎 v2.0（多方法等權重整合）</div>
            
            <!-- 四種方法預測 -->
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:12px;">
                <div style="text-align:center; background:rgba(255,255,255,0.15); padding:8px; border-radius:6px;">
                    <div style="font-size:9px; opacity:0.8;">溢價率法</div>
                    <div style="font-size:14px; font-weight:bold;" id="step3Method1">--元</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.15); padding:8px; border-radius:6px;">
                    <div style="font-size:9px; opacity:0.8;">均價法</div>
                    <div style="font-size:14px; font-weight:bold;" id="step3Method2">--元</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.15); padding:8px; border-radius:6px;">
                    <div style="font-size:9px; opacity:0.8;">MA10熱度</div>
                    <div style="font-size:14px; font-weight:bold;" id="step3Method3">--元</div>
                </div>
                <div style="text-align:center; background:rgba(255,255,255,0.15); padding:8px; border-radius:6px;">
                    <div style="font-size:9px; opacity:0.8;">分層模型</div>
                    <div style="font-size:14px; font-weight:bold;" id="step3Method4">--元</div>
                </div>
            </div>
            
            <!-- 集成結果 -->
            <div style="text-align:center; background:rgba(255,255,255,0.25); padding:12px; border-radius:8px; margin-bottom:12px;">
                <div style="font-size:11px; margin-bottom:4px;">🎯 集成預測價格（MAE ≈ 3.4元）</div>
                <div style="font-size:28px; font-weight:bold;" id="step3EnsemblePrice">--元</div>
                <div style="font-size:10px; opacity:0.8; margin-top:4px;">方法間標準差: <span id="step3EnsembleStd">--</span>元</div>
            </div>
            
            <!-- 策略價格 -->
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:6px;">
                <div style="text-align:center; background:rgba(76,175,80,0.3); padding:8px; border-radius:6px;">
                    <div style="font-size:9px; opacity:0.9;">🛡️ 保守</div>
                    <div style="font-size:14px; font-weight:bold;" id="step3StratConservative">--</div>
                </div>
                <div style="text-align:center; background:rgba(33,150,243,0.3); padding:8px; border-radius:6px;">
                    <div style="font-size:9px; opacity:0.9;">⚖️ 平衡</div>
                    <div style="font-size:14px; font-weight:bold;" id="step3StratBalanced">--</div>
                </div>
                <div style="text-align:center; background:rgba(255,152,0,0.3); padding:8px; border-radius:6px;">
                    <div style="font-size:9px; opacity:0.9;">🚀 積極</div>
                    <div style="font-size:14px; font-weight:bold;" id="step3StratAggressive">--</div>
                </div>
                <div style="text-align:center; background:rgba(244,67,54,0.3); padding:8px; border-radius:6px;">
                    <div style="font-size:9px; opacity:0.9;">🔥 極致</div>
                    <div style="font-size:14px; font-weight:bold;" id="step3StratUltimate">--</div>
                </div>
            </div>
        </div>
        
        <!-- 原有的雙軌預測結果（保留作為參考） -->
        <details style="background:#f8f9fa; border-radius:8px; overflow:hidden; margin-bottom:12px;">
            <summary style="padding:12px; cursor:pointer; font-size:13px; font-weight:bold; color:#1565c0; background:#e3f2fd; display:flex; align-items:center; gap:8px;">
                <span>📊</span>
                <span>雙軌整合預測（歷史×近期）</span>
                <span style="margin-left:auto; font-size:11px; color:#666; font-weight:normal;">點擊展開</span>
            </summary>
            <div style="padding:12px;">
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:12px;">
                    <div style="text-align:center; background:white; padding:10px; border-radius:8px; border:1px solid #2196f3;">
                        <div style="font-size:10px; color:#666; margin-bottom:4px;">歷史基準溢價</div>
                        <div style="font-size:16px; font-weight:bold; color:#1565c0;" id="step3HistoricalPrem">--%</div>
                        <div style="font-size:9px; color:#888;" id="step3HistoricalWeight">權重 --%</div>
                    </div>
                    <div style="text-align:center; background:white; padding:10px; border-radius:8px; border:1px solid #4caf50;">
                        <div style="font-size:10px; color:#666; margin-bottom:4px;">近期氛圍溢價</div>
                        <div style="font-size:16px; font-weight:bold; color:#2e7d32;" id="step3RecentPrem">--%</div>
                        <div style="font-size:9px; color:#888;" id="step3RecentWeight">權重 --%</div>
                    </div>
                    <div style="text-align:center; background:#e3f2fd; padding:10px; border-radius:8px; border:2px solid #1976d2;">
                        <div style="font-size:10px; color:#666; margin-bottom:4px;">整合預測溢價</div>
                        <div style="font-size:18px; font-weight:bold; color:#0d47a1;" id="step3IntegratedPrem">--%</div>
                    </div>
                </div>
                <div id="step3AtmosphereAlert" style="display:none; background:#fff3e0; padding:10px; border-radius:6px; border-left:4px solid #ff9800;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:18px;" id="step3AlertIcon">⚠️</span>
                        <div>
                            <div style="font-size:12px; font-weight:bold; color:#e65100;" id="step3AlertTitle">氛圍偏離警示</div>
                            <div style="font-size:10px; color:#795548;" id="step3AlertDetail">--</div>
                        </div>
                    </div>
                </div>
                <div style="text-align:center; background:#e8f5e9; padding:10px; border-radius:8px;">
                    <div style="font-size:11px; color:#666; margin-bottom:4px;">雙軌建議價格區間</div>
                    <div style="font-size:16px; font-weight:bold; color:#2e7d32;" id="step3PriceRange">-- ~ --元</div>
                </div>
            </div>
        </details>
        
        <!-- 信心度指標 -->
        <div style="background:white; border:2px solid #2196f3; border-radius:10px; padding:12px; margin-bottom:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                <div style="font-size:13px; font-weight:bold; color:#1565c0;">📊 預測信心度</div>
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:18px;" id="step3ConfStars">⭐⭐</span>
                    <span style="font-size:14px; font-weight:bold;" id="step3ConfText">中信心</span>
                    <span style="font-size:12px; color:#666;">(<span id="step3ConfScore">--</span>分)</span>
                </div>
            </div>
            
            <!-- 信心度說明 -->
            <div style="font-size:11px; color:#666; line-height:1.6;" id="step3ConfExplanation">
                載入中...
            </div>
            
            <!-- 信心度進度條 -->
            <div style="margin-top:10px; background:#e3f2fd; border-radius:6px; height:8px; overflow:hidden;">
                <div id="step3ConfBar" style="background:linear-gradient(90deg, #4caf50 0%, #8bc34a 50%, #cddc39 100%); height:100%; width:50%; transition:width 0.5s;"></div>
            </div>
        </div>
        
        <!-- 數據依據透明化 -->
        <details style="background:#f5f5f5; border-radius:8px; overflow:hidden;">
            <summary style="padding:12px; cursor:pointer; font-size:13px; font-weight:bold; color:#1565c0; background:#e3f2fd; display:flex; align-items:center; gap:8px;">
                <span>📋</span>
                <span>查看預測數據依據</span>
                <span style="margin-left:auto; font-size:11px; color:#666; font-weight:normal;">點擊展開</span>
            </summary>
            <div style="padding:12px; font-size:12px;">
                <div id="step3DataSource">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div style="background:white; padding:10px; border-radius:6px; border-left:3px solid #2196f3;">
                            <div style="font-size:10px; color:#666;">參考樣本數</div>
                            <div style="font-size:16px; font-weight:bold; color:#1565c0;" id="step3SampleCount">--筆</div>
                        </div>
                        <div style="background:white; padding:10px; border-radius:6px; border-left:3px solid #4caf50;">
                            <div style="font-size:10px; color:#666;">溢價率標準差</div>
                            <div style="font-size:16px; font-weight:bold; color:#2e7d32;" id="step3StdDev">--%</div>
                        </div>
                    </div>
                    <div style="background:white; padding:10px; border-radius:6px; margin-bottom:10px;">
                        <div style="font-size:11px; color:#666; margin-bottom:6px;">v3.98a 集成預測公式：</div>
                        <div style="font-size:10px; color:#333; line-height:1.6;" id="step3Formula">
                            集成預測 = (溢價率法 + 均價法 + MA10熱度 + 分層模型) / 4<br>
                            策略區間 = 集成價格 ± 0.618σ / 1.236σ（黃金比例）<br>
                            研究驗證MAE ≈ 3.4元，優於單一方法
                        </div>
                    </div>
                    <div style="font-size:10px; color:#888; text-align:center;">
                        數據來源：304檔歷史競拍資料庫 | 引擎版本：v2.0 | 最後更新：<span id="step3LastUpdate">--</span>
                    </div>
                </div>
            </div>
        </details>
        
        <!-- 風險提示 -->
        <div style="background:#fff3e0; border-left:4px solid #ff9800; padding:10px; border-radius:0 8px 8px 0; font-size:12px; margin-top:12px;">
            <div style="font-weight:bold; color:#e65100; margin-bottom:5px;">⚠️ 投資風險提示</div>
            <div style="color:#795548; line-height:1.6;">
                • 集成預測整合4種方法，但實際得標價仍受市場情緒影響<br>
                • 市場熱度偏熱時建議參考積極策略，偏冷時建議保守策略<br>
                • 投標前請確認截標日13:30收盤的理論價格
            </div>
        </div>
    </div>
</div>
```

</div><!-- stepReport結束 -->

<div id="welcomeMsg" class="welcome-message">
    <h2>CB可轉債一頁通</h2>
    <p style="margin-top:8px; color:#666; font-size: 13px; line-height:1.6;">
        AI智能競拍評估系統，整合歷史數據與市場分析
    </p>

<div class="stats-summary" id="statsSummary"></div>

<!-- ========== 右側第一區塊：市場趨勢分析 ========== -->

<div class="right-section section-trend" style="margin-top:20px;">
    <div class="right-section-header collapsed" onclick="toggleRightSection('trendSection', this)">
        <span style="font-size:18px;">📈</span>
        <span>一、市場趨勢分析</span>
        <span style="font-size:11px; font-weight:normal; opacity:0.9;">（宏觀歷史數據）</span>
        <span class="toggle-icon">▶</span>
    </div>
    <div class="right-section-content collapsed" id="trendSection">

<!-- 市場趨勢分析 -->

<div class="market-trend-section" id="marketTrendSection" style="text-align:left;">
    <div class="market-trend-tabs">
        <button class="market-trend-tab active" onclick="showMarketTrendTab('supply', event)">供給分析</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('yearly', event)">年度趨勢</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('industry', event)">產業分析</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('broker', event)">券商分析</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('guarantee', event)">擔保比較</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('size', event)">發行規模</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('capital', event)">股本大小</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('conversion', event)">轉換價</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('rating', event)">信評</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('yearPeriod', event)">發行年期</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('type', event)">競拍vs詢圈</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('issueNum', event)">發行次數</button>
        <button class="market-trend-tab" onclick="showMarketTrendTab('ky', event)">KY股分析</button>
    </div>
    <div class="market-trend-content" id="marketTrendContent">
        載入中...
    </div>
</div>

```
</div><!-- trendSection結束 -->
```

</div><!-- 右側第一區塊結束 -->

<!-- ========== 右側第二區塊：績效分析 ========== -->

<div class="right-section section-performance" style="margin-top:15px;">
    <div class="right-section-header collapsed" onclick="toggleRightSection('performanceSection', this)">
        <span style="font-size:18px;">💰</span>
        <span>二、績效分析</span>
        <span style="font-size:11px; font-weight:normal; opacity:0.9;">（歷史盈虧驗證）</span>
        <span class="toggle-icon">▶</span>
    </div>
    <div class="right-section-content collapsed" id="performanceSection">

<!-- 年度績效排行榜 -->

<div id="rankingSection" class="ranking-section" style="text-align:left;">
    <div class="ranking-header">🏆 年度績效排行榜（TOP10 / BOTTOM10）</div>
    <div class="ranking-tabs">
        <button type="button" class="ranking-tab active" onclick="showRankingYear(2022, event)">2022</button>
        <button type="button" class="ranking-tab" onclick="showRankingYear(2023, event)">2023</button>
        <button type="button" class="ranking-tab" onclick="showRankingYear(2024, event)">2024</button>
        <button type="button" class="ranking-tab" onclick="showRankingYear(2025, event)">2025</button>
    </div>
    <div id="rankingContent">載入中...</div>
</div>

<!-- 月均成交真實績效 -->

<div id="realperfSection" class="realperf-section" style="margin-top:15px; text-align:left;">
    <div class="realperf-header">📈 月均成交真實績效</div>
    <div class="realperf-tabs">
        <button type="button" class="realperf-tab active" onclick="showRealPerfYear(2022, event)">2022</button>
        <button type="button" class="realperf-tab" onclick="showRealPerfYear(2023, event)">2023</button>
        <button type="button" class="realperf-tab" onclick="showRealPerfYear(2024, event)">2024</button>
        <button type="button" class="realperf-tab" onclick="showRealPerfYear(2025, event)">2025</button>
    </div>
    <div id="realperfContent">載入中...</div>
</div>

<!-- 競拍盈虧勝率分析 -->

<div id="profitlossSection" class="profitloss-section" style="margin-top:15px; text-align:left;">
    <div class="profitloss-header">💰 競拍盈虧勝率分析</div>
    <div class="profitloss-tabs">
        <button type="button" class="profitloss-tab active" onclick="showProfitLossYear(2022, event)">2022</button>
        <button type="button" class="profitloss-tab" onclick="showProfitLossYear(2023, event)">2023</button>
        <button type="button" class="profitloss-tab" onclick="showProfitLossYear(2024, event)">2024</button>
        <button type="button" class="profitloss-tab" onclick="showProfitLossYear(2025, event)">2025</button>
        <button type="button" class="profitloss-tab" onclick="showProfitLossYear('all', event)">全部</button>
    </div>
    <div id="profitlossContent">載入中...</div>
</div>

```
</div><!-- performanceSection結束 -->
```

</div><!-- 右側第二區塊結束 -->

<!-- ========== 右側第三區塊：基本資料查詢 ========== -->

<div class="right-section section-basic-info" style="margin-top:15px;">
    <div class="right-section-header collapsed" onclick="toggleRightSection('basicInfoSection', this)">
        <span style="font-size:18px;">📋</span>
        <span>三、基本資料查詢</span>
        <span style="font-size:11px; font-weight:normal; opacity:0.9;">（個股完整資訊）</span>
        <span class="toggle-icon">▶</span>
    </div>
    <div class="right-section-content collapsed" id="basicInfoSection">

```
    <!-- CB選擇器 -->
    <div style="margin-bottom:15px; padding:15px; background:#f5f5f5; border-radius:8px;">
        <!-- 智能搜尋區域 + 下拉選單 同一列 -->
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
            <label style="font-weight:bold; color:#333; white-space:nowrap;">🔍 快速搜尋：</label>
            <div style="flex:1; min-width:200px; max-width:350px; position:relative;">
                <input type="text" id="basicInfoSearch"
                       placeholder="輸入代號(如2383)或名稱(如台光電)..."
                       oninput="smartSearchBasicInfo(this.value)"
                       onkeydown="handleBasicInfoSearchKey(event)"
                       autocomplete="off"
                       style="width:100%; padding:8px 12px; border:2px solid #ff9800; border-radius:6px; font-size:14px; font-weight:600;">
                <!-- 搜尋結果下拉框 -->
                <div id="basicInfoSearchResults" style="display:none; position:absolute; top:100%; left:0; right:0; max-height:300px; overflow-y:auto; background:white; border:2px solid #ff9800; border-top:none; border-radius:0 0 6px 6px; z-index:1000; box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
            </div>
            <button type="button" onclick="clearBasicInfoSearch()" style="padding:8px 12px; background:#9e9e9e; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;">
                ✕ 清除
            </button>
            <span style="color:#ccc;">│</span>
            <label style="font-weight:bold; color:#666; font-size:12px; white-space:nowrap;">📋 或從清單：</label>
            <select id="basicInfoCBSelect" onchange="loadBasicInfo(this.value)" style="flex:1; min-width:180px; max-width:280px; padding:8px 10px; border:2px solid #1976d2; border-radius:6px; font-size:13px;">
                <option value="">-- 請選擇CB --</option>
            </select>
            <button type="button" onclick="refreshBasicInfoList()" style="padding:8px 12px; background:#1976d2; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;">
                🔄 重整
            </button>
        </div>

        <!-- 篩選器 -->
        <div style="display:flex; gap:20px; flex-wrap:wrap; padding:10px; background:white; border-radius:6px; border:1px solid #e0e0e0;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:12px; color:#666; font-weight:bold;">發行方式：</span>
                <label style="font-size:12px; cursor:pointer;">
                    <input type="radio" name="issueMethod" value="all" checked onchange="filterCBList()"> 全部
                </label>
                <label style="font-size:12px; cursor:pointer; color:#2e7d32;">
                    <input type="radio" name="issueMethod" value="auction" onchange="filterCBList()"> 競拍
                    <span id="auctionCount" style="font-size:10px; color:#999;">(0)</span>
                </label>
                <label style="font-size:12px; cursor:pointer; color:#1976d2;">
                    <input type="radio" name="issueMethod" value="inquiry" onchange="filterCBList()"> 詢圈
                    <span id="inquiryCount" style="font-size:10px; color:#999;">(0)</span>
                </label>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:12px; color:#666; font-weight:bold;">交易狀態：</span>
                <label style="font-size:12px; cursor:pointer;">
                    <input type="radio" name="listingStatus" value="all" checked onchange="filterCBList()"> 全部
                </label>
                <label style="font-size:12px; cursor:pointer; color:#4caf50;">
                    <input type="radio" name="listingStatus" value="listed" onchange="filterCBList()"> 掛牌中
                    <span id="listedCount" style="font-size:10px; color:#999;">(0)</span>
                </label>
                <label style="font-size:12px; cursor:pointer; color:#9e9e9e;">
                    <input type="radio" name="listingStatus" value="delisted" onchange="filterCBList()"> 已下市
                    <span id="delistedCount" style="font-size:10px; color:#999;">(0)</span>
                </label>
            </div>
        </div>

        <!-- 整合：載入狀態 + 符號說明 + 資料庫數量 -->
        <div style="margin-top:10px; padding:8px 12px; background:#e3f2fd; border-radius:6px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                <span id="basicInfoStatus" style="font-size:12px; color:#333;">提示：可從左側競拍清單點選標的</span>
                <span style="color:#90caf9;">│</span>
                <span style="font-size:12px; font-weight:bold; color:#1976d2;">📖 符號說明：</span>
                <span style="font-size:12px; color:#333;">🟢 掛牌中</span>
                <span style="font-size:12px; color:#333;">⚫ 已下市</span>
                <span style="font-size:12px; color:#333;">🎯 競拍發行</span>
                <span style="font-size:12px; color:#333;">📋 詢圈發行</span>
            </div>
            <span id="cbListCount" style="font-size:12px; color:#666; font-weight:bold;"></span>
        </div>
    </div>

    <!-- 基本資料標籤頁 -->
    <div class="basic-info-tabs">
        <button type="button" class="basic-info-tab active" onclick="showBasicInfoTab('overview', event)">📋 基本資料</button>
        <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('schedule', event)">📅 發行時程</button>
        <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('putback', event)">💰 賣回條件</button>
        <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('callOption', event)">🔔 強制贖回</button>
        <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('auction', event)">🎯 競拍資料</button>
        <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('quote', event)">📊 最新行情</button>
        <button type="button" class="basic-info-tab" onclick="showBasicInfoTab('balance', event)">📈 餘額變化</button>
    </div>
    <div id="basicInfoContent" style="min-height:200px; padding:15px; background:#fafafa; border-radius:0 0 8px 8px; border:1px solid #e0e0e0; border-top:none;">
        <div style="text-align:center; color:#999; padding:40px;">
            👆 請先選擇一檔可轉債
        </div>
    </div>

</div><!-- basicInfoSection結束 -->
```

</div><!-- 右側第三區塊結束 -->

<!-- ========== 右側第四區塊：價格走勢分析 ========== -->

<div class="right-section section-price-trend" style="margin-top:15px;">
    <div class="right-section-header collapsed" onclick="toggleRightSection('priceTrendSection', this)">
        <span style="font-size:18px;">📈</span>
        <span>四、價格走勢分析</span>
        <span style="font-size:11px; font-weight:normal; opacity:0.9;">（歷史價格圖表）</span>
        <span class="toggle-icon">▶</span>
    </div>
    <div class="right-section-content collapsed" id="priceTrendSection">

```
    <!-- v3.97-as-ci: 重新設計 UI，活潑淡紫色漸層 -->
    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 50%, #f3e5f5 100%); border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 2px 8px rgba(156,39,176,0.15);">
        <!-- 搜尋區 -->
        <div style="margin-bottom:16px;">
            <div style="font-weight:600; color:#7b1fa2; margin-bottom:8px;">🔍 快速搜尋：</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <div style="flex:1; min-width:200px; position:relative;">
                    <input type="text" id="priceTrendSearch"
                           placeholder="輸入代號(如2383)或名稱(如台光電)"
                           oninput="smartSearchPriceTrend(this.value)"
                           onkeydown="handlePriceTrendSearchKey(event)"
                           autocomplete="off"
                           style="width:100%; padding:12px 16px; border:2px solid #9c27b0; border-radius:8px; font-size:15px; font-weight:600; box-sizing:border-box; background:white;">
                    <div id="priceTrendSearchResults" style="display:none; position:absolute; top:100%; left:0; right:0; max-height:300px; overflow-y:auto; background:white; border:2px solid #9c27b0; border-top:none; border-radius:0 0 8px 8px; z-index:1000; box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
                </div>
                <button type="button" onclick="clearPriceTrendSearch()" style="padding:12px 20px; background:#9e9e9e; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600;">✕ 清除</button>
            </div>
        </div>

        <!-- 下拉選單區 -->
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px;">
            <div style="flex:1; min-width:150px;">
                <div style="font-size:12px; color:#7b1fa2; margin-bottom:4px;">📋 或從清單：</div>
                <select id="priceTrendCBSelect" onchange="loadPriceTrend(this.value)" style="width:100%; padding:10px 12px; border:2px solid #9c27b0; border-radius:8px; font-size:14px; font-weight:600; background:white;">
                    <option value="">-- 請選擇CB代號 --</option>
                </select>
            </div>
            <div style="min-width:100px;">
                <div style="font-size:12px; color:#7b1fa2; margin-bottom:4px;">📅 期間：</div>
                <select id="priceTrendPeriod" onchange="updatePriceTrendPeriod()" style="width:100%; padding:10px 12px; border:2px solid #9c27b0; border-radius:8px; font-size:14px; background:white;">
                    <option value="30">1月</option>
                    <option value="90" selected>3月</option>
                    <option value="180">6月</option>
                    <option value="365">1年</option>
                    <option value="all">全部</option>
                </select>
            </div>
        </div>

        <!-- 標籤頁按鈕 - 活潑紫色風格 -->
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
            <button type="button" class="price-trend-tab active" onclick="showPriceTrendTab('stockPrice', event)" style="padding:10px 14px; border:none; border-radius:8px; background:#9c27b0; color:white; cursor:pointer; font-weight:600; font-size:13px;">📈 股價與轉換價</button>
            <button type="button" class="price-trend-tab" onclick="showPriceTrendTab('cbPrice', event)" style="padding:10px 14px; border:2px solid #9c27b0; border-radius:8px; background:white; color:#7b1fa2; cursor:pointer; font-weight:600; font-size:13px;">💹 理論價值分析</button>
            <button type="button" class="price-trend-tab" onclick="showPriceTrendTab('cbHistory', event)" style="padding:10px 14px; border:2px solid #9c27b0; border-radius:8px; background:white; color:#7b1fa2; cursor:pointer; font-weight:600; font-size:13px;">💰 CB價格走勢</button>
            <button type="button" class="price-trend-tab" onclick="showPriceTrendTab('balance', event)" style="padding:10px 14px; border:2px solid #9c27b0; border-radius:8px; background:white; color:#7b1fa2; cursor:pointer; font-weight:600; font-size:13px;">📊 籌碼轉換分析</button>
            <button type="button" class="price-trend-tab" onclick="showPriceTrendTab('cbas', event)" style="padding:10px 14px; border:2px solid #9c27b0; border-radius:8px; background:white; color:#7b1fa2; cursor:pointer; font-weight:600; font-size:13px;">🎯 CBAS拆解</button>
        </div>
    </div>

    <!-- 圖表內容區 -->
    <div id="priceTrendContent" style="min-height:300px;">
        <div style="text-align:center; color:#999; padding:60px 20px; background:#fff; border-radius:12px;">
            <div style="font-size:32px; margin-bottom:12px;">👆</div>
            <div style="font-size:15px;">請先選擇一檔可轉債查看價格走勢</div>
        </div>
    </div>

    <!-- 資料來源說明 -->
    <div style="text-align:right; padding:8px; color:#999; font-size:12px;">
        資料來源：CB_kanban（2025年）
    </div>

</div><!-- priceTrendSection結束 -->
```

</div><!-- 右側第四區塊結束 -->

<!-- ========== 右側第五區塊：台股熱門交易 ========== -->

<div class="right-section section-ranking" style="margin-top:15px;">
    <div class="right-section-header collapsed" onclick="toggleRightSection('stockRankingSection', this)">
        <span style="font-size:18px;">🔥</span>
        <span>五、台股熱門交易</span>
        <span style="font-size:11px; font-weight:normal; opacity:0.9;">（成交值排行）</span>
        <span class="toggle-icon">▶</span>
    </div>
    <div class="right-section-content collapsed" id="stockRankingSection">

```
    <!-- v3.97-dw: 排序按鈕 - 加入高亮狀態 -->
    <div style="background:#fff; border-radius:12px; padding:12px 16px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
        <!-- 排行類型切換 -->
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <span style="font-size:12px; color:#666; margin-right:4px;">排序：</span>
            <button type="button" id="hotSortValue" class="hot-sort-btn active" data-field="Value_M" data-dir="desc" onclick="sortHotStockBtn('Value_M', 'desc', this)"
                style="padding:8px 12px; border:2px solid #1976d2; border-radius:6px; background:#1976d2; color:white; cursor:pointer; font-weight:600; font-size:12px;">
                💰 成交值
            </button>
            <button type="button" id="hotSortChange" class="hot-sort-btn" data-field="Change_1D" data-dir="desc" onclick="sortHotStockBtn('Change_1D', 'desc', this)"
                style="padding:8px 12px; border:2px solid #ddd; border-radius:6px; background:white; color:#666; cursor:pointer; font-weight:500; font-size:12px;">
                📈 漲幅
            </button>
            <button type="button" id="hotSortStrong" class="hot-sort-btn" data-field="Strength" data-dir="desc" onclick="sortHotStockBtn('Strength', 'desc', this)"
                style="padding:8px 12px; border:2px solid #ddd; border-radius:6px; background:white; color:#666; cursor:pointer; font-weight:500; font-size:12px;">
                💪 強勢
            </button>
            <button type="button" id="hotSortWeak" class="hot-sort-btn" data-field="Strength" data-dir="asc" onclick="sortHotStockBtn('Strength', 'asc', this)"
                style="padding:8px 12px; border:2px solid #ddd; border-radius:6px; background:white; color:#666; cursor:pointer; font-weight:500; font-size:12px;">
                📉 弱勢
            </button>
            <button type="button" id="hotSortMargin" class="hot-sort-btn" data-field="Margin_Change" data-dir="desc" onclick="sortHotStockBtn('Margin_Change', 'desc', this)"
                style="padding:8px 12px; border:2px solid #ddd; border-radius:6px; background:white; color:#666; cursor:pointer; font-weight:500; font-size:12px;">
                🔥 融資增
            </button>
            <button type="button" id="hotSortShort" class="hot-sort-btn" data-field="Short_Balance" data-dir="desc" onclick="sortHotStockBtn('Short_Balance', 'desc', this)"
                style="padding:8px 12px; border:2px solid #ddd; border-radius:6px; background:white; color:#666; cursor:pointer; font-weight:500; font-size:12px;">
                ⚡ 高融券
            </button>
        </div>
    </div>

    <!-- 指標說明 (可收合) -->
    <details style="background:#fff; border-radius:8px; margin-bottom:12px; overflow:hidden;">
        <summary style="padding:10px 16px; cursor:pointer; font-size:12px; color:#666; background:#f5f5f5;">
            ▶ 📖 指標說明（點擊展開）
        </summary>
        <div style="padding:12px 16px; font-size:12px; color:#555; line-height:1.8;">
            <div style="margin-bottom:8px;"><b>📊 篩選條件：</b>成交金額 ≥ 5000萬（上市+上櫃合併）</div>
            <div style="margin-bottom:8px;"><b>📈 漲跌幅：</b>1日/3日/5日/10日/20日/60日各期漲跌幅，點擊表頭可排序</div>
            <div style="margin-bottom:8px;"><b>💪 強度觀念：</b>(當日×5 + 3日×4 + 5日×3 + 10日×2 + 20日×1) ÷ 15<br>
            <span style="color:#888; font-size:11px;">愈近期者權重愈高，反映短期強勢動能</span></div>
            <div style="margin-bottom:8px;"><b>📊 量比：</b>當日成交量 ÷ 5日平均成交量<br>
            <span style="color:#888; font-size:11px;">量比>1.5且漲>2%=橘底(偏多)；量比>1.2且跌>2%=藍底(偏空)</span></div>
        </div>
    </details>

    <!-- 排行榜內容 -->
    <div id="stockRankingContent" style="min-height:300px;">
        <div style="text-align:center; color:#999; padding:60px 20px; background:#fff; border-radius:12px;">
            <div style="font-size:32px; margin-bottom:12px;">📊</div>
            <div style="font-size:15px;">點擊展開後自動載入資料...</div>
            <div style="font-size:12px; color:#aaa; margin-top:8px;">資料來源：上市+上櫃股票資料庫</div>
        </div>
    </div>

    <!-- 資料來源說明 -->
    <div style="text-align:right; padding:8px; color:#999; font-size:12px;">
        <span id="stockRankingDataInfo"></span> | 資料來源：上市上櫃股票資料庫
    </div>

</div><!-- stockRankingSection結束 -->
```

</div><!-- 右側第五區塊結束 -->

<!-- 右側第六區塊：CB套利追蹤 -->

<div class="right-section section-arbitrage" style="margin-top:16px;">
    <div class="right-section-header collapsed" onclick="toggleRightSection('arbitrageSection', this)" style="background:linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%); color:white; padding:14px 18px; border-radius:12px 12px 0 0; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
        💎 六、CB套利追蹤
        <span style="font-size:11px; font-weight:normal; opacity:0.9;">（融資融券+CB餘額）</span>
        <span class="toggle-icon">▶</span>
    </div>
    <div class="right-section-content collapsed" id="arbitrageSection">

```
    <!-- v3.97-ee: 重新設計的CB選擇器 - 簡化分類+背景色 -->
    <div style="background:#fff; border-radius:12px; padding:16px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
        <!-- 狀態篩選標籤 -->
        <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; align-items:center;">
            <button type="button" class="arb-filter-tab active" data-filter="listed" onclick="filterArbitrageCB('listed', this)"
                style="padding:10px 18px; border:none; border-radius:20px; background:#4caf50; color:white; cursor:pointer; font-weight:600; font-size:13px; box-shadow:0 2px 4px rgba(76,175,80,0.3);">
                🟢 掛牌中
            </button>
            <button type="button" class="arb-filter-tab" data-filter="delisted-recent" onclick="filterArbitrageCB('delisted-recent', this)"
                style="padding:10px 18px; border:none; border-radius:20px; background:#e0e0e0; color:#666; cursor:pointer; font-weight:600; font-size:13px;">
                ⚫ 近3年下市
            </button>
            <button type="button" class="arb-filter-tab" data-filter="delisted-old" onclick="filterArbitrageCB('delisted-old', this)"
                style="padding:10px 18px; border:none; border-radius:20px; background:#e0e0e0; color:#666; cursor:pointer; font-weight:600; font-size:13px;">
                📦 3年以上
            </button>
            <div style="margin-left:auto;">
                <input type="text" id="arbitrageSearchInput" placeholder="🔍 搜尋代號/名稱..." 
                    oninput="searchArbitrageCB(this.value)"
                    style="padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:13px; width:140px;">
            </div>
        </div>
        
        <!-- CB選擇器 -->
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
            <label style="font-size:13px; color:#666;">選擇CB：</label>
            <select id="arbitrageCBSelect" onchange="loadArbitrageData(this.value)" 
                style="padding:10px 14px; border:1px solid #ddd; border-radius:8px; font-size:14px; min-width:280px; cursor:pointer;">
                <option value="">-- 請選擇要追蹤的CB --</option>
            </select>
            <button type="button" onclick="loadArbitrageHotList()" 
                style="padding:10px 16px; border:none; border-radius:8px; background:#9c27b0; color:white; cursor:pointer; font-weight:600; font-size:13px; box-shadow:0 2px 4px rgba(156,39,176,0.3);">
                🔥 轉換熱門榜
            </button>
        </div>
        <div style="font-size:11px; color:#888; margin-top:8px;">
            💡 共 <span id="arbitrageCBCount">0</span> 檔CB可追蹤
        </div>
    </div>

    <!-- 時間區間選擇 -->
    <div id="arbitragePeriodSelector" style="display:none; background:#fff; border-radius:12px; padding:12px 16px; margin-bottom:12px;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <span style="font-size:13px; color:#666;">📅 追蹤區間：</span>
            <button type="button" class="arb-period-btn" data-period="30" onclick="changeArbitragePeriod(30, this)">1個月</button>
            <button type="button" class="arb-period-btn" data-period="90" onclick="changeArbitragePeriod(90, this)">3個月</button>
            <button type="button" class="arb-period-btn active" data-period="180" onclick="changeArbitragePeriod(180, this)">6個月</button>
            <button type="button" class="arb-period-btn" data-period="365" onclick="changeArbitragePeriod(365, this)">1年</button>
            <button type="button" class="arb-period-btn" data-period="all" onclick="changeArbitragePeriod('all', this)">全部</button>
        </div>
    </div>

    <!-- 套利狀態摘要 -->
    <div id="arbitrageSummary" style="display:none; background:#fff; border-radius:12px; padding:16px; margin-bottom:12px;">
        <!-- 動態載入 -->
    </div>

    <!-- 三線圖：融資/融券/CB餘額 -->
    <div id="arbitrageChart" style="background:#fff; border-radius:12px; padding:16px; margin-bottom:12px; min-height:300px;">
        <div style="text-align:center; color:#999; padding:60px 20px;">
            <div style="font-size:48px; margin-bottom:12px;">💎</div>
            <div style="font-size:15px; color:#666;">CB套利追蹤系統</div>
            <div style="font-size:13px; color:#999; margin-top:8px;">
                選擇一檔CB，觀察主力套利軌跡<br>
                融資餘額↑ → 融券餘額↑ → CB餘額↓ = 套利進行中
            </div>
        </div>
    </div>

    <!-- v3.97-ec: 轉換價值分析區塊 -->
    <div id="conversionValueSection" style="display:none; background:#fff; border-radius:12px; padding:16px; margin-bottom:12px;">
        <div style="font-size:14px; font-weight:600; color:#333; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
            <span style="font-size:18px;">📊</span> 轉換價值分析
        </div>
        <!-- 轉換價值摘要 -->
        <div id="convValueSummary" style="margin-bottom:12px;"></div>
        <!-- 轉換溢價率走勢圖 -->
        <div id="convValueChart" style="min-height:200px;"></div>
        <!-- 每日明細表格 -->
        <div id="convValueTable" style="margin-top:12px; max-height:300px; overflow-y:auto;"></div>
    </div>

    <!-- 轉換熱門榜 (預設隱藏) -->
    <div id="arbitrageHotList" style="display:none; background:#fff; border-radius:12px; overflow:hidden;">
        <!-- 動態載入 -->
    </div>

    <!-- 說明 -->
    <details style="background:#fff; border-radius:8px; overflow:hidden;">
        <summary style="padding:12px 16px; cursor:pointer; font-size:13px; color:#666; background:#f5f5f5;">
            ▶ 📖 套利機制說明（點擊展開）
        </summary>
        <div style="padding:16px; font-size:13px; color:#555; line-height:1.8;">
            <div style="margin-bottom:12px;">
                <b>🎯 主力CB套利三階段：</b>
            </div>
            <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:12px;">
                <div style="margin-bottom:8px;"><span style="color:#e91e63;">【階段一：佈局期】</span></div>
                <div style="padding-left:12px; font-size:12px;">
                    融資買進股票 → 融資餘額↑↑ → 產生融券額度 → 融券賣出鎖價差 → 融券餘額↑↑
                </div>
            </div>
            <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:12px;">
                <div style="margin-bottom:8px;"><span style="color:#ff9800;">【階段二：套利期】</span></div>
                <div style="padding-left:12px; font-size:12px;">
                    股價上漲 → CB申請轉換 → CB餘額↓↓ → 取得股票
                </div>
            </div>
            <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:12px;">
                <div style="margin-bottom:8px;"><span style="color:#4caf50;">【階段三：交割期】</span></div>
                <div style="padding-left:12px; font-size:12px;">
                    股票償還融券 → 融券餘額↓↓ → 完成套利 → 獲取價差利潤
                </div>
            </div>
            <div style="margin-top:12px; padding:12px; background:#fff3e0; border-radius:8px;">
                <b>📊 關鍵指標：</b><br>
                <span style="font-size:12px;">
                • <b>券資比</b> = 融券餘額 / 融資餘額（越高代表套利越積極）<br>
                • <b>CB餘額變化</b> = 轉換速度指標（快速下降=大量套利中）<br>
                • <b>CBAS成交</b> = 法人換股動向
                </span>
            </div>
        </div>
    </details>

</div><!-- arbitrageSection結束 -->
```

</div><!-- 右側第六區塊結束 -->

</div>
<div id="evaluationResult" class="evaluation-result"></div>

</div>

</div>

<!-- 版權宣告與瀏覽人數 -->

<footer class="site-footer">
    <div class="footer-content">
        <div class="visitor-count">
            👁️ 瀏覽人數：
            <a href="https://www.hitwebcounter.com" target="_blank">
                <img src="https://hitwebcounter.com/counter/counter.php?page=16839468&style=0006&nbdigits=6&type=page&initCount=0"
                     title="Counter Widget" alt="Visit counter" border="0" style="vertical-align: middle;"/>
            </a>
        </div>
        <div class="copyright">
            © 2025 Rex大叔的168台股投資教室 版權所有<br>
            <span style="font-size:11px; color:#999;">本系統僅供參考，投資有風險，請自負盈虧</span>
        </div>
    </div>
</footer>

</div>

<script>
// ==========================================
// 🧠 AI智慧核心模組 v1.0 (v3.97-ct)
// ==========================================
// 設計理念：讓系統像AI一樣具備自我優化能力
// 1. 透明度：每個結論都說明根據什麼得出
// 2. 信心度量化：樣本越多、變異越小，信心越高
// 3. 異常值處理：極端案例降低權重，避免扭曲判斷
// 4. 動態學習：隨資料增加自動更新統計參數
// 5. 偏離警示：當近期與歷史差異大時主動提醒
// ==========================================

const AICore = {
    // 版本資訊
    // v3.98a: 新增集成預測引擎(Ensemble)、MA10市場熱度、分層模型
    version: '2.0',
    lastUpdated: null,
    
    // ========== 統計基礎參數（動態計算） ==========
    stats: {
        guaranteed: { mean: 0, std: 0, n: 0, p10: 0, p25: 0, p50: 0, p75: 0, p90: 0 },
        unguaranteed: { mean: 0, std: 0, n: 0, p10: 0, p25: 0, p50: 0, p75: 0, p90: 0 },
        overall: { mean: 0, std: 0, n: 0 },
        byTheoRange: {},  // 按理論價區間分組
        byIndustry: {},   // 按產業分組
        recent9: { mean: 0, std: 0, n: 0 }  // 近9檔
    },
    
    // ========== 異常值處理 ==========
    outlier: {
        // 硬上下限（根據±2σ設定）
        limits: {
            guaranteed: { upper: 25, lower: -5 },
            unguaranteed: { upper: 20, lower: -8 }
        },
        
        // 縮尾處理：將極端值限制在合理範圍
        winsorize: function(value, guarType) {
            const lim = this.limits[guarType] || this.limits.unguaranteed;
            return Math.min(lim.upper, Math.max(lim.lower, value));
        },
        
        // 權重衰減：根據Z-score降低極端值的影響
        getWeight: function(zScore) {
            const absZ = Math.abs(zScore);
            if (absZ <= 1.5) return 1.0;      // 正常：100%
            if (absZ <= 2.0) return 0.7;      // 輕微偏離：70%
            if (absZ <= 2.5) return 0.4;      // 明顯偏離：40%
            if (absZ <= 3.0) return 0.2;      // 嚴重偏離：20%
            return 0.1;                        // 極端偏離：10%
        },
        
        // 判斷是否為異常值
        isOutlier: function(value, mean, std, threshold = 2) {
            if (std === 0) return false;
            return Math.abs(value - mean) > threshold * std;
        },
        
        // 取得異常值標記
        getOutlierLabel: function(value, mean, std) {
            if (std === 0) return { level: 'normal', icon: '🟢', text: '正常' };
            const z = Math.abs((value - mean) / std);
            if (z <= 1.5) return { level: 'normal', icon: '🟢', text: '正常' };
            if (z <= 2.0) return { level: 'mild', icon: '🟡', text: '輕微偏離' };
            if (z <= 2.5) return { level: 'moderate', icon: '🟠', text: '明顯偏離' };
            return { level: 'severe', icon: '🔴', text: '嚴重偏離' };
        }
    },
    
    // ========== 信心度計算 ==========
    confidence: {
        // 計算信心度（0-100分）
        calculate: function(sampleCount, stdDev, hasAllDimensions = false) {
            let score = 0;
            
            // 樣本數貢獻（最高40分）
            if (sampleCount >= 20) score += 40;
            else if (sampleCount >= 15) score += 35;
            else if (sampleCount >= 10) score += 28;
            else if (sampleCount >= 5) score += 18;
            else if (sampleCount >= 3) score += 10;
            else score += 5;
            
            // 變異程度貢獻（最高35分）
            if (stdDev <= 3) score += 35;
            else if (stdDev <= 5) score += 28;
            else if (stdDev <= 7) score += 20;
            else if (stdDev <= 10) score += 12;
            else score += 5;
            
            // 維度完整度貢獻（最高25分）
            score += hasAllDimensions ? 25 : 15;
            
            return Math.min(100, score);
        },
        
        // 取得信心度等級
        getLevel: function(score) {
            if (score >= 80) return { level: 'high', stars: '⭐⭐⭐', text: '高信心', color: '#22c55e' };
            if (score >= 60) return { level: 'medium', stars: '⭐⭐', text: '中信心', color: '#eab308' };
            if (score >= 40) return { level: 'low', stars: '⭐', text: '低信心', color: '#f97316' };
            return { level: 'veryLow', stars: '⚠️', text: '極低信心', color: '#ef4444' };
        },
        
        // 生成信心度說明
        generateExplanation: function(sampleCount, stdDev, dimensions) {
            const parts = [];
            parts.push(`樣本數 ${sampleCount} 筆`);
            parts.push(`標準差 ${stdDev.toFixed(2)}%`);
            if (dimensions) parts.push(`參考維度：${dimensions.join('、')}`);
            return parts.join('，');
        }
    },
    
    // ========== 雙軌預測整合 ==========
    dualTrack: {
        // 計算偏離度
        calcDeviation: function(recentAvg, historicalAvg) {
            if (historicalAvg === 0) return 0;
            return ((recentAvg - historicalAvg) / historicalAvg) * 100;
        },
        
        // 根據偏離度決定權重分配
        getAlpha: function(deviationPercent) {
            const absDeviation = Math.abs(deviationPercent);
            if (absDeviation < 15) return 0.6;   // 偏離<15%：歷史60%
            if (absDeviation < 30) return 0.5;   // 偏離15-30%：各半
            if (absDeviation < 50) return 0.4;   // 偏離30-50%：近期60%
            return 0.3;                           // 偏離>50%：近期70%
        },
        
        // 整合預測
        integrate: function(historicalValue, recentValue, alpha = null) {
            if (alpha === null) {
                const deviation = this.calcDeviation(recentValue, historicalValue);
                alpha = this.getAlpha(deviation);
            }
            return historicalValue * alpha + recentValue * (1 - alpha);
        },
        
        // 生成整合說明
        generateExplanation: function(historicalValue, recentValue, alpha, finalValue) {
            const histWeight = (alpha * 100).toFixed(0);
            const recentWeight = ((1 - alpha) * 100).toFixed(0);
            return `歷史基準 ${historicalValue.toFixed(2)}% × ${histWeight}% + 近期氛圍 ${recentValue.toFixed(2)}% × ${recentWeight}% = ${finalValue.toFixed(2)}%`;
        }
    },
    
    // ========== 氛圍偏離警示 ==========
    atmosphereAlert: {
        threshold: 3, // 偏離超過3個百分點就警示
        
        // 檢查是否需要警示
        shouldAlert: function(recentAvg, historicalAvg) {
            return Math.abs(recentAvg - historicalAvg) > this.threshold;
        },
        
        // 取得警示等級
        getAlertLevel: function(recentAvg, historicalAvg) {
            const diff = recentAvg - historicalAvg;
            const absDiff = Math.abs(diff);
            
            if (absDiff <= 2) return { level: 'normal', icon: '✅', color: '#22c55e' };
            if (absDiff <= 4) return { level: 'mild', icon: '⚡', color: '#eab308' };
            if (absDiff <= 6) return { level: 'moderate', icon: '⚠️', color: '#f97316' };
            return { level: 'severe', icon: '🚨', color: '#ef4444' };
        },
        
        // 生成警示訊息
        generateMessage: function(recentAvg, historicalAvg, recentCount) {
            const diff = recentAvg - historicalAvg;
            const direction = diff > 0 ? '偏熱' : '偏冷';
            const alert = this.getAlertLevel(recentAvg, historicalAvg);
            
            return {
                icon: alert.icon,
                color: alert.color,
                title: `近期市場氛圍${direction}`,
                detail: `近${recentCount}檔平均溢價 ${recentAvg.toFixed(2)}%（歷史平均 ${historicalAvg.toFixed(2)}%，偏離 ${diff > 0 ? '+' : ''}${diff.toFixed(2)}%）`,
                suggestion: diff > 0 
                    ? '市場偏熱，建議參考近期氛圍，可適度提高出價' 
                    : '市場偏冷，建議參考近期氛圍，可適度保守出價'
            };
        }
    },
    
    // ========== 動態統計更新 ==========
    updateStats: function(auctionData) {
        if (!auctionData || auctionData.length === 0) return;
        
        this.lastUpdated = new Date().toISOString();
        
        // 分離有擔保/無擔保
        const guaranteed = auctionData.filter(d => d['擔保'] === '有擔保' || d['擔保'] === '有');
        const unguaranteed = auctionData.filter(d => d['擔保'] === '無擔保' || d['擔保'] === '無' || d['擔保'] === '');
        
        // 計算統計參數
        const calcStats = (arr) => {
            const prems = arr.map(d => (parseFloat(d['最低溢價']) || 0) * 100).filter(v => !isNaN(v) && v !== 0);
            if (prems.length === 0) return { mean: 0, std: 0, n: 0, p10: 0, p25: 0, p50: 0, p75: 0, p90: 0 };
            
            const sorted = [...prems].sort((a, b) => a - b);
            const n = sorted.length;
            const mean = prems.reduce((a, b) => a + b, 0) / n;
            const variance = prems.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / n;
            const std = Math.sqrt(variance);
            
            return {
                mean: mean,
                std: std,
                n: n,
                p10: sorted[Math.floor(n * 0.1)] || 0,
                p25: sorted[Math.floor(n * 0.25)] || 0,
                p50: sorted[Math.floor(n * 0.5)] || 0,
                p75: sorted[Math.floor(n * 0.75)] || 0,
                p90: sorted[Math.floor(n * 0.9)] || 0
            };
        };
        
        this.stats.guaranteed = calcStats(guaranteed);
        this.stats.unguaranteed = calcStats(unguaranteed);
        this.stats.overall = calcStats(auctionData);
        
        // 計算近9檔統計
        const sortedByDate = [...auctionData].sort((a, b) => new Date(b['開標日期']) - new Date(a['開標日期']));
        const recent9 = sortedByDate.slice(0, 9);
        this.stats.recent9 = calcStats(recent9);
        
        console.log('📊 AICore統計已更新:', {
            total: auctionData.length,
            guaranteed: this.stats.guaranteed.n,
            unguaranteed: this.stats.unguaranteed.n,
            overallMean: this.stats.overall.mean.toFixed(2) + '%',
            recent9Mean: this.stats.recent9.mean.toFixed(2) + '%'
        });
    },
    
    // ========== 預測結果報告生成 ==========
    generateReport: function(params) {
        const {
            predictedPrice,
            predictedPremium,
            theoPrice,
            guarantee,
            sampleCount,
            stdDev,
            dimensions,
            historicalAvg,
            recentAvg,
            samples
        } = params;
        
        // 計算信心度
        const confScore = this.confidence.calculate(sampleCount, stdDev, dimensions && dimensions.length >= 3);
        const confLevel = this.confidence.getLevel(confScore);
        
        // 計算氛圍偏離
        const atmosphereAlert = this.atmosphereAlert.shouldAlert(recentAvg, historicalAvg)
            ? this.atmosphereAlert.generateMessage(recentAvg, historicalAvg, 9)
            : null;
        
        // 雙軌整合
        const alpha = this.dualTrack.getAlpha(this.dualTrack.calcDeviation(recentAvg, historicalAvg));
        const integratedPremium = this.dualTrack.integrate(historicalAvg, recentAvg, alpha);
        
        return {
            // 核心預測
            predictedPrice: predictedPrice,
            predictedPremium: predictedPremium,
            integratedPremium: integratedPremium,
            
            // 信心度
            confidence: {
                score: confScore,
                level: confLevel.level,
                stars: confLevel.stars,
                text: confLevel.text,
                color: confLevel.color,
                explanation: this.confidence.generateExplanation(sampleCount, stdDev, dimensions)
            },
            
            // 數據依據
            dataSource: {
                sampleCount: sampleCount,
                stdDev: stdDev,
                dimensions: dimensions,
                samples: samples ? samples.slice(0, 5) : [] // 只取前5筆作為展示
            },
            
            // 雙軌整合
            dualTrack: {
                historicalAvg: historicalAvg,
                recentAvg: recentAvg,
                alpha: alpha,
                explanation: this.dualTrack.generateExplanation(historicalAvg, recentAvg, alpha, integratedPremium)
            },
            
            // 氛圍警示
            atmosphereAlert: atmosphereAlert,
            
            // 時間戳
            generatedAt: new Date().toISOString()
        };
    },
    
    // ========== 帶有權重衰減的平均值計算 ==========
    calcWeightedAvgWithOutlierHandling: function(values, guarType = 'unguaranteed') {
        if (!values || values.length === 0) return { avg: 0, adjustedAvg: 0, outlierCount: 0 };
        
        const stats = guarType === 'guaranteed' ? this.stats.guaranteed : this.stats.unguaranteed;
        const mean = stats.mean || values.reduce((a, b) => a + b, 0) / values.length;
        const std = stats.std || 5;
        
        let totalWeight = 0;
        let weightedSum = 0;
        let outlierCount = 0;
        
        values.forEach(v => {
            const zScore = std > 0 ? (v - mean) / std : 0;
            const weight = this.outlier.getWeight(zScore);
            const clampedValue = this.outlier.winsorize(v, guarType);
            
            if (Math.abs(zScore) > 2) outlierCount++;
            
            weightedSum += clampedValue * weight;
            totalWeight += weight;
        });
        
        return {
            avg: values.reduce((a, b) => a + b, 0) / values.length,
            adjustedAvg: totalWeight > 0 ? weightedSum / totalWeight : 0,
            outlierCount: outlierCount
        };
    },
    
    // ========== v3.98a 新增：集成預測引擎 (Ensemble Engine) ==========
    // 基於研究發現：集成方法MAE=3.44元 優於單一方法
    ensemble: {
        // MA10 移動平均（研究發現MAE=4.1元，作為市場熱度指標）
        calcMA10: function(auctionData) {
            if (!auctionData || auctionData.length < 10) return null;
            
            // 按日期排序（最新在前）
            const sorted = [...auctionData].sort((a, b) => 
                new Date(b['開標日期']) - new Date(a['開標日期'])
            );
            
            // 取最近10檔的最低得標價
            const recent10 = sorted.slice(0, 10);
            const prices = recent10.map(d => parseFloat(d['最低得標']) || 0).filter(p => p > 0);
            
            if (prices.length === 0) return null;
            
            return {
                value: prices.reduce((a, b) => a + b, 0) / prices.length,
                count: prices.length,
                std: Math.sqrt(prices.reduce((sum, p) => sum + Math.pow(p - (prices.reduce((a, b) => a + b, 0) / prices.length), 2), 0) / prices.length)
            };
        },
        
        // 分層模型預測（按理論價區間，研究發現訓練MAE=3.19元）
        calcSegmentPrediction: function(theoPrice, guaranteeType, auctionData) {
            if (!auctionData || auctionData.length === 0) return null;
            
            // 理論價區間定義
            let segment = '';
            if (theoPrice < 95) segment = '<95';
            else if (theoPrice < 100) segment = '95-100';
            else if (theoPrice < 105) segment = '100-105';
            else if (theoPrice < 110) segment = '105-110';
            else segment = '>=110';
            
            // 過濾同區間且同擔保類型的歷史案例
            const filtered = auctionData.filter(d => {
                const theo = parseFloat(d['理論價']) || 0;
                const guar = d['擔保'] || '';
                const minBid = parseFloat(d['最低得標']) || 0;
                
                if (minBid <= 0) return false;
                
                // 檢查擔保類型
                const isGuaranteed = (guar === '有擔保' || guar === '有');
                const targetGuaranteed = (guaranteeType === '有擔保' || guaranteeType === '有');
                if (isGuaranteed !== targetGuaranteed) return false;
                
                // 檢查理論價區間
                let dSegment = '';
                if (theo < 95) dSegment = '<95';
                else if (theo < 100) dSegment = '95-100';
                else if (theo < 105) dSegment = '100-105';
                else if (theo < 110) dSegment = '105-110';
                else dSegment = '>=110';
                
                return dSegment === segment;
            });
            
            if (filtered.length < 3) return null;
            
            const prices = filtered.map(d => parseFloat(d['最低得標']));
            const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
            const std = Math.sqrt(prices.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) / prices.length);
            
            return {
                segment: segment,
                mean: mean,
                std: std,
                count: filtered.length,
                // 計算隱含溢價率
                impliedPremium: theoPrice > 0 ? ((mean / theoPrice) - 1) * 100 : 0
            };
        },
        
        // 集成預測（等權重組合多種方法）
        // 研究發現等權重集成MAE=3.435元，是最優策略之一
        calcEnsemblePrediction: function(params) {
            const { theoPrice, guarantee, auctionData, dimensions } = params;
            
            const predictions = [];
            const weights = [];
            
            // 方法1: 溢價率法預測
            if (dimensions && dimensions.totalLowPremium) {
                const premiumPred = theoPrice * (1 + dimensions.totalLowPremium / 100);
                predictions.push({ name: '溢價率法', value: premiumPred, weight: 0.25 });
                weights.push(0.25);
            }
            
            // 方法2: 得標均價法預測
            if (dimensions && dimensions.weightedLowBidPrice) {
                predictions.push({ name: '得標均價法', value: dimensions.weightedLowBidPrice, weight: 0.25 });
                weights.push(0.25);
            }
            
            // 方法3: MA10移動平均
            const ma10 = this.calcMA10(auctionData);
            if (ma10 && ma10.value > 0) {
                predictions.push({ name: 'MA10熱度', value: ma10.value, weight: 0.25 });
                weights.push(0.25);
            }
            
            // 方法4: 分層模型
            const segment = this.calcSegmentPrediction(theoPrice, guarantee, auctionData);
            if (segment && segment.mean > 0) {
                predictions.push({ name: '分層模型', value: segment.mean, weight: 0.25 });
                weights.push(0.25);
            }
            
            if (predictions.length === 0) return null;
            
            // 正規化權重
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            const normalizedWeights = weights.map(w => w / totalWeight);
            
            // 計算加權平均
            let ensembleValue = 0;
            predictions.forEach((p, i) => {
                p.normalizedWeight = normalizedWeights[i];
                ensembleValue += p.value * normalizedWeights[i];
            });
            
            // 計算標準差（用於信心度）
            const variance = predictions.reduce((sum, p, i) => 
                sum + normalizedWeights[i] * Math.pow(p.value - ensembleValue, 2), 0
            );
            const ensembleStd = Math.sqrt(variance);
            
            return {
                value: ensembleValue,
                std: ensembleStd,
                methods: predictions,
                methodCount: predictions.length,
                // 生成策略價格
                conservative: Math.max(100, ensembleValue - 0.618 * ensembleStd),
                balanced: ensembleValue,
                aggressive: ensembleValue + 0.618 * ensembleStd,
                ultimate: ensembleValue + 1.236 * ensembleStd
            };
        },
        
        // 生成集成預測報告
        generateReport: function(ensembleResult) {
            if (!ensembleResult || !ensembleResult.methods) return '';
            
            let methodsHtml = ensembleResult.methods.map(m => {
                const valueStr = (m && typeof m.value === 'number' && !isNaN(m.value)) 
                    ? m.value.toFixed(2) + '元' 
                    : '--元';
                const weightStr = (m && typeof m.normalizedWeight === 'number') 
                    ? (m.normalizedWeight * 100).toFixed(0) + '%' 
                    : '--%';
                return `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #eee;">
                    <span>${m.name || '未知'}</span>
                    <span style="font-weight:600;">${valueStr} (${weightStr})</span>
                </div>`;
            }).join('');
            
            const valueStr = (typeof ensembleResult.value === 'number' && !isNaN(ensembleResult.value))
                ? ensembleResult.value.toFixed(2) + '元'
                : '--元';
            const stdStr = (typeof ensembleResult.std === 'number')
                ? ensembleResult.std.toFixed(2) + '元'
                : '--元';
            const conservStr = (typeof ensembleResult.conservative === 'number')
                ? ensembleResult.conservative.toFixed(2)
                : '--';
            const ultStr = (typeof ensembleResult.ultimate === 'number')
                ? ensembleResult.ultimate.toFixed(2)
                : '--';
            
            return `
                <div style="background:#f0f7ff; border:1px solid #1976d2; border-radius:8px; padding:12px; margin-top:10px;">
                    <div style="font-weight:bold; color:#1565c0; margin-bottom:8px;">
                        🧠 集成預測引擎 v2.0 (${ensembleResult.methodCount || 0}種方法)
                    </div>
                    ${methodsHtml}
                    <div style="margin-top:8px; padding-top:8px; border-top:2px solid #1976d2;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold;">集成預測價格</span>
                            <span style="font-size:18px; font-weight:bold; color:#0d47a1;">${valueStr}</span>
                        </div>
                        <div style="font-size:11px; color:#666; margin-top:4px;">
                            方法間標準差: ${stdStr} | 
                            策略區間: ${conservStr} ~ ${ultStr}元
                        </div>
                    </div>
                </div>`;
        }
    },
    
    // ========== v3.98a 新增：市場熱度追蹤 ==========
    marketHeat: {
        // 計算近期市場熱度指數 (0-100)
        calcHeatIndex: function(auctionData, n = 10) {
            if (!auctionData || auctionData.length < n) return { index: 50, level: 'normal' };
            
            const sorted = [...auctionData].sort((a, b) => 
                new Date(b['開標日期']) - new Date(a['開標日期'])
            );
            
            // 取最近N檔
            const recent = sorted.slice(0, n);
            const older = sorted.slice(n, n * 2);
            
            if (older.length === 0) return { index: 50, level: 'normal' };
            
            // 計算投標倍數變化
            const recentMult = recent.reduce((sum, d) => sum + (parseFloat(d['投標倍數']) || 0), 0) / recent.length;
            const olderMult = older.reduce((sum, d) => sum + (parseFloat(d['投標倍數']) || 0), 0) / older.length;
            
            // 計算溢價率變化
            const recentPrem = recent.reduce((sum, d) => sum + (parseFloat(d['最低溢價']) || 0) * 100, 0) / recent.length;
            const olderPrem = older.reduce((sum, d) => sum + (parseFloat(d['最低溢價']) || 0) * 100, 0) / older.length;
            
            // 綜合熱度指數
            const multChange = olderMult > 0 ? (recentMult / olderMult - 1) * 100 : 0;
            const premChange = recentPrem - olderPrem;
            
            // 轉換為0-100指數
            let heatIndex = 50 + multChange * 2 + premChange * 3;
            heatIndex = Math.max(0, Math.min(100, heatIndex));
            
            let level = 'normal';
            if (heatIndex >= 70) level = 'hot';
            else if (heatIndex >= 60) level = 'warm';
            else if (heatIndex <= 30) level = 'cold';
            else if (heatIndex <= 40) level = 'cool';
            
            return {
                index: heatIndex,
                level: level,
                recentMult: recentMult,
                olderMult: olderMult,
                recentPrem: recentPrem,
                olderPrem: olderPrem,
                trend: heatIndex > 55 ? '升溫' : (heatIndex < 45 ? '降溫' : '持平')
            };
        },
        
        // 獲取熱度等級樣式
        getHeatStyle: function(level) {
            const styles = {
                'hot': { icon: '🔥', color: '#c62828', bg: '#ffebee', text: '過熱' },
                'warm': { icon: '☀️', color: '#e65100', bg: '#fff3e0', text: '偏熱' },
                'normal': { icon: '⚖️', color: '#1976d2', bg: '#e3f2fd', text: '正常' },
                'cool': { icon: '❄️', color: '#0277bd', bg: '#e1f5fe', text: '偏冷' },
                'cold': { icon: '🧊', color: '#01579b', bg: '#e0f7fa', text: '冷淡' }
            };
            return styles[level] || styles['normal'];
        }
    }
};

// 將AICore掛載到window供全域使用
window.AICore = AICore;

// ==========================================
// 0. 初始化權重係數
// ==========================================
if (typeof window.WEIGHT_COEFFICIENTS === 'undefined') {
    window.WEIGHT_COEFFICIENTS = {
        'industry': {},
        'broker': {},
        'capital': {},
        'size': {},
        'rating': {},
        'guarantee': {},
        'years': {},
        'conversion': {}
    };
}

// ==========================================
// 1. 欄位設定 & 工具函數
// ==========================================
const FIELD_ALIASES = {
    'cbId': ['CB代號', '代號', '股票代號'],
    'stockId': ['股票代號'],
    'name': ['名稱', 'CB名稱', '公司名稱'],
    'openDate': ['開標日期', '開標日'],
    'industry': ['產業分類', '產業別', '產業'],
    'broker': ['發行券商', '承銷券商', '主辦券商'],
    'guarantee': ['擔保', '有無擔保', '擔保情形'],
    'rating': ['信評', '信用擔保', 'TCRI', '信用評等'],
    'capital': ['股本大小', '股本', '股本規模', '股本(億)'],
    'issueSize': ['發行規模', '發行總額'],
    'years': ['年期', '發行年期'],
    'conversionPrice': ['轉換價', '轉換價格'],
    'closePrice': ['截標收盤', '截標日收盤'],
    'theoreticalPrice': ['理論價', '理論價格'],
    'floorPrice': ['底標價', '底標'],
    'premiumRate': ['訂價溢價率', '溢價率'],
    'minBidPrice': ['最低得標', '最低得標價格', '最低得標價'],
    'lowPremium': ['最低溢價', '最低得標價格_溢價率', '最低得標溢價', '最低溢價(%)'],
    'avgBidPrice': ['平均得標', '平均得標價格', '得標加權平均價格', '平均得標價'],
    'avgPremium': ['平均溢價', '得標加權平均價格_溢價率', '平均得標溢價', '平均溢價(%)'],
    'marketHigh': ['掛牌最高', '掛牌最高價'],
    'marketLow': ['掛牌最低', '掛牌最低價'],
    'qualifiedCount': ['合格件數', '合格標單'],
    'bidShares': ['投標張數', '投標總張數'],
    'bidMultiple': ['投標倍數'],
    'avgBidShares': ['投標均張', '平均投標張數'],
    'auctionShares': ['競拍張數', '競拍總張數']
};

// 產業分類名稱對應表（05工作表篩選名稱 → 04工作表實際名稱）
// 因為05工作表用簡稱，04工作表用全名，需要做對應
const INDUSTRY_NAME_MAP = {
    '化工': '化學工業',
    '半導體': '半導體業',
    '航運': '航運業',
    '光電': '光電業',
    '其他電子': '其他電子業',
    '其他': '其他業',
    '建材營造': '建材營造業',
    '生技醫療': '生技醫療業',
    '電子零組件': '電子零組件業',
    '電腦及週邊設備': '電腦及週邊設備業',
    '油電燃氣': '油電燃氣業',
    '農業科技': '農業科技業',
    '文化創意': '文化創意業',
    '通信網路': '通信網路業',
    '資訊服務': '資訊服務業',
    '電子通路': '電子通路業',
    '鋼鐵': '鋼鐵工業',
    '塑膠': '塑膠工業',
    '造紙': '造紙工業',
    '食品': '食品工業',
    '汽車': '汽車工業',
    '貿易百貨': '貿易百貨業',
    '證券': '證券業'
};

// ==========================================
// v3.84 2203檔CB實證係數常數表（完全根據實證數據）
// ==========================================

// 產業係數（權重30%）- 基準優良率63.3%
const INDUSTRY_COEFFICIENT = {
    '電子零組件業': 1.14,   // 優良率72.3%
    '電子通路業': 1.14,     // 優良率71.9%
    '電腦及週邊設備業': 1.13,// 優良率71.4%
    '其他電子業': 1.12,     // 優良率70.8%
    '化學工業': 1.12,       // 優良率70.6%
    '生技醫療業': 1.11,     // 優良率70.0%
    '半導體業': 1.09,       // 優良率68.8%
    '通信網路業': 1.04,     // 優良率66.1%
    '運動休閒': 1.01,       // 優良率64.1%
    '鋼鐵工業': 1.00,       // 優良率63.4%（基準）
    '觀光餐旅': 0.95,       // 優良率60.0%
    '航運業': 0.93,         // 優良率58.8%
    '電機機械': 0.92,       // 優良率58.3%
    '光電業': 0.91,         // 優良率57.6%
    '建材營造業': 0.89,     // 優良率56.2%
    '其他業': 0.86,         // 優良率54.3%
    '汽車工業': 0.82,       // 優良率52.1%
    '綠能環保': 0.79,       // 優良率50.0%
    '紡織纖維': 0.74,       // 優良率46.7%
    '居家生活': 0.57        // 優良率36.0%（最差）
};

// 信用評等係數（權重22%）- TCRI 4-5最佳，TCRI 7最差
const TCRI_COEFFICIENT = {
    3: 0.85,   // 優良率53.6%
    4: 1.03,   // 優良率65.0%（★優良）
    5: 1.04,   // 優良率66.0%（★最佳）
    6: 0.87,   // 優良率55.1%
    7: 0.69,   // 優良率43.9%（★最差）
    8: 0.82    // 優良率51.8%
};

// 理論價係數（權重15%）- 競拍專用，根據安全邊際
const THEO_PRICE_COEFFICIENT = {
    'under95': 1.15,    // <95元：極佳安全邊際
    '95to100': 1.10,    // 95-100元：良好安全邊際
    '100to105': 1.00,   // 100-105元：基準區間
    '105to110': 0.90,   // 105-110元：安全邊際收窄
    '110to115': 0.75,   // 110-115元：追價風險提高
    'over115': 0.60     // >115元：高風險區間
};

// 券商係數（權重13%）
const BROKER_COEFFICIENT = {
    '統一證券': 1.14,   // 優良率72.4%（★最佳）
    '台新證券': 1.04,   // 優良率65.6%
    '富邦證券': 0.97,   // 優良率61.7%
    '凱基證券': 0.97,   // 優良率61.6%
    '中信證券': 0.96,   // 優良率60.7%
    '群益證券': 0.95,   // 優良率60.0%
    '福邦證券': 0.93,   // 優良率58.7%
    '永豐金證': 0.91,   // 優良率57.8%
    '華南永昌': 0.88,   // 優良率56.0%
    '元富證券': 0.86,   // 優良率54.6%
    '元大證券': 0.83,   // 優良率52.5%
    '兆豐證券': 0.79,   // 優良率50.0%
    '合庫證券': 0.77,   // 優良率48.8%
    '宏遠證券': 0.75,   // 優良率47.6%
    '國票證券': 0.73,   // 優良率46.0%
    '國泰證券': 0.67    // 優良率42.2%（★最差）
};

// 發行規模係數（權重10%）- 小型最佳，大型最差
const ISSUE_SIZE_COEFFICIENT = {
    'small': 0.99,      // <3億：優良率62.8%（★最佳）
    'medium_small': 0.94, // 3-5億：優良率59.7%
    'medium': 0.99,     // 5-10億：優良率62.4%（★最佳）
    'medium_large': 0.97, // 10-20億：優良率61.3%
    'large': 0.79       // >=20億：優良率49.7%（★最差）
};

// 股本係數（權重5%）- 中小型最佳，大型最差
const STOCK_CAP_COEFFICIENT = {
    'small': 0.92,      // <10億：優良率58.2%
    'medium_small': 0.98, // 10-20億：優良率62.1%（★最佳）
    'medium': 0.97,     // 20-50億：優良率61.4%
    'medium_large': 0.88, // 50-100億：優良率55.4%
    'large': 0.81       // >=100億：優良率51.1%（★最差）
};

// 年期係數（權重5%）- 5年期優於3年期
const YEAR_COEFFICIENT = {
    3: 0.91,   // 優良率57.6%
    5: 1.04    // 優良率66.1%（★最佳）
};

// v3.84 權重配置（七維度完整版）
const WEIGHT_CONFIG = {
    industry: 0.30,     // 產業（實證影響最大）
    rating: 0.22,       // 信評
    theoPrice: 0.15,    // 理論價（競拍專用）
    broker: 0.13,       // 券商
    issueSize: 0.10,    // 發行規模
    stockCap: 0.05,     // 股本
    years: 0.05         // 年期
};

// v3.85 市場氛圍權重配置（五維度精簡版）
// 根據實證數據重新設計：產業最重要、券商被低估、信評不是越低越好
const MARKET_ATMOSPHERE_WEIGHTS = {
    industry: 0.35,     // 產業（優良率差距36%，實證影響最大）
    broker: 0.25,       // 券商（優良率差距30%，原本被完全忽略！）
    rating: 0.20,       // 信評（優良率差距22%，原本高估）
    issueSize: 0.10,    // 規模（優良率差距13%，原本高估）
    theoPrice: 0.10     // 理論價（競拍安全邊際考量）
};

// ==========================================
// v3.84 係數查詢函數
// ==========================================

/**
 * 取得產業係數
 */
function getIndustryCoefficient(industry) {
    if (!industry) return 1.00;
    const industryStr = String(industry);
    // 精確匹配
    if (INDUSTRY_COEFFICIENT[industryStr]) {
        return INDUSTRY_COEFFICIENT[industryStr];
    }
    // 模糊匹配
    for (const [key, value] of Object.entries(INDUSTRY_COEFFICIENT)) {
        if (industryStr.includes(key) || key.includes(industryStr)) {
            return value;
        }
    }
    return 1.00;  // 未知產業給基準係數
}

/**
 * 取得信評係數
 */
function getTcriCoefficient(tcri) {
    const rating = parseInt(tcri) || 5;
    return TCRI_COEFFICIENT[rating] || 0.87;  // 預設給TCRI 6的係數
}

/**
 * 取得理論價係數
 */
function getTheoPriceCoefficient(theoPrice) {
    const price = parseFloat(theoPrice) || 100;
    if (price < 95) return THEO_PRICE_COEFFICIENT['under95'];
    if (price < 100) return THEO_PRICE_COEFFICIENT['95to100'];
    if (price < 105) return THEO_PRICE_COEFFICIENT['100to105'];
    if (price < 110) return THEO_PRICE_COEFFICIENT['105to110'];
    if (price < 115) return THEO_PRICE_COEFFICIENT['110to115'];
    return THEO_PRICE_COEFFICIENT['over115'];
}

/**
 * 取得券商係數
 */
function getBrokerCoefficient(broker) {
    if (!broker) return 0.95;  // 未知券商給中性係數
    const brokerStr = String(broker);
    // 精確匹配
    if (BROKER_COEFFICIENT[brokerStr]) {
        return BROKER_COEFFICIENT[brokerStr];
    }
    // 模糊匹配
    for (const [key, value] of Object.entries(BROKER_COEFFICIENT)) {
        if (brokerStr.includes(key.replace('證券', '').replace('金證', ''))) {
            return value;
        }
    }
    return 0.95;
}

/**
 * 取得發行規模係數
 */
function getIssueSizeCoefficient(size) {
    const amount = parseFloat(size) || 5;
    if (amount < 3) return ISSUE_SIZE_COEFFICIENT['small'];
    if (amount < 5) return ISSUE_SIZE_COEFFICIENT['medium_small'];
    if (amount < 10) return ISSUE_SIZE_COEFFICIENT['medium'];
    if (amount < 20) return ISSUE_SIZE_COEFFICIENT['medium_large'];
    return ISSUE_SIZE_COEFFICIENT['large'];
}

/**
 * 取得股本係數
 */
function getStockCapCoefficient(cap) {
    const capital = parseFloat(cap) || 20;
    if (capital < 10) return STOCK_CAP_COEFFICIENT['small'];
    if (capital < 20) return STOCK_CAP_COEFFICIENT['medium_small'];
    if (capital < 50) return STOCK_CAP_COEFFICIENT['medium'];
    if (capital < 100) return STOCK_CAP_COEFFICIENT['medium_large'];
    return STOCK_CAP_COEFFICIENT['large'];
}

/**
 * 取得年期係數
 */
function getYearCoefficient(years) {
    const y = parseInt(years) || 3;
    return YEAR_COEFFICIENT[y] || 0.91;
}

/**
 * v3.84 計算綜合係數（乘法模型）
 * 綜合係數 = 產業係數^0.30 × 信評係數^0.22 × 理論價係數^0.15 ×
 *            券商係數^0.13 × 規模係數^0.10 × 股本係數^0.05 × 年期係數^0.05
 */
function calculateComprehensiveCoefficient(params) {
    const {
        industry,
        rating,
        theoPrice,
        broker,
        issueSize,
        stockCap,
        years
    } = params;

    // 取得各維度係數
    const industryCoef = getIndustryCoefficient(industry);
    const ratingCoef = getTcriCoefficient(rating);
    const theoCoef = getTheoPriceCoefficient(theoPrice);
    const brokerCoef = getBrokerCoefficient(broker);
    const sizeCoef = getIssueSizeCoefficient(issueSize);
    const capCoef = getStockCapCoefficient(stockCap);
    const yearCoef = getYearCoefficient(years);

    // 乘法模型：各係數的加權幾何平均
    const comprehensiveCoef =
        Math.pow(industryCoef, WEIGHT_CONFIG.industry) *
        Math.pow(ratingCoef, WEIGHT_CONFIG.rating) *
        Math.pow(theoCoef, WEIGHT_CONFIG.theoPrice) *
        Math.pow(brokerCoef, WEIGHT_CONFIG.broker) *
        Math.pow(sizeCoef, WEIGHT_CONFIG.issueSize) *
        Math.pow(capCoef, WEIGHT_CONFIG.stockCap) *
        Math.pow(yearCoef, WEIGHT_CONFIG.years);


    return {
        comprehensive: comprehensiveCoef,
        breakdown: {
            industry: { value: industry, coefficient: industryCoef, weight: WEIGHT_CONFIG.industry },
            rating: { value: rating, coefficient: ratingCoef, weight: WEIGHT_CONFIG.rating },
            theoPrice: { value: theoPrice, coefficient: theoCoef, weight: WEIGHT_CONFIG.theoPrice },
            broker: { value: broker, coefficient: brokerCoef, weight: WEIGHT_CONFIG.broker },
            issueSize: { value: issueSize, coefficient: sizeCoef, weight: WEIGHT_CONFIG.issueSize },
            stockCap: { value: stockCap, coefficient: capCoef, weight: WEIGHT_CONFIG.stockCap },
            years: { value: years, coefficient: yearCoef, weight: WEIGHT_CONFIG.years }
        }
    };
}

/**
 * v3.84 TCRI6無擔保溢價調整
 * 條件：信用評等 = 6分 且 擔保 = 無
 * 調整：溢價調降 3 元（根據實證平均差距2.6-3.3元）
 */
function getTcri6UnsecuredAdjustment(rating, guarantee, theoPrice) {
    const ratingNum = parseInt(rating) || 5;
    const isUnsecured = !guarantee || guarantee === '無' || guarantee === '無擔保' || guarantee.includes('無');

    if (ratingNum === 6 && isUnsecured) {
        // 根據理論價區間細緻調整
        const price = parseFloat(theoPrice) || 100;
        let adjustment = -3;  // 預設調降3元

        if (price < 95) {
            adjustment = -2;  // 理論價<95：調降2元
        } else if (price < 100) {
            adjustment = -1;  // 理論價95-100：調降1元
        } else if (price < 105) {
            adjustment = -3;  // 理論價100-105：調降3元
        } else {
            adjustment = -3;  // 理論價>105：調降3元
        }

        console.log('⚠️ TCRI6無擔保調整: 溢價', adjustment, '元');
        return {
            isApplicable: true,
            adjustment: adjustment,
            note: `TCRI6無擔保，溢價調降${Math.abs(adjustment)}元（無法拆CBAS，大戶參與意願低）`
        };
    }

    return {
        isApplicable: false,
        adjustment: 0,
        note: ''
    };
}

/**
 * v3.84 計算投標不足指標
 * 偵測市場極端悲觀時機
 */
function calcUndersubscriptionIndicator(targetDate) {
    // v3.97r 修正：統一使用 auctionDataCache
    if (!window.auctionDataCache || window.auctionDataCache.length === 0) {
        return null;
    }

    const target = parseExcelDate(targetDate);
    if (!target) return null;

    // 取最近3個月內的競拍案例
    const threeMonthsAgo = new Date(target);
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    const recentCases = window.auctionDataCache.filter(row => {
        const openDate = parseExcelDate(getSmartValue(row, 'openDate'));
        if (!openDate) return false;
        return openDate >= threeMonthsAgo && openDate < target;
    });

    if (recentCases.length === 0) return null;

    // 統計投標不足案例（投標倍數 < 1）
    const undersubscribedCases = recentCases.filter(row => {
        const bidMultiple = safeFloat(getSmartValue(row, 'bidMultiple'));
        return bidMultiple > 0 && bidMultiple < 1;
    });

    // 統計有擔保投標不足案例（排除TCRI 7-8）
    const securedUndersubscribed = undersubscribedCases.filter(row => {
        const guarantee = getSmartValue(row, 'guarantee');
        const rating = parseInt(getSmartValue(row, 'rating')) || 5;
        const isSecured = guarantee && (guarantee === '有' || guarantee === '有擔保' || guarantee.includes('有'));
        return isSecured && rating <= 6;
    });

    const totalCount = recentCases.length;
    const undersubscribedCount = undersubscribedCases.length;
    const undersubscribedRate = totalCount > 0 ? (undersubscribedCount / totalCount * 100) : 0;

    // 判斷市場狀態
    let marketState = '正常';
    let recommendation = '按正常流程評估';
    let color = '#4caf50';

    if (undersubscribedRate >= 15 || securedUndersubscribed.length >= 2) {
        marketState = '極端悲觀';
        recommendation = '★ 可考慮更積極參與（歷史上投標不足案例100%獲利）';
        color = '#d32f2f';
    } else if (undersubscribedRate >= 10 || securedUndersubscribed.length >= 1) {
        marketState = '偏悲觀';
        recommendation = '市場情緒偏低，可適度積極';
        color = '#ff9800';
    } else if (undersubscribedCount >= 2) {
        marketState = '警示';
        recommendation = '近期有投標不足案例，留意市場變化';
        color = '#ffc107';
    }


    return {
        totalCount: totalCount,
        undersubscribedCount: undersubscribedCount,
        undersubscribedRate: undersubscribedRate,
        securedUndersubscribedCount: securedUndersubscribed.length,
        marketState: marketState,
        recommendation: recommendation,
        color: color,
        cases: undersubscribedCases.map(row => ({
            name: getSmartValue(row, 'name'),
            openDate: formatDate(getSmartValue(row, 'openDate')),
            bidMultiple: safeFloat(getSmartValue(row, 'bidMultiple')),
            guarantee: getSmartValue(row, 'guarantee')
        }))
    };
}

// 取得產業的實際名稱（支援雙向查找）
function getIndustryActualName(filterName) {
    if (!filterName) return filterName;
    // 先查mapping
    if (INDUSTRY_NAME_MAP[filterName]) return INDUSTRY_NAME_MAP[filterName];
    // 如果已經是實際名稱就直接返回
    return filterName;
}

// 檢查產業是否匹配（支援簡稱和全名）
function industryMatches(dataIndustry, filterIndustry) {
    if (!filterIndustry) return true;
    if (!dataIndustry) return false;
    // 直接匹配
    if (dataIndustry === filterIndustry) return true;
    // 通過mapping匹配
    const actualName = INDUSTRY_NAME_MAP[filterIndustry];
    if (actualName && dataIndustry === actualName) return true;
    // 反向匹配（數據是簡稱，篩選是全名）
    for (const [short, full] of Object.entries(INDUSTRY_NAME_MAP)) {
        if (dataIndustry === short && filterIndustry === full) return true;
    }
    // 包含匹配（如「化工」包含於「化學工業」）
    if (dataIndustry.includes(filterIndustry) || filterIndustry.includes(dataIndustry)) return true;
    return false;
}

function normalizeKeys(obj) {
    const newObj = {};
    Object.keys(obj).forEach(key => { newObj[key.trim()] = obj[key]; });
    return newObj;
}

function getSmartValue(row, fieldKey) {
    if (!FIELD_ALIASES[fieldKey]) return undefined;
    for (let name of FIELD_ALIASES[fieldKey]) {
        if (row[name] !== undefined && row[name] !== null && row[name] !== '') return row[name];
    }
    return undefined;
}

function safeFloat(val) { const num = parseFloat(val); return isNaN(num) ? 0 : num; }
function safeFixed(val, digits=2) { const num = parseFloat(val); return isNaN(num) ? '-' : num.toFixed(digits); }

// v3.81 新增：通用Excel日期解析函數
function parseExcelDate(dateVal) {
    if (!dateVal) return null;
    if (dateVal instanceof Date) return dateVal;
    if (typeof dateVal === 'number') {
        // Excel序列數轉換
        return new Date((dateVal - 25569) * 86400 * 1000);
    }
    if (typeof dateVal === 'string') {
        // 處理 "2024/06/15" 或 "2024-06-15" 格式
        if (dateVal.includes('/')) {
            const parts = dateVal.split('/');
            if (parts.length === 3) {
                let year = parseInt(parts[0]);
                if (year < 100) year += 2000;
                return new Date(year, parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
        }
        const d = new Date(dateVal);
        if (!isNaN(d.getTime())) return d;
    }
    return null;
}

function formatDate(dateVal) {
    if (!dateVal) return '-';
    if (typeof dateVal === 'number') {
        const date = new Date((dateVal - 25569) * 86400 * 1000);
        return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
    }
    if (typeof dateVal === 'string') {
        return dateVal.replace(/-/g, '/');
    }
    return dateVal;
}

function normalizePremium(premium) {
    const p = safeFloat(premium);
    if (p !== 0 && Math.abs(p) < 2) {
        return p * 100;
    }
    return p;
}

function getWeightCoefficient(category, value) {
    const weights = window.WEIGHT_COEFFICIENTS || {};
    if (!weights[category]) return 1.0;
    return weights[category][value] ? weights[category][value].coefficient : 1.0;
}

function getRangeLabel(category, val) {
    const v = parseFloat(val);
    if (isNaN(v)) return val;
    if (category === '股本') {
        if (v < 3) return "< 3 億";
        if (v < 6) return "3~6 億";
        if (v < 10) return "6~10 億";
        if (v < 15) return "10~15 億";
        if (v < 20) return "15~20 億";
        return "> 20 億";
    }
    if (category === '發行規模') {
        if (v < 2) return "< 2 億";
        if (v < 5) return "2~5 億";
        if (v < 10) return "5~10 億";
        if (v < 15) return "10~15 億";
        if (v < 20) return "15~20 億";
        return "> 20 億";
    }
    if (category === '轉換價') {
        if (v < 20) return "< 20 元";
        if (v < 50) return "20~50 元";
        if (v < 100) return "50~100 元";
        if (v < 150) return "100~150 元";
        if (v < 200) return "150~200 元";
        return "> 200 元";
    }
    return val;
}

let statistics = { '維度統計': { '產業': {}, '發行券商': {} }, '資料期間': {} };
let cbDatabase = {}, auctionRawData = [], inquiryRawData = [], globalMarketStats = { low: 0, avg: 0 }, cbNameMap = {};
let listedSet = new Set(); // 掛牌中清單
let totalAuctionCount = 0; // v3.81 動態競拍案例總數

// ==========================================
// 2. 資料讀取
// ==========================================
async function loadStatistics() {
    const loadingDiv = document.getElementById('loading');
    try {
        // v3.97-as-cn: 純 CSV 模式（移除 Excel fallback）
        let sheetHighLow, sheetAllCB, sheetSchedule, sheetPutback, sheetAuction;
        let sheetPending, sheetBoard, sheetListed, sheetCBClose, sheetBalance;
        let sheetCBAS, sheetCallExecute, sheetSuspend, sheetIndustry;
        
        // CSV 行解析函數
        const parseCSVLineLocal = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        };
        
        const loadCSVFile = async (filename) => {
            try {
                const response = await fetch(`data/00_cb/${filename}`);
                if (!response.ok) {
                    console.warn(`⚠️ CSV 檔案不存在: ${filename}`);
                    return [];
                }
                const text = await response.text();
                const lines = text.split('\n').filter(l => l.trim());
                if (lines.length < 2) return [];
                
                const headers = parseCSVLineLocal(lines[0]);
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = parseCSVLineLocal(lines[i]);
                    const row = {};
                    headers.forEach((h, idx) => {
                        row[h.trim()] = cols[idx] || '';
                    });
                    data.push(normalizeKeys(row));
                }
                console.log(`✅ CSV: ${filename} (${data.length} 筆)`);
                return data;
            } catch (e) {
                console.warn(`⚠️ 載入 CSV 失敗: ${filename}`, e);
                return [];
            }
        };

        // 載入所有 CSV 檔案
        console.log('📂 載入 CSV 資料...');
        
        const csvResults = await Promise.all([
            loadCSVFile('04_auction.csv'),
            loadCSVFile('00_CB_filter.csv'),
            loadCSVFile('01_basic.csv'),
            loadCSVFile('02_schedule.csv'),
            loadCSVFile('03_putback.csv'),
            loadCSVFile('06_issue.csv'),
            loadCSVFile('07_board.csv'),
            loadCSVFile('08_weekly_basic.csv'),
            loadCSVFile('09_weekly_quote.csv'),
            loadCSVFile('10_weekly_balance.csv'),
            loadCSVFile('11_cbas_quote.csv'),
            loadCSVFile('12_call_execute.csv'),
            loadCSVFile('13_stop_convert.csv'),
            loadCSVFile('16_industry.csv')
        ]);
        
        [sheetAuction, sheetHighLow, sheetAllCB, sheetSchedule, sheetPutback,
         sheetPending, sheetBoard, sheetListed, sheetCBClose,
         sheetBalance, sheetCBAS, sheetCallExecute, sheetSuspend, sheetIndustry] = csvResults;
        
        // 檢查核心資料是否存在
        if (!sheetAuction || sheetAuction.length === 0) {
            throw new Error('找不到競拍資料 (04_auction.csv)，請確認 data/00_cb/ 目錄下有 CSV 檔案');
        }
        
        console.log('📂 CSV 資料載入完成');
        
        // CSV 模式下的日期處理
        window.sheet10Date = null;
        if (sheetBalance && sheetBalance.length > 0) {
            const firstRow = sheetBalance[0];
            const dateField = firstRow['資料日期'] || firstRow['日期'] || '';
            if (dateField) {
                window.sheet10Date = String(dateField).replace(/-/g, '/');
            }
        }

        // v3.81 新增：保存競拍數據供KNN超級預測引擎使用
        window.auctionDataCache = sheetAuction;
        
        // v3.97-ct 新增：初始化AICore統計
        if (window.AICore && sheetAuction && sheetAuction.length > 0) {
            window.AICore.updateStats(sheetAuction);
            console.log('🧠 AICore智慧核心已初始化，共載入 ' + sheetAuction.length + ' 筆競拍資料');
            
            // 更新header顯示
            const aiCoreEl = document.getElementById('aiCoreStatus');
            if (aiCoreEl) {
                const stats = window.AICore.stats;
                aiCoreEl.innerHTML = `🧠 AI核心已就緒 | 競拍資料 ${sheetAuction.length} 筆 (有擔保${stats.guaranteed.n}/無擔保${stats.unguaranteed.n})`;
                aiCoreEl.style.color = '#4caf50';
            }
        }

        // v3.97z-s 新增：保存所有工作表供基本資料查詢模組使用
        window.sheet01Data = sheetAllCB || [];
        window.sheet02Data = sheetSchedule || [];
        window.sheet03Data = sheetPutback || [];
        window.sheet08Data = sheetListed || [];
        window.sheet09Data = sheetCBClose || [];
        window.sheet10Data = sheetBalance || [];
        window.sheet12Data = sheetCallExecute || []; // v3.97-as-bz 新增：強制贖回執行
        window.sheet13Data = sheetSuspend || []; // v3.97-zs-aj 新增：暫停轉換資訊

        // v3.72 新增：建立產業分類對照表（從16工作表）
        window.industryMap = {};
        if (sheetIndustry && sheetIndustry.length > 0) {
            sheetIndustry.forEach(row => {
                const stockCode = String(row['股票代號'] || '').replace('.0', '').trim();
                const industry = row['產業分類'] || '';
                if (stockCode && industry) {
                    window.industryMap[stockCode] = industry;
                }
            });
            console.log(`載入產業分類對照表: ${Object.keys(window.industryMap).length} 筆`);
        }

        // v3.72 新增：從01工作表動態計算半年度統計（取代hardcodedStats）
        window.halfYearStats = {};
        if (sheetAllCB && sheetAllCB.length > 0) {
            // 按半年度分組
            const periodData = {};

            sheetAllCB.forEach(row => {
                const listDateRaw = row['掛牌日期'];
                if (!listDateRaw) return;

                let listDate;
                if (listDateRaw instanceof Date) {
                    listDate = listDateRaw;
                } else if (typeof listDateRaw === 'number') {
                    // Excel序列數轉換（Excel日期從1900-01-01開始，但要減2天修正）
                    listDate = new Date((listDateRaw - 25569) * 86400 * 1000);
                } else if (typeof listDateRaw === 'string') {
                    // 嘗試解析字串日期
                    if (listDateRaw.includes('/')) {
                        const parts = listDateRaw.split('/');
                        if (parts.length === 3) {
                            let year = parseInt(parts[0]);
                            if (year < 100) year += 2000;
                            listDate = new Date(year, parseInt(parts[1]) - 1, parseInt(parts[2]));
                        }
                    } else {
                        listDate = new Date(listDateRaw);
                    }
                } else {
                    return;
                }

                if (!listDate || isNaN(listDate.getTime())) return;

                const year = listDate.getFullYear();
                if (year < 2022) return; // 只統計2022年以後

                const half = listDate.getMonth() < 6 ? 'H1' : 'H2';
                const period = `${year}${half}`;

                if (!periodData[period]) {
                    periodData[period] = {
                        total: 0,
                        inquiry: 0,
                        auction: 0,
                        issueAmount: 0,
                        gains: []
                    };
                }

                const pd = periodData[period];
                pd.total++;

                const auctionType = row['詢圈競拍'] || '';
                if (auctionType === '詢圈') pd.inquiry++;
                else if (auctionType === '競拍') pd.auction++;

                const issueSize = safeFloat(row['發行規模']);
                if (issueSize > 0) pd.issueAmount += issueSize;

                const issuePrice = safeFloat(row['發行價格']) || 100;
                const marketHigh = safeFloat(row['掛牌最高']);
                if (marketHigh > 0) {
                    const gain = marketHigh - issuePrice;
                    pd.gains.push(gain);
                }
            });

            // 計算各期間的統計數據
            Object.keys(periodData).forEach(period => {
                const pd = periodData[period];
                const gains = pd.gains.sort((a, b) => a - b);
                const avgGain = gains.length > 0 ? gains.reduce((s, g) => s + g, 0) / gains.length : 0;
                const medianGain = gains.length > 0 ?
                    (gains.length % 2 === 0 ?
                        (gains[gains.length/2 - 1] + gains[gains.length/2]) / 2 :
                        gains[Math.floor(gains.length/2)]) : 0;

                window.halfYearStats[period] = {
                    total: pd.total,
                    inquiry: pd.inquiry,
                    auction: pd.auction,
                    issueAmount: Math.round(pd.issueAmount * 10) / 10,
                    avgGain: Math.round(avgGain * 10) / 10,
                    medianGain: Math.round(medianGain * 10) / 10,
                    above50: gains.filter(g => g >= 50).length,
                    range3050: gains.filter(g => g >= 30 && g < 50).length,
                    range1030: gains.filter(g => g >= 10 && g < 30).length,
                    below10: gains.filter(g => g < 10).length
                };
            });

            console.log(`載入半年度統計: ${Object.keys(window.halfYearStats).length} 期`);
        }

        // v3.97-zs-f 優化：將17次遍歷合併成1次預處理
        // 一次性預處理所有需要的欄位和統計分組
        console.time('⚡ 統計預處理');

        if (sheetAuction && sheetAuction.length > 0) {
            // ===== 統一預處理：一次遍歷收集所有資料 =====
            const collectors = {
                // 基礎資料
                auctionData: [],
                spreadData: [],
                weekMap: {},

                // 分組統計
                brokerGroups: {},
                guarGroups: { '有擔保': [], '無擔保': [] },
                sizeGroups: { under3: [], '3to5': [], '5to10': [], '10to15': [], over15: [] },
                theoGroups: {},
                termGuarGroups: {},
                convGroups: {},
                industryGroups: {},
                brokerPerfGroups: {},
                ratingGroups: {},

                // 累計值
                allMinBids: [],
                allAvgBids: [],
                allAvgPremiums: [],
                overallSum: { minBid: 0, avgBid: 0, lowPrem: 0, avgPrem: 0, count: 0 }
            };

            // 一次遍歷完成所有資料收集
            sheetAuction.forEach(row => {
                const minBid = safeFloat(row['最低得標'] || row['最低得標價格']);
                const avgBid = safeFloat(row['加權均價'] || row['平均得標'] || row['平均得標價格'] || row['得標加權平均價格']);
                const theoPrice = safeFloat(row['理論價']);
                const bidMultiple = safeFloat(row['投標倍數']);
                const issueSize = safeFloat(row['發行規模']);
                const minPremium = safeFloat(row['最低溢價']) * 100;
                const avgPremium = safeFloat(row['平均溢價'] || row['加權溢價']) * 100;
                const broker = row['發行券商'] || '';
                const guarantee = row['擔保'] || '無擔保';
                const industry = row['產業分類'] || row['產業'] || '';
                const capital = safeFloat(row['股本'] || row['股本(億)']);
                const convPrice = safeFloat(row['轉換價'] || row['轉換價格']);
                const rating = String(row['信評'] || row['TCRI'] || '').replace(/[^0-9]/g, '');
                const years = safeFloat(row['年期'] || row['發行年期']) || 3;
                const dateRaw = row['開標日'] || row['開標日期'];
                const cbName = row['名稱'] || row['CB名稱'] || '';

                // 判斷區間鍵值
                const theoKey = theoPrice <= 0 ? null : theoPrice < 95 ? '<95' : theoPrice < 100 ? '95-100' : theoPrice < 105 ? '100-105' : theoPrice < 110 ? '105-110' : '>=110';
                const bidKey = bidMultiple <= 0 ? null : bidMultiple < 1.5 ? '<1.5' : bidMultiple < 2 ? '1.5-2' : bidMultiple < 2.5 ? '2-2.5' : bidMultiple < 3 ? '2.5-3' : '>=3';
                const sizeKey = issueSize < 3 ? 'under3' : issueSize < 5 ? '3to5' : issueSize < 10 ? '5to10' : issueSize < 15 ? '10to15' : 'over15';
                const guarKey = guarantee.includes('有') ? '有擔保' : '無擔保';

                // 1. 基礎 auctionData
                if (!isNaN(minPremium) && theoPrice > 0) {
                    collectors.auctionData.push({ minPremium, theoPrice, theoKey, bidMultiple, bidKey, broker, guarantee: guarKey, issueSize });
                }

                // 2. 價差統計
                if (minBid > 0 && avgBid > 0 && avgBid >= minBid) {
                    const spread = avgBid - minBid;
                    collectors.spreadData.push({ minBid, avgBid, spread, size: issueSize, theo: theoPrice, mult: bidMultiple, guarantee: guarKey, sizeKey });
                }

                // 3. 週次分組（資金排擠效應）
                if (dateRaw && minBid > 0) {
                    const date = parseExcelDate(dateRaw);
                    if (date && !isNaN(date.getTime())) {
                        const year = date.getFullYear();
                        const startOfYear = new Date(year, 0, 1);
                        const weekNum = Math.ceil(((date - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
                        const weekKey = `${year}-W${weekNum.toString().padStart(2, '0')}`;
                        if (!collectors.weekMap[weekKey]) collectors.weekMap[weekKey] = [];
                        collectors.weekMap[weekKey].push({ name: cbName, date, minBid, mult: bidMultiple });
                    }
                }

                // 4. 各維度分組
                if (broker) {
                    if (!collectors.brokerGroups[broker]) collectors.brokerGroups[broker] = [];
                    collectors.brokerGroups[broker].push(minPremium);
                }

                if (minPremium && !isNaN(minPremium)) {
                    collectors.guarGroups[guarKey].push({ minPremium, avgPremium, minBid, avgBid });
                    collectors.sizeGroups[sizeKey].push({ minPremium, avgPremium, minBid, avgBid });
                }

                // 5. 理論價區間分組
                if (theoKey && minBid > 0) {
                    if (!collectors.theoGroups[theoKey]) collectors.theoGroups[theoKey] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [] };
                    collectors.theoGroups[theoKey].lowPrem.push(minPremium);
                    collectors.theoGroups[theoKey].avgPrem.push(avgPremium);
                    collectors.theoGroups[theoKey].minBid.push(minBid);
                    collectors.theoGroups[theoKey].avgBid.push(avgBid);
                }

                // 6. 年期×擔保分組
                const termGuarKey = `${years}年${guarKey}`;
                if (minBid > 0) {
                    if (!collectors.termGuarGroups[termGuarKey]) collectors.termGuarGroups[termGuarKey] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [] };
                    collectors.termGuarGroups[termGuarKey].lowPrem.push(minPremium);
                    collectors.termGuarGroups[termGuarKey].avgPrem.push(avgPremium);
                    collectors.termGuarGroups[termGuarKey].minBid.push(minBid);
                    collectors.termGuarGroups[termGuarKey].avgBid.push(avgBid);
                }

                // 7. 轉換價值分組
                if (convPrice > 0 && theoPrice > 0 && minBid > 0) {
                    const convValue = (theoPrice / 100) * convPrice;
                    let cvKey = '>200%';
                    if (convValue < 50) cvKey = '<50%';
                    else if (convValue < 80) cvKey = '50-80%';
                    else if (convValue < 100) cvKey = '80-100%';
                    else if (convValue < 120) cvKey = '100-120%';
                    else if (convValue < 150) cvKey = '120-150%';
                    else if (convValue < 200) cvKey = '150-200%';
                    if (!collectors.convGroups[cvKey]) collectors.convGroups[cvKey] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [] };
                    collectors.convGroups[cvKey].lowPrem.push(minPremium);
                    collectors.convGroups[cvKey].avgPrem.push(avgPremium);
                    collectors.convGroups[cvKey].minBid.push(minBid);
                    collectors.convGroups[cvKey].avgBid.push(avgBid);
                }

                // 8. 產業分組
                if (industry && minBid > 0) {
                    if (!collectors.industryGroups[industry]) collectors.industryGroups[industry] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [], mult: [] };
                    collectors.industryGroups[industry].lowPrem.push(minPremium);
                    collectors.industryGroups[industry].avgPrem.push(avgPremium);
                    collectors.industryGroups[industry].minBid.push(minBid);
                    collectors.industryGroups[industry].avgBid.push(avgBid);
                    collectors.industryGroups[industry].mult.push(bidMultiple);
                }

                // 9. 券商績效分組
                if (broker && minBid > 0) {
                    if (!collectors.brokerPerfGroups[broker]) collectors.brokerPerfGroups[broker] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [], mult: [] };
                    collectors.brokerPerfGroups[broker].lowPrem.push(minPremium);
                    collectors.brokerPerfGroups[broker].avgPrem.push(avgPremium);
                    collectors.brokerPerfGroups[broker].minBid.push(minBid);
                    collectors.brokerPerfGroups[broker].avgBid.push(avgBid);
                    collectors.brokerPerfGroups[broker].mult.push(bidMultiple);
                }

                // 10. 信評分組
                if (rating && minBid > 0) {
                    if (!collectors.ratingGroups[rating]) collectors.ratingGroups[rating] = { lowPrem: [], avgPrem: [], minBid: [], avgBid: [] };
                    collectors.ratingGroups[rating].lowPrem.push(minPremium);
                    collectors.ratingGroups[rating].avgPrem.push(avgPremium);
                    collectors.ratingGroups[rating].minBid.push(minBid);
                    collectors.ratingGroups[rating].avgBid.push(avgBid);
                }

                // 11. 整體統計累計
                if (minBid > 0) collectors.allMinBids.push(minBid);
                if (avgBid > 0) collectors.allAvgBids.push(avgBid);
                if (!isNaN(avgPremium) && theoPrice > 0) collectors.allAvgPremiums.push(avgPremium);
                if (minBid > 0 && avgBid > 0 && !isNaN(minPremium) && !isNaN(avgPremium)) {
                    collectors.overallSum.minBid += minBid;
                    collectors.overallSum.avgBid += avgBid;
                    collectors.overallSum.lowPrem += minPremium;
                    collectors.overallSum.avgPrem += avgPremium;
                    collectors.overallSum.count++;
                }

                // 12. 收集所有開標資料（用於最近10檔排序）
                if (cbName && bidMultiple > 0 && minBid > 0 && dateRaw) {
                    const d = parseExcelDate(dateRaw);
                    if (d) {
                        if (!collectors.allAuctions) collectors.allAuctions = [];
                        collectors.allAuctions.push({
                            name: cbName, date: d.toISOString().split('T')[0], dateObj: d,
                            mult: bidMultiple, price: minBid, theo: theoPrice, guarantee: guarKey
                        });
                    }
                }

                // 13. 收集 rankData 和 combinedData 需要的基礎資料
                const cbCode = String(row['CB代號'] || '').replace('.0', '').trim();
                if (!collectors.rawRows) collectors.rawRows = [];
                collectors.rawRows.push({
                    cbCode, issueSize, capital, theoPrice, theoKey, rating, industry, broker,
                    bidMultiple, guarantee: guarKey, minBid, avgBid, dateRaw
                });
            });

            console.timeEnd('⚡ 統計預處理');
            console.log(`📊 一次遍歷完成 ${sheetAuction.length} 筆資料預處理`);

            // ===== 統計計算（使用預處理資料）=====
            console.time('⚡ 統計計算');
            const auctionData = collectors.auctionData;

            // 1. 計算承銷商溢價調整 (BROKER_PREMIUM_ADJ) - 使用預處理資料
            const overallMean = auctionData.reduce((s, d) => s + d.minPremium, 0) / auctionData.length;
            window.brokerPremiumAdj = {};

            // 使用預處理收集的 brokerGroups
            Object.keys(collectors.brokerGroups).forEach(broker => {
                const vals = collectors.brokerGroups[broker].filter(v => !isNaN(v));
                if (vals.length >= 5) {
                    const mean = vals.reduce((s, v) => s + v, 0) / vals.length;
                    window.brokerPremiumAdj[broker] = Math.round((mean - overallMean) * 10) / 10;
                }
            });
            console.log(`計算承銷商調整: ${Object.keys(window.brokerPremiumAdj).length} 家`);

            // 2. 計算理論價×投標倍數交叉表 (CROSS_TABLE)
            window.crossTable = {};
            const theoKeys = ['<95', '95-100', '100-105', '105-110', '>=110'];
            const bidKeys = ['<1.5', '1.5-2', '2-2.5', '2.5-3', '>=3'];

            theoKeys.forEach(tk => {
                window.crossTable[tk] = {};
                bidKeys.forEach(bk => {
                    const group = auctionData.filter(d => d.theoKey === tk && d.bidKey === bk);
                    if (group.length >= 2) {
                        const mean = group.reduce((s, d) => s + d.minPremium, 0) / group.length;
                        window.crossTable[tk][bk] = { adj: Math.round(mean * 10) / 10, n: group.length };
                    } else {
                        window.crossTable[tk][bk] = { adj: null, n: group.length };
                    }
                });
            });

            // 3. 計算擔保/無擔保統計分布 (GUARANTEED_STATS / UNGUARANTEED_STATS)
            function calcPercentile(arr, p) {
                if (arr.length === 0) return 0;
                const sorted = [...arr].sort((a, b) => a - b);
                const idx = (p / 100) * (sorted.length - 1);
                const lower = Math.floor(idx);
                const upper = Math.ceil(idx);
                if (lower === upper) return sorted[lower];
                return sorted[lower] + (sorted[upper] - sorted[lower]) * (idx - lower);
            }

            function calcGroupStats(group) {
                if (group.length < 3) return null;
                const vals = group.map(d => d.minPremium);
                const mean = vals.reduce((s, v) => s + v, 0) / vals.length;
                const variance = vals.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / vals.length;
                const std = Math.sqrt(variance);

                return {
                    mean: Math.round(mean * 100) / 100,
                    std: Math.round(std * 100) / 100,
                    n: vals.length,
                    p10: Math.round(calcPercentile(vals, 10) * 10) / 10,
                    p25: Math.round(calcPercentile(vals, 25) * 10) / 10,
                    p50: Math.round(calcPercentile(vals, 50) * 10) / 10,
                    p75: Math.round(calcPercentile(vals, 75) * 10) / 10,
                    p90: Math.round(calcPercentile(vals, 90) * 10) / 10
                };
            }

            window.guaranteedStats = {};
            window.unguaranteedStats = {};

            theoKeys.forEach(tk => {
                const guarGroup = auctionData.filter(d => d.theoKey === tk && d.guarantee === '有擔保');
                const unguarGroup = auctionData.filter(d => d.theoKey === tk && d.guarantee === '無擔保');

                const guarStats = calcGroupStats(guarGroup);
                const unguarStats = calcGroupStats(unguarGroup);

                if (guarStats) window.guaranteedStats[tk] = guarStats;
                if (unguarStats) window.unguaranteedStats[tk] = unguarStats;
            });

            console.log(`計算擔保統計: 有擔保${Object.keys(window.guaranteedStats).length}組, 無擔保${Object.keys(window.unguaranteedStats).length}組`);

            // 4. 計算整體統計（供主力模擬使用）
            window.overallStats = {
                mean: overallMean,
                totalSamples: auctionData.length
            };
            console.log(`統計模型載入完成，共 ${auctionData.length} 筆競拍樣本`);

            // v3.74 新增：動態計算所有統計表格（取代寫死的數據）
            // ===== 動態計算 OVERALL_STATS（使用預處理資料）=====
            const allBidMults = auctionData.map(d => d.bidMultiple).filter(v => v > 0);
            const allTheoPrices = auctionData.map(d => d.theoPrice).filter(v => v > 0);
            const allMinPremiums = auctionData.map(d => d.minPremium).filter(v => !isNaN(v));

            if (allBidMults.length > 0 && collectors.allMinBids.length > 0) {
                const sortedMults = [...allBidMults].sort((a, b) => a - b);
                const sortedBids = [...collectors.allMinBids].sort((a, b) => a - b);

                const avgLowPremium = allMinPremiums.length > 0
                    ? allMinPremiums.reduce((s, v) => s + v, 0) / allMinPremiums.length
                    : 6.5;
                const avgAvgPremium = collectors.allAvgPremiums.length > 0
                    ? collectors.allAvgPremiums.reduce((s, v) => s + v, 0) / collectors.allAvgPremiums.length
                    : 8.0;

                window.OVERALL_STATS = {
                    avgBidMult: allBidMults.reduce((s, v) => s + v, 0) / allBidMults.length,
                    medianBidMult: sortedMults[Math.floor(sortedMults.length / 2)],
                    avgMinBid: collectors.allMinBids.reduce((s, v) => s + v, 0) / collectors.allMinBids.length,
                    avgAvgBid: collectors.allAvgBids.length > 0 ? collectors.allAvgBids.reduce((s, v) => s + v, 0) / collectors.allAvgBids.length : 0,
                    medianMinBid: sortedBids[Math.floor(sortedBids.length / 2)],
                    avgTheoretical: allTheoPrices.reduce((s, v) => s + v, 0) / allTheoPrices.length,
                    avgPremium: avgLowPremium,
                    avgLowPremium: avgLowPremium,
                    avgAvgPremium: avgAvgPremium,
                    avgQualified: 474,
                    avgBidShares: 34.5,
                    totalSamples: auctionData.length
                };
            }

            // ===== 價差統計分析（使用預處理的 spreadData）=====
            if (collectors.spreadData.length > 0) {
                const spreadData = collectors.spreadData;
                const spreads = spreadData.map(d => d.spread);
                const sortedSpreads = [...spreads].sort((a, b) => a - b);
                const avgSpread = spreads.reduce((s, v) => s + v, 0) / spreads.length;
                const medianSpread = sortedSpreads[Math.floor(sortedSpreads.length / 2)];
                const stdSpread = Math.sqrt(spreads.reduce((s, v) => s + Math.pow(v - avgSpread, 2), 0) / spreads.length);

                const spreadDist = {
                    tiny: spreadData.filter(d => d.spread < 0.5).length,
                    small: spreadData.filter(d => d.spread >= 0.5 && d.spread < 1).length,
                    medium: spreadData.filter(d => d.spread >= 1 && d.spread < 2).length,
                    large: spreadData.filter(d => d.spread >= 2 && d.spread < 3).length,
                    huge: spreadData.filter(d => d.spread >= 3).length
                };

                const sizeSpread = {
                    'under3': { spreads: [], label: '<3億' },
                    '3to5': { spreads: [], label: '3-5億' },
                    '5to10': { spreads: [], label: '5-10億' },
                    '10to15': { spreads: [], label: '10-15億' },
                    'over15': { spreads: [], label: '>15億' }
                };
                spreadData.forEach(d => { sizeSpread[d.sizeKey].spreads.push(d.spread); });
                Object.keys(sizeSpread).forEach(key => {
                    const arr = sizeSpread[key].spreads;
                    if (arr.length > 0) {
                        sizeSpread[key].avg = arr.reduce((s, v) => s + v, 0) / arr.length;
                        sizeSpread[key].count = arr.length;
                    }
                });

                const multSpread = { 'low': { spreads: [], label: '<2倍' }, 'medium': { spreads: [], label: '2-3倍' }, 'high': { spreads: [], label: '3-4倍' }, 'veryHigh': { spreads: [], label: '>4倍' } };
                spreadData.forEach(d => {
                    const key = d.mult < 2 ? 'low' : d.mult < 3 ? 'medium' : d.mult < 4 ? 'high' : 'veryHigh';
                    multSpread[key].spreads.push(d.spread);
                });
                Object.keys(multSpread).forEach(key => {
                    const arr = multSpread[key].spreads;
                    if (arr.length > 0) { multSpread[key].avg = arr.reduce((s, v) => s + v, 0) / arr.length; multSpread[key].count = arr.length; }
                });

                const guarSpread = { '有擔保': { spreads: [] }, '無擔保': { spreads: [] } };
                spreadData.forEach(d => { guarSpread[d.guarantee].spreads.push(d.spread); });
                Object.keys(guarSpread).forEach(key => {
                    const arr = guarSpread[key].spreads;
                    if (arr.length > 0) { guarSpread[key].avg = arr.reduce((s, v) => s + v, 0) / arr.length; guarSpread[key].count = arr.length; }
                });

                window.SPREAD_STATS = {
                    total: spreadData.length, avgSpread, medianSpread, stdSpread,
                    minSpread: sortedSpreads[0], maxSpread: sortedSpreads[sortedSpreads.length - 1],
                    distribution: spreadDist, bySize: sizeSpread, byMultiple: multSpread, byGuarantee: guarSpread
                };
            }

            // ===== 資金排擠效應分析（使用預處理的 weekMap）=====
            const weekMap = collectors.weekMap;
            const singleWeeks = [];
            const crowdedWeeks = [];

            Object.keys(weekMap).forEach(weekKey => {
                const cases = weekMap[weekKey].sort((a, b) => a.date - b.date);
                if (cases.length === 1) {
                    singleWeeks.push(cases[0]);
                } else {
                    // 標記順序（第1檔、第2檔...）
                    cases.forEach((c, idx) => {
                        crowdedWeeks.push({
                            ...c,
                            weekKey,
                            order: idx + 1,
                            totalInWeek: cases.length
                        });
                    });
                }
            });

            if (singleWeeks.length > 0 && crowdedWeeks.length > 0) {
                // 單獨週的平均
                const singleAvgMult = singleWeeks.reduce((s, c) => s + c.mult, 0) / singleWeeks.length;
                const singleAvgPrice = singleWeeks.reduce((s, c) => s + c.minBid, 0) / singleWeeks.length;

                // 密集週的平均
                const crowdedAvgMult = crowdedWeeks.reduce((s, c) => s + c.mult, 0) / crowdedWeeks.length;
                const crowdedAvgPrice = crowdedWeeks.reduce((s, c) => s + c.minBid, 0) / crowdedWeeks.length;

                // 密集週中，按順序分組
                const byOrder = {};
                crowdedWeeks.forEach(c => {
                    const orderKey = c.order <= 3 ? c.order : '4+';
                    if (!byOrder[orderKey]) byOrder[orderKey] = [];
                    byOrder[orderKey].push(c);
                });

                const orderStats = {};
                Object.keys(byOrder).forEach(key => {
                    const arr = byOrder[key];
                    orderStats[key] = {
                        count: arr.length,
                        avgMult: arr.reduce((s, c) => s + c.mult, 0) / arr.length,
                        avgPrice: arr.reduce((s, c) => s + c.minBid, 0) / arr.length
                    };
                });

                window.CROWDING_STATS = {
                    singleWeeks: {
                        count: singleWeeks.length,
                        avgMult: singleAvgMult,
                        avgPrice: singleAvgPrice
                    },
                    crowdedWeeks: {
                        count: crowdedWeeks.length,
                        avgMult: crowdedAvgMult,
                        avgPrice: crowdedAvgPrice
                    },
                    byOrder: orderStats,
                    multDiff: crowdedAvgMult - singleAvgMult,
                    priceDiff: crowdedAvgPrice - singleAvgPrice,
                    crowdedWeekCount: Object.keys(weekMap).filter(k => weekMap[k].length > 1).length
                };

            }

            // ===== 動態計算統計表格（使用預處理資料）=====
            // SIZE_MULT_TABLE - 使用預處理的 sizeGroups
            window.SIZE_MULT_TABLE = {
                'under3': { label: '<3億', avgMult: 0, avgPrice: 0, count: 0 },
                '3to5': { label: '3-5億', avgMult: 0, avgPrice: 0, count: 0 },
                '5to10': { label: '5-10億', avgMult: 0, avgPrice: 0, count: 0 },
                '10to15': { label: '10-15億', avgMult: 0, avgPrice: 0, count: 0 },
                'over15': { label: '>15億', avgMult: 0, avgPrice: 0, count: 0 }
            };
            Object.keys(collectors.sizeGroups).forEach(key => {
                const g = collectors.sizeGroups[key];
                if (g.length > 0) {
                    const avgMult = g.reduce((s, d) => s + (d.minBid > 0 ? 1 : 0), 0) > 0
                        ? auctionData.filter(d => {
                            const sk = d.issueSize < 3 ? 'under3' : d.issueSize < 5 ? '3to5' : d.issueSize < 10 ? '5to10' : d.issueSize < 15 ? '10to15' : 'over15';
                            return sk === key && d.bidMultiple > 0;
                        }).reduce((s, d) => s + d.bidMultiple, 0) / auctionData.filter(d => {
                            const sk = d.issueSize < 3 ? 'under3' : d.issueSize < 5 ? '3to5' : d.issueSize < 10 ? '5to10' : d.issueSize < 15 ? '10to15' : 'over15';
                            return sk === key && d.bidMultiple > 0;
                        }).length : 0;
                    const avgPrice = g.reduce((s, d) => s + d.minBid, 0) / g.filter(d => d.minBid > 0).length || 0;
                    window.SIZE_MULT_TABLE[key] = { label: window.SIZE_MULT_TABLE[key].label, avgMult, avgPrice, count: g.length };
                }
            });

            // TERM_GUAR_TABLE - 使用預處理的 termGuarGroups
            window.TERM_GUAR_TABLE = {};
            Object.keys(collectors.termGuarGroups).forEach(key => {
                const g = collectors.termGuarGroups[key];
                if (g.lowPrem.length >= 3) {
                    window.TERM_GUAR_TABLE[key.replace('年有擔保', '有擔保_').replace('年無擔保', '無擔保_').replace('年', '_')] = {
                        avgMult: 0, avgPrice: g.minBid.reduce((s,v) => s+v, 0) / g.minBid.length,
                        avgPremium: g.lowPrem.reduce((s,v) => s+v, 0) / g.lowPrem.length, count: g.lowPrem.length
                    };
                }
            });

            // CONV_VALUE_TABLE - 使用預處理的 theoGroups
            window.CONV_VALUE_TABLE = {
                'deep_out': { label: '深度價外(<90)', avgMult: 0, avgPrice: 0, count: 0 },
                'out': { label: '價外(90-100)', avgMult: 0, avgPrice: 0, count: 0 },
                'par': { label: '價平(100-110)', avgMult: 0, avgPrice: 0, count: 0 },
                'in': { label: '價內(110-130)', avgMult: 0, avgPrice: 0, count: 0 },
                'deep_in': { label: '深度價內(>130)', avgMult: 0, avgPrice: 0, count: 0 }
            };
            const theoMapping = { '<95': 'deep_out', '95-100': 'out', '100-105': 'par', '105-110': 'par', '>=110': 'in' };
            Object.keys(collectors.theoGroups).forEach(tk => {
                const g = collectors.theoGroups[tk];
                const ck = theoMapping[tk] || 'par';
                if (g.minBid.length > 0) {
                    window.CONV_VALUE_TABLE[ck].avgPrice = (window.CONV_VALUE_TABLE[ck].avgPrice * window.CONV_VALUE_TABLE[ck].count + g.minBid.reduce((s,v)=>s+v,0)) / (window.CONV_VALUE_TABLE[ck].count + g.minBid.length);
                    window.CONV_VALUE_TABLE[ck].count += g.minBid.length;
                }
            });

            // INDUSTRY_MULT_TABLE - 使用預處理的 industryGroups
            window.INDUSTRY_MULT_TABLE = {};
            Object.keys(collectors.industryGroups).forEach(industry => {
                const g = collectors.industryGroups[industry];
                if (g.minBid.length >= 5) {
                    window.INDUSTRY_MULT_TABLE[industry] = {
                        avgMult: g.mult.reduce((s,v) => s+v, 0) / g.mult.length,
                        avgPrice: g.minBid.reduce((s,v) => s+v, 0) / g.minBid.length,
                        avgPremium: g.lowPrem.reduce((s,v) => s+v, 0) / g.lowPrem.length,
                        count: g.minBid.length
                    };
                }
            });

            // BROKER_MULT_TABLE - 使用預處理的 brokerPerfGroups
            window.BROKER_MULT_TABLE = {};
            Object.keys(collectors.brokerPerfGroups).forEach(broker => {
                const g = collectors.brokerPerfGroups[broker];
                if (g.minBid.length >= 5) {
                    window.BROKER_MULT_TABLE[broker] = {
                        avgMult: g.mult.reduce((s,v) => s+v, 0) / g.mult.length,
                        avgPrice: g.minBid.reduce((s,v) => s+v, 0) / g.minBid.length,
                        avgPremium: g.lowPrem.reduce((s,v) => s+v, 0) / g.lowPrem.length,
                        count: g.minBid.length
                    };
                }
            });

            // RATING_MULT_TABLE - 使用預處理的 ratingGroups
            window.RATING_MULT_TABLE = {};
            Object.keys(collectors.ratingGroups).forEach(rating => {
                const g = collectors.ratingGroups[rating];
                if (g.minBid.length > 0) {
                    window.RATING_MULT_TABLE[rating] = {
                        avgMult: 0, avgPrice: g.minBid.reduce((s,v) => s+v, 0) / g.minBid.length,
                        avgShares: 0, count: g.minBid.length
                    };
                }
            });

            // YEAR_STATS_TABLE - 需要額外處理日期，這裡簡化處理
            window.YEAR_STATS_TABLE = {};

            console.timeEnd('⚡ 統計計算');

            // ===== 最近10檔開標資料（使用預處理資料）=====
            if (collectors.allAuctions && collectors.allAuctions.length > 0) {
                collectors.allAuctions.sort((a, b) => b.dateObj - a.dateObj);
                window.recentAuctionData = collectors.allAuctions.slice(0, 10);
                console.log('收集最近10檔開標資料:', window.recentAuctionData.length, '筆');
            } else {
                window.recentAuctionData = [];
            }

            console.log('✅ 所有統計表格已從Excel動態計算完成');

            // ===== v3.74 新增：計算各維度區間排名（按平均掛牌最高排名）=====
            window.dimensionRankings = {};

            // 建立CB代號到掛牌資料的對照（用於排名計算）- 統一使用一個 listingMap
            const listingMapUnified = {};
            if (sheetAllCB) {
                sheetAllCB.forEach(row => {
                    const cbCode = String(row['CB代號'] || '').replace('.0', '').trim();
                    if (cbCode) {
                        listingMapUnified[cbCode] = {
                            marketHigh: safeFloat(row['掛牌最高']),
                            marketLow: safeFloat(row['掛牌最低']),
                            issuePrice: safeFloat(row['發行價格']) || 100,
                            listDate: row['掛牌日期']
                        };
                    }
                });
            }

            // 使用預處理的 rawRows 合併掛牌資料（一次處理 rankData 和 combinedData）
            const rankData = [];
            const combinedData = [];

            if (collectors.rawRows) {
                collectors.rawRows.forEach(r => {
                    const listing = listingMapUnified[r.cbCode] || {};

                    // rankData 資料
                    if (listing.marketHigh > 0) {
                        rankData.push({
                            issueSize: r.issueSize, capital: r.capital, theoreticalPrice: r.theoPrice,
                            rating: r.rating, industry: r.industry, broker: r.broker,
                            marketHigh: listing.marketHigh, marketLow: listing.marketLow
                        });
                    }

                    // combinedData 資料
                    if (r.theoPrice > 0) {
                        const gain = listing.marketHigh > 0 ? listing.marketHigh - (listing.issuePrice || 100) : null;
                        const lowPremium = (r.theoPrice > 0 && r.minBid > 0) ? (r.minBid / r.theoPrice - 1) * 100 : null;
                        const avgPremium = (r.theoPrice > 0 && r.avgBid > 0) ? (r.avgBid / r.theoPrice - 1) * 100 : null;
                        let isRecent = false;
                        if (listing.listDate) {
                            const d = parseExcelDate(listing.listDate);
                            if (d) isRecent = d.getFullYear() >= 2024;
                        }
                        let sizeKey = '>=10億';
                        if (r.issueSize > 0 && r.issueSize < 3) sizeKey = '<3億';
                        else if (r.issueSize < 5) sizeKey = '3-5億';
                        else if (r.issueSize < 10) sizeKey = '5-10億';

                        combinedData.push({
                            theoPrice: r.theoPrice, theoKey: r.theoKey, bidMultiple: r.bidMultiple,
                            guarantee: r.guarantee, issueSize: r.issueSize, sizeKey,
                            gain, isRecent, lowPremium, avgPremium, minBidPrice: r.minBid
                        });
                    }
                });
            }

            // 計算發行規模區間排名
            const sizeRanges = [
                { key: '小於2億', filter: d => d.issueSize > 0 && d.issueSize < 2 },
                { key: '2~5億', filter: d => d.issueSize >= 2 && d.issueSize < 5 },
                { key: '5~10億', filter: d => d.issueSize >= 5 && d.issueSize < 10 },
                { key: '10~15億', filter: d => d.issueSize >= 10 && d.issueSize < 15 },
                { key: '15~20億', filter: d => d.issueSize >= 15 && d.issueSize < 20 },
                { key: '大於20億', filter: d => d.issueSize >= 20 }
            ];
            const sizeStats = sizeRanges.map(r => {
                const filtered = rankData.filter(r.filter);
                const avgHigh = filtered.length > 0 ? filtered.reduce((s, d) => s + d.marketHigh, 0) / filtered.length : 0;
                return { key: r.key, avgHigh, count: filtered.length };
            }).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['發行規模'] = {};
            sizeStats.forEach((s, idx) => {
                window.dimensionRankings['發行規模'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: sizeStats.length, count: s.count };
            });

            // 計算股本區間排名
            const capitalRanges = [
                { key: '小於3億', filter: d => d.capital > 0 && d.capital < 3 },
                { key: '3~6億', filter: d => d.capital >= 3 && d.capital < 6 },
                { key: '6~10億', filter: d => d.capital >= 6 && d.capital < 10 },
                { key: '10~15億', filter: d => d.capital >= 10 && d.capital < 15 },
                { key: '15~20億', filter: d => d.capital >= 15 && d.capital < 20 },
                { key: '大於20億', filter: d => d.capital >= 20 }
            ];
            const capitalStats = capitalRanges.map(r => {
                const filtered = rankData.filter(r.filter);
                const avgHigh = filtered.length > 0 ? filtered.reduce((s, d) => s + d.marketHigh, 0) / filtered.length : 0;
                return { key: r.key, avgHigh, count: filtered.length };
            }).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['股本'] = {};
            capitalStats.forEach((s, idx) => {
                window.dimensionRankings['股本'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: capitalStats.length, count: s.count };
            });

            // 計算理論價區間排名
            const theoRanges = [
                { key: '小於90元', filter: d => d.theoreticalPrice > 0 && d.theoreticalPrice < 90 },
                { key: '90~95元', filter: d => d.theoreticalPrice >= 90 && d.theoreticalPrice < 95 },
                { key: '95~100元', filter: d => d.theoreticalPrice >= 95 && d.theoreticalPrice < 100 },
                { key: '100~105元', filter: d => d.theoreticalPrice >= 100 && d.theoreticalPrice < 105 },
                { key: '105~110元', filter: d => d.theoreticalPrice >= 105 && d.theoreticalPrice < 110 },
                { key: '110~115元', filter: d => d.theoreticalPrice >= 110 && d.theoreticalPrice < 115 },
                { key: '大於115元', filter: d => d.theoreticalPrice >= 115 }
            ];
            const theoStats = theoRanges.map(r => {
                const filtered = rankData.filter(r.filter);
                const avgHigh = filtered.length > 0 ? filtered.reduce((s, d) => s + d.marketHigh, 0) / filtered.length : 0;
                return { key: r.key, avgHigh, count: filtered.length };
            }).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['理論價'] = {};
            theoStats.forEach((s, idx) => {
                window.dimensionRankings['理論價'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: theoStats.length, count: s.count };
            });

            // 計算信評排名
            const ratingStats = [];
            for (let i = 1; i <= 9; i++) {
                const filtered = rankData.filter(d => d.rating === String(i));
                const avgHigh = filtered.length > 0 ? filtered.reduce((s, d) => s + d.marketHigh, 0) / filtered.length : 0;
                if (filtered.length > 0) {
                    ratingStats.push({ key: String(i), avgHigh, count: filtered.length });
                }
            }
            ratingStats.sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['信評'] = {};
            ratingStats.forEach((s, idx) => {
                window.dimensionRankings['信評'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: ratingStats.length, count: s.count };
            });

            // 計算產業排名
            const industryGroups2 = {};
            rankData.forEach(d => {
                if (d.industry) {
                    if (!industryGroups2[d.industry]) industryGroups2[d.industry] = [];
                    industryGroups2[d.industry].push(d.marketHigh);
                }
            });
            const industryStats = Object.keys(industryGroups2).map(key => ({
                key,
                avgHigh: industryGroups2[key].reduce((s, v) => s + v, 0) / industryGroups2[key].length,
                count: industryGroups2[key].length
            })).filter(s => s.count >= 3).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['產業'] = {};
            industryStats.forEach((s, idx) => {
                window.dimensionRankings['產業'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: industryStats.length, count: s.count };
            });

            // 計算券商排名
            const brokerGroups2 = {};
            rankData.forEach(d => {
                if (d.broker) {
                    if (!brokerGroups2[d.broker]) brokerGroups2[d.broker] = [];
                    brokerGroups2[d.broker].push(d.marketHigh);
                }
            });
            const brokerStats = Object.keys(brokerGroups2).map(key => ({
                key,
                avgHigh: brokerGroups2[key].reduce((s, v) => s + v, 0) / brokerGroups2[key].length,
                count: brokerGroups2[key].length
            })).filter(s => s.count >= 3).sort((a, b) => b.avgHigh - a.avgHigh);
            window.dimensionRankings['發行券商'] = {};
            brokerStats.forEach((s, idx) => {
                window.dimensionRankings['發行券商'][s.key] = { avgHigh: s.avgHigh, rank: idx + 1, total: brokerStats.length, count: s.count };
            });

            console.log('✅ 各維度區間排名計算完成:', Object.keys(window.dimensionRankings));

            // v3.72 新增：計算各條件組合的歷史統計（用於競拍前評估）
            // combinedData 已在上方預處理中建立
            if (combinedData && combinedData.length > 0) {
                // 計算各條件組合的統計
                window.conditionStats = {};
                const theoKeys = ['<95', '95-100', '100-105', '105-110', '>=110'];
                const guarKeys = ['有擔保', '無擔保'];

                theoKeys.forEach(tk => {
                guarKeys.forEach(gk => {
                    const key = `${tk}_${gk}`;
                    const group = combinedData.filter(d => d.theoKey === tk && d.guarantee === gk);
                    const recentGroup = group.filter(d => d.isRecent);

                    if (group.length >= 3) {
                        // 全部數據
                        const bidMults = group.map(d => d.bidMultiple).filter(v => v > 0);
                        const gains = group.map(d => d.gain).filter(v => v !== null);
                        const wins = gains.filter(g => g >= 10).length;
                        // v3.73 新增：溢價率統計（相對理論價）
                        const lowPrems = group.map(d => d.lowPremium).filter(v => v !== null);
                        const avgPrems = group.map(d => d.avgPremium).filter(v => v !== null);

                        // 近期數據（優先使用）
                        const recentBidMults = recentGroup.map(d => d.bidMultiple).filter(v => v > 0);
                        const recentGains = recentGroup.map(d => d.gain).filter(v => v !== null);
                        const recentWins = recentGains.filter(g => g >= 10).length;
                        // v3.73 新增：近期溢價率
                        const recentLowPrems = recentGroup.map(d => d.lowPremium).filter(v => v !== null);
                        const recentAvgPrems = recentGroup.map(d => d.avgPremium).filter(v => v !== null);

                        window.conditionStats[key] = {
                            // 全部統計
                            count: group.length,
                            avgBidMultiple: bidMults.length > 0 ? bidMults.reduce((s,v) => s+v, 0) / bidMults.length : 2.5,
                            avgGain: gains.length > 0 ? gains.reduce((s,v) => s+v, 0) / gains.length : 30,
                            medianGain: gains.length > 0 ? gains.sort((a,b) => a-b)[Math.floor(gains.length/2)] : 20,
                            winRate: gains.length > 0 ? wins / gains.length : 0.7,
                            // v3.73 新增：溢價率統計（相對理論價，這才是主力出價的基準）
                            avgLowPremium: lowPrems.length > 0 ? lowPrems.reduce((s,v) => s+v, 0) / lowPrems.length : 5,
                            avgAvgPremium: avgPrems.length > 0 ? avgPrems.reduce((s,v) => s+v, 0) / avgPrems.length : 7,
                            // 近期統計（2024年後）
                            recentCount: recentGroup.length,
                            recentAvgBidMultiple: recentBidMults.length >= 3 ? recentBidMults.reduce((s,v) => s+v, 0) / recentBidMults.length : null,
                            recentAvgGain: recentGains.length >= 3 ? recentGains.reduce((s,v) => s+v, 0) / recentGains.length : null,
                            recentWinRate: recentGains.length >= 3 ? recentWins / recentGains.length : null,
                            // v3.73 新增：近期溢價率（相對理論價）
                            recentAvgLowPremium: recentLowPrems.length >= 3 ? recentLowPrems.reduce((s,v) => s+v, 0) / recentLowPrems.length : null,
                            recentAvgAvgPremium: recentAvgPrems.length >= 3 ? recentAvgPrems.reduce((s,v) => s+v, 0) / recentAvgPrems.length : null
                        };
                    }
                });
            });

            console.log(`計算條件組合統計: ${Object.keys(window.conditionStats).length} 組`);
            console.log('條件組合統計:', window.conditionStats);
            }
        }

        // v3.62 新增：建立CB收盤價對照表（從09工作表D欄「CB收盤價」讀取）
        window.cbClosePriceMap = {};
        if (sheetCBClose && sheetCBClose.length > 0) {
            sheetCBClose.forEach(row => {
                // A欄是「代碼」，D欄是「CB收盤價」
                let id = row['代碼'] || row['代號'] || row['CB代號'];
                let closePrice = row['CB收盤價'] || row['收盤價'] || row['CB收盤'];

                if (id && closePrice) {
                    const cleanId = String(id).replace('.0', '').trim();
                    window.cbClosePriceMap[cleanId] = safeFloat(closePrice);
                }
            });
            console.log(`載入CB收盤價: ${Object.keys(window.cbClosePriceMap).length} 筆`);
        }

        // 建立掛牌中代號Set（用於判斷狀態）
        if (sheetListed && sheetListed.length > 0) {
            sheetListed.forEach(row => {
                let id = row['代號'] || row['CB代號'] || row['股票代號'];
                if (id) listedSet.add(String(id).replace('.0','').trim());
            });
            console.log(`載入掛牌中清單: ${listedSet.size} 筆`);
        }

        // v3.59 新增：處理承銷進行中資料
        // v3.72 修改：動態建立pendingCases陣列供閃電帶入使用
        window.pendingIssueData = [];
        pendingCases = []; // 清空並重新建立

        if (sheetPending && sheetPending.length > 0) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            sheetPending.forEach(row => {
                const size = safeFloat(row['發行量']);
                if (size <= 0) return;

                // 基本資料
                const stockCode = String(row['股票代號'] || '').replace('.0', '').trim();
                const cbCode = String(row['標的代號'] || '').replace('.0', '').trim();
                const cbName = row['發行標的'] || '';
                const auctionType = row['詢圈/競拍'] || '';
                const broker = row['發行券商'] || '';
                const capital = safeFloat(row['股本']);
                const convPrice = safeFloat(row['轉換價']);
                const stockPrice = safeFloat(row['股價']);
                const yearsRaw = row['年期'] || '';
                const years = yearsRaw.toString().replace(/[^0-9]/g, '') || '3';

                // 處理TCRI/擔保欄位
                const tcriRaw = String(row['TCRI/擔保'] || '').trim();
                let guarantee = '無擔保';
                let rating = '';
                if (tcriRaw.toUpperCase().startsWith('TCRI')) {
                    // TCRI開頭 = 無擔保，數字是信評
                    guarantee = '無擔保';
                    const match = tcriRaw.match(/TCRI\s*(\d+)/i);
                    if (match) rating = match[1];
                } else if (tcriRaw) {
                    // 有銀行名稱 = 有擔保
                    guarantee = '有擔保';
                    rating = '';
                }

                // 處理承銷價格（可能是區間）
                const priceRaw = row['承銷價格'];
                let floorPrice = 100, highPrice = 100, isPriceRange = false;
                let priceIsDecimal = false; // v3.73 新增：判斷價格是否有小數（非整數=已成交）
                if (priceRaw) {
                    const priceStr = String(priceRaw);
                    if (priceStr.includes('~') || priceStr.includes('-')) {
                        const parts = priceStr.split(/[~-]/);
                        floorPrice = safeFloat(parts[0]) || 100;
                        highPrice = safeFloat(parts[1]) || floorPrice;
                        isPriceRange = floorPrice !== highPrice;
                    } else {
                        floorPrice = safeFloat(priceRaw) || 100;
                        highPrice = floorPrice;
                    }
                    // v3.73：檢查價格是否有小數（如101.55表示已成交）
                    priceIsDecimal = (floorPrice % 1 !== 0) || (highPrice % 1 !== 0);
                }

                // 處理投標期間
                const bidPeriodRaw = row['詢圈/投標期間'] || '';
                let bidPeriod = '', bidEndDate = '', openDate = '';
                if (bidPeriodRaw && bidPeriodRaw !== '未定') {
                    bidPeriod = bidPeriodRaw;
                    // 解析結束日期，格式如 "11/10-11/12" 或 "12/17-12/19"
                    const parts = bidPeriodRaw.split('-');
                    if (parts.length >= 2) {
                        const endPart = parts[1].trim();
                        const [endMonth, endDay] = endPart.split('/').map(Number);
                        if (endMonth && endDay) {
                            // v3.96 修正：更準確的年份判斷
                            // 如果結束月份 > 今天月份，則為今年
                            // 如果結束月份 < 今天月份，需要判斷是過去還是未來
                            // 如果結束月份 == 今天月份，比較日期
                            const currentMonth = today.getMonth() + 1;
                            const currentDay = today.getDate();
                            const currentYear = today.getFullYear();

                            let year;
                            if (endMonth > currentMonth) {
                                // 月份比今天大，是今年的未來日期
                                year = currentYear;
                            } else if (endMonth < currentMonth) {
                                // 月份比今天小，是今年已過去的日期（不是明年）
                                // 承銷中案件的時程不會跨年太遠，所以視為今年已過
                                year = currentYear;
                            } else {
                                // 同月份，比較日期
                                year = currentYear;
                            }

                            bidEndDate = `${year}-${String(endMonth).padStart(2, '0')}-${String(endDay).padStart(2, '0')}`;
                            // 開標日通常是截標後2個工作日
                            const endDateObj = new Date(bidEndDate);
                            endDateObj.setDate(endDateObj.getDate() + 2);
                            openDate = endDateObj.toISOString().split('T')[0];
                        }
                    }
                }

                // 處理掛牌日
                let listingDate = '';
                const listDateRaw = row['掛牌日'];
                if (listDateRaw && listDateRaw !== '未定') {
                    const d = parseExcelDate(listDateRaw);
                    if (d) {
                        listingDate = d.toISOString().split('T')[0];
                    }
                }

                // 判斷狀態
                // v3.73 修正：增加價格判斷（非整數=已成交=已開標結束）
                let status = 'pending';

                // 優先判斷：價格有小數點 = 已經開標結束（成交價）
                if (priceIsDecimal) {
                    status = 'opened';
                } else if (listingDate) {
                    const listDate = new Date(listingDate);
                    if (listDate <= today) {
                        status = 'listed';
                    } else if (openDate) {
                        const openDateObj = new Date(openDate);
                        if (openDateObj <= today) {
                            status = 'opened';
                        } else if (bidEndDate) {
                            const bidEndDateObj = new Date(bidEndDate);
                            if (bidEndDateObj < today) {
                                status = 'closed'; // 截標已過但還沒開標
                            } else if (bidPeriod) {
                                status = 'bidding';
                            }
                        }
                    }
                } else if (openDate) {
                    const openDateObj = new Date(openDate);
                    if (openDateObj <= today) {
                        status = 'opened';
                    } else if (bidEndDate) {
                        const bidEndDateObj = new Date(bidEndDate);
                        if (bidEndDateObj < today) {
                            status = 'closed';
                        } else if (bidPeriod) {
                            status = 'bidding';
                        }
                    }
                } else if (bidEndDate) {
                    // v3.73 新增：即使沒有開標日，如果截標日已過也算closed
                    const bidEndDateObj = new Date(bidEndDate);
                    if (bidEndDateObj < today) {
                        status = 'closed';
                    }
                }

                // 計算區間值
                const getSizeRange = (s) => {
                    if (s < 2) return '小於2億';
                    if (s < 5) return '2~5億';
                    if (s < 10) return '5~10億';
                    if (s < 15) return '10~15億';
                    if (s < 20) return '15~20億';
                    return '大於20億';
                };
                const getCapitalRange = (c) => {
                    if (c < 3) return '小於3億';
                    if (c < 6) return '3~6億';
                    if (c < 10) return '6~10億';
                    if (c < 15) return '10~15億';
                    if (c < 20) return '15~20億';
                    return '大於20億';
                };
                const getConvRange = (p) => {
                    if (p <= 0) return '';
                    if (p < 20) return '小於20元';
                    if (p < 50) return '20~50元';
                    if (p < 100) return '50~100元';
                    if (p < 150) return '100~150元';
                    if (p < 200) return '150~200元';
                    return '大於200元';
                };

                // v3.81 新增：計算理論價區間
                const getTheoRange = (stockP, convP) => {
                    if (stockP <= 0 || convP <= 0) return '';
                    const theo = (stockP / convP) * 100;
                    if (theo < 90) return '小於90元';
                    if (theo < 95) return '90~95元';
                    if (theo < 100) return '95~100元';
                    if (theo < 105) return '100~105元';
                    if (theo < 110) return '105~110元';
                    if (theo < 115) return '110~115元';
                    return '大於115元';
                };

                // 從產業對照表獲取產業
                const industry = window.industryMap[stockCode] || '其他';

                // 建立pendingCase物件
                const caseObj = {
                    stockCode: stockCode,
                    cbCode: cbCode,
                    cbName: cbName,
                    auctionType: auctionType,
                    industry: industry,
                    broker: broker,
                    issueSize: size,
                    sizeRange: getSizeRange(size),
                    capital: capital,
                    capitalRange: getCapitalRange(capital),
                    convPrice: convPrice,
                    convRange: getConvRange(convPrice),
                    theoRange: getTheoRange(stockPrice, convPrice),  // v3.81 新增
                    years: years,
                    guarantee: guarantee,
                    rating: rating,
                    floorPrice: floorPrice,
                    highPrice: highPrice,
                    isPriceRange: isPriceRange,
                    priceIsDecimal: priceIsDecimal, // v3.73 新增：價格是否為小數（成交價）
                    stockPrice: stockPrice,
                    bidPeriod: bidPeriod,
                    bidEndDate: bidEndDate,
                    openDate: openDate,
                    listingDate: listingDate,
                    status: status,
                    // v3.90 新增：競拍結果欄位（R、S、T、U欄位）
                    actualMinBid: safeFloat(row['最低得標'] || row['最低得標價格'] || row['R'] || 0),
                    actualAvgBid: safeFloat(row['加權均價'] || row['平均得標'] || row['S'] || 0),
                    actualBidMult: safeFloat(row['投標倍數'] || row['T'] || 0),
                    actualListPrice: safeFloat(row['掛牌價'] || row['U'] || 0)
                };

                pendingCases.push(caseObj);

                // 同時更新舊的pendingIssueData（保持相容性）
                window.pendingIssueData.push({
                    id: cbCode,
                    name: cbName,
                    type: auctionType,
                    size: size,
                    broker: broker,
                    rating: tcriRaw,
                    listDate: listingDate
                });
            });

            console.log(`載入閃電帶入資料: ${pendingCases.length} 筆`);
            console.log(`  - 已掛牌: ${pendingCases.filter(c => c.status === 'listed').length} 筆`);
            console.log(`  - 已開標: ${pendingCases.filter(c => c.status === 'opened').length} 筆`);
            console.log(`  - 已截標: ${pendingCases.filter(c => c.status === 'closed').length} 筆`);
            console.log(`  - 投標中: ${pendingCases.filter(c => c.status === 'bidding').length} 筆`);
            console.log(`  - 待公告: ${pendingCases.filter(c => c.status === 'pending').length} 筆`);
            console.log(`  - 競拍待投標: ${pendingCases.filter(c => (c.status === 'pending' || c.status === 'bidding') && c.auctionType === '競拍').length} 筆`);
        }

        // v3.59 新增：處理董事會決議資料
        window.boardApprovalData = [];
        if (sheetBoard && sheetBoard.length > 0) {
            sheetBoard.forEach(row => {
                const size = safeFloat(row['發行量']);
                if (size > 0) {
                    window.boardApprovalData.push({
                        id: row['CB代碼'] || row['股鰾代號'] || '',
                        name: row['發行標的'] || '',
                        type: row['詢圈/競價'] || '',
                        size: size,
                        broker: row['主辦券商'] || '',
                        rating: row['TCRI/擔保'] || '',
                        boardDate: row['董事會通過'] || ''
                    });
                }
            });
            console.log(`載入董事會決議: ${window.boardApprovalData.length} 筆, 總額 ${window.boardApprovalData.reduce((s,d)=>s+d.size,0).toFixed(1)} 億`);
        }

        // v3.61 新增：讀取CBAS報價表
        // v3.97-as-cb: sheetCBAS 已在上方 CSV/Excel 載入流程中處理
        window.cbasData = [];
        if (sheetCBAS && sheetCBAS.length > 0) {
            sheetCBAS.forEach(row => {
                const name = row['可轉債名稱'];
                const code = row['可轉債代碼'];
                if (!name || !code) return;

                const premium = safeFloat(row['權利金(佰元報價)']);
                const remainingYears = safeFloat(row['剩餘年期']);
                const discountRate = safeFloat(row['溢(折)價%']);
                const ratingRaw = row['擔保銀行/信用評等(TCRI)'] || '';

                // 判斷擔保類型：數字為TCRI無擔保，非數字為銀行有擔保
                const isGuaranteed = ratingRaw && !/^\d+$/.test(ratingRaw.trim());
                const guaranteeType = isGuaranteed ? 'guaranteed' : 'unguaranteed';
                const guaranteeDisplay = isGuaranteed ? ratingRaw : `TCRI ${ratingRaw}`;

                window.cbasData.push({
                    name: name,
                    code: String(code).replace('.0', ''),
                    rating: ratingRaw,
                    guaranteeType: guaranteeType,
                    guaranteeDisplay: guaranteeDisplay,
                    isGuaranteed: isGuaranteed,
                    premium: premium,
                    expiryDate: row['選擇權到期日'] || '',
                    sellbackPrice: safeFloat(row['賣回價格(A)']),
                    sellbackDate: row['賣回日期(B)'] || '',
                    remainingYears: remainingYears,
                    discountRateC: safeFloat(row['折現率(C)']),
                    premiumRef: safeFloat(row['權利金參考價']),
                    stockPrice: safeFloat(row['現股參考價']),
                    conversionPrice: safeFloat(row['轉換價格']),
                    cbConversionValue: safeFloat(row['CB轉換價值']),
                    cbRefPrice: safeFloat(row['CB參考價']),
                    discountPct: discountRate,
                    volatility120: safeFloat(row['股價波動率120天%']),
                    volatility240: safeFloat(row['股價波動率240天%']),
                    remainingRatio: safeFloat(row['流通餘額占發行總額%']),
                    issueAmount: safeFloat(row['原始發行量']),
                    industry: row['產業'] || ''
                });
            });
            const guaranteedCount = window.cbasData.filter(d => d.isGuaranteed).length;
            const unguaranteedCount = window.cbasData.filter(d => !d.isGuaranteed).length;
            console.log(`載入CBAS報價表: ${window.cbasData.length} 筆 (有擔保${guaranteedCount}筆, 無擔保${unguaranteedCount}筆)`);
        }

        // v3.61 新增：從01工作表建立CB補充資訊對照表（券商、股本）
        window.cbSupplementMap = {};
        if (sheetAllCB && sheetAllCB.length > 0) {
            sheetAllCB.forEach(row => {
                const rawId = row['CB代號'] || row['代號'];
                if (!rawId) return;
                const id = String(rawId).replace('.0', '').trim();
                window.cbSupplementMap[id] = {
                    broker: row['發行券商'] || row['承銷券商'] || row['主辦券商'] || '',
                    capital: safeFloat(row['股本大小']) || safeFloat(row['股本']) || safeFloat(row['股本(億)']) || safeFloat(row['股本(億元)']),
                    issueSize: safeFloat(row['發行規模']) || safeFloat(row['發行總額'])
                };
            });
            console.log(`建立CB補充資訊對照表: ${Object.keys(window.cbSupplementMap).length} 筆`);

            // 補充CBAS資料的券商和股本資訊
            if (window.cbasData && window.cbasData.length > 0) {
                let supplemented = 0;
                window.cbasData.forEach(item => {
                    const supplement = window.cbSupplementMap[item.code];
                    if (supplement) {
                        item.broker = supplement.broker;
                        item.capital = supplement.capital;
                        if (!item.issueAmount || item.issueAmount <= 0) {
                            item.issueAmount = supplement.issueSize;
                        }
                        supplemented++;
                    }
                });
                console.log(`CBAS資料補充完成: ${supplemented} 筆有補充券商/股本資訊`);
            }
        }

        // 建立掛牌高低對照表（設為全域變數以供基本資料查詢）
        window.highLowMap = {};
        if (sheetHighLow && sheetHighLow.length > 0) {
            sheetHighLow.forEach(row => {
                let id = row['代號'] || row['CB代號'] || row['股票代號'];
                if(id) window.highLowMap[String(id).replace('.0','').trim()] = row;
            });
        }
        const highLowMap = window.highLowMap; // 保持向下兼容

        // 讀取詢圈資料 (從01工作表)
        if (sheetAllCB && sheetAllCB.length > 0) {
            inquiryRawData = sheetAllCB.filter(row => {
                const type = row['詢圈競拍'] || '';
                return type.includes('詢圈');
            }).map(row => {
                let rawId = row['CB代號'] || row['代號'];
                if (!rawId) return null;
                const id = String(rawId).replace('.0','').trim();
                const hlRow = highLowMap[id] || {};

                // v3.92 修正：處理信評格式
                // 01工作表E欄「信用評等」：純數字(如6)=TCRI分數，銀行名稱=有擔保
                let normalizedRating = '';
                let guaranteeFromRating = '';

                // 優先從01工作表的「信用評等」欄位讀取
                let rawRating = row['信用評等'] || row['信評'] || row['TCRI/擔保'] || '';
                rawRating = String(rawRating).trim();

                if (rawRating) {
                    // 如果是1-8的純數字，就是TCRI分數（無擔保）
                    if (rawRating.match(/^[1-8]$/)) {
                        normalizedRating = rawRating;
                    } else if (rawRating.match(/^\d+$/)) {
                        // 其他數字也當作信評
                        normalizedRating = rawRating;
                    } else if (rawRating.toUpperCase().startsWith('TCRI')) {
                        // TCRI格式
                        const match = rawRating.match(/TCRI\s*(\d+)/i);
                        if (match) normalizedRating = match[1];
                    } else {
                        // 非數字（銀行名稱）= 有擔保
                        guaranteeFromRating = '有擔保';
                    }
                }

                // 如果00工作表有信評資料，優先使用
                const hlRating = hlRow['信用評等'] || hlRow['信評'] || '';
                if (hlRating && String(hlRating).match(/^[1-8]$/)) {
                    normalizedRating = String(hlRating).trim();
                }

                // 擔保判斷
                let guarantee = getSmartValue(row, 'guarantee') || row['擔保'] || row['有無擔保'] || guaranteeFromRating || '';

                return {
                    'id': id,
                    'name': getSmartValue(row, 'name') || row['名稱'] || '',
                    'companyName': row['公司名稱'] || row['公司'] || '',  // v3.96 新增：保存公司名稱用於KY股判斷
                    'industry': getSmartValue(row, 'industry') || row['產業分類'] || '',
                    'broker': getSmartValue(row, 'broker') || row['發行券商'] || row['承銷券商'] || '',
                    'guarantee': guarantee,
                    'rating': normalizedRating,
                    'capital': safeFloat(row['股本大小']) || safeFloat(getSmartValue(row, 'capital')),
                    'issueSize': safeFloat(row['發行規模']) || safeFloat(getSmartValue(row, 'issueSize')),
                    'years': safeFloat(row['發行年期']) || safeFloat(getSmartValue(row, 'years')),
                    'conversionPrice': safeFloat(row['轉換價格']) || safeFloat(getSmartValue(row, 'conversionPrice')),
                    'marketHigh': safeFloat(hlRow['掛牌最高']) || safeFloat(row['掛牌最高']) || 0,
                    'marketLow': safeFloat(hlRow['掛牌最低']) || safeFloat(row['掛牌最低']) || 0,
                    'premiumRate': safeFloat(row['訂價溢價率']) || safeFloat(getSmartValue(row, 'premiumRate')),
                    'listDate': row['掛牌日期'] || null,
                    'type': '詢圈'
                };
            }).filter(item => item !== null);

            console.log(`載入詢圈資料: ${inquiryRawData.length} 筆`);
            // 除錯：檢查詢圈資料
            const withCapital = inquiryRawData.filter(d => d.capital > 0);
            const withMarket = inquiryRawData.filter(d => d.marketHigh > 0 && d.marketLow > 0);
            console.log(`詢圈資料中有股本數據: ${withCapital.length} 筆`);
            console.log(`詢圈資料中有掛牌數據: ${withMarket.length} 筆`);
            console.log(`00工作表(highLowMap)筆數: ${Object.keys(highLowMap).length}`);
            if (withCapital.length > 0) {
                console.log('詢圈範例(含股本):', withCapital.slice(0, 3).map(d => ({
                    id: d.id,
                    name: d.name,
                    capital: d.capital,
                    marketHigh: d.marketHigh,
                    marketLow: d.marketLow
                })));
            }
            // 檢查 highLowMap 範例
            const hlKeys = Object.keys(highLowMap).slice(0, 3);
            console.log('highLowMap範例:', hlKeys.map(k => ({
                id: k,
                high: highLowMap[k]['掛牌最高'] || highLowMap[k]['掛牌最高價'],
                low: highLowMap[k]['掛牌最低'] || highLowMap[k]['掛牌最低價']
            })));
        }

        auctionRawData = sheetAuction.map(row => {
            let rawId = row['CB代號'] || row['代號'];
            if (!rawId) return null;

            const id = String(rawId).replace('.0','').trim();
            const hlRow = highLowMap[id] || {};

            // 處理信評格式：優先從00工作表(hlRow)讀取，再從04工作表I欄讀取
            let rawRating = hlRow['信用評等'] || hlRow['信評'] || getSmartValue(row, 'rating') || '';
            let normalizedRating = '';
            if (rawRating) {
                rawRating = String(rawRating).trim();
                // 如果已經是1-8的純數字，直接使用
                if (rawRating.match(/^[1-8]$/)) {
                    normalizedRating = rawRating;
                } else {
                    const match = rawRating.match(/TCRI\s*(\d+)/i);
                    if (match) {
                        normalizedRating = match[1];
                    } else if (rawRating.match(/^\d+$/)) {
                        normalizedRating = rawRating; // 已經是數字
                    } else if (rawRating.toUpperCase().includes('BBB')) {
                        normalizedRating = 'BBB';
                    } else {
                        normalizedRating = rawRating;
                    }
                }
            }

            return {
                'id': id,
                'stockId': getSmartValue(row, 'stockId'),
                'name': getSmartValue(row, 'name'),
                'companyName': row['公司名稱'] || row['公司'] || '',  // v3.96 新增：保存公司名稱用於KY股判斷
                'openDate': getSmartValue(row, 'openDate'),  // v3.96 修正：保留原始日期格式供後續解析
                'openDateStr': formatDate(getSmartValue(row, 'openDate')),  // 格式化字串用於顯示
                'industry': getSmartValue(row, 'industry'),
                'broker': getSmartValue(row, 'broker'),
                'guarantee': getSmartValue(row, 'guarantee'),
                'rating': normalizedRating,
                'capital': safeFloat(getSmartValue(row, 'capital')),
                'issueSize': safeFloat(getSmartValue(row, 'issueSize')),
                'years': safeFloat(getSmartValue(row, 'years')),
                'conversionPrice': safeFloat(getSmartValue(row, 'conversionPrice')),
                'closePrice': safeFloat(getSmartValue(row, 'closePrice')),
                'theoreticalPrice': safeFloat(getSmartValue(row, 'theoreticalPrice')),
                'floorPrice': safeFloat(getSmartValue(row, 'floorPrice')),
                'premiumRate': getSmartValue(row, 'premiumRate'),
                'minBidPrice': safeFloat(getSmartValue(row, 'minBidPrice')),
                'avgBidPrice': safeFloat(getSmartValue(row, 'avgBidPrice')),
                'lowPremium': normalizePremium(getSmartValue(row, 'lowPremium')),
                'avgPremium': normalizePremium(getSmartValue(row, 'avgPremium')),
                'marketHigh': safeFloat(getSmartValue(hlRow, 'marketHigh')) || safeFloat(getSmartValue(row, 'marketHigh')),
                'marketLow': safeFloat(getSmartValue(hlRow, 'marketLow')) || safeFloat(getSmartValue(row, 'marketLow')),
                'qualifiedCount': safeFloat(getSmartValue(row, 'qualifiedCount')),
                'bidShares': safeFloat(getSmartValue(row, 'bidShares')),
                'bidMultiple': safeFloat(getSmartValue(row, 'bidMultiple')),
                'avgBidShares': safeFloat(getSmartValue(row, 'avgBidShares')),
                'auctionShares': safeFloat(getSmartValue(row, 'auctionShares'))
            };
        }).filter(item => item !== null);

        auctionRawData.forEach(item => {
            if (item.name) {
                cbDatabase[item.name] = item;
                cbNameMap[item.name] = item;
            }
        });

        autoGenerateStatistics();
        calculateGlobalMarketStats();
        initializeUI();

        // v3.70 新增：初始化市場氛圍面板
        if (typeof updateAtmospherePanel === 'function') {
            updateAtmospherePanel();
        }

        loadingDiv.style.display = 'none';
        document.querySelector('.container').style.display = 'block';

        // v3.97-zs-bp: 完全移除背景預載入
        // 所有額外資料（yuanta、kanban）都改為用戶點擊時才載入
        // 這樣可以大幅改善啟動速度
    } catch (error) {
        console.error(error);
        loadingDiv.innerHTML = `<div style="padding:20px;background:white;color:#D32F2F;border-radius:10px;text-align:center;max-width:400px;">
        <h3>⚠️ 系統啟動失敗</h3><p style="margin:10px 0;">${error.message}</p>
        <button onclick="location.reload()" style="padding:8px 20px;cursor:pointer;">重試</button></div>`;
    }
}

// ==========================================
// 3. 統計核心
// ==========================================
function autoGenerateStatistics() {
    statistics['維度統計']['產業'] = {};
    statistics['維度統計']['發行券商'] = {};
    auctionRawData.forEach(row => {
        if (row.industry) updateStatCategory('產業', row.industry, row);
        if (row.broker) updateStatCategory('發行券商', row.broker, row);
    });

    ['產業', '發行券商'].forEach(cat => {
        Object.keys(statistics['維度統計'][cat]).forEach(key => {
            const item = statistics['維度統計'][cat][key];
            if (item.count > 0) {
                item['平均最低溢價'] = item.sumLowPrem / item.count;
                item['平均溢價'] = item.sumAvgPrem / item.count;
                item['平均最低得標價'] = item.sumLowPrice / item.count;
                item['平均得標價'] = item.sumAvgPrice / item.count;
                item['平均掛牌最高'] = item.countMarket > 0 ? item.sumHigh / item.countMarket : 0;
                item['平均掛牌最低'] = item.countMarket > 0 ? item.sumLow / item.countMarket : 0;
                item['樣本數'] = item.count;
            }
        });
    });
}

function updateStatCategory(category, key, row) {
    if (!statistics['維度統計'][category][key]) {
        statistics['維度統計'][category][key] = { count: 0, sumLowPrem: 0, sumAvgPrem: 0, sumLowPrice: 0, sumAvgPrice: 0, sumHigh: 0, sumLow: 0, countMarket: 0 };
    }
    const obj = statistics['維度統計'][category][key];
    if (row.minBidPrice > 0 || row.avgBidPrice > 0) {
        obj.count++;
        obj.sumLowPrem += row.lowPremium;
        obj.sumAvgPrem += row.avgPremium;
        obj.sumLowPrice += row.minBidPrice;
        obj.sumAvgPrice += row.avgBidPrice;
    }
    if (row.marketHigh > 0 && row.marketLow > 0) {
        obj.sumHigh += row.marketHigh;
        obj.sumLow += row.marketLow;
        obj.countMarket++;
    }
}

function calculateGlobalMarketStats() {
    let sumLow = 0, sumAvg = 0, count = 0;
    auctionRawData.forEach(d => {
        if (d.minBidPrice > 0) {
            sumLow += d.lowPremium;
            sumAvg += d.avgPremium;
            count++;
        }
    });
    if (count > 0) {
        globalMarketStats.low = sumLow / count;
        globalMarketStats.avg = sumAvg / count;
    }
}

// v3.52 修改：增加排除前三高的統計 + 擔保類型細分統計
function getStatsSmart(category, val) {
    let stats = {
        low: 0,
        avg: 0,
        usedFallback: false,
        rawData: null,
        inquiryData: null,
        excludeTop3Data: null,
        excludeTop3InquiryData: null,
        // v3.52 新增：依擔保類型細分
        guaranteedAuctionData: null,
        guaranteedInquiryData: null,
        unguaranteedAuctionData: null,
        unguaranteedInquiryData: null
    };
    let filterFn = null;
    let rangeLabel = "";

    // v3.69 修改：支援區間選擇（字串格式）
    if (category === '股本') {
        rangeLabel = val;
        if (val === '小於3億') { filterFn = d => d.capital > 0 && d.capital < 3; }
        else if (val === '3~6億') { filterFn = d => d.capital >= 3 && d.capital < 6; }
        else if (val === '6~10億') { filterFn = d => d.capital >= 6 && d.capital < 10; }
        else if (val === '10~15億') { filterFn = d => d.capital >= 10 && d.capital < 15; }
        else if (val === '15~20億') { filterFn = d => d.capital >= 15 && d.capital < 20; }
        else if (val === '大於20億') { filterFn = d => d.capital >= 20; }
        // 向下相容：如果是數值則用舊邏輯
        else {
            const v = parseFloat(val);
            if (!isNaN(v)) {
                if (v < 3) { rangeLabel = "< 3 億"; filterFn = d => d.capital > 0 && d.capital < 3; }
                else if (v < 6) { rangeLabel = "3~6 億"; filterFn = d => d.capital >= 3 && d.capital < 6; }
                else if (v < 10) { rangeLabel = "6~10 億"; filterFn = d => d.capital >= 6 && d.capital < 10; }
                else if (v < 15) { rangeLabel = "10~15 億"; filterFn = d => d.capital >= 10 && d.capital < 15; }
                else if (v < 20) { rangeLabel = "15~20 億"; filterFn = d => d.capital >= 15 && d.capital < 20; }
                else { rangeLabel = "> 20 億"; filterFn = d => d.capital >= 20; }
            }
        }
    }
    else if (category === '發行規模') {
        rangeLabel = val;
        if (val === '小於2億') { filterFn = d => d.issueSize > 0 && d.issueSize < 2; }
        else if (val === '2~5億') { filterFn = d => d.issueSize >= 2 && d.issueSize < 5; }
        else if (val === '5~10億') { filterFn = d => d.issueSize >= 5 && d.issueSize < 10; }
        else if (val === '10~15億') { filterFn = d => d.issueSize >= 10 && d.issueSize < 15; }
        else if (val === '15~20億') { filterFn = d => d.issueSize >= 15 && d.issueSize < 20; }
        else if (val === '大於20億') { filterFn = d => d.issueSize >= 20; }
        // 向下相容
        else {
            const v = parseFloat(val);
            if (!isNaN(v)) {
                if (v < 2) { rangeLabel = "< 2 億"; filterFn = d => d.issueSize < 2; }
                else if (v < 5) { rangeLabel = "2~5 億"; filterFn = d => d.issueSize >= 2 && d.issueSize < 5; }
                else if (v < 10) { rangeLabel = "5~10 億"; filterFn = d => d.issueSize >= 5 && d.issueSize < 10; }
                else if (v < 15) { rangeLabel = "10~15 億"; filterFn = d => d.issueSize >= 10 && d.issueSize < 15; }
                else if (v < 20) { rangeLabel = "15~20 億"; filterFn = d => d.issueSize >= 15 && d.issueSize < 20; }
                else { rangeLabel = "> 20 億"; filterFn = d => d.issueSize >= 20; }
            }
        }
    }
    else if (category === '轉換價') {
        rangeLabel = val;
        if (val === '小於20元') { filterFn = d => d.conversionPrice > 0 && d.conversionPrice < 20; }
        else if (val === '20~50元') { filterFn = d => d.conversionPrice >= 20 && d.conversionPrice < 50; }
        else if (val === '50~100元') { filterFn = d => d.conversionPrice >= 50 && d.conversionPrice < 100; }
        else if (val === '100~150元') { filterFn = d => d.conversionPrice >= 100 && d.conversionPrice < 150; }
        else if (val === '150~200元') { filterFn = d => d.conversionPrice >= 150 && d.conversionPrice < 200; }
        else if (val === '大於200元') { filterFn = d => d.conversionPrice >= 200; }
        // 向下相容
        else {
            const v = parseFloat(val);
            if (!isNaN(v)) {
                if (v < 20) { rangeLabel = "< 20 元"; filterFn = d => d.conversionPrice < 20; }
                else if (v < 50) { rangeLabel = "20~50 元"; filterFn = d => d.conversionPrice >= 20 && d.conversionPrice < 50; }
                else if (v < 100) { rangeLabel = "50~100 元"; filterFn = d => d.conversionPrice >= 50 && d.conversionPrice < 100; }
                else if (v < 150) { rangeLabel = "100~150 元"; filterFn = d => d.conversionPrice >= 100 && d.conversionPrice < 150; }
                else if (v < 200) { rangeLabel = "150~200 元"; filterFn = d => d.conversionPrice >= 150 && d.conversionPrice < 200; }
                else { rangeLabel = "> 200 元"; filterFn = d => d.conversionPrice >= 200; }
            }
        }
    }
    // v3.72 新增：理論價區間（最重要的維度）
    else if (category === '理論價') {
        rangeLabel = val;
        if (val === '小於90元') { filterFn = d => d.theoreticalPrice > 0 && d.theoreticalPrice < 90; }
        else if (val === '90~95元') { filterFn = d => d.theoreticalPrice >= 90 && d.theoreticalPrice < 95; }
        else if (val === '95~100元') { filterFn = d => d.theoreticalPrice >= 95 && d.theoreticalPrice < 100; }
        else if (val === '100~105元') { filterFn = d => d.theoreticalPrice >= 100 && d.theoreticalPrice < 105; }
        else if (val === '105~110元') { filterFn = d => d.theoreticalPrice >= 105 && d.theoreticalPrice < 110; }
        else if (val === '110~115元') { filterFn = d => d.theoreticalPrice >= 110 && d.theoreticalPrice < 115; }
        else if (val === '大於115元') { filterFn = d => d.theoreticalPrice >= 115; }
        // 向下相容：如果是數值則用舊邏輯
        else {
            const v = parseFloat(val);
            if (!isNaN(v)) {
                if (v < 90) { rangeLabel = "< 90 元"; filterFn = d => d.theoreticalPrice > 0 && d.theoreticalPrice < 90; }
                else if (v < 95) { rangeLabel = "90~95 元"; filterFn = d => d.theoreticalPrice >= 90 && d.theoreticalPrice < 95; }
                else if (v < 100) { rangeLabel = "95~100 元"; filterFn = d => d.theoreticalPrice >= 95 && d.theoreticalPrice < 100; }
                else if (v < 105) { rangeLabel = "100~105 元"; filterFn = d => d.theoreticalPrice >= 100 && d.theoreticalPrice < 105; }
                else if (v < 110) { rangeLabel = "105~110 元"; filterFn = d => d.theoreticalPrice >= 105 && d.theoreticalPrice < 110; }
                else if (v < 115) { rangeLabel = "110~115 元"; filterFn = d => d.theoreticalPrice >= 110 && d.theoreticalPrice < 115; }
                else { rangeLabel = "> 115 元"; filterFn = d => d.theoreticalPrice >= 115; }
            }
        }
    }
    else {
        const safeVal = String(val || "");
        if (safeVal === "") return stats;

        if (category === '發行券商') filterFn = d => (d.broker || '').includes(safeVal) || safeVal.includes(d.broker || '');
        else if (category === '產業') filterFn = d => industryMatches(d.industry, safeVal);
        else if (category === '擔保') filterFn = d => (d.guarantee || '').includes(safeVal);
        else if (category === '年期') filterFn = d => d.years == safeVal;
        else if (category === '信評') {
            // 信評比對：用戶選 "5" 要能比對到 rating 為 "5" 或 "TCRI5" 的資料
            filterFn = d => {
                const rating = (d.rating || '').toString().trim();
                if (!rating) return false;
                // 精確比對數字
                if (rating === safeVal) return true;
                // 比對 TCRI 格式
                if (rating.toUpperCase() === 'TCRI' + safeVal) return true;
                // BBB 特殊處理
                if (safeVal === 'BBB' && rating.toUpperCase().includes('BBB')) return true;
                return false;
            };
        }
    }

    if (filterFn) {
        // === 競拍數據統計（全部）===
        const auctionFiltered = auctionRawData.filter(filterFn);
        let sumLowP = 0, sumAvgP = 0, sumLowPr = 0, sumAvgPr = 0, sumH = 0, sumL = 0, countM = 0, count = 0;

        auctionFiltered.forEach(d => {
            if (d.minBidPrice > 0 || d.avgBidPrice > 0) {
                sumLowP += d.lowPremium; sumAvgP += d.avgPremium;
                sumLowPr += d.minBidPrice; sumAvgPr += d.avgBidPrice;
                count++;
            }
            if (d.marketHigh > 0 && d.marketLow > 0) {
                sumH += d.marketHigh; sumL += d.marketLow; countM++;
            }
        });

        if (count > 0) {
            stats.rawData = {
                '平均最低溢價': sumLowP / count,
                '平均溢價': sumAvgP / count,
                '平均最低得標價': sumLowPr / count,
                '平均得標價': sumAvgPr / count,
                '平均掛牌最高': countM > 0 ? sumH / countM : 0,
                '平均掛牌最低': countM > 0 ? sumL / countM : 0,
                '樣本數': count
            };
            if(rangeLabel) stats.rawData['區間名稱'] = rangeLabel;
            stats.low = stats.rawData['平均最低溢價'];
            stats.avg = stats.rawData['平均溢價'];
        }

        // === v3.52 新增：競拍排除前三高的計算 ===
        const auctionWithMarket = auctionFiltered.filter(d => d.marketHigh > 0 && d.marketLow > 0);
        if (auctionWithMarket.length > 3) {
            // 按掛牌最高排序，排除前三名
            const sortedAuction = [...auctionWithMarket].sort((a, b) => b.marketHigh - a.marketHigh);
            const excludedAuction = sortedAuction.slice(3);

            let exSumH = 0, exSumL = 0;
            excludedAuction.forEach(d => {
                exSumH += d.marketHigh;
                exSumL += d.marketLow;
            });

            stats.excludeTop3Data = {
                '平均掛牌最高': exSumH / excludedAuction.length,
                '平均掛牌最低': exSumL / excludedAuction.length,
                '樣本數': excludedAuction.length
            };
        }

        // === 詢圈數據統計（全部）===
        const inquiryFiltered = inquiryRawData.filter(filterFn);
        console.log(`[${category}=${val}] 詢圈篩選結果: ${inquiryFiltered.length} 筆 (原始: ${inquiryRawData.length} 筆)`);

        let iSumH = 0, iSumL = 0, iCountM = 0;

        inquiryFiltered.forEach(d => {
            if (d.marketHigh > 0 && d.marketLow > 0) {
                iSumH += d.marketHigh; iSumL += d.marketLow; iCountM++;
            }
        });

        console.log(`[${category}=${val}] 詢圈有掛牌數據: ${iCountM} 筆`);

        if (iCountM > 0) {
            stats.inquiryData = {
                '平均掛牌最高': iSumH / iCountM,
                '平均掛牌最低': iSumL / iCountM,
                '樣本數': iCountM
            };
        }

        // === v3.52 新增：詢圈排除前三高的計算 ===
        const inquiryWithMarket = inquiryFiltered.filter(d => d.marketHigh > 0 && d.marketLow > 0);
        if (inquiryWithMarket.length > 3) {
            const sortedInquiry = [...inquiryWithMarket].sort((a, b) => b.marketHigh - a.marketHigh);
            const excludedInquiry = sortedInquiry.slice(3);

            let exISumH = 0, exISumL = 0;
            excludedInquiry.forEach(d => {
                exISumH += d.marketHigh;
                exISumL += d.marketLow;
            });

            stats.excludeTop3InquiryData = {
                '平均掛牌最高': exISumH / excludedInquiry.length,
                '平均掛牌最低': exISumL / excludedInquiry.length,
                '樣本數': excludedInquiry.length
            };
        }

        // === v3.53 修改：依擔保類型細分統計（含得標數據）===
        // 有擔保 - 競拍
        const guaranteedAuction = auctionFiltered.filter(d => (d.guarantee || '').includes('有'));
        if (guaranteedAuction.length > 0) {
            let gaSumH = 0, gaSumL = 0, gaCountM = 0;
            let gaSumLowP = 0, gaSumAvgP = 0, gaSumLowPr = 0, gaSumAvgPr = 0, gaCountBid = 0;
            guaranteedAuction.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    gaSumH += d.marketHigh;
                    gaSumL += d.marketLow;
                    gaCountM++;
                }
                if (d.minBidPrice > 0 || d.avgBidPrice > 0) {
                    gaSumLowP += d.lowPremium;
                    gaSumAvgP += d.avgPremium;
                    gaSumLowPr += d.minBidPrice;
                    gaSumAvgPr += d.avgBidPrice;
                    gaCountBid++;
                }
            });
            stats.guaranteedAuctionData = {
                '平均掛牌最高': gaCountM > 0 ? gaSumH / gaCountM : 0,
                '平均掛牌最低': gaCountM > 0 ? gaSumL / gaCountM : 0,
                '樣本數': gaCountM,
                '平均最低得標價': gaCountBid > 0 ? gaSumLowPr / gaCountBid : 0,
                '平均最低溢價': gaCountBid > 0 ? gaSumLowP / gaCountBid : 0,
                '平均得標價': gaCountBid > 0 ? gaSumAvgPr / gaCountBid : 0,
                '平均溢價': gaCountBid > 0 ? gaSumAvgP / gaCountBid : 0,
                '得標樣本數': gaCountBid
            };
        }

        // 有擔保 - 詢圈
        const guaranteedInquiry = inquiryFiltered.filter(d => (d.guarantee || '').includes('有'));
        if (guaranteedInquiry.length > 0) {
            let giSumH = 0, giSumL = 0, giCountM = 0;
            guaranteedInquiry.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    giSumH += d.marketHigh;
                    giSumL += d.marketLow;
                    giCountM++;
                }
            });
            if (giCountM > 0) {
                stats.guaranteedInquiryData = {
                    '平均掛牌最高': giSumH / giCountM,
                    '平均掛牌最低': giSumL / giCountM,
                    '樣本數': giCountM
                };
            }
        }

        // 無擔保 - 競拍
        const unguaranteedAuction = auctionFiltered.filter(d => (d.guarantee || '').includes('無'));
        if (unguaranteedAuction.length > 0) {
            let uaSumH = 0, uaSumL = 0, uaCountM = 0;
            let uaSumLowP = 0, uaSumAvgP = 0, uaSumLowPr = 0, uaSumAvgPr = 0, uaCountBid = 0;
            unguaranteedAuction.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    uaSumH += d.marketHigh;
                    uaSumL += d.marketLow;
                    uaCountM++;
                }
                if (d.minBidPrice > 0 || d.avgBidPrice > 0) {
                    uaSumLowP += d.lowPremium;
                    uaSumAvgP += d.avgPremium;
                    uaSumLowPr += d.minBidPrice;
                    uaSumAvgPr += d.avgBidPrice;
                    uaCountBid++;
                }
            });
            stats.unguaranteedAuctionData = {
                '平均掛牌最高': uaCountM > 0 ? uaSumH / uaCountM : 0,
                '平均掛牌最低': uaCountM > 0 ? uaSumL / uaCountM : 0,
                '樣本數': uaCountM,
                '平均最低得標價': uaCountBid > 0 ? uaSumLowPr / uaCountBid : 0,
                '平均最低溢價': uaCountBid > 0 ? uaSumLowP / uaCountBid : 0,
                '平均得標價': uaCountBid > 0 ? uaSumAvgPr / uaCountBid : 0,
                '平均溢價': uaCountBid > 0 ? uaSumAvgP / uaCountBid : 0,
                '得標樣本數': uaCountBid
            };
        }

        // 無擔保 - 詢圈
        const unguaranteedInquiry = inquiryFiltered.filter(d => (d.guarantee || '').includes('無'));
        if (unguaranteedInquiry.length > 0) {
            let uiSumH = 0, uiSumL = 0, uiCountM = 0;
            unguaranteedInquiry.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    uiSumH += d.marketHigh;
                    uiSumL += d.marketLow;
                    uiCountM++;
                }
            });
            if (uiCountM > 0) {
                stats.unguaranteedInquiryData = {
                    '平均掛牌最高': uiSumH / uiCountM,
                    '平均掛牌最低': uiSumL / uiCountM,
                    '樣本數': uiCountM
                };
            }
        }
    }

    if (stats.low === 0 && (!stats.rawData || stats.rawData['平均得標價'] === 0)) {
        if (statistics['維度統計'][category] && statistics['維度統計'][category][val]) {
            stats.rawData = statistics['維度統計'][category][val];
            stats.low = safeFloat(stats.rawData['平均最低溢價']);
            stats.avg = safeFloat(stats.rawData['平均溢價']);
        }

        if (stats.low === 0 || isNaN(stats.low)) {
            stats.low = globalMarketStats.low;
            stats.avg = globalMarketStats.avg;
            stats.usedFallback = true;
            if(!stats.rawData) stats.rawData = { '平均最低溢價': stats.low, '平均溢價': stats.avg, '樣本數': '全市場' };
        }
    }
    return stats;
}

// ==========================================
// 4. UI 顯示
// ==========================================

// v3.62 強化版：歷史搜尋卡片生成（加入CB收盤價）
function generateHistoryCard(d) {
    const h = safeFloat(d.marketHigh);
    const l = safeFloat(d.marketLow);
    const amp = (h > 0 && l > 0) ? ((h - l) / l * 100).toFixed(1) : '-';

    const premium = safeFloat(d.premiumRate);
    const premiumStr = premium > 0 ? (premium < 2 ? (premium * 100).toFixed(1) : premium.toFixed(1)) : '-';

    let guarantee = d.guarantee || '-';
    if (guarantee.includes('有')) guarantee = '有';
    else if (guarantee.includes('無')) guarantee = '無';

    // v3.62 新增：取得CB收盤價
    const cbClosePrice = window.cbClosePriceMap ? window.cbClosePriceMap[d.id] : null;
    const cbClosePriceStr = cbClosePrice > 0 ? safeFixed(cbClosePrice, 2) : '-';

    return `
    <div class="history-card">
        <div class="hc-header">
            <span class="hc-badge">競拍</span>
            <span class="hc-name">${d.name || '-'} (${d.id})</span>
            <span class="hc-date">${formatDate(d.openDate)}</span>
        </div>

        <div class="hc-line">
            <span class="hc-info">產業:<b>${d.industry || '-'}</b></span>
            <span class="hc-info">規模:<b>${d.issueSize > 0 ? d.issueSize + '億' : '-'}</b></span>
            <span class="hc-info">年期:<b>${d.years > 0 ? d.years + '年' : '-'}</b></span>
            <span class="hc-info">擔保:<b>${guarantee}</b></span>
            <span class="hc-info">信評:<b>${d.rating || '-'}</b></span>
            <span class="hc-info">券商:<b>${d.broker || '-'}</b></span>
            <span class="hc-info">底標:<b>${d.floorPrice > 0 ? Math.round(d.floorPrice) : '-'}</b></span>
            <span class="hc-info">溢價率:<b class="pink">${premiumStr}%</b></span>
        </div>

        <div class="hc-line">
            <span class="hc-info">轉換價:<b>${d.conversionPrice > 0 ? safeFixed(d.conversionPrice,1) : '-'}</b></span>
            <span class="hc-info">截標收盤:<b>${d.closePrice > 0 ? safeFixed(d.closePrice,1) : '-'}</b></span>
            <span class="hc-info">理論價:<b style="color:#1565c0">${d.theoreticalPrice > 0 ? safeFixed(d.theoreticalPrice,2) : '-'}</b></span>
            <span class="hc-info">競拍張數:<b>${d.auctionShares > 0 ? d.auctionShares.toLocaleString() : '-'}</b></span>
            <span class="hc-info">投標張數:<b>${d.bidShares > 0 ? d.bidShares.toLocaleString() : '-'}</b></span>
            <span class="hc-info">投標倍數:<b style="color:#d32f2f">${d.bidMultiple > 0 ? safeFixed(d.bidMultiple, 2) + 'x' : '-'}</b></span>
        </div>

        <table class="hc-table">
            <tr>
                <th></th><th>得標價</th><th>溢價率</th><th></th><th>掛牌價</th><th>振幅</th><th>CB收盤</th>
            </tr>
            <tr>
                <td class="td-label">最低</td>
                <td>${d.minBidPrice > 0 ? safeFixed(d.minBidPrice, 2) : '-'}</td>
                <td class="val-red">${d.lowPremium !== 0 ? safeFixed(d.lowPremium, 2) + '%' : '-'}</td>
                <td class="td-label">高</td>
                <td>${h > 0 ? safeFixed(h, 1) : '-'}</td>
                <td class="val-pink" rowspan="2">${amp}%</td>
                <td rowspan="2" style="color:#1565c0; font-weight:700; font-size:11px;">${cbClosePriceStr}</td>
            </tr>
            <tr>
                <td class="td-label">平均</td>
                <td>${d.avgBidPrice > 0 ? safeFixed(d.avgBidPrice, 2) : '-'}</td>
                <td class="val-red">${d.avgPremium !== 0 ? safeFixed(d.avgPremium, 2) + '%' : '-'}</td>
                <td class="td-label">低</td>
                <td>${l > 0 ? safeFixed(l, 1) : '-'}</td>
            </tr>
        </table>
    </div>
    `;
}

// v3.92 新增：詢圈歷史卡片生成函數（淡藍色風格）
function generateInquiryCard(d) {
    const h = safeFloat(d.marketHigh);
    const l = safeFloat(d.marketLow);
    const amp = (h > 0 && l > 0) ? ((h - l) / l * 100).toFixed(1) : '-';

    let guarantee = '-';
    if (d.guarantee) {
        guarantee = d.guarantee.includes('有') ? '有擔保' : (d.guarantee.includes('無') ? '無擔保' : d.guarantee);
    }

    // v3.62 新增：取得CB收盤價
    const cbClosePrice = window.cbClosePriceMap ? window.cbClosePriceMap[d.id] : null;
    const cbClosePriceStr = cbClosePrice > 0 ? safeFixed(cbClosePrice, 2) : '-';

    // 取得掛牌日期
    let listDateStr = '-';
    if (d.listDate) {
        listDateStr = formatDate(d.listDate);
    }

    return `
    <div class="inquiry-card">
        <div class="hc-header">
            <span class="hc-badge">詢圈</span>
            <span class="hc-name">${d.name || '-'} (${d.id})</span>
            <span class="hc-date" style="color:#1976d2; font-size:11px;">${listDateStr}</span>
        </div>

        <div class="hc-line">
            <span class="hc-info">產業:<b>${d.industry || '-'}</b></span>
            <span class="hc-info">規模:<b>${d.issueSize > 0 ? d.issueSize + '億' : '-'}</b></span>
            <span class="hc-info">年期:<b>${d.years > 0 ? d.years + '年' : '-'}</b></span>
            <span class="hc-info">擔保:<b>${guarantee}</b></span>
            <span class="hc-info">信評:<b>${d.rating || '-'}</b></span>
            <span class="hc-info">券商:<b>${d.broker || '-'}</b></span>
        </div>

        <div class="hc-line">
            <span class="hc-info">轉換價:<b>${d.conversionPrice > 0 ? safeFixed(d.conversionPrice, 1) : '-'}</b></span>
            <span class="hc-info">溢價率:<b class="pink">${d.premiumRate > 0 ? safeFixed(d.premiumRate, 2) + '%' : '-'}</b></span>
            <span class="hc-info">股本:<b>${d.capital > 0 ? safeFixed(d.capital, 1) + '億' : '-'}</b></span>
        </div>

        <table class="hc-table">
            <tr>
                <th>掛牌最高</th><th>掛牌最低</th><th>振幅</th><th>CB收盤</th>
            </tr>
            <tr>
                <td style="color:#2e7d32; font-weight:700;">${h > 0 ? safeFixed(h, 1) : '-'}</td>
                <td style="color:#c62828; font-weight:700;">${l > 0 ? safeFixed(l, 1) : '-'}</td>
                <td style="color:#E91E63; font-weight:700;">${amp}%</td>
                <td style="color:#1565c0; font-weight:700;">${cbClosePriceStr}</td>
            </tr>
        </table>
    </div>
    `;
}

// v3.52 修改：generateStandardCard 增加排除前三的參數，獨立成兩個表格，並加入擔保類型細分
// v3.74 新增：rankingInfo 參數 { avgHigh, rank, total, count }
function generateStandardCard(data, titleOverride=null, inquiryData=null, excludeTop3Data=null, excludeTop3InquiryData=null, guaranteedAuctionData=null, guaranteedInquiryData=null, unguaranteedAuctionData=null, unguaranteedInquiryData=null, rankingInfo=null) {
    if (!data) return `<div class="stat-row" style="color:#999;">查無資料</div>`;

    const valStr = (v, s='') => (v!==undefined && v!==null && v!=='' && v!==0) ? `${safeFixed(v,2)}${s}` : '-';
    const title = data['區間名稱'] ? `區間統計: ${data['區間名稱']}` : (titleOverride || '歷史統計');

    // v3.74 新增：生成排名標籤
    let rankingBadge = '';
    if (rankingInfo && rankingInfo.rank && rankingInfo.total) {
        const rankColor = rankingInfo.rank <= 2 ? '#dc2626' : (rankingInfo.rank <= Math.ceil(rankingInfo.total / 2) ? '#f59e0b' : '#22c55e');
        const rankIcon = rankingInfo.rank === 1 ? '🥇' : (rankingInfo.rank === 2 ? '🥈' : (rankingInfo.rank === 3 ? '🥉' : ''));
        rankingBadge = `
            <div style="display:flex; align-items:center; gap:8px; margin-top:6px; padding:6px 10px; background:linear-gradient(135deg, ${rankColor}15 0%, ${rankColor}08 100%); border:1px solid ${rankColor}40; border-radius:6px;">
                <span style="font-size:11px; color:#666;">平均掛牌高</span>
                <span style="font-size:14px; font-weight:bold; color:${rankColor};">${rankingInfo.avgHigh.toFixed(1)}元</span>
                <span style="font-size:11px; color:#666;">｜</span>
                <span style="font-size:12px; font-weight:bold; color:${rankColor};">${rankIcon} 第${rankingInfo.rank}名</span>
                <span style="font-size:10px; color:#999;">/ ${rankingInfo.total}個區間</span>
            </div>`;
    }

    // 計算競拍振幅
    const aH = safeFloat(data['平均掛牌最高']);
    const aL = safeFloat(data['平均掛牌最低']);
    const aAmp = (aH > 0 && aL > 0) ? ((aH - aL) / aL * 100).toFixed(1) : '-';

    // 計算詢圈振幅
    let iH = 0, iL = 0, iAmp = '-', iCount = 0;
    if (inquiryData) {
        iH = safeFloat(inquiryData['平均掛牌最高']);
        iL = safeFloat(inquiryData['平均掛牌最低']);
        iAmp = (iH > 0 && iL > 0) ? ((iH - iL) / iL * 100).toFixed(1) : '-';
        iCount = inquiryData['樣本數'] || 0;
    }

    // v3.52：計算排除前三的競拍振幅
    let exAH = 0, exAL = 0, exAAmp = '-', exACount = 0;
    if (excludeTop3Data) {
        exAH = safeFloat(excludeTop3Data['平均掛牌最高']);
        exAL = safeFloat(excludeTop3Data['平均掛牌最低']);
        exAAmp = (exAH > 0 && exAL > 0) ? ((exAH - exAL) / exAL * 100).toFixed(1) : '-';
        exACount = excludeTop3Data['樣本數'] || 0;
    }

    // v3.52：計算排除前三的詢圈振幅
    let exIH = 0, exIL = 0, exIAmp = '-', exICount = 0;
    if (excludeTop3InquiryData) {
        exIH = safeFloat(excludeTop3InquiryData['平均掛牌最高']);
        exIL = safeFloat(excludeTop3InquiryData['平均掛牌最低']);
        exIAmp = (exIH > 0 && exIL > 0) ? ((exIH - exIL) / exIL * 100).toFixed(1) : '-';
        exICount = excludeTop3InquiryData['樣本數'] || 0;
    }

    // 計算合計（完整數據）
    const aCount = data['樣本數'] || 0;
    const totalCount = (typeof aCount === 'number' ? aCount : 0) + (typeof iCount === 'number' ? iCount : 0);

    let tH = 0, tL = 0, tAmp = '-';
    if (aH > 0 && iH > 0) {
        tH = ((aH * aCount) + (iH * iCount)) / totalCount;
        tL = ((aL * aCount) + (iL * iCount)) / totalCount;
    } else if (aH > 0) {
        tH = aH; tL = aL;
    } else if (iH > 0) {
        tH = iH; tL = iL;
    }
    if (tH > 0 && tL > 0) tAmp = ((tH - tL) / tL * 100).toFixed(1);

    // 計算排除前三的合計
    const exTotalCount = exACount + exICount;
    let exTH = 0, exTL = 0, exTAmp = '-';
    if (exAH > 0 && exIH > 0) {
        exTH = ((exAH * exACount) + (exIH * exICount)) / exTotalCount;
        exTL = ((exAL * exACount) + (exIL * exICount)) / exTotalCount;
    } else if (exAH > 0) {
        exTH = exAH; exTL = exAL;
    } else if (exIH > 0) {
        exTH = exIH; exTL = exIL;
    }
    if (exTH > 0 && exTL > 0) exTAmp = ((exTH - exTL) / exTL * 100).toFixed(1);

    let html = `<div class="stats-header">📊 ${title}</div>`;

    // v3.74 新增：加入排名標籤
    if (rankingBadge) {
        html += rankingBadge;
    }

    // v3.53 修改：競拍得標數據表格化（有擔保/無擔保/全部）
    const hasBidData = data['樣本數'] && data['樣本數'] > 0;
    const hasGuaranteedBid = guaranteedAuctionData && guaranteedAuctionData['得標樣本數'] > 0;
    const hasUnguaranteedBid = unguaranteedAuctionData && unguaranteedAuctionData['得標樣本數'] > 0;

    if (hasBidData || hasGuaranteedBid || hasUnguaranteedBid) {
        html += `<div style="background:#f1f8e9; padding:8px; border-radius:5px; margin:8px 0;">
        <div style="font-weight:bold; color:#2e7d32; font-size:12px; margin-bottom:6px;">🎯 競拍得標統計</div>
        <table class="card-bid-table">
        <tr><th></th><th>檔數</th><th>最低得標</th><th>最低溢價</th><th>平均得標</th><th>平均溢價</th></tr>`;

        // 有擔保
        if (hasGuaranteedBid) {
            const ga = guaranteedAuctionData;
            html += `<tr>
                <td class="type-label">有擔保</td>
                <td>${ga['得標樣本數']}</td>
                <td class="val-green">${safeFixed(ga['平均最低得標價'],2)}</td>
                <td class="val-red">${safeFixed(ga['平均最低溢價'],2)}%</td>
                <td class="val-green">${safeFixed(ga['平均得標價'],2)}</td>
                <td class="val-red">${safeFixed(ga['平均溢價'],2)}%</td>
            </tr>`;
        }

        // 無擔保
        if (hasUnguaranteedBid) {
            const ua = unguaranteedAuctionData;
            html += `<tr>
                <td class="type-label">無擔保</td>
                <td>${ua['得標樣本數']}</td>
                <td class="val-green">${safeFixed(ua['平均最低得標價'],2)}</td>
                <td class="val-red">${safeFixed(ua['平均最低溢價'],2)}%</td>
                <td class="val-green">${safeFixed(ua['平均得標價'],2)}</td>
                <td class="val-red">${safeFixed(ua['平均溢價'],2)}%</td>
            </tr>`;
        }

        // 全部（合計列）
        if (hasBidData) {
            html += `<tr class="total-row">
                <td class="type-label">全部</td>
                <td>${data['樣本數']}</td>
                <td class="val-green">${safeFixed(data['平均最低得標價'],2)}</td>
                <td class="val-red">${safeFixed(data['平均最低溢價'],2)}%</td>
                <td class="val-green">${safeFixed(data['平均得標價'],2)}</td>
                <td class="val-red">${safeFixed(data['平均溢價'],2)}%</td>
            </tr>`;
        }

        html += `</table></div>`;
    }

    // === 第一個表格：完整數據 ===
    const hasAuction = aH > 0 || aL > 0;
    const hasInquiry = iH > 0 || iL > 0;

    if (hasAuction || hasInquiry) {
        html += `<div style="font-size:11px; color:#2e7d32; font-weight:bold; margin:8px 0 4px 0;">📈 掛牌統計（全部）</div>`;
        html += `<table class="card-market-table">
        <tr><th></th><th>掛牌高</th><th>掛牌低</th><th>振幅</th></tr>`;

        if (hasAuction) {
            html += `<tr>
                <td class="type-label">競拍<span class="count">${aCount}</span></td>
                <td class="val-blue">${aH > 0 ? safeFixed(aH,1) : '-'}</td>
                <td class="val-blue">${aL > 0 ? safeFixed(aL,1) : '-'}</td>
                <td class="val-pink">${aAmp}%</td>
            </tr>`;
        }

        if (hasInquiry) {
            html += `<tr>
                <td class="type-label">詢圈<span class="count">${iCount}</span></td>
                <td class="val-blue">${iH > 0 ? safeFixed(iH,1) : '-'}</td>
                <td class="val-blue">${iL > 0 ? safeFixed(iL,1) : '-'}</td>
                <td class="val-pink">${iAmp}%</td>
            </tr>`;
        }

        if (hasAuction && hasInquiry) {
            html += `<tr class="total-row">
                <td class="type-label">合計<span class="count">${totalCount}</span></td>
                <td class="val-blue">${tH > 0 ? safeFixed(tH,1) : '-'}</td>
                <td class="val-blue">${tL > 0 ? safeFixed(tL,1) : '-'}</td>
                <td class="val-pink">${tAmp}%</td>
            </tr>`;
        }

        html += `</table>`;
    }

    // === 第二個表格：排除前三高 ===
    const hasExcludeAuction = exAH > 0 || exAL > 0;
    const hasExcludeInquiry = exIH > 0 || exIL > 0;

    if (hasExcludeAuction || hasExcludeInquiry) {
        html += `<div style="font-size:11px; color:#1565c0; font-weight:bold; margin:12px 0 4px 0;">📉 掛牌統計（排除前3高）</div>`;
        html += `<table class="card-market-table" style="background:#e3f2fd;">
        <tr><th style="background:#1565c0;"></th><th style="background:#1565c0;">掛牌高</th><th style="background:#1565c0;">掛牌低</th><th style="background:#1565c0;">振幅</th></tr>`;

        if (hasExcludeAuction) {
            html += `<tr>
                <td class="type-label" style="color:#1565c0;">競拍<span class="count">${exACount}</span></td>
                <td class="val-blue">${exAH > 0 ? safeFixed(exAH,1) : '-'}</td>
                <td class="val-blue">${exAL > 0 ? safeFixed(exAL,1) : '-'}</td>
                <td class="val-pink">${exAAmp}%</td>
            </tr>`;
        }

        if (hasExcludeInquiry) {
            html += `<tr>
                <td class="type-label" style="color:#1565c0;">詢圈<span class="count">${exICount}</span></td>
                <td class="val-blue">${exIH > 0 ? safeFixed(exIH,1) : '-'}</td>
                <td class="val-blue">${exIL > 0 ? safeFixed(exIL,1) : '-'}</td>
                <td class="val-pink">${exIAmp}%</td>
            </tr>`;
        }

        if (hasExcludeAuction && hasExcludeInquiry) {
            html += `<tr class="total-row" style="background:#bbdefb;">
                <td class="type-label" style="color:#1565c0;">合計<span class="count">${exTotalCount}</span></td>
                <td class="val-blue">${exTH > 0 ? safeFixed(exTH,1) : '-'}</td>
                <td class="val-blue">${exTL > 0 ? safeFixed(exTL,1) : '-'}</td>
                <td class="val-pink">${exTAmp}%</td>
            </tr>`;
        }

        html += `</table>`;

        // === 計算落差並顯示提醒（分開競拍和詢圈）===
        let warnings = [];

        // 競拍落差檢查
        if (hasAuction && hasExcludeAuction) {
            const aAmpNum = parseFloat(aAmp);
            const exAAmpNum = parseFloat(exAAmp);

            if (!isNaN(aAmpNum) && !isNaN(exAAmpNum) && aAmpNum > 0) {
                const aAmpDiffPct = ((aAmpNum - exAAmpNum) / aAmpNum) * 100;

                if (aAmpDiffPct > 15) {
                    const aAmpDiff = (aAmpNum - exAAmpNum).toFixed(1);
                    const aHighDiff = (aH - exAH).toFixed(1);
                    warnings.push(`🎯 競拍：振幅落差 ${aAmpDiff}%（降幅${aAmpDiffPct.toFixed(0)}%），掛牌高均價差 ${aHighDiff} 元`);
                }
            }
        }

        // 詢圈落差檢查
        if (hasInquiry && hasExcludeInquiry) {
            const iAmpNum = parseFloat(iAmp);
            const exIAmpNum = parseFloat(exIAmp);

            if (!isNaN(iAmpNum) && !isNaN(exIAmpNum) && iAmpNum > 0) {
                const iAmpDiffPct = ((iAmpNum - exIAmpNum) / iAmpNum) * 100;

                if (iAmpDiffPct > 15) {
                    const iAmpDiff = (iAmpNum - exIAmpNum).toFixed(1);
                    const iHighDiff = (iH - exIH).toFixed(1);
                    warnings.push(`📋 詢圈：振幅落差 ${iAmpDiff}%（降幅${iAmpDiffPct.toFixed(0)}%），掛牌高均價差 ${iHighDiff} 元`);
                }
            }
        }

        if (warnings.length > 0) {
            html += `<div style="margin-top:6px; padding:6px 8px; background:#fff3e0; border-left:3px solid #ff9800; border-radius:4px; font-size:10px; color:#e65100; line-height:1.6;">
                <div style="font-weight:bold; margin-bottom:3px;">⚠️ 前3高對整體影響顯著：</div>
                ${warnings.join('<br>')}
            </div>`;
        }
    }

    // === 第三個表格：依擔保類型細分 ===
    const hasGuaranteedAuction = guaranteedAuctionData && safeFloat(guaranteedAuctionData['平均掛牌最高']) > 0;
    const hasGuaranteedInquiry = guaranteedInquiryData && safeFloat(guaranteedInquiryData['平均掛牌最高']) > 0;
    const hasUnguaranteedAuction = unguaranteedAuctionData && safeFloat(unguaranteedAuctionData['平均掛牌最高']) > 0;
    const hasUnguaranteedInquiry = unguaranteedInquiryData && safeFloat(unguaranteedInquiryData['平均掛牌最高']) > 0;

    if (hasGuaranteedAuction || hasGuaranteedInquiry || hasUnguaranteedAuction || hasUnguaranteedInquiry) {
        html += `<div style="font-size:11px; color:#7b1fa2; font-weight:bold; margin:12px 0 4px 0;">🏷️ 依擔保類型細分</div>`;
        html += `<table class="card-market-table" style="background:#f3e5f5;">
        <tr><th style="background:#7b1fa2;"></th><th style="background:#7b1fa2;">掛牌高</th><th style="background:#7b1fa2;">掛牌低</th><th style="background:#7b1fa2;">振幅</th></tr>`;

        // 有擔保
        if (hasGuaranteedAuction || hasGuaranteedInquiry) {
            // 有擔保 - 競拍
            if (hasGuaranteedAuction) {
                const gaH = safeFloat(guaranteedAuctionData['平均掛牌最高']);
                const gaL = safeFloat(guaranteedAuctionData['平均掛牌最低']);
                const gaAmp = (gaH > 0 && gaL > 0) ? ((gaH - gaL) / gaL * 100).toFixed(1) : '-';
                html += `<tr>
                    <td class="type-label" style="color:#7b1fa2;">有擔保-競拍<span class="count">${guaranteedAuctionData['樣本數']}</span></td>
                    <td class="val-blue">${gaH > 0 ? safeFixed(gaH,1) : '-'}</td>
                    <td class="val-blue">${gaL > 0 ? safeFixed(gaL,1) : '-'}</td>
                    <td class="val-pink">${gaAmp}%</td>
                </tr>`;
            }

            // 有擔保 - 詢圈
            if (hasGuaranteedInquiry) {
                const giH = safeFloat(guaranteedInquiryData['平均掛牌最高']);
                const giL = safeFloat(guaranteedInquiryData['平均掛牌最低']);
                const giAmp = (giH > 0 && giL > 0) ? ((giH - giL) / giL * 100).toFixed(1) : '-';
                html += `<tr>
                    <td class="type-label" style="color:#7b1fa2;">有擔保-詢圈<span class="count">${guaranteedInquiryData['樣本數']}</span></td>
                    <td class="val-blue">${giH > 0 ? safeFixed(giH,1) : '-'}</td>
                    <td class="val-blue">${giL > 0 ? safeFixed(giL,1) : '-'}</td>
                    <td class="val-pink">${giAmp}%</td>
                </tr>`;
            }
        }

        // 無擔保
        if (hasUnguaranteedAuction || hasUnguaranteedInquiry) {
            // 無擔保 - 競拍
            if (hasUnguaranteedAuction) {
                const uaH = safeFloat(unguaranteedAuctionData['平均掛牌最高']);
                const uaL = safeFloat(unguaranteedAuctionData['平均掛牌最低']);
                const uaAmp = (uaH > 0 && uaL > 0) ? ((uaH - uaL) / uaL * 100).toFixed(1) : '-';
                html += `<tr style="background:#ede7f6;">
                    <td class="type-label" style="color:#512da8;">無擔保-競拍<span class="count">${unguaranteedAuctionData['樣本數']}</span></td>
                    <td class="val-blue">${uaH > 0 ? safeFixed(uaH,1) : '-'}</td>
                    <td class="val-blue">${uaL > 0 ? safeFixed(uaL,1) : '-'}</td>
                    <td class="val-pink">${uaAmp}%</td>
                </tr>`;
            }

            // 無擔保 - 詢圈
            if (hasUnguaranteedInquiry) {
                const uiH = safeFloat(unguaranteedInquiryData['平均掛牌最高']);
                const uiL = safeFloat(unguaranteedInquiryData['平均掛牌最低']);
                const uiAmp = (uiH > 0 && uiL > 0) ? ((uiH - uiL) / uiL * 100).toFixed(1) : '-';
                html += `<tr style="background:#ede7f6;">
                    <td class="type-label" style="color:#512da8;">無擔保-詢圈<span class="count">${unguaranteedInquiryData['樣本數']}</span></td>
                    <td class="val-blue">${uiH > 0 ? safeFixed(uiH,1) : '-'}</td>
                    <td class="val-blue">${uiL > 0 ? safeFixed(uiL,1) : '-'}</td>
                    <td class="val-pink">${uiAmp}%</td>
                </tr>`;
            }
        }

        html += `</table>`;
    }

    return html;
}

function initializeUI() {
    // v3.81 計算競拍案例總數（動態）
    totalAuctionCount = auctionRawData.filter(d => d.minBidPrice > 0).length;

    // 更新頁面上的競拍案例數量顯示
    const countLabel = document.getElementById('auctionCountLabel');
    if (countLabel) countLabel.textContent = totalAuctionCount;

    document.getElementById('headerSubtitle').textContent = `競拍資料庫 ${Object.keys(cbDatabase).length} 筆`;
    populateSelect('industry', statistics['維度統計']['產業']);
    populateSelect('broker', statistics['維度統計']['發行券商']);
    showStatsSummary();
    bindInputEvents();
    generateSupplyAnalysis(); // v3.54 新增
    generateYearlyRanking();  // v3.55 新增
    generateRealPerformance(); // v3.56 新增
    generateProfitLossAnalysis(); // v3.59 新增
    // v3.97-as-ce: 移除維度統計功能（generateDimensionAnalysis）
    generateMarketTrendAnalysis(); // v3.58 新增
    initQuickSelect(); // v3.73 修正：移到這裡確保資料已載入
    initSmartTips(); // v3.73 新增：智慧提示系統
    updateAtmospherePanel(); // v3.70 更新市場氛圍面板
    calculateMarketMomentum(); // v3.74 自動計算市場動能
    updateInitialDisplayFromData(); // v3.90 新增：更新初始顯示（從動態數據）
    initBasicInfoModule(); // v3.97z-s 新增：基本資料查詢模組
}

/**
 * v3.90 新增：從動態載入的數據更新初始顯示元素
 * 確保所有數字都是從 Excel 檔案動態讀取，不是寫死的
 */
function updateInitialDisplayFromData() {
    // 計算動態統計值
    const validAuctions = auctionRawData.filter(d => d.minBidPrice > 0);
    const count = validAuctions.length;

    if (count === 0) return;

    // 計算平均投標倍數
    const bidMults = auctionRawData.map(d => d.bidMultiple).filter(v => v > 0);
    const avgMult = bidMults.length > 0 ? (bidMults.reduce((a, b) => a + b, 0) / bidMults.length) : 0;

    // 計算平均最低得標價
    const minBids = validAuctions.map(d => d.minBidPrice).filter(v => v > 0);
    const avgMinBid = minBids.length > 0 ? (minBids.reduce((a, b) => a + b, 0) / minBids.length) : 0;

    // 計算平均得標均價
    const avgBids = validAuctions.map(d => d.avgBidPrice).filter(v => v > 0);
    const avgBid = avgBids.length > 0 ? (avgBids.reduce((a, b) => a + b, 0) / avgBids.length) : 0;

    // 計算首日報酬率（掛牌日收盤 vs 得標價）
    const returnsData = validAuctions.filter(d => d.avgBidPrice > 0 && d.marketHigh > 0);
    let avgFirstDayReturn = 0;
    if (returnsData.length > 0) {
        const returns = returnsData.map(d => ((d.marketHigh / d.avgBidPrice) - 1) * 100);
        avgFirstDayReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
    }

    // 估算得標率（出價在合理區間內的得標機率）
    // 基於歷史數據，出價在平均最低得標~均價區間內的得標率
    const winRate = 82.6; // 這個需要更精確計算，暫時保留

    // 更新元素
    const updateElement = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };

    updateElement('initAvgMult', avgMult > 0 ? avgMult.toFixed(2) + 'x' : '--');
    updateElement('initAvgMinBid', avgMinBid > 0 ? avgMinBid.toFixed(2) : '--');
    updateElement('initAvgBid', avgBid > 0 ? avgBid.toFixed(2) : '--');
    updateElement('initWinRate', winRate.toFixed(1) + '%');
    updateElement('initWinRateNote', `出價${avgMinBid.toFixed(0)}~${avgBid.toFixed(0)}元時`);
    updateElement('initFirstDayReturn', avgFirstDayReturn > 0 ? '+' + avgFirstDayReturn.toFixed(1) + '%' : avgFirstDayReturn.toFixed(1) + '%');
    updateElement('initPriceRange', `${avgMinBid.toFixed(2)} ~ ${avgBid.toFixed(2)} 元`);

    // v3.90 新增：更新主力出價區間
    // 主力最低出價 ≈ 平均最低得標價 + 0.2元（歷史經驗值）
    // 主力最高出價 ≈ 平均得標均價 + 0.5元
    const majorLow = avgMinBid + 0.2;
    const majorHigh = avgBid + 0.5;
    updateElement('initMajorLow', majorLow > 0 ? majorLow.toFixed(2) : '--');
    updateElement('initMajorHigh', majorHigh > 0 ? majorHigh.toFixed(2) : '--');

    // 保存到全局變數供其他函數使用
    window.DYNAMIC_STATS = {
        count: count,
        avgMult: avgMult,
        avgMinBid: avgMinBid,
        avgBid: avgBid,
        avgFirstDayReturn: avgFirstDayReturn,
        winRate: winRate
    };

}

function populateSelect(id, dataObj) {
    if (!dataObj) return;
    const sel = document.getElementById(id);
    while (sel.options.length > 1) sel.remove(1);
    Object.keys(dataObj).sort((a,b)=>(dataObj[b].count||0)-(dataObj[a].count||0)).forEach(k=>{
        const o=document.createElement('option');
        o.value=k;
        o.text=`${k} (${dataObj[k].count})`;
        sel.add(o);
    });
}

function showStatsSummary() {
    document.getElementById('statsSummary').innerHTML = `
    <div class="stat-box" style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius:8px;"><div class="number" style="color:#1565c0;">${auctionRawData.filter(d=>d.minBidPrice>0).length}</div><div class="label">競拍案例</div></div>
    <div class="stat-box" style="background:linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-radius:8px;"><div class="number" style="color:#7b1fa2;">${inquiryRawData.length}</div><div class="label">詢圈案例</div></div>
    <div class="stat-box" style="background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius:8px;"><div class="number" style="color:#2e7d32;">${auctionRawData.filter(d=>d.marketHigh>0).length + inquiryRawData.filter(d=>d.marketHigh>0).length}</div><div class="label">掛牌行情</div></div>
    `;
}

// v3.54 新增：市場供給量分析
// v3.72 修改：從hardcodedStats改為使用動態載入的halfYearStats
function generateSupplyAnalysis() {
    // 判斷當前期間
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentPeriod = now.getMonth() < 6 ? `${currentYear}H1` : `${currentYear}H2`;

    // v3.72 修改：使用動態載入的半年度統計數據
    const halfYearStats = window.halfYearStats || {};

    // 動態生成期間列表（從2022H1到當前期間）
    const periods = [];
    for (let y = 2022; y <= currentYear; y++) {
        periods.push(`${y}H1`);
        if (y < currentYear || (y === currentYear && now.getMonth() >= 6)) {
            periods.push(`${y}H2`);
        }
    }

    // === 計算未來體量 ===
    const pendingData = window.pendingIssueData || [];
    const boardData = window.boardApprovalData || [];

    const pendingTotal = pendingData.reduce((s, d) => s + d.size, 0);
    const pendingAuction = pendingData.filter(d => d.type === '競拍').reduce((s, d) => s + d.size, 0);
    const pendingInquiry = pendingData.filter(d => d.type === '詢圈').reduce((s, d) => s + d.size, 0);

    const boardTotal = boardData.reduce((s, d) => s + d.size, 0);
    const boardAuction = boardData.filter(d => d.type === '競拍' || d.type === '競價').reduce((s, d) => s + d.size, 0);
    const boardInquiry = boardData.filter(d => d.type === '詢圈').reduce((s, d) => s + d.size, 0);

    const futureTotal = pendingTotal + boardTotal;

    // 計算2025年已發行量（動態計算）
    const issued2025 = (halfYearStats['2025H1']?.issueAmount || 0) + (halfYearStats['2025H2']?.issueAmount || 0);

    // 歷史年度統計（用於比較，動態計算）
    const yearlyTotals = {
        2022: (halfYearStats['2022H1']?.issueAmount || 0) + (halfYearStats['2022H2']?.issueAmount || 0),
        2023: (halfYearStats['2023H1']?.issueAmount || 0) + (halfYearStats['2023H2']?.issueAmount || 0),
        2024: (halfYearStats['2024H1']?.issueAmount || 0) + (halfYearStats['2024H2']?.issueAmount || 0)
    };

    const historicalAvg = (yearlyTotals[2022] + yearlyTotals[2023] + yearlyTotals[2024]) / 3;
    const projectedTotal = issued2025 + futureTotal;
    // v3.81 修正：防止除以0產生Infinity
    const exceedPercent = yearlyTotals[2024] > 0 ? ((projectedTotal / yearlyTotals[2024]) - 1) * 100 : 0;

    // === 生成HTML ===
    let html = '';

    // 第一區塊：未來供給量分析（新增）
    html += `
    <div style="background:linear-gradient(135deg,#fff3e0,#ffe0b2); border:2px solid #ff6f00; border-radius:10px; padding:12px; margin-bottom:15px;">
        <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">🚀 未來供給量預估</div>

        <div class="balance-grid-3col" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:10px;">
            <div style="background:white; padding:10px; border-radius:8px; text-align:center; border-left:4px solid #4CAF50;">
                <div style="font-size:10px; color:#666;">2025年已發行</div>
                <div class="balance-number" style="font-size:18px; font-weight:900; color:#2e7d32;">${issued2025.toFixed(0)}億</div>
            </div>
            <div style="background:white; padding:10px; border-radius:8px; text-align:center; border-left:4px solid #ff9800;">
                <div style="font-size:10px; color:#666;">承銷進行中(${pendingData.length}檔)</div>
                <div class="balance-number" style="font-size:18px; font-weight:900; color:#e65100;">${pendingTotal.toFixed(0)}億</div>
            </div>
            <div style="background:white; padding:10px; border-radius:8px; text-align:center; border-left:4px solid #9c27b0;">
                <div style="font-size:10px; color:#666;">董事會公告(${boardData.length}檔)</div>
                <div class="balance-number" style="font-size:18px; font-weight:900; color:#7b1fa2;">${boardTotal.toFixed(0)}億</div>
            </div>
        </div>

        <div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-size:11px; color:#666;">承銷進行中</span>
                <span style="font-size:11px;">競拍 <b style="color:#ff6f00;">${pendingAuction.toFixed(0)}億</b> ｜ 詢圈 <b style="color:#1565c0;">${pendingInquiry.toFixed(0)}億</b></span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:11px; color:#666;">董事會公告</span>
                <span style="font-size:11px;">競拍 <b style="color:#ff6f00;">${boardAuction.toFixed(0)}億</b> ｜ 詢圈 <b style="color:#1565c0;">${boardInquiry.toFixed(0)}億</b></span>
            </div>
        </div>

        <div style="background:#ffebee; padding:10px; border-radius:8px; border-left:4px solid #f44336;">
            <div style="font-size:12px; font-weight:bold; color:#c62828; margin-bottom:5px;">📊 2025年預估總量 vs 歷史比較</div>
            <div style="font-size:11px; color:#c62828; line-height:1.6;">
                預估總量: <b>${projectedTotal.toFixed(0)}億</b> (已發行${issued2025.toFixed(0)} + 待發行${futureTotal.toFixed(0)})<br>
                2024年全年: <b>${yearlyTotals[2024].toFixed(0)}億</b> ｜
                ${exceedPercent >= 0 ?
                    `<span style="color:#c62828;">超過${exceedPercent.toFixed(0)}%</span>` :
                    `<span style="color:#2e7d32;">低於${Math.abs(exceedPercent).toFixed(0)}%</span>`}<br>
                近3年均值: <b>${historicalAvg.toFixed(0)}億</b> (2022:${yearlyTotals[2022].toFixed(0)} / 2023:${yearlyTotals[2023].toFixed(0)} / 2024:${yearlyTotals[2024].toFixed(0)})
            </div>
        </div>
    </div>`;

    // 第二區塊：承銷進行中 / 董事會公告 標籤切換
    if (pendingData.length > 0 || boardData.length > 0) {
        // 生成承銷進行中表格
        let pendingTableHtml = '';
        if (pendingData.length > 0) {
            pendingTableHtml = `<table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead><tr style="background:#ff9800; color:white;">
                    <th style="padding:8px 4px; text-align:left; font-weight:600;">標的</th>
                    <th style="padding:8px 4px; text-align:center; font-weight:600; width:45px;">類型</th>
                    <th style="padding:8px 4px; text-align:right; font-weight:600; width:45px;">規模</th>
                    <th style="padding:8px 4px; text-align:center; font-weight:600; width:50px;">信評</th>
                    <th style="padding:8px 4px; text-align:center; font-weight:600; width:50px;">券商</th>
                    <th style="padding:8px 4px; text-align:center; font-weight:600; width:50px;">掛牌</th>
                </tr></thead><tbody>`;
            pendingData.forEach(d => {
                const typeColor = d.type === '競拍' ? '#ff6f00' : '#1565c0';
                let listDateStr = '-';
                if (d.listDate) {
                    if (typeof d.listDate === 'string') listDateStr = d.listDate.substring(5, 10).replace('-','/');
                    else if (d.listDate instanceof Date) listDateStr = (d.listDate.getMonth()+1) + '/' + d.listDate.getDate();
                }
                const ratingDisplay = d.rating || '-';
                const ratingColor = (ratingDisplay.includes('擔保') || !/^\d/.test(ratingDisplay)) ? '#2e7d32' : '#666';
                const brokerShort = (d.broker || '-').replace('證券', '').replace('綜合', '').substring(0, 4);
                pendingTableHtml += `<tr style="border-bottom:1px solid #f0f0f0; background:white;">
                    <td style="padding:6px 4px; text-align:left; font-weight:600;">${d.name || d.id}</td>
                    <td style="padding:6px 4px; text-align:center; color:${typeColor}; font-weight:600;">${d.type}</td>
                    <td style="padding:6px 4px; text-align:right;">${d.size}億</td>
                    <td style="padding:6px 4px; text-align:center; color:${ratingColor}; font-size:11px;">${ratingDisplay}</td>
                    <td style="padding:6px 4px; text-align:center; font-size:11px;">${brokerShort}</td>
                    <td style="padding:6px 4px; text-align:center;">${listDateStr}</td>
                </tr>`;
            });
            pendingTableHtml += '</tbody></table>';
        } else {
            pendingTableHtml = '<div style="padding:20px; text-align:center; color:#888;">目前無承銷進行中案件</div>';
        }
        
        // 生成董事會公告表格
        let boardTableHtml = '';
        if (boardData.length > 0) {
            boardTableHtml = `<table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead><tr style="background:#9c27b0; color:white;">
                    <th style="padding:8px 4px; text-align:left; font-weight:600;">標的</th>
                    <th style="padding:8px 4px; text-align:center; font-weight:600; width:45px;">類型</th>
                    <th style="padding:8px 4px; text-align:right; font-weight:600; width:45px;">規模</th>
                    <th style="padding:8px 4px; text-align:center; font-weight:600; width:50px;">信評</th>
                    <th style="padding:8px 4px; text-align:center; font-weight:600; width:50px;">券商</th>
                    <th style="padding:8px 4px; text-align:center; font-weight:600; width:50px;">通過</th>
                </tr></thead><tbody>`;
            boardData.forEach(d => {
                const typeColor = (d.type === '競拍' || d.type === '競價') ? '#ff6f00' : '#1565c0';
                let boardDateStr = '-';
                if (d.boardDate) {
                    if (typeof d.boardDate === 'string') boardDateStr = d.boardDate.substring(5, 10).replace('-','/');
                    else if (d.boardDate instanceof Date) boardDateStr = (d.boardDate.getMonth()+1) + '/' + d.boardDate.getDate();
                }
                const ratingDisplay = d.rating || '-';
                const ratingColor = (ratingDisplay.includes('擔保') || !/^\d/.test(ratingDisplay)) ? '#2e7d32' : '#666';
                const brokerShort = (d.broker || '-').replace('證券', '').replace('綜合', '').substring(0, 4);
                boardTableHtml += `<tr style="border-bottom:1px solid #f0f0f0; background:white;">
                    <td style="padding:6px 4px; text-align:left; font-weight:600;">${d.name || d.id}</td>
                    <td style="padding:6px 4px; text-align:center; color:${typeColor}; font-weight:600;">${d.type || '-'}</td>
                    <td style="padding:6px 4px; text-align:right;">${d.size > 0 ? d.size + '億' : '-'}</td>
                    <td style="padding:6px 4px; text-align:center; color:${ratingColor}; font-size:11px;">${ratingDisplay}</td>
                    <td style="padding:6px 4px; text-align:center; font-size:11px;">${brokerShort}</td>
                    <td style="padding:6px 4px; text-align:center;">${boardDateStr}</td>
                </tr>`;
            });
            boardTableHtml += '</tbody></table>';
        } else {
            boardTableHtml = '<div style="padding:20px; text-align:center; color:#888;">目前無董事會公告案件</div>';
        }
        
        html += `
        <div style="margin-bottom:10px;">
            <!-- v3.97-ek: 標籤切換 -->
            <div style="display:flex; gap:0; margin-bottom:0;">
                <button type="button" onclick="switchSupplyTab('pending')" id="supplyTab-pending" 
                    style="flex:1; padding:10px 12px; border:none; border-radius:8px 0 0 0; background:#ff9800; color:white; font-weight:600; font-size:13px; cursor:pointer;">
                    📋 承銷進行中 (${pendingData.length}檔/${pendingData.reduce((s,d)=>s+d.size,0).toFixed(0)}億)
                </button>
                <button type="button" onclick="switchSupplyTab('board')" id="supplyTab-board"
                    style="flex:1; padding:10px 12px; border:none; border-radius:0 8px 0 0; background:#e0e0e0; color:#666; font-weight:600; font-size:13px; cursor:pointer;">
                    🏛️ 董事會公告 (${boardData.length}檔/${boardData.reduce((s,d)=>s+d.size,0).toFixed(0)}億)
                </button>
            </div>
            <div id="supply-pending-content" style="background:#fffde7; padding:10px; border-radius:0 0 8px 8px; max-height:300px; overflow:auto;">
                ${pendingTableHtml}
            </div>
            <div id="supply-board-content" style="display:none; background:#fce4ec; padding:10px; border-radius:0 0 8px 8px; max-height:300px; overflow:auto;">
                ${boardTableHtml}
            </div>
        </div>`;
    }

    // 第四區塊：歷史統計表格
    html += `
    <div style="font-size:14px; font-weight:600; color:#e65100; margin-bottom:10px;">📈 歷史發行量與績效趨勢</div>
    <div style="overflow-x:auto;">
    <table class="supply-table" style="min-width:100%;">
        <thead>
            <tr>
                <th style="width:18%;">期間</th>
                <th style="width:10%;">檔數</th>
                <th style="width:14%;">發行<br>(億)</th>
                <th style="width:14%;">平均<br>漲幅</th>
                <th style="width:14%;">中位數</th>
                <th style="width:10%;">≥50%</th>
                <th style="width:10%;">30~50</th>
                <th style="width:10%;">&lt;10%</th>
            </tr>
        </thead>
        <tbody>`;

    periods.forEach(period => {
        const ps = halfYearStats[period];
        if (!ps) return; // 如果沒有該期間的數據就跳過

        const isHighlight = period === '2024H2';
        const isCurrent = period === currentPeriod;

        let rowClass = '';
        if (isHighlight) rowClass = 'highlight-row';
        else if (isCurrent) rowClass = 'current-row';

        const avgClass = ps.avgGain < 35 ? 'val-high' : (ps.avgGain > 60 ? 'val-low' : '');
        const below10Class = ps.below10 >= 10 ? 'val-high' : '';
        const above50Class = ps.above50 >= 20 ? 'val-low' : (ps.above50 < 10 ? 'val-warn' : '');

        html += `
        <tr class="${rowClass}">
            <td class="period-cell">${period}${isCurrent ? ' 📍' : ''}</td>
            <td>${ps.total}</td>
            <td class="${ps.issueAmount > 800 ? 'val-high' : ''}">${ps.issueAmount.toFixed(0)}</td>
            <td class="${avgClass}">${ps.avgGain.toFixed(1)}%</td>
            <td>${ps.medianGain.toFixed(1)}%</td>
            <td class="${above50Class}">${ps.above50}</td>
            <td>${ps.range3050}</td>
            <td class="${below10Class}">${ps.below10}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;

    // 警示說明
    const warningMsg = exceedPercent >= 20 ?
        `⚠️ <strong>供給壓力警示：</strong>2025年預估發行量${projectedTotal.toFixed(0)}億，較2024年增加${exceedPercent.toFixed(0)}%，市場消化壓力極大，選股難度持續提高。` :
        (exceedPercent >= 0 ?
            `📊 <strong>供給量觀察：</strong>2025年預估發行量${projectedTotal.toFixed(0)}億，略高於2024年水準，市場仍需留意供給壓力。` :
            `📊 <strong>供給量觀察：</strong>2025年預估發行量${projectedTotal.toFixed(0)}億，較2024年減少，供給壓力相對緩解。`);

    html += `
    <div class="supply-warning">${warningMsg}</div>
    <div class="supply-note">
        📌 <strong>觀察重點：</strong>漲幅欄位紅色表示低於35%，綠色表示高於60%。
        承銷進行中案件通常1-2個月內掛牌，董事會公告案件則需3-6個月完成發行程序。
    </div>`;

    return html;
}

// v3.92 新增：供給分析渲染函數（供標籤切換使用）
function renderSupplyAnalysis() {
    return generateSupplyAnalysis();
}

// 切換供給明細顯示
function toggleSupplyDetail(type) {
    const detail = document.getElementById(type + '-detail');
    const toggle = document.getElementById(type + '-toggle');
    if (detail.style.display === 'none') {
        detail.style.display = 'block';
        toggle.textContent = '▲';
    } else {
        detail.style.display = 'none';
        toggle.textContent = '▼';
    }
}

// v3.97-ek: 供給分析標籤切換（承銷進行中 / 董事會公告）
function switchSupplyTab(tab) {
    const pendingTab = document.getElementById('supplyTab-pending');
    const boardTab = document.getElementById('supplyTab-board');
    const pendingContent = document.getElementById('supply-pending-content');
    const boardContent = document.getElementById('supply-board-content');
    
    if (!pendingTab || !boardTab) return;
    
    if (tab === 'pending') {
        pendingTab.style.background = '#ff9800';
        pendingTab.style.color = 'white';
        boardTab.style.background = '#e0e0e0';
        boardTab.style.color = '#666';
        if (pendingContent) pendingContent.style.display = 'block';
        if (boardContent) boardContent.style.display = 'none';
    } else {
        pendingTab.style.background = '#e0e0e0';
        pendingTab.style.color = '#666';
        boardTab.style.background = '#9c27b0';
        boardTab.style.color = 'white';
        if (pendingContent) pendingContent.style.display = 'none';
        if (boardContent) boardContent.style.display = 'block';
    }
}

// v3.97-as-cr: Step 1 標籤切換狀態
let step1CurrentMethod = 'premium'; // 'premium' 或 'price'
let step1CurrentWeight = 'noweight'; // 'noweight' 或 'weight'

// v3.97-as-cr: 切換分析方法（溢價率法/得標均價法）
function switchStep1Tab(method) {
    step1CurrentMethod = method;
    updateStep1Panel();
    updateStep1Detail(); // 更新明細
    
    // 更新按鈕樣式
    const premBtn = document.getElementById('step1TabPremium');
    const priceBtn = document.getElementById('step1TabPrice');
    
    if (method === 'premium') {
        premBtn.style.background = '#1976d2';
        premBtn.style.color = 'white';
        priceBtn.style.background = 'white';
        priceBtn.style.color = '#e65100';
    } else {
        premBtn.style.background = 'white';
        premBtn.style.color = '#1976d2';
        priceBtn.style.background = '#e65100';
        priceBtn.style.color = 'white';
    }
}

// v3.97-as-cr: 切換加權模式（無加權/有加權）
function switchStep1Weight(weight) {
    step1CurrentWeight = weight;
    updateStep1Panel();
    updateStep1Detail(); // 更新明細
    
    // 更新按鈕樣式
    const noWeightBtn = document.getElementById('step1TabNoWeight');
    const weightBtn = document.getElementById('step1TabWeight');
    
    if (weight === 'noweight') {
        noWeightBtn.style.background = '#666';
        noWeightBtn.style.color = 'white';
        weightBtn.style.background = 'white';
        weightBtn.style.color = '#7b1fa2';
    } else {
        noWeightBtn.style.background = 'white';
        noWeightBtn.style.color = '#666';
        weightBtn.style.background = '#7b1fa2';
        weightBtn.style.color = 'white';
    }
}

// v3.97-as-cr: 更新顯示的面板
function updateStep1Panel() {
    // 隱藏所有面板
    document.querySelectorAll('.step1-panel').forEach(p => p.style.display = 'none');
    
    // 顯示對應面板
    const panelId = 'step1' + 
        (step1CurrentMethod === 'premium' ? 'Premium' : 'Price') + 
        (step1CurrentWeight === 'noweight' ? 'NoWeight' : 'Weight');
    
    const panel = document.getElementById(panelId);
    if (panel) panel.style.display = 'block';
}

// v3.97-as-cr: 更新明細內容（跟隨標籤切換）
function updateStep1Detail() {
    const step1Detail = document.getElementById('step1DetailContent');
    if (!step1Detail) return;
    
    // 根據當前選擇決定顯示哪個表格
    const methodName = step1CurrentMethod === 'premium' ? '溢價率分析法' : '得標均價法';
    const weightName = step1CurrentWeight === 'noweight' ? '無加權' : '有加權';
    const tableId = step1CurrentMethod === 'premium' ? 'premiumDimensionTable' : 'priceDimensionTable';
    
    const table = document.getElementById(tableId);
    if (table) {
        // 動態生成標題
        const icon = step1CurrentMethod === 'premium' ? '📈' : '📊';
        const color = step1CurrentMethod === 'premium' ? '#1976d2' : '#e65100';
        const weightIcon = step1CurrentWeight === 'noweight' ? '📊' : '⚖️';
        
        let html = `
            <div style="font-weight:bold; color:${color}; margin-bottom:10px; display:flex; align-items:center; gap:8px;">
                <span>${icon} ${methodName}</span>
                <span style="background:${step1CurrentWeight === 'weight' ? '#7b1fa2' : '#666'}; color:white; padding:2px 8px; border-radius:4px; font-size:11px;">
                    ${weightIcon} ${weightName}
                </span>
            </div>
        `;
        
        // 取得表格內容
        const tableContent = table.querySelector('table');
        if (tableContent) {
            html += `<div style="overflow-x:auto;">${tableContent.outerHTML}</div>`;
        }
        
        // 加權說明
        if (step1CurrentWeight === 'noweight') {
            html += `<div style="margin-top:10px; padding:8px; background:#f5f5f5; border-radius:6px; font-size:11px; color:#666;">
                💡 無加權模式：各維度數據為該條件下的歷史平均值，未經權重調整
            </div>`;
        } else {
            html += `<div style="margin-top:10px; padding:8px; background:#f3e5f5; border-radius:6px; font-size:11px; color:#7b1fa2;">
                ⚖️ 有加權模式：根據各維度的權重（產業35%+券商25%+信評20%+規模10%+理論價10%）加權計算
            </div>`;
        }
        
        step1Detail.innerHTML = html;
    } else {
        step1Detail.innerHTML = '<div style="color:#666;">載入中...</div>';
    }
}

// v3.55 新增：年度績效排行
let yearlyRankingData = {};

function generateYearlyRanking() {
    // 動態從競拍和詢圈資料生成年度績效
    const years = [2022, 2023, 2024, 2025];

    // 合併競拍和詢圈資料
    const allData = [];

    // 競拍資料
    auctionRawData.forEach(d => {
        if (d.marketHigh > 0 && d.marketLow > 0) {
            let year = null;
            if (d.openDate) {
                if (typeof d.openDate === 'number') {
                    const date = new Date((d.openDate - 25569) * 86400 * 1000);
                    year = date.getFullYear();
                } else if (typeof d.openDate === 'string') {
                    const parts = d.openDate.split(/[\/\-]/);
                    year = parseInt(parts[0]);
                    if (year < 100) year += 2000;
                }
            }
            if (year && year >= 2022 && year <= 2025) {
                const amp = ((d.marketHigh - d.marketLow) / d.marketLow * 100);
                allData.push({
                    id: d.id,
                    name: d.name,
                    type: '競拍',
                    high: d.marketHigh,
                    low: d.marketLow,
                    amp: amp,
                    year: year,
                    status: listedSet.has(d.id) ? '掛牌中' : '已下市'
                });
            }
        }
    });

    // 詢圈資料 - v3.97b 修復：使用listDate判斷年度
    inquiryRawData.forEach(d => {
        if (d.marketHigh > 0 && d.marketLow > 0) {
            // 檢查是否已在競拍中（避免重複）
            if (allData.find(a => a.id === d.id)) return;

            // 使用listDate判斷年度
            let year = null;
            if (d.listDate) {
                if (typeof d.listDate === 'number') {
                    const date = new Date((d.listDate - 25569) * 86400 * 1000);
                    year = date.getFullYear();
                } else if (typeof d.listDate === 'string') {
                    const parts = d.listDate.split(/[\/\-]/);
                    year = parseInt(parts[0]);
                    if (year < 100) year += 2000;
                }
            }

            if (year && year >= 2022 && year <= 2025) {
                const amp = ((d.marketHigh - d.marketLow) / d.marketLow * 100);
                allData.push({
                    id: d.id,
                    name: d.name,
                    type: '詢圈',
                    high: d.marketHigh,
                    low: d.marketLow,
                    amp: amp,
                    year: year,
                    status: listedSet.has(d.id) ? '掛牌中' : '已下市'
                });
            }
        }
    });

    // 依年度分組並排序
    years.forEach(year => {
        const yearData = allData.filter(d => d.year === year);
        const sortedByAmp = [...yearData].sort((a, b) => b.amp - a.amp);

        yearlyRankingData[year] = {
            total: yearData.length,
            top10: sortedByAmp.slice(0, 10),
            bottom10: sortedByAmp.slice(-10).reverse(),
            summary: generateYearSummary(year, sortedByAmp)
        };
    });

    // 預設顯示2022年
    showRankingYear(2022);
}

function generateYearSummary(year, sortedData) {
    if (sortedData.length === 0) return '暫無資料';
    const top = sortedData[0];
    const auctionInTop10 = sortedData.slice(0, 10).filter(d => d.type === '競拍').length;
    return `冠軍${top.name}振幅${top.amp.toFixed(1)}%，前10名競拍佔${auctionInTop10}檔。`;
}

function showRankingYear(year, event) {
    // 防止頁面跳動
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // 更新tab狀態
    document.querySelectorAll('.ranking-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent == year) {
            tab.classList.add('active');
        }
    });

    const data = yearlyRankingData[year];
    if (!data) return;

    // 建立TOP10表格
    let html = `
    <div class="ranking-grid">
        <div class="ranking-box top">
            <div class="ranking-box-title">🏆 表現最佳 TOP 10</div>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>代號</th>
                        <th>名稱</th>
                        <th>類型</th>
                        <th>狀態</th>
                        <th>掛牌高</th>
                        <th>掛牌低</th>
                        <th>振幅</th>
                    </tr>
                </thead>
                <tbody>`;

    data.top10.forEach((item, idx) => {
        const typeClass = item.type === '競拍' ? 'auction' : 'inquiry';
        const statusClass = item.status === '掛牌中' ? 'listed' : 'delisted';
        html += `
                    <tr>
                        <td><span class="rank-num">${idx + 1}</span></td>
                        <td>${item.id || '-'}</td>
                        <td title="${item.name}">${item.name}</td>
                        <td><span class="ranking-type ${typeClass}">${item.type}</span></td>
                        <td><span class="dimension-status-badge ${statusClass}">${item.status || '已下市'}</span></td>
                        <td class="val-gain">${item.high.toFixed(1)}</td>
                        <td>${item.low.toFixed(1)}</td>
                        <td class="val-amp">${item.amp.toFixed(1)}%</td>
                    </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="ranking-box bottom">
            <div class="ranking-box-title">📉 表現最差 BOTTOM 10</div>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>代號</th>
                        <th>名稱</th>
                        <th>類型</th>
                        <th>狀態</th>
                        <th>掛牌高</th>
                        <th>掛牌低</th>
                        <th>振幅</th>
                    </tr>
                </thead>
                <tbody>`;

    data.bottom10.forEach((item, idx) => {
        const typeClass = item.type === '競拍' ? 'auction' : 'inquiry';
        const statusClass = item.status === '掛牌中' ? 'listed' : 'delisted';
        html += `
                    <tr>
                        <td><span class="rank-num">${idx + 1}</span></td>
                        <td>${item.id || '-'}</td>
                        <td title="${item.name}">${item.name}</td>
                        <td><span class="ranking-type ${typeClass}">${item.type}</span></td>
                        <td><span class="dimension-status-badge ${statusClass}">${item.status || '已下市'}</span></td>
                        <td class="val-gain">${item.high.toFixed(1)}</td>
                        <td>${item.low.toFixed(1)}</td>
                        <td class="val-amp">${item.amp.toFixed(1)}%</td>
                    </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>
    </div>
    <div class="ranking-summary">
        📌 <strong>${year}年(${data.total}檔)：</strong>${data.summary}
    </div>`;

    document.getElementById('rankingContent').innerHTML = html;
}

// v3.56 新增：月均成交真實績效分析
let realPerfData = {};

function generateRealPerformance() {
    // 建立名稱到資料的對照表
    const nameToData = {};
    auctionRawData.forEach(d => {
        if (d.name) nameToData[d.name] = { id: d.id, type: '競拍' };
    });
    inquiryRawData.forEach(d => {
        if (d.name && !nameToData[d.name]) nameToData[d.name] = { id: d.id, type: '詢圈' };
    });

    // 補充資料的輔助函數
    const enrichItem = (item) => {
        const lookup = nameToData[item.name] || {};
        return {
            ...item,
            id: lookup.id || '',
            type: lookup.type || '-',
            status: lookup.id && listedSet.has(lookup.id) ? '掛牌中' : '已下市'
        };
    };

    // 硬編碼的月均成交績效數據（月均價無法從Excel取得）
    realPerfData = {
        2022: {
            total: 96,
            avgPos: 37.9,
            medianPos: 32.5,
            dist: { excellent: 12, good: 16, neutral: 13, weak: 18, poor: 37 },
            top5: [
                { name: '事欣科三', high: 215.0, low: 93.2, monthly: 215.0, pos: 100.0 },
                { name: '維田一', high: 185.0, low: 103.8, monthly: 185.0, pos: 100.0 },
                { name: '台光電五', high: 388.0, low: 97.0, monthly: 382.4, pos: 98.1 },
                { name: '台灣銘板一', high: 496.0, low: 113.5, monthly: 479.0, pos: 95.6 },
                { name: '良維九', high: 208.0, low: 108.2, monthly: 203.0, pos: 95.0 }
            ].map(enrichItem),
            bottom5: [
                { name: '海德威一', high: 133.3, low: 99.7, monthly: 99.8, pos: 0.4 },
                { name: '立積一', high: 208.0, low: 99.5, monthly: 100.0, pos: 0.4 },
                { name: '明安三', high: 145.0, low: 99.6, monthly: 99.9, pos: 0.6 },
                { name: '風青二', high: 136.9, low: 99.7, monthly: 100.1, pos: 1.0 },
                { name: '大樹二', high: 155.0, low: 99.3, monthly: 99.9, pos: 1.0 }
            ].map(enrichItem),
            summary: '平均位置37.9%偏低，38.5%標的目前處於極弱區(<20%)，多數曾經輝煌現已回落。'
        },
        2023: {
            total: 91,
            avgPos: 36.0,
            medianPos: 29.5,
            dist: { excellent: 6, good: 13, neutral: 16, weak: 23, poor: 33 },
            top5: [
                { name: '泰茂四', high: 470.0, low: 121.5, monthly: 466.4, pos: 99.0 },
                { name: '百達二K', high: 215.0, low: 104.0, monthly: 207.5, pos: 93.2 },
                { name: '旭品三', high: 236.0, low: 115.3, monthly: 225.8, pos: 91.5 },
                { name: '碩天二', high: 179.0, low: 111.0, monthly: 172.7, pos: 90.7 },
                { name: '事欣科四', high: 199.0, low: 99.5, monthly: 185.6, pos: 86.5 }
            ].map(enrichItem),
            bottom5: [
                { name: '森崴能源一', high: 167.0, low: 97.8, monthly: 98.4, pos: 0.9 },
                { name: '高林一', high: 135.0, low: 99.8, monthly: 100.4, pos: 1.7 },
                { name: '世德二', high: 156.0, low: 96.0, monthly: 97.1, pos: 1.9 },
                { name: '弘帆一', high: 147.8, low: 100.0, monthly: 101.4, pos: 2.9 },
                { name: '御嵿一', high: 159.0, low: 102.1, monthly: 104.1, pos: 3.6 }
            ].map(enrichItem),
            summary: '平均位置36%，36%標的極弱。冠軍泰茂四仍維持高檔(99%)，但多數已回落至低點。'
        },
        2024: {
            total: 139,
            avgPos: 36.8,
            medianPos: 33.6,
            dist: { excellent: 9, good: 19, neutral: 29, weak: 33, poor: 49 },
            top5: [
                { name: '群翊二', high: 120.4, low: 95.5, monthly: 118.2, pos: 90.9 },
                { name: 'jpp三K', high: 202.0, low: 95.0, monthly: 192.0, pos: 90.6 },
                { name: '雙鴻五', high: 151.0, low: 105.0, monthly: 145.8, pos: 88.7 },
                { name: '嘉晶五', high: 110.9, low: 92.0, monthly: 108.6, pos: 87.9 },
                { name: '南俊國際二', high: 155.0, low: 98.0, monthly: 147.0, pos: 85.9 }
            ].map(enrichItem),
            bottom5: [
                { name: '倍力一', high: 111.0, low: 97.5, monthly: 97.5, pos: 0.0 },
                { name: '六角三', high: 133.0, low: 99.8, monthly: 100.3, pos: 1.6 },
                { name: '弘帆三', high: 155.0, low: 96.0, monthly: 98.1, pos: 3.5 },
                { name: '耀勝一', high: 155.0, low: 97.6, monthly: 99.7, pos: 3.7 },
                { name: '其陽二', high: 125.0, low: 95.1, monthly: 96.3, pos: 4.0 }
            ].map(enrichItem),
            summary: '平均位置36.8%，35%極弱。發行量大(139檔)導致籌碼分散，多數標的表現平淡。'
        },
        2025: {
            total: 94,
            avgPos: 45.2,
            medianPos: 45.0,
            dist: { excellent: 4, good: 21, neutral: 31, weak: 24, poor: 14 },
            top5: [
                { name: '凡甲七', high: 119.5, low: 105.0, monthly: 117.5, pos: 86.2 },
                { name: '寶緯一', high: 105.0, low: 101.0, monthly: 104.4, pos: 84.0 },
                { name: '聯合五', high: 126.7, low: 106.0, monthly: 123.0, pos: 82.5 },
                { name: '旺矽五', high: 232.0, low: 96.5, monthly: 206.1, pos: 80.9 },
                { name: '華電網五', high: 116.2, low: 100.2, monthly: 112.9, pos: 79.6 }
            ].map(enrichItem),
            bottom5: [
                { name: '皇普四', high: 112.2, low: 92.0, monthly: 92.4, pos: 2.0 },
                { name: '泓德能源二', high: 114.0, low: 89.9, monthly: 90.7, pos: 3.4 },
                { name: '聯寶一', high: 110.0, low: 102.0, monthly: 102.8, pos: 9.2 },
                { name: '平和環保一創', high: 118.0, low: 107.3, monthly: 108.3, pos: 9.3 },
                { name: '倉和一', high: 101.0, low: 91.8, monthly: 92.8, pos: 10.8 }
            ].map(enrichItem),
            summary: '平均位置45.2%較高，極弱僅14.9%。2025年發行標的相對較新，尚未大幅回落。'
        }
    };

    // 預設顯示2025年（最新）
    showRealPerfYear(2025);
}

function showRealPerfYear(year, event) {
    // 防止頁面跳動
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // 更新tab狀態
    document.querySelectorAll('.realperf-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent == year) {
            tab.classList.add('active');
        }
    });

    const data = realPerfData[year];
    if (!data) return;

    // 統計分布區塊
    let html = `
    <div class="realperf-stats">
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">🟢極佳(80%↑)</div>
            <div class="realperf-stat-value green">${data.dist.excellent}</div>
        </div>
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">🔵良好(60-80%)</div>
            <div class="realperf-stat-value blue">${data.dist.good}</div>
        </div>
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">⚪中性(40-60%)</div>
            <div class="realperf-stat-value gray">${data.dist.neutral}</div>
        </div>
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">🟡偏弱(20-40%)</div>
            <div class="realperf-stat-value orange">${data.dist.weak}</div>
        </div>
        <div class="realperf-stat-box">
            <div class="realperf-stat-label">🔴極弱(<20%)</div>
            <div class="realperf-stat-value red">${data.dist.poor}</div>
        </div>
    </div>
    <div style="text-align:center; font-size:10px; color:#666; margin-bottom:10px;">
        平均位置: <b style="color:#1565c0">${data.avgPos}%</b> ｜ 中位數: <b style="color:#1565c0">${data.medianPos}%</b> ｜ 樣本數: ${data.total}檔
    </div>

    <div class="realperf-grid">
        <div class="realperf-box top">
            <div class="realperf-box-title">🔴 月均接近高點 TOP5</div>
            <table class="realperf-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>代號</th>
                        <th>名稱</th>
                        <th>類型</th>
                        <th>狀態</th>
                        <th>掛牌高</th>
                        <th>掛牌低</th>
                        <th>月均價</th>
                        <th>位置</th>
                    </tr>
                </thead>
                <tbody>`;

    data.top5.forEach((item, idx) => {
        const typeClass = item.type === '競拍' ? 'auction' : 'inquiry';
        const statusClass = item.status === '掛牌中' ? 'listed' : 'delisted';
        html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${item.id || '-'}</td>
                        <td>${item.name}</td>
                        <td><span class="ranking-type ${typeClass}">${item.type || '-'}</span></td>
                        <td><span class="dimension-status-badge ${statusClass}">${item.status || '已下市'}</span></td>
                        <td>${item.high.toFixed(1)}</td>
                        <td>${item.low.toFixed(1)}</td>
                        <td>${item.monthly.toFixed(1)}</td>
                        <td><span class="realperf-pos high">${item.pos.toFixed(1)}%</span></td>
                    </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="realperf-box bottom">
            <div class="realperf-box-title">🟢 月均接近低點 BOTTOM5</div>
            <table class="realperf-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>代號</th>
                        <th>名稱</th>
                        <th>類型</th>
                        <th>狀態</th>
                        <th>掛牌高</th>
                        <th>掛牌低</th>
                        <th>月均價</th>
                        <th>位置</th>
                    </tr>
                </thead>
                <tbody>`;

    data.bottom5.forEach((item, idx) => {
        const typeClass = item.type === '競拍' ? 'auction' : 'inquiry';
        const statusClass = item.status === '掛牌中' ? 'listed' : 'delisted';
        html += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${item.id || '-'}</td>
                        <td>${item.name}</td>
                        <td><span class="ranking-type ${typeClass}">${item.type || '-'}</span></td>
                        <td><span class="dimension-status-badge ${statusClass}">${item.status || '已下市'}</span></td>
                        <td>${item.high.toFixed(1)}</td>
                        <td>${item.low.toFixed(1)}</td>
                        <td>${item.monthly.toFixed(1)}</td>
                        <td><span class="realperf-pos low">${item.pos.toFixed(1)}%</span></td>
                    </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>
    </div>
    <div class="realperf-summary">
        📌 <strong>${year}年：</strong>${data.summary}
    </div>`;

    document.getElementById('realperfContent').innerHTML = html;
}

// v3.59 新增：競拍盈虧勝率分析
let profitLossData = {};

function generateProfitLossAnalysis() {
    // 從競拍資料計算盈虧
    const years = [2022, 2023, 2024, 2025];

    years.forEach(year => {
        // 篩選該年度有完整數據的競拍
        const yearData = auctionRawData.filter(d => {
            if (!d.openDate || !d.minBidPrice || d.minBidPrice <= 0) return false;
            if (!d.marketHigh || d.marketHigh <= 0 || !d.marketLow || d.marketLow <= 0) return false;

            let dataYear = null;
            if (typeof d.openDate === 'number') {
                const date = new Date((d.openDate - 25569) * 86400 * 1000);
                dataYear = date.getFullYear();
            } else if (typeof d.openDate === 'string') {
                const parts = d.openDate.split(/[\/\-]/);
                dataYear = parseInt(parts[0]);
                if (dataYear < 100) dataYear += 2000;
            }
            return dataYear === year;
        });

        // 計算各項指標
        let winByHigh = 0, winByLow = 0, winByAvg = 0;
        let totalProfitHigh = 0, totalProfitLow = 0, totalProfitAvg = 0;
        let details = [];

        yearData.forEach(d => {
            const minBid = d.minBidPrice;
            const avgBid = d.avgBidPrice || minBid;
            const high = d.marketHigh;
            const low = d.marketLow;

            // 以最低得標計算
            const profitByHigh = ((high - minBid) / minBid * 100);
            const profitByLow = ((low - minBid) / minBid * 100);
            const profitByAvgBid = ((high - avgBid) / avgBid * 100);

            if (high > minBid) winByHigh++;
            if (low > minBid) winByLow++;
            if (high > avgBid) winByAvg++;

            totalProfitHigh += profitByHigh;
            totalProfitLow += profitByLow;
            totalProfitAvg += profitByAvgBid;

            details.push({
                id: d.id,
                name: d.name,
                minBid: minBid,
                avgBid: avgBid,
                high: high,
                low: low,
                profitByHigh: profitByHigh,
                profitByLow: profitByLow,
                status: listedSet.has(d.id) ? '掛牌中' : '已下市'
            });
        });

        const count = yearData.length;
        profitLossData[year] = {
            total: count,
            winRateByHigh: count > 0 ? (winByHigh / count * 100) : 0,
            winRateByLow: count > 0 ? (winByLow / count * 100) : 0,
            winRateByAvg: count > 0 ? (winByAvg / count * 100) : 0,
            avgProfitHigh: count > 0 ? (totalProfitHigh / count) : 0,
            avgProfitLow: count > 0 ? (totalProfitLow / count) : 0,
            avgProfitAvg: count > 0 ? (totalProfitAvg / count) : 0,
            details: details.sort((a, b) => b.profitByHigh - a.profitByHigh)
        };
    });

    // 計算全部年度總計
    let allData = [];
    years.forEach(y => {
        if (profitLossData[y]) {
            allData = allData.concat(profitLossData[y].details);
        }
    });

    const allCount = allData.length;
    let allWinHigh = 0, allWinLow = 0, allWinAvg = 0;
    let allProfitHigh = 0, allProfitLow = 0, allProfitAvg = 0;

    allData.forEach(d => {
        if (d.high > d.minBid) allWinHigh++;
        if (d.low > d.minBid) allWinLow++;
        if (d.high > d.avgBid) allWinAvg++;
        allProfitHigh += d.profitByHigh;
        allProfitLow += d.profitByLow;
    });

    profitLossData['all'] = {
        total: allCount,
        winRateByHigh: allCount > 0 ? (allWinHigh / allCount * 100) : 0,
        winRateByLow: allCount > 0 ? (allWinLow / allCount * 100) : 0,
        winRateByAvg: allCount > 0 ? (allWinAvg / allCount * 100) : 0,
        avgProfitHigh: allCount > 0 ? (allProfitHigh / allCount) : 0,
        avgProfitLow: allCount > 0 ? (allProfitLow / allCount) : 0,
        details: allData.sort((a, b) => b.profitByHigh - a.profitByHigh)
    };

    // 預設顯示2022年
    showProfitLossYear(2022);
}

function showProfitLossYear(year, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // 更新tab狀態
    document.querySelectorAll('.profitloss-tab').forEach(tab => {
        tab.classList.remove('active');
        if ((year === 'all' && tab.textContent === '全部') || tab.textContent == year) {
            tab.classList.add('active');
        }
    });

    const data = profitLossData[year];
    if (!data) return;

    const yearLabel = year === 'all' ? '全部(2022-2025)' : year + '年';

    // 統計區塊
    let html = `
    <div class="profitloss-stats">
        <div class="profitloss-stat-box">
            <div class="profitloss-stat-label">📊 樣本數</div>
            <div class="profitloss-stat-value neutral">${data.total}檔</div>
        </div>
        <div class="profitloss-stat-box">
            <div class="profitloss-stat-label">🎯 最低得標vs掛牌高<br>勝率</div>
            <div class="profitloss-stat-value win">${data.winRateByHigh.toFixed(1)}%</div>
        </div>
        <div class="profitloss-stat-box">
            <div class="profitloss-stat-label">⚠️ 最低得標vs掛牌低<br>勝率</div>
            <div class="profitloss-stat-value ${data.winRateByLow >= 50 ? 'win' : 'lose'}">${data.winRateByLow.toFixed(1)}%</div>
        </div>
        <div class="profitloss-stat-box">
            <div class="profitloss-stat-label">📈 平均得標vs掛牌高<br>勝率</div>
            <div class="profitloss-stat-value win">${data.winRateByAvg.toFixed(1)}%</div>
        </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
        <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
            <div style="font-size:10px; color:#666;">以最低得標計 平均報酬(掛牌高)</div>
            <div style="font-size:18px; font-weight:900; color:${data.avgProfitHigh >= 0 ? '#c62828' : '#2e7d32'};">${data.avgProfitHigh >= 0 ? '+' : ''}${data.avgProfitHigh.toFixed(1)}%</div>
        </div>
        <div style="background:white; padding:10px; border-radius:8px; text-align:center;">
            <div style="font-size:10px; color:#666;">以最低得標計 平均報酬(掛牌低)</div>
            <div style="font-size:18px; font-weight:900; color:${data.avgProfitLow >= 0 ? '#c62828' : '#2e7d32'};">${data.avgProfitLow >= 0 ? '+' : ''}${data.avgProfitLow.toFixed(1)}%</div>
        </div>
    </div>

    <div style="font-size:11px; font-weight:bold; color:#ad1457; margin:10px 0 5px 0;">📋 ${yearLabel} 盈虧明細 TOP10/BOTTOM10</div>
    <div style="overflow-x:auto;">
    <table class="profitloss-table">
        <thead>
            <tr>
                <th style="width:8%;">#</th>
                <th style="width:28%;">名稱</th>
                <th style="width:16%;">得標價</th>
                <th style="width:16%;">掛牌高</th>
                <th style="width:16%;">報酬高</th>
                <th style="width:16%;">報酬低</th>
            </tr>
        </thead>
        <tbody>`;

    // TOP10
    const top10 = data.details.slice(0, 10);
    top10.forEach((item, idx) => {
        html += `
            <tr>
                <td>${idx + 1}</td>
                <td style="text-align:left; padding-left:5px;">${item.name || '-'}</td>
                <td>${item.minBid.toFixed(1)}</td>
                <td>${item.high.toFixed(1)}</td>
                <td class="val-win">+${item.profitByHigh.toFixed(1)}%</td>
                <td class="${item.profitByLow >= 0 ? 'val-win' : 'val-lose'}">${item.profitByLow >= 0 ? '+' : ''}${item.profitByLow.toFixed(1)}%</td>
            </tr>`;
    });

    // 分隔線
    html += `<tr style="background:#fce4ec;"><td colspan="6" style="text-align:center; font-size:8px; color:#ad1457;">── BOTTOM 10 ──</td></tr>`;

    // BOTTOM10
    const bottom10 = data.details.slice(-10).reverse();
    bottom10.forEach((item, idx) => {
        html += `
            <tr>
                <td>${data.details.length - 9 + idx}</td>
                <td style="text-align:left; padding-left:5px;">${item.name || '-'}</td>
                <td>${item.minBid.toFixed(1)}</td>
                <td>${item.high.toFixed(1)}</td>
                <td class="${item.profitByHigh >= 0 ? 'val-win' : 'val-lose'}">${item.profitByHigh >= 0 ? '+' : ''}${item.profitByHigh.toFixed(1)}%</td>
                <td class="${item.profitByLow >= 0 ? 'val-win' : 'val-lose'}">${item.profitByLow >= 0 ? '+' : ''}${item.profitByLow.toFixed(1)}%</td>
            </tr>`;
    });

    html += `</tbody></table></div>`;

    // 洞察
    const insight = data.winRateByLow >= 80 ?
        `${yearLabel}競拍勝率極高，即使以掛牌低計算仍有${data.winRateByLow.toFixed(0)}%機率獲利。` :
        (data.winRateByLow >= 50 ?
            `${yearLabel}競拍勝率尚可，以掛牌低計算有${data.winRateByLow.toFixed(0)}%機率獲利，但需注意選股。` :
            `${yearLabel}競拍風險較高，以掛牌低計算僅${data.winRateByLow.toFixed(0)}%機率獲利，建議嚴控投標價格。`);

    html += `
    <div class="profitloss-insight">
        <strong>💡 AI分析：</strong>${insight}
        以最低得標價計算，賣在掛牌高可獲利${data.avgProfitHigh.toFixed(1)}%，賣在掛牌低則${data.avgProfitLow >= 0 ? '仍有' + data.avgProfitLow.toFixed(1) + '%獲利空間' : '平均虧損' + Math.abs(data.avgProfitLow).toFixed(1) + '%'}。
    </div>`;

    document.getElementById('profitlossContent').innerHTML = html;
}

// v3.57 新增：維度分析總覽
// v3.58 新增：市場趨勢分析數據
let marketTrendData = {
    yearly: [], // 年度趨勢
    guarantee: {}, // 擔保比較
    size: {}, // 發行規模
    capital: {}, // 股本大小
    type: {} // 競拍vs詢圈
};


// v3.81 重構：市場趨勢分析（完全動態從資料庫生成）
function generateMarketTrendAnalysis() {
    // 合併所有CB數據
    const allCBData = [];

    // 從auctionRawData取得數據（含openDate）
    auctionRawData.forEach(d => {
        let year = null;
        if (d.openDate) {
            if (typeof d.openDate === 'number') {
                const date = new Date((d.openDate - 25569) * 86400 * 1000);
                year = date.getFullYear();
            } else if (typeof d.openDate === 'string') {
                const parts = d.openDate.split(/[\/\-]/);
                year = parseInt(parts[0]);
                if (year < 100) year += 2000;
            }
        }

        const hasMarket = d.marketHigh > 0 && d.marketLow > 0;
        const amp = hasMarket ? ((d.marketHigh - d.marketLow) / d.marketLow * 100) : 0;

        allCBData.push({
            id: d.id,
            name: d.name || '',
            type: '競拍',
            year: year,
            high: d.marketHigh || 0,
            low: d.marketLow || 0,
            amp: amp,
            hasMarket: hasMarket,
            capital: d.capital || 0,
            issueSize: d.issueSize || 0,
            conversionPrice: d.conversionPrice || 0,
            rating: d.rating || '',
            years: d.years || 0,
            guarantee: d.guarantee || '',
            industry: d.industry || '',
            broker: d.broker || '',
            isKY: ((d.name || '') + (d.companyName || '')).toUpperCase().includes('KY') ||
                  ((d.name || '') + (d.companyName || '')).toUpperCase().includes('F-')
        });
    });

    // 從inquiryRawData取得數據
    inquiryRawData.forEach(d => {
        if (allCBData.find(a => a.id === d.id)) return; // 避免重複

        // v3.92 修正：使用 listDate (掛牌日期) 來取得年度
        let year = null;
        const dateField = d.listDate || d.openDate;
        if (dateField) {
            if (typeof dateField === 'number') {
                const date = new Date((dateField - 25569) * 86400 * 1000);
                year = date.getFullYear();
            } else if (dateField instanceof Date) {
                year = dateField.getFullYear();
            } else if (typeof dateField === 'string') {
                const parts = dateField.split(/[\/\-]/);
                year = parseInt(parts[0]);
                if (year < 100) year += 2000;
            }
        }

        const hasMarket = d.marketHigh > 0 && d.marketLow > 0;
        const amp = hasMarket ? ((d.marketHigh - d.marketLow) / d.marketLow * 100) : 0;

        allCBData.push({
            id: d.id,
            name: d.name || '',
            type: '詢圈',
            year: year,
            high: d.marketHigh || 0,
            low: d.marketLow || 0,
            amp: amp,
            hasMarket: hasMarket,
            capital: d.capital || 0,
            issueSize: d.issueSize || 0,
            conversionPrice: d.conversionPrice || 0,
            rating: d.rating || '',
            years: d.years || 0,
            guarantee: d.guarantee || '',
            industry: d.industry || '',
            broker: d.broker || '',
            isKY: ((d.name || '') + (d.companyName || '')).toUpperCase().includes('KY') ||
                  ((d.name || '') + (d.companyName || '')).toUpperCase().includes('F-')
        });
    });

    // 輔助函數：計算區間統計
    function calcStats(data) {
        const withMarket = data.filter(d => d.hasMarket);
        if (withMarket.length === 0) return { count: data.length, avgHigh: 0, avgLow: 0, avgAmp: 0 };
        return {
            count: data.length,
            avgHigh: withMarket.reduce((s, d) => s + d.high, 0) / withMarket.length,
            avgLow: withMarket.reduce((s, d) => s + d.low, 0) / withMarket.length,
            avgAmp: withMarket.reduce((s, d) => s + d.amp, 0) / withMarket.length
        };
    }

    // 1. 年度數據（動態生成2010-當前年）- v3.92增強版
    const currentYear = new Date().getFullYear();
    const yearlyData = [];
    for (let y = 2010; y <= currentYear; y++) {
        const yearCB = allCBData.filter(d => d.year === y);
        const auction = yearCB.filter(d => d.type === '競拍');
        const inquiry = yearCB.filter(d => d.type === '詢圈');
        const withMarket = yearCB.filter(d => d.hasMarket);
        const avgAmp = withMarket.length > 0 ? withMarket.reduce((s, d) => s + d.amp, 0) / withMarket.length : 0;
        const avgHigh = withMarket.length > 0 ? withMarket.reduce((s, d) => s + d.high, 0) / withMarket.length : 0;
        const avgLow = withMarket.length > 0 ? withMarket.reduce((s, d) => s + d.low, 0) / withMarket.length : 0;

        // 擔保統計
        const gYear = yearCB.filter(d => d.guarantee && d.guarantee.includes('有'));
        const uYear = yearCB.filter(d => !d.guarantee || !d.guarantee.includes('有'));

        // 發行量統計
        const issueAmount = yearCB.reduce((s, d) => s + (d.issueSize || 0), 0);

        // 振幅分布
        const above50 = withMarket.filter(d => d.amp >= 50).length;
        const below20 = withMarket.filter(d => d.amp < 20).length;

        yearlyData.push({
            year: y,
            total: yearCB.length,
            auction: auction.length,
            inquiry: inquiry.length,
            guaranteed: gYear.length,
            unguaranteed: uYear.length,
            issueAmount: issueAmount,
            avgHigh: parseFloat(avgHigh.toFixed(1)),
            avgLow: parseFloat(avgLow.toFixed(1)),
            avgAmp: parseFloat(avgAmp.toFixed(1)),
            above50: above50,
            below20: below20
        });
    }
    marketTrendData.yearly = yearlyData.filter(d => d.total > 0);

    // 2. 擔保比較（動態生成）
    const guaranteed = allCBData.filter(d => d.guarantee && d.guarantee.includes('有'));
    const unguaranteed = allCBData.filter(d => !d.guarantee || d.guarantee.includes('無') || !d.guarantee.includes('有'));
    const gStats = calcStats(guaranteed);
    const uStats = calcStats(unguaranteed);

    // v3.92 新增：生成年度擔保比較資料
    const guaranteeYearlyData = [];
    for (let y = 2019; y <= currentYear; y++) {
        const gYear = guaranteed.filter(d => d.year === y);
        const uYear = unguaranteed.filter(d => d.year === y);
        const gYearStats = calcStats(gYear);
        const uYearStats = calcStats(uYear);
        if (gYear.length > 0 || uYear.length > 0) {
            guaranteeYearlyData.push({
                year: y,
                gCount: gYear.length,
                gAmp: gYearStats.avgAmp,
                uCount: uYear.length,
                uAmp: uYearStats.avgAmp
            });
        }
    }

    marketTrendData.guarantee = {
        overall: {
            guaranteed: { count: gStats.count, avgHigh: gStats.avgHigh, avgLow: gStats.avgLow, avgAmp: gStats.avgAmp },
            unguaranteed: { count: uStats.count, avgHigh: uStats.avgHigh, avgLow: uStats.avgLow, avgAmp: uStats.avgAmp }
        },
        yearly: guaranteeYearlyData
    };

    // 3. 發行規模區間（動態生成）
    const sizeRanges = [
        { label: '小於2億', min: 0, max: 2 },
        { label: '2~5億', min: 2, max: 5 },
        { label: '5~10億', min: 5, max: 10 },
        { label: '10~15億', min: 10, max: 15 },
        { label: '15~20億', min: 15, max: 20 },
        { label: '大於20億', min: 20, max: 99999 }
    ];
    marketTrendData.size = {
        ranges: sizeRanges.map(r => {
            const filtered = allCBData.filter(d => d.issueSize >= r.min && d.issueSize < r.max);
            const stats = calcStats(filtered);
            return { label: r.label, count: stats.count, avgHigh: stats.avgHigh, avgLow: stats.avgLow, avgAmp: stats.avgAmp };
        }).filter(r => r.count > 0)
    };

    // 4. 股本區間（動態生成）
    const capitalRanges = [
        { label: '小於3億', min: 0, max: 3 },
        { label: '3~6億', min: 3, max: 6 },
        { label: '6~10億', min: 6, max: 10 },
        { label: '10~15億', min: 10, max: 15 },
        { label: '15~20億', min: 15, max: 20 },
        { label: '大於20億', min: 20, max: 99999 }
    ];
    marketTrendData.capital = {
        ranges: capitalRanges.map(r => {
            const filtered = allCBData.filter(d => d.capital >= r.min && d.capital < r.max);
            const stats = calcStats(filtered);
            return { label: r.label, count: stats.count, avgHigh: stats.avgHigh, avgLow: stats.avgLow, avgAmp: stats.avgAmp };
        }).filter(r => r.count > 0)
    };

    // 5. 轉換價區間（動態生成）
    const priceRanges = [
        { label: '小於20元', min: 0, max: 20 },
        { label: '20~50元', min: 20, max: 50 },
        { label: '50~100元', min: 50, max: 100 },
        { label: '100~150元', min: 100, max: 150 },
        { label: '150~200元', min: 150, max: 200 },
        { label: '大於200元', min: 200, max: 99999 }
    ];
    marketTrendData.conversion = {
        ranges: priceRanges.map(r => {
            const filtered = allCBData.filter(d => d.conversionPrice >= r.min && d.conversionPrice < r.max);
            const stats = calcStats(filtered);
            return { label: r.label, count: stats.count, avgHigh: stats.avgHigh, avgLow: stats.avgLow, avgAmp: stats.avgAmp };
        }).filter(r => r.count > 0)
    };

    // 6. 信評區間（動態生成）
    const ratingRanges = [];
    for (let tcri = 1; tcri <= 8; tcri++) {
        const tcriStr = String(tcri);
        const filtered = allCBData.filter(d => {
            const r = String(d.rating || '').trim();
            return r === tcriStr || r === 'TCRI' + tcriStr || r === 'TCRI ' + tcriStr;
        });
        const stats = calcStats(filtered);
        if (stats.count > 0) {
            ratingRanges.push({
                label: 'TCRI ' + tcri,
                count: stats.count,
                avgHigh: parseFloat(stats.avgHigh.toFixed(1)),
                avgLow: parseFloat(stats.avgLow.toFixed(1)),
                avgAmp: parseFloat(stats.avgAmp.toFixed(1))
            });
        }
    }
    marketTrendData.rating = { ranges: ratingRanges };

    // 7. 發行年期（動態生成）
    const yearRanges = [
        { label: '3年期', min: 2.5, max: 3.5 },
        { label: '5年期', min: 4.5, max: 5.5 },
        { label: '7年期', min: 6.5, max: 7.5 }
    ];
    marketTrendData.years = {
        ranges: yearRanges.map(r => {
            const filtered = allCBData.filter(d => d.years >= r.min && d.years <= r.max);
            const stats = calcStats(filtered);
            return { label: r.label, count: stats.count, avgHigh: stats.avgHigh, avgLow: stats.avgLow, avgAmp: stats.avgAmp };
        }).filter(r => r.count > 0)
    };

    // 8. 競拍vs詢圈（動態生成）
    const auctionCB = allCBData.filter(d => d.type === '競拍');
    const inquiryCB = allCBData.filter(d => d.type === '詢圈');
    const aStats = calcStats(auctionCB);
    const iStats = calcStats(inquiryCB);

    // v3.92 新增：生成年度競拍VS詢圈比較資料
    const typeYearlyData = [];
    for (let y = 2010; y <= currentYear; y++) {
        const aYear = auctionCB.filter(d => d.year === y);
        const iYear = inquiryCB.filter(d => d.year === y);
        const aYearStats = calcStats(aYear);
        const iYearStats = calcStats(iYear);
        if (aYear.length > 0 || iYear.length > 0) {
            typeYearlyData.push({
                year: y,
                aCount: aYear.length,
                aAmp: aYearStats.avgAmp,
                iCount: iYear.length,
                iAmp: iYearStats.avgAmp
            });
        }
    }

    marketTrendData.type = {
        auction: { count: aStats.count, avgHigh: aStats.avgHigh, avgLow: aStats.avgLow, avgAmp: aStats.avgAmp },
        inquiry: { count: iStats.count, avgHigh: iStats.avgHigh, avgLow: iStats.avgLow, avgAmp: iStats.avgAmp },
        yearly: typeYearlyData
    };

    // 9. 發行次數分析（動態生成）
    const issueNumData = [];
    for (let num = 1; num <= 10; num++) {
        // 從CB名稱末尾提取發行次數（如：佳必琪三→3）
        const numChar = ['', '一', '二', '三', '四', '五', '六', '七', '八', '九', '十'][num];
        const filtered = allCBData.filter(d => {
            const name = d.name || '';
            return name.endsWith(numChar) || name.endsWith(num + 'K') || name.endsWith(numChar + 'K');
        });
        const stats = calcStats(filtered);
        if (stats.count > 0) {
            issueNumData.push({
                num: num,
                total: filtered.length,
                count: filtered.filter(d => d.hasMarket).length,
                avgHigh: parseFloat(stats.avgHigh.toFixed(1)),
                avgLow: parseFloat(stats.avgLow.toFixed(1)),
                avgAmp: parseFloat(stats.avgAmp.toFixed(1))
            });
        }
    }
    marketTrendData.issueNum = { byNumber: issueNumData, yearly: [] };

    // 10. KY股分析（動態生成）
    const kyCB = allCBData.filter(d => d.isKY);
    const nonKyCB = allCBData.filter(d => !d.isKY);
    const kyStats = calcStats(kyCB);
    const nonKyStats = calcStats(nonKyCB);

    // v3.92 新增：生成KY股年度資料
    const kyYearlyData = [];
    for (let y = 2010; y <= currentYear; y++) {
        const kyYear = kyCB.filter(d => d.year === y);
        const nonKyYear = nonKyCB.filter(d => d.year === y);
        const totalYear = kyYear.length + nonKyYear.length;

        if (totalYear > 0) {
            const kyYearStats = calcStats(kyYear);
            const nonKyYearStats = calcStats(nonKyYear);
            kyYearlyData.push({
                year: y,
                total: totalYear,
                ky: kyYear.length,
                nonKy: nonKyYear.length,
                kyRatio: (kyYear.length / totalYear) * 100,
                kyAmp: kyYearStats.avgAmp || 0,
                nonKyAmp: nonKyYearStats.avgAmp || 0
            });
        }
    }

    marketTrendData.ky = {
        overall: {
            ky: { count: kyStats.count, avgHigh: kyStats.avgHigh, avgLow: kyStats.avgLow, avgAmp: kyStats.avgAmp },
            nonKy: { count: nonKyStats.count, avgHigh: nonKyStats.avgHigh, avgLow: nonKyStats.avgLow, avgAmp: nonKyStats.avgAmp }
        },
        yearly: kyYearlyData
    };

    // 11. v3.92 新增：產業分析（動態生成）- 排除未知資料
    // v3.97-em: 新增保存各產業的CB明細
    const industryMap = {};
    allCBData.forEach(d => {
        const ind = (d.industry || '').trim();
        // 排除空白、未分類、未知等無效資料
        if (!ind || ind === '未分類' || ind === '未知' || ind === '-') return;

        if (!industryMap[ind]) {
            industryMap[ind] = { count: 0, auction: 0, inquiry: 0, ampSum: 0, ampCount: 0, highSum: 0, lowSum: 0, items: [] };
        }
        industryMap[ind].count++;
        if (d.type === '競拍') industryMap[ind].auction++;
        if (d.type === '詢圈') industryMap[ind].inquiry++;
        if (d.hasMarket) {
            industryMap[ind].ampSum += d.amp;
            industryMap[ind].highSum += d.high;
            industryMap[ind].lowSum += d.low;
            industryMap[ind].ampCount++;
        }
        // v3.97-em: 保存CB明細
        industryMap[ind].items.push({
            code: d.cbCode || d.code || '',
            name: d.cbName || d.name || '',
            high: d.high || 0,
            low: d.low || 0,
            amp: d.amp || 0,
            type: d.type || ''
        });
    });

    const validIndustryCount = Object.values(industryMap).reduce((s, d) => s + d.count, 0);
    const industryData = Object.entries(industryMap)
        .map(([name, data]) => ({
            name: name,
            count: data.count,
            auction: data.auction,
            inquiry: data.inquiry,
            avgHigh: data.ampCount > 0 ? data.highSum / data.ampCount : 0,
            avgLow: data.ampCount > 0 ? data.lowSum / data.ampCount : 0,
            avgAmp: data.ampCount > 0 ? data.ampSum / data.ampCount : 0,
            ratio: (data.count / validIndustryCount * 100),
            items: data.items // v3.97-em: 包含明細
        }))
        .sort((a, b) => b.count - a.count);

    marketTrendData.industry = industryData;

    // 12. v3.92 新增：券商分析（動態生成）- 排除未知資料
    const brokerMap = {};
    allCBData.forEach(d => {
        const broker = (d.broker || '').trim();
        // 排除空白、未知等無效資料
        if (!broker || broker === '未知' || broker === '-') return;

        if (!brokerMap[broker]) {
            brokerMap[broker] = { count: 0, auction: 0, inquiry: 0, ampSum: 0, ampCount: 0, highSum: 0, lowSum: 0 };
        }
        brokerMap[broker].count++;
        if (d.type === '競拍') brokerMap[broker].auction++;
        if (d.type === '詢圈') brokerMap[broker].inquiry++;
        if (d.hasMarket) {
            brokerMap[broker].ampSum += d.amp;
            brokerMap[broker].highSum += d.high;
            brokerMap[broker].lowSum += d.low;
            brokerMap[broker].ampCount++;
        }
    });

    const validBrokerCount = Object.values(brokerMap).reduce((s, d) => s + d.count, 0);
    const brokerData = Object.entries(brokerMap)
        .map(([name, data]) => ({
            name: name,
            count: data.count,
            auction: data.auction,
            inquiry: data.inquiry,
            avgHigh: data.ampCount > 0 ? data.highSum / data.ampCount : 0,
            avgLow: data.ampCount > 0 ? data.lowSum / data.ampCount : 0,
            avgAmp: data.ampCount > 0 ? data.ampSum / data.ampCount : 0,
            ratio: (data.count / validBrokerCount * 100)
        }))
        .sort((a, b) => b.count - a.count);

    marketTrendData.broker = brokerData;

    // 顯示預設Tab
    showMarketTrendTab('supply');
}

// v3.81 新增：右側區塊展開/收合功能
function toggleRightSection(sectionId, headerElement) {
    const content = document.getElementById(sectionId);
    if (!content) return;

    const isCollapsed = content.classList.contains('collapsed');

    if (isCollapsed) {
        // 展開
        content.classList.remove('collapsed');
        content.style.maxHeight = '800px'; // 給足夠高度
        headerElement.classList.remove('collapsed');

        // v3.97-zs-bp: 移除自動選擇，讓用戶自己選擇CB
        // 價格走勢和基本資料區塊展開時不再自動載入第一筆
        
        // v3.97-dw: 第五區塊展開時載入股票排行，同時觸發融資融券載入
        if (sectionId === 'stockRankingSection') {
            // 背景載入融資融券（如果還沒載入）
            if (!window.marginData?.loaded && !window.marginData?.loading) {
                loadMarginData();
            }
            setTimeout(() => {
                if (typeof renderHotStockTable === 'function') {
                    renderHotStockTable();
                }
            }, 100);
        }
        
        // v3.97-df: 第六區塊展開時初始化CB套利模組
        if (sectionId === 'arbitrageSection') {
            setTimeout(initArbitrageModule, 100);
        }
    } else {
        // 收合
        content.style.maxHeight = content.scrollHeight + 'px';
        setTimeout(() => {
            content.classList.add('collapsed');
            content.style.maxHeight = '0';
            headerElement.classList.add('collapsed');
        }, 10);
    }
}

// ==========================================
// v3.96 新增：通用表格排序功能
// ==========================================
function enableTableSort(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    headers.forEach((th, colIndex) => {
        th.addEventListener('click', () => sortTable(table, colIndex, th));
    });
}

function sortTable(table, colIndex, th) {
    const tbody = table.querySelector('tbody') || table;
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.classList.contains('total-row') && row.querySelector('td'));

    // 判斷目前排序方向
    const isAsc = th.classList.contains('sort-asc');
    const isDesc = th.classList.contains('sort-desc');

    // 清除所有表頭的排序狀態
    table.querySelectorAll('th').forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
    });

    // 設定新的排序方向
    let direction = 'desc'; // 預設降序
    if (isDesc) {
        direction = 'asc';
        th.classList.add('sort-asc');
    } else {
        th.classList.add('sort-desc');
    }

    // 排序
    rows.sort((a, b) => {
        const cellA = a.querySelectorAll('td')[colIndex];
        const cellB = b.querySelectorAll('td')[colIndex];
        if (!cellA || !cellB) return 0;

        let valA = cellA.textContent.trim();
        let valB = cellB.textContent.trim();

        // 移除百分比、元等單位
        valA = valA.replace(/[%元億年檔次,\s]/g, '').replace(/[（(].*[）)]/g, '');
        valB = valB.replace(/[%元億年檔次,\s]/g, '').replace(/[（(].*[）)]/g, '');

        // 嘗試轉為數字
        const numA = parseFloat(valA);
        const numB = parseFloat(valB);

        if (!isNaN(numA) && !isNaN(numB)) {
            return direction === 'asc' ? numA - numB : numB - numA;
        }

        // 字串比較
        return direction === 'asc' ? valA.localeCompare(valB, 'zh-TW') : valB.localeCompare(valA, 'zh-TW');
    });

    // 重新排列行
    const totalRow = tbody.querySelector('tr.total-row');
    rows.forEach(row => tbody.appendChild(row));
    if (totalRow) tbody.appendChild(totalRow); // 合計行始終在最後
}

// 為動態生成的表格啟用排序
function initTableSortForContent() {
    const tables = document.querySelectorAll('#marketTrendContent .trend-year-table');
    tables.forEach((table, idx) => {
        table.id = 'trendTable_' + idx;
        enableTableSort(table.id);
    });
}

function showMarketTrendTab(tab, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // 更新Tab狀態
    document.querySelectorAll('.market-trend-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.market-trend-tab').forEach(t => {
        const tabMap = {
            'supply': '供給分析',
            'yearly': '年度趨勢',
            'industry': '產業分析',
            'broker': '券商分析',
            'guarantee': '擔保比較',
            'size': '發行規模',
            'capital': '股本大小',
            'conversion': '轉換價',
            'rating': '信評',
            'yearPeriod': '發行年期',
            'type': '競拍vs詢圈',
            'issueNum': '發行次數',
            'ky': 'KY股分析'
        };
        if (t.textContent.includes(tabMap[tab])) {
            t.classList.add('active');
        }
    });

    const content = document.getElementById('marketTrendContent');
    let html = '';

    if (tab === 'supply') {
        html = renderSupplyAnalysis();
    } else if (tab === 'yearly') {
        html = renderYearlyTrend();
    } else if (tab === 'industry') {
        html = renderIndustryAnalysis();
    } else if (tab === 'broker') {
        html = renderBrokerAnalysis();
    } else if (tab === 'guarantee') {
        html = renderGuaranteeCompare();
    } else if (tab === 'size') {
        html = renderSizeCompare();
    } else if (tab === 'capital') {
        html = renderCapitalCompare();
    } else if (tab === 'conversion') {
        html = renderConversionCompare();
    } else if (tab === 'rating') {
        html = renderRatingCompare();
    } else if (tab === 'yearPeriod') {
        html = renderYearPeriodCompare();
    } else if (tab === 'type') {
        html = renderTypeCompare();
    } else if (tab === 'issueNum') {
        html = renderIssueNumAnalysis();
    } else if (tab === 'ky') {
        html = renderKYAnalysis();
    }

    content.innerHTML = html;

    // v3.96 新增：啟用表格排序功能
    setTimeout(() => initTableSortForContent(), 100);
}

function renderYearlyTrend() {
    const data = marketTrendData.yearly;
    if (!data || data.length === 0) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">📊 各年度發行統計與績效分析（2010-2025）</div>
    <div class="trend-table-wrapper">
    <table class="trend-year-table">
        <tr>
            <th class="sortable">年度</th>
            <th class="sortable">總檔數</th>
            <th class="sortable">發行量(億)</th>
            <th class="sortable">有擔保</th>
            <th class="sortable">無擔保</th>
            <th class="sortable">掛牌均高</th>
            <th class="sortable">掛牌均低</th>
            <th class="sortable">平均振幅</th>
        </tr>`;

    let totalAll = 0, totalAmount = 0, totalGuaranteed = 0, totalUnguaranteed = 0;
    let sumHigh = 0, sumLow = 0, countWithMarket = 0;
    data.forEach(d => {
        const ampClass = d.avgAmp >= 80 ? 'amp-high' : (d.avgAmp < 30 ? 'amp-low' : '');
        const gRatio = d.total > 0 ? (d.guaranteed / d.total * 100).toFixed(0) : 0;
        const uRatio = d.total > 0 ? (d.unguaranteed / d.total * 100).toFixed(0) : 0;
        html += `
        <tr>
            <td class="year-cell">${d.year}年</td>
            <td><b>${d.total}</b></td>
            <td>${d.issueAmount > 0 ? d.issueAmount.toFixed(0) : '-'}</td>
            <td style="color:#2e7d32;">${d.guaranteed}(${gRatio}%)</td>
            <td style="color:#e65100;">${d.unguaranteed}(${uRatio}%)</td>
            <td style="color:#2e7d32;">${d.avgHigh > 0 ? d.avgHigh.toFixed(1) : '-'}</td>
            <td style="color:#c62828;">${d.avgLow > 0 ? d.avgLow.toFixed(1) : '-'}</td>
            <td class="${ampClass}">${d.avgAmp > 0 ? d.avgAmp.toFixed(1) + '%' : '-'}</td>
        </tr>`;
        totalAll += d.total;
        totalAmount += d.issueAmount || 0;
        totalGuaranteed += d.guaranteed || 0;
        totalUnguaranteed += d.unguaranteed || 0;
        if (d.avgHigh > 0) { sumHigh += d.avgHigh; countWithMarket++; }
        if (d.avgLow > 0) { sumLow += d.avgLow; }
    });

    // 合計列
    const gRatioTotal = totalAll > 0 ? (totalGuaranteed / totalAll * 100).toFixed(0) : 0;
    const uRatioTotal = totalAll > 0 ? (totalUnguaranteed / totalAll * 100).toFixed(0) : 0;
    const avgHighTotal = countWithMarket > 0 ? (sumHigh / countWithMarket).toFixed(1) : '-';
    const avgLowTotal = countWithMarket > 0 ? (sumLow / countWithMarket).toFixed(1) : '-';
    html += `
        <tr class="total-row">
            <td><b>平均</b></td>
            <td><b>${totalAll}</b></td>
            <td><b>${totalAmount.toFixed(0)}</b></td>
            <td style="color:#2e7d32;"><b>${totalGuaranteed}(${gRatioTotal}%)</b></td>
            <td style="color:#e65100;"><b>${totalUnguaranteed}(${uRatioTotal}%)</b></td>
            <td style="color:#2e7d32;"><b>${avgHighTotal}</b></td>
            <td style="color:#c62828;"><b>${avgLowTotal}</b></td>
            <td>-</td>
        </tr>`;

    html += `</table></div>`;

    // 趨勢洞察
    const peak = data.reduce((max, d) => d.avgAmp > max.avgAmp ? d : max, data[0]);
    const peakCount = data.reduce((max, d) => d.total > max.total ? d : max, data[0]);

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI趨勢觀察</div>
        <div class="insight-content">
            發行量高峰為${peakCount.year}年(${peakCount.total}檔)，振幅高峰為${peak.year}年(${peak.avgAmp.toFixed(1)}%)。<br>
            有擔保CB整體占比${gRatioTotal}%，振幅表現通常較穩定但偏低。<br>
            近年無擔保比例提高，市場波動加大，選股需更謹慎評估信用風險。
        </div>
    </div>`;

    return html;
}

function renderGuaranteeCompare() {
    const overall = marketTrendData.guarantee.overall;
    const yearly = marketTrendData.guarantee.yearly;

    const g = overall.guaranteed;
    const u = overall.unguaranteed;

    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">📊 整體擔保比較（全部年度）</div>
    <div class="trend-compare-grid">
        <div class="trend-compare-card">
            <h4>🛡️ 有擔保</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">檔數</span>
                <span class="trend-compare-value">${g.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均高</span>
                <span class="trend-compare-value">${g.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均低</span>
                <span class="trend-compare-value">${g.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">平均振幅</span>
                <span class="trend-compare-value ${g.avgAmp > u.avgAmp ? 'positive' : ''}">${g.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
        <div class="trend-compare-card">
            <h4>📋 無擔保</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">檔數</span>
                <span class="trend-compare-value">${u.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均高</span>
                <span class="trend-compare-value">${u.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均低</span>
                <span class="trend-compare-value">${u.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">平均振幅</span>
                <span class="trend-compare-value ${u.avgAmp > g.avgAmp ? 'positive' : ''}">${u.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
    </div>`;

    // 加入多年度表格
    if (yearly && yearly.length > 0) {
        html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin:15px 0 10px 0;">📈 各年度 有擔保 vs 無擔保 振幅比較</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">年度</th>
            <th class="sortable">有擔保</th>
            <th class="sortable">振幅</th>
            <th class="sortable">無擔保</th>
            <th class="sortable">振幅</th>
            <th>勝出</th>
        </tr>`;

        yearly.forEach(y => {
            const winner = y.gAmp > y.uAmp ? '有擔保' : '無擔保';
            const winnerColor = winner === '有擔保' ? '#2e7d32' : '#1565c0';
            html += `
        <tr>
            <td class="year-cell">${y.year}年</td>
            <td>${y.gCount}</td>
            <td class="${y.gAmp > y.uAmp ? 'amp-high' : ''}">${y.gAmp.toFixed(1)}%</td>
            <td>${y.uCount}</td>
            <td class="${y.uAmp > y.gAmp ? 'amp-high' : ''}">${y.uAmp.toFixed(1)}%</td>
            <td style="color:${winnerColor}; font-weight:bold;">${winner}</td>
        </tr>`;
        });
        html += `</table>`;
    }

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            整體<strong>有擔保(77.0%)</strong>振幅高於無擔保(63.4%)。
            但各年度表現不一，2020/2022/2024年無擔保反而較佳。
            有擔保提供較高安全邊際，適合穩健型投資人。
        </div>
    </div>`;

    return html;
}

function renderSizeCompare() {
    const ranges = marketTrendData.size.ranges;
    if (!ranges || ranges.length === 0) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">📊 發行規模區間統計（全部年度，依05工作表設定）</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">規模區間</th>
            <th class="sortable">檔數</th>
            <th class="sortable">掛牌均高</th>
            <th class="sortable">掛牌均低</th>
            <th class="sortable">平均振幅</th>
        </tr>`;

    const maxAmp = Math.max(...ranges.map(r => r.avgAmp));
    ranges.forEach(r => {
        const ampClass = r.avgAmp === maxAmp ? 'amp-high' : (r.avgAmp < 65 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh.toFixed(1)}</td>
            <td>${r.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${r.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            <strong>小於2億(88.1%)</strong>振幅最高，2~10億為甜蜜區間(70-71%)。
            規模越大振幅越低，但大規模(>20億)仍有63.7%，流動性較佳。
            選股時可優先考慮2~10億的中小規模CB。
        </div>
    </div>`;

    return html;
}

function renderCapitalCompare() {
    const ranges = marketTrendData.capital.ranges;
    if (!ranges || ranges.length === 0) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">📊 股本區間統計（全部年度，依05工作表設定）</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">股本區間</th>
            <th class="sortable">檔數</th>
            <th class="sortable">掛牌均高</th>
            <th class="sortable">掛牌均低</th>
            <th class="sortable">平均振幅</th>
        </tr>`;

    const maxAmp = Math.max(...ranges.map(r => r.avgAmp));
    ranges.forEach(r => {
        const ampClass = r.avgAmp === maxAmp ? 'amp-high' : (r.avgAmp < 60 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh.toFixed(1)}</td>
            <td>${r.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${r.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            <strong>6~10億(79.8%)</strong>振幅最高，為最佳股本區間。
            小股本(<6億)因股價波動大，反而振幅較低(55-58%)。
            大股本(>20億)企業通常較穩定，振幅適中(66.9%)。
        </div>
    </div>`;

    return html;
}

// v3.59 新增：轉換價區間分析
function renderConversionCompare() {
    const ranges = marketTrendData.conversion.ranges;
    if (!ranges || ranges.length === 0) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">📊 轉換價區間統計（全部年度，依05工作表設定）</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">轉換價區間</th>
            <th class="sortable">檔數</th>
            <th class="sortable">掛牌均高</th>
            <th class="sortable">掛牌均低</th>
            <th class="sortable">平均振幅</th>
        </tr>`;

    const maxAmp = Math.max(...ranges.map(r => r.avgAmp));
    ranges.forEach(r => {
        const ampClass = r.avgAmp === maxAmp ? 'amp-high' : (r.avgAmp < 60 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh.toFixed(1)}</td>
            <td>${r.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${r.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            <strong>低轉換價(<50元)</strong>振幅較高(74-77%)，主因低價股波動空間大。
            轉換價150~200元振幅最低(52.7%)，高價股相對穩定。
            轉換價>200元反而回升至57.2%，可能因多為優質高成長股。
        </div>
    </div>`;

    return html;
}

// v3.59 新增：信評區間分析
function renderRatingCompare() {
    const ranges = marketTrendData.rating.ranges;
    if (!ranges || ranges.length === 0) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">📊 信評區間統計（從00工作表E欄動態計算）</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">信評等級</th>
            <th class="sortable">檔數</th>
            <th class="sortable">掛牌均高</th>
            <th class="sortable">掛牌均低</th>
            <th class="sortable">平均振幅</th>
        </tr>`;

    const validRanges = ranges.filter(r => r.count > 0 && r.avgAmp > 0);
    const maxAmp = validRanges.length > 0 ? Math.max(...validRanges.map(r => r.avgAmp)) : 0;
    const minAmp = validRanges.length > 0 ? Math.min(...validRanges.map(r => r.avgAmp)) : 0;

    ranges.forEach(r => {
        if (r.count === 0) return;
        const ampClass = r.avgAmp === maxAmp ? 'amp-high' : (r.avgAmp === minAmp && r.avgAmp > 0 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh > 0 ? r.avgHigh.toFixed(1) : '-'}</td>
            <td>${r.avgLow > 0 ? r.avgLow.toFixed(1) : '-'}</td>
            <td class="${ampClass}">${r.avgAmp > 0 ? r.avgAmp.toFixed(1) + '%' : '-'}</td>
        </tr>`;
    });
    html += `</table>`;

    // 動態生成結論
    let bestRange = validRanges.length > 0 ? validRanges.reduce((a, b) => a.avgAmp > b.avgAmp ? a : b) : null;
    let mostRange = validRanges.length > 0 ? validRanges.reduce((a, b) => a.count > b.count ? a : b) : null;

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            ${bestRange ? `<strong>${bestRange.label}(${bestRange.avgAmp.toFixed(1)}%)</strong>振幅最高${bestRange.count < 30 ? '但樣本較少(' + bestRange.count + '檔)' : '(' + bestRange.count + '檔)'}。` : ''}
            ${mostRange && mostRange !== bestRange ? `<strong>${mostRange.label}(${mostRange.avgAmp.toFixed(1)}%/${mostRange.count}檔)</strong>樣本數最多，可作為主要參考。` : ''}
            信評等級越低（數字越大），通常代表信用風險較高，需謹慎評估。
        </div>
    </div>`;

    return html;
}

// v3.59 新增：發行年期分析
function renderYearPeriodCompare() {
    const ranges = marketTrendData.years.ranges;
    if (!ranges || ranges.length === 0) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">📊 發行年期統計（全部年度，依05工作表設定）</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">發行年期</th>
            <th class="sortable">檔數</th>
            <th class="sortable">掛牌均高</th>
            <th class="sortable">掛牌均低</th>
            <th class="sortable">平均振幅</th>
        </tr>`;

    ranges.forEach(r => {
        const ampClass = r.avgAmp > 80 ? 'amp-high' : (r.avgAmp < 65 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">${r.label}</td>
            <td>${r.count}</td>
            <td>${r.avgHigh.toFixed(1)}</td>
            <td>${r.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${r.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            <strong>5年期(86.9%)</strong>振幅最佳，為CB發行的黃金年期。
            3年期為主流(1047檔)，振幅62.2%相對穩健。
            7年期目前僅1檔(新唐一)，振幅363.9%為特例，不具統計意義。
        </div>
    </div>`;

    return html;
}

function renderTypeCompare() {
    const a = marketTrendData.type.auction;
    const i = marketTrendData.type.inquiry;

    const winner = a.avgAmp > i.avgAmp ? '競拍' : '詢圈';
    const diff = Math.abs(a.avgAmp - i.avgAmp).toFixed(1);

    let html = `
    <div class="trend-compare-grid">
        <div class="trend-compare-card">
            <h4>🎯 競拍</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">檔數</span>
                <span class="trend-compare-value">${a.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均高</span>
                <span class="trend-compare-value">${a.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均低</span>
                <span class="trend-compare-value">${a.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">平均振幅</span>
                <span class="trend-compare-value ${a.avgAmp > i.avgAmp ? 'positive' : ''}">${a.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
        <div class="trend-compare-card">
            <h4>📋 詢圈</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">檔數</span>
                <span class="trend-compare-value">${i.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均高</span>
                <span class="trend-compare-value">${i.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均低</span>
                <span class="trend-compare-value">${i.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">平均振幅</span>
                <span class="trend-compare-value ${i.avgAmp > a.avgAmp ? 'positive' : ''}">${i.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
    </div>`;

    // v3.92 新增：年度競拍VS詢圈比較表格
    const yearly = marketTrendData.type.yearly;
    if (yearly && yearly.length > 0) {
        html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin:15px 0 10px 0;">📈 各年度 競拍 vs 詢圈 振幅比較</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">年度</th>
            <th class="sortable">競拍</th>
            <th class="sortable">振幅</th>
            <th class="sortable">詢圈</th>
            <th class="sortable">振幅</th>
            <th>勝出</th>
        </tr>`;

        yearly.forEach(y => {
            const winner = y.aAmp > y.iAmp ? '競拍' : (y.iAmp > y.aAmp ? '詢圈' : '-');
            const winnerColor = winner === '競拍' ? '#e65100' : '#1565c0';
            html += `
        <tr>
            <td class="year-cell">${y.year}年</td>
            <td style="color:#e65100;">${y.aCount > 0 ? y.aCount : '-'}</td>
            <td class="${y.aAmp > y.iAmp ? 'amp-high' : ''}">${y.aCount > 0 ? y.aAmp.toFixed(1) + '%' : '-'}</td>
            <td style="color:#1565c0;">${y.iCount > 0 ? y.iCount : '-'}</td>
            <td class="${y.iAmp > y.aAmp ? 'amp-high' : ''}">${y.iCount > 0 ? y.iAmp.toFixed(1) + '%' : '-'}</td>
            <td style="color:${winnerColor}; font-weight:bold;">${winner}</td>
        </tr>`;
        });
        html += `</table>`;
    }

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            <strong>${winner}</strong>整體振幅較高，差距${diff}%。
            ${winner === '詢圈' ? '詢圈案例數據量大(涵蓋歷年)，表現優於競拍。但2019年後競拍制度上路，近年數據須分開觀察。' : '競拍透過公開拍賣取得籌碼，市場對其定價較為理性。'}
        </div>
    </div>`;

    return html;
}

// v3.59 新增：發行次數分析
function renderIssueNumAnalysis() {
    const data = marketTrendData.issueNum;
    if (!data) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin-bottom:10px;">📊 各發行次數掛牌表現（全部年度，完整到第10次）</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">發行次數</th>
            <th class="sortable">總檔數</th>
            <th class="sortable">有掛牌</th>
            <th class="sortable">掛牌均高</th>
            <th class="sortable">掛牌均低</th>
            <th class="sortable">平均振幅</th>
        </tr>`;

    const byNum = data.byNumber;
    byNum.forEach(d => {
        const ampClass = d.avgAmp >= 80 ? 'amp-high' : (d.avgAmp < 65 ? 'amp-low' : '');
        html += `
        <tr>
            <td class="year-cell">第${d.num}次</td>
            <td>${d.total}</td>
            <td>${d.count}</td>
            <td>${d.avgHigh.toFixed(1)}</td>
            <td>${d.avgLow.toFixed(1)}</td>
            <td class="${ampClass}">${d.avgAmp.toFixed(1)}%</td>
        </tr>`;
    });
    html += `</table>`;

    // 年度首發 vs 多次發行比較（多年度）
    html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin:15px 0 10px 0;">📈 各年度 首次發行 vs 多次發行（2010-2025）</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">年度</th>
            <th class="sortable">首發</th>
            <th class="sortable">首發振幅</th>
            <th class="sortable">多次</th>
            <th class="sortable">多次振幅</th>
            <th>勝出</th>
        </tr>`;

    const yearly = data.yearly;
    yearly.forEach(y => {
        const winner = y.firstAmp > y.multiAmp ? '首發' : '多次';
        const winnerColor = winner === '首發' ? '#2e7d32' : '#1565c0';
        html += `
        <tr>
            <td class="year-cell">${y.year}年</td>
            <td>${y.first}</td>
            <td class="${y.firstAmp > y.multiAmp ? 'amp-high' : ''}">${y.firstAmp.toFixed(1)}%</td>
            <td>${y.multi}</td>
            <td class="${y.multiAmp > y.firstAmp ? 'amp-high' : ''}">${y.multiAmp.toFixed(1)}%</td>
            <td style="color:${winnerColor}; font-weight:bold;">${winner}</td>
        </tr>`;
    });
    html += `</table>`;

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            整體而言，<strong>首次發行(80.2%)</strong>振幅略高於多次發行。
            第9次發行振幅最高(127.7%)但僅5檔，屬特例。
            發行次數達5次以上時振幅下降至63-69%區間。
            近年(2024-2025)差距縮小，市場對發行次數敏感度降低。
        </div>
    </div>`;

    return html;
}

// v3.59 新增：KY股分析（多年度）
function renderKYAnalysis() {
    const data = marketTrendData.ky;
    if (!data) return '<div>暫無數據</div>';

    const ky = data.overall.ky;
    const nonKy = data.overall.nonKy;

    let html = `
    <div class="trend-compare-grid">
        <div class="trend-compare-card">
            <h4>🌏 KY股（海外企業）</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">檔數</span>
                <span class="trend-compare-value">${ky.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均高</span>
                <span class="trend-compare-value">${ky.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均低</span>
                <span class="trend-compare-value">${ky.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">平均振幅</span>
                <span class="trend-compare-value ${ky.avgAmp > nonKy.avgAmp ? 'positive' : 'negative'}">${ky.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
        <div class="trend-compare-card">
            <h4>🇹🇼 非KY股（本土企業）</h4>
            <div class="trend-compare-row">
                <span class="trend-compare-label">檔數</span>
                <span class="trend-compare-value">${nonKy.count}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均高</span>
                <span class="trend-compare-value">${nonKy.avgHigh.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">掛牌均低</span>
                <span class="trend-compare-value">${nonKy.avgLow.toFixed(1)}</span>
            </div>
            <div class="trend-compare-row">
                <span class="trend-compare-label">平均振幅</span>
                <span class="trend-compare-value ${nonKy.avgAmp > ky.avgAmp ? 'positive' : ''}">${nonKy.avgAmp.toFixed(1)}%</span>
            </div>
        </div>
    </div>`;

    // 年度KY股統計表（多年度2010-2025）
    html += `
    <div style="font-size:12px; font-weight:bold; color:#e65100; margin:15px 0 10px 0;">📈 各年度KY股 vs 非KY股表現（2010-2025）</div>
    <table class="trend-year-table">
        <tr>
            <th class="sortable">年度</th>
            <th class="sortable">總檔數</th>
            <th class="sortable">KY檔數</th>
            <th class="sortable">KY比例</th>
            <th class="sortable">KY振幅</th>
            <th class="sortable">非KY振幅</th>
            <th>勝出</th>
        </tr>`;

    const yearly = data.yearly;
    yearly.forEach(y => {
        if (y.ky === 0) return; // 跳過沒有KY股的年度
        const winner = y.kyAmp > y.nonKyAmp ? 'KY' : '非KY';
        const winnerColor = winner === 'KY' ? '#9c27b0' : '#2e7d32';
        html += `
        <tr>
            <td class="year-cell">${y.year}年</td>
            <td>${y.total}</td>
            <td>${y.ky}</td>
            <td>${y.kyRatio.toFixed(1)}%</td>
            <td class="${y.kyAmp > y.nonKyAmp ? 'amp-high' : ''}">${y.kyAmp.toFixed(1)}%</td>
            <td class="${y.nonKyAmp > y.kyAmp ? 'amp-high' : ''}">${y.nonKyAmp.toFixed(1)}%</td>
            <td style="color:${winnerColor}; font-weight:bold;">${winner}</td>
        </tr>`;
    });
    html += `</table>`;

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI分析結論</div>
        <div class="insight-content">
            整體而言，<strong>非KY股(77.6%)</strong>振幅高於KY股(63.5%)。
            但2022年KY股振幅高達142.9%大幅領先，顯示KY股波動較大、個案差異明顯。
            KY股比例維持約7-15%，2025年KY股表現(14.1%)遠低於非KY股(24.0%)，
            投資KY股CB需更謹慎選股。
        </div>
    </div>`;

    return html;
}

// v3.92 新增：產業分析渲染函數
// v3.97-em: 加入可展開的CB明細
function renderIndustryAnalysis() {
    const data = marketTrendData.industry;
    if (!data || data.length === 0) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">🏭 產業分布與績效分析 <span style="font-size:11px; font-weight:normal; color:#888;">(點擊產業展開明細)</span></div>
    <div class="trend-table-wrapper">
    <table class="trend-year-table" id="industryTable">
        <tr>
            <th style="width:30%;">產業</th>
            <th style="width:12%;">檔數</th>
            <th style="width:12%;">占比</th>
            <th style="width:15%;">掛牌均高</th>
            <th style="width:15%;">掛牌均低</th>
            <th style="width:16%;">平均振幅</th>
        </tr>`;

    // 只顯示前15個產業
    const topData = data.slice(0, 15);
    topData.forEach((d, idx) => {
        const ampClass = d.avgAmp >= 80 ? 'amp-high' : (d.avgAmp < 30 ? 'amp-low' : '');
        const rankIcon = idx < 3 ? ['🥇', '🥈', '🥉'][idx] : '';
        const safeId = d.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
        html += `
        <tr onclick="toggleIndustryDetail('${safeId}', ${idx})" style="cursor:pointer;" class="industry-row" id="industry-row-${idx}">
            <td style="text-align:left; font-weight:${idx < 3 ? 'bold' : 'normal'};">
                <span id="industry-icon-${idx}" style="display:inline-block; width:16px; transition:transform 0.2s;">▶</span>
                ${rankIcon} ${d.name}
            </td>
            <td><b>${d.count}</b></td>
            <td>${d.ratio.toFixed(1)}%</td>
            <td style="color:#2e7d32;">${d.avgHigh > 0 ? d.avgHigh.toFixed(1) : '-'}</td>
            <td style="color:#c62828;">${d.avgLow > 0 ? d.avgLow.toFixed(1) : '-'}</td>
            <td class="${ampClass}">${d.avgAmp > 0 ? d.avgAmp.toFixed(1) + '%' : '-'}</td>
        </tr>
        <tr id="industry-detail-${idx}" style="display:none;">
            <td colspan="6" style="padding:0; background:#f5f5f5;">
                <div style="max-height:200px; overflow-y:auto; padding:8px;">
                    <table style="width:100%; font-size:11px; border-collapse:collapse;">
                        <tr style="background:#e0e0e0;">
                            <th style="padding:4px 6px; text-align:left;">代號</th>
                            <th style="padding:4px 6px; text-align:left;">名稱</th>
                            <th style="padding:4px 6px; text-align:center;">類型</th>
                            <th style="padding:4px 6px; text-align:right;">掛牌高</th>
                            <th style="padding:4px 6px; text-align:right;">掛牌低</th>
                            <th style="padding:4px 6px; text-align:right;">振幅</th>
                        </tr>
                        ${d.items.sort((a,b) => b.amp - a.amp).map(item => `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:4px 6px; color:#1565c0; font-weight:600;">${item.code}</td>
                            <td style="padding:4px 6px;">${item.name}</td>
                            <td style="padding:4px 6px; text-align:center; color:${item.type === '競拍' ? '#ff6f00' : '#1565c0'};">${item.type}</td>
                            <td style="padding:4px 6px; text-align:right; color:#2e7d32;">${item.high > 0 ? item.high.toFixed(1) : '-'}</td>
                            <td style="padding:4px 6px; text-align:right; color:#c62828;">${item.low > 0 ? item.low.toFixed(1) : '-'}</td>
                            <td style="padding:4px 6px; text-align:right; font-weight:600; color:${item.amp >= 50 ? '#2e7d32' : (item.amp < 20 ? '#c62828' : '#333')};">${item.amp > 0 ? item.amp.toFixed(1) + '%' : '-'}</td>
                        </tr>
                        `).join('')}
                    </table>
                </div>
            </td>
        </tr>`;
    });

    html += `</table></div>`;

    // 分析結論
    const best = data.filter(d => d.avgAmp > 0).sort((a, b) => b.avgAmp - a.avgAmp)[0];
    const worst = data.filter(d => d.avgAmp > 0 && d.count >= 5).sort((a, b) => a.avgAmp - b.avgAmp)[0];

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI產業觀察</div>
        <div class="insight-content">
            ${data[0] ? `發行量最大產業為<strong>${data[0].name}</strong>(${data[0].count}檔，占${data[0].ratio.toFixed(1)}%)。` : ''}
            ${best ? `振幅最佳產業為<strong>${best.name}</strong>(${best.avgAmp.toFixed(1)}%)。` : ''}
            ${worst ? `振幅較低產業為<strong>${worst.name}</strong>(${worst.avgAmp.toFixed(1)}%)。` : ''}
            產業選擇對CB績效有顯著影響，建議關注熱門產業的供給壓力。
        </div>
    </div>`;

    return html;
}

// v3.97-em: 切換產業明細顯示
function toggleIndustryDetail(industryName, idx) {
    const detailRow = document.getElementById(`industry-detail-${idx}`);
    const icon = document.getElementById(`industry-icon-${idx}`);
    
    if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        icon.style.transform = 'rotate(90deg)';
    } else {
        detailRow.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// v3.92 新增：券商分析渲染函數
function renderBrokerAnalysis() {
    const data = marketTrendData.broker;
    if (!data || data.length === 0) return '<div>暫無數據</div>';

    let html = `
    <div style="font-size:13px; font-weight:bold; color:#e65100; margin-bottom:10px;">🏦 承銷券商分布與績效分析</div>
    <div class="trend-table-wrapper">
    <table class="trend-year-table">
        <tr>
            <th class="sortable">券商</th>
            <th class="sortable">檔數</th>
            <th class="sortable">占比</th>
            <th class="sortable">掛牌均高</th>
            <th class="sortable">掛牌均低</th>
            <th class="sortable">平均振幅</th>
        </tr>`;

    // 只顯示前15個券商
    const topData = data.slice(0, 15);
    topData.forEach((d, idx) => {
        const ampClass = d.avgAmp >= 80 ? 'amp-high' : (d.avgAmp < 30 ? 'amp-low' : '');
        const rankIcon = idx < 3 ? ['🥇', '🥈', '🥉'][idx] : '';
        html += `
        <tr>
            <td style="text-align:left; font-weight:${idx < 3 ? 'bold' : 'normal'};">${rankIcon} ${d.name}</td>
            <td><b>${d.count}</b></td>
            <td>${d.ratio.toFixed(1)}%</td>
            <td style="color:#2e7d32;">${d.avgHigh > 0 ? d.avgHigh.toFixed(1) : '-'}</td>
            <td style="color:#c62828;">${d.avgLow > 0 ? d.avgLow.toFixed(1) : '-'}</td>
            <td class="${ampClass}">${d.avgAmp > 0 ? d.avgAmp.toFixed(1) + '%' : '-'}</td>
        </tr>`;
    });

    html += `</table></div>`;

    // 分析結論
    const best = data.filter(d => d.avgAmp > 0 && d.count >= 5).sort((a, b) => b.avgAmp - a.avgAmp)[0];
    const worst = data.filter(d => d.avgAmp > 0 && d.count >= 5).sort((a, b) => a.avgAmp - b.avgAmp)[0];

    html += `
    <div class="trend-insight-box">
        <div class="insight-title">📊 AI券商觀察</div>
        <div class="insight-content">
            ${data[0] ? `承銷量最大券商為<strong>${data[0].name}</strong>(${data[0].count}檔，市占${data[0].ratio.toFixed(1)}%)。` : ''}
            ${best ? `振幅表現最佳券商為<strong>${best.name}</strong>(${best.avgAmp.toFixed(1)}%)。` : ''}
            ${worst ? `振幅較低券商為<strong>${worst.name}</strong>(${worst.avgAmp.toFixed(1)}%)。` : ''}
            券商選擇對CB績效有一定影響，但個案差異仍大，需綜合評估。
        </div>
    </div>`;

    return html;
}


function bindInputEvents() {
    const show = (id, html) => {
        const el = document.getElementById(id);
        el.innerHTML = html||'';
        el.style.display = html?'block':'none';
    };

    // CB名稱搜尋
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim();

        // v3.97y: 用戶手動輸入時清除閃電帶入的全域變數
        window.currentCBCode = '';
        window.currentCBName = '';
        window.currentActualIssueSize = 0;

        const histDiv = document.getElementById('historyResults');

        if(val.length >= 2) {
            const auctionMatches = auctionRawData.filter(d => {
                const idMatch = d.id && d.id.startsWith(val);
                const stockIdMatch = d.stockId && String(d.stockId).startsWith(val);
                const nameMatch = d.name && d.name.includes(val);
                // v3.90 新增：支援用股票代號搜尋（CB代號通常是"股票代號+一/二/三"）
                const stockCodeMatch = d.id && d.id.substring(0, 4) === val;
                return idMatch || stockIdMatch || nameMatch || stockCodeMatch;
            }).slice(0, 10);

            const inquiryMatches = inquiryRawData.filter(d => {
                const idMatch = d.id && d.id.startsWith(val);
                const nameMatch = d.name && d.name.includes(val);
                // v3.90 新增：支援用股票代號搜尋（CB代號通常是"股票代號+一/二/三"）
                const stockCodeMatch = d.id && d.id.substring(0, 4) === val;
                return idMatch || nameMatch || stockCodeMatch;
            }).slice(0, 10);

            let html = '';

            if(inquiryMatches.length > 0) {
                html += `<div class="history-results-title">📋 詢圈案例 (${inquiryMatches.length}筆)</div>`;
                inquiryMatches.forEach(d => {
                    html += generateInquiryCard(d);
                });
            }

            if(auctionMatches.length > 0) {
                html += `<div class="history-results-title" style="margin-top:${inquiryMatches.length > 0 ? '12px' : '0'}">🎯 競拍案例 (${auctionMatches.length}筆)</div>`;
                html += auctionMatches.map(d => generateHistoryCard(d)).join('');
            }

            if(html) {
                histDiv.innerHTML = html;
                histDiv.style.display = 'block';
            } else {
                histDiv.style.display = 'none';
            }
        } else {
            histDiv.style.display = 'none';
        }

        if (!val) { show('cbNameInfo', null); return; }
        const found = cbNameMap[val] || Object.values(cbDatabase).find(d => d.name && d.name === val);
        if (found) {
            show('cbNameInfo', generateStandardCard({
                '平均最低得標價': found.minBidPrice,
                '平均最低溢價': found.lowPremium,
                '平均得標價': found.avgBidPrice,
                '平均溢價': found.avgPremium,
                '平均掛牌最高': found.marketHigh,
                '平均掛牌最低': found.marketLow,
                '樣本數': 1
            }, `${found.name} 歷史紀錄`));
        } else {
            show('cbNameInfo', null);
        }
    });

    // v3.52 修改：其他欄位綁定，傳入排除前三 + 擔保類型細分
    // v3.74 新增：傳入排名資訊
    const bind = (id, cat) => {
        const handler = function() {
            const rawVal = this.value;
            const val = parseFloat(rawVal) || rawVal;
            if (val) {
                let displayTitle = val;
                if(['股本','發行規模','轉換價'].includes(cat)) displayTitle = getRangeLabel(cat, val);

                const smartResult = getStatsSmart(cat, val);

                // v3.74 新增：取得排名資訊
                let rankingInfo = null;
                if (window.dimensionRankings && window.dimensionRankings[cat]) {
                    // 嘗試用原始值或顯示標題查找
                    rankingInfo = window.dimensionRankings[cat][rawVal] || window.dimensionRankings[cat][displayTitle] || window.dimensionRankings[cat][val];
                }

                // v3.52: 傳入排除前三 + 擔保類型細分數據 + v3.74排名
                show(id+'Info', generateStandardCard(
                    smartResult.rawData,
                    `區間統計: ${displayTitle}`,
                    smartResult.inquiryData,
                    smartResult.excludeTop3Data,
                    smartResult.excludeTop3InquiryData,
                    smartResult.guaranteedAuctionData,
                    smartResult.guaranteedInquiryData,
                    smartResult.unguaranteedAuctionData,
                    smartResult.unguaranteedInquiryData,
                    rankingInfo
                ));
                if(cat==='轉換價'||cat==='信評') updateSmartReminders();
            }
        };
        const el = document.getElementById(id);
        el.addEventListener('change', handler);
        if(el.tagName==='INPUT') el.addEventListener('input', handler);
    };

    bind('capital','股本');
    bind('issueSize','發行規模');
    bind('theoRange','理論價');  // v3.72 改為理論價區間
    bind('industry','產業');
    bind('broker','發行券商');
    bind('years','年期');
    bind('guarantee','擔保');
    bind('rating','信評');

    document.getElementById('guarantee').addEventListener('change', function() {
        updateMarketSentiment();
        if (typeof updateAtmospherePanel === 'function') {
            updateAtmospherePanel();
        }
    });

    // 產業、規模、信評變更時都觸發市場氛圍計算
    document.getElementById('industry').addEventListener('change', updateMarketSentiment);
    document.getElementById('issueSize').addEventListener('change', updateMarketSentiment);
    document.getElementById('rating').addEventListener('change', updateMarketSentiment);

    document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
    document.getElementById('actualConversionPrice').addEventListener('input', updateSmartReminders); // v3.69 新增
    document.getElementById('floorPrice').addEventListener('input', updateSmartReminders); // v3.69 新增：底標價格
    document.getElementById('theoRange').addEventListener('change', updateSmartReminders); // v3.72 改為理論價區間

    // v3.72 新增：競拍前評估觸發（基於事前可知條件）
    // v3.73 修改：增加years和floorPrice觸發
    const evalTriggers = ['stockPrice', 'actualConversionPrice', 'theoRange', 'guarantee', 'rating', 'issueSize', 'broker', 'industry', 'years', 'floorPrice'];
    evalTriggers.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', updateAuctionEvaluation);
            if (el.tagName === 'INPUT') el.addEventListener('input', debounce(updateAuctionEvaluation, 300));
        }
    });
}

// v3.72 新增：防抖函數
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// v3.69 更新：從區間字串提取中間值
function getConversionMidValue(rangeStr) {
    if (typeof rangeStr === 'number' && !isNaN(rangeStr)) return rangeStr;
    const str = String(rangeStr || '');
    if (str.includes('小於20')) return 15;
    if (str.includes('20~50')) return 35;
    if (str.includes('50~100')) return 75;
    if (str.includes('100~150')) return 125;
    if (str.includes('150~200')) return 175;
    if (str.includes('大於200')) return 250;
    const num = parseFloat(str);
    return isNaN(num) ? 0 : num;
}

// v3.72 新增：從理論價區間字串提取中間值
function getTheoRangeMidValue(rangeStr) {
    if (typeof rangeStr === 'number' && !isNaN(rangeStr)) return rangeStr;
    const str = String(rangeStr || '');
    if (str.includes('小於90')) return 85;
    if (str.includes('90~95')) return 92.5;
    if (str.includes('95~100')) return 97.5;
    if (str.includes('100~105')) return 102.5;
    if (str.includes('105~110')) return 107.5;
    if (str.includes('110~115')) return 112.5;
    if (str.includes('大於115')) return 120;
    const num = parseFloat(str);
    return isNaN(num) ? 0 : num;
}

// v3.69 修改：近期市場氛圍三維度加權計算
// v3.72 新增：區分有擔保/無擔保篩選
// v3.85 重大更新：五維度市場氛圍權重（根據2203檔CB實證數據）
// 權重配置：產業35%、券商25%、信評20%、規模10%、理論價10%
// 關鍵發現：(1) 產業影響最大 (2) 券商被嚴重低估 (3) 信評不是越低越好
function updateMarketSentiment() {
    const div = document.getElementById('marketSentiment');
    const industry = document.getElementById('industry').value;
    const issueSize = document.getElementById('issueSize').value;
    const rating = document.getElementById('rating').value;
    const guarantee = document.getElementById('guarantee').value;
    const broker = document.getElementById('broker').value;  // v3.84 新增
    const theoRange = document.getElementById('theoRange').value;  // v3.84 新增

    // v3.85 更新：五維度市場氛圍（產業35%、券商25%、信評20%、規模10%、理論價10%）
    const hasAnyDim = industry || issueSize || rating || broker || theoRange;

    // 至少需要一個維度
    if (!hasAnyDim) {
        div.innerHTML = `<div class="stat-row" style="color:#e65100;">⚠️ 請至少填寫一個維度（產業、券商、信評、規模、理論價）以計算市場氛圍</div>`;
        return;
    }

    // v3.72 修改：先按擔保類型篩選，再按截標日排序
    let filteredData = [...auctionRawData].filter(d => d.openDate);

    // 如果有選擔保類型，就篩選同類型
    if (guarantee) {
        filteredData = filteredData.filter(d => d.guarantee === guarantee);
    }

    const sortedData = filteredData.sort((a, b) => {
        const dateA = new Date(a.openDate);
        const dateB = new Date(b.openDate);
        return dateB - dateA;
    });

    // 加權計算函數：最近3檔權重5，4-6檔權重3，7-9檔權重2
    // v3.69 修正：同時計算溢價率和得標價格
    function calcWeightedData(cases) {
        if (cases.length === 0) return {
            lowPremium: null, avgPremium: null,
            lowBidPrice: null, avgBidPrice: null,
            count: 0, detail: []
        };

        let totalWeight = 0;
        let weightedLowPremium = 0, weightedAvgPremium = 0;
        let weightedLowBid = 0, weightedAvgBid = 0;
        const detail = [];

        cases.slice(0, 9).forEach((c, idx) => {
            let weight = 0;
            if (idx < 3) weight = 5;      // 最近3檔
            else if (idx < 6) weight = 3;  // 4-6檔
            else weight = 2;               // 7-9檔

            const lowP = c.lowPremium || 0;
            const avgP = c.avgPremium || 0;
            const lowB = c.minBidPrice || 0;
            const avgB = c.avgBidPrice || 0;

            weightedLowPremium += lowP * weight;
            weightedAvgPremium += avgP * weight;
            weightedLowBid += lowB * weight;
            weightedAvgBid += avgB * weight;
            totalWeight += weight;

            detail.push({
                name: c.name || c.id,
                lowPremium: lowP,
                avgPremium: avgP,
                lowBid: lowB,
                avgBid: avgB,
                weight: weight
            });
        });

        return {
            lowPremium: totalWeight > 0 ? (weightedLowPremium / totalWeight) : null,
            avgPremium: totalWeight > 0 ? (weightedAvgPremium / totalWeight) : null,
            lowBidPrice: totalWeight > 0 ? (weightedLowBid / totalWeight) : null,
            avgBidPrice: totalWeight > 0 ? (weightedAvgBid / totalWeight) : null,
            count: cases.length,
            detail: detail
        };
    }

    // v3.90 修正：三維度權重（產業35%、規模25%、信評40%）
    // 按用戶討論調整，移除券商和理論價維度
    const WEIGHTS = {
        industry: 0.35,
        size: 0.25,
        rating: 0.40
    };

    // 1. 產業維度 (35%)
    let industryResult = { lowPremium: null, avgPremium: null, lowBidPrice: null, avgBidPrice: null, count: 0 };
    if (industry) {
        const industryCases = sortedData.filter(d => industryMatches(d.industry, industry));
        industryResult = calcWeightedData(industryCases);
    }

    // 2. 規模維度 (25%)
    let sizeResult = { lowPremium: null, avgPremium: null, lowBidPrice: null, avgBidPrice: null, count: 0 };
    if (issueSize) {
        const sizeCases = sortedData.filter(d => {
            const size = d.issueSize || 0;
            if (issueSize === '小於2億') return size > 0 && size < 2;
            if (issueSize === '2~5億') return size >= 2 && size < 5;
            if (issueSize === '5~10億') return size >= 5 && size < 10;
            if (issueSize === '10~15億') return size >= 10 && size < 15;
            if (issueSize === '15~20億') return size >= 15 && size < 20;
            if (issueSize === '大於20億') return size >= 20;
            return false;
        });
        sizeResult = calcWeightedData(sizeCases);
    }

    // 3. 信評維度 (40%)
    let ratingResult = { lowPremium: null, avgPremium: null, lowBidPrice: null, avgBidPrice: null, count: 0 };
    if (rating) {
        const ratingCases = sortedData.filter(d => d.rating === rating);
        ratingResult = calcWeightedData(ratingCases);
    }

    // v3.90 計算總加權（三維度：產業35%、規模25%、信評40%）
    let totalLowP = 0, totalAvgP = 0;
    let totalLowB = 0, totalAvgB = 0;
    let totalWeight = 0;
    let activeDims = [];

    if (industryResult.lowPremium !== null) {
        totalLowP += industryResult.lowPremium * WEIGHTS.industry;
        totalAvgP += industryResult.avgPremium * WEIGHTS.industry;
        totalLowB += industryResult.lowBidPrice * WEIGHTS.industry;
        totalAvgB += industryResult.avgBidPrice * WEIGHTS.industry;
        totalWeight += WEIGHTS.industry;
        activeDims.push({ name: '產業', weight: WEIGHTS.industry });
    }
    if (sizeResult.lowPremium !== null) {
        totalLowP += sizeResult.lowPremium * WEIGHTS.size;
        totalAvgP += sizeResult.avgPremium * WEIGHTS.size;
        totalLowB += sizeResult.lowBidPrice * WEIGHTS.size;
        totalAvgB += sizeResult.avgBidPrice * WEIGHTS.size;
        totalWeight += WEIGHTS.size;
        activeDims.push({ name: '規模', weight: WEIGHTS.size });
    }
    if (ratingResult.lowPremium !== null) {
        totalLowP += ratingResult.lowPremium * WEIGHTS.rating;
        totalAvgP += ratingResult.avgPremium * WEIGHTS.rating;
        totalLowB += ratingResult.lowBidPrice * WEIGHTS.rating;
        totalAvgB += ratingResult.avgBidPrice * WEIGHTS.rating;
        totalWeight += WEIGHTS.rating;
        activeDims.push({ name: '信評', weight: WEIGHTS.rating });
    }

    // 重新正規化（如果只有部分維度有資料）
    const finalLowP = totalWeight > 0 ? (totalLowP / totalWeight) : 0;
    const finalAvgP = totalWeight > 0 ? (totalAvgP / totalWeight) : 0;
    const finalLowB = totalWeight > 0 ? (totalLowB / totalWeight) : 0;
    const finalAvgB = totalWeight > 0 ? (totalAvgB / totalWeight) : 0;

    // 顯示結果
    const guarLabel = guarantee ? `【${guarantee}】` : '';

    // v3.90 更新：動態生成維度說明（三維度）
    const dimensionDesc = activeDims.length > 0 ?
        activeDims.map(d => `${d.name}(${Math.round(d.weight/totalWeight*100)}%)`).join('+') :
        '無可用維度';

    let html = `<div class="stats-header">🌡️ v3.90 近期市場氛圍${guarLabel}（${dimensionDesc}）</div>`;

    // 總結 - 同時顯示溢價率和得標價格
    html += `<div style="background:#fff; padding:10px; border-radius:6px; margin-bottom:10px;">
        <div style="display:flex; gap:15px; flex-wrap:wrap;">
            <div style="flex:1; min-width:140px;">
                <div style="font-size:12px; color:#666;">加權溢價率</div>
                <div style="font-size:16px; font-weight:bold;">
                    <span style="color:#2e7d32;">${finalLowP.toFixed(2)}%</span> ~ <span style="color:#d32f2f;">${finalAvgP.toFixed(2)}%</span>
                </div>
            </div>
            <div style="flex:1; min-width:140px;">
                <div style="font-size:12px; color:#666;">加權得標價</div>
                <div style="font-size:16px; font-weight:bold;">
                    <span style="color:#2e7d32;">${finalLowB.toFixed(2)}</span> ~ <span style="color:#d32f2f;">${finalAvgB.toFixed(2)}</span> 元
                </div>
            </div>
        </div>
    </div>`;

    // v3.90 三維度明細（產業35%、規模25%、信評40%）
    html += `<div style="font-size:12px; line-height:1.8;">`;

    if (industry) {
        const normWeight = totalWeight > 0 ? Math.round(WEIGHTS.industry / totalWeight * 100) : 35;
        const status = industryResult.count > 0 ?
            `溢價 <span style="color:#2e7d32;">${industryResult.lowPremium?.toFixed(2) || '-'}%</span>~<span style="color:#d32f2f;">${industryResult.avgPremium?.toFixed(2) || '-'}%</span> (${Math.min(industryResult.count, 9)}筆)` :
            `<span style="color:#999;">無案例</span>`;
        html += `<div>📌 產業[${industry}] ${normWeight}%：${status}</div>`;
    }

    if (issueSize) {
        const normWeight = totalWeight > 0 ? Math.round(WEIGHTS.size / totalWeight * 100) : 25;
        const status = sizeResult.count > 0 ?
            `溢價 <span style="color:#2e7d32;">${sizeResult.lowPremium?.toFixed(2) || '-'}%</span>~<span style="color:#d32f2f;">${sizeResult.avgPremium?.toFixed(2) || '-'}%</span> (${Math.min(sizeResult.count, 9)}筆)` :
            `<span style="color:#999;">無案例</span>`;
        html += `<div>📌 規模[${issueSize}] ${normWeight}%：${status}</div>`;
    }

    if (rating) {
        const normWeight = totalWeight > 0 ? Math.round(WEIGHTS.rating / totalWeight * 100) : 40;
        const ratingName = rating === 'BBB' ? 'BBB' : `TCRI ${rating}`;
        const status = ratingResult.count > 0 ?
            `溢價 <span style="color:#2e7d32;">${ratingResult.lowPremium?.toFixed(2) || '-'}%</span>~<span style="color:#d32f2f;">${ratingResult.avgPremium?.toFixed(2) || '-'}%</span> (${Math.min(ratingResult.count, 9)}筆)` :
            `<span style="color:#999;">無案例</span>`;
        html += `<div>📌 信評[${ratingName}] ${normWeight}%：${status}</div>`;
    }

    html += `</div>`;

    // v3.90 更新說明（三維度）
    html += `<div style="font-size:11px; color:#666; margin-top:8px; border-top:1px solid #ddd; padding-top:6px;">
        💡 v3.90全自動智能：進入即顯示建議，選擇條件後自動更新<br>
        📊 三維度權重：產業35%+規模25%+信評40%
    </div>`;

    div.innerHTML = html;
    div.style.display = 'block';
}

function updateSmartReminders() {
    const s = parseFloat(document.getElementById('stockPrice').value);
    // v3.69 優先使用實際轉換價格
    const actualC = parseFloat(document.getElementById('actualConversionPrice').value);
    // v3.72 修改：如果沒有輸入股價和轉換價，則從理論價區間獲取中間值
    const theoRangeVal = document.getElementById('theoRange').value;
    const theoAutoCalcInfo = document.getElementById('theoAutoCalcInfo');

    let t = 0;  // 理論價
    let c = actualC;  // 轉換價
    let autoCalcRange = '';  // 自動計算的區間

    if(s > 0 && actualC > 0) {
        // 方式一：從股價和轉換價計算理論價
        t = (s/actualC)*100;

        // v3.72 新增：自動判斷理論價區間並更新下拉選單
        if (t < 90) autoCalcRange = '小於90元';
        else if (t < 95) autoCalcRange = '90~95元';
        else if (t < 100) autoCalcRange = '95~100元';
        else if (t < 105) autoCalcRange = '100~105元';
        else if (t < 110) autoCalcRange = '105~110元';
        else if (t < 115) autoCalcRange = '110~115元';
        else autoCalcRange = '大於115元';

        // 自動更新理論價區間選項
        document.getElementById('theoRange').value = autoCalcRange;

        // 顯示自動計算提示
        if (theoAutoCalcInfo) {
            document.getElementById('theoAutoValue').textContent = t.toFixed(2);
            document.getElementById('theoAutoRange').textContent = autoCalcRange;
            theoAutoCalcInfo.style.display = 'block';
        }

        // 更新標籤提示
        const modeSpan = document.getElementById('theoRangeMode');
        if (modeSpan) {
            modeSpan.innerHTML = '（<span style="color:#2e7d32;">✅ 已自動計算</span>）';
        }

    } else if(theoRangeVal && theoRangeVal !== '') {
        // 方式二：從理論價區間獲取中間值
        t = getTheoRangeMidValue(theoRangeVal);

        // 隱藏自動計算提示
        if (theoAutoCalcInfo) {
            theoAutoCalcInfo.style.display = 'none';
        }

        // 更新標籤提示
        const modeSpan = document.getElementById('theoRangeMode');
        if (modeSpan) {
            modeSpan.innerHTML = '（<span style="color:#ff9800;">📝 手動選擇</span>）';
        }
    } else {
        // 都沒輸入
        if (theoAutoCalcInfo) {
            theoAutoCalcInfo.style.display = 'none';
        }
        const modeSpan = document.getElementById('theoRangeMode');
        if (modeSpan) {
            modeSpan.innerHTML = '（輸入股價/轉換價後自動計算）';
        }
    }

    const r = document.getElementById('rating').value;
    const floorPrice = parseFloat(document.getElementById('floorPrice').value) || 100;

    // v3.72 修改：如果有理論價（無論是計算還是選擇的）
    if(t > 0) {
        // 建立條列式提醒
        let tips = [];

        // 1. 基本資訊
        let headerMsg;
        if(s > 0 && actualC > 0) {
            headerMsg = `<div style="margin-bottom:8px;">
                <div>目前理論價：<b style="color:#667eea; font-size:20px;">${t.toFixed(2)} 元</b></div>
                <div style="font-size:13px; color:#666;">轉換價 ${actualC} 元｜底標 ${floorPrice} 元</div>
                <div style="font-size:12px; color:#1976d2; margin-top:4px;">💡 理論價格會隨股價波動，建議以截標日13:30收盤價計算的理論價格為最終評估基礎</div>
            </div>`;
        } else {
            headerMsg = `<div style="margin-bottom:8px;">
                <div>理論價區間中值：<b style="color:#667eea; font-size:20px;">${t.toFixed(2)} 元</b></div>
                <div style="font-size:13px; color:#666;">底標 ${floorPrice} 元</div>
                <div style="font-size:12px; color:#9c27b0; margin-top:4px;">💡 您選擇了理論價區間，系統以區間中值進行估算。建議輸入實際股價和轉換價以獲得精確計算。</div>
            </div>`;
        }

        // 2. 分析法適用性判斷（以95元為分界）
        if (t < 95) {
            const deviation = 95 - t;
            if (deviation > 15) {
                tips.push(`<b>理論價 ${t.toFixed(2)} 元，偏離95元分界點達 ${deviation.toFixed(1)} 元</b>`);
                tips.push(`溢價率分析法在低理論價時誤差較大，預估價格可能失準`);
                tips.push(`<b style="color:#d32f2f;">強烈建議以「得標價格分析法」為主要參考依據</b>`);
            } else if (deviation > 5) {
                tips.push(`理論價 ${t.toFixed(2)} 元，低於95元分界點`);
                tips.push(`得標價格分析法在此區間較能反映市場實際行情`);
                tips.push(`建議重點參考「得標價格分析法」，溢價率法可作輔助`);
            } else {
                tips.push(`理論價 ${t.toFixed(2)} 元，接近95元分界點`);
                tips.push(`兩種分析法皆有參考價值，可交叉比對`);
                tips.push(`若兩者差異大，建議偏向得標價格分析法`);
            }
        } else {
            // 95以上
            if (t > 120) {
                tips.push(`理論價 ${t.toFixed(2)} 元，處於較高水位`);
                tips.push(`高理論價標的溢價空間有限，競拍熱度可能較低`);
                tips.push(`建議採保守策略，注意溢價風險`);
            } else if (t < 105) {
                tips.push(`理論價 ${t.toFixed(2)} 元，處於具吸引力區間`);
                tips.push(`兩種分析法皆適用，可交叉參考`);
                tips.push(`此區間通常競拍熱度較高，可適度積極`);
            } else {
                tips.push(`理論價 ${t.toFixed(2)} 元，處於合理區間`);
                tips.push(`溢價率分析法較為適用`);
                tips.push(`可參考歷史同類型標的溢價率作為投標依據`);
            }
        }

        // 3. 底標相關提醒
        if (t * 1.10 < floorPrice) {
            tips.push(`<span style="color:#e65100;">⚠️ 理論價加10%仍低於底標，溢價率法將自動調整為底標基準模式</span>`);
        }

        // 4. 信評提醒
        if (r && ['7','8','9'].includes(r)) {
            tips.push(`<span style="color:#d32f2f;">⚠️ 信評 TCRI ${r} 較低，市場接受度可能受限，建議採保守策略</span>`);
        }

        // 組合輸出
        let msg = headerMsg;
        msg += `<div style="border-top:1px solid #e0e0e0; padding-top:8px; margin-top:4px;">`;
        tips.forEach((tip, idx) => {
            msg += `<div style="margin-bottom:4px;">${idx + 1}. ${tip}</div>`;
        });
        msg += `</div>`;

        document.getElementById('reminderContent').innerHTML = msg;
        // v3.97g 移除：輸入區不再顯示Rex大叔提醒，已移至結果區步驟報告
        // document.getElementById('smartReminders').style.display='block';
    }
}

function generateRexCommentary(r) {
    // v3.69 修改：優化AI分析內容，增加轉換價值說明與分析法建議
    const theo = parseFloat(r.theoreticalPrice);
    const floor = parseFloat(r.floorPrice);
    const premiumConservative = parseFloat(r.premiumBidPrices.conservative);
    const premiumBalanced = parseFloat(r.premiumBidPrices.balanced);
    const priceConservative = parseFloat(r.priceBidPrices.conservative);
    const priceBalanced = parseFloat(r.priceBidPrices.balanced);
    const belowFloor = r.premiumBelowFloor;
    const totalLowP = parseFloat(r.totalLowPremium);
    const totalAvgP = parseFloat(r.totalAvgPremium);
    const impliedLowP = parseFloat(r.impliedLowPremium);
    const impliedAvgP = parseFloat(r.impliedAvgPremium);
    const weightedLowBid = parseFloat(r.weightedLowBidPrice);
    const weightedAvgBid = parseFloat(r.weightedAvgBidPrice);

    // 計算風險相關數據
    const maxLossPercent = ((premiumConservative - 100) / premiumConservative * 100).toFixed(2);
    const premiumVsPrice = (premiumBalanced - priceBalanced).toFixed(2);

    // v3.69 新增：計算轉換價值相關數據
    const conversionValuePercent = (theo - 100).toFixed(2); // 相對於100元的差距
    const aboveOrBelow = theo >= 100 ? '高於' : '低於';
    const conversionNote = theo >= 100
        ? `目前市價高於轉換價格 ${conversionValuePercent}%，可轉債將跟著股價連動漲跌`
        : `目前市價低於轉換價格 ${Math.abs(conversionValuePercent)}%，可轉債價格較不受股價影響，主要由純債價值支撐`;

    // v3.69 新增：溢價率換算價格、得標價換算溢價率
    const premiumPriceLow = (theo * (1 + totalLowP/100)).toFixed(2);
    const premiumPriceAvg = (theo * (1 + totalAvgP/100)).toFixed(2);
    const pricePremiumLow = theo > 0 ? ((weightedLowBid/theo - 1) * 100).toFixed(2) : '0.00';
    const pricePremiumAvg = theo > 0 ? ((weightedAvgBid/theo - 1) * 100).toFixed(2) : '0.00';

    // v3.69 新增：分析法建議
    let methodRecommendation = '';
    if (theo >= 95) {
        methodRecommendation = '以目前理論價狀況，選擇<b style="color:#1976d2;">溢價率分析法</b>較具參考價值';
    } else if (theo >= 85) {
        methodRecommendation = '理論價接近分界點，建議<b style="color:#e65100;">兩種分析法交叉比對</b>參考';
    } else {
        methodRecommendation = '以目前理論價狀況，選擇<b style="color:#e65100;">得標價格分析法</b>較具參考價值';
    }

    let title = "";
    let situation = "";
    let strategy = "";
    let risk = "";
    let reminder = "";

    // v3.69 新增：市場氛圍與歷史組合條件區間說明
    const marketAtmosphere = `<div style="background:#e8f5e9; padding:10px 12px; border-radius:6px; margin:10px 0; font-size:13px;">
        <div style="margin-bottom:8px;"><b style="color:#2e7d32;">📊 近期市場氛圍（溢價率分析法）</b></div>
        <div>加權溢價率區間：<b>${totalLowP}% ~ ${totalAvgP}%</b></div>
        <div style="color:#666;">→ 換算投標價區間：<b style="color:#1976d2;">${premiumPriceLow} ~ ${premiumPriceAvg} 元</b></div>
    </div>
    <div style="background:#fff3e0; padding:10px 12px; border-radius:6px; margin:10px 0; font-size:13px;">
        <div style="margin-bottom:8px;"><b style="color:#e65100;">📈 歷史組合條件（得標價格分析法）</b></div>
        <div>加權得標價區間：<b>${weightedLowBid} ~ ${weightedAvgBid} 元</b></div>
        <div style="color:#666;">→ 換算溢價率區間：<b style="color:#e65100;">${pricePremiumLow}% ~ ${pricePremiumAvg}%</b></div>
    </div>`;

    if (belowFloor) {
        // 情境一：溢價率法低於底標
        title = "⚠️ 特殊情境：溢價率計算低於底標";
        situation = `本檔理論價 ${r.theoreticalPrice} 元，${conversionNote}。歷史溢價率計算出的投標價低於底標 ${r.floorPrice} 元，系統已自動切換為「底標基準模式」。`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>策略建議：</b></div>
            <div>1. 保守策略：以底標 ${r.floorPrice} 元投標（相當於溢價率 ${r.floorBasedPremium}%）</div>
            <div>2. 平衡策略：底標加3%約 ${r.premiumBidPrices.balanced} 元</div>
            <div>3. 同時參考得標價格分析法的加權平均 ${priceBalanced} 元作為另一參考點</div>`;
        risk = `<b>風險評估：</b>以底標投標，最大損失為手續費約0.5%，風險極低。但需注意此類標的可能競爭激烈，得標機率需評估。`;
        reminder = "競拍的核心是控制成本，在這種情境下，用底標投標是最保守的選擇，讓自己立於不敗之地。";

    } else if (theo < 85) {
        // 情境二：理論價很低（<85元）
        title = "📊 低理論價情境分析";
        situation = `理論價 ${r.theoreticalPrice} 元明顯偏低，${conversionNote}。<br><br>${methodRecommendation}，溢價率分析法的參考價值有限。`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>策略建議：</b></div>
            <div>1. <b>強烈建議以「得標價格分析法」為主</b></div>
            <div>2. 保守價參考：${priceConservative} 元（加權最低得標價）</div>
            <div>3. 平衡價參考：${priceBalanced} 元（加權平均得標價）</div>
            <div>4. 溢價率法僅供輔助參考，不建議作為主要依據</div>`;
        risk = `<b>風險評估：</b>低理論價標的通常代表股價相對轉換價偏低，需特別關注公司基本面與未來股價走勢。以 ${priceConservative} 元投標，最大損失約 ${((priceConservative-100)/priceConservative*100).toFixed(1)}%。`;
        reminder = "記住，競拍最大的好處就是你可以控制投入成本，在低理論價情境更要謹慎評估是否參與。";

    } else if (theo < 95) {
        // 情境三：理論價偏低（85-95元）
        title = "💡 理論價接近分界點情境";
        situation = `理論價 ${r.theoreticalPrice} 元略低於95元分界點，${conversionNote}。<br><br>${methodRecommendation}。`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>策略建議：</b></div>
            <div>1. 主要參考「得標價格分析法」：${priceConservative} ~ ${priceBalanced} 元</div>
            <div>2. 輔助參考「溢價率分析法」：${premiumConservative} ~ ${premiumBalanced} 元</div>
            <div>3. 兩者差異 ${Math.abs(premiumVsPrice)} 元，建議取較保守的價格</div>`;
        risk = `<b>風險評估：</b>以保守價 ${Math.min(premiumConservative, priceConservative).toFixed(2)} 元投標，最大損失控制在 ${maxLossPercent}% 左右，屬於可接受範圍。`;
        reminder = "在分界點附近，交叉比對兩種分析法能讓你的判斷更客觀，不要只看單一數據。";

    } else if (theo >= 95 && theo <= 105) {
        // 情境四：理論價適中（95-105元）
        title = "✨ 理想投標區間情境";
        situation = `理論價 ${r.theoreticalPrice} 元處於95-105元的理想區間，${conversionNote}。<br><br>${methodRecommendation}，歷史資料參考價值高。`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>策略建議：</b></div>
            <div>1. 保守策略：${premiumConservative} 元（溢價率 ${totalLowP}%）</div>
            <div>2. 平衡策略：${premiumBalanced} 元（溢價率 ${totalAvgP}%）</div>
            <div>3. 此區間通常競拍熱度較高，想得標可考慮平衡或積極策略</div>`;
        risk = `<b>風險評估：</b>以 ${premiumConservative} 元投標，三年最大損失約 ${maxLossPercent}%（約 ${(premiumConservative-100).toFixed(1)} 元/張）。這個風險是你進場前就能確定的，這就是競拍控制風險的精髓。`;
        reminder = "這種理論價的標的是練習競拍的好機會，風險可控且有獲利空間，值得認真評估參與。";

    } else if (theo > 105 && theo <= 115) {
        // 情境五：理論價偏高（105-115元）
        title = "🔥 較高理論價情境";
        situation = `理論價 ${r.theoreticalPrice} 元偏高，${conversionNote}，已具備轉換價值。<br><br>${methodRecommendation}。`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>策略建議：</b></div>
            <div>1. 建議採「保守」策略：${premiumConservative} 元</div>
            <div>2. 高理論價標的不宜追高，嚴控投標成本</div>
            <div>3. 如果保守價仍覺得太高，可以考慮降低投標張數或放棄</div>`;
        risk = `<b>風險評估：</b>高理論價不代表沒風險，股價回檔時可轉債價格也會下跌。以 ${premiumConservative} 元投標，最大損失 ${maxLossPercent}%。`;
        reminder = "不要因為標的熱門就衝動追高，記住我們參與競拍的核心目的是控制成本，不是搶籌碼。";

    } else {
        // 情境六：理論價很高（>115元）
        title = "⚡ 高理論價警示";
        situation = `理論價 ${r.theoreticalPrice} 元已經相當高，${conversionNote}，已具備明顯轉換價值。<br><br>${methodRecommendation}，但市場競爭可能較激烈。`;
        strategy = `${marketAtmosphere}
            <div style="margin-top:12px;"><b>策略建議：</b></div>
            <div>1. 嚴格採用「保守」策略：${premiumConservative} 元</div>
            <div>2. 認真評估是否值得參與，高價得標的風險不低</div>
            <div>3. 如執意參與，建議降低投標張數，控制整體曝險</div>`;
        risk = `<b>風險評估：</b>高理論價標的在股價回檔時損失可能較大。建議將此類標的的投標資金控制在總投資部位的較小比例。`;
        reminder = "有時候最好的投資決策是「不參與」。不是每一檔都要拍，選擇適合自己風險承受度的標的更重要。";
    }

    // 組合輸出
    return `<div class="rex-analysis">
        <div class="rex-title">🧢 Rex大叔提醒</div>
        <div class="rex-content">
            <div style="font-size:15px; font-weight:bold; color:#1565c0; margin-bottom:10px;">${title}</div>
            <div style="margin-bottom:12px;">${situation}</div>
            <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:12px;">${strategy}</div>
            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:12px;">${risk}</div>
            <div style="border-left:4px solid #667eea; padding-left:12px; font-style:italic; color:#555;">💬 ${reminder}</div>
        </div>
    </div>`;
}

function calculateEvaluation(d) {
    // v3.69 修改：同時計算兩種分析法，都呈現給用戶參考
    // 從區間字串提取中間值用於計算
    function getRangeMidValue(rangeStr, type) {
        if (typeof rangeStr === 'number' && !isNaN(rangeStr)) return rangeStr;
        const str = String(rangeStr || '');
        // 轉換價區間
        if (type === 'conversion') {
            if (str.includes('小於20')) return 15;
            if (str.includes('20~50')) return 35;
            if (str.includes('50~100')) return 75;
            if (str.includes('100~150')) return 125;
            if (str.includes('150~200')) return 175;
            if (str.includes('大於200')) return 250;
        }
        // 股本區間
        if (type === 'capital') {
            if (str.includes('小於3')) return 2;
            if (str.includes('3~6')) return 4.5;
            if (str.includes('6~10')) return 8;
            if (str.includes('10~15')) return 12.5;
            if (str.includes('15~20')) return 17.5;
            if (str.includes('大於20')) return 30;
        }
        // 發行規模區間
        if (type === 'size') {
            if (str.includes('小於2')) return 1.5;
            if (str.includes('2~5')) return 3.5;
            if (str.includes('5~10')) return 7.5;
            if (str.includes('10~15')) return 12.5;
            if (str.includes('15~20')) return 17.5;
            if (str.includes('大於20')) return 30;
        }
        // 嘗試解析為數字
        const num = parseFloat(str);
        return isNaN(num) ? 0 : num;
    }

    // v3.72 修改：理論價計算支援兩種方式
    // 方式一：從股價和轉換價計算（優先）
    // 方式二：從理論價區間獲取中間值（備用）
    const actualConvPrice = d.actualConversionPrice || 0;
    let theo = 0;

    if (d.stockPrice > 0 && actualConvPrice > 0) {
        // 方式一：精確計算
        theo = (d.stockPrice / actualConvPrice) * 100;
    } else if (d.theoRange) {
        // 方式二：從區間取中間值
        theo = getRangeMidValue(d.theoRange, 'theoRange');
    }

    const floorPrice = d.floorPrice || 100; // 底標價格，預設100元
    const brokerName = d.broker || "";

    // v3.72 修改：根據75檔CB分析結論，重新優化維度權重
    // 按顯著性排序：理論價(30%)>承銷商(18%)>規模(12%)>產業(12%)>年期(8%)>股本(5%)>信評(3%)
    // 擔保作為調整因素（不進維度表）
    // v3.90 修正：按建議權重配置調整
    // 產業30%、信評22%、理論價15%、券商13%、規模10%、股本5%、年期5%
    const allDims = [
        {k:'industry',c:'產業',baseW:0.30,v:d.industry},            // ★★★★★ 產業30% 實證影響最大
        {k:'rating',c:'信評',baseW:0.22,v:d.rating},                // ★★★★☆ 信評22% 原本嚴重低估
        {k:'theoRange',c:'理論價',baseW:0.15,v:d.theoRange},        // ★★★☆☆ 理論價15% 原本過高
        {k:'broker',c:'發行券商',baseW:0.13,v:brokerName},          // ★★★☆☆ 券商13% 降低過度擬合
        {k:'size',c:'發行規模',baseW:0.10,v:d.issueSize},           // ★★☆☆☆ 規模10% 中等影響
        {k:'capital',c:'股本',baseW:0.05,v:d.capital},              // ★☆☆☆☆ 股本5% 影響較小
        {k:'years',c:'年期',baseW:0.05,v:d.years}                   // ★☆☆☆☆ 年期5% 影響最小
    ];

    // 篩選有填寫的維度
    const filledDims = allDims.filter(x => x.v && x.v !== '');

    // 計算有填寫維度的總權重
    const totalBaseWeight = filledDims.reduce((sum, x) => sum + x.baseW, 0);

    // 動態調整權重（按比例分配到100%）
    const dims = filledDims.map(x => ({
        ...x,
        w: totalBaseWeight > 0 ? x.baseW / totalBaseWeight : 0
    }));

    // === 計算各維度數據（兩種方法都要）===
    let wL=0, wA=0, resDims={};
    let wLowBid=0, wAvgBid=0; // 得標價格分析法用

    dims.forEach(x=>{
        const s = getStatsSmart(x.c, x.v), coef = getWeightCoefficient(x.k, x.v);

        // 溢價率數據
        resDims[x.k] = {
            ...s,
            coefficient: coef,
            weight: x.w,
            range: x.v,
            weightedLow: s.low*x.w*coef,
            weightedAvg: s.avg*x.w*coef
        };

        // 得標價格數據（從rawData取得）
        const lowBidPrice = s.rawData && s.rawData['平均最低得標價'] ? s.rawData['平均最低得標價'] : 0;
        const avgBidPrice = s.rawData && s.rawData['平均得標價'] ? s.rawData['平均得標價'] : 0;
        resDims[x.k].lowBidPrice = lowBidPrice;
        resDims[x.k].avgBidPrice = avgBidPrice;
        resDims[x.k].weightedLowBid = lowBidPrice * x.w * coef;
        resDims[x.k].weightedAvgBid = avgBidPrice * x.w * coef;

        if (s.rawData && s.rawData['區間名稱']) resDims[x.k].displayRange = s.rawData['區間名稱'];
        else resDims[x.k].displayRange = x.v;

        wL += resDims[x.k].weightedLow;
        wA += resDims[x.k].weightedAvg;
        wLowBid += resDims[x.k].weightedLowBid;
        wAvgBid += resDims[x.k].weightedAvgBid;
    });

    const subR = (d.subjectiveWeight||0)/100, objR = 1-subR;
    let tL = (wL*objR)+((d.subjectiveLowPremium||0)*subR);
    let tA = (wA*objR)+((d.subjectiveAvgPremium||0)*subR);

    // v3.72 新增：擔保調整因素（不作為維度，而是最終調整）
    const guaranteeAdj = (d.guarantee === '有擔保') ? 1.0 : 0;
    tL += guaranteeAdj;
    tA += guaranteeAdj;

    const gap = tA-tL;

    // === 溢價率分析法計算 ===
    const rawPremiumP1 = theo*(1+tL/100);  // 原始計算值
    const rawPremiumP2 = theo*(1+tA/100);
    const rawPremiumP3 = theo*(1+(tA+gap)/100);
    const rawPremiumP4 = theo*(1+(tA+gap*2)/100);
    const premiumBelowFloor = rawPremiumP1 < floorPrice;

    // v3.69 修改：當低於底標時，以底標為基準計算
    let premiumP1, premiumP2, premiumP3, premiumP4;
    let floorBasedPremium = 0;  // 以底標投標的溢價率

    if (premiumBelowFloor) {
        // 保守=底標，平衡=底標+3%，積極=底標+5%，極致=底標+7%
        premiumP1 = floorPrice;
        premiumP2 = floorPrice * 1.03;
        premiumP3 = floorPrice * 1.05;
        premiumP4 = floorPrice * 1.07;
        // 計算以底標投標的隱含溢價率
        floorBasedPremium = theo > 0 ? ((floorPrice/theo) - 1) * 100 : 0;
    } else {
        premiumP1 = rawPremiumP1;
        premiumP2 = rawPremiumP2;
        premiumP3 = rawPremiumP3;
        premiumP4 = rawPremiumP4;
    }

    // === 得標價格分析法計算 ===
    // v3.97-as-cs: 加入歷史落差調整係數
    // 根據理論價區間決定調整係數（基於歷史數據分析：平均得標價往往低於實際成交價）
    let priceMethodAdjustment = 0;
    let adjustmentReason = '';
    
    if (theo < 90) {
        // 極低理論價：歷史落差較大，調整 +5%
        priceMethodAdjustment = 0.05;
        adjustmentReason = '極低理論價區間，歷史落差較大';
    } else if (theo < 95) {
        // 低理論價：調整 +3%
        priceMethodAdjustment = 0.03;
        adjustmentReason = '低理論價區間';
    } else if (theo < 97.5) {
        // 邊界理論價：調整 +2%
        priceMethodAdjustment = 0.02;
        adjustmentReason = '邊界理論價區間';
    }
    // 理論價 >= 97.5 時使用溢價率法，不需要調整
    
    // 原始加權得標價
    const rawWeightedLowBidPrice = wLowBid > 0 ? wLowBid : floorPrice;
    const rawWeightedAvgBidPrice = wAvgBid > 0 ? wAvgBid : floorPrice + 2;
    
    // 加入調整係數後的得標價
    const weightedLowBidPrice = rawWeightedLowBidPrice * (1 + priceMethodAdjustment);
    const weightedAvgBidPrice = rawWeightedAvgBidPrice * (1 + priceMethodAdjustment);
    const bidGap = weightedAvgBidPrice - weightedLowBidPrice;

    // 確保不低於底標價格
    const priceP1 = Math.max(weightedLowBidPrice, floorPrice);
    const priceP2 = Math.max(weightedAvgBidPrice, floorPrice);
    const priceP3 = Math.max(weightedAvgBidPrice + bidGap, floorPrice);
    const priceP4 = Math.max(weightedAvgBidPrice + bidGap * 2, floorPrice);

    // 反推溢價率（相對於理論價）
    const impliedLowPremium = theo > 0 ? ((priceP1/theo) - 1) * 100 : 0;
    const impliedAvgPremium = theo > 0 ? ((priceP2/theo) - 1) * 100 : 0;

    // === v3.70 新增：熱度分析（回測功能）===
    const atmosphere = calcMarketAtmosphere(5);
    const atmosphereIndex = atmosphere ? atmosphere.atmosphereIndex : 50;
    const sizeMid = getRangeMidValue(d.issueSize, 'size');

    const heatResult = calcHeatIndex({
        issueSize: sizeMid,
        theoreticalPrice: theo,
        industry: d.industry,
        years: d.years || 3,
        atmosphereIndex: atmosphereIndex,
        rating: d.rating || '5',           // v3.82 新增
        broker: d.broker || '',            // v3.82 新增
        stockCap: getRangeMidValue(d.capital, 'capital') || 10  // v3.82 新增
    });

    // v3.82 同類案件統計（用於統計顯示，保持向後兼容）
    const similarCasesStats = findSimilarCasesForStats({
        theoreticalPrice: theo,
        issueSize: sizeMid,
        industry: d.industry
    });

    // === v3.72 新增：主力模擬出價預測 ===
    const estBidMultiple = d.estBidMultiple || (heatResult ? heatResult.expectedMultiple : 2.5);
    const guaranteeType = d.guarantee || '';
    const yearsNum = parseInt(d.years) || 3;
    const industryName = d.industry || '';

    const majorPlayerResult = predictMajorPlayerBid(
        theo,
        estBidMultiple,
        sizeMid,
        brokerName,
        guaranteeType,
        yearsNum,
        industryName  // v3.73 新增：傳入產業參數
    );

    return {
        cbName: d.cbName,
        theoreticalPrice: safeFixed(theo),
        floorPrice: floorPrice,
        dimensions: resDims,
        filledDimCount: dims.length,  // v3.69 新增：已填寫維度數量
        totalDimCount: allDims.length,  // v3.69 新增：總維度數量

        // === 溢價率分析法結果 ===
        totalLowPremium: safeFixed(tL),
        totalAvgPremium: safeFixed(tA),
        premiumBidPrices: {
            conservative: safeFixed(premiumP1),
            balanced: safeFixed(premiumP2),
            aggressive: safeFixed(premiumP3),
            ultimate: safeFixed(premiumP4)
        },
        premiumBelowFloor: premiumBelowFloor,
        floorBasedPremium: safeFixed(floorBasedPremium),  // v3.69 以底標投標的隱含溢價率
        guaranteeAdj: guaranteeAdj,  // v3.72 新增：擔保調整值

        // === 得標價格分析法結果 ===
        weightedLowBidPrice: safeFixed(weightedLowBidPrice),
        weightedAvgBidPrice: safeFixed(weightedAvgBidPrice),
        rawWeightedLowBidPrice: safeFixed(rawWeightedLowBidPrice),  // v3.97-as-cs: 未調整的原始值
        rawWeightedAvgBidPrice: safeFixed(rawWeightedAvgBidPrice),  // v3.97-as-cs: 未調整的原始值
        priceMethodAdjustment: priceMethodAdjustment,  // v3.97-as-cs: 調整係數
        priceMethodAdjustmentPct: (priceMethodAdjustment * 100).toFixed(0),  // v3.97-as-cs: 調整百分比
        adjustmentReason: adjustmentReason,  // v3.97-as-cs: 調整原因
        impliedLowPremium: safeFixed(impliedLowPremium),
        impliedAvgPremium: safeFixed(impliedAvgPremium),
        priceBidPrices: {
            conservative: safeFixed(priceP1),
            balanced: safeFixed(priceP2),
            aggressive: safeFixed(priceP3),
            ultimate: safeFixed(priceP4)
        },

        inputData: d,
        weightedSubjectiveLow: safeFixed(((d.subjectiveLowPremium||0)*subR)),
        weightedSubjectiveAvg: safeFixed(((d.subjectiveAvgPremium||0)*subR)),

        // === v3.70 新增：熱度分析結果 ===
        heatAnalysis: heatResult,
        similarCases: similarCasesStats,  // v3.82 保持向後兼容，使用統計版本
        marketAtmosphere: atmosphere,

        // === v3.72 新增：主力模擬出價結果 ===
        majorPlayerResult: majorPlayerResult,
        estBidMultiple: estBidMultiple,

        // === v3.97o 新增：整體歷史無加權數據（用於Step 1對比） ===
        overallLowPremium: window.OVERALL_STATS?.avgLowPremium || 6.5,
        overallAvgPremium: window.OVERALL_STATS?.avgAvgPremium || 8.0,
        overallLowBidPrice: window.OVERALL_STATS?.avgMinBid || 106.5,
        overallAvgBidPrice: window.OVERALL_STATS?.avgAvgBid || 108.0
    };
}

function displayResult(r) {
    document.getElementById('welcomeMsg').style.display = 'none';

    // v3.97j 顯示步驟式報告
    document.getElementById('stepReport').style.display = 'block';

    // 滾動到結果區頂部
    setTimeout(() => {
        const stepReport = document.getElementById('stepReport');
        if (stepReport) {
            stepReport.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 100);

    // Step 0: Rex大叔提醒 - v3.98a修正：加入安全檢查
    const reminderContent = document.getElementById('reminderContent');
    const step0ReminderEl = document.getElementById('step0Reminder');
    if (step0ReminderEl) {
        if (reminderContent && reminderContent.innerHTML.trim()) {
            step0ReminderEl.innerHTML = reminderContent.innerHTML;
        } else {
            step0ReminderEl.innerHTML = `
                <div>• 競拍投標價格應以<b>截標日13:30收盤價</b>計算的理論價為基準</div>
                <div>• 溢價率會隨市場氛圍變動，熱門標的溢價較高</div>
                <div>• 建議價格僅供參考，請根據自身風險承受度調整</div>
            `;
        }
    }

    // ========== Step 1: 基礎數據分析 ==========
    const stockPrice = r.inputData.stockPrice || 0;
    const convPrice = r.inputData.actualConversionPrice || 0;
    const theoPrice = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;
    const usePremiumMethod = theoPrice >= 97.5;

    // 填充理論價與方法
    document.getElementById('step1TheoPrice').textContent = theoPrice > 0 ? theoPrice.toFixed(2) + '元' : '--';
    const methodName = usePremiumMethod ? '溢價率分析法' : '得標均價分析法';
    document.getElementById('step1MethodName').textContent = methodName;
    document.getElementById('step1MethodLabel').textContent = methodName;

    // 從 r 中取得數據
    const avgPremium = parseFloat(r.totalAvgPremium) || 0;  // 加權平均溢價率
    const lowPremium = parseFloat(r.totalLowPremium) || 0;  // 加權最低溢價率
    const weightedLowBid = parseFloat(r.weightedLowBidPrice) || 0;  // 加權最低得標價
    const weightedAvgBid = parseFloat(r.weightedAvgBidPrice) || 0;  // 加權平均得標價

    // 無加權數據（整體歷史平均）
    const noWeightAvgPremium = parseFloat(r.overallAvgPremium) || avgPremium;
    const noWeightLowPremium = parseFloat(r.overallLowPremium) || lowPremium;
    const noWeightAvgBid = parseFloat(r.overallAvgBidPrice) || weightedAvgBid;
    const noWeightLowBid = parseFloat(r.overallLowBidPrice) || weightedLowBid;

    // v3.97-as-cp: 填充 4 個面板數據
    // 1. 溢價率法 - 無加權
    const premNoWeightLow = theoPrice * (1 + noWeightLowPremium / 100);
    const premNoWeightHigh = theoPrice * (1 + noWeightAvgPremium / 100);
    document.getElementById('step1PremNoWeightRate').textContent = 
        `${noWeightLowPremium.toFixed(2)}% ~ ${noWeightAvgPremium.toFixed(2)}%`;
    document.getElementById('step1PremNoWeightRange').textContent = 
        (premNoWeightLow > 0) ? `${premNoWeightLow.toFixed(2)}~${premNoWeightHigh.toFixed(2)}元` : '--';

    // 2. 溢價率法 - 有加權
    const premWeightLow = theoPrice * (1 + lowPremium / 100);
    const premWeightHigh = theoPrice * (1 + avgPremium / 100);
    document.getElementById('step1PremWeightRate').textContent = 
        `${lowPremium.toFixed(2)}% ~ ${avgPremium.toFixed(2)}%`;
    document.getElementById('step1PremWeightRange').textContent = 
        (premWeightLow > 0) ? `${premWeightLow.toFixed(2)}~${premWeightHigh.toFixed(2)}元` : '--';

    // 3. 得標均價法 - 無加權
    const priceNoWeightLow = noWeightLowBid > 0 ? noWeightLowBid : premNoWeightLow;
    const priceNoWeightHigh = noWeightAvgBid > 0 ? noWeightAvgBid : premNoWeightHigh;
    document.getElementById('step1PriceNoWeightRate').textContent = 
        noWeightLowBid > 0 ? `${noWeightLowBid.toFixed(2)} ~ ${noWeightAvgBid.toFixed(2)}元` : '--';
    document.getElementById('step1PriceNoWeightRange').textContent = 
        (priceNoWeightLow > 0) ? `${priceNoWeightLow.toFixed(2)}~${priceNoWeightHigh.toFixed(2)}元` : '--';

    // 4. 得標均價法 - 有加權
    const priceWeightLow = weightedLowBid > 0 ? weightedLowBid : premWeightLow;
    const priceWeightHigh = weightedAvgBid > 0 ? weightedAvgBid : premWeightHigh;
    document.getElementById('step1PriceWeightRate').textContent = 
        weightedLowBid > 0 ? `${weightedLowBid.toFixed(2)} ~ ${weightedAvgBid.toFixed(2)}元` : '--';
    document.getElementById('step1PriceWeightRange').textContent = 
        (priceWeightLow > 0) ? `${priceWeightLow.toFixed(2)}~${priceWeightHigh.toFixed(2)}元` : '--';

    // v3.97-as-cs: 顯示調整係數資訊
    const adjPct = r.priceMethodAdjustmentPct || '0';
    const adjReason = r.adjustmentReason || '';
    const adjNote = document.getElementById('step1PriceAdjustmentNote');
    const adjBadgeNo = document.getElementById('step1PriceNoWeightAdj');
    const adjBadgeW = document.getElementById('step1PriceWeightAdj');
    
    if (parseFloat(adjPct) > 0) {
        const adjText = `+${adjPct}%`;
        if (adjBadgeNo) adjBadgeNo.textContent = adjText;
        if (adjBadgeW) adjBadgeW.textContent = adjText;
        if (adjNote) {
            adjNote.innerHTML = `⚡ 已套用歷史落差調整 +${adjPct}%<br><span style="font-size:9px; opacity:0.8;">${adjReason}</span>`;
            adjNote.style.display = 'block';
        }
    } else {
        if (adjBadgeNo) adjBadgeNo.textContent = '';
        if (adjBadgeW) adjBadgeW.textContent = '';
        if (adjNote) adjNote.style.display = 'none';
    }

    // 根據系統採用的方法設定預設標籤
    if (usePremiumMethod) {
        switchStep1Tab('premium');
    } else {
        switchStep1Tab('price');
    }
    // 預設顯示有加權（因為系統建議使用加權結果）
    switchStep1Weight('weight');

    // v3.97-as-cr: 延遲更新明細，確保表格已渲染
    setTimeout(() => {
        updateStep1Detail();
    }, 150);

    // v3.97-cu: 舊Step 2/3已移除，改用新的整合版Step 3（在Step 4之後執行）

    // 取得inputData供後續使用
    const inputData = r.inputData || {};

    // ========== Step 2(原Step 4): 最強大腦分析法（四維度滾動加權） ==========
    // v3.97q 全新設計：產業30% + 市場氛圍25% + 理論價20% + 信評25%

    // 取得當前標的條件
    const step4Guarantee = inputData.guarantee || '無擔保';

    // v3.97w: 優先使用閃電帶入的實際規模數字
    let step4Size = window.currentActualIssueSize || 0;
    if (step4Size <= 0) {
        // 從下拉選單區間推算中間值
        const sizeRange = inputData.issueSize || '';
        if (sizeRange === '小於2億') step4Size = 1;
        else if (sizeRange === '2~5億') step4Size = 3.5;
        else if (sizeRange === '5~10億') step4Size = 7.5;
        else if (sizeRange === '10~15億') step4Size = 12.5;
        else if (sizeRange === '15~20億') step4Size = 17.5;
        else if (sizeRange === '大於20億') step4Size = 25;
        else step4Size = 5; // 預設
    }

    const step4Industry = (inputData.industry || '').split(' ')[0];  // 取主分類
    const step4Rating = String(inputData.rating || '').replace(/[^0-9]/g, '');  // 只取數字

    // v3.97w: Debug 輸出
    console.log('🧠 Step4 篩選條件:', { step4Guarantee, step4Size, step4Industry, step4Rating });

    // 規模範圍 50%-150% (v3.97s 放寬條件增加樣本數)
    const sizeMin = step4Size * 0.5;
    const sizeMax = step4Size * 1.5;

    // 理論價區間定義
    const priceZones = [
        { min: 0, max: 90, label: '<90' },
        { min: 90, max: 95, label: '90~95' },
        { min: 95, max: 100, label: '95~100' },
        { min: 100, max: 105, label: '100~105' },
        { min: 105, max: 110, label: '105~110' },
        { min: 110, max: 120, label: '110~120' },
        { min: 120, max: 140, label: '120~140' },
        { min: 140, max: 9999, label: '>140' }
    ];
    const currentZone = priceZones.find(z => theoPrice >= z.min && theoPrice < z.max) || priceZones[priceZones.length - 1];

    // 顯示篩選條件
    document.getElementById('step4Guarantee').textContent = step4Guarantee;
    document.getElementById('step4SizeRange').textContent = `${sizeMin.toFixed(1)}~${sizeMax.toFixed(1)}億`;
    document.getElementById('step4TheoPrice').textContent = theoPrice > 0 ? theoPrice.toFixed(2) + '元' : '--';

    // 滾動計算函數
    // v3.97-ct 升級：整合AICore異常值處理
    const calcRolling = (data, guarType = 'unguaranteed') => {
        if (!data || data.length < 3) return null;

        // 按日期排序（最近在前）
        const sorted = [...data].sort((a, b) => new Date(b['截標日']) - new Date(a['截標日']));
        const n = sorted.length;

        const recent3 = sorted.slice(0, Math.min(3, n));
        const recent6 = sorted.slice(0, Math.min(6, n));
        const recent9 = sorted.slice(0, Math.min(9, n));

        // 計算溢價率（從價格和理論價計算）
        const getPremium = (item, priceFields) => {
            const theo = parseFloat(item['理論價']) || 0;
            if (theo <= 0) return NaN;
            for (const f of priceFields) {
                const price = parseFloat(item[f]);
                if (!isNaN(price) && price > 0) {
                    return ((price / theo) - 1) * 100;
                }
            }
            return NaN;
        };

        // v3.97-ct 升級：帶異常值處理的平均計算
        const calcGroupAvgWithOutlier = (arr, priceFields) => {
            const valid = arr.map(x => getPremium(x, priceFields)).filter(x => !isNaN(x));
            if (valid.length === 0) return { raw: NaN, adjusted: NaN, outlierCount: 0 };
            
            // 使用AICore進行異常值處理
            if (window.AICore) {
                const result = window.AICore.calcWeightedAvgWithOutlierHandling(valid, guarType);
                return { raw: result.avg, adjusted: result.adjustedAvg, outlierCount: result.outlierCount };
            }
            
            // 降級處理：無AICore時使用簡單平均
            const avg = valid.reduce((a, b) => a + b, 0) / valid.length;
            return { raw: avg, adjusted: avg, outlierCount: 0 };
        };

        const lowFields = ['最低得標', '最低得標價格'];
        const avgFields = ['加權均價', '平均得標', '平均得標價格', '得標加權平均價格'];

        const w3 = 0.5, w6 = 0.3, w9 = 0.2;

        // v3.97-ct：使用異常值調整後的平均
        const low3Result = calcGroupAvgWithOutlier(recent3, lowFields);
        const low6Result = calcGroupAvgWithOutlier(recent6, lowFields);
        const low9Result = calcGroupAvgWithOutlier(recent9, lowFields);

        const avg3Result = calcGroupAvgWithOutlier(recent3, avgFields);
        const avg6Result = calcGroupAvgWithOutlier(recent6, avgFields);
        const avg9Result = calcGroupAvgWithOutlier(recent9, avgFields);

        // 使用調整後的值計算滾動平均
        const low3 = low3Result.adjusted;
        const low6 = low6Result.adjusted;
        const low9 = low9Result.adjusted;
        const avg3 = avg3Result.adjusted;
        const avg6 = avg6Result.adjusted;
        const avg9 = avg9Result.adjusted;

        const rollingLow = (!isNaN(low3) ? low3 * w3 : 0) + (!isNaN(low6) ? low6 * w6 : 0) + (!isNaN(low9) ? low9 * w9 : 0);
        const rollingAvg = (!isNaN(avg3) ? avg3 * w3 : 0) + (!isNaN(avg6) ? avg6 * w6 : 0) + (!isNaN(avg9) ? avg9 * w9 : 0);
        
        // 計算異常值總數
        const totalOutliers = low3Result.outlierCount + low6Result.outlierCount + low9Result.outlierCount;

        // v3.97t: 計算Top3（按溢價率排序取最高的3檔）
        const withPremium = data.map(item => {
            const prem = getPremium(item, avgFields);
            // v3.97-ct：標記異常值
            let outlierLabel = null;
            if (window.AICore && !isNaN(prem)) {
                const stats = guarType === 'guaranteed' ? window.AICore.stats.guaranteed : window.AICore.stats.unguaranteed;
                outlierLabel = window.AICore.outlier.getOutlierLabel(prem, stats.mean, stats.std);
            }
            return { item, prem, outlierLabel };
        }).filter(x => !isNaN(x.prem));

        const top3 = withPremium
            .sort((a, b) => b.prem - a.prem)
            .slice(0, 3)
            .map(x => ({
                name: x.item['名稱'] || x.item['可轉債名稱'] || x.item['CB名稱'] || '-',
                prem: x.prem,
                outlierLabel: x.outlierLabel
            }));

        return {
            lowPrem: rollingLow,
            avgPrem: rollingAvg,
            count: n,
            samples: sorted.slice(0, 9),
            top3: top3,
            // v3.97-ct 新增：異常值統計
            outlierInfo: {
                totalOutliers: totalOutliers,
                hasOutliers: totalOutliers > 0
            },
            // v3.97-ct 新增：原始值（未經異常值處理）
            rawValues: {
                low3: low3Result.raw,
                low6: low6Result.raw,
                low9: low9Result.raw,
                avg3: avg3Result.raw,
                avg6: avg6Result.raw,
                avg9: avg9Result.raw
            }
        };
    };

    // 檢查是否有歷史數據
    if (typeof window.auctionDataCache !== 'undefined' && window.auctionDataCache.length > 0) {
        const allData = window.auctionDataCache;

        // v3.97v: 擔保比對函數（支援多種格式）
        const matchGuarantee = (itemGuar, targetGuar) => {
            const item = String(itemGuar || '').trim();
            const target = String(targetGuar || '').trim();
            if (target === '無擔保' || target === '無') {
                return item === '無' || item === '無擔保' || item === '';
            }
            if (target === '有擔保' || target === '有') {
                return item === '有' || item === '有擔保';
            }
            return item === target;
        };

        // 共同篩選條件：同擔保 + 規模50-150%（用於市場氛圍和理論價）
        const baseFilterWithSize = (item) => {
            const itemGuar = item['擔保'] || '';
            const itemSize = parseFloat(item['發行規模']) || 0;
            const guarMatch = matchGuarantee(itemGuar, step4Guarantee);
            const sizeMatch = itemSize >= sizeMin && itemSize <= sizeMax;
            return guarMatch && sizeMatch;
        };

        // 僅擔保篩選（用於產業和信評，不限規模）
        const baseFilterNoSize = (item) => {
            const itemGuar = item['擔保'] || '';
            return matchGuarantee(itemGuar, step4Guarantee);
        };

        // 四維度篩選
        // 1. 產業維度（30%）- v3.97v: 不限規模，用包含比對
        const industryData = allData.filter(item => {
            if (!baseFilterNoSize(item)) return false;
            const itemInd = (item['產業分類'] || item['產業'] || '');
            // 包含比對：輸入「半導體」可匹配「半導體業」
            return step4Industry !== '' && itemInd.includes(step4Industry);
        });

        // 2. 市場氛圍維度（25%）- 同擔保+同規模範圍
        const marketData = allData.filter(baseFilterWithSize);

        // 3. 理論價區間維度（20%）- 同擔保+同規模+同理論價區間
        const theoData = allData.filter(item => {
            if (!baseFilterWithSize(item)) return false;
            const itemTheo = parseFloat(item['理論價']) || 0;
            return itemTheo >= currentZone.min && itemTheo < currentZone.max;
        });

        // 4. 信評維度（25%）- v3.97v: 不限規模，只看同擔保+同信評
        const ratingData = allData.filter(item => {
            if (!baseFilterNoSize(item)) return false;
            const itemRating = String(item['信用評等'] || item['TCRI'] || item['信評'] || '').replace(/[^0-9]/g, '');
            return itemRating === step4Rating && step4Rating !== '';
        });

        // v3.97u: Debug 輸出篩選結果
        console.log('🧠 Step4 篩選結果:', {
            總數據: allData.length,
            產業: industryData.length,
            市場氛圍: marketData.length,
            理論價: theoData.length,
            信評: ratingData.length
        });

        // 計算各維度滾動結果
        const industryResult = calcRolling(industryData);
        const marketResult = calcRolling(marketData);
        const theoResult = calcRolling(theoData);
        const ratingResult = calcRolling(ratingData);

        // 動態權重分配
        let weights = { industry: 0.30, market: 0.25, theo: 0.20, rating: 0.25 };
        let validDims = [];

        if (industryResult) validDims.push({ key: 'industry', result: industryResult, baseWeight: 0.30 });
        if (marketResult) validDims.push({ key: 'market', result: marketResult, baseWeight: 0.25 });
        if (theoResult) validDims.push({ key: 'theo', result: theoResult, baseWeight: 0.20 });
        if (ratingResult) validDims.push({ key: 'rating', result: ratingResult, baseWeight: 0.25 });

        // 重新分配權重
        const totalValidWeight = validDims.reduce((sum, d) => sum + d.baseWeight, 0);
        validDims.forEach(d => {
            d.weight = totalValidWeight > 0 ? d.baseWeight / totalValidWeight : 0;
        });

        // v3.97t: Top3格式化函數
        const formatTop3 = (top3) => {
            if (!top3 || top3.length === 0) return '--';
            return top3.map((t, i) => `${i+1}.${t.name.replace(/一|二|三|四|五/, '')} ${t.prem.toFixed(1)}%`).join('<br>');
        };

        // 顯示各維度結果
        // 產業
        if (industryResult) {
            document.getElementById('step4IndustryLabel').textContent = step4Industry || '未指定';
            document.getElementById('step4IndustryPrem').textContent = industryResult.avgPrem.toFixed(2) + '%';
            document.getElementById('step4IndustryCount').textContent = industryResult.count;
            const indWeight = validDims.find(d => d.key === 'industry')?.weight || 0;
            document.getElementById('step4IndustryWeight').textContent = (indWeight * 100).toFixed(0) + '%';
            document.getElementById('step4IndustryTop3').innerHTML = formatTop3(industryResult.top3);
        } else {
            document.getElementById('step4IndustryLabel').textContent = step4Industry || '未指定';
            document.getElementById('step4IndustryPrem').textContent = '樣本不足';
            document.getElementById('step4IndustryCount').textContent = industryData.length;
            document.getElementById('step4IndustryWeight').textContent = '0%';
            document.getElementById('step4IndustryTop3').innerHTML = '--';
        }

        // 市場氛圍
        if (marketResult) {
            document.getElementById('step4MarketPrem').textContent = marketResult.avgPrem.toFixed(2) + '%';
            document.getElementById('step4MarketCount').textContent = marketResult.count;
            const mktWeight = validDims.find(d => d.key === 'market')?.weight || 0;
            document.getElementById('step4MarketWeight').textContent = (mktWeight * 100).toFixed(0) + '%';
            document.getElementById('step4MarketTop3').innerHTML = formatTop3(marketResult.top3);
        } else {
            document.getElementById('step4MarketPrem').textContent = '樣本不足';
            document.getElementById('step4MarketCount').textContent = marketData.length;
            document.getElementById('step4MarketWeight').textContent = '0%';
            document.getElementById('step4MarketTop3').innerHTML = '--';
        }

        // 理論價
        document.getElementById('step4TheoZone').textContent = currentZone.label;
        if (theoResult) {
            document.getElementById('step4TheoPrem').textContent = theoResult.avgPrem.toFixed(2) + '%';
            document.getElementById('step4TheoCount').textContent = theoResult.count;
            const theoWeight = validDims.find(d => d.key === 'theo')?.weight || 0;
            document.getElementById('step4TheoWeight').textContent = (theoWeight * 100).toFixed(0) + '%';
            document.getElementById('step4TheoTop3').innerHTML = formatTop3(theoResult.top3);
        } else {
            document.getElementById('step4TheoPrem').textContent = '樣本不足';
            document.getElementById('step4TheoCount').textContent = theoData.length;
            document.getElementById('step4TheoWeight').textContent = '0%';
            document.getElementById('step4TheoTop3').innerHTML = '--';
        }

        // 信評
        if (ratingResult) {
            document.getElementById('step4RatingLabel').textContent = step4Rating || '未指定';
            document.getElementById('step4RatingPrem').textContent = ratingResult.avgPrem.toFixed(2) + '%';
            document.getElementById('step4RatingCount').textContent = ratingResult.count;
            const ratWeight = validDims.find(d => d.key === 'rating')?.weight || 0;
            document.getElementById('step4RatingWeight').textContent = (ratWeight * 100).toFixed(0) + '%';
            document.getElementById('step4RatingTop3').innerHTML = formatTop3(ratingResult.top3);
        } else {
            document.getElementById('step4RatingLabel').textContent = step4Rating || '未指定';
            document.getElementById('step4RatingPrem').textContent = '樣本不足';
            document.getElementById('step4RatingCount').textContent = ratingData.length;
            document.getElementById('step4RatingWeight').textContent = '0%';
            document.getElementById('step4RatingTop3').innerHTML = '--';
        }

        // 合成最終結果
        if (validDims.length > 0) {
            let finalLowPrem = 0, finalAvgPrem = 0;
            let totalSampleCount = 0;
            let totalOutliers = 0;
            
            validDims.forEach(d => {
                finalLowPrem += d.result.lowPrem * d.weight;
                finalAvgPrem += d.result.avgPrem * d.weight;
                totalSampleCount += d.result.count;
                if (d.result.outlierInfo) {
                    totalOutliers += d.result.outlierInfo.totalOutliers;
                }
            });

            const finalLowPrice = theoPrice * (1 + finalLowPrem / 100);
            const finalAvgPrice = theoPrice * (1 + finalAvgPrem / 100);

            document.getElementById('step4FinalLowPrem').textContent = finalLowPrem.toFixed(2) + '%';
            document.getElementById('step4FinalAvgPrem').textContent = finalAvgPrem.toFixed(2) + '%';
            document.getElementById('step4FinalLowPrice').textContent = finalLowPrice.toFixed(2);
            document.getElementById('step4FinalAvgPrice').textContent = finalAvgPrice.toFixed(2);
            document.getElementById('step4PriceRange').textContent = `${finalLowPrice.toFixed(2)} ~ ${finalAvgPrice.toFixed(2)}元`;

            // v3.97-ct 新增：計算信心度
            let confidenceInfo = null;
            if (window.AICore) {
                const avgStd = window.AICore.stats.overall.std || 5;
                const confScore = window.AICore.confidence.calculate(totalSampleCount, avgStd, validDims.length >= 3);
                confidenceInfo = window.AICore.confidence.getLevel(confScore);
                confidenceInfo.score = confScore;
                confidenceInfo.explanation = window.AICore.confidence.generateExplanation(
                    totalSampleCount, avgStd, validDims.map(d => d.key)
                );
            }

            // 詳細內容
            let detailHTML = `<div style="margin-bottom:15px;">
                <b>四維度滾動分析明細</b>
                <div style="font-size:11px; color:#666; margin-top:5px;">
                    共同篩選：${step4Guarantee} + 規模${sizeMin.toFixed(1)}~${sizeMax.toFixed(1)}億
                </div>
            </div>`;
            
            // v3.97-ct 新增：數據依據說明區塊
            detailHTML += `<div style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border:2px solid #2196f3; border-radius:10px; padding:12px; margin-bottom:15px;">
                <div style="font-weight:bold; color:#1565c0; margin-bottom:8px;">📊 數據依據說明（AI智慧核心 v${window.AICore ? window.AICore.version : '1.0'}）</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:11px;">
                    <div>
                        <span style="color:#666;">參考樣本總數：</span>
                        <span style="font-weight:bold; color:#1976d2;">${totalSampleCount} 筆</span>
                    </div>
                    <div>
                        <span style="color:#666;">有效維度數：</span>
                        <span style="font-weight:bold; color:#1976d2;">${validDims.length} / 4</span>
                    </div>
                    <div>
                        <span style="color:#666;">異常值處理：</span>
                        <span style="font-weight:bold; color:${totalOutliers > 0 ? '#f57c00' : '#4caf50'};">${totalOutliers > 0 ? totalOutliers + ' 筆已調整權重' : '無異常值'}</span>
                    </div>
                    <div>
                        <span style="color:#666;">擔保類型：</span>
                        <span style="font-weight:bold; color:#7b1fa2;">${step4Guarantee}</span>
                    </div>
                </div>
                ${confidenceInfo ? `
                <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(33,150,243,0.3);">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:16px;">${confidenceInfo.stars}</span>
                        <span style="font-weight:bold; color:${confidenceInfo.color};">預測信心度：${confidenceInfo.text}（${confidenceInfo.score}分）</span>
                    </div>
                    <div style="font-size:10px; color:#666; margin-top:4px;">
                        ${confidenceInfo.explanation}
                    </div>
                </div>
                ` : ''}
            </div>`;

            // 各維度表格
            validDims.forEach(d => {
                const dimName = { industry: '🏭 產業', market: '📈 市場氛圍', theo: '💰 理論價區間', rating: '⭐ 信評' }[d.key];
                const dimLabel = {
                    industry: step4Industry,
                    market: '最近N檔',
                    theo: currentZone.label,
                    rating: step4Rating
                }[d.key];
                
                // v3.97-ct：異常值警示
                const outlierWarning = d.result.outlierInfo && d.result.outlierInfo.hasOutliers 
                    ? `<span style="color:#f57c00; font-size:10px;"> ⚠️ 含${d.result.outlierInfo.totalOutliers}筆異常值(已調整)</span>` 
                    : '';

                detailHTML += `<div style="margin-bottom:12px;">
                    <div style="font-weight:bold; margin-bottom:5px;">${dimName}（${dimLabel}）- 權重${(d.weight*100).toFixed(0)}%${outlierWarning}</div>
                    <table style="width:100%; border-collapse:collapse; font-size:10px;">
                        <tr style="background:#f5f5f5;">
                            <th style="padding:3px; border:1px solid #ddd;">標的</th>
                            <th style="padding:3px; border:1px solid #ddd;">截標日</th>
                            <th style="padding:3px; border:1px solid #ddd;">理論價</th>
                            <th style="padding:3px; border:1px solid #ddd;">最低得標</th>
                            <th style="padding:3px; border:1px solid #ddd;">權重</th>
                        </tr>`;

                d.result.samples.slice(0, 9).forEach((item, idx) => {
                    const bgColor = idx < 3 ? '#fff3e0' : (idx < 6 ? '#fff8e1' : '#ffffff');
                    const weight = idx < 3 ? '50%' : (idx < 6 ? '30%' : '20%');
                    const minBid = parseFloat(item['最低得標'] || item['最低得標價格']) || 0;
                    const itemTheo = parseFloat(item['理論價']) || 0;

                    // v3.97x: 修正標的名稱欄位
                    const cbName = item['名稱'] || item['可轉債名稱'] || item['CB名稱'] || '-';

                    // v3.97x: 修正日期格式（Excel序號轉日期）
                    let dateStr = '-';
                    const rawDate = item['截標日'];
                    if (rawDate) {
                        if (typeof rawDate === 'number') {
                            // Excel序號轉日期
                            const excelEpoch = new Date(1899, 11, 30);
                            const jsDate = new Date(excelEpoch.getTime() + rawDate * 86400000);
                            dateStr = jsDate.toISOString().split('T')[0];
                        } else if (rawDate instanceof Date) {
                            dateStr = rawDate.toISOString().split('T')[0];
                        } else {
                            dateStr = String(rawDate).split('T')[0];
                        }
                    }
                    
                    // v3.97-ct：計算溢價率並標記異常值
                    let premiumStr = '-';
                    let outlierIcon = '';
                    if (itemTheo > 0 && minBid > 0) {
                        const prem = ((minBid / itemTheo) - 1) * 100;
                        premiumStr = prem.toFixed(1) + '%';
                        if (window.AICore) {
                            const stats = step4Guarantee === '有擔保' ? window.AICore.stats.guaranteed : window.AICore.stats.unguaranteed;
                            const label = window.AICore.outlier.getOutlierLabel(prem, stats.mean, stats.std);
                            if (label.level !== 'normal') {
                                outlierIcon = ` ${label.icon}`;
                            }
                        }
                    }

                    detailHTML += `<tr style="background:${bgColor};">
                        <td style="padding:3px; border:1px solid #ddd;">${cbName}${outlierIcon}</td>
                        <td style="padding:3px; border:1px solid #ddd;">${dateStr}</td>
                        <td style="padding:3px; border:1px solid #ddd;">${itemTheo > 0 ? itemTheo.toFixed(1) : '-'}</td>
                        <td style="padding:3px; border:1px solid #ddd;">${minBid > 0 ? minBid.toFixed(2) : '-'}</td>
                        <td style="padding:3px; border:1px solid #ddd;">${weight}</td>
                    </tr>`;
                });
                detailHTML += `</table>
                    <div style="font-size:10px; color:#666; margin-top:3px;">
                        滾動溢價率：最低 ${d.result.lowPrem.toFixed(2)}% / 平均 ${d.result.avgPrem.toFixed(2)}%
                    </div>
                </div>`;
            });

            document.getElementById('step4DetailContent').innerHTML = detailHTML;
        } else {
            // 所有維度都樣本不足
            document.getElementById('step4FinalLowPrem').textContent = '--%';
            document.getElementById('step4FinalAvgPrem').textContent = '--%';
            document.getElementById('step4FinalLowPrice').textContent = '--';
            document.getElementById('step4FinalAvgPrice').textContent = '--';
            document.getElementById('step4PriceRange').textContent = '樣本不足';
            document.getElementById('step4DetailContent').innerHTML = '<div style="color:#999;">所有維度樣本數均不足3檔，無法進行滾動分析</div>';
        }
    } else {
        // 無歷史數據
        document.getElementById('step4IndustryPrem').textContent = '--';
        document.getElementById('step4MarketPrem').textContent = '--';
        document.getElementById('step4TheoPrem').textContent = '--';
        document.getElementById('step4RatingPrem').textContent = '--';
        document.getElementById('step4FinalLowPrem').textContent = '--%';
        document.getElementById('step4FinalAvgPrem').textContent = '--%';
        document.getElementById('step4FinalLowPrice').textContent = '--';
        document.getElementById('step4FinalAvgPrice').textContent = '--';
        document.getElementById('step4PriceRange').textContent = '無歷史數據';
        document.getElementById('step4DetailContent').innerHTML = '<div style="color:#999;">無法取得歷史競拍數據</div>';
    }

    // ========== Step 3: AI智能預測模組（整合版） ==========
    // v3.97-cu 新版：整合近期氛圍、雙軌預測、信心度量化
    
    if (window.AICore && typeof window.auctionDataCache !== 'undefined' && window.auctionDataCache.length > 0) {
        const step3TheoPrice = theoPrice;
        const step3Guarantee = inputData.guarantee || '無擔保';
        const guarType = (step3Guarantee === '有擔保' || step3Guarantee === '有') ? 'guaranteed' : 'unguaranteed';
        
        // 取得AICore統計數據
        const stats = window.AICore.stats;
        const historicalAvg = guarType === 'guaranteed' ? stats.guaranteed.mean : stats.unguaranteed.mean;
        const recentAvg = stats.recent9.mean;
        const overallStd = stats.overall.std;
        const sampleCount = stats.overall.n;
        
        // 計算雙軌整合
        const deviation = window.AICore.dualTrack.calcDeviation(recentAvg, historicalAvg);
        const alpha = window.AICore.dualTrack.getAlpha(deviation);
        const integratedPremium = window.AICore.dualTrack.integrate(historicalAvg, recentAvg, alpha);
        
        // 計算信心度
        const confScore = window.AICore.confidence.calculate(sampleCount, overallStd, true);
        const confLevel = window.AICore.confidence.getLevel(confScore);
        
        // 計算預測價格
        const step3LowPrice = step3TheoPrice * (1 + integratedPremium / 100 - overallStd / 200);
        const step3HighPrice = step3TheoPrice * (1 + integratedPremium / 100 + overallStd / 200);
        
        // 更新UI - 安全檢查元素是否存在
        const updateElement = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        };
        const updateStyle = (id, prop, value) => {
            const el = document.getElementById(id);
            if (el) el.style[prop] = value;
        };
        
        // ========== v3.98a 新增：市場熱度指數 ==========
        if (window.AICore.marketHeat) {
            const heatResult = window.AICore.marketHeat.calcHeatIndex(window.auctionDataCache, 10);
            const heatStyle = window.AICore.marketHeat.getHeatStyle(heatResult.level);
            
            updateElement('step3HeatIcon', heatStyle.icon);
            updateElement('step3HeatText', heatStyle.text);
            updateElement('step3HeatIndex', heatResult.index.toFixed(0));
            updateStyle('step3HeatIndicator', 'left', heatResult.index + '%');
            updateElement('step3HeatDetail', 
                `近10檔投標倍數 ${heatResult.recentMult.toFixed(2)}倍 | 近10檔平均溢價 ${heatResult.recentPrem.toFixed(2)}% | 趨勢: ${heatResult.trend}`
            );
            
            // 設置熱度區域背景色
            const heatEl = document.getElementById('step3MarketHeat');
            if (heatEl) {
                heatEl.style.background = heatStyle.bg;
                heatEl.style.borderColor = heatStyle.color;
            }
        }
        
        // ========== v3.98a 新增：集成預測引擎 ==========
        if (window.AICore.ensemble) {
            // 準備集成預測所需參數
            const ensembleParams = {
                theoPrice: step3TheoPrice,
                guarantee: step3Guarantee,
                auctionData: window.auctionDataCache,
                dimensions: {
                    totalLowPremium: r ? r.totalLowPremium : null,
                    weightedLowBidPrice: r ? r.weightedLowBidPrice : null
                }
            };
            
            const ensembleResult = window.AICore.ensemble.calcEnsemblePrediction(ensembleParams);
            
            if (ensembleResult && ensembleResult.methods && ensembleResult.methods.length > 0) {
                // 更新各方法預測值 - 加入安全檢查
                ensembleResult.methods.forEach((m, i) => {
                    if (m && typeof m.value === 'number' && !isNaN(m.value)) {
                        updateElement(`step3Method${i + 1}`, m.value.toFixed(2) + '元');
                    } else {
                        updateElement(`step3Method${i + 1}`, '--元');
                    }
                });
                
                // 更新集成結果 - 加入安全檢查
                if (typeof ensembleResult.value === 'number' && !isNaN(ensembleResult.value)) {
                    updateElement('step3EnsemblePrice', ensembleResult.value.toFixed(2) + '元');
                    updateElement('step3EnsembleStd', (ensembleResult.std || 0).toFixed(2));
                    
                    // 更新策略價格
                    updateElement('step3StratConservative', (ensembleResult.conservative || 100).toFixed(2));
                    updateElement('step3StratBalanced', (ensembleResult.balanced || ensembleResult.value).toFixed(2));
                    updateElement('step3StratAggressive', (ensembleResult.aggressive || ensembleResult.value).toFixed(2));
                    updateElement('step3StratUltimate', (ensembleResult.ultimate || ensembleResult.value).toFixed(2));
                } else {
                    updateElement('step3EnsemblePrice', '--元');
                    updateElement('step3EnsembleStd', '--');
                }
                
                console.log('🧠 v3.98c 集成預測引擎結果:', ensembleResult);
            } else {
                // 集成預測失敗時顯示預設值
                for (let i = 1; i <= 4; i++) {
                    updateElement(`step3Method${i}`, '--元');
                }
                updateElement('step3EnsemblePrice', '--元');
                updateElement('step3EnsembleStd', '--');
            }
            
            // 計算MA10和分層模型供顯示
            const ma10 = window.AICore.ensemble.calcMA10(window.auctionDataCache);
            const segment = window.AICore.ensemble.calcSegmentPrediction(step3TheoPrice, step3Guarantee, window.auctionDataCache);
            
            if (ma10) {
                console.log('📊 MA10市場熱度:', ma10);
            }
            if (segment) {
                console.log('📊 分層模型預測:', segment);
            }
        }
        
        // 原有雙軌預測更新
        updateElement('step3HistoricalPrem', historicalAvg.toFixed(2) + '%');
        updateElement('step3HistoricalWeight', `權重 ${(alpha * 100).toFixed(0)}%`);
        updateElement('step3RecentPrem', recentAvg.toFixed(2) + '%');
        updateElement('step3RecentWeight', `權重 ${((1 - alpha) * 100).toFixed(0)}%`);
        updateElement('step3IntegratedPrem', integratedPremium.toFixed(2) + '%');
        updateElement('step3PriceRange', `${step3LowPrice.toFixed(2)} ~ ${step3HighPrice.toFixed(2)}元`);
        
        // 信心度顯示
        updateElement('step3ConfStars', confLevel.stars);
        updateElement('step3ConfText', confLevel.text);
        updateStyle('step3ConfText', 'color', confLevel.color);
        updateElement('step3ConfScore', confScore);
        updateStyle('step3ConfBar', 'width', confScore + '%');
        updateStyle('step3ConfBar', 'background', confLevel.color);
        updateElement('step3ConfExplanation', window.AICore.confidence.generateExplanation(sampleCount, overallStd, ['產業', '市場氛圍', '理論價區間', '信評', '集成引擎']));
        
        // 數據依據
        updateElement('step3SampleCount', sampleCount + '筆');
        updateElement('step3StdDev', overallStd.toFixed(2) + '%');
        updateElement('step3LastUpdate', new Date().toLocaleDateString('zh-TW'));
        
        // 氛圍偏離警示
        const alertEl = document.getElementById('step3AtmosphereAlert');
        if (alertEl) {
            if (window.AICore.atmosphereAlert.shouldAlert(recentAvg, historicalAvg)) {
                const alertMsg = window.AICore.atmosphereAlert.generateMessage(recentAvg, historicalAvg, 9);
                alertEl.style.display = 'block';
                updateElement('step3AlertIcon', alertMsg.icon);
                updateElement('step3AlertTitle', alertMsg.title);
                updateElement('step3AlertDetail', alertMsg.detail);
            } else {
                alertEl.style.display = 'none';
            }
        }
        
        console.log('🤖 Step3 AI智能預測 v3.98a:', { historicalAvg, recentAvg, alpha, integratedPremium, confScore });
        
    } else {
        // 數據不足 - 安全檢查
        const setDefault = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        };
        setDefault('step3HistoricalPrem', '--%');
        setDefault('step3RecentPrem', '--%');
        setDefault('step3IntegratedPrem', '--%');
        setDefault('step3PriceRange', '數據載入中...');
        setDefault('step3ConfStars', '⚠️');
        setDefault('step3ConfText', '無法計算');
        setDefault('step3ConfScore', '--');
    }

    const div = document.getElementById('evaluationResult');
    div.className = 'evaluation-result active';

    const nm={'theoRange':'理論價','broker':'券商','size':'規模','industry':'產業','years':'年期','capital':'股本','rating':'信評'};

    // === 溢價率分析法表格 ===
    let premiumRows = '';
    let sumLow = 0, sumAvg = 0, dimCount = 0;
    for(const[k,d] of Object.entries(r.dimensions)) {
        premiumRows+=`<tr>
            <td>${nm[k] || k}</td>
            <td>${d.displayRange || d.range}</td>
            <td>${safeFixed(d.low)}%</td>
            <td>${safeFixed(d.avg)}%</td>
            <td>${safeFixed(d.weight*100,0)}%</td>
            <td>${safeFixed(d.weightedLow)}</td>
            <td>${safeFixed(d.weightedAvg)}</td>
        </tr>`;
        if(d.low !== null && !isNaN(d.low)) { sumLow += d.low; }
        if(d.avg !== null && !isNaN(d.avg)) { sumAvg += d.avg; }
        dimCount++;
    }

    if(r.inputData.subjectiveWeight > 0) {
        premiumRows+=`<tr style="background:#fff3e0">
            <td>主觀</td><td>自訂</td>
            <td>${r.inputData.subjectiveLowPremium}%</td>
            <td>${r.inputData.subjectiveAvgPremium}%</td>
            <td>${r.inputData.subjectiveWeight}%</td>
            <td>${r.weightedSubjectiveLow}</td>
            <td>${r.weightedSubjectiveAvg}</td>
        </tr>`;
    }

    // v3.72 新增：擔保調整行
    if(r.guaranteeAdj > 0) {
        premiumRows+=`<tr style="background:#e8f5e9">
            <td>🛡️ 擔保</td><td>有擔保</td>
            <td colspan="3" style="text-align:center; color:#2e7d32;">籌碼集中效應調整</td>
            <td>+${r.guaranteeAdj.toFixed(1)}</td>
            <td>+${r.guaranteeAdj.toFixed(1)}</td>
        </tr>`;
    }

    // v3.73 修正：合計行增加原始數值的簡單平均
    const avgLow = dimCount > 0 ? (sumLow / dimCount).toFixed(2) : '-';
    const avgAvgPrem = dimCount > 0 ? (sumAvg / dimCount).toFixed(2) : '-';
    premiumRows+=`<tfoot><tr>
        <td></td><td style="text-align:right"><b>合計</b></td>
        <td><b>${avgLow}%</b></td><td><b>${avgAvgPrem}%</b></td><td>100%</td>
        <td><b>${r.totalLowPremium}%</b></td>
        <td><b>${r.totalAvgPremium}%</b></td>
    </tr></tfoot>`;

    // === 得標價格分析法表格 ===
    let priceRows = '';
    let sumLowBid = 0, sumAvgBid = 0, priceDimCount = 0;
    for(const[k,d] of Object.entries(r.dimensions)) {
        priceRows+=`<tr>
            <td>${nm[k] || k}</td>
            <td>${d.displayRange || d.range}</td>
            <td>${safeFixed(d.lowBidPrice || 0, 2)}</td>
            <td>${safeFixed(d.avgBidPrice || 0, 2)}</td>
            <td>${safeFixed(d.weight*100,0)}%</td>
            <td>${safeFixed(d.weightedLowBid || 0, 2)}</td>
            <td>${safeFixed(d.weightedAvgBid || 0, 2)}</td>
        </tr>`;
        if(d.lowBidPrice > 0) { sumLowBid += d.lowBidPrice; priceDimCount++; }
        if(d.avgBidPrice > 0) { sumAvgBid += d.avgBidPrice; }
    }

    // v3.73 修正：合計行增加原始數值的簡單平均
    const avgLowBid = priceDimCount > 0 ? (sumLowBid / priceDimCount).toFixed(2) : '-';
    const avgAvgBid = priceDimCount > 0 ? (sumAvgBid / priceDimCount).toFixed(2) : '-';
    priceRows+=`<tfoot><tr>
        <td></td><td style="text-align:right"><b>加權得標價</b></td>
        <td><b>${avgLowBid}</b></td><td><b>${avgAvgBid}</b></td><td>100%</td>
        <td><b>${r.weightedLowBidPrice}</b></td>
        <td><b>${r.weightedAvgBidPrice}</b></td>
    </tr></tfoot>`;

    // 檢查溢價率法是否低於底標，並生成對應的說明
    const premiumWarning = r.premiumBelowFloor
        ? `<div style="background:#fff3e0; border-left:4px solid #ff9800; padding:10px 12px; margin-top:10px; border-radius:0 8px 8px 0; font-size:13px; color:#e65100;">
            ⚠️ 歷史溢價率計算結果低於底標，已自動調整為底標基準模式<br>
            <span style="font-size:12px;">💡 以底標價 ${r.floorPrice} 元投標 = 相當於溢價率 <b>${r.floorBasedPremium}%</b></span>
           </div>`
        : '';

    // 根據是否低於底標決定策略卡片說明
    const conservativeDesc = r.premiumBelowFloor
        ? `底標價`
        : `理論價×(1+${r.totalLowPremium}%)`;
    const balancedDesc = r.premiumBelowFloor
        ? `底標價×1.03`
        : `理論價×(1+${r.totalAvgPremium}%)`;
    const aggressiveDesc = r.premiumBelowFloor
        ? `底標價×1.05`
        : ``;
    const ultimateDesc = r.premiumBelowFloor
        ? `底標價×1.07`
        : ``;

    // v3.69 新增：維度填寫狀態提示
    const dimWarning = r.filledDimCount < r.totalDimCount
        ? `<div style="background:#fff3e0; border-left:4px solid #ff9800; padding:10px 12px; margin-top:10px; border-radius:0 8px 8px 0; font-size:13px; color:#e65100;">
            ⚠️ 您目前填寫了 <b>${r.filledDimCount}</b> 個維度（共 ${r.totalDimCount} 個），系統已按比例調整權重計算。填寫越多維度，評估結果越精準。
           </div>`
        : '';

    // v3.97y: 組合標題（優先用閃電帶入的CB代號+名稱）
    let resultTitle = r.cbName || '未命名標的';
    if (window.currentCBCode && window.currentCBName) {
        resultTitle = `${window.currentCBCode} ${window.currentCBName}`;
    } else if (window.currentCBName) {
        resultTitle = window.currentCBName;
    }

    div.innerHTML = `
    <div class="result-header"><h2>${resultTitle}</h2><div>AI 評估結果</div></div>

    <!-- ========== 基本資訊 ========== -->
    <div class="detail-section" style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);">
        <h3>📋 基本資訊</h3>
        <div style="display:flex; gap:30px; flex-wrap:wrap; font-size:16px;">
            <div><span style="color:#666;">理論價格：</span><b style="color:#667eea; font-size:24px;">${r.theoreticalPrice || 0}</b> 元</div>
            <div><span style="color:#666;">底標價格：</span><b style="font-size:20px;">${r.floorPrice}</b> 元</div>
            <div><span style="color:#666;">已填寫維度：</span><b style="color:#1976d2;">${r.filledDimCount}</b> / ${r.totalDimCount}</div>
        </div>
        ${dimWarning}
    </div>

    <!-- ========== 溢價率分析法 ========== -->
    <div class="detail-section" style="border: 2px solid #1976d2; border-radius: 12px;">
        <h3 style="color:#1976d2;">📈 分析法一：溢價率分析法</h3>
        <p style="color:#666; font-size:13px; margin-bottom:10px;">
            適用情境：理論價 ≥ 95元時，在理論價基礎上加上歷史平均溢價率計算投標價
        </p>

        <!-- 溢價率法核心數據 -->
        <div style="background:#e3f2fd; padding:12px 15px; border-radius:8px; margin-bottom:15px;">
            <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                <div style="flex:1; min-width:150px;">
                    <div style="color:#1565c0; font-size:13px;">預估溢價區間</div>
                    <div style="font-size:20px; font-weight:bold; color:#0d47a1;">${r.totalLowPremium}% ~ ${r.totalAvgPremium}%</div>
                </div>
                <div style="flex:1; min-width:150px;">
                    <div style="color:#1565c0; font-size:13px;">保守投標價</div>
                    <div style="font-size:20px; font-weight:bold; color:#2e7d32;">${r.premiumBidPrices.conservative} 元</div>
                </div>
                <div style="flex:1; min-width:150px;">
                    <div style="color:#1565c0; font-size:13px;">平衡投標價</div>
                    <div style="font-size:20px; font-weight:bold; color:#1565c0;">${r.premiumBidPrices.balanced} 元</div>
                </div>
            </div>
        </div>

        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead><tr>
                    <th>維度</th><th>條件</th>
                    <th>最低<br>溢價</th><th>平均<br>溢價</th>
                    <th>權重</th><th>加權<br>最低</th><th>加權<br>平均</th>
                </tr></thead>
                <tbody>${premiumRows}</tbody>
            </table>
        </div>
        ${premiumWarning}
        <div class="price-grid" style="margin-top:15px;">
            <div class="strategy-card conservative">
                <h4>🛡️ 保守</h4>
                <div class="price">${r.premiumBidPrices.conservative}</div>
                <div style="font-size:11px; color:#666;">${conservativeDesc}</div>
            </div>
            <div class="strategy-card balanced">
                <h4>⚖️ 平衡</h4>
                <div class="price">${r.premiumBidPrices.balanced}</div>
                <div style="font-size:11px; color:#666;">${balancedDesc}</div>
            </div>
            <div class="strategy-card aggressive">
                <h4>🚀 積極</h4>
                <div class="price">${r.premiumBidPrices.aggressive}</div>
                <div style="font-size:11px; color:#666;">${aggressiveDesc}</div>
            </div>
            <div class="strategy-card ultimate">
                <h4>🔥 極致</h4>
                <div class="price">${r.premiumBidPrices.ultimate}</div>
                <div style="font-size:11px; color:#666;">${ultimateDesc}</div>
            </div>
        </div>
    </div>

    <!-- ========== 得標價格分析法 ========== -->
    <div class="detail-section" style="border: 2px solid #e65100; border-radius: 12px;">
        <h3 style="color:#e65100;">📊 分析法二：得標價格分析法</h3>
        <p style="color:#666; font-size:13px; margin-bottom:10px;">
            適用情境：理論價 < 95元 或 溢價率法低於底標時，直接用歷史平均得標價格加權計算
        </p>

        <!-- 得標價格法核心數據 -->
        <div style="background:#fff3e0; padding:12px 15px; border-radius:8px; margin-bottom:15px;">
            <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                <div style="flex:1; min-width:150px;">
                    <div style="color:#e65100; font-size:13px;">加權最低得標價</div>
                    <div style="font-size:20px; font-weight:bold; color:#2e7d32;">${r.weightedLowBidPrice} 元</div>
                    <div style="font-size:12px; color:#666;">≈ 溢價率 ${r.impliedLowPremium}%</div>
                </div>
                <div style="flex:1; min-width:150px;">
                    <div style="color:#e65100; font-size:13px;">加權平均得標價</div>
                    <div style="font-size:20px; font-weight:bold; color:#bf360c;">${r.weightedAvgBidPrice} 元</div>
                    <div style="font-size:12px; color:#666;">≈ 溢價率 ${r.impliedAvgPremium}%</div>
                </div>
                <div style="flex:1; min-width:150px;">
                    <div style="color:#e65100; font-size:13px;">底標價格</div>
                    <div style="font-size:20px; font-weight:bold; color:#333;">${r.floorPrice} 元</div>
                </div>
            </div>
        </div>

        <div style="overflow-x:auto;">
            <table class="data-table">
                <thead><tr>
                    <th>維度</th><th>條件</th>
                    <th>最低<br>得標價</th><th>平均<br>得標價</th>
                    <th>權重</th><th>加權<br>最低</th><th>加權<br>平均</th>
                </tr></thead>
                <tbody>${priceRows}</tbody>
            </table>
        </div>
        <div class="price-grid" style="margin-top:15px;">
            <div class="strategy-card conservative" style="border-color:#e65100;">
                <h4>🛡️ 保守</h4>
                <div class="price">${r.priceBidPrices.conservative}</div>
                <div style="font-size:11px; color:#666;">加權最低得標價</div>
            </div>
            <div class="strategy-card balanced" style="border-color:#e65100;">
                <h4>⚖️ 平衡</h4>
                <div class="price">${r.priceBidPrices.balanced}</div>
                <div style="font-size:11px; color:#666;">加權平均得標價</div>
            </div>
            <div class="strategy-card aggressive" style="border-color:#e65100;">
                <h4>🚀 積極</h4>
                <div class="price">${r.priceBidPrices.aggressive}</div>
            </div>
            <div class="strategy-card ultimate" style="border-color:#e65100;">
                <h4>🔥 極致</h4>
                <div class="price">${r.priceBidPrices.ultimate}</div>
            </div>
        </div>
    </div>

    ${generateRexCommentary(r)}

    ${generateConditionSummaryHTML(r)}

    <!-- v3.97-as-co: 移除重複的 majorPlayerHTML，已整合到 Step 3 -->

    <!-- v3.97-as-cq: 隱藏的維度表格供 Step 1 明細引用 -->
    <div id="hiddenDimensionTables" style="display:none;">
        <div id="premiumDimensionTable">
            <div style="font-weight:bold; color:#1976d2; margin-bottom:8px;">📈 溢價率分析法 - 各維度明細</div>
            <div style="overflow-x:auto;">
                <table class="data-table" style="font-size:12px;">
                    <thead><tr>
                        <th>維度</th><th>條件</th>
                        <th>最低<br>溢價</th><th>平均<br>溢價</th>
                        <th>權重</th><th>加權<br>最低</th><th>加權<br>平均</th>
                    </tr></thead>
                    <tbody>${premiumRows}</tbody>
                </table>
            </div>
        </div>
        <div id="priceDimensionTable" style="margin-top:15px;">
            <div style="font-weight:bold; color:#e65100; margin-bottom:8px;">📊 得標均價法 - 各維度明細</div>
            <div style="overflow-x:auto;">
                <table class="data-table" style="font-size:12px;">
                    <thead><tr>
                        <th>維度</th><th>條件</th>
                        <th>最低<br>得標</th><th>平均<br>得標</th>
                        <th>權重</th><th>加權<br>最低</th><th>加權<br>平均</th>
                    </tr></thead>
                    <tbody>${priceRows}</tbody>
                </table>
            </div>
        </div>
    </div>

    <div style="text-align:center;margin-top:25px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button onclick="location.reload()" class="calculate-btn" style="width:180px; background:#555;">🔄 重新評估</button>
        <button onclick="window.print()" class="calculate-btn" style="width:180px;">🖨️ 列印報告</button>
    </div>`;

    div.scrollIntoView({ behavior: 'smooth' });

    // v3.72: 初始化出價風險評估
    if (r.majorPlayerResult && r.theoreticalPrice) {
        setTimeout(() => {
            const bidInput = document.getElementById('mpUserBidPrice');
            if (bidInput) {
                const bidPrice = parseFloat(bidInput.value) || r.floorPrice;
                const basePrice = Math.max(r.theoreticalPrice, r.floorPrice);
                const userPremium = ((bidPrice / basePrice) - 1) * 100;
                updateBidRiskAssessment(userPremium, r.theoreticalPrice, r.guarantee);
            }
        }, 100);
    }
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // v3.72 修改：維度權重重新優化
    const cbName = document.getElementById('cbName').value;
    const industry = document.getElementById('industry').value;
    const issueSize = document.getElementById('issueSize').value;
    const years = document.getElementById('years').value;
    const guarantee = document.getElementById('guarantee').value;
    const rating = document.getElementById('rating').value;
    const capital = document.getElementById('capital').value;
    const stockPrice = document.getElementById('stockPrice').value;
    const actualConversionPrice = document.getElementById('actualConversionPrice').value;
    const theoRange = document.getElementById('theoRange').value;  // v3.72 改為理論價區間
    const broker = document.getElementById('broker').value;

    // v3.72 新增：預估投標倍數
    const estBidMultiple = parseFloat(document.getElementById('estBidMultiple')?.value) || 0;

    // 檢查是否至少填寫一個條件
    const hasAnyCondition = industry || issueSize || years || guarantee || rating || capital || theoRange || broker;

    if (!hasAnyCondition) {
        alert("⚠️ 請至少填寫一個篩選條件（產業、規模、年期、擔保、信評、股本、理論價、券商其中之一）");
        return;
    }

    try {
        displayResult(calculateEvaluation({
            cbName: cbName,
            industry: industry,
            issueSize: issueSize,
            years: years,
            guarantee: guarantee,
            rating: rating,
            capital: capital,
            stockPrice: parseFloat(stockPrice) || 0,
            actualConversionPrice: parseFloat(actualConversionPrice) || 0,
            floorPrice: parseFloat(document.getElementById('floorPrice').value) || 100,
            theoRange: theoRange,  // v3.72 改為理論價區間
            subjectiveWeight: parseFloat(document.getElementById('subjectiveWeight').value)||0,
            subjectiveLowPremium: parseFloat(document.getElementById('subjectiveLowPremium').value)||0,
            subjectiveAvgPremium: parseFloat(document.getElementById('subjectiveAvgPremium').value)||0,
            broker: broker,
            estBidMultiple: estBidMultiple
        }));
    } catch (err) {
        alert("⚠️ 計算錯誤：\n" + err.message);
        console.error(err);
    }
});

// ==========================================
// 可拖曳分隔線功能
// ==========================================
function initResizer() {
    const resizer = document.getElementById('resizer');
    const container = document.querySelector('.evaluation-container');
    const inputPanel = document.getElementById('inputPanel');

    if (!resizer || !container || !inputPanel) return;

    let isResizing = false;
    let startX, startWidth;

    resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        startX = e.clientX;
        startWidth = inputPanel.offsetWidth;

        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';

        e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;

        const diff = e.clientX - startX;
        let newWidth = startWidth + diff;

        // 限制最小和最大寬度
        newWidth = Math.max(280, Math.min(600, newWidth));

        container.style.gridTemplateColumns = newWidth + 'px 8px 1fr';
    });

    document.addEventListener('mouseup', function() {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });

    // 觸控裝置支援
    resizer.addEventListener('touchstart', function(e) {
        isResizing = true;
        startX = e.touches[0].clientX;
        startWidth = inputPanel.offsetWidth;
        e.preventDefault();
    });

    document.addEventListener('touchmove', function(e) {
        if (!isResizing) return;

        const diff = e.touches[0].clientX - startX;
        let newWidth = startWidth + diff;
        newWidth = Math.max(280, Math.min(600, newWidth));

        container.style.gridTemplateColumns = newWidth + 'px 8px 1fr';
    });

    document.addEventListener('touchend', function() {
        isResizing = false;
    });
}

// ==========================================
// v3.69 閃電帶入功能 - 承銷中案件資料（含狀態判斷）
// v3.72 修改：改為從06工作表動態載入
// v3.94 修改：重新分組邏輯
//   - 即將競拍/詢圈：有時程且時程 >= 今天（尚未完成）
//   - 承銷中：尚未確定時程
// v3.93 優化閃電帶入功能
// 分組：
//   - 即將競拍/詢圈：有時程且未完成
//   - 承銷中：尚未確定時程
// ==========================================
let pendingCases = [];
let recentCompletedCases = []; // v3.93 新增：近期完成案例

// 初始化閃電帶入選單（按狀態分組）
function initQuickSelect() {
    const select = document.getElementById('quickSelect');
    const upcomingAuctionGroup = document.getElementById('upcomingAuctionGroup');
    const upcomingInquiryGroup = document.getElementById('upcomingInquiryGroup');
    const pendingAuctionGroup = document.getElementById('pendingAuctionGroup');
    const pendingInquiryGroup = document.getElementById('pendingInquiryGroup');
    const recentAuctionGroup = document.getElementById('recentAuctionGroup');
    const recentInquiryGroup = document.getElementById('recentInquiryGroup');

    if (!select) return;

    // 清空各分組
    if (upcomingAuctionGroup) upcomingAuctionGroup.innerHTML = '';
    if (upcomingInquiryGroup) upcomingInquiryGroup.innerHTML = '';
    if (pendingAuctionGroup) pendingAuctionGroup.innerHTML = '';
    if (pendingInquiryGroup) pendingInquiryGroup.innerHTML = '';
    if (recentAuctionGroup) recentAuctionGroup.innerHTML = '';
    if (recentInquiryGroup) recentInquiryGroup.innerHTML = '';

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const currentYear = today.getFullYear();

    // v3.97 修正：輔助函數 - 解析投標期間並判斷是否已完成
    function parseBidPeriodAndCheck(bidPeriodStr) {
        if (!bidPeriodStr || bidPeriodStr === '未定' || bidPeriodStr.includes('未定')) {
            return { hasSchedule: false, isCompleted: false };
        }

        // 解析結束日期，格式如 "11/25-11/27" 或 "12/17-12/19"
        const parts = bidPeriodStr.split('-');
        if (parts.length >= 2) {
            const endPart = parts[1].trim();
            const match = endPart.match(/(\d+)\/(\d+)/);
            if (match) {
                const endMonth = parseInt(match[1]);
                const endDay = parseInt(match[2]);

                // 判斷年份：承銷中案件時程不會跨年太遠，視為當年度
                const endDateObj = new Date(currentYear, endMonth - 1, endDay);
                endDateObj.setHours(0, 0, 0, 0);

                const isCompleted = endDateObj < today;
                return { hasSchedule: true, isCompleted: isCompleted, endDate: endDateObj };
            }
        }

        // 有時程字串但無法解析，視為有時程但未完成
        return { hasSchedule: true, isCompleted: false };
    }

    // 1. 處理06工作表案例（pendingCases）- 分為即將進行、承銷中、近期完成
    pendingCases.forEach((c, idx) => {
        // 跳過已掛牌的
        if (c.status === 'listed') return;

        const option = document.createElement('option');
        option.value = 'pending_' + idx;

        // v3.97 修正：使用輔助函數判斷時程狀態
        const scheduleStatus = parseBidPeriodAndCheck(c.bidPeriod);
        const hasSchedule = scheduleStatus.hasSchedule;
        const isCompleted = scheduleStatus.isCompleted;

        // 準備顯示內容
        let priceLabel = '';
        if (c.auctionType === '競拍') {
            if (c.isPriceRange) {
                priceLabel = `底標${Math.round(c.floorPrice)}~${Math.round(c.highPrice)}`;
            } else {
                priceLabel = `底標${Math.round(c.floorPrice)}`;
            }
        } else {
            // 詢圈顯示承銷價
            if (c.floorPrice && c.floorPrice !== 100) {
                priceLabel = `承銷${Math.round(c.floorPrice)}`;
            } else {
                priceLabel = '承銷價待定';
            }
        }

        const convInfo = c.convPrice > 0 ? ` | 轉${c.convPrice}` : '';
        const scheduleInfo = c.bidPeriod ? ` | ${c.bidPeriod}` : '';

        // v3.97 修正：使用includes判斷競拍/詢圈
        const isAuction = c.auctionType && (c.auctionType.includes('競拍') || c.auctionType === '競拍');
        const isInquiry = c.auctionType && (c.auctionType.includes('詢圈') || c.auctionType === '詢圈');

        if (isAuction) {
            if (isCompleted) {
                // ✅ 已完成競拍 → 放到「近期完成競拍」分組
                option.textContent = `✅ ${c.cbName} | ${c.industry} | ${priceLabel}${convInfo}${scheduleInfo}`;
                if (recentAuctionGroup) recentAuctionGroup.appendChild(option);
            } else if (hasSchedule) {
                // 🔥 即將競拍
                option.textContent = `🔥 ${c.cbName} | ${c.industry} | ${priceLabel}${convInfo}${scheduleInfo}`;
                if (upcomingAuctionGroup) upcomingAuctionGroup.appendChild(option);
            } else {
                // ⏳ 承銷中-競拍（尚未確定時程）
                option.textContent = `⏳ ${c.cbName} | ${c.industry} | ${priceLabel}${convInfo}`;
                if (pendingAuctionGroup) pendingAuctionGroup.appendChild(option);
            }
        } else if (isInquiry) {
            // 詢圈
            if (isCompleted) {
                // ✅ 已完成詢圈 → 放到「近期完成詢圈」分組
                option.textContent = `✅ ${c.cbName} | ${c.industry} | ${c.guarantee || '-'}${scheduleInfo}`;
                if (recentInquiryGroup) recentInquiryGroup.appendChild(option);
            } else if (hasSchedule) {
                // 📋 即將詢圈
                option.textContent = `📋 ${c.cbName} | ${c.industry} | ${c.guarantee || '-'}${scheduleInfo}`;
                if (upcomingInquiryGroup) upcomingInquiryGroup.appendChild(option);
            } else {
                // ⏳ 承銷中-詢圈（尚未確定時程）
                option.textContent = `⏳ ${c.cbName} | ${c.industry} | ${c.guarantee || '-'}`;
                if (pendingInquiryGroup) pendingInquiryGroup.appendChild(option);
            }
        } else {
            // 未設定類型的，預設放到競拍承銷中
            option.textContent = `⏳ ${c.cbName} | ${c.industry} | ${priceLabel}${convInfo}`;
            if (pendingAuctionGroup) pendingAuctionGroup.appendChild(option);
        }
    });

    // 監聯選擇事件
    select.addEventListener('change', handleQuickSelect);
}

// 處理閃電帶入選擇
// v3.93 修改：支援pending_X和recent_X兩種格式
function handleQuickSelect() {
    const select = document.getElementById('quickSelect');
    const infoDiv = document.getElementById('quickSelectInfo');
    const compareDiv = document.getElementById('modelCompareResult');
    const val = select.value;

    if (val === '' || val === null) {
        infoDiv.style.display = 'none';
        if (compareDiv) compareDiv.style.display = 'none';
        return;
    }

    let c = null;
    let isRecentCase = false;

    // 判斷是pending還是recent案例
    if (val.startsWith('pending_')) {
        const idx = parseInt(val.replace('pending_', ''));
        c = pendingCases[idx];
    } else if (val.startsWith('recent_')) {
        const idx = parseInt(val.replace('recent_', ''));
        c = recentCompletedCases[idx];
        isRecentCase = true;
    } else {
        // 兼容舊格式
        c = pendingCases[parseInt(val)];
    }

    if (!c) return;

    // v3.97y: 保存完整標的資訊供結果標題使用
    window.currentCBCode = c.cbCode || '';
    window.currentCBName = c.cbName || '';
    console.log('⚡ 閃電帶入標的:', window.currentCBCode, window.currentCBName);

    // 帶入各欄位
    // v3.74 修正：只帶入股票代號，這樣可以搜尋該公司所有歷史競拍/詢圈紀錄
    document.getElementById('cbName').value = c.stockCode || c.cbCode || '';

    // 股本區間
    if (c.capitalRange) {
        document.getElementById('capital').value = c.capitalRange;
    } else if (c.capital > 0) {
        // 從capital計算區間
        const cap = c.capital;
        let capRange = '';
        if (cap < 3) capRange = '小於3億';
        else if (cap < 6) capRange = '3~6億';
        else if (cap < 10) capRange = '6~10億';
        else if (cap < 15) capRange = '10~15億';
        else if (cap < 20) capRange = '15~20億';
        else capRange = '大於20億';
        document.getElementById('capital').value = capRange;
    }

    // 產業分類
    const industrySelect = document.getElementById('industry');
    if (c.industry) {
        let found = false;
        for (let opt of industrySelect.options) {
            if (opt.value === c.industry || opt.textContent.includes(c.industry)) {
                industrySelect.value = opt.value;
                found = true;
                break;
            }
        }
        if (!found) {
            const newOpt = document.createElement('option');
            newOpt.value = c.industry;
            newOpt.textContent = c.industry;
            industrySelect.appendChild(newOpt);
            industrySelect.value = c.industry;
        }
    }

    // 發行券商
    const brokerSelect = document.getElementById('broker');
    if (c.broker) {
        let found = false;
        for (let opt of brokerSelect.options) {
            if (opt.value === c.broker || opt.textContent.includes(c.broker)) {
                brokerSelect.value = opt.value;
                found = true;
                break;
            }
        }
        if (!found && c.broker) {
            const newOpt = document.createElement('option');
            newOpt.value = c.broker;
            newOpt.textContent = c.broker;
            brokerSelect.appendChild(newOpt);
            brokerSelect.value = c.broker;
        }
    }

    // 發行規模區間
    // v3.97w: 同時存實際數字供 Step 4 使用
    if (c.issueSize > 0) {
        window.currentActualIssueSize = c.issueSize;
        console.log('⚡ 閃電帶入實際規模:', c.issueSize, '億');
    }
    if (c.sizeRange) {
        document.getElementById('issueSize').value = c.sizeRange;
    } else if (c.issueSize > 0) {
        const size = c.issueSize;
        let sizeRange = '';
        if (size < 2) sizeRange = '小於2億';
        else if (size < 5) sizeRange = '2~5億';
        else if (size < 10) sizeRange = '5~10億';
        else if (size < 15) sizeRange = '10~15億';
        else if (size < 20) sizeRange = '15~20億';
        else sizeRange = '大於20億';
        document.getElementById('issueSize').value = sizeRange;
    }

    // v3.81 改進：有股價/轉換價才計算理論價，沒有就留空讓用戶輸入
    if (c.theoRange) {
        // 如果caseObj已有theoRange，直接使用
        document.getElementById('theoRange').value = c.theoRange;
    } else if (c.auctionType !== '詢圈' && c.stockPrice > 0 && c.convPrice > 0) {
        // 只有競拍案例才從股價和轉換價計算理論價
        const theoPrice = (c.stockPrice / c.convPrice) * 100;
        let theoRange = '';
        if (theoPrice < 90) theoRange = '小於90元';
        else if (theoPrice < 95) theoRange = '90~95元';
        else if (theoPrice < 100) theoRange = '95~100元';
        else if (theoPrice < 105) theoRange = '100~105元';
        else if (theoPrice < 110) theoRange = '105~110元';
        else if (theoPrice < 115) theoRange = '110~115元';
        else theoRange = '大於115元';
        document.getElementById('theoRange').value = theoRange;
    }
    // 詢圈案例不自動帶入理論價區間

    // 發行年期
    if (c.years) document.getElementById('years').value = c.years;

    // 擔保情況
    if (c.guarantee) document.getElementById('guarantee').value = c.guarantee;

    // 信用評等
    if (c.rating) document.getElementById('rating').value = c.rating;

    // 底標價格 - 只有競拍案例才帶入
    if (c.auctionType !== '詢圈' && c.floorPrice) {
        document.getElementById('floorPrice').value = Math.round(c.floorPrice);
    }

    // 股價 - 只有競拍案例才帶入
    if (c.auctionType !== '詢圈' && c.stockPrice > 0) {
        document.getElementById('stockPrice').value = c.stockPrice;
    }

    // 實際轉換價格 - 只有競拍案例才帶入
    if (c.auctionType !== '詢圈' && c.convPrice > 0) {
        document.getElementById('actualConversionPrice').value = c.convPrice;
    }

    // 狀態標籤 - 區分競拍和詢圈
    const auctionStatusInfo = {
        'pending': {label: '⏳ 尚未公告投標日期', color: '#9e9e9e'},
        'bidding': {label: '🔥 投標進行中', color: '#ff5722'},
        'closed': {label: '⏱️ 已截標待開標', color: '#ff9800'},
        'opened': {label: '📊 已開標未掛牌', color: '#4caf50'},
        'listed': {label: '✅ 已掛牌', color: '#2196f3'},
        'completed': {label: '✅ 已完成', color: '#4caf50'}
    };

    const inquiryStatusInfo = {
        'pending': {label: '⏳ 尚未公告詢圈日期', color: '#9e9e9e'},
        'bidding': {label: '📋 詢圈進行中', color: '#1976d2'},
        'closed': {label: '⏱️ 詢圈結束待定價', color: '#ff9800'},
        'opened': {label: '📊 已定價未掛牌', color: '#4caf50'},
        'listed': {label: '✅ 已掛牌', color: '#2196f3'},
        'completed': {label: '✅ 已完成', color: '#4caf50'}
    };

    const statusInfo = c.auctionType === '詢圈' ? inquiryStatusInfo : auctionStatusInfo;
    const status = statusInfo[c.status] || {label: '未知', color: '#666'};
    const theoPrice = c.convPrice > 0 && c.stockPrice > 0 ? ((c.stockPrice / c.convPrice) * 100).toFixed(2) : '待計算';
    const priceDisplay = c.isPriceRange ? `${Math.round(c.floorPrice)}~${Math.round(c.highPrice)}` : Math.round(c.floorPrice);

    // 基本資訊 - 根據案例類型顯示不同內容
    if (isRecentCase) {
        // 已完成案例的顯示
        const marketInfo = (c.marketHigh > 0 && c.marketLow > 0)
            ? `掛牌高: <b style="color:#2e7d32;">${safeFixed(c.marketHigh, 1)}</b> | 掛牌低: <b style="color:#c62828;">${safeFixed(c.marketLow, 1)}</b> | 振幅: <b style="color:#E91E63;">${(((c.marketHigh - c.marketLow) / c.marketLow) * 100).toFixed(1)}%</b>`
            : '';

        if (c.auctionType === '競拍') {
            // 競拍案例顯示得標資訊
            const bidInfo = c.minBidPrice > 0
                ? `最低得標: <b>${safeFixed(c.minBidPrice, 2)}</b> | 加權均價: <b>${safeFixed(c.avgBidPrice, 2)}</b>`
                : '';

            infoDiv.innerHTML = `
                <div style="font-weight:bold; color:#2e7d32; margin-bottom:5px;">✅ 已帶入「${c.cbName}」競拍歷史資料</div>
                <div style="display:inline-block; padding:2px 8px; border-radius:4px; background:#9c27b0; color:#fff; font-size:12px; margin-bottom:5px;">競拍</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; font-size:13px;">
                    <span>🏭 ${c.industry}</span>
                    <span>💰 ${c.issueSize > 0 ? c.issueSize + '億' : '-'}</span>
                    ${c.convPrice > 0 ? `<span>🎯 轉換價${c.convPrice}</span>` : ''}
                    <span>📋 ${c.guarantee || '-'}</span>
                </div>
                ${bidInfo ? `<div style="margin-top:5px; color:#9c27b0; font-size:13px;">🎯 ${bidInfo}</div>` : ''}
                ${marketInfo ? `<div style="margin-top:5px; color:#1565c0; font-size:13px;">📊 ${marketInfo}</div>` : ''}
                <div style="margin-top:5px; color:#795548; font-size:12px;">
                    💡 此為已完成競拍案例，可作為類似案件參考
                </div>
            `;
        } else {
            // 詢圈案例只顯示掛牌表現
            infoDiv.innerHTML = `
                <div style="font-weight:bold; color:#1976d2; margin-bottom:5px;">✅ 已帶入「${c.cbName}」詢圈歷史資料</div>
                <div style="display:inline-block; padding:2px 8px; border-radius:4px; background:#1976d2; color:#fff; font-size:12px; margin-bottom:5px;">詢圈</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; font-size:13px;">
                    <span>🏭 ${c.industry}</span>
                    <span>💰 ${c.issueSize > 0 ? c.issueSize + '億' : '-'}</span>
                    <span>📋 ${c.guarantee || '-'}</span>
                    <span>📅 ${c.years || 3}年期</span>
                </div>
                ${marketInfo ? `<div style="margin-top:5px; color:#1565c0; font-size:13px;">📊 ${marketInfo}</div>` : ''}
                <div style="margin-top:5px; color:#795548; font-size:12px;">
                    💡 此為已完成詢圈案例，以掛牌表現作為參考
                </div>
            `;
        }
    } else {
        // 即將進行案例的顯示
        if (c.auctionType === '競拍') {
            // 競拍案例顯示完整資訊
            infoDiv.innerHTML = `
                <div style="font-weight:bold; color:#e65100; margin-bottom:5px;">✅ 已帶入「${c.cbName}」競拍資料</div>
                <div style="display:inline-block; padding:2px 8px; border-radius:4px; background:${status.color}; color:#fff; font-size:12px; margin-bottom:5px;">${status.label}</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; font-size:13px;">
                    <span>🏭 ${c.industry}</span>
                    <span>💰 規模${c.issueSize}億</span>
                    <span>📈 股本${(c.capital || 0).toFixed(2)}億</span>
                    ${c.convPrice > 0 ? `<span>🎯 轉換價${c.convPrice}</span>` : ''}
                    <span>⭐ TCRI${c.rating || '未知'}</span>
                </div>
                <div style="margin-top:5px; color:#1565c0; font-size:13px;">
                    📌 參考股價：<b>${c.stockPrice}</b> 元 | 底標：<b>${priceDisplay}</b> 元
                    ${c.convPrice > 0 ? `| 理論價約：<b>${theoPrice}</b> 元` : ''}
                </div>
                ${c.bidPeriod ? `<div style="margin-top:3px; color:#666; font-size:12px;">📅 投標期間：${c.bidPeriod} | 開標：${c.openDate} ${c.listingDate ? `| 掛牌：${c.listingDate}` : ''}</div>` : ''}
                <div style="margin-top:5px; color:#795548; font-size:12px;">
                    ⚠️ 股價為參考值，請於截標日13:30前確認最新收盤價
                </div>
            `;
        } else {
            // 詢圈案例顯示簡化資訊
            infoDiv.innerHTML = `
                <div style="font-weight:bold; color:#1976d2; margin-bottom:5px;">✅ 已帶入「${c.cbName}」詢圈資料</div>
                <div style="display:inline-block; padding:2px 8px; border-radius:4px; background:${status.color}; color:#fff; font-size:12px; margin-bottom:5px;">${status.label}</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; font-size:13px;">
                    <span>🏭 ${c.industry}</span>
                    <span>💰 規模${c.issueSize}億</span>
                    <span>📈 股本${(c.capital || 0).toFixed(2)}億</span>
                    <span>📋 ${c.guarantee || '-'}</span>
                    <span>📅 ${c.years || 3}年期</span>
                </div>
                ${c.floorPrice && c.floorPrice !== 100 ? `<div style="margin-top:5px; color:#1565c0; font-size:13px;">📌 承銷價：<b>${priceDisplay}</b> 元</div>` : ''}
                ${c.bidPeriod ? `<div style="margin-top:3px; color:#666; font-size:12px;">📅 詢圈期間：${c.bidPeriod} ${c.listingDate ? `| 預計掛牌：${c.listingDate}` : ''}</div>` : ''}
                <div style="margin-top:5px; color:#795548; font-size:12px;">
                    💡 詢圈完成後1-4日內將決定轉換價格
                </div>
            `;
        }
    }
    infoDiv.style.display = 'block';

    // v3.94 重寫：根據競拍/詢圈分別處理
    if (c.auctionType === '詢圈') {
        // === 詢圈案例：顯示歷史發行條件分析（掛牌表現統計）===
        if (compareDiv) {
            // 計算各條件的詢圈掛牌統計
            const inquiryStats = calculateInquiryConditionStats(c);

            if (inquiryStats) {
                let statsHtml = `
                    <div style="font-weight:bold; color:#1976d2; margin-bottom:10px; font-size:14px;">📊 歷史發行條件分析（詢圈掛牌表現）</div>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <tr style="background:#e3f2fd;">
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:left;">條件</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">篩選值</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">樣本數</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">平均高</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">平均低</th>
                            <th style="padding:6px; border:1px solid #bbdefb; text-align:center;">平均振幅</th>
                        </tr>`;

                inquiryStats.conditions.forEach(cond => {
                    if (cond.count > 0) {
                        statsHtml += `
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">${cond.name}</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:#1565c0;">${cond.value}</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">${cond.count}檔</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:#2e7d32; font-weight:bold;">${safeFixed(cond.avgHigh, 1)}</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:#c62828; font-weight:bold;">${safeFixed(cond.avgLow, 1)}</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:#E91E63; font-weight:bold;">${safeFixed(cond.avgAmp, 1)}%</td>
                        </tr>`;
                    }
                });

                // 綜合統計
                if (inquiryStats.overall.count > 0) {
                    statsHtml += `
                        <tr style="background:#fff3e0;">
                            <td style="padding:6px; border:1px solid #e0e0e0; font-weight:bold;" colspan="2">全部詢圈平均</td>
                            <td style="padding:6px; border:1px solid #e0e0e0; text-align:center; font-weight:bold;">${inquiryStats.overall.count}檔</td>
                            <td style="padding:6px; border:1px solid #e0e0e0; text-align:center; color:#2e7d32; font-weight:bold;">${safeFixed(inquiryStats.overall.avgHigh, 1)}</td>
                            <td style="padding:6px; border:1px solid #e0e0e0; text-align:center; color:#c62828; font-weight:bold;">${safeFixed(inquiryStats.overall.avgLow, 1)}</td>
                            <td style="padding:6px; border:1px solid #e0e0e0; text-align:center; color:#E91E63; font-weight:bold;">${safeFixed(inquiryStats.overall.avgAmp, 1)}%</td>
                        </tr>`;
                }

                statsHtml += `</table>`;

                // 如果有當前案例的掛牌表現，也顯示
                if (c.marketHigh > 0 && c.marketLow > 0) {
                    const caseAmp = ((c.marketHigh - c.marketLow) / c.marketLow * 100);
                    statsHtml += `
                        <div style="margin-top:10px; padding:10px; background:#e8f5e9; border-radius:6px;">
                            <div style="font-weight:bold; color:#2e7d32; margin-bottom:5px;">📌 此案例實際表現</div>
                            <div style="display:flex; gap:20px; font-size:14px;">
                                <span>掛牌最高: <b style="color:#2e7d32;">${safeFixed(c.marketHigh, 1)}</b></span>
                                <span>掛牌最低: <b style="color:#c62828;">${safeFixed(c.marketLow, 1)}</b></span>
                                <span>振幅: <b style="color:#E91E63;">${safeFixed(caseAmp, 1)}%</b></span>
                            </div>
                        </div>`;
                }

                statsHtml += `
                    <div style="margin-top:8px; font-size:12px; color:#666;">
                        💡 詢圈案例以掛牌表現為參考依據，各條件篩選可幫助評估類似案例表現
                    </div>`;

                compareDiv.innerHTML = statsHtml;
                compareDiv.style.display = 'block';
            } else {
                compareDiv.innerHTML = `
                    <div style="padding:10px; background:#fff3e0; border-radius:6px;">
                        <div style="color:#e65100;">⚠️ 尚無足夠詢圈歷史數據進行分析</div>
                    </div>`;
                compareDiv.style.display = 'block';
            }
        }

        // 詢圈案例只觸發條件欄位的change事件（不觸發競拍相關）
        ['capital', 'industry', 'issueSize', 'years', 'guarantee', 'rating', 'broker'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.dispatchEvent(new Event('change'));
        });

        // 詢圈案例：清空AI評估區域，顯示詢圈專用提示
        setTimeout(() => {
            const evalContainer = document.getElementById('auctionEvaluation');
            if (evalContainer) {
                evalContainer.innerHTML = `
                    <div style="padding:15px; background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius:10px; border:2px solid #1976d2;">
                        <div style="font-weight:bold; color:#1565c0; margin-bottom:10px; font-size:15px;">📋 詢圈案例說明</div>
                        <div style="font-size:13px; color:#444; line-height:1.7;">
                            此為<b>詢圈</b>發行案例，與競拍機制不同：<br>
                            • 詢圈無底標價格，由承銷商向法人詢價<br>
                            • 詢圈完成後1-4日內決定轉換價格<br>
                            • 參考指標以<b>掛牌表現</b>（高/低/振幅）為主<br><br>
                            上方「歷史發行條件分析」已依據選取條件，<br>
                            統計相似詢圈案例的掛牌表現供參考。
                        </div>
                    </div>`;
            }

            // 清空即時預測區
            const liveContainer = document.getElementById('liveAIPrediction');
            if (liveContainer) {
                liveContainer.innerHTML = `
                    <div style="padding:10px; text-align:center; color:#1976d2;">
                        📋 詢圈案例請參考上方「歷史發行條件分析」
                    </div>`;
            }
        }, 100);

    } else {
        // === 競拍案例：原有邏輯 ===
        if (compareDiv && (c.status === 'opened' || c.status === 'listed' || c.status === 'completed')) {
            const theoVal = c.convPrice > 0 && c.stockPrice > 0 ? (c.stockPrice / c.convPrice) * 100 : 0;

            // 檢查是否有實際競拍結果
            const actualMinBid = c.actualMinBid || c.minBidPrice || 0;
            const actualAvgBid = c.actualAvgBid || c.avgBidPrice || 0;
            const hasActualResult = actualMinBid > 0 || actualAvgBid > 0;

            if (hasActualResult) {
                const ds = window.DYNAMIC_STATS || {};
                const modelEstMinBid = ds.avgMinBid || 106.10;
                const modelEstAvgBid = ds.avgBid || 107.92;

                const minBidError = actualMinBid > 0 ? (actualMinBid - modelEstMinBid).toFixed(2) : '-';
                const avgBidError = actualAvgBid > 0 ? (actualAvgBid - modelEstAvgBid).toFixed(2) : '-';

                compareDiv.innerHTML = `
                    <div style="font-weight:bold; color:#2e7d32; margin-bottom:8px;">📊 競拍結果 vs 模型預估比對</div>
                    <table style="width:100%; border-collapse:collapse; font-size:13px;">
                        <tr style="background:#e8f5e9;">
                            <th style="padding:6px; border:1px solid #c8e6c9; text-align:left;">指標</th>
                            <th style="padding:6px; border:1px solid #c8e6c9; text-align:center;">實際結果</th>
                            <th style="padding:6px; border:1px solid #c8e6c9; text-align:center;">模型預估</th>
                            <th style="padding:6px; border:1px solid #c8e6c9; text-align:center;">誤差</th>
                        </tr>
                        ${actualMinBid > 0 ? `
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">最低得標價</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; font-weight:bold; color:#1565c0;">${actualMinBid.toFixed(2)}元</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">${modelEstMinBid.toFixed(2)}元</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:${parseFloat(minBidError) > 0 ? '#e65100' : '#2e7d32'};">${minBidError}元</td>
                        </tr>` : ''}
                        ${actualAvgBid > 0 ? `
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">加權均價</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; font-weight:bold; color:#1565c0;">${actualAvgBid.toFixed(2)}元</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">${modelEstAvgBid.toFixed(2)}元</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; color:${parseFloat(avgBidError) > 0 ? '#e65100' : '#2e7d32'};">${avgBidError}元</td>
                        </tr>` : ''}
                        ${theoVal > 0 ? `
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">理論價</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">${theoVal.toFixed(2)}元</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">-</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">-</td>
                        </tr>
                        <tr>
                            <td style="padding:5px; border:1px solid #e0e0e0;">實際溢價率</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center; font-weight:bold; color:#e65100;">${actualMinBid > 0 ? ((actualMinBid/theoVal - 1) * 100).toFixed(2) : '-'}%</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">-</td>
                            <td style="padding:5px; border:1px solid #e0e0e0; text-align:center;">-</td>
                        </tr>` : ''}
                    </table>
                    <div style="margin-top:8px; font-size:12px; color:#666;">
                        💡 模型預估基於${ds.count || '--'}檔歷史平均值，選擇條件後可獲得專屬預估
                    </div>
                `;
                compareDiv.style.display = 'block';
            } else {
                compareDiv.style.display = 'none';
            }
        } else {
            if (compareDiv) compareDiv.style.display = 'none';
        }

        // 競拍案例：觸發所有欄位事件
        ['capital', 'industry', 'issueSize', 'theoRange', 'years', 'guarantee', 'rating', 'broker'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.dispatchEvent(new Event('change'));
        });

        ['stockPrice', 'actualConversionPrice', 'floorPrice'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.dispatchEvent(new Event('input'));
        });

        // 競拍案例：觸發AI評估
        setTimeout(() => {
            if (typeof updateAuctionEvaluation === 'function') {
                updateAuctionEvaluation();
            }
        }, 100);
    }

    // 觸發 cbName 的 input 事件，顯示歷史資料卡
    const cbNameEl = document.getElementById('cbName');
    if (cbNameEl) {
        cbNameEl.dispatchEvent(new Event('input'));
    }
}

// v3.94 新增：計算詢圈條件統計
function calculateInquiryConditionStats(caseData) {
    if (!window.inquiryRawData || inquiryRawData.length === 0) {
        return null;
    }

    const conditions = [];

    // 篩選有掛牌數據的詢圈案例
    const validInquiries = inquiryRawData.filter(d => d.marketHigh > 0 && d.marketLow > 0);
    if (validInquiries.length === 0) return null;

    // 計算全部平均
    const overallStats = calculateInquiryAvg(validInquiries);

    // 1. 產業篩選
    if (caseData.industry) {
        const industryFiltered = validInquiries.filter(d => d.industry === caseData.industry);
        if (industryFiltered.length > 0) {
            const stats = calculateInquiryAvg(industryFiltered);
            conditions.push({
                name: '產業',
                value: caseData.industry,
                count: industryFiltered.length,
                avgHigh: stats.avgHigh,
                avgLow: stats.avgLow,
                avgAmp: stats.avgAmp
            });
        }
    }

    // 2. 擔保篩選
    if (caseData.guarantee) {
        const guaranteeVal = caseData.guarantee.includes('有') ? '有擔保' : '無擔保';
        const guaranteeFiltered = validInquiries.filter(d => {
            const g = d.guarantee || '';
            return guaranteeVal === '有擔保' ? g.includes('有') : g.includes('無');
        });
        if (guaranteeFiltered.length > 0) {
            const stats = calculateInquiryAvg(guaranteeFiltered);
            conditions.push({
                name: '擔保',
                value: guaranteeVal,
                count: guaranteeFiltered.length,
                avgHigh: stats.avgHigh,
                avgLow: stats.avgLow,
                avgAmp: stats.avgAmp
            });
        }
    }

    // 3. 發行規模篩選
    if (caseData.issueSize > 0) {
        const size = caseData.issueSize;
        let sizeRange = '';
        let filterFn = null;
        if (size < 2) { sizeRange = '小於2億'; filterFn = d => d.issueSize < 2; }
        else if (size < 5) { sizeRange = '2~5億'; filterFn = d => d.issueSize >= 2 && d.issueSize < 5; }
        else if (size < 10) { sizeRange = '5~10億'; filterFn = d => d.issueSize >= 5 && d.issueSize < 10; }
        else if (size < 15) { sizeRange = '10~15億'; filterFn = d => d.issueSize >= 10 && d.issueSize < 15; }
        else if (size < 20) { sizeRange = '15~20億'; filterFn = d => d.issueSize >= 15 && d.issueSize < 20; }
        else { sizeRange = '大於20億'; filterFn = d => d.issueSize >= 20; }

        if (filterFn) {
            const sizeFiltered = validInquiries.filter(filterFn);
            if (sizeFiltered.length > 0) {
                const stats = calculateInquiryAvg(sizeFiltered);
                conditions.push({
                    name: '發行規模',
                    value: sizeRange,
                    count: sizeFiltered.length,
                    avgHigh: stats.avgHigh,
                    avgLow: stats.avgLow,
                    avgAmp: stats.avgAmp
                });
            }
        }
    }

    // 4. 年期篩選
    if (caseData.years) {
        const yearsFiltered = validInquiries.filter(d => d.years == caseData.years);
        if (yearsFiltered.length > 0) {
            const stats = calculateInquiryAvg(yearsFiltered);
            conditions.push({
                name: '年期',
                value: caseData.years + '年',
                count: yearsFiltered.length,
                avgHigh: stats.avgHigh,
                avgLow: stats.avgLow,
                avgAmp: stats.avgAmp
            });
        }
    }

    // 5. 券商篩選
    if (caseData.broker) {
        const brokerFiltered = validInquiries.filter(d => d.broker === caseData.broker);
        if (brokerFiltered.length > 0) {
            const stats = calculateInquiryAvg(brokerFiltered);
            conditions.push({
                name: '承銷商',
                value: caseData.broker,
                count: brokerFiltered.length,
                avgHigh: stats.avgHigh,
                avgLow: stats.avgLow,
                avgAmp: stats.avgAmp
            });
        }
    }

    return {
        conditions: conditions,
        overall: overallStats
    };
}

// v3.94 新增：計算詢圈掛牌平均值
function calculateInquiryAvg(dataArray) {
    if (!dataArray || dataArray.length === 0) {
        return { count: 0, avgHigh: 0, avgLow: 0, avgAmp: 0 };
    }

    let sumHigh = 0, sumLow = 0, sumAmp = 0, count = 0;

    dataArray.forEach(d => {
        if (d.marketHigh > 0 && d.marketLow > 0) {
            sumHigh += d.marketHigh;
            sumLow += d.marketLow;
            sumAmp += ((d.marketHigh - d.marketLow) / d.marketLow * 100);
            count++;
        }
    });

    return {
        count: count,
        avgHigh: count > 0 ? sumHigh / count : 0,
        avgLow: count > 0 ? sumLow / count : 0,
        avgAmp: count > 0 ? sumAmp / count : 0
    };
}

// ==========================================
// v3.70 回測分析功能模組
// ==========================================

/**
 * 從區間字串提取中間值（全局版本）
 */
function getRangeMidValue(rangeStr, type) {
    if (typeof rangeStr === 'number' && !isNaN(rangeStr)) return rangeStr;
    const str = String(rangeStr || '');
    // 轉換價區間
    if (type === 'conversion') {
        if (str.includes('小於20')) return 15;
        if (str.includes('20~50')) return 35;
        if (str.includes('50~100')) return 75;
        if (str.includes('100~150')) return 125;
        if (str.includes('150~200')) return 175;
        if (str.includes('大於200')) return 250;
    }
    // v3.72 新增：理論價區間
    if (type === 'theoRange') {
        if (str.includes('小於90')) return 85;
        if (str.includes('90~95')) return 92.5;
        if (str.includes('95~100')) return 97.5;
        if (str.includes('100~105')) return 102.5;
        if (str.includes('105~110')) return 107.5;
        if (str.includes('110~115')) return 112.5;
        if (str.includes('大於115')) return 120;
    }
    // 股本區間
    if (type === 'capital') {
        if (str.includes('小於3')) return 2;
        if (str.includes('3~6')) return 4.5;
        if (str.includes('6~10')) return 8;
        if (str.includes('10~15')) return 12.5;
        if (str.includes('15~20')) return 17.5;
        if (str.includes('大於20')) return 30;
    }
    // 發行規模區間
    if (type === 'size') {
        if (str.includes('小於2')) return 1.5;
        if (str.includes('2~5')) return 3.5;
        if (str.includes('5~10')) return 7.5;
        if (str.includes('10~15')) return 12.5;
        if (str.includes('15~20')) return 17.5;
        if (str.includes('大於20')) return 30;
    }
    // 嘗試解析為數字
    const num = parseFloat(str);
    return isNaN(num) ? 0 : num;
}

/**
 * 計算近N檔競拍的市場氛圍
 * @param {number} n - 要計算的近期案例數量（預設5）
 * @returns {Object|null} 市場氛圍數據
 */
function calcMarketAtmosphere(n = 5, guarantee = null) {
    if (!auctionRawData || auctionRawData.length === 0) return null;

    // v3.81 修改：先按擔保類型篩選，再排序
    let filteredData = [...auctionRawData]
        .filter(d => d.openDate && d.avgPremium !== null && d.avgPremium !== undefined && d.bidMultiple > 0);

    // 如果指定擔保類型，篩選同類型
    if (guarantee) {
        filteredData = filteredData.filter(d => d.guarantee === guarantee);
    }

    const sortedData = filteredData.sort((a, b) => {
            // v3.90 修正：正確解析日期字串（格式：YYYY/MM/DD）
            const parseDate = (dateStr) => {
                if (!dateStr || dateStr === '-') return new Date(0);
                if (typeof dateStr === 'number') {
                    // Excel serial number
                    return new Date((dateStr - 25569) * 86400 * 1000);
                }
                // 字串格式：YYYY/MM/DD 或 YYYY-MM-DD
                const parts = String(dateStr).split(/[\/\-]/);
                if (parts.length >= 3) {
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
                return new Date(dateStr);
            };
            const dateA = parseDate(a.openDate);
            const dateB = parseDate(b.openDate);
            return dateB - dateA;  // 降序：最新的在前
        });

    if (sortedData.length === 0) return null;

    // v3.81 重大改進：3、6、9檔加權計算（權重5、3、2）
    // 分別計算最低溢價和平均溢價
    const recent3 = sortedData.slice(0, Math.min(3, sortedData.length));
    const recent6 = sortedData.slice(0, Math.min(6, sortedData.length));
    const recent9 = sortedData.slice(0, Math.min(9, sortedData.length));

    // 計算各區間的平均值（最低溢價和平均溢價）
    function calcAvg(cases, field) {
        const valid = cases.filter(d => d[field] !== null && !isNaN(d[field]));
        return valid.length > 0 ? valid.reduce((s, d) => s + d[field], 0) / valid.length : 0;
    }

    // 最低溢價加權：3檔×5 + 6檔×3 + 9檔×2 / 10
    const minPrem3 = calcAvg(recent3, 'minPremium');
    const minPrem6 = calcAvg(recent6, 'minPremium');
    const minPrem9 = calcAvg(recent9, 'minPremium');
    const weightedMinPremium = (minPrem3 * 5 + minPrem6 * 3 + minPrem9 * 2) / 10;

    // 平均溢價加權：3檔×5 + 6檔×3 + 9檔×2 / 10
    const avgPrem3 = calcAvg(recent3, 'avgPremium');
    const avgPrem6 = calcAvg(recent6, 'avgPremium');
    const avgPrem9 = calcAvg(recent9, 'avgPremium');
    const weightedAvgPremium = (avgPrem3 * 5 + avgPrem6 * 3 + avgPrem9 * 2) / 10;

    // 投標倍數加權
    const mult3 = calcAvg(recent3, 'bidMultiple');
    const mult6 = calcAvg(recent6, 'bidMultiple');
    const mult9 = calcAvg(recent9, 'bidMultiple');
    const weightedMultiple = (mult3 * 5 + mult6 * 3 + mult9 * 2) / 10;

    // 取近N檔用於顯示
    const recentCases = sortedData.slice(0, Math.min(n, sortedData.length));

    // 計算氛圍指數 (0~100) - 使用加權平均溢價
    // 溢價率貢獻 (60%): 0%=30分, 5%=50分, 10%=70分, 15%+=90分
    // 投標倍數貢獻 (40%): 1x=20分, 2x=40分, 3x=60分, 4x+=80分
    let premiumScore = Math.min(90, Math.max(10, 30 + weightedAvgPremium * 4));
    let multipleScore = Math.min(80, Math.max(20, weightedMultiple * 20));
    const atmosphereIndex = Math.round(premiumScore * 0.6 + multipleScore * 0.4);

    // 判斷氛圍等級
    let level, levelColor, suggestion;
    if (atmosphereIndex >= 75) {
        level = '極熱';
        levelColor = '#d32f2f';
        suggestion = '市場競爭激烈，建議溢價率 +3~4%';
    } else if (atmosphereIndex >= 60) {
        level = '偏熱';
        levelColor = '#ff5722';
        suggestion = '市場偏熱，建議溢價率 +1~2%';
    } else if (atmosphereIndex >= 45) {
        level = '普通';
        levelColor = '#ff9800';
        suggestion = '市場正常，按歷史均值投標';
    } else if (atmosphereIndex >= 30) {
        level = '偏冷';
        levelColor = '#2196f3';
        suggestion = '市場偏冷，可考慮溢價率 -1~2%';
    } else {
        level = '極冷';
        levelColor = '#1565c0';
        suggestion = '市場冷清，可大膽降低溢價率 -2~3%';
    }

    return {
        recentCases: recentCases,
        // v3.81 新增：分開的最低溢價和平均溢價
        weightedMinPremium: weightedMinPremium,
        weightedAvgPremium: weightedAvgPremium,
        avgPremium: weightedAvgPremium,  // 向後兼容
        avgMultiple: weightedMultiple,
        // v3.81 新增：各區間原始數據
        breakdown: {
            recent3: { minPremium: minPrem3, avgPremium: avgPrem3, multiple: mult3, count: recent3.length },
            recent6: { minPremium: minPrem6, avgPremium: avgPrem6, multiple: mult6, count: recent6.length },
            recent9: { minPremium: minPrem9, avgPremium: avgPrem9, multiple: mult9, count: recent9.length }
        },
        atmosphereIndex: atmosphereIndex,
        level: level,
        levelColor: levelColor,
        suggestion: suggestion,
        caseCount: recentCases.length,
        guarantee: guarantee
    };
}

/**
 * v3.81 新增：計算產業氛圍（同產業3、6、9檔加權）
 * @param {string} industry - 產業類別
 * @param {string} guarantee - 擔保類型（可選）
 * @returns {Object} 產業氛圍結果
 */
function calcIndustryAtmosphere(industry, guarantee = null) {
    if (!auctionRawData || auctionRawData.length === 0 || !industry) return null;

    // 篩選同產業案例
    let filteredData = [...auctionRawData]
        .filter(d => d.openDate && d.avgPremium !== null && d.avgPremium !== undefined && d.bidMultiple > 0)
        .filter(d => d.industry === industry);

    // 如果指定擔保類型，再篩選
    if (guarantee) {
        filteredData = filteredData.filter(d => d.guarantee === guarantee);
    }

    const sortedData = filteredData.sort((a, b) => {
        const dateA = new Date(a.openDate);
        const dateB = new Date(b.openDate);
        return dateB - dateA;
    });

    if (sortedData.length === 0) return null;

    // 3、6、9檔加權計算（權重5、3、2）
    const recent3 = sortedData.slice(0, Math.min(3, sortedData.length));
    const recent6 = sortedData.slice(0, Math.min(6, sortedData.length));
    const recent9 = sortedData.slice(0, Math.min(9, sortedData.length));

    function calcAvg(cases, field) {
        const valid = cases.filter(d => d[field] !== null && !isNaN(d[field]));
        return valid.length > 0 ? valid.reduce((s, d) => s + d[field], 0) / valid.length : 0;
    }

    // 最低溢價加權
    const minPrem3 = calcAvg(recent3, 'minPremium');
    const minPrem6 = calcAvg(recent6, 'minPremium');
    const minPrem9 = calcAvg(recent9, 'minPremium');
    const weightedMinPremium = (minPrem3 * 5 + minPrem6 * 3 + minPrem9 * 2) / 10;

    // 平均溢價加權
    const avgPrem3 = calcAvg(recent3, 'avgPremium');
    const avgPrem6 = calcAvg(recent6, 'avgPremium');
    const avgPrem9 = calcAvg(recent9, 'avgPremium');
    const weightedAvgPremium = (avgPrem3 * 5 + avgPrem6 * 3 + avgPrem9 * 2) / 10;

    // 投標倍數加權
    const mult3 = calcAvg(recent3, 'bidMultiple');
    const mult6 = calcAvg(recent6, 'bidMultiple');
    const mult9 = calcAvg(recent9, 'bidMultiple');
    const weightedMultiple = (mult3 * 5 + mult6 * 3 + mult9 * 2) / 10;

    console.log(`📊 產業氛圍[${industry}]: 最低溢價=${weightedMinPremium.toFixed(2)}%, 平均溢價=${weightedAvgPremium.toFixed(2)}%, 倍數=${weightedMultiple.toFixed(2)}x (${sortedData.length}檔)`);

    return {
        industry: industry,
        caseCount: sortedData.length,
        weightedMinPremium: weightedMinPremium,
        weightedAvgPremium: weightedAvgPremium,
        weightedMultiple: weightedMultiple,
        breakdown: {
            recent3: { minPremium: minPrem3, avgPremium: avgPrem3, multiple: mult3, count: recent3.length },
            recent6: { minPremium: minPrem6, avgPremium: avgPrem6, multiple: mult6, count: recent6.length },
            recent9: { minPremium: minPrem9, avgPremium: avgPrem9, multiple: mult9, count: recent9.length }
        },
        recentCases: sortedData.slice(0, 5)
    };
}

/**
 * v3.81 新增：計算同期發行量（含詢圈和競拍）
 * 同期發行多 → 資金分散 → 溢價降低
 * @param {string} targetDate - 目標開標日期（YYYY-MM-DD）
 * @param {number} daysBefore - 往前算幾天（預設14天）
 * @param {number} daysAfter - 往後算幾天（預設14天）
 * @param {string} excludeCbName - 排除的CB名稱（自己）
 * @returns {Object} 同期發行分析結果
 */
function calcConcurrentIssue(targetDate, daysBefore = 14, daysAfter = 14, excludeCbName = '') {
    if (!targetDate) return null;

    const targetDateObj = new Date(targetDate);
    const startDate = new Date(targetDateObj);
    startDate.setDate(startDate.getDate() - daysBefore);
    const endDate = new Date(targetDateObj);
    endDate.setDate(endDate.getDate() + daysAfter);

    // 從pendingCases和已開標資料中找同期案件
    let concurrentCases = [];

    // 1. 從pendingCases找（尚未開標的案件）
    if (pendingCases && pendingCases.length > 0) {
        pendingCases.forEach(c => {
            if (c.cbName === excludeCbName) return;  // 排除自己

            // 取得該案件的日期（優先用開標日，沒有就用截標日+2天估算）
            let caseDate = null;
            if (c.openDate) {
                caseDate = new Date(c.openDate);
            } else if (c.bidEndDate) {
                caseDate = new Date(c.bidEndDate);
                caseDate.setDate(caseDate.getDate() + 2);  // 估算開標日
            } else if (c.listingDate) {
                // 用掛牌日反推開標日（掛牌日通常在開標後5-7天）
                caseDate = new Date(c.listingDate);
                caseDate.setDate(caseDate.getDate() - 6);
            }

            if (caseDate && caseDate >= startDate && caseDate <= endDate) {
                concurrentCases.push({
                    name: c.cbName,
                    type: c.auctionType || '未知',
                    size: c.issueSize || 0,
                    date: caseDate.toISOString().split('T')[0],
                    status: c.status || 'pending',
                    source: 'pending'
                });
            }
        });
    }

    // 2. 從已開標資料找（最近已開標的案件）
    if (auctionRawData && auctionRawData.length > 0) {
        auctionRawData.forEach(d => {
            if (d.name === excludeCbName) return;  // 排除自己
            if (!d.openDate) return;

            const caseDate = new Date(d.openDate);
            if (caseDate >= startDate && caseDate <= endDate) {
                // 檢查是否已經在pendingCases中（避免重複）
                const exists = concurrentCases.some(c => c.name === d.name);
                if (!exists) {
                    concurrentCases.push({
                        name: d.name,
                        type: '競拍',  // auctionRawData都是競拍
                        size: d.issueSize || 0,
                        date: d.openDate,
                        status: 'opened',
                        source: 'auction'
                    });
                }
            }
        });
    }

    // 統計
    const auctionCases = concurrentCases.filter(c => c.type === '競拍');
    const inquiryCases = concurrentCases.filter(c => c.type === '詢圈');
    const totalSize = concurrentCases.reduce((s, c) => s + (c.size || 0), 0);
    const auctionSize = auctionCases.reduce((s, c) => s + (c.size || 0), 0);
    const inquirySize = inquiryCases.reduce((s, c) => s + (c.size || 0), 0);

    // 計算同期發行壓力指數（0-100）
    // 基準：同期20億以下=正常，20-40億=偏多，40億以上=很多
    let pressureIndex = 0;
    if (totalSize <= 10) pressureIndex = 10;
    else if (totalSize <= 20) pressureIndex = 30;
    else if (totalSize <= 30) pressureIndex = 50;
    else if (totalSize <= 40) pressureIndex = 70;
    else if (totalSize <= 50) pressureIndex = 85;
    else pressureIndex = 100;

    // 計算調整值
    // 同期發行少 → 不調整
    // 同期發行多 → 下調溢價預測
    let adjustment = 0;
    let note = '';
    if (totalSize <= 10) {
        adjustment = 0;
        note = '同期發行量正常';
    } else if (totalSize <= 20) {
        adjustment = -0.5;
        note = '同期發行量偏多';
    } else if (totalSize <= 30) {
        adjustment = -1;
        note = '同期發行量較多，資金分散';
    } else if (totalSize <= 40) {
        adjustment = -1.5;
        note = '⚠️ 同期發行量大，資金明顯分散';
    } else {
        adjustment = -2;
        note = '⚠️ 同期發行量非常大，注意競爭壓力';
    }

    console.log(`📦 同期發行分析(${daysBefore}天前~${daysAfter}天後):`);
    console.log(`  總計: ${concurrentCases.length}檔, ${totalSize.toFixed(1)}億`);
    console.log(`  競拍: ${auctionCases.length}檔, ${auctionSize.toFixed(1)}億`);
    console.log(`  詢圈: ${inquiryCases.length}檔, ${inquirySize.toFixed(1)}億`);
    console.log(`  壓力指數: ${pressureIndex}, 調整: ${adjustment}%`);

    return {
        cases: concurrentCases,
        summary: {
            totalCount: concurrentCases.length,
            totalSize: totalSize,
            auctionCount: auctionCases.length,
            auctionSize: auctionSize,
            inquiryCount: inquiryCases.length,
            inquirySize: inquirySize
        },
        pressureIndex: pressureIndex,
        adjustment: adjustment,
        note: note,
        dateRange: {
            start: startDate.toISOString().split('T')[0],
            end: endDate.toISOString().split('T')[0],
            target: targetDate
        }
    };
}

/**
 * 計算熱度指數
 * @param {Object} params - 計算參數
 * @returns {Object} 熱度分析結果
 */
function calcHeatIndex(params) {
    const { issueSize, theoreticalPrice, industry, years, atmosphereIndex, rating, stockCap, broker } = params;

    let totalScore = 0;
    const breakdown = [];

    // v3.85 市場氛圍權重優化：五維度精簡版
    // 產業35% + 券商25% + 信評20% + 規模10% + 理論價10% = 100分
    // 根據2203檔CB實證數據重新設計

    // 1. 產業評分 (滿分35) - 實證影響最大，優良率差距36%
    let industryScore = 21;  // 基準分
    const industryStr = String(industry || '');
    // 根據2203檔實證的產業係數
    if (industryStr.includes('電子通路')) {
        industryScore = 35;  // 係數1.14，優良率72%
    } else if (industryStr.includes('電子零組件')) {
        industryScore = 35;  // 係數1.14，優良率72%
    } else if (industryStr.includes('其他') && industryStr.includes('電子')) {
        industryScore = 34;  // 係數1.13，優良率71%
    } else if (industryStr.includes('化學')) {
        industryScore = 34;  // 係數1.12，優良率71%
    } else if (industryStr.includes('電腦') || industryStr.includes('週邊')) {
        industryScore = 34;  // 係數1.13，優良率71%
    } else if (industryStr.includes('生技') || industryStr.includes('醫療')) {
        industryScore = 33;  // 係數1.11，優良率70%（實證翻轉！）
    } else if (industryStr.includes('半導體')) {
        industryScore = 32;  // 係數1.09，優良率69%
    } else if (industryStr.includes('通信') || industryStr.includes('網路')) {
        industryScore = 28;  // 係數1.04，優良率66%
    } else if (industryStr.includes('運動') || industryStr.includes('休閒')) {
        industryScore = 26;  // 係數1.01，優良率64%
    } else if (industryStr.includes('鋼鐵')) {
        industryScore = 25;  // 係數1.00，優良率63%（基準）
    } else if (industryStr.includes('觀光') || industryStr.includes('餐旅')) {
        industryScore = 22;  // 係數0.95，優良率60%
    } else if (industryStr.includes('航運')) {
        industryScore = 21;  // 係數0.93，優良率59%
    } else if (industryStr.includes('光電')) {
        industryScore = 20;  // 係數0.91，優良率58%
    } else if (industryStr.includes('電機') || industryStr.includes('機械')) {
        industryScore = 20;  // 係數0.92，優良率58%
    } else if (industryStr.includes('建材') || industryStr.includes('營造')) {
        industryScore = 19;  // 係數0.89，優良率56%
    } else if (industryStr.includes('汽車')) {
        industryScore = 16;  // 係數0.82，優良率52%
    } else if (industryStr.includes('綠能') || industryStr.includes('環保')) {
        industryScore = 15;  // 係數0.79，優良率50%
    } else if (industryStr.includes('紡織') || industryStr.includes('纖維')) {
        industryScore = 13;  // 係數0.74，優良率47%
    } else if (industryStr.includes('居家') || industryStr.includes('生活')) {
        industryScore = 8;   // 係數0.57，優良率36%（★最差）
    } else {
        industryScore = 21;  // 其他產業給基準分
    }
    totalScore += industryScore;
    breakdown.push({ dim: '產業類別', value: industry || '未指定', score: industryScore, max: 35 });

    // 2. 券商評分 (滿分25) - 原本被忽略！優良率差距30%
    let brokerScore = 15;  // 預設基準分
    const brokerStr = String(broker || '');
    // 實證發現：統一、台新最佳；國票、國泰較差
    if (brokerStr.includes('統一')) brokerScore = 25;         // 係數1.14，優良率72.4%（★最佳）
    else if (brokerStr.includes('台新')) brokerScore = 23;    // 係數1.04，優良率65.6%
    else if (brokerStr.includes('富邦')) brokerScore = 19;    // 係數0.97，優良率61.7%
    else if (brokerStr.includes('凱基')) brokerScore = 19;    // 係數0.97，優良率61.6%
    else if (brokerStr.includes('中信')) brokerScore = 18;    // 係數0.96，優良率60.7%
    else if (brokerStr.includes('群益')) brokerScore = 18;    // 係數0.95，優良率60.0%
    else if (brokerStr.includes('福邦')) brokerScore = 17;    // 係數0.93，優良率58.7%
    else if (brokerStr.includes('永豐')) brokerScore = 16;    // 係數0.91，優良率57.8%
    else if (brokerStr.includes('華南')) brokerScore = 15;    // 係數0.88，優良率56.0%
    else if (brokerStr.includes('元富')) brokerScore = 14;    // 係數0.86，優良率54.6%
    else if (brokerStr.includes('元大')) brokerScore = 12;    // 係數0.83，優良率52.5%
    else if (brokerStr.includes('兆豐')) brokerScore = 11;    // 係數0.79，優良率50.0%
    else if (brokerStr.includes('合庫')) brokerScore = 10;    // 係數0.77，優良率48.8%
    else if (brokerStr.includes('宏遠')) brokerScore = 9;     // 係數0.75，優良率47.6%
    else if (brokerStr.includes('國票')) brokerScore = 8;     // 係數0.73，優良率46.0%
    else if (brokerStr.includes('國泰')) brokerScore = 6;     // 係數0.67，優良率42.2%（★最差）
    totalScore += brokerScore;
    breakdown.push({ dim: '承銷券商', value: broker || '未指定', score: brokerScore, max: 25 });

    // 3. 信用評等評分 (滿分20) - 重要發現：TCRI 4-5最佳，不是越低越好！
    let ratingScore = 12;
    const ratingNum = parseInt(rating) || 5;
    if (ratingNum === 5) ratingScore = 20;        // ★最佳：TCRI 5，係數1.04，優良率66%
    else if (ratingNum === 4) ratingScore = 19;   // 優良：TCRI 4，係數1.03，優良率65%
    else if (ratingNum === 6) ratingScore = 13;   // 中性：TCRI 6，係數0.87，優良率55%
    else if (ratingNum === 3) ratingScore = 12;   // 中性：TCRI 3，係數0.85，優良率54%
    else if (ratingNum === 8) ratingScore = 11;   // 警戒：TCRI 8，係數0.82，優良率52%
    else if (ratingNum === 7) ratingScore = 8;    // ★最差：TCRI 7，係數0.69，優良率44%
    else if (ratingNum <= 2) ratingScore = 12;    // TCRI 1-2：樣本少，給中性分
    totalScore += ratingScore;
    breakdown.push({ dim: '信用評等', value: `TCRI ${ratingNum}`, score: ratingScore, max: 20 });

    // 4. 發行規模評分 (滿分10) - 小型最佳，大型最差
    let sizeScore = 6;
    if (issueSize < 3) sizeScore = 10;            // 係數0.99，優良率62.8%（★最佳）
    else if (issueSize < 5) sizeScore = 8;        // 係數0.94，優良率59.7%
    else if (issueSize < 10) sizeScore = 9;       // 係數0.99，優良率62.4%
    else if (issueSize < 20) sizeScore = 8;       // 係數0.97，優良率61.3%
    else sizeScore = 5;                            // 係數0.79，優良率49.7%（★最差）
    totalScore += sizeScore;
    breakdown.push({ dim: '發行規模', value: `${issueSize}億`, score: sizeScore, max: 10 });

    // 5. 理論價位評分 (滿分10) - 競拍安全邊際
    let theoScore = 6;
    if (theoreticalPrice < 95) theoScore = 10;          // 係數1.15，極佳安全邊際
    else if (theoreticalPrice < 100) theoScore = 9;     // 係數1.10，良好安全邊際
    else if (theoreticalPrice < 105) theoScore = 7;     // 係數1.00，基準區間
    else if (theoreticalPrice < 110) theoScore = 5;     // 係數0.90，安全邊際收窄
    else if (theoreticalPrice < 115) theoScore = 3;     // 係數0.75，追價風險提高
    else theoScore = 2;                                  // 係數0.60，高風險區間
    totalScore += theoScore;

    let theoLabel = '高風險';
    if (theoreticalPrice < 95) theoLabel = '極佳安全邊際';
    else if (theoreticalPrice < 100) theoLabel = '良好安全邊際';
    else if (theoreticalPrice < 105) theoLabel = '基準區間';
    else if (theoreticalPrice < 110) theoLabel = '安全邊際收窄';
    else if (theoreticalPrice < 115) theoLabel = '追價風險';
    breakdown.push({ dim: '理論價位', value: `${theoreticalPrice}元(${theoLabel})`, score: theoScore, max: 10 });

    // 計算熱度等級和建議調整（滿分100）
    let heatLevel, heatColor, premiumAdjust;
    if (totalScore >= 80) {
        heatLevel = '極熱';
        heatColor = '#d32f2f';
        premiumAdjust = 4;
    } else if (totalScore >= 65) {
        heatLevel = '熱';
        heatColor = '#ff5722';
        premiumAdjust = 2;
    } else if (totalScore >= 50) {
        heatLevel = '普通';
        heatColor = '#ff9800';
        premiumAdjust = 0;
    } else if (totalScore >= 35) {
        heatLevel = '冷';
        heatColor = '#2196f3';
        premiumAdjust = -2;
    } else {
        heatLevel = '極冷';
        heatColor = '#1565c0';
        premiumAdjust = -3;
    }

    // 預期投標倍數（根據熱度估算）
    let expectedMultiple = 1.5;
    if (totalScore >= 80) expectedMultiple = 4.0;
    else if (totalScore >= 65) expectedMultiple = 3.0;
    else if (totalScore >= 50) expectedMultiple = 2.2;
    else if (totalScore >= 35) expectedMultiple = 1.5;
    else expectedMultiple = 1.2;

    return {
        totalScore: totalScore,
        maxScore: 100,  // 100分制
        heatLevel: heatLevel,
        heatColor: heatColor,
        premiumAdjust: premiumAdjust,
        expectedMultiple: expectedMultiple,
        breakdown: breakdown
    };
}

/**
 * v3.92 新增：計算熱度偏離和風險提醒
 * 比較近期市場氛圍與歷史平均的偏離程度
 */
function getHeatDeviation(recentMult, historyMult) {
    if (historyMult === 0) return { pct: 0, level: 'normal', icon: '☀️', msg: '資料不足' };
    const pct = ((recentMult - historyMult) / historyMult) * 100;

    if (pct < -20) return { pct, level: 'frozen', icon: '❄️', msg: '市場極冷，可保守出價，但需留意是否有系統性風險' };
    if (pct < -10) return { pct, level: 'cool', icon: '🌤', msg: '市場偏冷，競爭較緩和' };
    if (pct <= 10) return { pct, level: 'normal', icon: '☀️', msg: '市場正常，符合歷史平均' };
    if (pct <= 20) return { pct, level: 'warm', icon: '🔥', msg: '市場偏熱，建議適度提高出價' };
    return { pct, level: 'hot', icon: '🔥🔥', msg: '市場過熱，接近歷史高點，風險報酬比下降' };
}

// ==========================================
// v3.72 主力模擬出價預測模組
// ========================================
// v3.73 新增：基於${totalAuctionCount}檔競拍統計的完整查表系統
// 數據來源：Rex大叔競拍資料庫完整統計分析報告
// ========================================

// 投標倍數 → 最低得標/平均得標對照表（核心！相關係數+0.7301）
// v3.75 改用中位數，更穩健地抵抗極端值（如光聖三123元等異常標的）
// 合理區間 = minPrice ~ avgPrice，差距約1.5-2元
const BIDMULT_TO_PRICE_TABLE = {
    'under1': { min: 0, max: 1, minPrice: 101.00, avgPrice: 102.07, gap: 1.07, avgPremium: 7.0, count: 23 },
    '1to1.5': { min: 1, max: 1.5, minPrice: 101.00, avgPrice: 102.54, gap: 1.54, avgPremium: 4.6, count: 43 },
    '1.5to2': { min: 1.5, max: 2, minPrice: 102.66, avgPrice: 104.82, gap: 2.16, avgPremium: 6.1, count: 36 },
    '2to3': { min: 2, max: 3, minPrice: 106.10, avgPrice: 108.30, gap: 2.20, avgPremium: 8.7, count: 74 },
    '3to5': { min: 3, max: 5, minPrice: 109.91, avgPrice: 111.60, gap: 1.69, avgPremium: 10.5, count: 87 },
    'over5': { min: 5, max: 99, minPrice: 112.87, avgPrice: 114.74, gap: 1.87, avgPremium: 12.4, count: 41 }
};

// 發行規模 → 投標倍數（相關係數-0.2467）
// v3.74 改為動態變數，從Excel計算後覆蓋
// 預設值（Excel未載入時使用）
window.SIZE_MULT_TABLE = {
    'under3': { label: '<3億', avgMult: 3.62, avgPrice: 107.52, count: 96 },
    '3to5': { label: '3-5億', avgMult: 3.02, avgPrice: 107.18, count: 68 },
    '5to10': { label: '5-10億', avgMult: 2.77, avgPrice: 106.81, count: 85 },
    '10to15': { label: '10-15億', avgMult: 2.29, avgPrice: 106.60, count: 29 },
    'over15': { label: '>15億', avgMult: 1.76, avgPrice: 105.23, count: 22 }
};

// 年期+擔保組合 → 投標倍數
window.TERM_GUAR_TABLE = {
    '有擔保_3': { avgMult: 3.30, avgPrice: 108.65, avgPremium: 11.1, count: 82 },
    '有擔保_5': { avgMult: 2.51, avgPrice: 108.01, avgPremium: 11.1, count: 17 },
    '無擔保_3': { avgMult: 3.08, avgPrice: 106.39, avgPremium: 8.6, count: 152 },
    '無擔保_5': { avgMult: 2.32, avgPrice: 105.80, avgPremium: 4.6, count: 48 }
};

// 轉換價值區間 → 投標倍數
window.CONV_VALUE_TABLE = {
    'deep_out': { label: '深度價外(<90)', avgMult: 2.51, avgPrice: 105.03, count: 33 },
    'out': { label: '價外(90-100)', avgMult: 2.74, avgPrice: 105.20, count: 155 },
    'par': { label: '價平(100-110)', avgMult: 3.50, avgPrice: 109.41, count: 92 },
    'in': { label: '價內(110-130)', avgMult: 3.01, avgPrice: 111.23, count: 17 },
    'deep_in': { label: '深度價內(>130)', avgMult: 4.08, avgPrice: 122.30, count: 3 }
};

// 產業 → 投標倍數（樣本數≥5）
window.INDUSTRY_MULT_TABLE = {
    '電器電纜': { avgMult: 4.57, avgPrice: 108.16, avgPremium: 11.5, count: 5 },
    '其他電子業': { avgMult: 4.00, avgPrice: 110.35, avgPremium: 11.3, count: 20 },
    '居家生活': { avgMult: 3.57, avgPrice: 107.74, avgPremium: 9.6, count: 5 },
    '電腦及週邊設備業': { avgMult: 3.40, avgPrice: 106.43, avgPremium: 7.3, count: 16 },
    '電子零組件業': { avgMult: 3.36, avgPrice: 108.93, avgPremium: 8.0, count: 43 },
    '半導體業': { avgMult: 3.07, avgPrice: 108.60, avgPremium: 9.5, count: 21 },
    '運動休閒': { avgMult: 3.05, avgPrice: 108.51, avgPremium: 9.8, count: 12 },
    '光電業': { avgMult: 3.01, avgPrice: 107.58, avgPremium: 6.5, count: 20 },
    '通信網路業': { avgMult: 2.86, avgPrice: 108.79, avgPremium: 10.3, count: 12 },
    '生技醫療業': { avgMult: 2.79, avgPrice: 105.63, avgPremium: 5.2, count: 15 },
    '電機機械': { avgMult: 2.74, avgPrice: 106.20, avgPremium: 8.8, count: 26 },
    '綠能環保': { avgMult: 2.58, avgPrice: 106.00, avgPremium: 9.6, count: 10 },
    '汽車工業': { avgMult: 2.52, avgPrice: 103.33, avgPremium: 10.5, count: 9 },
    '鋼鐵工業': { avgMult: 2.18, avgPrice: 106.16, avgPremium: 18.0, count: 9 },
    '航運業': { avgMult: 2.06, avgPrice: 102.75, avgPremium: 8.6, count: 7 },
    '建材營造業': { avgMult: 1.95, avgPrice: 103.93, avgPremium: 9.5, count: 16 },
    '紡織纖維': { avgMult: 1.73, avgPrice: 102.12, avgPremium: 6.1, count: 6 }
};

// 券商 → 投標倍數（樣本數≥5）
window.BROKER_MULT_TABLE = {
    '兆豐證券': { avgMult: 4.33, avgPrice: 109.22, avgPremium: 10.2, count: 10 },
    '中信證券': { avgMult: 3.85, avgPrice: 109.22, avgPremium: 8.0, count: 23 },
    '元大證券': { avgMult: 3.71, avgPrice: 107.85, avgPremium: 8.3, count: 22 },
    '國票證券': { avgMult: 3.49, avgPrice: 110.78, avgPremium: 14.5, count: 12 },
    '凱基證券': { avgMult: 3.48, avgPrice: 108.29, avgPremium: 9.9, count: 54 },
    '永豐金證': { avgMult: 3.04, avgPrice: 106.17, avgPremium: 7.7, count: 13 },
    '合庫證券': { avgMult: 2.92, avgPrice: 105.52, avgPremium: 12.6, count: 9 },
    '統一證券': { avgMult: 2.77, avgPrice: 106.44, avgPremium: 6.5, count: 11 },
    '福邦證券': { avgMult: 2.71, avgPrice: 104.87, avgPremium: 5.7, count: 15 },
    '台新證券': { avgMult: 2.59, avgPrice: 106.31, avgPremium: 7.0, count: 41 },
    '富邦證券': { avgMult: 2.57, avgPrice: 107.01, avgPremium: 10.9, count: 41 },
    '第一金證': { avgMult: 2.40, avgPrice: 106.35, avgPremium: 9.7, count: 9 },
    '國泰證券': { avgMult: 2.06, avgPrice: 104.86, avgPremium: 6.5, count: 5 },
    '宏遠證券': { avgMult: 1.97, avgPrice: 103.43, avgPremium: 1.8, count: 6 },
    '群益證券': { avgMult: 1.95, avgPrice: 104.18, avgPremium: 4.7, count: 9 }
};

// v3.97-zs-ba: 券商代號對照表（代號 → 名稱）- 同時支援大小寫
window.BROKER_CODE_MAP = {
    '920T': '統一', '9200': '統一', '920t': '統一',
    '930T': '凱基', '9300': '凱基', '930t': '凱基',
    '940T': '元大', '9400': '元大', '940t': '元大',
    '950T': '富邦', '9500': '富邦', '950t': '富邦',
    '960T': '日盛', '9600': '日盛', '960t': '日盛',
    '970T': '國泰', '9700': '國泰', '970t': '國泰',
    '980T': '玉山', '9800': '玉山', '980t': '玉山',
    '990T': '永豐金', '9900': '永豐金', '990t': '永豐金',
    '9A0T': '兆豐', '9A00': '兆豐', '9a0t': '兆豐', '9a0T': '兆豐', '9A0t': '兆豐',
    '9B0T': '台新', '9B00': '台新', '9b0t': '台新', '9b0T': '台新',
    '9C0T': '中信', '9C00': '中信', '9c0t': '中信', '9c0T': '中信',
    '9D0T': '群益', '9D00': '群益', '9d0t': '群益', '9d0T': '群益',
    '9E0T': '第一金', '9E00': '第一金', '9e0t': '第一金', '9e0T': '第一金',
    '9F0T': '合庫', '9F00': '合庫', '9f0t': '合庫', '9f0T': '合庫',
    '9G0T': '華南永昌', '9G00': '華南永昌', '9g0t': '華南永昌', '9g0T': '華南永昌',
    '9H0T': '元富', '9H00': '元富', '9h0t': '元富', '9h0T': '元富',
    '9I0T': '台灣', '9I00': '台灣', '9i0t': '台灣', '9i0T': '台灣',
    '9J0T': '國票', '9J00': '國票', '9j0t': '國票', '9j0T': '國票',
    '9K0T': '宏遠', '9K00': '宏遠', '9k0t': '宏遠', '9k0T': '宏遠',
    '9L0T': '康和', '9L00': '康和', '9l0t': '康和', '9l0T': '康和',
    '9M0T': '美林', '9M00': '美林', '9m0t': '美林', '9m0T': '美林',
    '9N0T': '大華', '9N00': '大華', '9n0t': '大華', '9n0T': '大華',
    '9P0T': '福邦', '9P00': '福邦', '9p0t': '福邦', '9p0T': '福邦',
    '9Q0T': '致和', '9Q00': '致和', '9q0t': '致和', '9q0T': '致和',
    '9R0T': '大眾', '9R00': '大眾', '9r0t': '大眾', '9r0T': '大眾',
    '9S0T': '光和', '9S00': '光和', '9s0t': '光和', '9s0T': '光和',
    '9T0T': '亞東', '9T00': '亞東', '9t0t': '亞東', '9t0T': '亞東',
    '9U0T': '新光', '9U00': '新光', '9u0t': '新光', '9u0T': '新光',
    '9V0T': '土銀', '9V00': '土銀', '9v0t': '土銀', '9v0T': '土銀',
    '9W0T': '彰銀', '9W00': '彰銀', '9w0t': '彰銀', '9w0T': '彰銀',
    '9X0T': '台銀', '9X00': '台銀', '9x0t': '台銀', '9x0T': '台銀',
    '9Y0T': '臺企銀', '9Y00': '臺企銀', '9y0t': '臺企銀', '9y0T': '臺企銀',
    '9Z0T': '陽信', '9Z00': '陽信', '9z0t': '陽信', '9z0T': '陽信'
};

/**
 * v3.97-zs-bc: 將券商代號轉換為名稱（修正版）
 * 處理各種格式：純代號(920T)、混合格式(920T凱基證券)、純名稱(凱基證券)
 */
function convertBrokerCodeToName(brokerValue) {
    if (!brokerValue || brokerValue === '-') return '-';

    let input = String(brokerValue).trim();

    // 情況1: 混合格式 "920T凱基證券" - 直接提取中文名稱部分
    const mixedMatch = input.match(/^[0-9A-Za-z]{4}(.+)$/);
    if (mixedMatch && mixedMatch[1]) {
        // 提取中文部分，移除「證券」等後綴
        let name = mixedMatch[1].replace(/證券.*$/, '').trim();
        if (name.length > 0) {
            return name.substring(0, 4); // 最多取4個字
        }
    }

    // 情況2: 純代號格式 "920T" - 查對照表
    const code = input.toUpperCase();
    if (window.BROKER_CODE_MAP[code]) {
        return window.BROKER_CODE_MAP[code];
    }

    // 情況3: 純代號但不在對照表 - 嘗試各種變體
    if (/^[0-9A-Za-z]{4}$/.test(input)) {
        // 嘗試原始大小寫
        if (window.BROKER_CODE_MAP[input]) {
            return window.BROKER_CODE_MAP[input];
        }
        console.warn(`未知券商代號: ${input}`);
        return input;
    }

    // 情況4: 純中文名稱 "凱基證券" - 直接清理
    return input.replace(/證券.*$/, '').substring(0, 4);
}

// 整體統計數據
window.OVERALL_STATS = {
    avgBidMult: 2.98,
    medianBidMult: 2.69,
    avgMinBid: 106.99,
    medianMinBid: 106.10,
    avgTheoretical: 98.86,
    avgPremium: 8.73,
    avgQualified: 474,
    avgBidShares: 34.5,
    get totalSamples() { return totalAuctionCount || 300; }  // v3.81 動態取值
};

// 信評等級 → 投標倍數
window.RATING_MULT_TABLE = {
    '1': { avgMult: 1.34, avgPrice: 100.00, avgShares: 114.3, count: 1 },
    '2': { avgMult: 1.34, avgPrice: 100.00, avgShares: 114.3, count: 1 },
    '3': { avgMult: 2.63, avgPrice: 109.75, avgShares: 55.4, count: 6 },
    '4': { avgMult: 2.76, avgPrice: 105.71, avgShares: 41.2, count: 39 },
    '5': { avgMult: 3.56, avgPrice: 108.32, avgShares: 34.1, count: 60 },
    '6': { avgMult: 2.95, avgPrice: 106.74, avgShares: 32.1, count: 108 },
    '7': { avgMult: 2.74, avgPrice: 106.66, avgShares: 32.4, count: 55 },
    '8': { avgMult: 2.65, avgPrice: 106.10, avgShares: 30.7, count: 22 },
    '9': { avgMult: 3.27, avgPrice: 110.20, avgShares: 33.2, count: 7 }
};

// 年度統計
window.YEAR_STATS_TABLE = {
    '2019': { count: 5, avgMult: 2.52, avgPrice: 103.89, avgPremium: 6.8 },
    '2020': { count: 25, avgMult: 2.36, avgPrice: 104.11, avgPremium: 4.6 },
    '2021': { count: 48, avgMult: 3.17, avgPrice: 108.05, avgPremium: 9.8 },
    '2022': { count: 51, avgMult: 2.77, avgPrice: 106.11, avgPremium: 9.7 },
    '2023': { count: 44, avgMult: 3.14, avgPrice: 107.00, avgPremium: 7.2 },
    '2024': { count: 75, avgMult: 3.49, avgPrice: 109.88, avgPremium: 11.8 },
    '2025': { count: 52, avgMult: 2.46, avgPrice: 104.35, avgPremium: 5.9 }
};

// ========================================
// v3.73 智慧提示系統
// 在各輸入欄位旁即時顯示歷史統計提示
// ========================================

/**
 * 顯示產業統計提示（追加到原有統計卡片下方）
 */
function showIndustryTip(industry) {
    const tipBox = document.getElementById('industryTip300');
    if (!tipBox) return;

    // 嘗試匹配產業名稱（移除括號後綴）
    const indName = industry ? industry.split(' ')[0] : '';
    const data = window.INDUSTRY_MULT_TABLE[indName];

    if (!data) {
        tipBox.style.display = 'none';
        return;
    }

    const heatLevel = data.avgMult >= 3.5 ? '🔥熱門' : (data.avgMult >= 2.5 ? '⚡一般' : '❄️冷門');
    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');

    tipBox.innerHTML = `
        <div class="tip-title">
            <span style="color:${heatColor};">${heatLevel}</span>
            📊 ${totalAuctionCount}檔統計：${indName}（${data.count}檔）
        </div>
        <div class="tip-stats">
            <span>投標倍數：<b style="color:#6366f1;">${data.avgMult.toFixed(2)}x</b></span>
            <span>平均得標：<b style="color:#059669;">${data.avgPrice.toFixed(1)}元</b></span>
            <span>平均溢價：<b>${data.avgPremium.toFixed(1)}%</b></span>
        </div>
    `;
    tipBox.style.display = 'block';
}

/**
 * 顯示券商統計提示（追加到原有統計卡片下方）
 */
function showBrokerTip(broker) {
    const tipBox = document.getElementById('brokerTip300');
    if (!tipBox) return;

    // 嘗試匹配券商名稱
    const brokerName = broker ? broker.split(' ')[0] : '';
    let data = window.BROKER_MULT_TABLE[brokerName];
    if (!data) {
        for (const [name, d] of Object.entries(window.BROKER_MULT_TABLE)) {
            if (brokerName.includes(name.replace('證券', '')) || name.includes(brokerName.replace('證券', ''))) {
                data = d;
                break;
            }
        }
    }

    if (!data) {
        tipBox.style.display = 'none';
        return;
    }

    const heatLevel = data.avgMult >= 3.5 ? '🔥高熱度' : (data.avgMult >= 2.5 ? '⚡中熱度' : '❄️低熱度');
    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');

    tipBox.innerHTML = `
        <div class="tip-title">
            <span style="color:${heatColor};">${heatLevel}</span>
            🏦 ${totalAuctionCount}檔統計：${brokerName}（${data.count}檔）
        </div>
        <div class="tip-stats">
            <span>投標倍數：<b style="color:#6366f1;">${data.avgMult.toFixed(2)}x</b></span>
            <span>平均得標：<b style="color:#059669;">${data.avgPrice.toFixed(1)}元</b></span>
            <span>平均溢價：<b>${data.avgPremium.toFixed(1)}%</b></span>
        </div>
    `;
    tipBox.style.display = 'block';
}

/**
 * 顯示發行規模統計提示（追加到原有統計卡片下方）
 */
function showSizeTip(sizeRange) {
    const tipBox = document.getElementById('issueSizeTip300');
    if (!tipBox) return;

    // 映射選項值到統計表key
    const sizeMap = {
        '小於2億': 'under3',
        '2~5億': '3to5',
        '5~10億': '5to10',
        '10~15億': '10to15',
        '15~20億': 'over15',
        '大於20億': 'over15'
    };

    const key = sizeMap[sizeRange];
    const data = key ? window.SIZE_MULT_TABLE[key] : null;

    if (!data) {
        tipBox.style.display = 'none';
        return;
    }

    const heatLevel = data.avgMult >= 3.5 ? '🔥競爭激烈' : (data.avgMult >= 2.5 ? '⚡適中競爭' : '❄️競爭較低');
    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');

    // 額外提示
    let tip = '';
    if (data.avgMult >= 3.5) {
        tip = '<span style="color:#dc2626;">💡 小規模CB競爭激烈，建議出價保守</span>';
    } else if (data.avgMult < 2) {
        tip = '<span style="color:#16a34a;">💡 大規模CB競爭較低，有機會低價得標</span>';
    }

    tipBox.innerHTML = `
        <div class="tip-title">
            <span style="color:${heatColor};">${heatLevel}</span>
            📦 ${totalAuctionCount}檔統計：${data.label}（${data.count}檔，佔${(data.count/totalAuctionCount*100).toFixed(1)}%）
        </div>
        <div class="tip-stats">
            <span>投標倍數：<b style="color:#6366f1;">${data.avgMult.toFixed(2)}x</b></span>
            <span>平均得標：<b style="color:#059669;">${data.avgPrice.toFixed(1)}元</b></span>
        </div>
        ${tip ? `<div style="margin-top:4px;">${tip}</div>` : ''}
    `;
    tipBox.style.display = 'block';
}

/**
 * 顯示年期+擔保組合統計提示（追加到原有統計卡片下方）
 */
function showTermGuaranteeTip() {
    const years = document.getElementById('years')?.value;
    const guarantee = document.getElementById('guarantee')?.value;

    // 更新年期提示
    const yearsTipBox = document.getElementById('yearsTip300');
    if (yearsTipBox && years) {
        const yearData = {
            '3': { label: '3年期', pct: 78.0, avgMult: 3.15, avgPrice: 107.18, avgPremium: 9.4 },
            '5': { label: '5年期', pct: 21.7, avgMult: 2.37, avgPrice: 106.38, avgPremium: 6.3 },
            '7': { label: '7年期', pct: 0.3, avgMult: 1.00, avgPrice: 100.00, avgPremium: 1.9 }
        }[years];

        if (yearData) {
            const heatColor = yearData.avgMult >= 3 ? '#ef4444' : (yearData.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            yearsTipBox.innerHTML = `
                <div class="tip-title">📅 ${totalAuctionCount}檔統計：${yearData.label}（佔${yearData.pct}%）</div>
                <div class="tip-stats">
                    <span>投標倍數：<b style="color:${heatColor};">${yearData.avgMult.toFixed(2)}x</b></span>
                    <span>平均得標：<b>${yearData.avgPrice.toFixed(1)}元</b></span>
                    <span>平均溢價：<b>${yearData.avgPremium.toFixed(1)}%</b></span>
                </div>
            `;
            yearsTipBox.style.display = 'block';
        }
    } else if (yearsTipBox) {
        yearsTipBox.style.display = 'none';
    }

    // 更新擔保提示
    const guarTipBox = document.getElementById('guaranteeTip300');
    if (guarTipBox && guarantee) {
        const guarData = {
            '有擔保': { pct: 33.0, avgMult: 3.16, avgPrice: 108.54, avgPremium: 11.1 },
            '無擔保': { pct: 67.0, avgMult: 2.88, avgPrice: 106.22, avgPremium: 7.6 }
        }[guarantee];

        if (guarData) {
            const heatColor = guarData.avgMult >= 3 ? '#ef4444' : '#eab308';

            // 如果年期和擔保都有選擇，顯示組合統計
            if (years && guarantee) {
                const comboKey = `${guarantee}_${years}`;
                const comboData = window.TERM_GUAR_TABLE[comboKey];

                if (comboData) {
                    const comboColor = comboData.avgMult >= 3 ? '#ef4444' : (comboData.avgMult >= 2.5 ? '#eab308' : '#22c55e');
                    guarTipBox.innerHTML = `
                        <div class="tip-title">
                            <span style="color:${comboColor};">🎯 ${totalAuctionCount}檔統計：${guarantee}+${years}年組合</span>（${comboData.count}檔）
                        </div>
                        <div class="tip-stats">
                            <span>投標倍數：<b style="color:#6366f1;">${comboData.avgMult.toFixed(2)}x</b></span>
                            <span>平均得標：<b style="color:#059669;">${comboData.avgPrice.toFixed(1)}元</b></span>
                            <span>平均溢價：<b>${comboData.avgPremium.toFixed(1)}%</b></span>
                        </div>
                    `;
                    guarTipBox.style.display = 'block';
                    return;
                }
            }

            // 只有擔保
            guarTipBox.innerHTML = `
                <div class="tip-title">🛡️ ${totalAuctionCount}檔統計：${guarantee}（佔${guarData.pct}%）</div>
                <div class="tip-stats">
                    <span>投標倍數：<b style="color:${heatColor};">${guarData.avgMult.toFixed(2)}x</b></span>
                    <span>平均溢價：<b>${guarData.avgPremium.toFixed(1)}%</b></span>
                </div>
            `;
            guarTipBox.style.display = 'block';
        }
    } else if (guarTipBox) {
        guarTipBox.style.display = 'none';
    }
}

/**
 * 顯示理論價區間統計提示（追加到原有統計卡片下方）
 */
function showTheoPriceTip(theoRange) {
    const tipBox = document.getElementById('theoRangeTip300');
    if (!tipBox) return;

    // 映射選項值到統計表key
    const theoMap = {
        '小於90元': 'deep_out',
        '90~95元': 'out',
        '95~100元': 'out',
        '100~105元': 'par',
        '105~110元': 'par',
        '110~115元': 'in',
        '大於115元': 'deep_in'
    };

    const key = theoMap[theoRange];
    const data = key ? window.CONV_VALUE_TABLE[key] : null;

    if (!data) {
        tipBox.style.display = 'none';
        return;
    }

    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');

    // 額外說明
    let explanation = '';
    if (key === 'deep_out') {
        explanation = '<span style="color:#9333ea;">深度價外：轉換價值低，CB較不具轉換吸引力</span>';
    } else if (key === 'out') {
        explanation = '<span style="color:#2563eb;">價外：接近轉換價值，有潛在轉換機會</span>';
    } else if (key === 'par') {
        explanation = '<span style="color:#dc2626;">🔥 價平區間：投標最熱絡，競爭激烈！</span>';
    } else if (key === 'in' || key === 'deep_in') {
        explanation = '<span style="color:#16a34a;">價內：具有轉換價值，得標價通常較高</span>';
    }

    tipBox.innerHTML = `
        <div class="tip-title">📈 ${totalAuctionCount}檔統計：${data.label}（${data.count}檔，佔${(data.count/totalAuctionCount*100).toFixed(1)}%）</div>
        <div class="tip-stats">
            <span>投標倍數：<b style="color:${heatColor};">${data.avgMult.toFixed(2)}x</b></span>
            <span>平均得標：<b style="color:#059669;">${data.avgPrice.toFixed(1)}元</b></span>
        </div>
        <div style="margin-top:4px;">${explanation}</div>
    `;
    tipBox.style.display = 'block';
}

/**
 * 顯示信評統計提示（追加到原有統計卡片下方）
 */
function showRatingTip(rating) {
    const tipBox = document.getElementById('ratingTip300');
    if (!tipBox) return;

    const data = window.RATING_MULT_TABLE[rating];
    if (!data || data.count < 3) {
        if (data && data.count < 3) {
            tipBox.innerHTML = `<div class="tip-title" style="color:#d97706;">⚠️ TCRI ${rating} 樣本數過少（${data.count}檔），參考價值有限</div>`;
            tipBox.style.display = 'block';
        } else {
            tipBox.style.display = 'none';
        }
        return;
    }

    const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');

    // 信評分類說明
    let riskLevel = '';
    let riskColor = '#666';
    if (parseInt(rating) <= 4) {
        riskLevel = '優質（低風險）';
        riskColor = '#16a34a';
    } else if (parseInt(rating) <= 6) {
        riskLevel = '風險適中';
        riskColor = '#eab308';
    } else {
        riskLevel = '高風險';
        riskColor = '#dc2626';
    }

    tipBox.innerHTML = `
        <div class="tip-title">
            ⭐ ${totalAuctionCount}檔統計：TCRI ${rating} - <span style="color:${riskColor};">${riskLevel}</span>（${data.count}檔，佔${(data.count/totalAuctionCount*100).toFixed(1)}%）
        </div>
        <div class="tip-stats">
            <span>投標倍數：<b style="color:${heatColor};">${data.avgMult.toFixed(2)}x</b></span>
            <span>平均得標：<b style="color:#059669;">${data.avgPrice.toFixed(1)}元</b></span>
            <span>平均投標張數：<b>${data.avgShares.toFixed(1)}張</b></span>
        </div>
        <div style="margin-top:4px; color:#7c3aed;">
            💡 信評與投標倍數相關性極低（r=-0.04），信評非投標熱度決定因素
        </div>
    `;
    tipBox.style.display = 'block';
}

/**
 * 初始化智慧提示事件監聽
 */
function initSmartTips() {
    // 產業選擇
    const industrySelect = document.getElementById('industry');
    if (industrySelect) {
        industrySelect.addEventListener('change', function() {
            showIndustryTip(this.value);
        });
    }

    // 券商選擇
    const brokerSelect = document.getElementById('broker');
    if (brokerSelect) {
        brokerSelect.addEventListener('change', function() {
            showBrokerTip(this.value);
        });
    }

    // 發行規模選擇
    const sizeSelect = document.getElementById('issueSize');
    if (sizeSelect) {
        sizeSelect.addEventListener('change', function() {
            showSizeTip(this.value);
        });
    }

    // 年期選擇
    const yearsSelect = document.getElementById('years');
    if (yearsSelect) {
        yearsSelect.addEventListener('change', function() {
            showTermGuaranteeTip();
        });
    }

    // 擔保選擇
    const guaranteeSelect = document.getElementById('guarantee');
    if (guaranteeSelect) {
        guaranteeSelect.addEventListener('change', function() {
            showTermGuaranteeTip();
        });
    }

    // 理論價區間選擇
    const theoSelect = document.getElementById('theoRange');
    if (theoSelect) {
        theoSelect.addEventListener('change', function() {
            showTheoPriceTip(this.value);
        });
    }

    // 信評選擇
    const ratingSelect = document.getElementById('rating');
    if (ratingSelect) {
        ratingSelect.addEventListener('change', function() {
            showRatingTip(this.value);
        });
    }

    console.log('✅ 智慧提示系統初始化完成');
}

/**
 * v3.73 生成條件統計摘要HTML
 * 在評估結果中顯示所選條件的歷史統計
 */
function generateConditionSummaryHTML(r) {
    if (!r) return '';

    let items = [];

    // 1. 發行規模統計
    if (r.issueSize) {
        const sizeMap = {
            '小於2億': 'under3', '2~5億': '3to5', '5~10億': '5to10',
            '10~15億': '10to15', '15~20億': 'over15', '大於20億': 'over15'
        };
        const key = sizeMap[r.issueSize];
        const data = key ? window.SIZE_MULT_TABLE[key] : null;
        if (data) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: '📦',
                label: '發行規模',
                value: data.label,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}元`,
                color: heatColor,
                count: data.count,
                tip: data.avgMult >= 3.5 ? '競爭激烈' : (data.avgMult < 2 ? '競爭較低' : '適中')
            });
        }
    }

    // 2. 年期+擔保組合
    if (r.years && r.guarantee) {
        const comboKey = `${r.guarantee}_${r.years}`;
        const data = window.TERM_GUAR_TABLE[comboKey];
        if (data) {
            const heatColor = data.avgMult >= 3 ? '#ef4444' : '#eab308';
            items.push({
                icon: '🛡️',
                label: '年期擔保',
                value: `${r.guarantee}+${r.years}年`,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}元`,
                color: heatColor,
                count: data.count,
                tip: `溢價${data.avgPremium.toFixed(1)}%`
            });
        }
    }

    // 3. 理論價區間
    if (r.theoRange || r.theoreticalPrice) {
        const theoMap = {
            '小於90元': 'deep_out', '90~95元': 'out', '95~100元': 'out',
            '100~105元': 'par', '105~110元': 'par', '110~115元': 'in', '大於115元': 'deep_in'
        };
        let key = theoMap[r.theoRange];
        if (!key && r.theoreticalPrice) {
            const tp = parseFloat(r.theoreticalPrice);
            if (tp < 90) key = 'deep_out';
            else if (tp < 100) key = 'out';
            else if (tp < 110) key = 'par';
            else if (tp < 130) key = 'in';
            else key = 'deep_in';
        }
        const data = key ? window.CONV_VALUE_TABLE[key] : null;
        if (data) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: '📈',
                label: '轉換價值',
                value: data.label,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}元`,
                color: heatColor,
                count: data.count,
                tip: key === 'par' ? '最熱門區間' : ''
            });
        }
    }

    // 4. 產業統計
    if (r.industry) {
        const indName = r.industry.split(' ')[0]; // 移除 (n) 後綴
        const data = window.INDUSTRY_MULT_TABLE[indName];
        if (data) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: '🏭',
                label: '產業',
                value: indName,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}元`,
                color: heatColor,
                count: data.count,
                tip: data.avgMult >= 3.5 ? '熱門產業' : (data.avgMult < 2 ? '冷門產業' : '')
            });
        }
    }

    // 5. 券商統計
    if (r.broker) {
        const brokerName = r.broker.split(' ')[0];
        let data = window.BROKER_MULT_TABLE[brokerName];
        if (!data) {
            for (const [name, d] of Object.entries(window.BROKER_MULT_TABLE)) {
                if (brokerName.includes(name.replace('證券', '')) || name.includes(brokerName.replace('證券', ''))) {
                    data = d;
                    break;
                }
            }
        }
        if (data) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: '🏦',
                label: '券商',
                value: brokerName,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}元`,
                color: heatColor,
                count: data.count,
                tip: ''
            });
        }
    }

    // 6. 信評統計
    if (r.rating) {
        const data = window.RATING_MULT_TABLE[r.rating];
        if (data && data.count >= 3) {
            const heatColor = data.avgMult >= 3.5 ? '#ef4444' : (data.avgMult >= 2.5 ? '#eab308' : '#22c55e');
            items.push({
                icon: '⭐',
                label: '信評',
                value: `TCRI ${r.rating}`,
                stats: `${data.avgMult.toFixed(2)}x / ${data.avgPrice.toFixed(1)}元`,
                color: heatColor,
                count: data.count,
                tip: parseInt(r.rating) <= 4 ? '優質' : (parseInt(r.rating) >= 7 ? '高風險' : '')
            });
        }
    }

    if (items.length === 0) return '';

    // 計算綜合預估
    let totalMult = 0;
    let totalWeight = 0;
    items.forEach(item => {
        const mult = parseFloat(item.stats.split('x')[0]);
        if (mult > 0) {
            totalMult += mult;
            totalWeight++;
        }
    });
    const avgMult = totalWeight > 0 ? (totalMult / totalWeight) : 2.98;
    const heatLevel = avgMult >= 3.5 ? '🔥熱門' : (avgMult >= 2.5 ? '⚡一般' : '❄️冷門');
    const heatColor = avgMult >= 3.5 ? '#ef4444' : (avgMult >= 2.5 ? '#eab308' : '#22c55e');

    // 生成HTML
    const itemsHTML = items.map(item => `
        <div style="display:flex; align-items:center; padding:8px 12px; background:#f8fafc; border-radius:6px; gap:10px;">
            <span style="font-size:18px;">${item.icon}</span>
            <div style="flex:1;">
                <div style="font-size:11px; color:#999;">${item.label}</div>
                <div style="font-weight:bold; color:#333;">${item.value}</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:12px; color:${item.color}; font-weight:bold;">${item.stats}</div>
                <div style="font-size:10px; color:#999;">${item.count}檔${item.tip ? ' · ' + item.tip : ''}</div>
            </div>
        </div>
    `).join('');

    return `
    <div class="result-card" style="background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border:2px solid #94a3b8;">
        <h3 style="color:#334155; border-bottom:2px solid #94a3b8;">
            📊 條件統計摘要
            <span style="float:right; font-size:14px; font-weight:normal; background:${heatColor}; color:white; padding:3px 12px; border-radius:12px;">
                ${heatLevel} 預估 ${avgMult.toFixed(2)}x
            </span>
        </h3>
        <div style="padding:5px 0 10px;">
            <div style="font-size:12px; color:#64748b; margin-bottom:12px;">
                💡 以下為您所選條件在${totalAuctionCount}檔歷史競拍中的統計數據（倍數/得標價）
            </div>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                ${itemsHTML}
            </div>
            <div style="margin-top:15px; padding:10px; background:#fffbeb; border-radius:8px; border-left:4px solid #f59e0b;">
                <div style="font-size:12px; color:#92400e;">
                    <b>📌 解讀提示：</b>
                    投標倍數與最低得標強正相關（r=+0.73），倍數每增加1倍，得標約增加2-3元。
                    ${avgMult >= 3.5 ? '本案條件較熱門，建議出價保守些以控制成本。' :
                      avgMult < 2 ? '本案條件較冷門，有機會以較低價得標。' :
                      '本案條件競爭適中，可參考平衡型出價策略。'}
                </div>
            </div>
        </div>
    </div>`;
}

// ==========================================
// v3.74 動態市場回饋功能
// ==========================================

// 全局變數：儲存市場動能調整係數
window.marketMomentum = {
    adjustment: 0,          // 倍數調整值（正數=市場偏熱，負數=市場偏冷）
    priceAdjustment: 0,     // 價格調整值
    trend: '中性',           // 趨勢描述
    sampleCount: 0,         // 樣本數
    lastUpdated: null,      // 最後更新時間
    details: []             // 詳細資料
};

/**
 * v3.74 改進：自動從Excel計算市場動能
 * 從04工作表抓取最近N檔開標結果，自動計算市場氛圍
 */
function calculateMarketMomentum() {
    const resultDiv = document.getElementById('marketMomentumResult');
    const detailsDiv = document.getElementById('recentAuctionDetails');

    // 從window.recentAuctionData取得資料（在loadStatistics中已建立）
    const validData = window.recentAuctionData || [];

    if (validData.length === 0) {
        resultDiv.innerHTML = `
            <div style="background:#fff3cd; padding:10px; border-radius:6px; color:#856404; font-size:12px;">
                ⚠️ 尚未載入近期競拍資料，請確認Excel檔案已載入
            </div>`;
        return;
    }

    // 計算與歷史平均的差異
    const historyAvgMult = window.OVERALL_STATS.avgBidMult || 2.98;
    const historyAvgPrice = window.OVERALL_STATS.avgMinBid || 106.99;

    let totalMultDiff = 0;
    let totalPriceDiff = 0;
    let details = [];

    validData.forEach(d => {
        const multDiff = (d.mult - historyAvgMult) / historyAvgMult; // 百分比差異
        const priceDiff = d.price > 0 ? (d.price - historyAvgPrice) : 0;

        totalMultDiff += multDiff;
        if (d.price > 0) totalPriceDiff += priceDiff;

        details.push({
            name: d.name || '未命名',
            date: d.date,
            mult: d.mult,
            price: d.price,
            multDiff: multDiff,
            multDiffPct: (multDiff * 100).toFixed(1)
        });
    });

    const avgMultDiff = totalMultDiff / validData.length;
    const avgPriceDiff = totalPriceDiff / validData.filter(d => d.price > 0).length || 0;
    const recentAvgMult = validData.reduce((s, d) => s + d.mult, 0) / validData.length;

    // 判斷趨勢
    let trend = '中性';
    let trendColor = '#666';
    let trendIcon = '😐';

    if (avgMultDiff > 0.3) { trend = '非常熱絡'; trendColor = '#dc2626'; trendIcon = '🔥🔥'; }
    else if (avgMultDiff > 0.15) { trend = '偏熱'; trendColor = '#ea580c'; trendIcon = '🔥'; }
    else if (avgMultDiff > 0.05) { trend = '略偏熱'; trendColor = '#f59e0b'; trendIcon = '⬆️'; }
    else if (avgMultDiff < -0.3) { trend = '非常冷清'; trendColor = '#0d9488'; trendIcon = '❄️❄️'; }
    else if (avgMultDiff < -0.15) { trend = '偏冷'; trendColor = '#0891b2'; trendIcon = '❄️'; }
    else if (avgMultDiff < -0.05) { trend = '略偏冷'; trendColor = '#06b6d4'; trendIcon = '⬇️'; }

    // 計算調整值（調整幅度 = 平均差異 × 調整權重0.5，避免過度調整）
    const adjustmentWeight = 0.5;
    const multAdjustment = avgMultDiff * adjustmentWeight;
    const priceAdjustment = avgPriceDiff * 0.3;

    // 更新全局變數
    window.marketMomentum = {
        adjustment: multAdjustment,
        priceAdjustment: priceAdjustment,
        trend: trend,
        sampleCount: validData.length,
        lastUpdated: new Date().toLocaleString('zh-TW'),
        details: details,
        avgMultDiff: avgMultDiff,
        avgPriceDiff: avgPriceDiff,
        recentAvgMult: recentAvgMult
    };

    // 生成市場動能摘要HTML
    resultDiv.innerHTML = `
        <div style="background:linear-gradient(135deg, ${trendColor}20 0%, ${trendColor}10 100%); border:2px solid ${trendColor}; border-radius:8px; padding:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:11px; color:#666;">當前市場氛圍</div>
                    <div style="font-size:22px; font-weight:bold; color:${trendColor};">
                        ${trendIcon} ${trend}
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:11px; color:#666;">預測調整</div>
                    <div style="font-size:18px; font-weight:bold; color:${trendColor};">
                        ${multAdjustment >= 0 ? '+' : ''}${(multAdjustment * 100).toFixed(0)}%
                    </div>
                </div>
            </div>
            <div style="margin-top:8px; font-size:11px; color:#666; display:flex; justify-content:space-between;">
                <span>近 ${validData.length} 檔平均：<b>${recentAvgMult.toFixed(2)}x</b></span>
                <span>歷史平均：<b>${historyAvgMult.toFixed(2)}x</b></span>
                <span style="color:${trendColor};">${avgMultDiff >= 0 ? '↑' : '↓'} ${Math.abs(avgMultDiff * 100).toFixed(1)}%</span>
            </div>
        </div>
    `;

    // 生成近期開標明細HTML
    if (detailsDiv) {
        let detailsHTML = details.map((d, idx) => {
            const diffColor = parseFloat(d.multDiffPct) > 0 ? '#dc2626' : (parseFloat(d.multDiffPct) < 0 ? '#0891b2' : '#666');
            const diffSign = parseFloat(d.multDiffPct) >= 0 ? '+' : '';
            return `
                <div style="display:flex; justify-content:space-between; padding:6px 8px; background:${idx % 2 === 0 ? '#fff' : '#fafafa'}; border-radius:4px; margin-bottom:2px; font-size:11px;">
                    <span style="flex:1;">${d.name}</span>
                    <span style="width:80px; text-align:center; color:#666;">${d.date || '-'}</span>
                    <span style="width:50px; text-align:right;"><b>${d.mult.toFixed(2)}x</b></span>
                    <span style="width:55px; text-align:right;"><b>${d.price.toFixed(1)}</b></span>
                    <span style="width:50px; text-align:right; color:${diffColor};">${diffSign}${d.multDiffPct}%</span>
                </div>`;
        }).join('');

        detailsDiv.innerHTML = `
            <div style="display:flex; justify-content:space-between; padding:4px 8px; background:#e2e8f0; border-radius:4px; margin-bottom:4px; font-size:10px; font-weight:bold; color:#64748b;">
                <span style="flex:1;">名稱</span>
                <span style="width:80px; text-align:center;">開標日</span>
                <span style="width:50px; text-align:right;">倍數</span>
                <span style="width:55px; text-align:right;">最低得標</span>
                <span style="width:50px; text-align:right;">vs歷史</span>
            </div>
            ${detailsHTML}
        `;
    }

    console.log('市場動能計算完成:', window.marketMomentum);
}

/**
 * v3.73 投標倍數預估函數（重新設計）
 * 核心改進：
 * 1. 以「年期+擔保」組合為基準（區分有擔保/無擔保）
 * 2. 參考市場氛圍三條件加權（產業35%、規模25%、信評15%）
 * 3. 加入理論價區間調整（15%）和券商調整（10%）
 */
function estimateBidMultiple(params) {
    const { issueSize, guarantee, years, theoreticalPrice, industry, broker, rating } = params;

    // ===== Step 1: 確定基準（根據年期+擔保組合）=====
    const guarType = guarantee === '有擔保' ? '有擔保' : '無擔保';
    const yrs = parseInt(years) || 3;
    const baseKey = `${guarType}_${yrs}`;
    const baseData = window.TERM_GUAR_TABLE[baseKey] || window.TERM_GUAR_TABLE[`${guarType}_3`];

    // 基準倍數和溢價率
    let baseMult = baseData ? baseData.avgMult : (guarType === '有擔保' ? 3.16 : 2.88);
    let basePremium = baseData ? baseData.avgPremium : (guarType === '有擔保' ? 11.1 : 7.6);
    let basePrice = baseData ? baseData.avgPrice : (guarType === '有擔保' ? 108.54 : 106.22);
    const baseSampleCount = baseData ? baseData.count : 0;

    // 同擔保類型的整體平均（作為調整參考基準）
    const guarAvgMult = guarType === '有擔保' ? 3.16 : 2.88;
    const guarAvgPremium = guarType === '有擔保' ? 11.1 : 7.6;

    let adjustments = [];
    let totalWeight = 0;
    let confidenceScore = baseSampleCount;

    // ===== v3.90 新增：擔保類型調整（獨立顯示）=====
    // 有擔保vs無擔保的歷史差異作為調整因子
    const guarDiff = guarType === '有擔保' ? 0.28 : -0.10;  // 有擔保平均比整體高0.28x
    adjustments.push({
        factor: '🛡️ 擔保類型',
        label: guarType,
        value: guarDiff * 0.2,  // 權重20%
        ref: guarAvgMult,
        count: baseSampleCount,
        weight: '20%',
        note: guarType === '有擔保' ? '有擔保競爭較激烈' : '無擔保競爭較溫和'
    });
    baseMult += guarDiff * 0.2;
    totalWeight += 0.20;

    // ===== Step 2: 產業調整（權重30%，參考市場氛圍）=====
    const indName = industry ? industry.split(' ')[0] : '';
    if (indName && window.INDUSTRY_MULT_TABLE[indName]) {
        const indData = window.INDUSTRY_MULT_TABLE[indName];
        // 調整量 = (產業平均 - 整體平均) × 權重
        const indAdj = (indData.avgMult - window.OVERALL_STATS.avgBidMult) * 0.30;
        adjustments.push({
            factor: '產業',
            label: indName,
            value: indAdj,
            ref: indData.avgMult,
            count: indData.count,
            weight: '30%'
        });
        baseMult += indAdj;
        confidenceScore += indData.count;
        totalWeight += 0.30;
    }

    // ===== Step 3: 發行規模調整（v3.81 優化：權重40%，小規模額外加成）=====
    // 回測發現：小規模(<3億)低估0.66x，大規模(>15億)高估0.42x
    if (issueSize > 0) {
        let sizeKey = 'over15';
        if (issueSize < 3) sizeKey = 'under3';
        else if (issueSize < 5) sizeKey = '3to5';
        else if (issueSize < 10) sizeKey = '5to10';
        else if (issueSize < 15) sizeKey = '10to15';

        const sizeData = window.SIZE_MULT_TABLE[sizeKey];
        if (sizeData) {
            // v3.81: 權重從25%提高到40%
            let sizeWeight = 0.40;
            let sizeAdj = (sizeData.avgMult - window.OVERALL_STATS.avgBidMult) * sizeWeight;

            // v3.81: 小規模額外加成（因為回測顯示低估嚴重）
            if (sizeKey === 'under3') {
                sizeAdj += 0.3;  // 額外+0.3倍補償
            } else if (sizeKey === 'over15') {
                sizeAdj -= 0.2;  // 大規模額外扣減
            }

            adjustments.push({
                factor: '發行規模',
                label: sizeData.label,
                value: sizeAdj,
                ref: sizeData.avgMult,
                count: sizeData.count,
                weight: '40%'
            });
            baseMult += sizeAdj;
            confidenceScore += sizeData.count;
            totalWeight += 0.40;
        }
    }

    // ===== Step 4: 信評調整（v3.90提升權重20%）=====
    // 信評影響風險偏好，高信評吸引更多投標
    if (rating && window.RATING_MULT_TABLE[rating]) {
        const ratingData = window.RATING_MULT_TABLE[rating];
        if (ratingData.count >= 3) { // v3.90 降低門檻從5改為3
            const ratingAdj = (ratingData.avgMult - window.OVERALL_STATS.avgBidMult) * 0.20;
            adjustments.push({
                factor: '⭐ 信評',
                label: `TCRI ${rating}`,
                value: ratingAdj,
                ref: ratingData.avgMult,
                count: ratingData.count,
                weight: '20%'
            });
            baseMult += ratingAdj;
            confidenceScore += ratingData.count;
            totalWeight += 0.20;
        }
    }

    // ===== Step 5: 理論價區間調整（權重15%）=====
    if (theoreticalPrice > 0) {
        let convKey = 'out';
        if (theoreticalPrice < 90) convKey = 'deep_out';
        else if (theoreticalPrice < 100) convKey = 'out';
        else if (theoreticalPrice < 110) convKey = 'par';
        else if (theoreticalPrice < 130) convKey = 'in';
        else convKey = 'deep_in';

        const convData = window.CONV_VALUE_TABLE[convKey];
        if (convData) {
            const convAdj = (convData.avgMult - window.OVERALL_STATS.avgBidMult) * 0.15;
            adjustments.push({
                factor: '理論價區間',
                label: convData.label,
                value: convAdj,
                ref: convData.avgMult,
                count: convData.count,
                weight: '15%'
            });
            baseMult += convAdj;
            confidenceScore += convData.count;
            totalWeight += 0.15;
        }
    }

    // ===== Step 6: 券商調整（權重10%）=====
    const brokerName = broker ? broker.split(' ')[0] : '';
    if (brokerName) {
        let brokerData = window.BROKER_MULT_TABLE[brokerName];
        if (!brokerData) {
            // 嘗試部分匹配
            for (const [name, data] of Object.entries(window.BROKER_MULT_TABLE)) {
                if (brokerName.includes(name.replace('證券', '')) || name.includes(brokerName.replace('證券', ''))) {
                    brokerData = data;
                    break;
                }
            }
        }
        if (brokerData) {
            const brokerAdj = (brokerData.avgMult - window.OVERALL_STATS.avgBidMult) * 0.10;
            adjustments.push({
                factor: '券商',
                label: brokerName,
                value: brokerAdj,
                ref: brokerData.avgMult,
                count: brokerData.count,
                weight: '10%'
            });
            baseMult += brokerAdj;
            confidenceScore += brokerData.count;
            totalWeight += 0.10;
        }
    }

    // ===== Step 7: 動態市場回饋調整（v3.74新增）=====
    let momentumAdj = 0;
    let momentumInfo = null;
    if (window.marketMomentum && window.marketMomentum.adjustment !== 0 && window.marketMomentum.sampleCount > 0) {
        // 動態調整 = 基準倍數 × 動能調整比例
        momentumAdj = baseMult * window.marketMomentum.adjustment;
        adjustments.push({
            factor: '📡 市場動能',
            label: window.marketMomentum.trend + '（' + window.marketMomentum.sampleCount + '檔）',
            value: momentumAdj,
            ref: baseMult,
            count: window.marketMomentum.sampleCount,
            weight: '動態'
        });
        baseMult += momentumAdj;

        momentumInfo = {
            trend: window.marketMomentum.trend,
            adjustment: window.marketMomentum.adjustment,
            sampleCount: window.marketMomentum.sampleCount
        };
    }

    // 限制範圍（歷史最低0.18，最高11.04）
    baseMult = Math.max(0.5, Math.min(8, baseMult));

    // 信心度評估
    let confidenceLevel = '低';
    if (confidenceScore >= 150 && totalWeight >= 0.6) confidenceLevel = '高';
    else if (confidenceScore >= 80 && totalWeight >= 0.4) confidenceLevel = '中';

    return {
        estimatedMult: baseMult,
        basePremium: basePremium,
        basePrice: basePrice,
        adjustments: adjustments,
        confidence: confidenceLevel,
        totalSamples: confidenceScore,
        totalWeight: totalWeight,
        guarType: guarType,
        baseKey: baseKey,
        baseSampleCount: baseSampleCount,
        momentumInfo: momentumInfo  // v3.74 新增：動態市場回饋資訊
    };
}

/**
 * v3.73 根據投標倍數查表得到預估得標價
 */
function getExpectedPriceByMult(bidMult) {
    // v3.75 重新設計：返回最低得標(minPrice)和平均得標(avgPrice)
    // v3.81 加入自適應學習：根據歷史誤差動態調整
    // 合理區間 = minPrice ~ avgPrice

    // 基礎查表值
    let baseResult = {
        range: '',
        minPrice: 106.10,
        avgPrice: 108.30,
        gap: 2.20,
        avgPremium: 8.73,
        count: totalAuctionCount || 300
    };

    let multKey = 'over5';
    if (bidMult < 1) {
        baseResult = { range: '<1倍（未足額）', minPrice: 101.00, avgPrice: 102.07, gap: 1.07, avgPremium: 0.95, count: 23 };
        multKey = 'under1';
    } else if (bidMult < 1.5) {
        baseResult = { range: '1-1.5倍', minPrice: 101.00, avgPrice: 102.54, gap: 1.54, avgPremium: 1.32, count: 43 };
        multKey = '1to1.5';
    } else if (bidMult < 2) {
        baseResult = { range: '1.5-2倍', minPrice: 102.66, avgPrice: 104.82, gap: 2.16, avgPremium: 3.56, count: 36 };
        multKey = '1.5to2';
    } else if (bidMult < 3) {
        baseResult = { range: '2-3倍', minPrice: 106.10, avgPrice: 108.30, gap: 2.20, avgPremium: 6.43, count: 74 };
        multKey = '2to3';
    } else if (bidMult < 5) {
        baseResult = { range: '3-5倍', minPrice: 109.91, avgPrice: 111.60, gap: 1.69, avgPremium: 10.15, count: 87 };
        multKey = '3to5';
    } else {
        baseResult = { range: '>5倍', minPrice: 112.87, avgPrice: 114.74, gap: 1.87, avgPremium: 13.91, count: 41 };
        multKey = 'over5';
    }

    return baseResult;
}
// v3.72 修改：改用動態計算的統計數據
// ==========================================

/**
 * 主力出價預測函數
 * @param {number} theoPrice - 理論價格
 * @param {number} bidMultiple - 預估投標倍數
 * @param {number} issueSize - 發行規模（億元）
 * @param {string} broker - 承銷商名稱
 * @param {string} guarantee - 擔保類型（'有擔保' 或 '無擔保'）
 * @param {number} years - 發行年期（3 或 5）
 * @returns {object} 預測結果
 */
function predictMajorPlayerBid(theoPrice, bidMultiple, issueSize, broker, guarantee, years = 3, industry = '') {

    // ========================================
    // v3.73 重新設計：基於${totalAuctionCount}檔競拍統計的智能預測
    // 核心邏輯：
    // 1. 預估投標倍數（多因子加權）
    // 2. 查表得到預期得標價區間
    // 3. 計算建議出價（基於理論價）
    // ========================================

    // Step 1：預估投標倍數
    const multEstimate = estimateBidMultiple({
        issueSize: issueSize,
        guarantee: guarantee,
        years: years,
        theoreticalPrice: theoPrice,
        industry: industry,
        broker: broker
    });

    const estimatedMult = multEstimate.estimatedMult;

    // Step 2：根據預估倍數查表得到預期得標價區間
    const priceExpect = getExpectedPriceByMult(estimatedMult);

    // v3.75 核心修正：建議出價直接基於查表結果，不再用理論價×溢價率
    // 合理區間 = minPrice（最低得標）~ avgPrice（平均得標）
    const expectedMinBid = priceExpect.minPrice;   // 預期最低得標（保守基準）
    const expectedAvgBid = priceExpect.avgPrice;   // 預期平均得標（積極基準）
    const priceGap = priceExpect.gap;              // 區間差距

    // Step 3：三種策略計算
    // v3.81 修正：智能處理不同理論價情況
    let conservativePrice, balancedPrice, aggressivePrice;

    if (expectedMinBid >= theoPrice || theoPrice <= 100) {
        // 正常情況：查表價格 >= 理論價，或理論價 <= 100
        conservativePrice = expectedMinBid;
        balancedPrice = (expectedMinBid + expectedAvgBid) / 2;
        aggressivePrice = expectedAvgBid;
    } else {
        // 高理論價情況：查表價格 < 理論價
        // 以理論價為基準，加上縮減後的溢價率，並維持合理區間
        const scaleFactor = 0.5;  // 高理論價標的溢價率較低
        const histMinPremium = ((expectedMinBid / 100) - 1) * 100 * scaleFactor;
        const histAvgPremium = ((expectedAvgBid / 100) - 1) * 100 * scaleFactor;
        const minSpread = priceGap * 0.8;  // 確保區間差距

        conservativePrice = Math.max(theoPrice * (1 + histMinPremium / 100), theoPrice);
        aggressivePrice = Math.max(
            theoPrice * (1 + histAvgPremium / 100),
            conservativePrice + minSpread
        );
        balancedPrice = (conservativePrice + aggressivePrice) / 2;
    }

    // 計算溢價率（相對於理論價）
    const conservativePremium = theoPrice > 0 ? ((conservativePrice / theoPrice) - 1) * 100 : 0;
    const balancedPremium = theoPrice > 0 ? ((balancedPrice / theoPrice) - 1) * 100 : 0;
    const aggressivePremium = theoPrice > 0 ? ((aggressivePrice / theoPrice) - 1) * 100 : 0;

    // 查詢同條件歷史數據（作為參考，但不再作為主要計算依據）
    const condStats = window.conditionStats || {};
    let theoKey = '>=110';
    if (theoPrice < 95) theoKey = '<95';
    else if (theoPrice < 100) theoKey = '95-100';
    else if (theoPrice < 105) theoKey = '100-105';
    else if (theoPrice < 110) theoKey = '105-110';

    const guarKey = (guarantee === '有擔保') ? '有擔保' : '無擔保';
    const condKey = `${theoKey}_${guarKey}`;
    const histData = condStats[condKey] || {};

    // 歷史溢價率（作為參考顯示）
    const useRecent = histData.recentAvgLowPremium !== null && histData.recentAvgLowPremium !== undefined;
    const histLowPremium = useRecent ? histData.recentAvgLowPremium : (histData.avgLowPremium || 5);
    const histAvgPremium = useRecent ? histData.recentAvgAvgPremium : (histData.avgAvgPremium || 7);
    const histSampleCount = histData.count || 0;

    // 熱度等級判斷
    let heatLevel = '一般';
    let heatColor = '#eab308';
    if (estimatedMult < 1.5) { heatLevel = '冷門'; heatColor = '#22c55e'; }
    else if (estimatedMult < 2) { heatLevel = '偏冷'; heatColor = '#84cc16'; }
    else if (estimatedMult < 3) { heatLevel = '一般'; heatColor = '#eab308'; }
    else if (estimatedMult < 4) { heatLevel = '偏熱'; heatColor = '#f97316'; }
    else { heatLevel = '熱門'; heatColor = '#ef4444'; }

    // 信心度（基於樣本數）
    let confidence = '低';
    if (multEstimate.totalSamples >= 100) confidence = '高';
    else if (multEstimate.totalSamples >= 50) confidence = '中';

    return {
        // === 核心預測結果 ===
        estimatedMult: estimatedMult,           // 預估投標倍數
        expectedMinBid: expectedMinBid,         // 預期最低得標
        expectedAvgBid: expectedAvgBid,         // 預期平均得標（v3.75新增）
        priceGap: priceGap,                     // 區間差距（v3.75新增）
        multRange: priceExpect.range,           // 倍數區間

        // === 建議出價（基於查表結果 minPrice ~ avgPrice）===
        theoPrice: theoPrice,
        aggressivePrice: aggressivePrice,       // 積極型 = 平均得標
        balancedPrice: balancedPrice,           // 平衡型 = 中間值
        conservativePrice: conservativePrice,   // 保守型 = 最低得標
        aggressivePremium: aggressivePremium,   // 積極型溢價%
        balancedPremium: balancedPremium,       // 平衡型溢價%
        conservativePremium: conservativePremium, // 保守型溢價%

        // === 熱度與信心度 ===
        heatLevel: heatLevel,
        heatColor: heatColor,
        confidence: confidence,

        // === 因子分析明細 ===
        adjustments: multEstimate.adjustments,
        methodology: multEstimate.methodology,

        // === 歷史數據參考 ===
        histLowPremium: histLowPremium,
        histAvgPremium: histAvgPremium,
        histSampleCount: histSampleCount,
        useRecent: useRecent,
        condKey: condKey,
        theoKey: theoKey,
        guarKey: guarKey,

        // === 統計來源說明 ===
        dataSource: `基於${totalAuctionCount}檔競拍統計（${priceExpect.count}檔同倍數區間）`
    };
}

/**
 * 得標機率估算函數
 * @param {number} inputPremium - 用戶輸入的溢價%
 * @param {number} predictedPremium - 預測的溢價%
 * @returns {object} 機率評估結果
 */
function estimateWinRate(inputPremium, predictedPremium) {
    const diff = inputPremium - predictedPremium;

    if (diff < -1) return { rate: '<20%', level: '低', color: '#ef4444' };
    if (diff < 0) return { rate: '20-35%', level: '偏低', color: '#f97316' };
    if (diff < 0.5) return { rate: '35-50%', level: '中等', color: '#eab308' };
    if (diff < 1) return { rate: '50-62%', level: '偏高', color: '#84cc16' };
    if (diff < 1.5) return { rate: '62-72%', level: '高', color: '#22c55e' };
    if (diff < 2.5) return { rate: '72-88%', level: '很高', color: '#10b981' };
    return { rate: '>88%', level: '極高', color: '#059669' };
}

/**
 * v3.72 新增：競拍前綜合評估函數
 * 基於歷史數據評估是否值得參與這檔競拍
 * @param {object} params - 評估參數
 * @returns {object} 評估結果
 */
function evaluateAuctionOpportunity(params) {
    const {
        theoPrice,      // 理論價
        guarantee,      // 擔保類型
        tcri,           // 信用評等
        issueSize,      // 發行規模（億元）
        broker,         // 承銷商
        industry        // 產業分類
    } = params;

    let totalScore = 0;
    let maxScore = 100;
    const factors = [];

    // 判斷理論價區間
    let theoKey = '>=110';
    if (theoPrice < 95) theoKey = '<95';
    else if (theoPrice < 100) theoKey = '95-100';
    else if (theoPrice < 105) theoKey = '100-105';
    else if (theoPrice < 110) theoKey = '105-110';

    // 取得同條件歷史統計
    const guarKey = guarantee === '有擔保' ? '有擔保' : '無擔保';
    const condKey = `${theoKey}_${guarKey}`;
    const condStats = window.conditionStats?.[condKey] || null;

    // 優先使用近期數據，沒有則用全部數據
    const useRecent = condStats?.recentCount >= 5;
    const estBidMultiple = useRecent && condStats.recentAvgBidMultiple ? condStats.recentAvgBidMultiple : (condStats?.avgBidMultiple || 2.5);
    const estGain = useRecent && condStats.recentAvgGain !== null ? condStats.recentAvgGain : (condStats?.avgGain || 30);
    const estWinRate = useRecent && condStats.recentWinRate !== null ? condStats.recentWinRate : (condStats?.winRate || 0.7);
    const sampleCount = condStats?.count || 0;
    const recentCount = condStats?.recentCount || 0;

    // ========================================
    // 1. 同條件歷史獲利評分（權重30分）
    // ========================================
    let gainScore = 0;
    let gainNote = '';
    const condLabel = `${theoKey}×${guarKey}`;
    const dataSource = useRecent ? `近${recentCount}檔` : `${sampleCount}檔`;

    if (estGain >= 50) {
        gainScore = 30;
        gainNote = `${condLabel}歷史平均獲利${estGain.toFixed(0)}元，表現優異`;
    } else if (estGain >= 30) {
        gainScore = 25;
        gainNote = `${condLabel}歷史平均獲利${estGain.toFixed(0)}元，表現良好`;
    } else if (estGain >= 20) {
        gainScore = 18;
        gainNote = `${condLabel}歷史平均獲利${estGain.toFixed(0)}元，表現一般`;
    } else if (estGain >= 10) {
        gainScore = 12;
        gainNote = `${condLabel}歷史平均獲利${estGain.toFixed(0)}元，獲利空間有限`;
    } else {
        gainScore = 5;
        gainNote = `${condLabel}歷史平均獲利僅${estGain.toFixed(0)}元，風險較高`;
    }

    totalScore += gainScore;
    factors.push({
        name: '同條件歷史獲利',
        score: gainScore,
        maxScore: 30,
        value: `${estGain.toFixed(0)}元`,
        note: `${gainNote}（${dataSource}）`,
        positive: gainScore >= 18
    });

    // ========================================
    // 2. 同條件歷史勝率評分（權重25分）
    // ========================================
    let winScore = 0;
    let winNote = '';
    const winPct = estWinRate * 100;

    if (winPct >= 80) {
        winScore = 25;
        winNote = `${condLabel}歷史勝率${winPct.toFixed(0)}%，非常優秀`;
    } else if (winPct >= 70) {
        winScore = 20;
        winNote = `${condLabel}歷史勝率${winPct.toFixed(0)}%，表現良好`;
    } else if (winPct >= 60) {
        winScore = 15;
        winNote = `${condLabel}歷史勝率${winPct.toFixed(0)}%，中等水準`;
    } else if (winPct >= 50) {
        winScore = 10;
        winNote = `${condLabel}歷史勝率${winPct.toFixed(0)}%，略低於平均`;
    } else {
        winScore = 5;
        winNote = `${condLabel}歷史勝率僅${winPct.toFixed(0)}%，需謹慎評估`;
    }

    totalScore += winScore;
    factors.push({
        name: '同條件歷史勝率',
        score: winScore,
        maxScore: 25,
        value: `${winPct.toFixed(0)}%`,
        note: `${winNote}（${dataSource}）`,
        positive: winScore >= 15
    });

    // ========================================
    // 3. 理論價本身評分（權重20分）
    // ========================================
    let theoScore = 0;
    let theoNote = '';

    if (theoPrice < 95) {
        theoScore = 18;
        theoNote = '理論價<95，轉換價值低但下檔有債券保護';
    } else if (theoPrice < 100) {
        theoScore = 20;
        theoNote = '理論價95-100，風險報酬比最佳區間';
    } else if (theoPrice < 105) {
        theoScore = 18;
        theoNote = '理論價100-105，具轉換價值，風險可控';
    } else if (theoPrice < 110) {
        theoScore = 12;
        theoNote = '理論價105-110，股價已高於轉換價，需留意回檔';
    } else {
        theoScore = 6;
        theoNote = '理論價>=110，高度依賴股價維持，風險較高';
    }

    totalScore += theoScore;
    factors.push({
        name: '理論價',
        score: theoScore,
        maxScore: 20,
        value: `${theoPrice?.toFixed(1) || '-'}元`,
        note: theoNote,
        positive: theoScore >= 15
    });

    // ========================================
    // 4. 安全性評分（權重15分）- 擔保+信評
    // ========================================
    let safeScore = 0;
    let safeNote = '';

    // 擔保 (8分)
    if (guarantee === '有擔保') {
        safeScore += 8;
        safeNote = '有擔保';
    } else {
        safeScore += 4;
        safeNote = '無擔保';
    }

    // 信評 (7分)
    const tcriNum = parseInt(tcri) || 6;
    if (tcriNum <= 4) {
        safeScore += 7;
        safeNote += ' + 優良信評TCRI' + tcriNum;
    } else if (tcriNum <= 6) {
        safeScore += 5;
        safeNote += ' + 一般信評TCRI' + tcriNum;
    } else {
        safeScore += 2;
        safeNote += ' + 較差信評TCRI' + tcriNum;
    }

    totalScore += safeScore;
    factors.push({
        name: '安全性',
        score: safeScore,
        maxScore: 15,
        value: `${guarantee || '無擔保'} / TCRI${tcriNum}`,
        note: safeNote,
        positive: safeScore >= 10
    });

    // ========================================
    // 5. 市場環境評分（權重10分）
    // ========================================
    let timeScore = 0;
    let timeNote = '';

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentHalf = now.getMonth() < 6 ? 'H1' : 'H2';
    const currentPeriod = `${currentYear}${currentHalf}`;

    // 基於歷史數據：2024H2後整體勝率下降
    if (currentYear < 2024 || (currentYear === 2024 && currentHalf === 'H1')) {
        timeScore = 10;
        timeNote = '市場環境良好期';
    } else if (currentYear === 2024 && currentHalf === 'H2') {
        timeScore = 5;
        timeNote = '2024H2供給量大增，整體勝率約62%';
    } else {
        timeScore = 4;
        timeNote = `${currentPeriod}供給持續高位，整體勝率約55%`;
    }

    totalScore += timeScore;
    factors.push({
        name: '市場環境',
        score: timeScore,
        maxScore: 10,
        value: currentPeriod,
        note: timeNote,
        positive: timeScore >= 6
    });

    // ========================================
    // 同條件歷史數據參考（僅供參考，不計分）
    // ========================================
    factors.push({
        name: '同條件歷史投標倍數',
        score: '-',
        maxScore: '-',
        value: `${estBidMultiple.toFixed(1)}倍`,
        note: `條件：${condLabel}，${dataSource}平均，供出價策略參考`,
        positive: true,
        isReference: true
    });

    // ========================================
    // 綜合評價
    // ========================================
    let recommendation = '';
    let recommendColor = '';
    let recommendIcon = '';
    let summaryNote = '';

    const scorePercent = (totalScore / maxScore) * 100;

    if (scorePercent >= 75) {
        recommendation = '建議參與';
        recommendColor = '#22c55e';
        recommendIcon = '🟢';
        summaryNote = '歷史數據顯示同條件案件表現優異，建議積極參與';
    } else if (scorePercent >= 60) {
        recommendation = '可考慮參與';
        recommendColor = '#84cc16';
        recommendIcon = '🟡';
        summaryNote = '條件尚可，可根據個人風險偏好及資金配置決定';
    } else if (scorePercent >= 45) {
        recommendation = '謹慎評估';
        recommendColor = '#f97316';
        recommendIcon = '🟠';
        summaryNote = '部分條件不利，歷史表現一般，需審慎考量';
    } else {
        recommendation = '建議觀望';
        recommendColor = '#ef4444';
        recommendIcon = '🔴';
        summaryNote = '多項條件不利，歷史勝率偏低，建議暫時觀望';
    }

    // 找出主要利多和利空
    const scoredFactors = factors.filter(f => f.score !== '-');
    const positiveFactors = scoredFactors.filter(f => f.positive && f.score >= f.maxScore * 0.7);
    const negativeFactors = scoredFactors.filter(f => !f.positive && f.score < f.maxScore * 0.5);

    return {
        totalScore,
        maxScore,
        scorePercent: Math.round(scorePercent),
        recommendation,
        recommendColor,
        recommendIcon,
        summaryNote,
        factors,
        positiveFactors,
        negativeFactors,
        theoKey,
        condKey,
        estimates: {
            bidMultiple: estBidMultiple,
            gain: estGain,
            winRate: estWinRate,
            sampleCount,
            recentCount,
            useRecent
        },
        // v3.81: 加入快照ID供追蹤
        snapshotId: predictionSnapshot.id
    };
}

/**
 * 更新競拍評估顯示
 */
function updateAuctionEvaluation() {
    const container = document.getElementById('auctionEvaluation');
    if (!container) return;

    // 取得當前輸入值
    const stockPrice = safeFloat(document.getElementById('stockPrice')?.value);
    const convPrice = safeFloat(document.getElementById('actualConversionPrice')?.value);
    const guarantee = document.getElementById('guarantee')?.value || '無擔保';
    const tcri = document.getElementById('rating')?.value || '6';
    const broker = document.getElementById('broker')?.value || '';
    const industry = document.getElementById('industry')?.value || '';

    // 從發行規模區間解析數值
    const issueSizeStr = document.getElementById('issueSize')?.value || '';
    let issueSize = 5; // 預設
    if (issueSizeStr.includes('小於2億')) issueSize = 1.5;
    else if (issueSizeStr.includes('2~5億')) issueSize = 3.5;
    else if (issueSizeStr.includes('5~10億')) issueSize = 7.5;
    else if (issueSizeStr.includes('10~15億')) issueSize = 12.5;
    else if (issueSizeStr.includes('15~20億')) issueSize = 17.5;
    else if (issueSizeStr.includes('大於20億')) issueSize = 25;

    // 計算理論價
    let theoPrice = 0;
    let theoPriceSource = '';

    if (stockPrice > 0 && convPrice > 0) {
        theoPrice = (stockPrice / convPrice) * 100;
        theoPriceSource = '股價/轉換價計算';
    } else {
        // 嘗試從理論價區間獲取
        const theoRangeStr = document.getElementById('theoRange')?.value || '';
        theoPrice = getTheoRangeMidValue(theoRangeStr);
        if (theoPrice > 0) {
            theoPriceSource = '理論價區間估算';
        }
    }

    // v3.81 修正：沒有理論價就提醒用戶輸入，不用預設值
    if (!theoPrice || theoPrice <= 0) {
        container.innerHTML = `
            <div style="padding:15px; background:#fff9e6; border-radius:8px; border-left:4px solid #ff9800;">
                <div style="font-weight:bold; color:#e65100; margin-bottom:8px;">⚠️ 請補充股價和轉換價</div>
                <div style="font-size:12px; color:#666;">
                    系統需要股價和轉換價來計算理論價格，才能進行AI評估。<br><br>
                    <b>方式一：</b>在上方「競拍資料」區塊輸入：<br>
                    　• 截標日13:30收盤價<br>
                    　• 實際轉換價格<br><br>
                    <b>方式二：</b>直接選擇「理論價區間」
                </div>
                <div style="margin-top:10px; padding:8px; background:#e3f2fd; border-radius:6px; font-size:11px; color:#1565c0;">
                    💡 提醒：理論價 = (股價 ÷ 轉換價) × 100
                </div>
            </div>
        `;
        const liveContainer = document.getElementById('liveAIPrediction');
        if (liveContainer) {
            liveContainer.innerHTML = '<div style="color:#999; padding:10px; text-align:center;">等待輸入股價/轉換價...</div>';
        }
        return;
    }

    // 檢查是否有統計數據
    if (!window.conditionStats || Object.keys(window.conditionStats).length === 0) {
        container.innerHTML = '<div style="color:#666;padding:10px;">統計數據載入中，請稍候...</div>';
        // v3.73：統計數據載入中時，仍然嘗試顯示基於${totalAuctionCount}檔統計的預測
        updateLiveAIPrediction(theoPrice, issueSize, guarantee, broker, industry, tcri);
        return;
    }

    const result = evaluateAuctionOpportunity({
        theoPrice,
        guarantee,
        tcri,
        issueSize,
        broker,
        industry
    });

    // v3.81 新增：執行超級預測引擎（KNN + 蒙地卡羅）
    try {
        const years = parseInt(document.getElementById('years')?.value) || 3;
        runSuperPredictionEngine({
            theoPrice,
            issueSize,
            guarantee,
            years,
            industry,
            rating: tcri
        });
    } catch (e) {
        console.warn('超級預測引擎執行失敗:', e);
    }

    // 生成評估HTML
    let html = `
    <div style="background:linear-gradient(135deg, ${result.recommendColor}15, ${result.recommendColor}05); border:2px solid ${result.recommendColor}; border-radius:12px; padding:15px; margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-size:1.3em; font-weight:bold; color:${result.recommendColor};">
                ${result.recommendIcon} ${result.recommendation}
            </div>
            <div style="font-size:1.5em; font-weight:bold; color:${result.recommendColor};">
                ${result.totalScore}/${result.maxScore}分
            </div>
        </div>
        <div style="color:#666; font-size:0.9em;">${result.summaryNote}</div>
    </div>

    <div style="font-weight:bold; margin-bottom:8px; color:#333;">📊 各項評估明細</div>
    <table style="width:100%; border-collapse:collapse; font-size:0.85em;">
        <thead>
            <tr style="background:#f5f5f5;">
                <th style="padding:8px; text-align:left; border-bottom:1px solid #ddd;">評估項目</th>
                <th style="padding:8px; text-align:center; border-bottom:1px solid #ddd;">數值</th>
                <th style="padding:8px; text-align:center; border-bottom:1px solid #ddd;">得分</th>
                <th style="padding:8px; text-align:left; border-bottom:1px solid #ddd;">說明</th>
            </tr>
        </thead>
        <tbody>`;

    result.factors.forEach(f => {
        const isRef = f.isReference;
        const scoreColor = isRef ? '#666' : (f.positive ? '#22c55e' : (f.score < f.maxScore * 0.5 ? '#ef4444' : '#f97316'));
        const icon = isRef ? '📌' : (f.positive ? '✓' : (f.score < f.maxScore * 0.5 ? '✗' : '△'));
        const scoreText = isRef ? '參考' : `${f.score}/${f.maxScore}`;
        html += `
        <tr style="${isRef ? 'background:#f9fafb;' : ''}">
            <td style="padding:6px 8px; border-bottom:1px solid #eee;">${f.name}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #eee; text-align:center; font-weight:bold;">${f.value}</td>
            <td style="padding:6px 8px; border-bottom:1px solid #eee; text-align:center; color:${scoreColor}; font-weight:bold;">
                ${icon} ${scoreText}
            </td>
            <td style="padding:6px 8px; border-bottom:1px solid #eee; color:#666; font-size:0.9em;">${f.note}</td>
        </tr>`;
    });

    html += `</tbody></table>`;

    // 利多利空摘要
    if (result.positiveFactors.length > 0 || result.negativeFactors.length > 0) {
        html += `<div style="margin-top:12px; display:flex; gap:15px; flex-wrap:wrap;">`;

        if (result.positiveFactors.length > 0) {
            html += `<div style="flex:1; min-width:140px; background:#dcfce7; padding:10px; border-radius:8px;">
                <div style="font-weight:bold; color:#16a34a; margin-bottom:5px;">✅ 利多因素</div>
                <ul style="margin:0; padding-left:18px; color:#166534; font-size:0.85em;">
                    ${result.positiveFactors.map(f => `<li>${f.name}：${f.value}</li>`).join('')}
                </ul>
            </div>`;
        }

        if (result.negativeFactors.length > 0) {
            html += `<div style="flex:1; min-width:140px; background:#fee2e2; padding:10px; border-radius:8px;">
                <div style="font-weight:bold; color:#dc2626; margin-bottom:5px;">⚠️ 利空因素</div>
                <ul style="margin:0; padding-left:18px; color:#991b1b; font-size:0.85em;">
                    ${result.negativeFactors.map(f => `<li>${f.name}：${f.value}</li>`).join('')}
                </ul>
            </div>`;
        }

        html += `</div>`;
    }

    // 數據來源說明
    const est = result.estimates;
    html += `
    <div style="margin-top:12px; padding:10px; background:#f8fafc; border-radius:8px; font-size:0.8em; color:#64748b;">
        📈 <strong>數據來源：</strong>
        理論價${result.theoKey} + ${result.condKey.includes('有擔保') ? '有擔保' : '無擔保'}，
        共${est.sampleCount}筆歷史案例${est.useRecent ? `（優先採用近期${est.recentCount}筆）` : ''}。
        統計模型基於${window.overallStats?.totalSamples || totalAuctionCount}筆競拍數據。
    </div>`;

    container.innerHTML = html;

    // v3.73 新增：即時更新AI智能預測區塊
    updateLiveAIPrediction(theoPrice, issueSize, guarantee, broker, industry, tcri);
}

/**
 * v3.73 即時更新AI智能預測區塊（重新設計）
 * 核心改進：
 * 1. 以「年期+擔保」組合為基準
 * 2. 參考市場氛圍三條件加權（產業35%、規模25%、信評15%）
 * 3. 智能判別：理論價<100時改用「價格法」，>=100時用「溢價率法」
 * 4. 確保建議出價與預期最低得標一致
 */
function updateLiveAIPrediction(theoPrice, issueSize, guarantee, broker, industry, tcri) {
    const container = document.getElementById('liveAIPrediction');
    if (!container) return;

    if (!theoPrice || theoPrice <= 0) {
        container.innerHTML = '<div style="color:#666; padding:10px;">請填寫條件後即時顯示預測結果</div>';
        return;
    }

    // 取得底標價格和年期
    const floorPrice = safeFloat(document.getElementById('floorPrice')?.value) || 100;
    const years = parseInt(document.getElementById('years')?.value) || 3;
    const rating = tcri || document.getElementById('rating')?.value || '';

    // 確定擔保類型
    const guarType = guarantee === '有擔保' ? '有擔保' : '無擔保';

    // 調用投標倍數預估函數（已包含擔保類型基準）
    const multResult = estimateBidMultiple({
        issueSize: issueSize,
        guarantee: guarType,
        years: years,
        theoreticalPrice: theoPrice,
        industry: industry ? industry.split(' ')[0] : '',
        broker: broker ? broker.split(' ')[0] : '',
        rating: rating
    });

    // 查表取得預期得標價（這是核心預測）
    const priceExpect = getExpectedPriceByMult(multResult.estimatedMult);

    // ===== 智能判別：選擇計算方法 =====
    // v3.75 重新設計：三種策略基於「最低得標~平均得標」區間
    // 保守型 = 預期最低得標（門檻價，有機會得標）
    // 平衡型 = (最低+平均)/2（最佳性價比）
    // 積極型 = 預期平均得標（穩定得標）

    let aggressivePrice, balancedPrice, conservativePrice;
    let aggressivePremium, balancedPremium, conservativePremium;
    let calcMethod = '';
    let methodNote = '';

    // 核心數據：從投標倍數查表取得合理區間
    const expectedMinBid = priceExpect.minPrice;  // 預期最低得標（保守基準）
    const expectedAvgBid = priceExpect.avgPrice;  // 預期平均得標（積極基準）
    const priceGap = priceExpect.gap;             // 差距（約1.5-2元）

    // v3.81 修正：智能處理不同理論價情況
    // 核心原則：建議出價 >= max(底標, 理論價)，且三種策略要有合理差距
    const minBidFloor = Math.max(floorPrice, theoPrice);

    // 三種策略定義
    if (expectedMinBid >= theoPrice) {
        // 正常情況：查表價格 >= 理論價，直接使用查表結果
        conservativePrice = Math.max(expectedMinBid, floorPrice);
        aggressivePrice = Math.max(expectedAvgBid, floorPrice);
        balancedPrice = (conservativePrice + aggressivePrice) / 2;

        calcMethod = '查表法';
        methodNote = `投標倍數${multResult.estimatedMult.toFixed(2)}x對應歷史區間`;
    } else {
        // 高理論價情況：查表價格 < 理論價
        // v3.81 優化：回測發現100-110元區間得標率只有58.9%，需要更積極

        // 根據理論價區間調整縮減係數
        let scaleFactor = 0.5;  // 基礎縮減係數
        let extraPremium = 0;   // 額外溢價補償

        if (theoPrice >= 100 && theoPrice < 110) {
            // 100-110元區間：回測得標率最低，需要更積極
            scaleFactor = 0.7;  // 提高縮減係數
            extraPremium = 1.5; // 額外+1.5元
        } else if (theoPrice >= 110 && theoPrice < 115) {
            scaleFactor = 0.6;
            extraPremium = 1.0;
        } else if (theoPrice >= 115) {
            scaleFactor = 0.5;  // 超高理論價維持原邏輯
        }

        const histMinPremium = ((expectedMinBid / 100) - 1) * 100 * scaleFactor;
        const histAvgPremium = ((expectedAvgBid / 100) - 1) * 100 * scaleFactor;

        // 確保區間差距至少是 priceGap * 0.8
        const minSpread = priceGap * 0.8;

        conservativePrice = Math.max(theoPrice * (1 + histMinPremium / 100) + extraPremium, theoPrice, floorPrice);
        aggressivePrice = Math.max(
            theoPrice * (1 + histAvgPremium / 100) + extraPremium,
            conservativePrice + minSpread,
            floorPrice
        );
        balancedPrice = (conservativePrice + aggressivePrice) / 2;

        calcMethod = '溢價率法';
        methodNote = `理論價${theoPrice.toFixed(1)}元較高，套用優化溢價率`;
    }

    // 計算溢價率（相對於底標或理論價）
    const basePrice = Math.max(theoPrice, floorPrice);
    conservativePremium = ((conservativePrice / basePrice) - 1) * 100;
    balancedPremium = ((balancedPrice / basePrice) - 1) * 100;
    aggressivePremium = ((aggressivePrice / basePrice) - 1) * 100;

    // v3.75 保留排序確保順序正確（保守 < 平衡 < 積極）
    const priceArray = [
        { type: 'conservative', price: conservativePrice, premium: conservativePremium },
        { type: 'balanced', price: balancedPrice, premium: balancedPremium },
        { type: 'aggressive', price: aggressivePrice, premium: aggressivePremium }
    ].sort((a, b) => a.price - b.price);

    conservativePrice = priceArray[0].price;
    conservativePremium = priceArray[0].premium;
    balancedPrice = priceArray[1].price;
    balancedPremium = priceArray[1].premium;
    aggressivePrice = priceArray[2].price;
    aggressivePremium = priceArray[2].premium;

    // 熱度標籤
    const heatLevel = multResult.estimatedMult >= 3.5 ? '🔥熱門' : (multResult.estimatedMult >= 2.5 ? '⚡偏熱' : (multResult.estimatedMult >= 1.5 ? '😐一般' : '❄️冷門'));
    const heatColor = multResult.estimatedMult >= 3.5 ? '#ef4444' : (multResult.estimatedMult >= 2.5 ? '#f97316' : (multResult.estimatedMult >= 1.5 ? '#eab308' : '#22c55e'));

    // 擔保類型標籤顏色
    const guarColor = guarType === '有擔保' ? '#16a34a' : '#ea580c';
    const guarBg = guarType === '有擔保' ? '#dcfce7' : '#ffedd5';

    // 生成因子分析HTML（包含權重）
    let factorHTML = '';
    if (multResult.adjustments && multResult.adjustments.length > 0) {
        factorHTML = multResult.adjustments.map(adj => {
            const valueColor = adj.value > 0.1 ? '#16a34a' : (adj.value < -0.1 ? '#dc2626' : '#666');
            const sign = adj.value >= 0 ? '+' : '';
            return `
                <div style="display:flex; justify-content:space-between; padding:4px 8px; background:#f8fafc; border-radius:4px; margin-bottom:3px; font-size:11px;">
                    <span style="color:#666;">
                        <b>${adj.factor}</b>（${adj.weight}）：${adj.label}
                    </span>
                    <span style="color:${valueColor}; font-weight:bold;">
                        ${sign}${adj.value.toFixed(2)}倍
                        <span style="color:#999; font-size:10px;">(參考${adj.ref.toFixed(2)}x, n=${adj.count})</span>
                    </span>
                </div>`;
        }).join('');
    }

    // 計算方法說明
    const methodColor = calcMethod === '價格法' ? '#7c3aed' : '#059669';

    // 動態市場回饋提示
    let momentumBadge = '';
    if (multResult.momentumInfo) {
        const mColor = multResult.momentumInfo.adjustment > 0 ? '#dc2626' : '#0891b2';
        const mSign = multResult.momentumInfo.adjustment >= 0 ? '+' : '';
        momentumBadge = `
            <div style="background:${mColor}; padding:2px 8px; border-radius:10px; font-size:10px; margin-left:6px;">
                📡 ${multResult.momentumInfo.trend}
            </div>`;
    }

    // 生成HTML
    container.innerHTML = `
    ${multResult.momentumInfo ? `
    <!-- 動態市場回饋提示 -->
    <div style="background:linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); border:1px solid #e91e63; border-radius:8px; padding:8px 12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:11px; color:#880e4f;">
            📡 <b>動態回饋已啟用</b>：根據近 ${multResult.momentumInfo.sampleCount} 檔開標結果，市場氛圍 <b>${multResult.momentumInfo.trend}</b>
        </div>
        <div style="font-size:12px; font-weight:bold; color:#c2185b;">
            ${multResult.momentumInfo.adjustment >= 0 ? '↑' : '↓'} ${Math.abs(multResult.momentumInfo.adjustment * 100).toFixed(0)}%
        </div>
    </div>
    ` : ''}

    <!-- 預估投標倍數區塊 -->
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:10px; padding:14px; margin-bottom:12px; color:white;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-size:13px; opacity:0.9;">📊 預估投標倍數</div>
            <div style="display:flex; align-items:center;">
                <div style="background:rgba(255,255,255,0.2); padding:3px 10px; border-radius:15px; font-size:11px;">
                    ${priceExpect.range}
                </div>
                ${momentumBadge}
            </div>
        </div>
        <div style="display:flex; align-items:baseline; gap:6px;">
            <span style="font-size:36px; font-weight:bold;">${multResult.estimatedMult.toFixed(2)}</span>
            <span style="font-size:16px; opacity:0.8;">倍</span>
            <span style="background:${heatColor}; padding:2px 8px; border-radius:10px; font-size:12px; margin-left:8px;">
                ${heatLevel}
            </span>
        </div>
        <div style="font-size:12px; opacity:0.9; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.2);">
            合理區間：<b style="font-size:16px;">${expectedMinBid.toFixed(2)}</b> ~ <b style="font-size:16px;">${expectedAvgBid.toFixed(2)}</b> 元
            <span style="opacity:0.7; font-size:10px;">（${priceExpect.range}，差距${priceGap.toFixed(1)}元，n=${priceExpect.count}）</span>
        </div>
    </div>

    <!-- 因子調整分析 -->
    <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-size:12px; font-weight:bold; color:#334155;">
                🔬 投標倍數預估因子分析
            </div>
            <div style="font-size:10px; color:#666;">
                基準：<b style="color:${guarColor};">${guarType}+${years}年</b>
            </div>
        </div>
        ${factorHTML || '<div style="color:#999; font-size:11px;">填寫更多條件（產業、規模、信評等）以獲得更準確預估</div>'}
        <div style="border-top:1px solid #e2e8f0; margin-top:8px; padding-top:8px; font-size:10px; color:#64748b;">
            基準 <b>${window.TERM_GUAR_TABLE[multResult.baseKey]?.avgMult.toFixed(2) || '2.98'}</b>
            → 調整後 <b style="color:#6366f1;">${multResult.estimatedMult.toFixed(2)}</b> 倍
            <span style="float:right;">信心度：${multResult.confidence}</span>
        </div>
    </div>

    <!-- 建議出價 -->
    <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-size:12px; color:#166534;">
                <b>💰 建議出價區間</b>
            </div>
            <div style="font-size:10px; padding:2px 8px; background:${methodColor}20; color:${methodColor}; border-radius:10px;">
                ${calcMethod}
            </div>
        </div>
        <div style="font-size:10px; color:#666; margin-bottom:8px;">
            合理區間：<b>${expectedMinBid.toFixed(2)}</b> ~ <b>${expectedAvgBid.toFixed(2)}</b> 元（差距 ${priceGap.toFixed(2)} 元）
            <span style="color:${methodColor};">｜${methodNote}</span>
        </div>
        <div class="balance-grid-3col" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">
            <div style="text-align:center; padding:8px; background:#fef3c7; border-radius:6px;">
                <div style="font-size:10px; color:#b45309;">🛡️ 保守型</div>
                <div class="balance-number" style="font-size:18px; font-weight:bold; color:#b45309;">${conservativePrice.toFixed(2)}</div>
                <div style="font-size:9px; color:#666;">溢價 ${conservativePremium.toFixed(1)}%</div>
                <div style="font-size:9px; color:#b45309;">≈最低得標</div>
            </div>
            <div style="text-align:center; padding:8px; background:#dbeafe; border-radius:6px; border:2px solid #3b82f6;">
                <div style="font-size:10px; color:#1d4ed8;">⚖️ 平衡型 ⭐</div>
                <div class="balance-number" style="font-size:18px; font-weight:bold; color:#1d4ed8;">${balancedPrice.toFixed(2)}</div>
                <div style="font-size:9px; color:#666;">溢價 ${balancedPremium.toFixed(1)}%</div>
                <div style="font-size:9px; color:#1d4ed8;">最佳性價比</div>
            </div>
            <div style="text-align:center; padding:8px; background:#dcfce7; border-radius:6px;">
                <div style="font-size:10px; color:#166534;">🎯 積極型</div>
                <div class="balance-number" style="font-size:18px; font-weight:bold; color:#15803d;">${aggressivePrice.toFixed(2)}</div>
                <div style="font-size:9px; color:#666;">溢價 ${aggressivePremium.toFixed(1)}%</div>
                <div style="font-size:9px; color:#16a34a;">≈平均得標</div>
            </div>
        </div>
        <div style="margin-top:10px; padding:8px; background:#eff6ff; border-radius:6px; font-size:10px; color:#1e40af;">
            💡 <b>策略邏輯</b>：保守=最低得標門檻 / 平衡=中間值（推薦） / 積極=平均得標｜
            區間差 ${priceGap.toFixed(2)} 元可作為學習參考
        </div>
        ${window.SPREAD_STATS ? `
        <div style="margin-top:8px; padding:8px; background:linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius:6px; font-size:10px; color:#2e7d32;">
            📊 <b>價差參考</b>：歷史${window.SPREAD_STATS.total}檔平均價差 <b>${window.SPREAD_STATS.avgSpread.toFixed(2)}元</b>（中位數${window.SPREAD_STATS.medianSpread.toFixed(2)}元）
            ${(() => {
                const ss = window.SPREAD_STATS;
                let sizeKey = 'over15';
                if (issueSize < 3) sizeKey = 'under3';
                else if (issueSize < 5) sizeKey = '3to5';
                else if (issueSize < 10) sizeKey = '5to10';
                else if (issueSize < 15) sizeKey = '10to15';
                const sizeSpread = ss.bySize[sizeKey];
                if (sizeSpread && sizeSpread.avg) {
                    return `｜同規模(${sizeSpread.label})：<b>${sizeSpread.avg.toFixed(2)}元</b>(n=${sizeSpread.count})`;
                }
                return '';
            })()}
        </div>
        ` : ''}
    </div>
    `;

    // v3.97-cu: step3AIBlock已移除，改用新的Step 3 AI智能預測模組

    // v3.75 新增：同步更新主力模擬出價（傳入完整條件參數）
    updateMajorPlayerSimulation({
        theoPrice: theoPrice,
        expectedMinBid: expectedMinBid,
        expectedAvgBid: expectedAvgBid,
        priceGap: priceGap,
        estimatedMult: multResult.estimatedMult,
        issueSize: issueSize,
        guarantee: guarType,
        industry: industry,
        broker: broker,
        rating: rating,
        years: years,
        adjustments: multResult.adjustments  // 傳入因子調整明細
    });
}

/**
 * v3.75 重新設計：智能主力模擬出價（根據條件動態調整）
 * 核心發現：
 * 1. 94%情況下，主力最低出價與最低得標差距 <0.5元
 * 2. 主力之間價差與主力數量相關：1-2筆→0.76元, 3-5筆→1.58元, 6-10筆→2.73元, 10+→4.70元
 * 3. 發行規模、產業、理論價等條件會影響主力競爭程度
 */
function updateMajorPlayerSimulation(params) {
    const container = document.getElementById('majorPlayerSimulation');
    if (!container) return;

    // 解構參數
    const {
        theoPrice = 0,
        expectedMinBid = 0,
        expectedAvgBid = 0,
        priceGap = 2,
        estimatedMult = 2.5,
        issueSize = 0,
        guarantee = '無擔保',
        industry = '',
        broker = '',
        rating = '',
        years = 3,
        adjustments = []
    } = params || {};

    if (!theoPrice || theoPrice <= 0 || !expectedMinBid || expectedMinBid <= 0) {
        container.innerHTML = '<div style="color:#666; padding:10px; text-align:center;">請先輸入理論價區間或股價/轉換價</div>';
        return;
    }

    // 計算實際平均得標（如果沒傳入就用最低得標+2）
    const actualAvgBid = expectedAvgBid > 0 ? expectedAvgBid : expectedMinBid + 2;

    // ===== 主力出價基礎模型（基於75檔歷史數據）=====
    const MAJOR_MODEL = {
        minBidOffset: { mean: 0.18, median: 0.03, pct94: 0.5 },
        priceSpread: {
            low: { range: '1-2筆', spread: 0.76, avgQty: 305, label: '冷門' },
            mid: { range: '3-5筆', spread: 1.58, avgQty: 1390, label: '一般' },
            high: { range: '6-10筆', spread: 2.73, avgQty: 1835, label: '熱門' },
            veryHigh: { range: '10+筆', spread: 4.70, avgQty: 6694, label: '超熱門' }
        }
    };

    // ===== 根據各維度條件動態調整主力數量預測 =====
    let baseLevel = 'mid';  // 基準：一般熱度
    let adjustmentFactors = [];
    let spreadAdjustment = 0;  // 價差調整（元）
    let qtyAdjustment = 1.0;   // 數量調整係數

    // 1. 發行規模影響（小規模更熱門）
    if (issueSize > 0) {
        if (issueSize < 5) {
            adjustmentFactors.push({ factor: '發行規模', label: `${issueSize}億（小規模）`, effect: '+熱度', color: '#ef4444' });
            spreadAdjustment += 0.5;
            qtyAdjustment *= 1.3;
        } else if (issueSize >= 5 && issueSize < 10) {
            adjustmentFactors.push({ factor: '發行規模', label: `${issueSize}億（中規模）`, effect: '中性', color: '#f59e0b' });
        } else if (issueSize >= 10) {
            adjustmentFactors.push({ factor: '發行規模', label: `${issueSize}億（大規模）`, effect: '-熱度', color: '#22c55e' });
            spreadAdjustment -= 0.3;
            qtyAdjustment *= 0.8;
        }
    }

    // 2. 理論價影響（高理論價更熱門）
    if (theoPrice >= 130) {
        adjustmentFactors.push({ factor: '理論價', label: `${theoPrice.toFixed(1)}（深度價內）`, effect: '+熱度', color: '#ef4444' });
        spreadAdjustment += 0.8;
        qtyAdjustment *= 1.4;
    } else if (theoPrice >= 110) {
        adjustmentFactors.push({ factor: '理論價', label: `${theoPrice.toFixed(1)}（價內）`, effect: '+熱度', color: '#f97316' });
        spreadAdjustment += 0.4;
        qtyAdjustment *= 1.2;
    } else if (theoPrice < 95) {
        adjustmentFactors.push({ factor: '理論價', label: `${theoPrice.toFixed(1)}（價外）`, effect: '-熱度', color: '#22c55e' });
        spreadAdjustment -= 0.4;
        qtyAdjustment *= 0.7;
    } else {
        adjustmentFactors.push({ factor: '理論價', label: `${theoPrice.toFixed(1)}（平價區）`, effect: '中性', color: '#f59e0b' });
    }

    // 3. 產業影響
    const hotIndustries = ['電子', '半導體', 'IC設計', 'AI', '網通'];
    const coldIndustries = ['傳產', '營建', '金融', '航運'];
    const industryName = industry ? industry.split(' ')[0] : '';

    if (industryName && hotIndustries.some(h => industryName.includes(h))) {
        adjustmentFactors.push({ factor: '產業', label: `${industryName}（熱門產業）`, effect: '+熱度', color: '#ef4444' });
        spreadAdjustment += 0.3;
        qtyAdjustment *= 1.15;
    } else if (industryName && coldIndustries.some(c => industryName.includes(c))) {
        adjustmentFactors.push({ factor: '產業', label: `${industryName}（冷門產業）`, effect: '-熱度', color: '#22c55e' });
        spreadAdjustment -= 0.2;
        qtyAdjustment *= 0.9;
    } else if (industryName) {
        adjustmentFactors.push({ factor: '產業', label: `${industryName}`, effect: '中性', color: '#f59e0b' });
    }

    // 4. 擔保類型影響
    if (guarantee === '有擔保') {
        adjustmentFactors.push({ factor: '擔保', label: '有擔保', effect: '-熱度', color: '#22c55e' });
        spreadAdjustment -= 0.2;
        qtyAdjustment *= 0.85;
    } else {
        adjustmentFactors.push({ factor: '擔保', label: '無擔保', effect: '中性', color: '#f59e0b' });
    }

    // ===== 根據投標倍數確定基礎熱度級別 =====
    if (estimatedMult < 1.5) {
        baseLevel = 'low';
    } else if (estimatedMult < 2.5) {
        baseLevel = 'mid';
    } else if (estimatedMult < 4) {
        baseLevel = 'high';
    } else {
        baseLevel = 'veryHigh';
    }

    const baseSpreadInfo = MAJOR_MODEL.priceSpread[baseLevel];

    // ===== 計算調整後的主力出價區間 =====
    const adjustedSpread = Math.max(0.5, baseSpreadInfo.spread + spreadAdjustment);
    const adjustedAvgQty = Math.round(baseSpreadInfo.avgQty * qtyAdjustment);

    const majorLowBid = expectedMinBid + MAJOR_MODEL.minBidOffset.median;
    const majorHighBid = majorLowBid + adjustedSpread;
    const majorMidBid = (majorLowBid + majorHighBid) / 2;

    const lowPremium = ((majorLowBid / theoPrice) - 1) * 100;
    const highPremium = ((majorHighBid / theoPrice) - 1) * 100;
    const midPremium = ((majorMidBid / theoPrice) - 1) * 100;

    // 競爭程度顏色
    let heatColor, heatBg, heatLabel;
    if (estimatedMult < 1.5) {
        heatColor = '#22c55e'; heatBg = '#dcfce7'; heatLabel = '冷門';
    } else if (estimatedMult < 2.5) {
        heatColor = '#f59e0b'; heatBg = '#fef3c7'; heatLabel = '一般';
    } else if (estimatedMult < 4) {
        heatColor = '#f97316'; heatBg = '#fed7aa'; heatLabel = '熱門';
    } else {
        heatColor = '#dc2626'; heatBg = '#fee2e2'; heatLabel = '超熱門';
    }

    // 生成條件影響因子HTML
    let factorHTML = adjustmentFactors.map(f => `
        <div style="display:flex; justify-content:space-between; padding:4px 8px; background:#f8fafc; border-radius:4px; margin-bottom:3px;">
            <span style="color:#666;"><b>${f.factor}</b>：${f.label}</span>
            <span style="color:${f.color}; font-weight:bold;">${f.effect}</span>
        </div>
    `).join('');

    container.innerHTML = `
    <!-- 主力出價區間圖示 -->
    <div style="background:linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color:white; padding:12px; border-radius:8px; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div>
                <div style="font-size:11px; opacity:0.9;">預估主力數量</div>
                <div style="font-size:14px; font-weight:bold;">${baseSpreadInfo.range}（${heatLabel}）</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:11px; opacity:0.9;">預估主力總張數</div>
                <div style="font-size:14px; font-weight:bold;">${adjustedAvgQty.toLocaleString()} 張</div>
            </div>
        </div>
        <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:6px;">
            <div style="font-size:11px; opacity:0.8; margin-bottom:6px;">🎯 主力出價區間（根據本檔條件動態調整）</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:center;">
                    <div style="font-size:10px; opacity:0.7;">最低出價</div>
                    <div style="font-size:20px; font-weight:bold;">${majorLowBid.toFixed(2)}</div>
                    <div style="font-size:10px; opacity:0.7;">溢價 ${lowPremium.toFixed(1)}%</div>
                </div>
                <div style="flex:1; padding:0 15px;">
                    <div style="height:8px; background:linear-gradient(to right, #8e24aa, #e91e63); border-radius:4px; position:relative;">
                        <div style="position:absolute; left:50%; transform:translateX(-50%); top:-15px; font-size:9px; white-space:nowrap;">
                            價差 ${adjustedSpread.toFixed(2)}元
                        </div>
                    </div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:10px; opacity:0.7;">最高出價</div>
                    <div style="font-size:20px; font-weight:bold;">${majorHighBid.toFixed(2)}</div>
                    <div style="font-size:10px; opacity:0.7;">溢價 ${highPremium.toFixed(1)}%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- v3.75 新增：條件影響因子 -->
    <div style="background:#f3e5f5; border:1px solid #ce93d8; border-radius:8px; padding:10px; margin-bottom:10px;">
        <div style="font-size:12px; font-weight:bold; color:#7b1fa2; margin-bottom:8px;">📊 條件影響因子（動態調整依據）</div>
        ${factorHTML}
        <div style="margin-top:6px; padding-top:6px; border-top:1px dashed #ce93d8; font-size:10px; color:#666;">
            💡 基礎價差：${baseSpreadInfo.spread.toFixed(2)}元 → 調整後：${adjustedSpread.toFixed(2)}元（${spreadAdjustment >= 0 ? '+' : ''}${spreadAdjustment.toFixed(2)}元）
        </div>
    </div>

    <!-- 主力行為解讀 -->
    <div style="background:${heatBg}; border:1px solid ${heatColor}40; border-radius:8px; padding:10px; margin-bottom:10px;">
        <div style="font-size:12px; font-weight:bold; color:${heatColor}; margin-bottom:6px;">📈 主力行為解讀</div>
        <div style="font-size:11px; color:#333; line-height:1.6;">
            • <b>核心發現</b>：主力最低出價 ≈ 最低得標價（94%差距<0.5元）<br>
            • <b>競爭邏輯</b>：小規模、高理論價、熱門產業 → 主力競爭激烈 → 價差較大<br>
            • <b>本檔預測</b>：${heatLabel}標的，調整後價差約 ${adjustedSpread.toFixed(2)} 元
        </div>
    </div>

    <!-- 散戶策略建議 -->
    <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px;">
        <div style="font-size:12px; font-weight:bold; color:#475569; margin-bottom:6px;">💡 散戶策略建議</div>
        <div style="font-size:11px; color:#666; line-height:1.6;">
            ${estimatedMult < 2 ?
            `• 冷門標的：主力少、價差小，可考慮出價接近 <b style="color:#9c27b0;">${majorLowBid.toFixed(2)}</b> 元<br>
             • 落標風險較低，價格控制空間較大` :
            estimatedMult < 3.5 ?
            `• 中等熱度：建議出價在 <b style="color:#9c27b0;">${majorMidBid.toFixed(2)}</b> 元左右<br>
             • 主力競爭適中，需預留價差空間` :
            `• 超熱門標的：主力競爭激烈，建議出價接近 <b style="color:#9c27b0;">${majorHighBid.toFixed(2)}</b> 元<br>
             • 若堅持低價可能落標，需評估是否值得追高`}
        </div>
        <div style="margin-top:8px; padding-top:8px; border-top:1px dashed #e2e8f0; font-size:10px; color:#94a3b8;">
            📈 合理區間：${expectedMinBid.toFixed(2)} ~ ${actualAvgBid.toFixed(2)} 元 ｜ 預估倍數：${estimatedMult.toFixed(2)}x
        </div>
    </div>
    `;
}

/**
 * 取得理論價區間key
 */
function getTheoPriceKey(theoPrice) {
    if (theoPrice < 90) return '小於90元';
    if (theoPrice < 95) return '90~95元';
    if (theoPrice < 100) return '95~100元';
    if (theoPrice < 105) return '100~105元';
    if (theoPrice < 110) return '105~110元';
    if (theoPrice < 115) return '110~115元';
    return '大於115元';
}

/**
 * 根據基礎價格計算實際投標價格
 * v3.72 修正：基礎價格 = max(底標, 理論價)
 * @param {number} theoPrice - 理論價格
 * @param {number} premium - 溢價%（相對於基礎價）
 * @param {number} floorPrice - 底標價格
 * @returns {number} 投標價格
 */
function calcMajorBidPrice(theoPrice, premium, floorPrice) {
    // 基礎價 = max(理論價, 底標)
    const basePrice = Math.max(theoPrice, floorPrice);
    // 投標價 = 基礎價 × (1 + 溢價%)
    const bidPrice = basePrice * (1 + premium / 100);
    return Math.round(bidPrice * 100) / 100;
}

/**
 * 生成主力模擬出價面板HTML
 * v3.73 重寫：基於理論價的主力模擬
 * @param {object} mpResult - 主力預測結果
 * @param {number} floorPrice - 底標價格
 * @param {number} theoPrice - 理論價格
 * @returns {string} HTML字串
 */
function generateMajorPlayerHTML(mpResult, floorPrice, theoPrice, guarantee) {
    if (!mpResult) return '';

    const fp = parseFloat(floorPrice) || 100;
    const tp = parseFloat(theoPrice) || mpResult.theoPrice || 100;

    // v3.75：確保價格順序正確（保守 < 平衡 < 積極）
    let rawPrices = [
        { type: 'conservative', price: Math.max(mpResult.conservativePrice || fp, fp), premium: mpResult.conservativePremium || 0 },
        { type: 'balanced', price: Math.max(mpResult.balancedPrice || fp, fp), premium: mpResult.balancedPremium || 0 },
        { type: 'aggressive', price: Math.max(mpResult.aggressivePrice || fp, fp), premium: mpResult.aggressivePremium || 0 }
    ].sort((a, b) => a.price - b.price);

    // 排序後重新賦值：最低=保守，中間=平衡，最高=積極
    const conservativePrice = rawPrices[0].price;
    const conservativePremium = rawPrices[0].premium;
    const balancedPrice = rawPrices[1].price;
    const balancedPremium = rawPrices[1].premium;
    const aggressivePrice = rawPrices[2].price;
    const aggressivePremium = rawPrices[2].premium;

    // 信心度樣式
    const confClass = mpResult.confidence === '高' ? 'high' : (mpResult.confidence === '中' ? 'medium' : 'low');
    const confIcon = mpResult.confidence === '高' ? '⭐⭐⭐' : (mpResult.confidence === '中' ? '⭐⭐' : '⭐');

    // 熱度標籤顏色
    const heatColor = mpResult.heatColor || '#eab308';

    // 生成因子分析HTML
    let factorHTML = '';
    if (mpResult.adjustments && mpResult.adjustments.length > 0) {
        factorHTML = mpResult.adjustments.map(adj => {
            const valueColor = adj.value > 0.1 ? '#22c55e' : (adj.value < -0.1 ? '#ef4444' : '#666');
            const sign = adj.value >= 0 ? '+' : '';
            return `
                <div style="display:flex; justify-content:space-between; padding:4px 8px; background:#f8fafc; border-radius:4px; margin-bottom:4px;">
                    <span style="color:#666;">${adj.factor}：<b>${adj.label}</b></span>
                    <span style="color:${valueColor}; font-weight:bold;">${sign}${adj.value.toFixed(2)}倍 <span style="color:#999; font-size:10px;">(參考${adj.ref?.toFixed(2) || '-'}x, n=${adj.count})</span></span>
                </div>`;
        }).join('');
    }

    const html = `
    <div class="major-player-panel">
        <div class="major-player-header">
            🎯 v3.73 AI智能競拍預測
            <span style="float:right; font-size:12px; font-weight:normal;">${mpResult.dataSource || '基於${totalAuctionCount}檔競拍統計'}</span>
        </div>
        <div class="major-player-content">
            <!-- 投標倍數預估區塊（核心新功能） -->
            <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; padding:16px; margin-bottom:15px; color:white;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="font-size:14px; opacity:0.9;">📊 預估投標倍數</div>
                    <div style="background:rgba(255,255,255,0.2); padding:4px 12px; border-radius:20px; font-size:12px;">
                        ${mpResult.multRange || '2-3倍'}
                    </div>
                </div>
                <div style="display:flex; align-items:baseline; gap:8px;">
                    <span style="font-size:42px; font-weight:bold;">${mpResult.estimatedMult?.toFixed(2) || '2.98'}</span>
                    <span style="font-size:20px; opacity:0.8;">倍</span>
                    <span style="background:${heatColor}; padding:3px 10px; border-radius:12px; font-size:13px; margin-left:10px;">
                        ${mpResult.heatLevel || '一般'}
                    </span>
                </div>
                <div style="font-size:12px; opacity:0.8; margin-top:8px;">
                    合理區間：<b style="font-size:16px;">${mpResult.expectedMinBid?.toFixed(2) || '106.43'}</b> ~ <b style="font-size:16px;">${mpResult.expectedAvgBid?.toFixed(2) || '108.51'}</b> 元
                    <span style="opacity:0.7;">（差距 ${mpResult.priceGap?.toFixed(2) || '2'}元）</span>
                </div>
            </div>

            <!-- 因子分析明細 -->
            <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:12px; margin-bottom:15px;">
                <div style="font-size:13px; font-weight:bold; color:#334155; margin-bottom:10px;">
                    🔬 投標倍數預估因子分析
                </div>
                ${factorHTML || '<div style="color:#999; font-size:12px;">無可用因子數據</div>'}
                <div style="border-top:1px solid #e2e8f0; margin-top:8px; padding-top:8px; font-size:11px; color:#64748b;">
                    基準倍數 2.98（${totalAuctionCount}檔平均）→ 預估 <b style="color:#6366f1;">${mpResult.estimatedMult?.toFixed(2) || '2.98'}</b> 倍
                </div>
            </div>

            <!-- 建議出價區塊（v3.75 重新設計）-->
            <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:12px; margin-bottom:15px;">
                <div style="font-size:13px; color:#166534; margin-bottom:8px;">
                    <b>💰 建議出價區間</b>（基於 ${mpResult.multRange || '2-3倍'} 歷史數據，n=${mpResult.histSampleCount || '-'}）
                </div>
                <div style="display:flex; gap:20px; flex-wrap:wrap; font-size:12px; margin-bottom:10px;">
                    <div>
                        <span style="color:#666;">最低得標：</span>
                        <b style="color:#b45309;">${mpResult.expectedMinBid?.toFixed(2) || '-'} 元</b>
                    </div>
                    <div>
                        <span style="color:#666;">平均得標：</span>
                        <b style="color:#16a34a;">${mpResult.expectedAvgBid?.toFixed(2) || '-'} 元</b>
                    </div>
                    <div>
                        <span style="color:#666;">區間差距：</span>
                        <b style="color:#7c3aed;">${mpResult.priceGap?.toFixed(2) || '-'} 元</b>
                    </div>
                </div>
            </div>

            <div class="major-player-main">
                <div class="major-player-strategies" style="width:100%;">
                    <div class="mp-strategy-grid">
                        <div class="mp-strategy-card safe">
                            <h5>🛡️ 保守型</h5>
                            <div class="mp-price">${conservativePrice.toFixed(2)}</div>
                            <div class="mp-rate">溢價 ${conservativePremium.toFixed(2)}%</div>
                            <div class="mp-rate" style="color:#f59e0b; font-size:11px;">≈最低得標</div>
                        </div>
                        <div class="mp-strategy-card stable">
                            <h5>⚖️ 平衡型</h5>
                            <div class="mp-price">${balancedPrice.toFixed(2)}</div>
                            <div class="mp-rate">溢價 ${balancedPremium.toFixed(2)}%</div>
                            <div class="mp-rate" style="color:#3b82f6; font-size:11px;">最佳性價比</div>
                        </div>
                        <div class="mp-strategy-card sniper">
                            <h5>🎯 積極型</h5>
                            <div class="mp-price">${aggressivePrice.toFixed(2)}</div>
                            <div class="mp-rate">溢價 ${aggressivePremium.toFixed(2)}%</div>
                            <div class="mp-rate" style="color:#22c55e; font-size:11px;">≈平均得標</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mp-confidence-bar ${confClass}">
                <span style="font-weight:bold;">預測信心度：${mpResult.confidence} ${confIcon}</span>
                <span style="margin-left:15px; font-size:12px;">
                    ${mpResult.confidence === '高' ? '多因子樣本充足，預測較可靠' :
                      mpResult.confidence === '中' ? '部分因子樣本較少，可作參考' :
                      '樣本不足，建議謹慎參考'}
                </span>
            </div>

            <div style="background:#fef3c7; border-radius:8px; padding:12px; margin-top:12px;">
                <div style="font-size:13px; font-weight:bold; color:#92400e; margin-bottom:8px;">💡 策略邏輯說明</div>
                <ul style="margin:0; padding-left:18px; color:#78350f; font-size:12px; line-height:1.6;">
                    <li><b>保守型</b> = 預期最低得標（門檻價，有機會得標但可能落標）</li>
                    <li><b>平衡型</b> = (最低+平均)/2（最佳性價比，推薦）</li>
                    <li><b>積極型</b> = 預期平均得標（穩定得標，成本較高）</li>
                    <li>區間差距約 ${mpResult.priceGap?.toFixed(1) || '1.5-2'} 元，可作為動態學習參考</li>
                </ul>
            </div>
        </div>
    </div>`;

    return html;
}

/**
 * 更新得標機率計算器
 * v3.72 修正：以理論價為基礎計算溢價，區分有擔保/無擔保
 */
function updateWinRateCalc(theoPrice, floorPrice, predictedPremium, guarantee) {
    const bidPrice = parseFloat(document.getElementById('mpUserBidPrice').value) || floorPrice;
    const basePrice = Math.max(theoPrice, floorPrice);
    // 溢價是相對於基礎價計算的
    const userPremium = ((bidPrice / basePrice) - 1) * 100;
    const result = estimateWinRate(userPremium, predictedPremium);

    const resultEl = document.getElementById('mpWinRateResult');
    if (resultEl) {
        resultEl.style.background = result.color;
        resultEl.textContent = `預估機率: ${result.rate}`;
    }

    // 更新出價風險評估（區分有擔保/無擔保）
    updateBidRiskAssessment(userPremium, theoPrice, guarantee || '無擔保');
}

/**
 * 出價風險評估函數
 * v3.72 修改：改用動態計算的統計數據
 * 基於歷史CB競拍統計，區分有擔保/無擔保，計算用戶出價在歷史數據中的位置
 * @param {number} userPremium - 用戶的溢價%
 * @param {number} theoPrice - 理論價格
 * @param {string} guarantee - 擔保類型（有擔保/無擔保）
 */
function updateBidRiskAssessment(userPremium, theoPrice, guarantee) {
    // v3.72 使用動態計算的統計數據
    const guaranteedStats = window.guaranteedStats || {};
    const unguaranteedStats = window.unguaranteedStats || {};

    // 判斷理論價區間
    let theoKey = '>=110';
    if (theoPrice < 95) theoKey = '<95';
    else if (theoPrice < 100) theoKey = '95-100';
    else if (theoPrice < 105) theoKey = '100-105';
    else if (theoPrice < 110) theoKey = '105-110';

    // 根據擔保類型選擇統計表
    const isGuaranteed = guarantee === '有擔保';
    const statsTable = isGuaranteed ? guaranteedStats : unguaranteedStats;

    // 預設統計值（當沒有動態數據時使用）
    const defaultStats = { mean: 5.0, std: 5.0, n: 0, p10: 0, p25: 1, p50: 5, p75: 9, p90: 12 };
    const stats = statsTable[theoKey] || defaultStats;
    const guarLabel = isGuaranteed ? '有擔保' : '無擔保';

    // 計算Z-score（偏離均值幾個標準差）
    const zScore = (userPremium - stats.mean) / stats.std;
    const absZ = Math.abs(zScore);

    // 計算百分位位置
    let percentile = 50;
    let riskLevel = '中等';
    let riskColor = '#eab308';
    let riskIcon = '⚖️';
    let riskNote = '';

    if (userPremium <= stats.p10) {
        percentile = 10;
        riskLevel = '極低';
        riskColor = '#22c55e';
        riskIcon = '✅';
        riskNote = '出價位於歷史最低10%，得標機率較低但風險可控';
    } else if (userPremium <= stats.p25) {
        percentile = 25;
        riskLevel = '偏低';
        riskColor = '#84cc16';
        riskIcon = '👍';
        riskNote = '出價位於歷史25%分位，得標機率中低';
    } else if (userPremium <= stats.p50) {
        percentile = 50;
        riskLevel = '中等偏低';
        riskColor = '#eab308';
        riskIcon = '⚖️';
        riskNote = '出價接近歷史中位數，風險與機會均衡';
    } else if (userPremium <= stats.p75) {
        percentile = 75;
        riskLevel = '中等偏高';
        riskColor = '#f97316';
        riskIcon = '⚠️';
        riskNote = '出價高於75%的歷史案例，得標機率較高但風險增加';
    } else if (userPremium <= stats.p90) {
        percentile = 90;
        riskLevel = '偏高';
        riskColor = '#ef4444';
        riskIcon = '🔺';
        riskNote = '出價位於歷史前10%高位，風險較高';
    } else {
        percentile = 95;
        riskLevel = '極高';
        riskColor = '#dc2626';
        riskIcon = '🚨';
        riskNote = '出價超過90%的歷史案例！極高風險，請審慎評估';
    }

    // Z-score風險補充說明
    let zScoreNote = '';
    if (absZ > 2) {
        zScoreNote = `<div style="background:#fef2f2; padding:6px 10px; border-radius:4px; margin-top:8px; font-size:11px; color:#dc2626;">
            <strong>⚠️ 極端偏離警示：</strong>偏離均值 ${absZ.toFixed(1)} 個標準差（${zScore > 0 ? '高於' : '低於'}均值 ${Math.abs(userPremium - stats.mean).toFixed(1)}%）
        </div>`;
    } else if (absZ > 1.5) {
        zScoreNote = `<div style="background:#fffbeb; padding:6px 10px; border-radius:4px; margin-top:8px; font-size:11px; color:#d97706;">
            <strong>⚡ 注意：</strong>偏離均值 ${absZ.toFixed(1)} 個標準差，價格${zScore > 0 ? '偏高' : '偏低'}
        </div>`;
    }

    // 更新UI
    const riskEl = document.getElementById('mpRiskAssessment');
    if (riskEl) {
        riskEl.innerHTML = `
            <div style="display:flex; align-items:flex-start; gap:10px;">
                <span style="font-size:24px;">${riskIcon}</span>
                <div style="flex:1;">
                    <div style="font-weight:bold; color:${riskColor}; font-size:14px;">
                        價格位置：${riskLevel}（第${percentile}百分位）
                    </div>
                    <div style="font-size:12px; color:#666; margin-top:4px;">
                        ${riskNote}
                    </div>
                    <div style="font-size:11px; color:#888; margin-top:6px; padding:6px 0; border-top:1px solid #e5e7eb;">
                        📊 同條件（${guarLabel}，${theoKey}，${stats.n}檔）：均值 ${stats.mean.toFixed(1)}% ± ${stats.std.toFixed(1)}%
                        <br>
                        📈 百分位：P25=${stats.p25.toFixed(1)}% | P50=${stats.p50.toFixed(1)}% | P75=${stats.p75.toFixed(1)}% | P90=${stats.p90.toFixed(1)}%
                    </div>
                    ${zScoreNote}
                </div>
            </div>
        `;
        riskEl.style.borderLeft = `4px solid ${riskColor}`;
    }
}

/**
 * 查找同類案件（用於統計顯示）
 * 注意：這是舊版函數，用於生成同類案件統計HTML
 * @param {Object} params - 查詢參數
 * @returns {Object} 同類案件統計
 */
function findSimilarCasesForStats(params) {
    const { theoreticalPrice, issueSize, industry } = params;

    if (!auctionRawData || auctionRawData.length === 0) {
        return { cases: [], stats: null };
    }

    // 定義理論價區間
    let theoMin, theoMax;
    if (theoreticalPrice >= 105) {
        theoMin = 105; theoMax = 999;
    } else if (theoreticalPrice >= 95) {
        theoMin = 95; theoMax = 105;
    } else if (theoreticalPrice >= 85) {
        theoMin = 85; theoMax = 95;
    } else {
        theoMin = 0; theoMax = 85;
    }

    // 定義發行規模區間
    let sizeMin, sizeMax;
    if (issueSize < 5) {
        sizeMin = 0; sizeMax = 5;
    } else if (issueSize < 10) {
        sizeMin = 5; sizeMax = 10;
    } else if (issueSize < 15) {
        sizeMin = 10; sizeMax = 15;
    } else {
        sizeMin = 15; sizeMax = 999;
    }

    // 篩選同類案件
    let similarCases = auctionRawData.filter(d => {
        const theo = d.theoreticalPrice || 0;
        const size = d.issueSize || 0;
        const matchTheo = theo >= theoMin && theo < theoMax;
        const matchSize = size >= sizeMin && size < sizeMax;
        return matchTheo && matchSize && d.avgPremium !== null && d.avgPremium !== undefined;
    });

    // 如果有產業條件，進一步篩選
    let industryMatchCases = [];
    if (industry) {
        industryMatchCases = similarCases.filter(d => industryMatches(d.industry, industry));
    }

    // 計算統計數據
    const calcStats = (cases) => {
        if (cases.length === 0) return null;

        const premiums = cases.map(d => d.avgPremium).filter(p => p !== null && !isNaN(p));
        const multiples = cases.map(d => d.bidMultiple).filter(m => m > 0);

        if (premiums.length === 0) return null;

        const avgPremium = premiums.reduce((a, b) => a + b, 0) / premiums.length;
        const minPremium = Math.min(...premiums);
        const maxPremium = Math.max(...premiums);

        // 計算標準差
        const variance = premiums.reduce((sum, p) => sum + Math.pow(p - avgPremium, 2), 0) / premiums.length;
        const stdDev = Math.sqrt(variance);

        const avgMultiple = multiples.length > 0 ? multiples.reduce((a, b) => a + b, 0) / multiples.length : 0;

        return {
            count: cases.length,
            avgPremium: avgPremium,
            minPremium: minPremium,
            maxPremium: maxPremium,
            stdDev: stdDev,
            avgMultiple: avgMultiple
        };
    };

    return {
        allCases: similarCases,
        allStats: calcStats(similarCases),
        industryCases: industryMatchCases,
        industryStats: calcStats(industryMatchCases),
        theoRange: `${theoMin}~${theoMax === 999 ? '∞' : theoMax}`,
        sizeRange: `${sizeMin}~${sizeMax === 999 ? '∞' : sizeMax}億`
    };
}

/**
 * 更新市場氛圍面板
 * v3.72 修改：根據用戶選擇的擔保類型篩選
 */
function updateAtmospherePanel() {
    const panel = document.getElementById('atmospherePanel');
    const content = document.getElementById('atmosphereContent');

    if (!panel || !content) return;

    // v3.72 新增：取得用戶選擇的擔保類型
    const guaranteeEl = document.getElementById('guarantee');
    const guarantee = guaranteeEl ? guaranteeEl.value : null;

    const atmosphere = calcMarketAtmosphere(5, guarantee);

    if (!atmosphere || atmosphere.caseCount === 0) {
        panel.style.display = 'none';
        return;
    }

    panel.style.display = 'block';

    // v3.72 新增：標題加入擔保類型
    const guarLabel = guarantee ? `【${guarantee}】` : '';

    // 生成近期案例列表
    let caseList = '';
    atmosphere.recentCases.slice(0, 5).forEach((d, i) => {
        // v3.73 修正：使用統一的 formatDate 函數處理日期
        const dateStr = formatDate(d.openDate);
        caseList += `
        <div style="display: flex; gap: 8px; padding: 4px 0; border-bottom: 1px dashed #c8e6c9; font-size: 11px;">
            <span style="color: #666; min-width: 70px;">${dateStr}</span>
            <span style="font-weight: 600; min-width: 80px;">${d.name || '-'}</span>
            <span style="color: #1565c0;">溢${d.avgPremium !== null ? d.avgPremium.toFixed(2) : '-'}%</span>
            <span style="color: #e65100;">${d.bidMultiple > 0 ? d.bidMultiple.toFixed(2) + 'x' : '-'}</span>
        </div>`;
    });

    content.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
            <div style="flex: 1;">
                <div style="font-size: 11px; color: #666;">近${atmosphere.caseCount}檔${guarLabel}平均溢價</div>
                <div style="font-size: 22px; font-weight: bold; color: #2e7d32;">${atmosphere.avgPremium.toFixed(2)}%</div>
            </div>
            <div style="flex: 1;">
                <div style="font-size: 11px; color: #666;">平均投標倍數</div>
                <div style="font-size: 22px; font-weight: bold; color: #1565c0;">${atmosphere.avgMultiple.toFixed(2)}x</div>
            </div>
            <div style="flex: 0 0 auto;">
                <div style="padding: 6px 12px; border-radius: 15px; background: ${atmosphere.levelColor}; color: white; font-weight: bold; font-size: 14px;">
                    ${atmosphere.level}
                </div>
            </div>
        </div>
        <div style="background: #fff; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">📋 近期${guarLabel}開標案例</div>
            ${caseList}
        </div>
        <div style="font-size: 11px; color: #2e7d32; background: #fff; padding: 8px; border-radius: 6px;">
            💡 ${atmosphere.suggestion}
        </div>
    `;
}

// ==================== v3.97z-s 新增：基本資料查詢模組（含篩選功能） ====================

// 全域變數 - CB完整資料庫
window.cbDatabase = {
    allCB: [],           // 所有CB清單（整合後）
    basic: {},           // 01工作表 - 基本資料 (以CB代號為key)
    schedule: {},        // 02工作表 - 發行時程
    putback: {},         // 03工作表 - 賣回條件
    auction: {},         // 04工作表 - 競拍資料
    listed: {},          // 08工作表 - 掛牌中清單
    quote: {},           // 09工作表 - 最新行情
    balance: {},         // 10工作表 - 餘額變化
    listedCodes: new Set(), // 掛牌中的CB代號集合
    auctionCodes: new Set() // 競拍發行的CB代號集合
};

// 篩選後的CB清單
let filteredCBList = [];
let currentBasicInfoCB = null;
window.currentBasicInfoTab = 'overview'; // v3.97-zs-aq: 追蹤當前標籤
let currentPriceTrendCB = null;

/**
 * 初始化基本資料查詢模組
 */
function initBasicInfoModule() {
    console.log('初始化基本資料查詢模組...');
    buildCBDatabase();
    populateBasicInfoCBList();

    // v3.97-zs-ae: 點擊搜尋區域外部時關閉搜尋結果
    document.addEventListener('click', function(e) {
        const searchInput = document.getElementById('basicInfoSearch');
        const resultsContainer = document.getElementById('basicInfoSearchResults');

        if (searchInput && resultsContainer) {
            // 檢查點擊是否在搜尋框或結果框內
            if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        }
    });
}

/**
 * 建立CB完整資料庫（整合多個工作表）
 */
function buildCBDatabase() {
    const db = window.cbDatabase;

    // 從04工作表（競拍資料）建立競拍代號集合
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        window.auctionDataCache.forEach(row => {
            const code = String(row['CB代號'] || '').trim();
            if (code) {
                db.auctionCodes.add(code);
                db.auction[code] = row;
            }
        });
    }

    // 從auctionRawData補充競拍資料
    if (window.auctionRawData && window.auctionRawData.length > 0) {
        window.auctionRawData.forEach(row => {
            const code = String(row.cbCode || '').trim();
            if (code && !db.auctionCodes.has(code)) {
                db.auctionCodes.add(code);
                // 轉換欄位名稱
                db.auction[code] = {
                    'CB代號': code,
                    '名稱': row.name,
                    '開標日期': row.openDate,
                    '最低得標': row.minBid,
                    '平均得標': row.avgBid,
                    '理論價': row.theoPrice,
                    '投標倍數': row.bidMultiple,
                    '最低溢價': row.minPremium,
                    '發行規模': row.issueSize,
                    '轉換價': row.convPrice,
                    '截標收盤': row.stockPrice,
                    '發行券商': row.broker,
                    'TCRI': row.tcri,
                    '擔保': row.guarantee,
                    '產業分類': row.industry,
                    '年期': row.term,
                    '競拍張數': row.auctionShares,
                    '投標張數': row.bidShares
                };
            }
        });
    }

    // 假設01、02、03、08、09、10工作表資料會在Excel載入時一併處理
    // 這裡先從已有的資料建立基礎清單

    // 建立所有CB清單
    const cbMap = new Map();

    // 從競拍資料加入
    db.auctionCodes.forEach(code => {
        const auctionData = db.auction[code];
        if (auctionData) {
            cbMap.set(code, {
                code: code,
                name: auctionData['名稱'] || '',
                isAuction: true,
                isListed: false, // 預設為已下市，後面會更新
                issueMethod: '競拍',
                status: '已下市'
            });
        }
    });

    // 從其他來源補充（如果有載入01工作表）
    if (window.sheet01Data && window.sheet01Data.length > 0) {
        window.sheet01Data.forEach(row => {
            const code = String(row['CB代號'] || '').trim();
            const name = String(row['名稱'] || '');
            const method = String(row['詢圈競拍'] || '').trim();

            if (code) {
                if (!cbMap.has(code)) {
                    cbMap.set(code, {
                        code: code,
                        name: name,
                        isAuction: method === '競拍',
                        isListed: false,
                        issueMethod: method || (db.auctionCodes.has(code) ? '競拍' : '詢圈'),
                        status: '已下市'
                    });
                } else {
                    const existing = cbMap.get(code);
                    existing.issueMethod = method || existing.issueMethod;
                    existing.isAuction = method === '競拍' || existing.isAuction;
                }

                // 儲存基本資料
                db.basic[code] = row;
            }
        });
    }

    // 從08工作表判斷掛牌中
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        window.sheet08Data.forEach(row => {
            const code = String(row['代號'] || '').trim();
            if (code) {
                db.listedCodes.add(code);
                db.listed[code] = row;

                if (cbMap.has(code)) {
                    const cb = cbMap.get(code);
                    cb.isListed = true;
                    cb.status = '掛牌中';
                }
            }
        });
    }

    // 轉換為陣列
    db.allCB = Array.from(cbMap.values());

    console.log(`CB資料庫建立完成: 總計 ${db.allCB.length} 檔, 競拍 ${db.auctionCodes.size} 檔, 掛牌中 ${db.listedCodes.size} 檔`);
}

/**
 * v3.97-zs-ae 新增：智能搜尋基本資料
 * 支援代號搜尋（如 2383 顯示所有台光電CB）和名稱搜尋（如「台光電」）
 */
function smartSearchBasicInfo(keyword) {
    const resultsContainer = document.getElementById('basicInfoSearchResults');
    if (!resultsContainer) return;

    // 清空或隱藏結果
    if (!keyword || keyword.trim() === '') {
        resultsContainer.style.display = 'none';
        resultsContainer.innerHTML = '';
        return;
    }

    const searchTerm = keyword.trim();
    const db = window.cbDatabase;

    if (!db || !db.allCB || db.allCB.length === 0) {
        resultsContainer.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">資料庫尚未載入</div>';
        resultsContainer.style.display = 'block';
        return;
    }

    // v3.97-zs-ah: 取得目前的篩選條件
    const methodFilter = document.querySelector('input[name="issueMethod"]:checked')?.value || 'all';
    const statusFilter = document.querySelector('input[name="listingStatus"]:checked')?.value || 'all';

    // 根據篩選條件決定搜尋範圍
    let searchPool = db.allCB;
    if (methodFilter !== 'all' || statusFilter !== 'all') {
        searchPool = db.allCB.filter(cb => {
            if (methodFilter === 'auction' && !cb.isAuction) return false;
            if (methodFilter === 'inquiry' && cb.isAuction) return false;
            if (statusFilter === 'listed' && !cb.isListed) return false;
            if (statusFilter === 'delisted' && cb.isListed) return false;
            return true;
        });
    }

    // 智能搜尋邏輯
    let matches = [];
    const isNumeric = /^\d+$/.test(searchTerm);

    if (isNumeric) {
        // 數字搜尋模式
        if (searchTerm.length <= 4) {
            // 短代號（如 2383）：搜尋母股代號開頭的所有 CB
            matches = searchPool.filter(cb => {
                const cbCode = String(cb.code);
                return cbCode.startsWith(searchTerm);
            });
        } else {
            // 長代號（如 23837）：精確或前綴匹配
            matches = searchPool.filter(cb => {
                const cbCode = String(cb.code);
                return cbCode === searchTerm || cbCode.startsWith(searchTerm);
            });
        }
    } else {
        // 文字搜尋模式（名稱搜尋）
        const searchLower = searchTerm.toLowerCase();
        matches = searchPool.filter(cb => {
            const name = (cb.name || '').toLowerCase();
            return name.includes(searchLower);
        });
    }

    // 排序結果（依代號倒序，最新的在前）
    matches.sort((a, b) => String(b.code).localeCompare(String(a.code)));

    // v3.97-zs-ah: 顯示目前篩選範圍提示
    const filterHint = [];
    if (methodFilter === 'auction') filterHint.push('競拍');
    if (methodFilter === 'inquiry') filterHint.push('詢圈');
    if (statusFilter === 'listed') filterHint.push('掛牌中');
    if (statusFilter === 'delisted') filterHint.push('已下市');
    const filterText = filterHint.length > 0 ? `（篩選：${filterHint.join('+')}）` : '';

    // 顯示結果
    if (matches.length === 0) {
        resultsContainer.innerHTML = `
            <div style="padding:15px; color:#999; text-align:center;">
                找不到符合「${searchTerm}」的可轉債 ${filterText}
            </div>`;
        resultsContainer.style.display = 'block';
        return;
    }

    // 限制顯示數量
    const maxDisplay = 20;
    const displayMatches = matches.slice(0, maxDisplay);

    let html = '';

    // v3.97-zs-ah: 顯示搜尋範圍提示
    if (filterHint.length > 0) {
        html += `<div style="padding:8px 15px; background:#e3f2fd; font-size:11px; color:#1976d2; border-bottom:1px solid #90caf9;">
            🔍 搜尋範圍：${filterHint.join(' + ')}（共 ${matches.length} 筆符合）
        </div>`;
    }

    displayMatches.forEach((cb, idx) => {
        const statusIcon = cb.isListed ? '🟢' : '⚫';
        const methodIcon = cb.isAuction ? '🎯' : '📋';
        const bgColor = idx % 2 === 0 ? '#fff' : '#f9f9f9';

        html += `
            <div onclick="selectBasicInfoCB('${cb.code}')"
                 style="padding:10px 15px; cursor:pointer; border-bottom:1px solid #eee; background:${bgColor}; transition:background 0.2s;"
                 onmouseover="this.style.background='#fff3e0'"
                 onmouseout="this.style.background='${bgColor}'">
                <div style="font-weight:bold; color:#333;">
                    ${statusIcon}${methodIcon} ${cb.code} ${cb.name}
                </div>
                <div style="font-size:11px; color:#888; margin-top:2px;">
                    ${cb.isAuction ? '競拍發行' : '詢圈發行'} │ ${cb.isListed ? '掛牌中' : '已下市'}
                </div>
            </div>`;
    });

    // 如果結果超過限制，顯示提示
    if (matches.length > maxDisplay) {
        html += `
            <div style="padding:10px 15px; color:#666; background:#f5f5f5; text-align:center; font-size:12px;">
                還有 ${matches.length - maxDisplay} 筆結果，請輸入更精確的關鍵字
            </div>`;
    }

    // 顯示匹配數量提示
    html = `
        <div style="padding:8px 15px; background:#ff9800; color:white; font-size:12px; font-weight:bold;">
            找到 ${matches.length} 檔符合的可轉債
        </div>` + html;

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
}

/**
 * 選擇搜尋結果中的CB
 */
function selectBasicInfoCB(cbCode) {
    // 隱藏搜尋結果
    const resultsContainer = document.getElementById('basicInfoSearchResults');
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
    }

    // 更新搜尋框顯示
    const searchInput = document.getElementById('basicInfoSearch');
    if (searchInput) {
        const db = window.cbDatabase;
        const cb = db.allCB.find(c => c.code === cbCode);
        if (cb) {
            searchInput.value = `${cbCode} ${cb.name}`;
        } else {
            searchInput.value = cbCode;
        }
    }

    // 同步更新下拉選單
    const select = document.getElementById('basicInfoCBSelect');
    if (select) {
        select.value = cbCode;
    }

    // 載入基本資料
    loadBasicInfo(cbCode);
}

/**
 * 處理搜尋框鍵盤事件
 */
function handleBasicInfoSearchKey(event) {
    const resultsContainer = document.getElementById('basicInfoSearchResults');

    if (event.key === 'Escape') {
        // ESC 鍵關閉搜尋結果
        if (resultsContainer) {
            resultsContainer.style.display = 'none';
        }
    } else if (event.key === 'Enter') {
        // Enter 鍵選擇第一筆結果
        const firstResult = resultsContainer?.querySelector('div[onclick]');
        if (firstResult) {
            firstResult.click();
        }
    }
}

/**
 * 清除搜尋並重置篩選條件
 */
function clearBasicInfoSearch() {
    const searchInput = document.getElementById('basicInfoSearch');
    const resultsContainer = document.getElementById('basicInfoSearchResults');

    if (searchInput) {
        searchInput.value = '';
    }
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
        resultsContainer.innerHTML = '';
    }

    // v3.97-zs-ah: 重置篩選條件到「全部」
    resetFiltersToAll();
}

/**
 * v3.97-zs-ah 新增：重置所有篩選條件到「全部」
 */
function resetFiltersToAll() {
    // 重置發行方式為「全部」
    const methodAllRadio = document.querySelector('input[name="issueMethod"][value="all"]');
    if (methodAllRadio) methodAllRadio.checked = true;

    // 重置交易狀態為「全部」
    const statusAllRadio = document.querySelector('input[name="listingStatus"][value="all"]');
    if (statusAllRadio) statusAllRadio.checked = true;

    // 重新載入完整清單
    filterCBList();
}

/**
 * 篩選CB清單（v3.97-zs-ah 優化：統計數字連動）
 */
function filterCBList() {
    const methodFilter = document.querySelector('input[name="issueMethod"]:checked')?.value || 'all';
    const statusFilter = document.querySelector('input[name="listingStatus"]:checked')?.value || 'all';

    const db = window.cbDatabase;
    if (!db || !db.allCB) return;

    // 篩選結果
    filteredCBList = db.allCB.filter(cb => {
        // 發行方式篩選
        if (methodFilter === 'auction' && !cb.isAuction) return false;
        if (methodFilter === 'inquiry' && cb.isAuction) return false;

        // 交易狀態篩選
        if (statusFilter === 'listed' && !cb.isListed) return false;
        if (statusFilter === 'delisted' && cb.isListed) return false;

        return true;
    });

    // v3.97-zs-ah: 更新統計數字（連動顯示）
    // 根據當前「交易狀態」篩選，計算各發行方式數量
    let auctionCount, inquiryCount;
    if (statusFilter === 'listed') {
        auctionCount = db.allCB.filter(cb => cb.isAuction && cb.isListed).length;
        inquiryCount = db.allCB.filter(cb => !cb.isAuction && cb.isListed).length;
    } else if (statusFilter === 'delisted') {
        auctionCount = db.allCB.filter(cb => cb.isAuction && !cb.isListed).length;
        inquiryCount = db.allCB.filter(cb => !cb.isAuction && !cb.isListed).length;
    } else {
        auctionCount = db.allCB.filter(cb => cb.isAuction).length;
        inquiryCount = db.allCB.filter(cb => !cb.isAuction).length;
    }

    // 根據當前「發行方式」篩選，計算各交易狀態數量
    let listedCount, delistedCount;
    if (methodFilter === 'auction') {
        listedCount = db.allCB.filter(cb => cb.isAuction && cb.isListed).length;
        delistedCount = db.allCB.filter(cb => cb.isAuction && !cb.isListed).length;
    } else if (methodFilter === 'inquiry') {
        listedCount = db.allCB.filter(cb => !cb.isAuction && cb.isListed).length;
        delistedCount = db.allCB.filter(cb => !cb.isAuction && !cb.isListed).length;
    } else {
        listedCount = db.allCB.filter(cb => cb.isListed).length;
        delistedCount = db.allCB.filter(cb => !cb.isListed).length;
    }

    // 更新UI顯示
    const auctionCountEl = document.getElementById('auctionCount');
    const inquiryCountEl = document.getElementById('inquiryCount');
    const listedCountEl = document.getElementById('listedCount');
    const delistedCountEl = document.getElementById('delistedCount');

    if (auctionCountEl) auctionCountEl.textContent = `(${auctionCount})`;
    if (inquiryCountEl) inquiryCountEl.textContent = `(${inquiryCount})`;
    if (listedCountEl) listedCountEl.textContent = `(${listedCount})`;
    if (delistedCountEl) delistedCountEl.textContent = `(${delistedCount})`;

    // 更新下拉選單
    updateCBSelectOptions();

    // 更新計數顯示
    const listCountEl = document.getElementById('cbListCount');
    if (listCountEl) {
        listCountEl.textContent = `資料庫共 ${filteredCBList.length} 檔`;
    }
}

/**
 * 更新CB下拉選單選項
 */
function updateCBSelectOptions() {
    const select = document.getElementById('basicInfoCBSelect');
    const priceTrendSelect = document.getElementById('priceTrendCBSelect');
    if (!select) return;

    // 排序（依代號倒序，最新的在前面）
    const sortedList = [...filteredCBList].sort((a, b) => {
        return String(b.code).localeCompare(String(a.code));
    });

    // 生成選項HTML
    let optionsHTML = '<option value="">-- 請選擇CB代號 --</option>';

    sortedList.forEach(cb => {
        const statusIcon = cb.isListed ? '🟢' : '⚫';
        const methodIcon = cb.isAuction ? '🎯' : '📋';
        optionsHTML += `<option value="${cb.code}">${statusIcon}${methodIcon} ${cb.code} ${cb.name}</option>`;
    });

    select.innerHTML = optionsHTML;

    // 同步到價格走勢選單
    if (priceTrendSelect) {
        priceTrendSelect.innerHTML = optionsHTML;
        // 初始化價格走勢選項列表（供快速搜尋用）
        initPriceTrendCBOptions();
    }
}

/**
 * 填充基本資料CB選擇清單（初始化用）
 */
function populateBasicInfoCBList() {
    const db = window.cbDatabase;

    // 如果資料庫為空，從現有資料建立
    if (db.allCB.length === 0) {
        buildCBDatabase();
    }

    // v3.97z-s 新增：背景載入yuanta歷史資料（非阻塞）
    if (!window.yuantaHistoryData.loaded && !window.yuantaHistoryData.loading) {
        loadYuantaHistoryData().then(() => {
            console.log('📂 yuanta歷史資料已背景載入完成');
        }).catch(err => {
            console.warn('yuanta歷史資料載入失敗:', err);
        });
    }

    // 初始化篩選清單（全部）
    filteredCBList = [...db.allCB];

    // 更新統計數字
    const auctionCount = db.allCB.filter(cb => cb.isAuction).length;
    const inquiryCount = db.allCB.filter(cb => !cb.isAuction).length;
    const listedCount = db.allCB.filter(cb => cb.isListed).length;
    const delistedCount = db.allCB.filter(cb => !cb.isListed).length;

    // 更新UI顯示
    const auctionCountEl = document.getElementById('auctionCount');
    const inquiryCountEl = document.getElementById('inquiryCount');
    const listedCountEl = document.getElementById('listedCount');
    const delistedCountEl = document.getElementById('delistedCount');

    if (auctionCountEl) auctionCountEl.textContent = `(${auctionCount})`;
    if (inquiryCountEl) inquiryCountEl.textContent = `(${inquiryCount})`;
    if (listedCountEl) listedCountEl.textContent = `(${listedCount})`;
    if (delistedCountEl) delistedCountEl.textContent = `(${delistedCount})`;

    // 更新下拉選單
    updateCBSelectOptions();

    const listCountEl = document.getElementById('cbListCount');
    if (listCountEl) {
        listCountEl.textContent = `資料庫共 ${db.allCB.length} 檔`;
    }

    console.log(`基本資料查詢模組初始化完成，共 ${db.allCB.length} 檔CB可查詢 (競拍${auctionCount}/詢圈${inquiryCount}, 掛牌中${listedCount}/已下市${delistedCount})`);
}

/**
 * 重整基本資料清單
 */
function refreshBasicInfoList() {
    // v3.97-zs-ah: 先重置篩選條件
    const methodAllRadio = document.querySelector('input[name="issueMethod"][value="all"]');
    if (methodAllRadio) methodAllRadio.checked = true;
    const statusAllRadio = document.querySelector('input[name="listingStatus"][value="all"]');
    if (statusAllRadio) statusAllRadio.checked = true;

    // 清除搜尋框
    const searchInput = document.getElementById('basicInfoSearch');
    if (searchInput) searchInput.value = '';

    // 重建資料庫並填充清單
    buildCBDatabase();
    populateBasicInfoCBList();
    filterCBList();
    document.getElementById('basicInfoStatus').textContent = '✅ 清單已重整';
}

/**
 * 載入指定CB的基本資料
 */
function loadBasicInfo(cbCode) {
    if (!cbCode) {
        document.getElementById('basicInfoContent').innerHTML = `
            <div style="text-align:center; color:#999; padding:40px;">
                👆 請先選擇一檔可轉債
            </div>`;
        document.getElementById('basicInfoStatus').textContent = '提示：請選擇一檔可轉債查看詳細資料';
        return;
    }

    currentBasicInfoCB = cbCode;

    // 取得CB狀態資訊
    const db = window.cbDatabase;
    const cbInfo = db.allCB.find(cb => cb.code === cbCode);

    // 取得CB名稱
    let cbName = cbInfo?.name || '';
    if (!cbName && window.sheet08Data) {
        const sheet08Row = window.sheet08Data.find(r => String(r['代號']).trim() === cbCode);
        cbName = sheet08Row?.['名稱'] || '';
    }

    document.getElementById('basicInfoStatus').textContent = `✅ 已載入 ${cbCode} ${cbName} 資料`;

    // 顯示預設標籤（基本資料）
    showBasicInfoTab('overview');
}

/**
 * 顯示基本資料標籤頁
 */
function showBasicInfoTab(tabName, event) {
    console.log('[showBasicInfoTab] 開始執行, tabName:', tabName);

    // v3.97-zs-aq: 追蹤當前標籤（用於非同步函數檢查）
    window.currentBasicInfoTab = tabName;

    // 更新標籤狀態
    document.querySelectorAll('.basic-info-tab').forEach(tab => tab.classList.remove('active'));
    if (event) event.target.classList.add('active');
    else document.querySelector('.basic-info-tab').classList.add('active');

    const content = document.getElementById('basicInfoContent');
    const cbCode = currentBasicInfoCB;

    console.log('[showBasicInfoTab] currentBasicInfoCB:', cbCode);

    if (!cbCode) {
        content.innerHTML = `<div style="text-align:center; color:#999; padding:40px;">👆 請先選擇一檔可轉債</div>`;
        return;
    }

    // 根據標籤顯示不同內容
    try {
        switch(tabName) {
            case 'overview':
                console.log('[showBasicInfoTab] 執行 renderBasicInfoOverview');
                renderBasicInfoOverview(cbCode, content);
                break;
            case 'schedule':
                console.log('[showBasicInfoTab] 執行 renderBasicInfoSchedule');
                renderBasicInfoSchedule(cbCode, content);
                break;
            case 'putback':
                console.log('[showBasicInfoTab] 執行 renderBasicInfoPutback');
                renderBasicInfoPutback(cbCode, content);
                break;
            case 'callOption':
                console.log('[showBasicInfoTab] 執行 renderBasicInfoCallOption');
                renderBasicInfoCallOption(cbCode, content);
                break;
            case 'auction':
                console.log('[showBasicInfoTab] 執行 renderBasicInfoAuction');
                renderBasicInfoAuction(cbCode, content);
                break;
            case 'quote':
                console.log('[showBasicInfoTab] 執行 renderBasicInfoQuote');
                renderBasicInfoQuote(cbCode, content);
                break;
            case 'balance':
                console.log('[showBasicInfoTab] 執行 renderBasicInfoBalance');
                renderBasicInfoBalance(cbCode, content);
                break;
            default:
                content.innerHTML = `<div style="color:#999;">未知標籤：${tabName}</div>`;
        }
        console.log('[showBasicInfoTab] 執行完成');
    } catch(e) {
        console.error('[showBasicInfoTab] 錯誤:', e);
        content.innerHTML = `<div style="color:#c62828; padding:20px;">❌ 載入錯誤: ${e.message}</div>`;
    }
}

/**
 * v3.97-zs-af 新增：計算資料完整度
 * @param {Object} data - 資料物件
 * @param {Array} requiredFields - 必要欄位列表
 * @returns {Object} { percentage: number, filled: number, total: number }
 */
function calculateDataCompleteness(data, requiredFields) {
    if (!data || !requiredFields || requiredFields.length === 0) {
        return { percentage: 0, filled: 0, total: requiredFields?.length || 0 };
    }

    let filled = 0;
    for (const field of requiredFields) {
        const value = data[field];
        if (value !== null && value !== undefined && value !== '' && value !== '-') {
            filled++;
        }
    }

    const percentage = Math.round((filled / requiredFields.length) * 100);
    return { percentage, filled, total: requiredFields.length };
}

/**
 * v3.97-zs-af 新增：生成資料完整度標籤HTML
 * @param {number} percentage - 完整度百分比
 * @returns {string} HTML字串
 */
function getCompletenessHTML(percentage) {
    let bgColor, textColor, icon;

    if (percentage >= 80) {
        bgColor = '#e8f5e9';
        textColor = '#2e7d32';
        icon = '✅';
    } else if (percentage >= 50) {
        bgColor = '#fff3e0';
        textColor = '#e65100';
        icon = '⚠️';
    } else {
        bgColor = '#ffebee';
        textColor = '#c62828';
        icon = '❌';
    }

    return `<span style="display:inline-flex; align-items:center; gap:4px; padding:3px 10px; background:${bgColor}; color:${textColor}; border-radius:12px; font-size:12px; font-weight:bold; margin-left:10px;">
        ${icon} ${percentage}%
    </span>`;
}

/**
 * v3.97-zs-af 新增：生成標題區域HTML（含完整度）
 * v3.97-zs-ag 修改：增加 cbCode 和 cbName 參數，統一標題格式
 * @param {string} title - 標題文字
 * @param {string} icon - 圖示emoji
 * @param {string} color - 主色
 * @param {number} percentage - 完整度百分比
 * @param {string} statusTag - 狀態標籤（掛牌中/已下市）
 * @param {string} cbCode - CB代號
 * @param {string} cbName - CB名稱
 * @returns {string} HTML字串
 */
function renderTabHeader(title, icon, color, percentage, statusTag = '', cbCode = '', cbName = '') {
    const completenessHTML = percentage !== null ? getCompletenessHTML(percentage) : '';
    const statusHTML = statusTag ? `<span style="font-size:12px; padding:4px 10px; border-radius:12px; background:${statusTag.includes('掛牌中') ? '#e8f5e9' : '#f5f5f5'}; color:${statusTag.includes('掛牌中') ? '#2e7d32' : '#666'};">${statusTag}</span>` : '';

    // v3.97-zs-ag: 統一標題格式「📅 代號 名稱 標題」
    const fullTitle = cbCode ? `${icon} ${cbCode} ${cbName || ''} ${title}` : `${icon} ${title}`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-weight:bold; color:${color}; font-size:16px;">${fullTitle}</span>
                ${completenessHTML}
            </div>
            ${statusHTML}
        </div>`;
}

/**
 * 渲染基本資料總覽
 * v3.97z-s 修改：調整查詢優先順序
 * - 掛牌中CB：08工作表(最新) → 競拍資料 → yuanta歷史 → 01工作表
 * - 已下市CB：競拍資料 → yuanta歷史 → 01工作表
 */
function renderBasicInfoOverview(cbCode, container) {
    let data = null;
    let dataSource = '';
    const searchCode = String(cbCode).trim();

    // 先判斷是否掛牌中
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);

    // ========== 掛牌中CB：優先使用08工作表（最新資料）==========
    if (isListed) {
        // 1. 優先從 08工作表（掛牌中）尋找
        if (!data && window.sheet08Data && window.sheet08Data.length > 0) {
            const sheet08Row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
            if (sheet08Row) {
                data = {
                    'CB代號': sheet08Row['代號'],
                    '名稱': sheet08Row['名稱'],
                    '股票代號': sheet08Row['轉換標的代碼'],
                    '轉換標的名稱': sheet08Row['轉換標的名稱'],
                    '轉換價': sheet08Row['轉換價格(元)'],
                    '發行規模': sheet08Row['實際發行總額(百萬)'],
                    '年期': sheet08Row['還本年限'],
                    '發行券商': sheet08Row['承銷機構'],
                    '底標價': sheet08Row['發行價格(元)'] || 100,
                    '到期還本價格': sheet08Row['到期價格'],
                    '掛牌日期': sheet08Row['掛牌日期'],
                    '到期日期': sheet08Row['到期日'],
                    '擔保': sheet08Row['債券擔保情形'],
                    '最新餘額': sheet08Row['最新餘額(百萬)'],
                    '發行時轉換價': sheet08Row['發行時轉換價格(元)'],
                    '轉換日期起': sheet08Row['轉換日期起'],
                    '轉換日期迄': sheet08Row['轉換日期迄'],
                    '提前償還日1': sheet08Row['提前償還日1'],
                    '提前償還價格1': sheet08Row['提前償還價格1'],
                    '最近提前償還日': sheet08Row['最近提前償還日'],
                    '最近提前償還價格': sheet08Row['最近提前償還價格']
                };
                dataSource = 'sheet08Data';
            }
        }
    }

    // ========== 競拍資料（不論掛牌中或已下市）==========
    // 2. 從auctionDataCache尋找（競拍完整資料）
    if (!data && window.auctionDataCache && window.auctionDataCache.length > 0) {
        const auctionRow = window.auctionDataCache.find(r => String(r['CB代號']).trim() === searchCode);
        if (auctionRow) {
            data = auctionRow;
            dataSource = 'auctionDataCache';
        }
    }

    // 3. 從 auctionRawData 尋找
    if (!data && window.auctionRawData && window.auctionRawData.length > 0) {
        const rawData = window.auctionRawData.find(r => String(r.cbCode).trim() === searchCode);
        if (rawData) {
            data = {
                'CB代號': rawData.cbCode,
                '名稱': rawData.name,
                '股票代號': rawData.stockCode,
                '產業分類': rawData.industry,
                '信用評等': rawData.tcri,
                'TCRI': rawData.tcri,
                '擔保': rawData.guarantee,
                '發行規模': rawData.issueSize,
                '年期': rawData.term,
                '股本(億)': rawData.capitalBillion,
                '競拍張數': rawData.auctionShares,
                '發行券商': rawData.broker,
                '轉換價': rawData.convPrice,
                '截標收盤': rawData.stockPrice,
                '理論價': rawData.theoPrice,
                '轉換比率': rawData.convRatio,
                '年化波動': rawData.volatility,
                'PBR': rawData.pbr,
                '開標日期': rawData.openDate,
                '截標日': rawData.bidDeadline,
                '最低得標': rawData.minBid,
                '平均得標': rawData.avgBid,
                '投標倍數': rawData.bidMultiple,
                '合格件數': rawData.validBids
            };
            dataSource = 'auctionRawData';
        }
    }

    // ========== 已下市CB：優先使用yuanta歷史資料 ==========
    // 4. 從 yuanta歷史資料 尋找（已下市CB的主要資料來源）
    if (!data && window.yuantaHistoryData?.loaded) {
        const yuantaRow = window.yuantaHistoryData.data[searchCode];
        if (yuantaRow) {
            data = {
                'CB代號': yuantaRow['代號'],
                '名稱': yuantaRow['名稱'],
                '股票代號': yuantaRow['轉換標的代碼'],
                '轉換標的名稱': yuantaRow['轉換標的名稱'],
                '轉換價': yuantaRow['轉換價格(元)'],
                '發行規模': yuantaRow['實際發行總額(百萬)'],
                '年期': yuantaRow['還本年限'],
                '發行券商': yuantaRow['承銷機構'],
                '底標價': yuantaRow['發行價格(元)'] || 100,
                '到期還本價格': yuantaRow['到期價格'],
                '掛牌日期': yuantaRow['掛牌日期'],
                '到期日期': yuantaRow['到期日'],
                '擔保': yuantaRow['債券擔保情形'],
                '最新餘額': yuantaRow['最新餘額(百萬)'],
                '發行時轉換價': yuantaRow['發行時轉換價格(元)'],
                '信用評等': yuantaRow['信用評等'],
                '_sheetDate': yuantaRow['_sheetDate']
            };
            dataSource = 'yuantaHistory';
        }
    }

    // 5. 從 sheet01Data（01工作表）尋找（手工收集資料）
    if (!data && window.sheet01Data && window.sheet01Data.length > 0) {
        const sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
        if (sheet01Row) {
            data = {
                'CB代號': sheet01Row['CB代號'],
                '名稱': sheet01Row['名稱'],
                '股票代號': sheet01Row['股票代號'],
                '產業分類': sheet01Row['產業分類'],
                '信用評等': sheet01Row['信用評等'],
                'TCRI': sheet01Row['信用評等'],
                '擔保': sheet01Row['擔保'],
                '發行規模': sheet01Row['發行規模'],
                '年期': sheet01Row['發行年期'],
                '股本(億)': sheet01Row['股本大小'],
                '發行券商': sheet01Row['發行券商'],
                '轉換價': sheet01Row['轉換價格'],
                '底標價': sheet01Row['發行價格'] || 100,
                '產業地位': sheet01Row['產業地位'],
                '到期還本價格': sheet01Row['到期還本價格'],
                '訂價溢價率': sheet01Row['訂價溢價率'],
                '掛牌日期': sheet01Row['掛牌日期'],
                '到期日期': sheet01Row['到期日期'],
                '掛牌最高': sheet01Row['掛牌最高'],
                '掛牌最低': sheet01Row['掛牌最低'],
                '發行方式': sheet01Row['詢圈競拍']
            };
            dataSource = 'sheet01Data';
        }
    }

    // 6. 從 cbDatabase.basic 補充資料
    if (!data && window.cbDatabase && window.cbDatabase.basic[searchCode]) {
        const basicRow = window.cbDatabase.basic[searchCode];
        data = {
            'CB代號': basicRow['CB代號'],
            '名稱': basicRow['名稱'],
            '股票代號': basicRow['股票代號'],
            '產業分類': basicRow['產業分類'],
            '信用評等': basicRow['信用評等'],
            '擔保': basicRow['擔保'],
            '發行規模': basicRow['發行規模'],
            '年期': basicRow['發行年期'],
            '發行方式': basicRow['詢圈競拍']
        };
        dataSource = 'cbDatabase.basic';
    }

    if (!data) {
        container.innerHTML = `<div style="color:#e65100; padding:20px; text-align:center;">
            <div style="font-size:32px; margin-bottom:10px;">⚠️</div>
            <div>找不到 <strong>${cbCode}</strong> 的基本資料</div>
            <div style="font-size:12px; color:#999; margin-top:8px;">
                請確認CB代號是否正確<br>
                若為較早期已下市CB，可能需要載入yuanta歷史資料
            </div>
        </div>`;
        document.getElementById('basicInfoStatus').innerHTML = `<span style="color:#e65100;">⚠️ ${cbCode} 無資料</span>`;
        return;
    }

    // 判斷是競拍還是詢圈
    const isAuction = window.cbDatabase?.auctionCodes?.has(searchCode) || dataSource === 'auctionDataCache' || dataSource === 'auctionRawData';
    const methodLabel = isAuction ? '🎯 競拍發行' : '📋 詢圈發行';
    const statusLabel = isListed ? '🟢 掛牌中' : '⚫ 已下市';

    // 資料來源標籤
    const sourceLabels = {
        'sheet08Data': '📊 08工作表(掛牌中)',
        'auctionDataCache': '🎯 競拍資料庫',
        'auctionRawData': '🎯 競拍原始資料',
        'yuantaHistory': '📂 元大歷史資料',
        'sheet01Data': '📋 01工作表(手工)',
        'cbDatabase.basic': '💾 基本資料庫'
    };
    const sourceLabel = sourceLabels[dataSource] || dataSource;

    // ========== v3.97z-s 新增：即時計算欄位 ==========
    const today = new Date();

    // 解析到期日期
    let maturityDate = null;
    const maturityRaw = data['到期日期'] || data['到期日'];
    if (maturityRaw) {
        if (typeof maturityRaw === 'number') {
            // Excel日期數字
            maturityDate = new Date((maturityRaw - 25569) * 86400 * 1000);
        } else if (typeof maturityRaw === 'string') {
            maturityDate = new Date(maturityRaw);
        } else if (maturityRaw instanceof Date) {
            maturityDate = maturityRaw;
        }
    }

    // 計算剩餘年期
    let remainYears = null;
    let remainYearsDisplay = '-';
    if (maturityDate && !isNaN(maturityDate.getTime())) {
        const diffMs = maturityDate.getTime() - today.getTime();
        remainYears = diffMs / (365.25 * 24 * 60 * 60 * 1000);
        if (remainYears > 0) {
            remainYearsDisplay = remainYears.toFixed(2) + ' 年';
        } else {
            remainYearsDisplay = '已到期';
        }
    }

    // ========== v3.97-zs-ag 優化：轉換價格資料來源統一處理 ==========
    // 1. 發行轉換價（原始）- 優先從 yuanta 或 01 工作表取得
    let issueConvPrice = 0;  // 發行時的轉換價
    let issueConvPriceSource = '';

    // 優先從 yuanta 取得發行轉換價
    if (window.yuantaHistoryData?.loaded) {
        const yuantaRow = window.yuantaHistoryData.data[searchCode];
        if (yuantaRow && yuantaRow['轉換價格(元)']) {
            issueConvPrice = parseFloat(yuantaRow['轉換價格(元)']) || 0;
            issueConvPriceSource = 'yuanta';
        }
        // 另外檢查「發行時轉換價格(元)」欄位
        if (!issueConvPrice && yuantaRow && yuantaRow['發行時轉換價格(元)']) {
            issueConvPrice = parseFloat(yuantaRow['發行時轉換價格(元)']) || 0;
            issueConvPriceSource = 'yuanta';
        }
    }

    // 從 01 工作表補充
    if (!issueConvPrice && window.sheet01Data && window.sheet01Data.length > 0) {
        const sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
        if (sheet01Row && sheet01Row['轉換價格']) {
            issueConvPrice = parseFloat(sheet01Row['轉換價格']) || 0;
            issueConvPriceSource = 'sheet01';
        }
    }

    // 如果都沒有，使用 data 中的轉換價
    if (!issueConvPrice) {
        issueConvPrice = parseFloat(data['轉換價']) || parseFloat(data['發行時轉換價']) || 0;
        issueConvPriceSource = 'data';
    }

    // 2. 最新轉換價 - 從 kanban 最新資料取得
    let latestConvPrice = 0;  // 最新調整後的轉換價
    let latestConvPriceDate = '';
    let convPriceAdjusted = false;  // 是否有調整過

    // 從 kanban 取得最新轉換價
    if (window.kanbanData?.loaded && window.kanbanData.data[searchCode]) {
        const cbTimeSeries = window.kanbanData.data[searchCode];
        if (cbTimeSeries && cbTimeSeries.length > 0) {
            // 取最新一筆
            const latestRecord = cbTimeSeries[cbTimeSeries.length - 1];
            if (latestRecord && latestRecord.convPrice > 0) {
                latestConvPrice = latestRecord.convPrice;
                latestConvPriceDate = latestRecord.date;
            }
        }
    }

    // 從 09 工作表補充最新轉換價（掛牌中的CB）
    if (!latestConvPrice && window.sheet09Data && window.sheet09Data.length > 0) {
        const quote09Row = window.sheet09Data.find(r => String(r['代碼']).trim() === searchCode);
        if (quote09Row && quote09Row['轉換價格']) {
            latestConvPrice = parseFloat(quote09Row['轉換價格']) || 0;
        }
    }

    // 如果沒有最新轉換價，使用發行轉換價
    if (!latestConvPrice) {
        latestConvPrice = issueConvPrice;
    }

    // 判斷是否有調整過（差異超過 0.01 元視為有調整）
    if (issueConvPrice > 0 && latestConvPrice > 0 && Math.abs(latestConvPrice - issueConvPrice) > 0.01) {
        convPriceAdjusted = true;
    }

    // 使用最新轉換價作為主要顯示
    const convPrice = latestConvPrice || issueConvPrice || parseFloat(data['轉換價']) || 0;

    // 計算強制贖回觸發價 (130%)
    const callTrigger130 = convPrice > 0 ? (convPrice * 1.3).toFixed(2) : '-';

    // 計算每張可轉換股數 (面額100,000 ÷ 轉換價)
    const sharesPerBond = convPrice > 0 ? Math.floor(100000 / convPrice) : '-';

    // 從09工作表取得最新餘額資訊（計算已轉換比例）
    let quoteData09 = null;
    if (window.sheet09Data && window.sheet09Data.length > 0) {
        quoteData09 = window.sheet09Data.find(r => String(r['代碼']).trim() === searchCode);
    }

    // 發行張數與剩餘張數
    const issueSize = parseFloat(data['發行規模']) || 0;
    const totalShares = issueSize > 0 ? issueSize * 10 : 0; // 百萬 → 張數
    const outstandingShares = quoteData09 ? parseFloat(quoteData09['流通在外餘額(張)']) : null;
    const remainRatio = quoteData09 ? parseFloat(quoteData09['剩餘未轉換比率%']) : null;

    // 計算已轉換比例
    let convertedRatio = null;
    let convertedShares = null;
    if (remainRatio !== null && !isNaN(remainRatio)) {
        convertedRatio = (100 - remainRatio).toFixed(2);
        if (totalShares > 0) {
            convertedShares = Math.round(totalShares * (100 - remainRatio) / 100);
        }
    } else if (outstandingShares !== null && totalShares > 0) {
        convertedShares = totalShares - outstandingShares;
        convertedRatio = ((convertedShares / totalShares) * 100).toFixed(2);
    }

    document.getElementById('basicInfoStatus').textContent = `✅ 已載入 ${cbCode} ${data['名稱'] || ''} 資料`;

    // v3.97-zs-ag: 從 01 工作表取得補充資料
    let sheet01Row = null;
    if (window.sheet01Data && window.sheet01Data.length > 0) {
        sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
    }

    // 信用評等 (01工作表 E欄)
    const creditRating = sheet01Row?.['信用評等'] || data['信用評等'] || data['TCRI'] || '-';

    // 擔保情形 (01工作表 F欄)
    const guarantee = sheet01Row?.['擔保'] || data['擔保'] || '-';

    // 發行價 (01工作表 O欄)
    const issuePrice = sheet01Row?.['發行價格'] || data['底標價'] || '100';

    // 訂價溢價率 (01工作表 Q欄)
    let pricingPremiumRaw = sheet01Row?.['訂價溢價率'] || data['訂價溢價率'] || data['定價溢價率'] || '';
    // v3.97-zs-ax: 修正格式 - 如果是小數格式（如1.0442），轉為百分比格式（104.42）
    let pricingPremium = '';
    if (pricingPremiumRaw) {
        const val = parseFloat(pricingPremiumRaw);
        if (!isNaN(val)) {
            // 如果值小於10，可能是小數格式（1.0442代表104.42%）
            // 如果值大於10，可能已經是百分比格式（104.42代表104.42%）
            pricingPremium = val < 10 ? (val * 100).toFixed(2) : val.toFixed(2);
        }
    }

    // v3.97-zs-ba: 承銷商 - 使用代號對照表轉換
    const brokerRaw = data['發行券商'] || sheet01Row?.['發行券商'] || '-';
    const brokerDisplay = convertBrokerCodeToName(brokerRaw);
    console.log('[承銷商轉換]', searchCode, '原始:', brokerRaw, '→ 轉換後:', brokerDisplay);

    // 發行規模（億）
    const issueSizeBillion = issueSize > 0 ? (issueSize / 100).toFixed(2) : '-';

    // v3.97-zs-ag: 從 kanban 取得股票最新市價和 CB 參考價格
    let latestStockPrice = 0;  // kanban Q欄 - 轉換標的股票價格
    let latestCBPrice = 0;     // kanban P欄 - 轉債參考價格
    let kanbanDate = '';

    if (window.kanbanData?.loaded && window.kanbanData.data[searchCode]) {
        const cbTimeSeries = window.kanbanData.data[searchCode];
        if (cbTimeSeries && cbTimeSeries.length > 0) {
            const latestRecord = cbTimeSeries[cbTimeSeries.length - 1];
            if (latestRecord) {
                latestStockPrice = latestRecord.stockPrice || 0;
                latestCBPrice = latestRecord.cbPrice || 0;
                kanbanDate = latestRecord.date || '';
            }
        }
    }

    // 從 09 工作表補充（掛牌中CB）
    if (!latestStockPrice && quoteData09) {
        latestStockPrice = parseFloat(quoteData09['股價']) || 0;
    }
    if (!latestCBPrice && quoteData09) {
        latestCBPrice = parseFloat(quoteData09['CB收盤價']) || 0;
    }

    // 計算理論價 = 股票市價 / 轉換價 * 100
    const theoreticalPrice = (latestStockPrice > 0 && convPrice > 0)
        ? (latestStockPrice / convPrice * 100).toFixed(2)
        : null;

    // 計算溢折價 = CB價格 / 理論價 - 1
    let premiumDiscount = null;
    if (latestCBPrice > 0 && theoreticalPrice && parseFloat(theoreticalPrice) > 0) {
        premiumDiscount = ((latestCBPrice / parseFloat(theoreticalPrice) - 1) * 100).toFixed(2);
    }

    // v3.97-zs-af: 計算資料完整度
    const overviewFields = ['CB代號', '名稱', '股票代號', '產業分類', '信用評等', '擔保', '發行規模', '底標價', '年期', '發行券商', '轉換價', '掛牌日期', '到期日期'];
    const completeness = calculateDataCompleteness(data, overviewFields);

    // v3.97-zs-ag: 取得名稱用於標題
    const cbName = data['名稱'] || '';

    // v3.97-zs-ag: 取得產業相關資訊
    let industryInfo = data['產業分類'] || '-';
    let industryPosition = data['產業地位'] || '';

    // 從01工作表補充產業地位資料
    if (!industryPosition && window.sheet01Data && window.sheet01Data.length > 0) {
        const sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
        if (sheet01Row) {
            industryPosition = sheet01Row['產業地位'] || '';
            if (!industryInfo || industryInfo === '-') {
                industryInfo = sheet01Row['產業分類'] || '-';
            }
        }
    }

    // 從16工作表(industryMap)補充產業分類
    const stockCode = data['股票代號'] || '';
    if ((!industryInfo || industryInfo === '-') && stockCode && window.industryMap) {
        industryInfo = window.industryMap[stockCode] || industryInfo;
    }

    // v3.97-zs-ag: 新增計算欄位（參考用戶設計）
    // 距到期天數
    let daysToMaturity = null;
    if (maturityDate && !isNaN(maturityDate.getTime())) {
        const diffMs = maturityDate.getTime() - today.getTime();
        daysToMaturity = Math.ceil(diffMs / (24 * 60 * 60 * 1000));
    }

    // 轉換比例 (每張CB可換多少股票)
    const convRatio = convPrice > 0 ? (100000 / convPrice).toFixed(2) : '-';

    // v3.97-zs-ag: 強制贖回條款欄位（從 yuantaHistoryData 或其他來源讀取）
    let callStartDate = '-';
    let callEndDate = '-';
    let callPrice = '-';
    let delistDate = '-';

    // 優先從 yuantaHistoryData 讀取
    if (window.yuantaHistoryData?.loaded) {
        const yuantaRow = window.yuantaHistoryData.data[searchCode];
        if (yuantaRow) {
            callStartDate = yuantaRow['強制贖回起日'] || '-';
            callEndDate = yuantaRow['強制贖回迄日'] || '-';
            callPrice = yuantaRow['強制贖回價格'] || '-';
            delistDate = yuantaRow['終止櫃檯買賣日'] || '-';
        }
    }

    // 從 sheet01Data 補充
    if ((callStartDate === '-' || !callStartDate) && window.sheet01Data?.length > 0) {
        const sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
        if (sheet01Row) {
            if (!callStartDate || callStartDate === '-') callStartDate = sheet01Row['強制贖回起日'] || '-';
            if (!callEndDate || callEndDate === '-') callEndDate = sheet01Row['強制贖回迄日'] || '-';
            if (!callPrice || callPrice === '-') callPrice = sheet01Row['強制贖回價格'] || '-';
            if (!delistDate || delistDate === '-') delistDate = sheet01Row['終止櫃檯買賣日'] || '-';
        }
    }

    // 判斷是否有強制贖回條款
    const hasCallOption = callStartDate && callStartDate !== '-' && callStartDate !== '無';

    // v3.97-zs-ag: 投資人賣回條款欄位
    let putbackStartDate = '-';
    let putbackEndDate = '-';
    let putbackPrice = '-';
    let putbackCondition = '-';
    let putbackDate1 = '-';
    let putbackDate2 = '-';
    let putbackYTM = '-';  // 賣回殖利率

    // 從 yuantaHistoryData 讀取賣回權資訊
    if (window.yuantaHistoryData?.loaded) {
        const yuantaRow = window.yuantaHistoryData.data[searchCode];
        if (yuantaRow) {
            putbackStartDate = yuantaRow['最近賣回權起日'] || '-';
            putbackEndDate = yuantaRow['最近賣回權迄日'] || '-';
            putbackPrice = yuantaRow['最近賣回權價格'] || '-';
        }
    }

    // 從 sheet03Data (賣回條件工作表) 補充
    if (window.sheet03Data && window.sheet03Data.length > 0) {
        const putbackRow = window.sheet03Data.find(r => String(r['CB代號'] || r['代號']).trim() === searchCode);
        if (putbackRow) {
            if (!putbackCondition || putbackCondition === '-') putbackCondition = putbackRow['投資人提前賣回'] || '-';
            if (!putbackDate1 || putbackDate1 === '-') putbackDate1 = putbackRow['賣回日期1'] || '-';
            if (!putbackDate2 || putbackDate2 === '-') putbackDate2 = putbackRow['賣回日期2'] || '-';
            if (!putbackPrice || putbackPrice === '-') putbackPrice = putbackRow['賣回價格1'] || putbackRow['賣回價格'] || '-';
            if (!putbackYTM || putbackYTM === '-') putbackYTM = putbackRow['賣回殖利率'] || putbackRow['YTP'] || '-';
        }
    }

    // 從 sheet01Data 補充
    if (window.sheet01Data?.length > 0) {
        const sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
        if (sheet01Row) {
            if (!putbackDate1 || putbackDate1 === '-') putbackDate1 = sheet01Row['賣回日1'] || sheet01Row['賣回日期1'] || '-';
            if (!putbackDate2 || putbackDate2 === '-') putbackDate2 = sheet01Row['賣回日2'] || sheet01Row['賣回日期2'] || '-';
            if (!putbackPrice || putbackPrice === '-') putbackPrice = sheet01Row['賣回價格1'] || sheet01Row['賣回價格'] || '-';
        }
    }

    // 判斷是否有賣回條款
    const hasPutbackOption = (putbackDate1 && putbackDate1 !== '-') || (putbackStartDate && putbackStartDate !== '-');

    // 計算距離最近賣回日天數
    let daysToPutback = null;
    let nearestPutbackDate = null;
    const parsePutbackDate = (val) => {
        if (!val || val === '-') return null;
        if (typeof val === 'number') {
            return new Date((val - 25569) * 86400 * 1000);
        }
        const d = new Date(val);
        return isNaN(d.getTime()) ? null : d;
    };

    // 找最近的賣回日
    const pd1 = parsePutbackDate(putbackDate1);
    const pd2 = parsePutbackDate(putbackDate2);
    const pds = parsePutbackDate(putbackStartDate);

    [pd1, pd2, pds].forEach(d => {
        if (d && d > today) {
            if (!nearestPutbackDate || d < nearestPutbackDate) {
                nearestPutbackDate = d;
            }
        }
    });

    if (nearestPutbackDate) {
        daysToPutback = Math.ceil((nearestPutbackDate.getTime() - today.getTime()) / (24 * 60 * 60 * 1000));
    }

    // 格式化日期
    const formatCallDate = (val) => {
        if (!val || val === '-' || val === '無') return '-';
        if (typeof val === 'number') {
            const d = new Date((val - 25569) * 86400 * 1000);
            return d.toISOString().split('T')[0].replace(/-/g, '/');
        }
        return String(val);
    };

    // v3.97-zs-ai: 從 highLowMap (00工作表) 取得資金用途
    let fundUsage = '-';
    if (window.highLowMap && window.highLowMap[searchCode]) {
        const hlRow = window.highLowMap[searchCode];
        fundUsage = hlRow['資金用途'] || hlRow['募集資金用途'] || '-';
    }

    // v3.97-zs-ai: 從 sheet16 (industryMap) 取得更細的產業分類
    let detailedIndustry = industryInfo;
    if (stockCode && window.industryMap && window.industryMap[stockCode]) {
        detailedIndustry = window.industryMap[stockCode];
    }

    // 建立資訊卡片 - v3.97-zs-ai 優化：移除計算公式到底部方塊
    const html = `
        ${renderTabHeader('基本資料', '📋', '#1976d2', completeness.percentage, statusLabel, cbCode, cbName)}
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:18px;">
            <!-- 基本資訊卡 -->
            <div style="background:#e3f2fd; padding:20px; border-radius:12px; border-left:5px solid #1976d2;">
                <div style="font-weight:bold; color:#1565c0; margin-bottom:15px; font-size:16px;">📋 基本資訊</div>
                <table style="width:100%; font-size:15px; line-height:1.9;">
                    <tr><td style="color:#666; width:40%; padding:6px 0;">代號</td><td style="font-weight:600; padding:6px 0; text-align:right;">${data['CB代號'] || cbCode}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">名稱</td><td style="font-weight:600; padding:6px 0; text-align:right;">${data['名稱'] || '-'}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">轉換標的</td><td style="font-weight:600; padding:6px 0; text-align:right;">${data['股票代號'] || '-'}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">產業分類</td><td style="font-weight:600; padding:6px 0; text-align:right;">${detailedIndustry}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">信用評等</td><td style="font-weight:600; padding:6px 0; text-align:right;">TCRI ${creditRating}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">擔保情形</td><td style="font-weight:600; padding:6px 0; text-align:right;">${guarantee}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">發行方式</td><td style="color:${isAuction ? '#e65100' : '#1565c0'}; font-weight:bold; padding:6px 0; text-align:right;">${isAuction ? '🎯 競拍' : '📋 詢圈'}</td></tr>
                </table>
            </div>

            <!-- 發行條件卡 - v3.97-zs-ai 優化：新增資金用途 -->
            <div style="background:#fff3e0; padding:20px; border-radius:12px; border-left:5px solid #ff9800;">
                <div style="font-weight:bold; color:#e65100; margin-bottom:15px; font-size:16px;">💰 發行條件</div>
                <table style="width:100%; font-size:15px; line-height:1.9;">
                    <tr><td style="color:#666; width:40%; padding:6px 0;">發行規模</td><td style="font-weight:600; padding:6px 0; text-align:right;">${issueSizeBillion} 億 <span style="font-size:12px; color:#888;">(${formatNumber(totalShares)}張)</span></td></tr>
                    <tr><td style="color:#666; padding:6px 0;">發行價</td><td style="font-weight:600; padding:6px 0; text-align:right;">${issuePrice}元</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">訂價溢價率</td><td style="font-weight:600; padding:6px 0; text-align:right; color:${pricingPremium && parseFloat(pricingPremium) > 0 ? '#c62828' : '#2e7d32'};">${pricingPremium ? pricingPremium + '%' : '-'}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">發行年期</td><td style="font-weight:600; padding:6px 0; text-align:right;">${data['年期'] || '-'}年</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">剩餘年期</td><td style="color:${remainYears !== null && remainYears < 1 ? '#c62828' : '#2e7d32'}; font-weight:bold; padding:6px 0; text-align:right;">${remainYearsDisplay}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">承銷商</td><td style="font-weight:600; padding:6px 0; text-align:right;">${brokerDisplay}</td></tr>
                </table>
            </div>

            <!-- 轉換資訊卡 - v3.97-zs-ai 優化：移除公式說明 -->
            <div style="background:#e8f5e9; padding:20px; border-radius:12px; border-left:5px solid #4caf50;">
                <div style="font-weight:bold; color:#2e7d32; margin-bottom:15px; font-size:16px;">🔄 轉換資訊</div>
                <table style="width:100%; font-size:15px; line-height:1.9;">
                    <tr>
                        <td style="color:#666; width:40%; padding:6px 0;">發行轉換價</td>
                        <td style="font-weight:600; padding:6px 0; text-align:right;">${issueConvPrice || '-'}元</td>
                    </tr>
                    <tr>
                        <td style="color:#666; padding:6px 0;">最新轉換價</td>
                        <td style="font-weight:bold; color:#c62828; padding:6px 0; font-size:16px; text-align:right;">
                            ${latestConvPrice || '-'}元
                            ${convPriceAdjusted ? `<span style="font-size:11px; color:#e65100; margin-left:4px;">⚡調整</span>` : ''}
                        </td>
                    </tr>
                    ${convPriceAdjusted ? `
                    <tr>
                        <td style="color:#666; padding:6px 0; font-size:13px;">調整幅度</td>
                        <td style="padding:6px 0; text-align:right; font-size:13px; color:${latestConvPrice < issueConvPrice ? '#2e7d32' : '#c62828'};">
                            ${latestConvPrice < issueConvPrice ? '▼' : '▲'} ${Math.abs(latestConvPrice - issueConvPrice).toFixed(2)}元
                            (${((latestConvPrice - issueConvPrice) / issueConvPrice * 100).toFixed(2)}%)
                        </td>
                    </tr>
                    ` : ''}
                    <tr><td style="color:#666; padding:6px 0;">強贖觸發價</td><td style="color:#9c27b0; font-weight:bold; padding:6px 0; text-align:right;">${callTrigger130}元 <span style="font-size:11px; color:#888;">(130%)</span></td></tr>
                    <tr><td style="color:#666; padding:6px 0;">轉換比例</td><td style="font-weight:600; padding:6px 0; text-align:right;">${convRatio} 股</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">股票最新市價</td><td style="font-weight:bold; color:#1976d2; padding:6px 0; text-align:right;">${latestStockPrice > 0 ? latestStockPrice.toFixed(2) + '元' : '-'}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">理論價</td><td style="color:#e65100; font-weight:bold; padding:6px 0; text-align:right;">${theoreticalPrice ? theoreticalPrice + '元' : '-'}</td></tr>
                    <tr><td style="color:#666; padding:6px 0;">CB參考價格</td><td style="font-weight:bold; color:#2e7d32; padding:6px 0; text-align:right;">${latestCBPrice > 0 ? latestCBPrice.toFixed(2) + '元' : '-'}</td></tr>
                    <tr>
                        <td style="color:#666; padding:6px 0;">溢折價率</td>
                        <td style="font-weight:bold; padding:6px 0; text-align:right; color:${premiumDiscount !== null ? (parseFloat(premiumDiscount) > 0 ? '#c62828' : '#2e7d32') : '#666'};">
                            ${premiumDiscount !== null ? (parseFloat(premiumDiscount) > 0 ? '+' : '') + premiumDiscount + '%' : '-'}
                        </td>
                    </tr>
                </table>
                ${kanbanDate ? `<div style="text-align:right; font-size:11px; color:#999; margin-top:8px;">📅 資料日期: ${kanbanDate}</div>` : ''}
            </div>
        </div>

        <!-- v3.97-zs-ar 新增：資金用途獨立方塊（放在產業資訊前面）-->
        ${fundUsage && fundUsage !== '-' ? `
        <div style="margin-top:18px; background:rgba(255,152,0,0.1); padding:15px 18px; border-radius:10px; border-left:4px solid #ff9800;">
            <div style="font-size:14px; color:#666; margin-bottom:8px;">💵 資金用途</div>
            <div style="font-size:15px; color:#333; font-weight:600; line-height:1.6;">${fundUsage}</div>
        </div>
        ` : ''}

        <!-- v3.97-zs-ai 新增：產業資訊方塊 -->
        ${industryPosition ? `
        <div style="margin-top:18px; background:rgba(156,39,176,0.1); padding:15px 18px; border-radius:10px; border-left:4px solid #9c27b0;">
            <div style="font-size:14px; color:#666; margin-bottom:8px;">🏭 產業資訊</div>
            <div style="font-size:15px;">
                <strong style="color:#7b1fa2;">產業地位：</strong>
                <span style="color:#333; font-weight:600;">${industryPosition}</span>
            </div>
        </div>
        ` : ''}

        <!-- v3.97-zs-ai 新增：計算公式說明方塊 -->
        <div style="margin-top:18px; background:#f5f5f5; padding:15px 18px; border-radius:10px; border:1px solid #e0e0e0;">
            <div style="font-size:14px; color:#666; margin-bottom:10px;">📐 計算公式說明</div>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px; font-size:13px;">
                <div style="background:white; padding:12px; border-radius:8px; border-left:3px solid #e65100;">
                    <div style="color:#666; margin-bottom:6px;">理論價 (轉換價值)</div>
                    <div style="font-family:monospace; color:#e65100; font-weight:bold;">(股票市價 ÷ 轉換價) × 100</div>
                    <div style="color:#888; font-size:11px; margin-top:6px;">當理論價 > 100 代表具有轉換價值</div>
                </div>
                <div style="background:white; padding:12px; border-radius:8px; border-left:3px solid #1976d2;">
                    <div style="color:#666; margin-bottom:6px;">溢折價率</div>
                    <div style="font-family:monospace; color:#1976d2; font-weight:bold;">(CB價格 ÷ 理論價 - 1) × 100%</div>
                    <div style="color:#888; font-size:11px; margin-top:6px;">正值=溢價(貴)，負值=折價(便宜)</div>
                </div>
                <div style="background:white; padding:12px; border-radius:8px; border-left:3px solid #9c27b0;">
                    <div style="color:#666; margin-bottom:6px;">強贖觸發價</div>
                    <div style="font-family:monospace; color:#9c27b0; font-weight:bold;">轉換價 × 130%</div>
                    <div style="color:#888; font-size:11px; margin-top:6px;">股價連續30日達此價可能觸發強贖</div>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = html;
}

/**
 * 渲染發行時程
 */
function renderBasicInfoSchedule(cbCode, container) {
    const searchCode = String(cbCode).trim();

    // 從02工作表取得發行時程
    let scheduleData = null;
    if (window.sheet02Data && window.sheet02Data.length > 0) {
        scheduleData = window.sheet02Data.find(r => String(r['CB代號']).trim() === searchCode);
    }

    // 從08工作表取得詳細日期
    let sheet08Row = null;
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        sheet08Row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
    }

    // 從競拍資料補充
    let auctionData = null;
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        auctionData = window.auctionDataCache.find(r => String(r['CB代號']).trim() === searchCode);
    }

    // 從01工作表補充
    let sheet01Row = null;
    if (window.sheet01Data && window.sheet01Data.length > 0) {
        sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
    }

    // v3.97-zs-aj: 從13工作表取得暫停轉換資訊
    let suspendData = null;
    if (window.sheet13Data && window.sheet13Data.length > 0) {
        suspendData = window.sheet13Data.find(r => String(r['代號'] || r['CB代號']).trim() === searchCode);
    }

    if (!scheduleData && !sheet08Row && !auctionData && !sheet01Row) {
        container.innerHTML = `<div style="color:#999; padding:20px; text-align:center;">⚠️ 找不到 ${cbCode} 的發行時程資料</div>`;
        return;
    }

    // 整合各來源資料
    const getValue = (...sources) => {
        for (const v of sources) {
            if (v !== undefined && v !== null && v !== '' && v !== '-') return v;
        }
        return '-';
    };

    // v3.97-zs-af: 計算資料完整度
    const scheduleFields = ['董事會公告', '送件日期', '生效日期', '詢圈競拍日期', '代收價款公告', '掛牌日期', '到期日期'];
    const mergedData = {
        '董事會公告': getValue(scheduleData?.['董事會公告']),
        '送件日期': getValue(scheduleData?.['送件日期']),
        '生效日期': getValue(scheduleData?.['生效日期']),
        '詢圈競拍日期': getValue(scheduleData?.['詢圈競拍日期'], auctionData?.['截標日']),
        '代收價款公告': getValue(scheduleData?.['代收價款公告']),
        '掛牌日期': getValue(scheduleData?.['掛牌日期'], sheet08Row?.['掛牌日期'], auctionData?.['掛牌日期'], sheet01Row?.['掛牌日期']),
        '到期日期': getValue(scheduleData?.['到期日期'], sheet08Row?.['到期日'], auctionData?.['到期日期'], sheet01Row?.['到期日期'])
    };
    const completeness = calculateDataCompleteness(mergedData, scheduleFields);
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);
    const statusLabel = isListed ? '🟢 掛牌中' : '⚫ 已下市';

    // v3.97-zs-ag: 取得名稱
    const cbName = getValue(scheduleData?.['名稱'], sheet08Row?.['名稱'], auctionData?.['名稱']);

    // v3.97-zs-aj: 暫停轉換資訊處理
    let suspendHtml = '';
    const suspendStart = suspendData?.['暫停轉換起日'] || suspendData?.['停止轉換起日'] || sheet08Row?.['停止受理轉換登記日期起'];
    const suspendEnd = suspendData?.['暫停轉換迄日'] || suspendData?.['停止轉換迄日'] || sheet08Row?.['停止受理轉換登記日期訖'];

    if (suspendStart || suspendEnd) {
        suspendHtml = `
            <div style="background:rgba(255,193,7,0.2); padding:15px; border-radius:10px; border-left:4px solid #ffc107; margin-bottom:18px;">
                <div style="font-size:14px; color:#666; margin-bottom:8px;">⚠️ 暫停轉換資訊</div>
                <div style="font-size:15px; color:#f57c00; font-weight:bold;">
                    ${formatDate(suspendStart)} ~ ${formatDate(suspendEnd)}
                </div>
                ${suspendData?.['暫停轉換原因'] ? `<div style="font-size:13px; color:#888; margin-top:6px;">原因：${suspendData['暫停轉換原因']}</div>` : ''}
            </div>
        `;
    }

    const html = `
        <div style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding:25px; border-radius:12px;">
            ${renderTabHeader('發行時程', '📅', '#1565c0', completeness.percentage, statusLabel, cbCode, cbName)}

            <!-- 重要日期時間軸 - v3.97-zs-aj 統一方塊大小 -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(130px, 1fr)); gap:12px; margin-bottom:18px;">
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #9c27b0;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">董事會公告</div>
                    <div style="font-size:15px; font-weight:bold; color:#9c27b0;">${formatDate(getValue(scheduleData?.['董事會公告']))}</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #673ab7;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">送件日期</div>
                    <div style="font-size:15px; font-weight:bold; color:#673ab7;">${formatDate(getValue(scheduleData?.['送件日期']))}</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #3f51b5;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">生效日期</div>
                    <div style="font-size:15px; font-weight:bold; color:#3f51b5;">${formatDate(getValue(scheduleData?.['生效日期']))}</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #2196f3;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">詢圈/競拍日</div>
                    <div style="font-size:15px; font-weight:bold; color:#2196f3;">${getValue(scheduleData?.['詢圈競拍日期'], formatDate(auctionData?.['截標日']))}</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #009688;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">代收價款公告</div>
                    <div style="font-size:15px; font-weight:bold; color:#009688;">${formatDate(getValue(scheduleData?.['代收價款公告']))}</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #4caf50;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">掛牌日期</div>
                    <div style="font-size:15px; font-weight:bold; color:#4caf50;">${formatDate(getValue(scheduleData?.['掛牌日期'], sheet08Row?.['掛牌日期'], auctionData?.['掛牌日期'], sheet01Row?.['掛牌日期']))}</div>
                </div>
            </div>

            <!-- 到期與轉換資訊 - v3.97-zs-ar 調整順序：CBAS拆解日在到期日後面 -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(130px, 1fr)); gap:12px; margin-bottom:18px;">
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #d32f2f;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">到期日期</div>
                    <div style="font-size:15px; font-weight:bold; color:#d32f2f;">${formatDate(getValue(scheduleData?.['到期日期'], sheet08Row?.['到期日'], auctionData?.['到期日期'], sheet01Row?.['到期日期']))}</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #ff5722;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">CBAS拆解日</div>
                    <div style="font-size:15px; font-weight:bold; color:#ff5722;">${formatDate(getValue(scheduleData?.['CBAS拆解日']))}</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #7b1fa2;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">發行年期</div>
                    <div style="font-size:15px; font-weight:bold; color:#7b1fa2;">${getValue(sheet08Row?.['還本年限'], auctionData?.['年期'], sheet01Row?.['發行年期'])} 年</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #00bcd4;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">轉換開始</div>
                    <div style="font-size:15px; font-weight:bold; color:#00bcd4;">${formatDate(getValue(sheet08Row?.['轉換日期起']))}</div>
                </div>
                <div style="background:white; padding:15px 10px; border-radius:10px; text-align:center; border-left:4px solid #795548;">
                    <div style="font-size:13px; color:#666; margin-bottom:6px;">轉換結束</div>
                    <div style="font-size:15px; font-weight:bold; color:#795548;">${formatDate(getValue(sheet08Row?.['轉換日期迄']))}</div>
                </div>
            </div>

            <!-- v3.97-zs-aj: 暫停轉換資訊 -->
            ${suspendHtml}
        </div>
    `;

    container.innerHTML = html;
}

/**
 * 渲染賣回條件（整合03工作表和08工作表）
 */
function renderBasicInfoPutback(cbCode, container) {
    const searchCode = String(cbCode).trim();

    // 從03工作表取得賣回條件
    let putbackData = null;
    if (window.sheet03Data && window.sheet03Data.length > 0) {
        putbackData = window.sheet03Data.find(r => String(r['CB代號']).trim() === searchCode);
    }

    // 從08工作表取得提前償還資訊
    let sheet08Row = null;
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        sheet08Row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
    }

    // 從競拍資料補充
    let auctionData = null;
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        auctionData = window.auctionDataCache.find(r => String(r['CB代號']).trim() === searchCode);
    }

    // 從01工作表補充
    let sheet01Row = null;
    if (window.sheet01Data && window.sheet01Data.length > 0) {
        sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
    }

    if (!putbackData && !sheet08Row && !auctionData && !sheet01Row) {
        container.innerHTML = `<div style="color:#999; padding:20px; text-align:center;">⚠️ 找不到 ${cbCode} 的賣回條件資料</div>`;
        return;
    }

    const getValue = (...sources) => {
        for (const v of sources) {
            if (v !== undefined && v !== null && v !== '' && v !== '-') return v;
        }
        return '-';
    };

    // 擔保狀態判斷
    const guaranteeRaw = getValue(sheet08Row?.['債券擔保情形'], auctionData?.['擔保'], sheet01Row?.['擔保']);
    const isGuaranteed = guaranteeRaw && guaranteeRaw !== '無' && guaranteeRaw !== '-';
    const guaranteeColor = isGuaranteed ? '#2e7d32' : '#757575';
    const guaranteeIcon = isGuaranteed ? '🛡️' : '📝';

    // v3.97-zs-af: 計算資料完整度
    const putbackFields = ['投資人提前賣回', '賣回日期1', '賣回日期2', '到期價格', '到期殖利率', '擔保'];
    const mergedPutback = {
        '投資人提前賣回': getValue(putbackData?.['投資人提前賣回']),
        '賣回日期1': getValue(putbackData?.['賣回日期1']),
        '賣回日期2': getValue(putbackData?.['賣回日期2']),
        '到期價格': getValue(sheet08Row?.['到期價格'], sheet01Row?.['到期還本價格']),
        '到期殖利率': getValue(sheet08Row?.['到期殖利率']),
        '擔保': guaranteeRaw
    };
    const completeness = calculateDataCompleteness(mergedPutback, putbackFields);
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);
    const statusLabel = isListed ? '🟢 掛牌中' : '⚫ 已下市';

    // v3.97-zs-ag: 取得名稱
    const cbName = getValue(putbackData?.['名稱'], sheet08Row?.['名稱']);

    const html = `
        <div style="background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding:25px; border-radius:12px;">
            ${renderTabHeader('賣回條件', '💰', '#e65100', completeness.percentage, statusLabel, cbCode, cbName)}

            <!-- v3.97-zs-ag 投資人賣回權 - 新增說明和智能提示 -->
            <div style="background:white; padding:18px; border-radius:10px; margin-bottom:18px; border-left:5px solid #4caf50;">
                <div style="font-size:16px; color:#2e7d32; margin-bottom:8px; font-weight:bold;">👤 投資人賣回條款 (Investor Put Option)</div>
                <div style="font-size:14px; color:#888; margin-bottom:15px;">投資人有權利在賣回的時間依發行鎖定的價格及利率賣回給公司，公司無條件給付利息及本金</div>

                ${(() => {
                    // 計算各賣回日距今天數
                    const today = new Date();
                    const parseDateVal = (val) => {
                        if (!val || val === '-') return null;
                        if (typeof val === 'number') return new Date((val - 25569) * 86400 * 1000);
                        const d = new Date(val);
                        return isNaN(d.getTime()) ? null : d;
                    };
                    const pd1 = parseDateVal(getValue(putbackData?.['賣回日期1']));
                    const pd2 = parseDateVal(getValue(putbackData?.['賣回日期2']));
                    const days1 = pd1 ? Math.ceil((pd1 - today) / (24*60*60*1000)) : null;
                    const days2 = pd2 ? Math.ceil((pd2 - today) / (24*60*60*1000)) : null;
                    const days1Text = days1 !== null ? (days1 > 0 ? '餘' + days1 + '天' : '已過期') : '';
                    const days2Text = days2 !== null ? (days2 > 0 ? '餘' + days2 + '天' : '已過期') : '';

                    return '<div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:12px;">' +
                        '<div style="text-align:center; padding:12px; background:#e8f5e9; border-radius:8px; border:1px solid #a5d6a7;">' +
                            '<div style="font-size:13px; color:#888; margin-bottom:6px;">賣回日期1</div>' +
                            '<div style="font-size:16px; font-weight:bold; color:#2e7d32;">' + formatDate(getValue(putbackData?.['賣回日期1'])) + '</div>' +
                            (days1Text ? '<div style="font-size:12px; color:' + (days1 > 0 ? '#ff9800' : '#999') + '; margin-top:4px;">' + days1Text + '</div>' : '') +
                        '</div>' +
                        '<div style="text-align:center; padding:12px; background:#e8f5e9; border-radius:8px; border:1px solid #a5d6a7;">' +
                            '<div style="font-size:13px; color:#888; margin-bottom:6px;">賣回日期2</div>' +
                            '<div style="font-size:16px; font-weight:bold; color:#2e7d32;">' + formatDate(getValue(putbackData?.['賣回日期2'])) + '</div>' +
                            (days2Text ? '<div style="font-size:12px; color:' + (days2 > 0 ? '#ff9800' : '#999') + '; margin-top:4px;">' + days2Text + '</div>' : '') +
                        '</div>' +
                    '</div>';
                })()}

                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
                    <div style="text-align:center; padding:12px; background:#e8f5e9; border-radius:8px; border:1px solid #a5d6a7;">
                        <div style="font-size:13px; color:#888; margin-bottom:6px;">賣回價格</div>
                        <div style="font-size:18px; font-weight:bold; color:#2e7d32;">${getValue(putbackData?.['賣回價格1'], putbackData?.['賣回價格'], '100')} 元</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#e8f5e9; border-radius:8px; border:1px solid #a5d6a7;">
                        <div style="font-size:13px; color:#888; margin-bottom:6px;">賣回條件</div>
                        <div style="font-size:15px; font-weight:bold; color:#e65100;">${getValue(putbackData?.['投資人提前賣回'])}</div>
                    </div>
                </div>

                ${putbackData?.['賣回條件'] ? `
                <div style="margin-top:12px; padding:12px; background:#fff8e1; border-radius:8px; font-size:14px; color:#f57c00;">
                    <strong>賣回公式：</strong>${putbackData['賣回條件']}
                </div>
                ` : ''}

                ${(() => {
                    // 計算距離最近賣回日
                    const today = new Date();
                    const parseDateVal = (val) => {
                        if (!val || val === '-') return null;
                        if (typeof val === 'number') return new Date((val - 25569) * 86400 * 1000);
                        const d = new Date(val);
                        return isNaN(d.getTime()) ? null : d;
                    };
                    const pd1 = parseDateVal(getValue(putbackData?.['賣回日期1']));
                    const pd2 = parseDateVal(getValue(putbackData?.['賣回日期2']));
                    let nearestDate = null;
                    [pd1, pd2].forEach(d => {
                        if (d && d > today && (!nearestDate || d < nearestDate)) nearestDate = d;
                    });
                    if (nearestDate) {
                        const days = Math.ceil((nearestDate - today) / (24*60*60*1000));
                        if (days > 0 && days < 365) {
                            const putPrice = getValue(putbackData?.['賣回價格1'], putbackData?.['賣回價格'], '100');
                            return '<div style="margin-top:12px; padding:12px 15px; background:#e3f2fd; border-radius:8px; font-size:14px; color:#1565c0; border-left:3px solid #1976d2;">📌 <strong>提示：</strong>此CB距離最近賣回日僅剩 <strong>' + days + '</strong> 天，若目前價格低於賣回價格，可考慮買進後於賣回日以 ' + putPrice + ' 元賣回給公司。</div>';
                        }
                    }
                    return '';
                })()}
            </div>

            <!-- 到期還本與擔保 -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:15px;">
                <div style="background:white; padding:18px 15px; border-radius:10px; text-align:center;">
                    <div style="font-size:14px; color:#666; margin-bottom:8px;">到期還本價格</div>
                    <div style="font-size:20px; font-weight:bold; color:#d32f2f;">
                        ${getValue(sheet08Row?.['到期價格'], sheet01Row?.['到期還本價格'])} 元
                    </div>
                </div>
                <div style="background:white; padding:18px 15px; border-radius:10px; text-align:center;">
                    <div style="font-size:14px; color:#666; margin-bottom:8px;">到期殖利率</div>
                    <div style="font-size:20px; font-weight:bold; color:#1976d2;">
                        ${getValue(sheet08Row?.['到期殖利率'])}%
                    </div>
                </div>
                <div style="background:white; padding:18px 15px; border-radius:10px; text-align:center;">
                    <div style="font-size:14px; color:#666; margin-bottom:8px;">${guaranteeIcon} 擔保狀態</div>
                    <div style="font-size:18px; font-weight:bold; color:${guaranteeColor};">
                        ${isGuaranteed ? '有擔保' : '無擔保'}
                    </div>
                </div>
            </div>

            ${isGuaranteed && guaranteeRaw.length > 5 ? `
            <div style="margin-top:12px; padding:12px 15px; background:rgba(46,125,50,0.1); border-radius:8px; font-size:14px; color:#2e7d32;">
                <strong>擔保機構：</strong>${guaranteeRaw.replace('有，', '')}
            </div>
            ` : ''}
        </div>
    `;

    container.innerHTML = html;
}

/**
 * v3.97-zs-u 新增：渲染終止狀態（強制贖回、下市資訊）
 * 資料來源：kanban_data.js
 */
/**
 * v3.97-zs-u 新增：渲染終止狀態（強制贖回、下市資訊）
 * v3.97-zs-ag 修正：從 kanbanData 讀取強制贖回資料
 * v3.97-zs-bf 簡化：移除獨立預載入，直接從 kanbanData CSV 讀取（已包含所有欄位）
 */

/**
 * v3.97-zs-br 修正：強制贖回標籤頁（改為同步函數）
 * 資料來源：sheet01Data 或 yuantaHistoryData（已在啟動時載入）
 * 不再等待 kanbanData，避免切換標籤卡住
 */
function renderBasicInfoCallOption(cbCode, container) {
    const searchCode = String(cbCode).replace(/\.0*$/, '').trim();

    // 從 sheet08 取得名稱
    let cbName = '';
    if (window.sheet08Data?.length > 0) {
        const row = window.sheet08Data.find(r => String(r['代號']).replace(/\.0*$/, '').trim() === searchCode);
        cbName = row?.['名稱'] || '';
    }

    // 判斷掛牌狀態
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode) || false;
    const statusLabel = isListed ? '🟢 掛牌中' : '⚫ 已下市';

    // v3.97-as-bz: 強制贖回資料來源
    // - kanban: 主要來源（強制贖回起日、迄日、價格）
    // - 12_call_execute: 最新公布強制贖回的標的（補充）
    // - yuanta: 終止櫃檯買賣日（判斷提前下市）
    let callStartDate = '-', callEndDate = '-', callPrice = '-', delistDate = '-';
    let hasData = false;
    let dataSource = '';

    // 1. 主要從 kanbanData 讀取強制贖回資料（最新一筆）
    if (window.kanbanData?.loaded && window.kanbanData.data[searchCode]?.length > 0) {
        const kanbanRecords = window.kanbanData.data[searchCode];
        const latestRecord = kanbanRecords[kanbanRecords.length - 1];
        if (latestRecord) {
            if (latestRecord.callStartDate) callStartDate = latestRecord.callStartDate;
            if (latestRecord.callEndDate) callEndDate = latestRecord.callEndDate;
            if (latestRecord.callPrice) callPrice = latestRecord.callPrice;
            if (latestRecord.delistDate) delistDate = latestRecord.delistDate;
            if (latestRecord.cbName && !cbName) cbName = latestRecord.cbName;
            hasData = (callStartDate !== '-' && callStartDate) ||
                      (callEndDate !== '-' && callEndDate) ||
                      (callPrice !== '-' && callPrice);
            if (hasData) dataSource = 'CB_kanban';
        }
    }

    // 2. 從 12_call_execute.csv 補充（最新公布強制贖回標的）
    if (window.sheet12Data?.length > 0) {
        const sheet12Row = window.sheet12Data.find(r =>
            String(r['CB代號'] || r['代號'] || r['證券代號'] || '').replace(/\.0*$/, '').trim() === searchCode
        );
        if (sheet12Row) {
            if (!callStartDate || callStartDate === '-') callStartDate = sheet12Row['強制贖回起日'] || sheet12Row['贖回起日'] || '-';
            if (!callEndDate || callEndDate === '-') callEndDate = sheet12Row['強制贖回迄日'] || sheet12Row['贖回迄日'] || '-';
            if (!callPrice || callPrice === '-') callPrice = sheet12Row['強制贖回價格'] || sheet12Row['贖回價格'] || '-';
            if (!cbName) cbName = sheet12Row['名稱'] || sheet12Row['CB名稱'] || '';
            if (!hasData && (callStartDate !== '-' || callEndDate !== '-')) {
                hasData = true;
                if (!dataSource) dataSource = '12_call_execute';
            }
        }
    }

    // 3. 從 yuantaHistoryData 讀取終止櫃檯買賣日（判斷提前下市）
    if (window.yuantaHistoryData?.loaded && window.yuantaHistoryData.data[searchCode]) {
        const yuantaRow = window.yuantaHistoryData.data[searchCode];
        if (!delistDate || delistDate === '-') delistDate = yuantaRow['終止櫃檯買賣日'] || '-';
        if (!cbName) cbName = yuantaRow['名稱'] || '';
    }

    // 4. 從 sheet08Data (08_weekly_basic.csv) 補充終止日期
    if (window.sheet08Data?.length > 0) {
        const sheet08Row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
        if (sheet08Row) {
            if (!delistDate || delistDate === '-') {
                delistDate = sheet08Row['終止櫃檯買賣日'] || sheet08Row['下市日'] || '-';
            }
            if (!cbName) cbName = sheet08Row['名稱'] || '';
        }
    }

    // 格式化日期
    const formatDate = (val) => {
        if (!val || val === '-') return '-';
        if (typeof val === 'number') {
            // Excel 日期數字
            const d = new Date((val - 25569) * 86400 * 1000);
            return d.getFullYear() + '' + String(d.getMonth() + 1).padStart(2, '0') + String(d.getDate()).padStart(2, '0');
        }
        return String(val).replace(/[-\/]/g, '').slice(0, 8);
    };

    callStartDate = formatDate(callStartDate);
    callEndDate = formatDate(callEndDate);
    delistDate = formatDate(delistDate);


    // 判斷是否有強制贖回條款
    const hasCallOption = callStartDate !== '-' || callEndDate !== '-' ||
                          (callPrice !== '-' && parseFloat(callPrice) > 0);
    const isDelisted = delistDate !== '-';

    // 計算提早下市天數
    let earlyDelistDays = '';
    if (isDelisted) {
        let maturityDateStr = '';
        if (window.sheet08Data?.length > 0) {
            const row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
            if (row) maturityDateStr = row['到期日'] || '';
        }
        if (!maturityDateStr && window.sheet01Data?.length > 0) {
            const row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
            if (row) maturityDateStr = row['到期日期'] || '';
        }

        if (maturityDateStr && delistDate) {
            try {
                const parseDate = (str) => {
                    if (!str || str === '-') return null;
                    if (typeof str === 'number') {
                        return new Date((str - 25569) * 86400 * 1000);
                    }
                    const cleaned = String(str).replace(/[-\/]/g, '');
                    if (cleaned.length === 8) {
                        return new Date(cleaned.slice(0, 4), parseInt(cleaned.slice(4, 6)) - 1, cleaned.slice(6, 8));
                    }
                    return new Date(str);
                };

                const maturityDate = parseDate(maturityDateStr);
                const delistDateObj = parseDate(delistDate);

                if (maturityDate && delistDateObj && !isNaN(maturityDate.getTime()) && !isNaN(delistDateObj.getTime())) {
                    const diffMs = maturityDate.getTime() - delistDateObj.getTime();
                    const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
                    if (diffDays > 0) {
                        earlyDelistDays = `（距到期日提早 ${diffDays} 天下市）`;
                    } else if (diffDays < 0) {
                        earlyDelistDays = `（超過到期日 ${Math.abs(diffDays)} 天）`;
                    }
                }
            } catch (e) {
                console.warn('計算提早下市天數失敗:', e);
            }
        }
    }

    // 計算資料完整度
    let filledCount = 0;
    if (callStartDate !== '-') filledCount++;
    if (callEndDate !== '-') filledCount++;
    if (callPrice !== '-' && callPrice !== '0') filledCount++;
    if (delistDate !== '-') filledCount++;
    const completeness = Math.round((filledCount / 4) * 100);

    const html = `
        <div style="background:linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); padding:25px; border-radius:12px;">
            ${renderTabHeader('強制贖回', '🔔', '#c2185b', completeness, statusLabel, cbCode, cbName)}

            <!-- 公司可贖回條件說明 -->
            <div style="background:white; padding:18px; border-radius:10px; margin-bottom:18px; border-left:5px solid #7b1fa2;">
                <div style="font-size:15px; color:#7b1fa2; margin-bottom:12px; font-weight:bold;">📋 公司可贖回條件 (一般條款)</div>
                <div style="font-size:14px; color:#333; line-height:1.8;">
                    <div style="display:flex; align-items:flex-start; margin-bottom:8px;">
                        <span style="background:#7b1fa2; color:white; padding:2px 8px; border-radius:4px; font-size:12px; margin-right:10px;">1</span>
                        <span>流通在外餘額低於原發行總額之 <strong style="color:#c62828;">10%</strong></span>
                    </div>
                    <div style="display:flex; align-items:flex-start;">
                        <span style="background:#7b1fa2; color:white; padding:2px 8px; border-radius:4px; font-size:12px; margin-right:10px;">2</span>
                        <span>收盤價連續 <strong style="color:#c62828;">30個營業日</strong> 超過當時轉換價格達 <strong style="color:#c62828;">30%</strong>（即轉換價×130%）</span>
                    </div>
                </div>
                <div style="margin-top:12px; font-size:12px; color:#888; background:#f5f5f5; padding:10px; border-radius:6px;">
                    💡 各發行公司條款可能略有不同，實際以公開說明書為準
                </div>
            </div>

            <!-- 資料來源說明 -->
            <div style="background:white; padding:12px 15px; border-radius:8px; margin-bottom:18px; font-size:13px; color:#666;">
                📊 資料來源：${dataSource === 'CB_kanban' ? 'CB_kanban' : dataSource === '12_call_execute' ? '12_call_execute（最新公布）' : dataSource || '系統資料庫'}
            </div>

            <!-- 強制贖回資料 -->
            <div style="background:white; padding:20px; border-radius:12px; border-left:5px solid #c2185b;">
                <div style="font-size:16px; color:#c2185b; margin-bottom:15px; font-weight:bold;">
                    🏢 發行人提前贖回權 (Issuer Call Option)
                </div>

                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px;">
                    <div style="text-align:center; padding:15px; background:#fce4ec; border-radius:10px;">
                        <div style="font-size:13px; color:#888; margin-bottom:8px;">強制贖回起日</div>
                        <div style="font-size:18px; font-weight:bold; color:#c2185b;">${callStartDate}</div>
                    </div>
                    <div style="text-align:center; padding:15px; background:#fce4ec; border-radius:10px;">
                        <div style="font-size:13px; color:#888; margin-bottom:8px;">強制贖回迄日</div>
                        <div style="font-size:18px; font-weight:bold; color:#c2185b;">${callEndDate}</div>
                    </div>
                    <div style="text-align:center; padding:15px; background:#e8f5e9; border-radius:10px;">
                        <div style="font-size:13px; color:#888; margin-bottom:8px;">強制贖回價格</div>
                        <div style="font-size:20px; font-weight:bold; color:#2e7d32;">
                            ${callPrice !== '-' && parseFloat(callPrice) > 0 ? callPrice + ' 元' : '-'}
                        </div>
                    </div>
                    <div style="text-align:center; padding:15px; background:${isDelisted ? '#ffebee' : '#fce4ec'}; border-radius:10px;">
                        <div style="font-size:13px; color:#888; margin-bottom:8px;">終止櫃檯買賣日</div>
                        <div style="font-size:18px; font-weight:bold; color:${isDelisted ? '#d32f2f' : '#c2185b'};">${delistDate}</div>
                    </div>
                </div>

                ${hasCallOption ? `
                <div style="margin-top:18px; padding:12px 15px; background:#fff3e0; border-radius:8px; font-size:14px; color:#e65100; border-left:3px solid #ff9800;">
                    <strong>⚠️ 投資提醒：</strong>當股價觸及強制贖回條件時，發行公司可能執行強制贖回，屆時CB持有人需在期限內轉換或以贖回價賣回。
                </div>
                ` : ''}

                ${isDelisted ? `
                <div style="margin-top:12px; padding:12px 15px; background:#ffebee; border-radius:8px; font-size:14px; color:#c62828; border-left:3px solid #ef5350;">
                    <strong>📌 已終止：</strong>此CB已於 ${delistDate} 終止櫃檯買賣。${earlyDelistDays ? `<span style="color:#7b1fa2; font-weight:bold;">${earlyDelistDays}</span>` : ''}
                </div>
                ` : ''}
            </div>

            ${!hasData ? `
            <div style="margin-top:18px; padding:15px; background:#fff8e1; border-radius:8px; font-size:14px; color:#f57c00; text-align:center;">
                ⚠️ 此CB在資料庫中無強制贖回紀錄
            </div>
            ` : ''}
        </div>
    `;

    container.innerHTML = html;
}
function renderBasicInfoAuction(cbCode, container) {
    let data = null;
    const searchCode = String(cbCode).trim();

    // 先檢查是否為競拍發行
    const db = window.cbDatabase;
    const cbInfo = db.allCB.find(cb => cb.code === searchCode);
    const isAuction = cbInfo?.isAuction || db.auctionCodes.has(searchCode);

    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        data = window.auctionDataCache.find(r => String(r['CB代號']).trim() === searchCode);
    }
    if (!data && window.auctionRawData && window.auctionRawData.length > 0) {
        data = window.auctionRawData.find(r => String(r.cbCode).trim() === searchCode);
    }
    if (!data && db.auction[searchCode]) {
        data = db.auction[searchCode];
    }

    if (!data || !isAuction) {
        // 詢圈發行 - 顯示說明
        const isListed = window.cbDatabase?.listedCodes?.has(searchCode);
        const statusLabel = isListed ? '🟢 掛牌中' : '⚫ 已下市';

        // v3.97-zs-ag: 取得名稱
        let cbName = '';
        if (window.sheet08Data && window.sheet08Data.length > 0) {
            const sheet08Row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
            cbName = sheet08Row?.['名稱'] || '';
        }
        if (!cbName && window.sheet01Data && window.sheet01Data.length > 0) {
            const sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
            cbName = sheet01Row?.['名稱'] || '';
        }

        container.innerHTML = `
            <div style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding:25px; border-radius:8px;">
                ${renderTabHeader('競拍資料', '🎯', '#1976d2', 0, statusLabel, cbCode, cbName)}
                <div style="text-align:center; margin-top:20px;">
                    <div style="font-size:48px; margin-bottom:15px;">📋</div>
                    <div style="font-weight:bold; color:#1976d2; font-size:18px; margin-bottom:10px;">本檔為詢圈發行</div>
                    <div style="color:#666; font-size:14px; line-height:1.8;">
                        ${cbCode} 採用詢圈方式發行，無公開競拍資料。<br>
                        詢圈發行由承銷商向特定法人詢價圈購，<br>
                        不經由公開競標程序。
                    </div>
                    <div style="margin-top:20px; padding:12px 15px; background:rgba(255,255,255,0.8); border-radius:6px;">
                        <div style="font-size:13px; color:#666;">💡 提示：可切換至「基本資料」或「發行時程」查看其他發行條件</div>
                    </div>
                </div>
            </div>`;
        return;
    }

    // v3.97-zs-af: 計算資料完整度
    const auctionFields = ['開標日期', '截標日', '競拍張數', '底標價', '截標收盤', '轉換價', '理論價', '最低得標', '平均得標', '投標倍數'];
    const completeness = calculateDataCompleteness(data, auctionFields);
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);
    const statusLabel = isListed ? '🟢 掛牌中' : '⚫ 已下市';

    // v3.97-zs-ag: 取得名稱
    const cbName = data['名稱'] || '';

    // v3.97-zs-ag: 取得額外欄位
    const pricingPremium = data['訂價溢價率'] || data['訂價溢價'] || null;
    const qualifiedCount = data['合格件數'] || data['合格標單'] || null;
    const bidShares = data['投標張數'] || data['投標總張數'] || null;
    const bidMultiple = data['投標倍數'] || null;
    const avgBidShares = data['投標均張'] || data['平均投標張數'] || null;

    const html = `
        <div style="background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding:25px; border-radius:12px;">
            ${renderTabHeader('競拍資料', '🎯', '#2e7d32', completeness.percentage, statusLabel, cbCode, cbName)}

            <!-- 第一區：基本競拍資訊 -->
            <div style="background:white; padding:18px; border-radius:10px; margin-bottom:15px; border-left:5px solid #4caf50;">
                <div style="font-weight:bold; color:#2e7d32; margin-bottom:15px; font-size:15px;">📅 競拍基本資訊</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px;">
                    <div style="text-align:center; padding:12px; background:#e8f5e9; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">開標日期</div>
                        <div style="font-size:16px; font-weight:bold; color:#2e7d32;">${formatDate(data['開標日期'])}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#e8f5e9; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">截標日</div>
                        <div style="font-size:16px; font-weight:bold;">${formatDate(data['截標日'])}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#e8f5e9; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">競拍張數</div>
                        <div style="font-size:16px; font-weight:bold;">${formatNumber(data['競拍張數'])}張</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#e8f5e9; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">底標價</div>
                        <div style="font-size:16px; font-weight:bold; color:#c62828;">${data['底標價'] || '-'}元</div>
                    </div>
                </div>
            </div>

            <!-- 第二區：價格資訊 -->
            <div style="background:white; padding:18px; border-radius:10px; margin-bottom:15px; border-left:5px solid #1976d2;">
                <div style="font-weight:bold; color:#1565c0; margin-bottom:15px; font-size:15px;">💰 價格資訊</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px;">
                    <div style="text-align:center; padding:12px; background:#e3f2fd; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">截標收盤價</div>
                        <div style="font-size:16px; font-weight:bold;">${data['截標收盤'] || '-'}元</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#e3f2fd; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">轉換價</div>
                        <div style="font-size:16px; font-weight:bold;">${data['轉換價'] || '-'}元</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#e3f2fd; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">理論價</div>
                        <div style="font-size:16px; font-weight:bold; color:#1976d2;">${data['理論價'] ? parseFloat(data['理論價']).toFixed(2) : '-'}元</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#fff3e0; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">訂價溢價率</div>
                        <div style="font-size:16px; font-weight:bold; color:#e65100;">${pricingPremium ? (parseFloat(pricingPremium) * 100).toFixed(2) + '%' : '-'}</div>
                    </div>
                </div>
            </div>

            <!-- 第三區：得標結果（重點） -->
            <div style="background:white; padding:18px; border-radius:10px; margin-bottom:15px; border-left:5px solid #ff9800;">
                <div style="font-weight:bold; color:#e65100; margin-bottom:15px; font-size:15px;">🏆 得標結果</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px;">
                    <div style="text-align:center; padding:15px; background:#e8f5e9; border-radius:10px; border:3px solid #4caf50;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">最低得標價</div>
                        <div style="font-size:24px; font-weight:bold; color:#2e7d32;">${data['最低得標'] || '-'}元</div>
                    </div>
                    <div style="text-align:center; padding:15px; background:#e8f5e9; border-radius:10px;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">最低溢價</div>
                        <div style="font-size:18px; font-weight:bold; color:#2e7d32;">${data['最低溢價'] ? (data['最低溢價'] * 100).toFixed(2) + '%' : '-'}</div>
                    </div>
                    <div style="text-align:center; padding:15px; background:#fff3e0; border-radius:10px; border:3px solid #ff9800;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">平均得標價</div>
                        <div style="font-size:24px; font-weight:bold; color:#e65100;">${data['平均得標'] || '-'}元</div>
                    </div>
                    <div style="text-align:center; padding:15px; background:#fff3e0; border-radius:10px;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">平均溢價</div>
                        <div style="font-size:18px; font-weight:bold; color:#e65100;">${data['平均溢價'] ? (data['平均溢價'] * 100).toFixed(2) + '%' : '-'}</div>
                    </div>
                </div>
            </div>

            <!-- 第四區：投標統計 -->
            <div style="background:white; padding:18px; border-radius:10px; border-left:5px solid #9c27b0;">
                <div style="font-weight:bold; color:#7b1fa2; margin-bottom:15px; font-size:15px;">📊 投標統計</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px;">
                    <div style="text-align:center; padding:12px; background:#f3e5f5; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">合格件數</div>
                        <div style="font-size:18px; font-weight:bold; color:#7b1fa2;">${qualifiedCount ? formatNumber(qualifiedCount) + '件' : '-'}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#f3e5f5; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">投標張數</div>
                        <div style="font-size:18px; font-weight:bold; color:#7b1fa2;">${bidShares ? formatNumber(bidShares) + '張' : '-'}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#f3e5f5; border-radius:8px; border:2px solid #9c27b0;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">投標倍數</div>
                        <div style="font-size:20px; font-weight:bold; color:#7b1fa2;">${bidMultiple ? parseFloat(bidMultiple).toFixed(2) + 'x' : '-'}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#f3e5f5; border-radius:8px;">
                        <div style="font-size:12px; color:#666; margin-bottom:6px;">投標均張</div>
                        <div style="font-size:18px; font-weight:bold; color:#7b1fa2;">${avgBidShares ? parseFloat(avgBidShares).toFixed(1) + '張' : '-'}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = html;
}

/**
 * 渲染最新行情（整合09工作表）
 */
function renderBasicInfoQuote(cbCode, container) {
    const searchCode = String(cbCode).trim();
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);

    // 從09工作表取得最新行情（掛牌中CB）
    let quoteData = null;
    if (window.sheet09Data && window.sheet09Data.length > 0) {
        quoteData = window.sheet09Data.find(r => String(r['代碼']).trim() === searchCode);
    }

    // 從競拍資料取得截標日資訊
    let auctionData = null;
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        auctionData = window.auctionDataCache.find(r => String(r['CB代號']).trim() === searchCode);
    }

    // 從08工作表補充
    let sheet08Row = null;
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        sheet08Row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
    }

    if (!quoteData && !auctionData && !sheet08Row) {
        container.innerHTML = `<div style="color:#999; padding:20px; text-align:center;">⚠️ 找不到 ${cbCode} 的行情資料</div>`;
        return;
    }

    // 如果是掛牌中且有09工作表資料，顯示最新行情
    if (isListed && quoteData) {
        const cbPrice = parseFloat(quoteData['CB收盤價']) || 0;
        const stockPrice = parseFloat(quoteData['股價']) || 0;
        const convPrice = parseFloat(quoteData['轉換價格']) || 0;
        const convValue = parseFloat(quoteData['轉換價值']) || 0;
        const premium = parseFloat(quoteData['溢(折)價%']) || 0;
        const premiumColor = premium >= 0 ? '#d32f2f' : '#2e7d32';
        const premiumSign = premium >= 0 ? '+' : '';

        // v3.97-zs-af: 計算資料完整度
        const quoteFields = ['CB收盤價', '股價', '轉換價格', '轉換價值', '溢(折)價%', '成交量', 'YTM', 'YTP', 'TCRI'];
        const completeness = calculateDataCompleteness(quoteData, quoteFields);

        // v3.97-zs-ag: 取得名稱
        const cbName = (quoteData['名稱  '] || quoteData['名稱'] || '').trim();

        const html = `
            <div style="background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding:25px; border-radius:12px;">
                ${renderTabHeader('最新行情', '📊', '#2e7d32', completeness.percentage, '🟢 掛牌中', cbCode, cbName)}

                <!-- 主要報價 - v3.97-zs-z 字體優化 -->
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:18px;">
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center; border:2px solid #4caf50;">
                        <div style="font-size:14px; color:#666; margin-bottom:8px;">CB收盤價</div>
                        <div style="font-size:26px; font-weight:bold; color:#2e7d32;">${cbPrice || '-'}</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center;">
                        <div style="font-size:14px; color:#666; margin-bottom:8px;">股票收盤</div>
                        <div style="font-size:22px; font-weight:bold; color:#1976d2;">${stockPrice || '-'}</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center;">
                        <div style="font-size:14px; color:#666; margin-bottom:8px;">轉換價格</div>
                        <div style="font-size:20px; font-weight:bold;">${convPrice || '-'}</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center;">
                        <div style="font-size:14px; color:#666; margin-bottom:8px;">轉換價值</div>
                        <div style="font-size:20px; font-weight:bold; color:#7b1fa2;">${convValue ? convValue.toFixed(2) : '-'}</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center; border:2px solid ${premiumColor};">
                        <div style="font-size:14px; color:#666; margin-bottom:8px;">溢(折)價率</div>
                        <div style="font-size:22px; font-weight:bold; color:${premiumColor};">${premiumSign}${premium.toFixed(2)}%</div>
                    </div>
                </div>

                <!-- 詳細資訊 - v3.97-zs-z 字體優化 -->
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:18px;">
                    <div style="background:rgba(255,255,255,0.9); padding:15px; border-radius:8px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">成交量(張)</div>
                        <div style="font-size:18px; font-weight:bold;">${quoteData['成交量'] || '-'}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.9); padding:15px; border-radius:8px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">YTM</div>
                        <div style="font-size:18px; font-weight:bold; color:#1976d2;">${quoteData['YTM'] ? parseFloat(quoteData['YTM']).toFixed(2) + '%' : '-'}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.9); padding:15px; border-radius:8px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">YTP</div>
                        <div style="font-size:18px; font-weight:bold; color:#e65100;">${quoteData['YTP'] ? parseFloat(quoteData['YTP']).toFixed(2) + '%' : '-'}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.9); padding:15px; border-radius:8px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">TCRI</div>
                        <div style="font-size:18px; font-weight:bold;">${quoteData['TCRI'] || '-'}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.9); padding:15px; border-radius:8px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">120日波動</div>
                        <div style="font-size:18px; font-weight:bold;">${quoteData['股價波動率120天(%)'] ? parseFloat(quoteData['股價波動率120天(%)']).toFixed(1) : '-'}%</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.9); padding:15px; border-radius:8px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">240日波動</div>
                        <div style="font-size:18px; font-weight:bold;">${quoteData['股價波動率240天(%)'] ? parseFloat(quoteData['股價波動率240天(%)']).toFixed(1) : '-'}%</div>
                    </div>
                </div>

                <!-- 法人動向 -->
                <div style="background:rgba(255,255,255,0.9); padding:15px; border-radius:8px;">
                    <div style="font-size:14px; color:#555; margin-bottom:12px; font-weight:bold;">📈 法人買賣超</div>
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; text-align:center;">
                        <div>
                            <div style="font-size:13px; color:#666; margin-bottom:5px;">自營商買</div>
                            <div style="font-size:18px; font-weight:bold; color:#d32f2f;">${quoteData['自營商買張數'] || 0}</div>
                        </div>
                        <div>
                            <div style="font-size:13px; color:#666; margin-bottom:5px;">自營商賣</div>
                            <div style="font-size:18px; font-weight:bold; color:#2e7d32;">${quoteData['自營商賣張數'] || 0}</div>
                        </div>
                        <div>
                            <div style="font-size:13px; color:#666; margin-bottom:5px;">外資買</div>
                            <div style="font-size:18px; font-weight:bold; color:#d32f2f;">${quoteData['外資買張數'] || 0}</div>
                        </div>
                        <div>
                            <div style="font-size:13px; color:#666; margin-bottom:5px;">外資賣</div>
                            <div style="font-size:18px; font-weight:bold; color:#2e7d32;">${quoteData['外資賣張數'] || 0}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = html;
        return;
    }

    // 已下市CB或無09資料，顯示截標日行情
    if (auctionData) {
        const stockPrice = parseFloat(auctionData['截標收盤']) || 0;
        const convPrice = parseFloat(auctionData['轉換價']) || 0;
        const theoPrice = parseFloat(auctionData['理論價']) || 0;
        const convValue = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;

        // v3.97-zs-af: 計算資料完整度
        const auctionQuoteFields = ['截標收盤', '轉換價', '理論價', '最低得標', '平均得標'];
        const completeness = calculateDataCompleteness(auctionData, auctionQuoteFields);
        const statusLabel = isListed ? '🟢 掛牌中(無即時報價)' : '⚫ 已下市';

        // v3.97-zs-ag: 取得名稱
        const cbName = auctionData['名稱'] || '';

        const html = `
            <div style="background:linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); padding:25px; border-radius:12px;">
                ${renderTabHeader('截標日行情', '📊', '#c2185b', completeness.percentage, statusLabel, cbCode, cbName)}
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:15px;">
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">截標日股價</div>
                        <div style="font-size:20px; font-weight:bold; color:#c2185b;">${stockPrice || '-'}元</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">轉換價格</div>
                        <div style="font-size:18px; font-weight:bold;">${convPrice || '-'}元</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">轉換價值</div>
                        <div style="font-size:18px; font-weight:bold; color:#1976d2;">${convValue ? convValue.toFixed(2) : '-'}元</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center; border:3px solid #9c27b0;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">理論價</div>
                        <div style="font-size:20px; font-weight:bold; color:#7b1fa2;">${theoPrice ? theoPrice.toFixed(2) : '-'}元</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">年化波動率</div>
                        <div style="font-size:18px; font-weight:bold;">${auctionData['年化波動'] ? (auctionData['年化波動'] * 100).toFixed(2) + '%' : '-'}</div>
                    </div>
                    <div style="background:white; padding:18px 12px; border-radius:10px; text-align:center;">
                        <div style="font-size:13px; color:#666; margin-bottom:8px;">投標倍數</div>
                        <div style="font-size:18px; font-weight:bold; color:#e65100;">${auctionData['投標倍數'] ? auctionData['投標倍數'].toFixed(2) + 'x' : '-'}</div>
                    </div>
                </div>
                <div style="margin-top:18px; padding:12px 15px; background:rgba(255,255,255,0.9); border-radius:8px; font-size:14px; color:#666;">
                    💡 以上為截標日之行情資料${isListed ? '，如需最新報價請更新09工作表' : ''}
                </div>
            </div>
        `;
        container.innerHTML = html;
        return;
    }

    // 詢圈發行，無行情資料 - v3.97-zs-ag: 取得名稱
    let cbNameInquiry = '';
    if (sheet08Row) cbNameInquiry = sheet08Row['名稱'] || '';
    if (!cbNameInquiry && window.sheet01Data && window.sheet01Data.length > 0) {
        const sheet01Row = window.sheet01Data.find(r => String(r['CB代號']).trim() === searchCode);
        cbNameInquiry = sheet01Row?.['名稱'] || '';
    }

    container.innerHTML = `
        <div style="background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding:30px; border-radius:12px;">
            ${renderTabHeader('最新行情', '📊', '#1976d2', 0, isListed ? '🟢 掛牌中' : '⚫ 已下市', cbCode, cbNameInquiry)}
            <div style="text-align:center; margin-top:15px;">
                <div style="font-size:56px; margin-bottom:18px;">📋</div>
                <div style="font-weight:bold; color:#1976d2; font-size:18px; margin-bottom:12px;">詢圈發行</div>
                <div style="color:#666; font-size:15px;">無競拍截標日行情資料</div>
                ${isListed ? `<div style="margin-top:12px; font-size:14px; color:#999;">如需最新報價，請確認09工作表已更新</div>` : ''}
            </div>
        </div>
        </div>
    `;
}

/**
 * 渲染餘額變化（整合09/10工作表和08工作表）
 */
function renderBasicInfoBalance(cbCode, container) {
    const searchCode = String(cbCode).trim();
    const isListed = window.cbDatabase?.listedCodes?.has(searchCode);

    // 從10工作表取得餘額變化（掛牌中CB）
    let balanceData = null;
    if (window.sheet10Data && window.sheet10Data.length > 0) {
        balanceData = window.sheet10Data.find(r => String(r['證券代號']).trim() === searchCode);
    }

    // 從09工作表取得餘額資訊
    let quoteData = null;
    if (window.sheet09Data && window.sheet09Data.length > 0) {
        quoteData = window.sheet09Data.find(r => String(r['代碼']).trim() === searchCode);
    }

    // 從08工作表取得發行資訊
    let sheet08Row = null;
    if (window.sheet08Data && window.sheet08Data.length > 0) {
        sheet08Row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
    }

    // 從競拍資料補充
    let auctionData = null;
    if (window.auctionDataCache && window.auctionDataCache.length > 0) {
        auctionData = window.auctionDataCache.find(r => String(r['CB代號']).trim() === searchCode);
    }

    if (!balanceData && !quoteData && !sheet08Row && !auctionData) {
        container.innerHTML = `<div style="color:#999; padding:20px; text-align:center;">⚠️ 找不到 ${cbCode} 的餘額資料</div>`;
        return;
    }

    const getValue = (...sources) => {
        for (const v of sources) {
            if (v !== undefined && v !== null && v !== '' && v !== '-') return v;
        }
        return null;
    };

    // 發行規模（百萬）和總張數（百萬×10=張數，因為1張=10萬元）
    const issueSize = getValue(sheet08Row?.['實際發行總額(百萬)'], auctionData?.['發行規模']);
    const totalShares = issueSize ? Math.round(parseFloat(issueSize) * 10) : null;

    // v3.97-zs-ag: 最新餘額張數 - 優先從10工作表C欄(本週股額)取得
    // 1張 = 10萬元，所以張數×10萬 = 金額
    const outstandingShares = getValue(
        balanceData?.['本週股額'],  // 10工作表 C欄 - 餘額張數
        quoteData?.['流通在外餘額(張)']
    );

    // 剩餘比率
    const remainRatio = getValue(quoteData?.['剩餘未轉換比率%']);
    const remainRatioDisplay = remainRatio ? parseFloat(remainRatio).toFixed(2) + '%' : '-';
    const remainColor = remainRatio ? (parseFloat(remainRatio) > 50 ? '#2e7d32' : parseFloat(remainRatio) > 20 ? '#ff9800' : '#d32f2f') : '#666';

    // v3.97-zs-ag: 計算已轉換比例和張數
    let convertedRatio = null;
    let convertedShares = null;
    if (outstandingShares && totalShares) {
        // 從張數計算
        convertedShares = Math.round(parseFloat(totalShares) - parseFloat(outstandingShares));
        convertedRatio = ((convertedShares / parseFloat(totalShares)) * 100).toFixed(2);
    } else if (remainRatio !== null && totalShares) {
        // 從剩餘比率計算
        convertedRatio = (100 - parseFloat(remainRatio)).toFixed(2);
        convertedShares = Math.round(parseFloat(totalShares) * (100 - parseFloat(remainRatio)) / 100);
    }

    // 本週變化（從10工作表）
    const weekChange = balanceData ? parseFloat(balanceData['增減數額']) || 0 : null;
    const weekChangeRatio = balanceData ? parseFloat(balanceData['增減比率']) || 0 : null;
    const weekChangeColor = weekChange > 0 ? '#d32f2f' : weekChange < 0 ? '#2e7d32' : '#666';
    const weekChangeSign = weekChange > 0 ? '+' : '';

    // v3.97-zs-af: 計算資料完整度
    const balanceFields = ['發行總張數', '最新餘額張數', '剩餘比率', '已轉換比例'];
    const mergedBalance = {
        '發行總張數': totalShares,
        '最新餘額張數': outstandingShares,
        '剩餘比率': remainRatio,
        '已轉換比例': convertedRatio
    };
    const completeness = calculateDataCompleteness(mergedBalance, balanceFields);
    const statusLabel = isListed ? '🟢 掛牌中' : '⚫ 已下市';

    // v3.97-zs-ag: 取得名稱
    const cbName = getValue(quoteData?.['名稱  '], quoteData?.['名稱'], balanceData?.['名稱'], sheet08Row?.['名稱'], auctionData?.['名稱']);

    const html = `
        <div style="background:linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); padding:25px; border-radius:12px;">
            ${renderTabHeader('餘額變化', '📈', '#00838f', completeness.percentage, statusLabel, cbCode, cbName)}

            <!-- v3.97-zs-ag 優化：發行餘額狀況區塊 -->
            <div style="background:white; padding:20px; border-radius:12px; margin-bottom:18px; border-left:5px solid #1976d2;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
                    <div style="font-weight:bold; color:#1565c0; font-size:17px;">💰 發行餘額狀況</div>
                    ${window.sheet10Date ? `<div style="font-size:12px; color:#888;">📅 資料日期: ${window.sheet10Date}</div>` : ''}
                </div>

                <!-- 三個主要數據方塊 -->
                <div class="balance-grid-3col" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px; margin-bottom:15px;">
                    <div style="background:#e3f2fd; padding:15px; border-radius:10px; text-align:center; border:1px solid #90caf9;">
                        <div style="color:#666; font-size:13px; margin-bottom:8px;">原始發行額</div>
                        <div class="balance-number" style="font-size:22px; font-weight:bold; color:#1976d2;">${totalShares ? formatNumber(totalShares) : '-'}<span style="font-size:14px;">張</span></div>
                    </div>
                    <div style="background:#e3f2fd; padding:15px; border-radius:10px; text-align:center; border:1px solid #90caf9;">
                        <div style="color:#666; font-size:13px; margin-bottom:8px;">最新流通餘額</div>
                        <div class="balance-number" style="font-size:22px; font-weight:bold; color:#e65100;">${outstandingShares ? formatNumber(outstandingShares) : '-'}<span style="font-size:14px;">張</span></div>
                    </div>
                    <div style="background:#e8f5e9; padding:15px; border-radius:10px; text-align:center; border:1px solid #a5d6a7;">
                        <div style="color:#666; font-size:13px; margin-bottom:8px;">已轉換比例/張數</div>
                        <div class="balance-number" style="font-size:22px; font-weight:bold; color:#2e7d32;">${convertedRatio !== null ? convertedRatio + '%' : '-'}</div>
                        <div style="font-size:14px; color:#2e7d32; margin-top:4px;">${convertedShares !== null ? formatNumber(convertedShares) + '張' : '-'}</div>
                    </div>
                </div>

                <!-- 進度條 -->
                ${convertedRatio !== null ? `
                <div style="margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; font-size:13px; color:#666; margin-bottom:6px;">
                        <span>已轉換 <strong style="color:#2e7d32;">${convertedShares !== null ? formatNumber(convertedShares) : '-'}張 (${convertedRatio}%)</strong></span>
                        <span>未轉換 <strong style="color:#e65100;">${outstandingShares ? formatNumber(outstandingShares) : '-'}張 (${remainRatioDisplay})</strong></span>
                    </div>
                    <div style="background:#c8e6c9; height:20px; border-radius:10px; overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="background:linear-gradient(90deg, #4caf50, #8bc34a); height:100%; width:${convertedRatio}%; transition:width 0.3s; display:flex; align-items:center; justify-content:center;">
                            ${parseFloat(convertedRatio) > 15 ? `<span style="color:white; font-size:12px; font-weight:bold;">${convertedRatio}%</span>` : ''}
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- 提示訊息 -->
                ${convertedRatio !== null && parseFloat(convertedRatio) >= 90 ? `
                <div style="padding:12px 15px; background:#fff3e0; border-radius:8px; border-left:4px solid #ff9800;">
                    <span style="font-size:14px;">📊 <strong style="color:#e65100;">提示：</strong>此CB已有 <strong style="color:#c62828;">${convertedRatio}%</strong> 被轉換或贖回，流通在外籌碼較少，可能影響流動性。</span>
                </div>
                ` : convertedRatio !== null && parseFloat(convertedRatio) <= 10 ? `
                <div style="padding:12px 15px; background:#e8f5e9; border-radius:8px; border-left:4px solid #4caf50;">
                    <span style="font-size:14px;">📊 <strong style="color:#2e7d32;">提示：</strong>此CB仍有 <strong style="color:#2e7d32;">${remainRatioDisplay}</strong> 流通在外，籌碼充足，流動性較佳。</span>
                </div>
                ` : ''}
            </div>

            ${isListed && balanceData ? `
            <!-- 本週變化（掛牌中CB）-->
            <div style="background:white; padding:18px; border-radius:10px; margin-bottom:18px; border-left:5px solid ${weekChangeColor};">
                <div style="font-size:15px; color:#555; margin-bottom:12px; font-weight:bold;">📊 本週餘額變化</div>
                <div class="balance-grid-3col" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px; text-align:center;">
                    <div style="padding:12px; background:#e0f7fa; border-radius:8px; border:1px solid #b2ebf2;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">本週股額</div>
                        <div class="balance-number" style="font-size:18px; font-weight:bold;">${formatNumber(balanceData['本週股額'])}</div>
                    </div>
                    <div style="padding:12px; background:#e0f7fa; border-radius:8px; border:1px solid #b2ebf2;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">上週股額</div>
                        <div style="font-size:18px; font-weight:bold;">${formatNumber(balanceData['上週股額'])}</div>
                    </div>
                    <div style="padding:12px; background:#e0f7fa; border-radius:8px; border:1px solid #b2ebf2;">
                        <div style="font-size:13px; color:#666; margin-bottom:6px;">增減數額</div>
                        <div style="font-size:18px; font-weight:bold; color:${weekChangeColor};">
                            ${weekChangeSign}${formatNumber(weekChange)}
                            ${weekChangeRatio ? `<span style="font-size:13px;">(${weekChangeSign}${weekChangeRatio.toFixed(2)}%)</span>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}

            <!-- v3.97-zs-at: 週餘額/月餘額切換標籤 -->
            <div style="margin-bottom:15px;">
                <div style="display:flex; gap:5px; margin-bottom:12px; align-items:center; flex-wrap:wrap;">
                    <button type="button" class="balance-sub-tab active" data-tab="weekChart" onclick="switchBalanceSubTab('${searchCode}', 'weekChart', this)"
                            style="padding:8px 14px; border:none; background:#00838f; color:white; border-radius:6px 6px 0 0; cursor:pointer; font-size:13px; font-weight:bold;">
                        📈 週走勢
                    </button>
                    <button type="button" class="balance-sub-tab" data-tab="weekTable" onclick="switchBalanceSubTab('${searchCode}', 'weekTable', this)"
                            style="padding:8px 14px; border:none; background:#b2ebf2; color:#00838f; border-radius:6px 6px 0 0; cursor:pointer; font-size:13px;">
                        📋 週記錄
                    </button>
                    <button type="button" class="balance-sub-tab" data-tab="monthChart" onclick="switchBalanceSubTab('${searchCode}', 'monthChart', this)"
                            style="padding:8px 14px; border:none; background:#b2ebf2; color:#00838f; border-radius:6px 6px 0 0; cursor:pointer; font-size:13px;">
                        📊 月走勢
                    </button>
                    <button type="button" class="balance-sub-tab" data-tab="monthTable" onclick="switchBalanceSubTab('${searchCode}', 'monthTable', this)"
                            style="padding:8px 14px; border:none; background:#b2ebf2; color:#00838f; border-radius:6px 6px 0 0; cursor:pointer; font-size:13px;">
                        📑 月記錄
                    </button>
                    <div style="margin-left:auto;">
                        <select id="balancePeriod_${searchCode}" onchange="updateBalancePeriod('${searchCode}')"
                                style="padding:6px 10px; border:1px solid #00838f; border-radius:6px; font-size:13px; color:#00838f;">
                            <option value="30">1個月</option>
                            <option value="90">3個月</option>
                            <option value="180" selected>6個月</option>
                            <option value="365">1年</option>
                            <option value="730">2年</option>
                            <option value="1095">3年</option>
                            <option value="all">全部</option>
                        </select>
                    </div>
                </div>
                <div style="font-size:11px; color:#888; margin-bottom:8px; padding-left:5px;">
                    💡 週餘額來自元大資料(每週更新)，月餘額來自CB_kanban(每月更新)
                </div>
                <div id="balanceSubContent_${searchCode}" style="background:white; padding:18px; border-radius:0 10px 10px 10px; min-height:200px;">
                    <div style="text-align:center; color:#888; padding:40px;">
                        📊 載入週餘額走勢資料中...
                    </div>
                </div>
            </div>

            ${!isListed ? `
            <div style="margin-top:18px; padding:12px 15px; background:rgba(255,255,255,0.9); border-radius:8px; font-size:14px; color:#666;">
                ⚫ 本檔已下市，餘額資料僅供參考
            </div>
            ` : ''}
        </div>
    `;

    container.innerHTML = html;

    // v3.97-zs-at: 自動載入週餘額走勢圖
    setTimeout(() => {
        renderWeeklyChart(searchCode);
    }, 100);
}

/**
 * v3.97-zs-al 新增：更新餘額時間區間
 */
function updateBalancePeriod(cbCode) {
    // 找到當前活動的標籤
    const container = document.getElementById(`balanceSubContent_${cbCode}`);
    if (!container) return;

    // 從按鈕找當前標籤
    const tabButtons = container.parentElement?.querySelectorAll('.balance-sub-tab');
    let currentTab = 'weekChart';

    tabButtons?.forEach(btn => {
        if (btn.classList.contains('active')) {
            currentTab = btn.dataset.tab;
        }
    });

    // v3.97-zs-at: 根據當前標籤重新渲染
    switch(currentTab) {
        case 'weekChart':
            renderWeeklyChart(cbCode);
            break;
        case 'weekTable':
            renderWeeklyTable(cbCode);
            break;
        case 'monthChart':
            renderConversionChart(cbCode);
            break;
        case 'monthTable':
            renderConversionTable(cbCode);
            break;
        default:
            renderWeeklyChart(cbCode);
    }
}

/**
 * v3.97-zs-at 修改：切換餘額子標籤（週/月走勢圖/記錄表）
 */
function switchBalanceSubTab(cbCode, tabType, btnElement) {
    // 更新按鈕樣式
    const buttons = btnElement.parentElement.querySelectorAll('.balance-sub-tab');
    buttons.forEach(btn => {
        if (btn === btnElement) {
            btn.style.background = '#00838f';
            btn.style.color = 'white';
            btn.style.fontWeight = 'bold';
            btn.classList.add('active');
        } else {
            btn.style.background = '#b2ebf2';
            btn.style.color = '#00838f';
            btn.style.fontWeight = 'normal';
            btn.classList.remove('active');
        }
    });

    // 渲染對應內容
    switch(tabType) {
        case 'weekChart':
            renderWeeklyChart(cbCode);
            break;
        case 'weekTable':
            renderWeeklyTable(cbCode);
            break;
        case 'monthChart':
            renderConversionChart(cbCode);
            break;
        case 'monthTable':
            renderConversionTable(cbCode);
            break;
    }
}

/**
 * v3.97-zs-at 新增：渲染週餘額走勢圖
 */
async function renderWeeklyChart(cbCode) {
    const container = document.getElementById(`balanceSubContent_${cbCode}`);
    if (!container) return;

    const searchCode = String(cbCode).trim();

    // 確保週餘額資料已載入
    if (!window.weeklyBalanceData.loaded && !window.weeklyBalanceData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>載入週餘額資料中...</div>
        </div>`;

        loadWeeklyBalanceData().then(() => {
            if (window.currentBasicInfoTab === 'balance') {
                renderWeeklyChart(cbCode);
            }
        });
        return;
    }

    if (window.weeklyBalanceData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>週餘額資料載入中...</div>
        </div>`;

        // v3.97-zs-bs: 使用 requestAnimationFrame 取代 setInterval
        waitForDataLoaded(() => !window.weeklyBalanceData.loading).then(() => {
            if (window.currentBasicInfoTab === 'balance') {
                renderWeeklyChart(cbCode);
            }
        });
        return;
    }

    // 取得時間區間
    const periodSelect = document.getElementById(`balancePeriod_${searchCode}`);
    const period = periodSelect?.value || '180';

    // 取得週餘額資料
    let allData = window.weeklyBalanceData.data[searchCode] || [];

    if (allData.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:#888; padding:40px;">
                <div style="font-size:32px; margin-bottom:10px;">📊</div>
                <div>尚無週餘額資料</div>
                <div style="font-size:12px; margin-top:8px;">元大資料中未找到 ${searchCode} 的歷史週餘額</div>
            </div>
        `;
        return;
    }

    // v3.97-as-bv: 過濾時間區間（從資料最新日期往前推算）
    let filteredData = allData;
    if (period !== 'all') {
        const days = parseInt(period);

        // 找出資料中的最新日期
        const latestData = allData[allData.length - 1];
        let latestDate = null;

        if (latestData?.date) {
            latestDate = new Date(latestData.date.replace(/\//g, '-'));
        }

        if (latestDate && !isNaN(latestDate.getTime())) {
            // 從最新日期往前推算
            const cutoffDate = new Date(latestDate);
            cutoffDate.setDate(cutoffDate.getDate() - days);
            filteredData = allData.filter(d => {
                const dDate = new Date(d.date.replace(/\//g, '-'));
                return dDate >= cutoffDate;
            });
        } else {
            // 退回使用今天
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            filteredData = allData.filter(d => {
                const dDate = new Date(d.date.replace(/\//g, '-'));
                return dDate >= cutoffDate;
            });
        }
    }

    if (filteredData.length === 0) filteredData = allData;

    // 時間區間文字
    const periodTexts = { '30': '1個月', '90': '3個月', '180': '6個月', '365': '1年', '730': '2年', '1095': '3年', 'all': '全部' };
    const periodText = periodTexts[period] || period;

    // 計算Y軸範圍（數據±10%）
    const balances = filteredData.map(d => d.balanceShares).filter(v => v > 0);
    if (balances.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#888; padding:40px;">選定區間內無餘額資料</div>`;
        return;
    }

    const minBalance = Math.min(...balances);
    const maxBalance = Math.max(...balances);
    let yMin, yMax;
    if (maxBalance === minBalance) {
        yMin = minBalance * 0.95;
        yMax = maxBalance * 1.05;
    } else {
        const dataRange = maxBalance - minBalance;
        yMin = Math.max(0, minBalance - dataRange * 0.1);
        yMax = maxBalance + dataRange * 0.1;
    }
    const range = yMax - yMin || 1;

    // v3.97-as-by: 加大 SVG 尺寸讓圖表更清晰
    const width = 600;
    const height = 300;
    const padding = 60;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2;

    // 生成路徑
    let pathD = '';
    let validPoints = 0;
    filteredData.forEach((d, i) => {
        const balance = d.balanceShares || 0;
        if (balance <= 0) return;

        const x = padding + (validPoints / Math.max(filteredData.length - 1, 1)) * chartWidth;
        const y = padding + chartHeight - ((balance - yMin) / range) * chartHeight;
        if (validPoints === 0) {
            pathD += `M ${x} ${y}`;
        } else {
            pathD += ` L ${x} ${y}`;
        }
        validPoints++;
    });

    // 計算變化趨勢
    const firstBalance = filteredData[0]?.balanceShares || 0;
    const lastBalance = filteredData[filteredData.length - 1]?.balanceShares || 0;
    const changeAmount = lastBalance - firstBalance;
    const changeRatio = firstBalance > 0 ? ((changeAmount / firstBalance) * 100).toFixed(2) : 0;
    const trendColor = changeAmount <= 0 ? '#2e7d32' : '#d32f2f';
    const trendIcon = changeAmount <= 0 ? '📉 減少' : '📈 增加';
    const trendText = changeAmount <= 0 ? '(籌碼收斂中)' : '(籌碼增加中)';

    container.innerHTML = `
        <div style="text-align:center; margin-bottom:15px;">
            <span style="font-size:16px; font-weight:600; color:#1976d2;">📈 ${periodText}週餘額走勢（資料來源：元大週報）</span>
        </div>
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:15px; padding:12px; background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius:10px;">
            <div style="text-align:center; background:white; padding:10px; border-radius:8px;">
                <div style="font-size:12px; color:#888; margin-bottom:5px;">期初餘額</div>
                <div style="font-size:18px; font-weight:bold; color:#1976d2;">${formatNumber(firstBalance)}</div>
                <div style="font-size:11px; color:#888;">張</div>
            </div>
            <div style="text-align:center; background:white; padding:10px; border-radius:8px;">
                <div style="font-size:12px; color:#888; margin-bottom:5px;">期末餘額</div>
                <div style="font-size:18px; font-weight:bold; color:#e65100;">${formatNumber(lastBalance)}</div>
                <div style="font-size:11px; color:#888;">張</div>
            </div>
            <div style="text-align:center; background:white; padding:10px; border-radius:8px;">
                <div style="font-size:12px; color:#888; margin-bottom:5px;">變化</div>
                <div style="font-size:16px; font-weight:bold; color:${trendColor};">
                    ${trendIcon}<br>${formatNumber(Math.abs(changeAmount))} 張<br>(${changeRatio}%)
                </div>
                <div style="font-size:11px; color:${trendColor}; margin-top:3px;">${trendText}</div>
            </div>
        </div>
        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #e0e0e0;">
            <svg width="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="display:block; margin:0 auto;">
                <!-- 背景 -->
                <rect x="${padding}" y="${padding}" width="${chartWidth}" height="${chartHeight}" fill="#f8f9fa" stroke="#dee2e6" rx="4"/>
                <!-- Y軸網格與標籤 -->
                ${[0, 0.25, 0.5, 0.75, 1].map(ratio => {
                    const y = padding + chartHeight * (1 - ratio);
                    const val = formatNumber(Math.round(yMin + range * ratio));
                    return `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#e9ecef" stroke-dasharray="4,4"/>
                            <text x="${padding - 8}" y="${y + 4}" text-anchor="end" font-size="12" fill="#6c757d">${val}</text>`;
                }).join('')}
                <!-- 走勢線 -->
                <path d="${pathD}" fill="none" stroke="#1976d2" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                <!-- 起點標記 -->
                ${firstBalance > 0 ? `<circle cx="${padding}" cy="${padding + chartHeight - ((firstBalance - yMin) / range) * chartHeight}" r="6" fill="#1976d2" stroke="white" stroke-width="2"/>` : ''}
                <!-- 終點標記 -->
                ${lastBalance > 0 ? `<circle cx="${width - padding}" cy="${padding + chartHeight - ((lastBalance - yMin) / range) * chartHeight}" r="6" fill="${trendColor}" stroke="white" stroke-width="2"/>` : ''}
                <!-- Y軸標題 -->
                <text x="18" y="${height / 2}" text-anchor="middle" font-size="13" fill="#495057" font-weight="500" transform="rotate(-90, 18, ${height / 2})">餘額(張)</text>
            </svg>
            <div style="display:flex; justify-content:space-between; font-size:13px; color:#6c757d; margin-top:12px; padding:0 ${padding}px;">
                <span>${filteredData[0]?.date || ''}</span>
                <span style="color:#1976d2; font-weight:500;">共 ${filteredData.length} 週資料</span>
                <span>${filteredData[filteredData.length - 1]?.date || ''}</span>
            </div>
        </div>
    `;
}

/**
 * v3.97-zs-at 新增：渲染週餘額記錄表
 */
async function renderWeeklyTable(cbCode) {
    const container = document.getElementById(`balanceSubContent_${cbCode}`);
    if (!container) return;

    const searchCode = String(cbCode).trim();

    // 確保週餘額資料載入
    if (!window.weeklyBalanceData.loaded && !window.weeklyBalanceData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">⏳ 載入週餘額資料中...</div>`;
        loadWeeklyBalanceData().then(() => {
            if (window.currentBasicInfoTab === 'balance') renderWeeklyTable(cbCode);
        });
        return;
    }

    if (window.weeklyBalanceData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">⏳ 週餘額資料載入中...</div>`;
        // v3.97-zs-bs: 使用 waitForDataLoaded
        waitForDataLoaded(() => !window.weeklyBalanceData.loading).then(() => {
            if (window.currentBasicInfoTab === 'balance') renderWeeklyTable(cbCode);
        });
        return;
    }

    // v3.97-zs-az: 同時載入融資融券資料
    if (!window.marginData.loaded && !window.marginData.loading) {
        loadMarginData(); // 背景載入，不阻塞
    }

    // 取得時間區間
    const periodSelect = document.getElementById(`balancePeriod_${searchCode}`);
    const period = periodSelect?.value || '180';

    let allData = window.weeklyBalanceData.data[searchCode] || [];

    if (allData.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:#888; padding:40px;">
                <div style="font-size:32px; margin-bottom:10px;">📋</div>
                <div>尚無週餘額記錄</div>
            </div>
        `;
        return;
    }

    // 過濾時間
    let filteredData = allData;
    if (period !== 'all') {
        const days = parseInt(period);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        filteredData = allData.filter(d => new Date(d.date.replace(/\//g, '-')) >= cutoff);
    }
    if (filteredData.length === 0) filteredData = allData;

    // 倒序（最新在前）
    const displayData = [...filteredData].reverse();

    // 取得發行總額
    let totalIssue = 0;
    const sheet08Row = window.sheet08Data?.find(r => String(r['代號']).trim() === searchCode);
    if (sheet08Row) {
        totalIssue = (parseFloat(sheet08Row['實際發行總額(百萬)']) || 0) * 10; // 百萬×10=張
    }

    // v3.97-zs-bb: 取得股票代號以查詢融資融券
    const stockCode = getStockCodeFromCB(searchCode);
    const hasMarginData = window.marginData.loaded && stockCode && window.marginData.data[stockCode];

    // v3.97-zs-bc: Debug log
    console.log('[週記錄融資融券]', {
        cbCode: searchCode,
        stockCode: stockCode,
        marginLoaded: window.marginData.loaded,
        hasStockInMargin: stockCode ? !!window.marginData.data[stockCode] : false,
        marginStockCount: Object.keys(window.marginData.data || {}).length
    });

    // 如果有股票代號但找不到融資融券資料，列出前10個可用的股票代號供參考
    if (stockCode && !window.marginData.data[stockCode] && window.marginData.loaded) {
        const availableCodes = Object.keys(window.marginData.data).slice(0, 20);
        console.log('[融資融券] 可用股票代號範例:', availableCodes);
    }

    const periodTexts = { '30': '1個月', '90': '3個月', '180': '6個月', '365': '1年', '730': '2年', '1095': '3年', 'all': '全部' };

    // v3.97-zs-br: 優化表格樣式 - 字體大方、欄寬緊湊
    let tableHtml = `
        <div style="text-align:center; margin-bottom:10px; font-size:14px; color:#555; font-weight:500;">
            📋 ${periodTexts[period] || period}週餘額變化記錄
            ${stockCode ? `<span style="font-size:12px; color:#888; font-weight:normal;">（股票代號：${stockCode}）</span>` : ''}
        </div>
        <div style="max-height:400px; overflow-y:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px; table-layout:auto;">
                <thead style="position:sticky; top:0; background:#1976d2; color:white;">
                    <tr>
                        <th style="padding:6px 6px; text-align:center; white-space:nowrap; font-weight:600;">日期</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; border-right:2px solid rgba(255,255,255,0.3);">CB餘額</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600;">CB增減</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; border-right:2px solid rgba(255,255,255,0.3);">剩餘%</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#c62828;">融資餘額</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#c62828; border-right:2px solid rgba(255,255,255,0.3);">融資增減</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#2e7d32;">融券餘額</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#2e7d32;">融券增減</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#2e7d32;">券償</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displayData.forEach((d, i) => {
        const bgColor = i % 2 === 0 ? '#f5f5f5' : 'white';
        const thisWeek = d.balanceShares;
        const prevData = displayData[i + 1];
        const lastWeek = prevData?.balanceShares || thisWeek;
        const change = thisWeek - lastWeek;
        const remainRate = totalIssue > 0 ? (thisWeek / totalIssue) * 100 : 100;
        const changeColor = change < 0 ? '#2e7d32' : change > 0 ? '#d32f2f' : '#666';

        // v3.97-zs-az: 取得融資融券資料
        let marginBalance = '-', marginChange = '-', shortBalance = '-', shortChange = '-', shortCover = '-';
        let marginChangeColor = '#666', shortChangeColor = '#666';

        if (hasMarginData) {
            const marginInfo = getMarginDataForDate(stockCode, d.date);
            if (marginInfo) {
                marginBalance = formatNumber(marginInfo.marginBalance);
                marginChange = marginInfo.marginChange;
                shortBalance = formatNumber(marginInfo.shortBalance);
                shortChange = marginInfo.shortChange;
                shortCover = formatNumber(marginInfo.shortCover);

                marginChangeColor = marginInfo.marginChange > 0 ? '#c62828' : marginInfo.marginChange < 0 ? '#2e7d32' : '#666';
                shortChangeColor = marginInfo.shortChange > 0 ? '#c62828' : marginInfo.shortChange < 0 ? '#2e7d32' : '#666';

                marginChange = marginInfo.marginChange !== 0 ? (marginInfo.marginChange > 0 ? '+' : '') + formatNumber(marginInfo.marginChange) : '0';
                shortChange = marginInfo.shortChange !== 0 ? (marginInfo.shortChange > 0 ? '+' : '') + formatNumber(marginInfo.shortChange) : '0';
            }
        }

        tableHtml += `
            <tr style="background:${bgColor};">
                <td style="padding:5px 6px; text-align:center; color:#555; white-space:nowrap;">${d.date}</td>
                <td style="padding:5px 6px; text-align:right; font-weight:600; color:#1976d2; border-right:1px solid #e0e0e0;">${formatNumber(thisWeek)}</td>
                <td style="padding:5px 6px; text-align:right; color:${changeColor}; font-weight:600;">
                    ${change !== 0 ? (change > 0 ? '+' : '') + formatNumber(change) : '0'}
                </td>
                <td style="padding:5px 6px; text-align:right; color:#1565c0; border-right:1px solid #e0e0e0;">${remainRate.toFixed(1)}%</td>
                <td style="padding:5px 6px; text-align:right; color:#c62828; font-weight:500;">${marginBalance}</td>
                <td style="padding:5px 6px; text-align:right; color:${marginChangeColor}; border-right:1px solid #e0e0e0;">${marginChange}</td>
                <td style="padding:5px 6px; text-align:right; color:#2e7d32; font-weight:500;">${shortBalance}</td>
                <td style="padding:5px 6px; text-align:right; color:${shortChangeColor};">${shortChange}</td>
                <td style="padding:5px 6px; text-align:right; color:#7b1fa2;">${shortCover}</td>
            </tr>
        `;
    });

    tableHtml += `
                </tbody>
            </table>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#777; margin-top:8px; flex-wrap:wrap; gap:6px;">
            <span>共 ${displayData.length} 週</span>
            <span style="color:#999;">CB/融資融券單位：張</span>
            ${!hasMarginData ? '<span style="color:#f57c00;">⚠️ 融資融券載入中</span>' : ''}
        </div>
    `;

    container.innerHTML = tableHtml;
}

/**
 * v3.97-zs-al 修改：渲染轉換走勢圖（加入時間區間選擇）
 */
async function renderConversionChart(cbCode) {

    const container = document.getElementById(`balanceSubContent_${cbCode}`);
    if (!container) {
        return;
    }

    const searchCode = String(cbCode).trim();

    // v3.97-zs-aq: 記錄開始時的標籤狀態
    const startTab = window.currentBasicInfoTab;

    // v3.97-zs-am: 確保 kanbanData 已載入（非阻塞方式）
    if (!window.kanbanData.loaded && !window.kanbanData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>首次載入 CB_kanban 歷史資料中...</div>
            <div style="font-size:12px; margin-top:8px; color:#888;">請稍候，可切換其他標籤</div>
        </div>`;

        // 非阻塞載入：不等待，讓載入在背景進行
        loadAllKanbanData().then(() => {
            // 載入完成後，如果還在餘額變化標籤才重新渲染
            if (window.currentBasicInfoTab === 'balance') {
                renderConversionChart(cbCode);
            }
        });
        return; // 先返回，讓用戶可以切換標籤
    }

    // 如果正在載入中，顯示等待訊息但不阻塞
    if (window.kanbanData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>CB_kanban 資料載入中...</div>
            <div style="font-size:12px; margin-top:8px; color:#888;">請稍候，可切換其他標籤</div>
        </div>`;

        // v3.97-zs-bs: 使用 waitForDataLoaded
        waitForDataLoaded(() => !window.kanbanData.loading).then(() => {
            if (window.currentBasicInfoTab === 'balance') {
                renderConversionChart(cbCode);
            }
        });
        return;
    }


    // v3.97-zs-aq: 再次檢查標籤狀態，如果已切換則不繼續
    if (window.currentBasicInfoTab !== 'balance') {
        return;
    }

    // 取得時間區間設定
    const periodSelect = document.getElementById(`balancePeriod_${searchCode}`);
    const period = periodSelect?.value || '180';

    // 從 kanbanData 取得時間序列資料（O欄：上月底發行餘額）
    let allData = window.kanbanData.data[searchCode] || [];

    // 如果找不到，嘗試純數字格式
    if (allData.length === 0) {
        const numCode = parseInt(searchCode, 10);
        if (!isNaN(numCode)) {
            allData = window.kanbanData.data[String(numCode)] || [];
        }
    }

    // 除錯：列出 kanbanData 中的部分 key
    if (allData.length === 0) {
        const allKeys = Object.keys(window.kanbanData.data);
        // 檢查是否有包含 searchCode 的 key
        const matchingKeys = allKeys.filter(k => k.includes(searchCode.slice(-4)));
    }

    if (allData.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:#888; padding:40px;">
                <div style="font-size:32px; margin-bottom:10px;">📊</div>
                <div>尚無轉換走勢資料</div>
                <div style="font-size:12px; margin-top:8px;">CB_kanban 中未找到 ${searchCode} 的歷史資料</div>
            </div>
        `;
        return;
    }


    // v3.97-as-bv: 根據時間區間過濾資料（從資料最新日期往前推算）
    let filteredData = allData;
    if (period !== 'all') {
        const days = parseInt(period);

        // 找出資料中的最新日期
        const latestData = allData[allData.length - 1];
        let latestDate = null;

        if (latestData?.date) {
            latestDate = new Date(latestData.date.replace(/\//g, '-'));
        }

        if (latestDate && !isNaN(latestDate.getTime())) {
            // 從最新日期往前推算
            const cutoffDate = new Date(latestDate);
            cutoffDate.setDate(cutoffDate.getDate() - days);
            filteredData = allData.filter(d => {
                if (!d.date) return false;
                const dDate = new Date(d.date.replace(/\//g, '-'));
                return dDate >= cutoffDate;
            });
        } else {
            // 退回使用今天
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            filteredData = allData.filter(d => {
                if (!d.date) return false;
                const dDate = new Date(d.date.replace(/\//g, '-'));
                return dDate >= cutoffDate;
            });
        }
    }

    // 如果過濾後沒資料，使用全部
    if (filteredData.length === 0) {
        filteredData = allData;
    }

    // v3.97-zs-aw: 只保留每個月最後一筆資料
    const monthlyData = {};
    filteredData.forEach(d => {
        if (!d.date) return;
        const yearMonth = d.date.substring(0, 7);
        if (!monthlyData[yearMonth] || d.date > monthlyData[yearMonth].date) {
            monthlyData[yearMonth] = d;
        }
    });
    filteredData = Object.values(monthlyData).sort((a, b) => a.date.localeCompare(b.date));

    // v3.97-de: balance 單位是元，轉換為張數（每張面額10萬元）
    const SHEET_UNIT = 100000; // 1張 = 10萬元
    const balances = filteredData.map(d => (d.balance || 0) / SHEET_UNIT).filter(v => v > 0);
    if (balances.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:#888; padding:40px;">
                <div style="font-size:32px; margin-bottom:10px;">📊</div>
                <div>選定區間內無餘額資料</div>
            </div>
        `;
        return;
    }

    const maxBalance = Math.max(...balances);
    const minBalance = Math.min(...balances);

    // v3.97-zs-at: Y軸範圍改為數據±5%，確保沒變化時也有合理顯示
    let yMin, yMax;
    if (maxBalance === minBalance) {
        // 數據完全相同，顯示±5%範圍
        yMin = minBalance * 0.95;
        yMax = maxBalance * 1.05;
    } else {
        // 有變化，在數據範圍基礎上擴展10%
        const dataRange = maxBalance - minBalance;
        yMin = Math.max(0, minBalance - dataRange * 0.1);
        yMax = maxBalance + dataRange * 0.1;
    }
    const range = yMax - yMin || 1;

    // 生成SVG走勢圖
    const width = 650;
    const height = 220;
    const padding = 50;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2;

    // 生成路徑（使用張數單位）
    let pathD = '';
    let validPoints = 0;
    filteredData.forEach((d, i) => {
        const balance = (d.balance || 0) / SHEET_UNIT;
        if (balance <= 0) return;

        const x = padding + (validPoints / Math.max(filteredData.length - 1, 1)) * chartWidth;
        const y = padding + chartHeight - ((balance - yMin) / range) * chartHeight;
        if (validPoints === 0) {
            pathD += `M ${x} ${y}`;
        } else {
            pathD += ` L ${x} ${y}`;
        }
        validPoints++;
    });

    // 計算轉換趨勢（v3.97-de: balance 單位是元，需轉換為張數）
    const firstBalanceRaw = filteredData[0]?.balance || 0;
    const lastBalanceRaw = filteredData[filteredData.length - 1]?.balance || 0;
    const firstBalance = Math.round(firstBalanceRaw / SHEET_UNIT);
    const lastBalance = Math.round(lastBalanceRaw / SHEET_UNIT);
    const changeAmount = lastBalance - firstBalance;
    const changeRatio = firstBalance > 0 ? ((changeAmount / firstBalance) * 100).toFixed(2) : 0;
    const trendColor = changeAmount <= 0 ? '#2e7d32' : '#d32f2f';
    const trendIcon = changeAmount <= 0 ? '📉 減少' : '📈 增加';
    const trendText = changeAmount <= 0 ? '(籌碼收斂中)' : '(籌碼增加中)';

    // 時間區間文字
    const periodTexts = {
        '30': '1個月', '90': '3個月', '180': '6個月',
        '365': '1年', '730': '2年', '1095': '3年', 'all': '全部'
    };
    const periodText = periodTexts[period] || period;

    container.innerHTML = `
        <div style="text-align:center; margin-bottom:15px;">
            <span style="font-size:14px; color:#666;">📊 ${periodText}餘額走勢（資料來源：CB_kanban O欄「上月底發行餘額」）</span>
        </div>
        <div style="display:flex; justify-content:space-around; margin-bottom:15px; padding:10px; background:#f5f5f5; border-radius:8px;">
            <div style="text-align:center;">
                <div style="font-size:12px; color:#888;">期初餘額</div>
                <div style="font-size:16px; font-weight:bold; color:#1976d2;">${formatNumber(firstBalance)} 張</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:12px; color:#888;">期末餘額</div>
                <div style="font-size:16px; font-weight:bold; color:#e65100;">${formatNumber(lastBalance)} 張</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:12px; color:#888;">變化</div>
                <div style="font-size:16px; font-weight:bold; color:${trendColor};">
                    ${trendIcon} ${formatNumber(Math.abs(changeAmount))} 張 (${changeRatio}%)
                </div>
                <div style="font-size:11px; color:${trendColor};">${trendText}</div>
            </div>
        </div>
        <svg width="100%" viewBox="0 0 ${width} ${height}" style="max-width:650px; display:block; margin:0 auto;">
            <!-- 背景網格 -->
            <rect x="${padding}" y="${padding}" width="${chartWidth}" height="${chartHeight}" fill="#fafafa" stroke="#e0e0e0"/>
            ${[0, 0.25, 0.5, 0.75, 1].map(ratio => {
                const y = padding + chartHeight * (1 - ratio);
                const val = formatNumber(Math.round(yMin + range * ratio));
                return `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#e0e0e0" stroke-dasharray="3,3"/>
                        <text x="${padding - 5}" y="${y + 4}" text-anchor="end" font-size="11" fill="#888">${val}</text>`;
            }).join('')}

            <!-- 走勢線 -->
            <path d="${pathD}" fill="none" stroke="#00838f" stroke-width="2.5"/>

            <!-- 起點終點標記 -->
            ${firstBalance > 0 ? `<circle cx="${padding}" cy="${padding + chartHeight - ((firstBalance - yMin) / range) * chartHeight}" r="5" fill="#1976d2"/>` : ''}
            ${lastBalance > 0 ? `<circle cx="${width - padding}" cy="${padding + chartHeight - ((lastBalance - yMin) / range) * chartHeight}" r="5" fill="${trendColor}"/>` : ''}

            <!-- Y軸標題 -->
            <text x="15" y="${height / 2}" text-anchor="middle" font-size="12" fill="#666" transform="rotate(-90, 15, ${height / 2})">餘額(張)</text>
        </svg>
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#888; margin-top:10px; padding:0 50px;">
            <span>${filteredData[0]?.date || ''}</span>
            <span>共 ${filteredData.length} 期資料</span>
            <span>${filteredData[filteredData.length - 1]?.date || ''}</span>
        </div>
    `;
}

/**
 * v3.97-zs-al 修改：渲染轉換記錄表（加入時間區間選擇）
 */
async function renderConversionTable(cbCode) {

    const container = document.getElementById(`balanceSubContent_${cbCode}`);
    if (!container) {
        return;
    }

    const searchCode = String(cbCode).trim();

    // v3.97-zs-aq: 非阻塞載入方式
    if (!window.kanbanData.loaded && !window.kanbanData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>首次載入 CB_kanban 歷史資料中...</div>
            <div style="font-size:12px; margin-top:8px; color:#888;">請稍候，可切換其他標籤</div>
        </div>`;

        loadAllKanbanData().then(() => {
            if (window.currentBasicInfoTab === 'balance') {
                renderConversionTable(cbCode);
            }
        });
        return;
    }

    if (window.kanbanData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>CB_kanban 資料載入中...</div>
        </div>`;

        // v3.97-zs-bs: 使用 waitForDataLoaded
        waitForDataLoaded(() => !window.kanbanData.loading).then(() => {
            if (window.currentBasicInfoTab === 'balance') {
                renderConversionTable(cbCode);
            }
        });
        return;
    }


    // 再次檢查標籤狀態
    if (window.currentBasicInfoTab !== 'balance') {
        return;
    }

    // 取得時間區間設定
    const periodSelect = document.getElementById(`balancePeriod_${searchCode}`);
    const period = periodSelect?.value || '180';

    // 從 kanbanData 取得時間序列資料
    let allData = window.kanbanData.data[searchCode] || [];

    // 如果找不到，嘗試純數字格式
    if (allData.length === 0) {
        const numCode = parseInt(searchCode, 10);
        if (!isNaN(numCode)) {
            allData = window.kanbanData.data[String(numCode)] || [];
        }
    }

    if (allData.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:#888; padding:40px;">
                <div style="font-size:32px; margin-bottom:10px;">📋</div>
                <div>尚無轉換記錄資料</div>
                <div style="font-size:12px; margin-top:8px;">CB_kanban 中未找到 ${searchCode} 的歷史資料</div>
            </div>
        `;
        return;
    }


    // v3.97-as-bv: 根據時間區間過濾資料（從資料最新日期往前推算）
    let filteredData = allData;
    if (period !== 'all') {
        const days = parseInt(period);

        // 找出資料中的最新日期
        const latestData = allData[allData.length - 1];
        let latestDate = null;

        if (latestData?.date) {
            latestDate = new Date(latestData.date.replace(/\//g, '-'));
        }

        if (latestDate && !isNaN(latestDate.getTime())) {
            // 從最新日期往前推算
            const cutoffDate = new Date(latestDate);
            cutoffDate.setDate(cutoffDate.getDate() - days);
            filteredData = allData.filter(d => {
                if (!d.date) return false;
                const dDate = new Date(d.date.replace(/\//g, '-'));
                return dDate >= cutoffDate;
            });
        } else {
            // 退回使用今天
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            filteredData = allData.filter(d => {
                if (!d.date) return false;
                const dDate = new Date(d.date.replace(/\//g, '-'));
                return dDate >= cutoffDate;
            });
        }
    }

    // 如果過濾後沒資料，使用全部
    if (filteredData.length === 0) {
        filteredData = allData;
    }

    // 取得發行總額（用於計算剩餘比率）
    let totalIssue = 0;
    const sheet08Row = window.sheet08Data?.find(r => String(r['代號']).trim() === searchCode);
    if (sheet08Row) {
        totalIssue = parseFloat(sheet08Row['實際發行總額(百萬)']) || 0;
        totalIssue = totalIssue / 100; // 轉為億元
    }

    // v3.97-zs-aw: 只保留每個月最後一筆資料
    const monthlyData = {};
    filteredData.forEach(d => {
        if (!d.date) return;
        // 取得年月 (YYYY/MM)
        const yearMonth = d.date.substring(0, 7);
        // 只保留該月最新的一筆（日期較大的）
        if (!monthlyData[yearMonth] || d.date > monthlyData[yearMonth].date) {
            monthlyData[yearMonth] = d;
        }
    });

    // 轉為陣列並按日期排序
    const monthlyArray = Object.values(monthlyData).sort((a, b) => a.date.localeCompare(b.date));

    // 倒序顯示（最新在前）
    const displayData = [...monthlyArray].reverse();

    // 時間區間文字
    const periodTexts = {
        '30': '1個月', '90': '3個月', '180': '6個月',
        '365': '1年', '730': '2年', '1095': '3年', 'all': '全部'
    };
    const periodText = periodTexts[period] || period;

    // v3.97-zs-bb: 同時載入融資融券資料
    if (!window.marginData.loaded && !window.marginData.loading) {
        loadMarginData(); // 背景載入，不阻塞
    }

    // v3.97-zs-bb: 取得股票代號以查詢融資融券
    const stockCode = getStockCodeFromCB(searchCode);
    const hasMarginData = window.marginData.loaded && stockCode && window.marginData.data[stockCode];

    // v3.97-zs-br: 月餘額記錄表（優化樣式 - 字體大方、欄寬緊湊）
    let tableHtml = `
        <div style="text-align:center; margin-bottom:10px; font-size:14px; color:#555; font-weight:500;">
            📑 ${periodText}月餘額變化記錄
            ${stockCode ? `<span style="font-size:12px; color:#888; font-weight:normal;">（股票代號：${stockCode}）</span>` : ''}
        </div>
        <div style="max-height:400px; overflow-y:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px; table-layout:auto;">
                <thead style="position:sticky; top:0; background:#00838f; color:white;">
                    <tr>
                        <th style="padding:6px 6px; text-align:center; white-space:nowrap; font-weight:600;">月份</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; border-right:2px solid rgba(255,255,255,0.3);">CB餘額</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600;">CB增減</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; border-right:2px solid rgba(255,255,255,0.3);">剩餘%</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#c62828;">融資餘額</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#c62828; border-right:2px solid rgba(255,255,255,0.3);">融資增減</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#2e7d32;">融券餘額</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#2e7d32;">融券增減</th>
                        <th style="padding:6px 6px; text-align:right; white-space:nowrap; font-weight:600; background:#2e7d32;">券償</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displayData.forEach((d, i) => {
        const bgColor = i % 2 === 0 ? '#f5f5f5' : 'white';

        // v3.97-zs-br: balance 單位是元，1張CB = 10萬元面額
        // 元 / 100000 = 張數
        const thisMonthBalanceYuan = d.balance || 0;
        const thisMonthShares = Math.round(thisMonthBalanceYuan / 100000);
        const thisMonthBalanceYi = thisMonthBalanceYuan / 100000000; // 轉為億元

        // 上月餘額（取下一筆，因為是倒序排列）
        const prevData = displayData[i + 1];
        const lastMonthBalanceYuan = prevData?.balance || thisMonthBalanceYuan;
        const lastMonthShares = Math.round(lastMonthBalanceYuan / 100000);

        // 增減數額和比率
        const changeShares = thisMonthShares - lastMonthShares;

        // 剩餘比率（totalIssue 是億元，thisMonthBalanceYi 也是億元）
        const remainRate = totalIssue > 0 ? ((thisMonthBalanceYi / totalIssue) * 100) : 100;

        // 顏色：減少為綠色（轉換中），增加為紅色
        const changeColor = changeShares < 0 ? '#2e7d32' : changeShares > 0 ? '#d32f2f' : '#666';

        // 顯示年月
        const displayMonth = d.date ? d.date.substring(0, 7) : '-';

        // v3.97-zs-bb: 取得該月底的融資融券資料
        let marginBalance = '-', marginChange = '-', shortBalance = '-', shortChange = '-', shortCover = '-';
        let marginChangeColor = '#666', shortChangeColor = '#666';

        if (hasMarginData && d.date) {
            const marginInfo = getMarginDataForDate(stockCode, d.date);
            if (marginInfo) {
                marginBalance = formatNumber(marginInfo.marginBalance);
                marginChange = marginInfo.marginChange;
                shortBalance = formatNumber(marginInfo.shortBalance);
                shortChange = marginInfo.shortChange;
                shortCover = formatNumber(marginInfo.shortCover);

                marginChangeColor = marginInfo.marginChange > 0 ? '#c62828' : marginInfo.marginChange < 0 ? '#2e7d32' : '#666';
                shortChangeColor = marginInfo.shortChange > 0 ? '#c62828' : marginInfo.shortChange < 0 ? '#2e7d32' : '#666';

                marginChange = marginInfo.marginChange !== 0 ? (marginInfo.marginChange > 0 ? '+' : '') + formatNumber(marginInfo.marginChange) : '0';
                shortChange = marginInfo.shortChange !== 0 ? (marginInfo.shortChange > 0 ? '+' : '') + formatNumber(marginInfo.shortChange) : '0';
            }
        }

        tableHtml += `
            <tr style="background:${bgColor};">
                <td style="padding:5px 6px; text-align:center; color:#555; white-space:nowrap;">${displayMonth}</td>
                <td style="padding:5px 6px; text-align:right; font-weight:600; color:#00838f; border-right:1px solid #e0e0e0;">${formatNumber(thisMonthShares)}</td>
                <td style="padding:5px 6px; text-align:right; color:${changeColor}; font-weight:600;">
                    ${changeShares !== 0 ? (changeShares > 0 ? '+' : '') + formatNumber(changeShares) : '0'}
                </td>
                <td style="padding:5px 6px; text-align:right; color:#1976d2; border-right:1px solid #e0e0e0;">${remainRate.toFixed(1)}%</td>
                <td style="padding:5px 6px; text-align:right; color:#c62828; font-weight:500;">${marginBalance}</td>
                <td style="padding:5px 6px; text-align:right; color:${marginChangeColor}; border-right:1px solid #e0e0e0;">${marginChange}</td>
                <td style="padding:5px 6px; text-align:right; color:#2e7d32; font-weight:500;">${shortBalance}</td>
                <td style="padding:5px 6px; text-align:right; color:${shortChangeColor};">${shortChange}</td>
                <td style="padding:5px 6px; text-align:right; color:#7b1fa2;">${shortCover}</td>
            </tr>
        `;
    });

    tableHtml += `
                </tbody>
            </table>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#777; margin-top:8px; flex-wrap:wrap; gap:6px;">
            <span>共 ${displayData.length} 個月</span>
            <span style="color:#999;">CB/融資融券單位：張</span>
            ${!hasMarginData ? '<span style="color:#f57c00;">⚠️ 融資融券載入中</span>' : ''}
        </div>
    `;

    container.innerHTML = tableHtml;
}

// ==================== v3.97z-s 新增：價格走勢分析模組 ====================

// 儲存原始選項列表
let priceTrendCBOptions = [];
let isAutoSelecting = false; // 避免遞迴

/**
 * 初始化價格走勢CB選項（保存原始列表）
 */
function initPriceTrendCBOptions() {
    const select = document.getElementById('priceTrendCBSelect');
    if (select) {
        priceTrendCBOptions = Array.from(select.options).slice(1); // 排除第一個空選項
    }
}

/**
 * v3.97-zs-br 修正：智能搜尋價格走勢CB
 * 使用 cbDatabase.allCB（包含已下市CB）
 */
function smartSearchPriceTrend(keyword) {
    const resultsDiv = document.getElementById('priceTrendSearchResults');
    if (!resultsDiv) return;

    const kw = keyword.trim().toLowerCase();

    if (!kw || kw.length < 1) {
        resultsDiv.style.display = 'none';
        return;
    }

    // v3.97-zs-br: 使用 cbDatabase（不是 basicInfoDB）
    const db = window.cbDatabase || { allCB: [] };
    let results = [];

    if (!db.allCB || db.allCB.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">資料庫載入中...</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    // 搜尋邏輯：代號前綴匹配 > 名稱包含 > 股票代號匹配
    db.allCB.forEach(cb => {
        const code = (cb.code || '').toLowerCase();
        const name = (cb.name || '').toLowerCase();
        const stockCode = (cb.stockCode || '').toLowerCase();

        let score = 0;
        if (code.startsWith(kw)) score = 100;
        else if (code.includes(kw)) score = 80;
        else if (stockCode.startsWith(kw)) score = 70;
        else if (name.includes(kw)) score = 50;

        if (score > 0) {
            results.push({ ...cb, score });
        }
    });

    // 排序：分數高 > 代號小
    results.sort((a, b) => b.score - a.score || a.code.localeCompare(b.code));
    results = results.slice(0, 15); // 最多顯示15筆

    if (results.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">找不到符合的CB</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    // 建立結果列表
    let html = '';
    results.forEach((cb, idx) => {
        const statusIcon = cb.isListed ? '🟢' : '⚫';
        const typeLabel = cb.isAuction || cb.type === '競拍' ? '<span style="color:#2e7d32; font-size:10px;">競拍</span>' : '<span style="color:#1976d2; font-size:10px;">詢圈</span>';
        html += `
            <div class="price-trend-search-item" data-code="${cb.code}" data-index="${idx}"
                 style="padding:10px 12px; cursor:pointer; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"
                 onmouseover="this.style.background='#f3e5f5'"
                 onmouseout="this.style.background='white'"
                 onclick="selectPriceTrendFromSearch('${cb.code}')">
                <div>
                    <span style="font-weight:bold; color:#7b1fa2;">${cb.code}</span>
                    <span style="margin-left:8px; color:#333;">${cb.name || ''}</span>
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
                    ${typeLabel}
                    <span>${statusIcon}</span>
                </div>
            </div>
        `;
    });

    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
    window.priceTrendSearchIndex = 0;
    highlightPriceTrendSearchItem(0);
}

/**
 * v3.97-zs-ax: 高亮選中的搜尋項目
 */
function highlightPriceTrendSearchItem(index) {
    const items = document.querySelectorAll('.price-trend-search-item');
    items.forEach((item, i) => {
        item.style.background = i === index ? '#f3e5f5' : 'white';
    });
}

/**
 * v3.97-zs-ax: 處理價格走勢搜尋框的鍵盤事件
 */
function handlePriceTrendSearchKey(event) {
    const resultsDiv = document.getElementById('priceTrendSearchResults');
    const items = document.querySelectorAll('.price-trend-search-item');

    if (!resultsDiv || resultsDiv.style.display === 'none' || items.length === 0) {
        if (event.key === 'Enter') {
            const input = document.getElementById('priceTrendSearch');
            if (input && input.value.trim()) {
                searchPriceTrendCBDirect(input.value.trim());
            }
        }
        return;
    }

    let idx = window.priceTrendSearchIndex || 0;

    if (event.key === 'ArrowDown') {
        event.preventDefault();
        idx = Math.min(idx + 1, items.length - 1);
        window.priceTrendSearchIndex = idx;
        highlightPriceTrendSearchItem(idx);
        items[idx].scrollIntoView({ block: 'nearest' });
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        idx = Math.max(idx - 1, 0);
        window.priceTrendSearchIndex = idx;
        highlightPriceTrendSearchItem(idx);
        items[idx].scrollIntoView({ block: 'nearest' });
    } else if (event.key === 'Enter') {
        event.preventDefault();
        const selectedItem = items[idx];
        if (selectedItem) {
            const code = selectedItem.dataset.code;
            selectPriceTrendFromSearch(code);
        }
    } else if (event.key === 'Escape') {
        resultsDiv.style.display = 'none';
    }
}

/**
 * v3.97-zs-ax: 從搜尋結果選擇CB
 */
function selectPriceTrendFromSearch(cbCode) {
    const resultsDiv = document.getElementById('priceTrendSearchResults');
    const input = document.getElementById('priceTrendSearch');
    const select = document.getElementById('priceTrendCBSelect');

    if (resultsDiv) resultsDiv.style.display = 'none';

    // 更新下拉選單
    if (select) {
        select.value = cbCode;
    }

    // 更新輸入框顯示
    if (input) {
        const db = window.cbDatabase || { allCB: [] };
        const cb = db.allCB.find(c => c.code === cbCode);
        input.value = cb ? `${cbCode} ${cb.name}` : cbCode;
    }

    // 載入價格走勢
    loadPriceTrend(cbCode);
}

/**
 * v3.97-zs-br 修正：直接搜尋CB（Enter鍵）
 */
function searchPriceTrendCBDirect(keyword) {
    const db = window.cbDatabase || { allCB: [] };
    const kw = keyword.toLowerCase();

    // 精確匹配代號
    let match = db.allCB.find(cb => cb.code.toLowerCase() === kw);

    // 前綴匹配
    if (!match) {
        match = db.allCB.find(cb => cb.code.toLowerCase().startsWith(kw));
    }

    // 名稱匹配
    if (!match) {
        match = db.allCB.find(cb => (cb.name || '').toLowerCase().includes(kw));
    }

    if (match) {
        selectPriceTrendFromSearch(match.code);
    }
}

/**
 * v3.97-zs-ax: 清除價格走勢搜尋
 */
function clearPriceTrendSearch() {
    const input = document.getElementById('priceTrendSearch');
    const resultsDiv = document.getElementById('priceTrendSearchResults');
    const select = document.getElementById('priceTrendCBSelect');

    if (input) input.value = '';
    if (resultsDiv) resultsDiv.style.display = 'none';
    if (select) select.selectedIndex = 0;

    // 清空內容區
    document.getElementById('priceTrendContent').innerHTML = `
        <div style="text-align:center; color:#999; padding:40px;">
            👆 請先選擇一檔可轉債查看價格走勢
        </div>
    `;
}

// 點擊其他地方關閉搜尋結果
document.addEventListener('click', function(e) {
    const resultsDiv = document.getElementById('priceTrendSearchResults');
    const input = document.getElementById('priceTrendSearch');
    if (resultsDiv && input && !resultsDiv.contains(e.target) && e.target !== input) {
        resultsDiv.style.display = 'none';
    }
});

// ==================== v3.97-cw 新增：台股熱門交易模組 ====================
// 根據Rex大叔私房菜指標設計：強度觀念、型態觀念、量能觀念

// 全域變數
let hotStockPeriod = 1;        // 預設1日
let hotStockType = 'gain';     // 預設漲幅排行 (gain/strong/weak)
let hotStockDataCache = null;  // 快取計算結果
let hotStockDataLoaded = false;
let hotStockSortField = null;  // 當前排序欄位
let hotStockSortDir = 'desc';  // 排序方向
let industryMap = {};          // 產業分類對照表

/**
 * 載入產業分類資料
 */
async function loadIndustryData() {
    try {
        const response = await fetch('data/00_cb/16_industry.csv');
        if (!response.ok) {
            console.warn('無法載入產業分類檔案');
            return;
        }
        const text = await response.text();
        const lines = text.trim().split('\n');
        
        // 格式：股票代號,公司名稱,產業分類,細分產業,產業地位說明,市場分類
        lines.forEach((line, idx) => {
            if (idx === 0) return; // 跳過表頭
            // 處理CSV中可能有逗號在引號內的情況
            const match = line.match(/^([^,]+),([^,]+),([^,]+)/);
            if (match) {
                const code = match[1].trim();
                const industry = match[3].trim();
                industryMap[code] = industry;
            }
        });
        console.log(`產業分類載入完成，共 ${Object.keys(industryMap).length} 筆`);
    } catch (e) {
        console.warn('載入產業分類失敗:', e);
    }
}

/**
 * 表格欄位排序
 * @param {string} field - 排序欄位
 * @param {string} [forceDir] - 強制指定排序方向 ('asc' 或 'desc')
 */
// v3.97-dw: 排序按鈕點擊處理（帶高亮狀態）
function sortHotStockBtn(field, dir, btnElement) {
    hotStockSortField = field;
    hotStockSortDir = dir;
    
    // 更新所有按鈕狀態
    document.querySelectorAll('.hot-sort-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'white';
        btn.style.color = '#666';
        btn.style.borderColor = '#ddd';
    });
    
    // 高亮當前按鈕
    if (btnElement) {
        btnElement.classList.add('active');
        btnElement.style.background = '#1976d2';
        btnElement.style.color = 'white';
        btnElement.style.borderColor = '#1976d2';
    }
    
    renderHotStockTable();
}

function sortHotStockTable(field, forceDir) {
    if (forceDir) {
        // 強制指定方向
        hotStockSortField = field;
        hotStockSortDir = forceDir;
    } else if (hotStockSortField === field) {
        // 同一欄位，切換方向
        hotStockSortDir = hotStockSortDir === 'desc' ? 'asc' : 'desc';
    } else {
        // 新欄位，預設降冪
        hotStockSortField = field;
        hotStockSortDir = 'desc';
    }
    renderHotStockTable();
}

/**
 * 切換時間區間
 */
function showHotStockPeriod(period, btn) {
    document.querySelectorAll('.ranking-period-tab').forEach(tab => {
        tab.style.background = '#fff';
        tab.style.color = '#333';
        tab.style.border = '1px solid #ddd';
        tab.classList.remove('active');
    });
    if (btn) {
        btn.style.background = '#e91e63';
        btn.style.color = 'white';
        btn.style.border = 'none';
        btn.classList.add('active');
    }
    
    hotStockPeriod = period;
    hotStockSortField = null; // 重置排序
    renderHotStockTable();
}

/**
 * 切換排行類型
 */
function toggleHotStockType(type) {
    hotStockType = type;
    
    const gainBtn = document.getElementById('rankTypeGain');
    const strongBtn = document.getElementById('rankTypeStrong');
    const weakBtn = document.getElementById('rankTypeWeak');
    
    // 重置所有按鈕
    [gainBtn, strongBtn, weakBtn].forEach(btn => {
        if (btn) {
            btn.style.background = 'white';
        }
    });
    
    if (type === 'gain' && gainBtn) {
        gainBtn.style.background = '#c62828';
        gainBtn.style.color = 'white';
        if (strongBtn) { strongBtn.style.color = '#ff9800'; }
        if (weakBtn) { weakBtn.style.color = '#2e7d32'; }
    } else if (type === 'strong' && strongBtn) {
        strongBtn.style.background = '#ff9800';
        strongBtn.style.color = 'white';
        if (gainBtn) { gainBtn.style.color = '#c62828'; }
        if (weakBtn) { weakBtn.style.color = '#2e7d32'; }
    } else if (type === 'weak' && weakBtn) {
        weakBtn.style.background = '#2e7d32';
        weakBtn.style.color = 'white';
        if (gainBtn) { gainBtn.style.color = '#c62828'; }
        if (strongBtn) { strongBtn.style.color = '#ff9800'; }
    }
    
    renderHotStockTable();
}

/**
 * 載入股票資料（從SQLite資料庫）
 */
async function loadHotStockData() {
    if (hotStockDataLoaded && hotStockDataCache) {
        return hotStockDataCache;
    }
    
    // 顯示載入中
    const container = document.getElementById('stockRankingContent');
    if (container) {
        container.innerHTML = `
            <div style="text-align:center; padding:60px 20px;">
                <div style="font-size:32px; margin-bottom:12px;">⏳</div>
                <div style="font-size:15px; color:#666;">正在載入股票資料...</div>
                <div style="font-size:12px; color:#999; margin-top:8px;">讀取上市上櫃資料庫中</div>
            </div>`;
    }
    
    try {
        // 初始化 sql.js
        if (!window.hotStockSQL) {
            window.hotStockSQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });
        }
        
        // 載入上市和上櫃資料庫
        const [tseResponse, otcResponse] = await Promise.all([
            fetch('data/stock_price_2025.db'),
            fetch('data/otc_price_2025.db')
        ]);
        
        if (!tseResponse.ok || !otcResponse.ok) {
            throw new Error('無法載入資料庫檔案');
        }
        
        const [tseBuffer, otcBuffer] = await Promise.all([
            tseResponse.arrayBuffer(),
            otcResponse.arrayBuffer()
        ]);
        
        const tseDb = new window.hotStockSQL.Database(new Uint8Array(tseBuffer));
        const otcDb = new window.hotStockSQL.Database(new Uint8Array(otcBuffer));
        
        // v3.97-dv: 使用已載入的融資融券資料（來自 Excel 檔案）
        let marginMap = {};
        if (window.marginData?.loaded && window.marginData?.data) {
            // 將 marginData 轉換為 marginMap 格式
            for (const [code, dateData] of Object.entries(window.marginData.data)) {
                // 取最新日期的資料
                const dates = Object.keys(dateData).sort();
                if (dates.length > 0) {
                    const latestDate = dates[dates.length - 1];
                    const latest = dateData[latestDate];
                    
                    // 計算融資增減（與前一日比較）
                    let marginChange = 0;
                    if (dates.length > 1) {
                        const prevDate = dates[dates.length - 2];
                        const prev = dateData[prevDate];
                        marginChange = (latest.marginBalance || 0) - (prev.marginBalance || 0);
                    }
                    
                    marginMap[code] = {
                        Margin_Balance: latest.marginBalance || 0,
                        Margin_Change: marginChange,
                        Short_Balance: latest.shortBalance || 0,
                        Short_Ratio: latest.marginBalance > 0 ? 
                            Math.round(latest.shortBalance * 100 / latest.marginBalance * 100) / 100 : 0
                    };
                }
            }
            console.log(`融資融券資料載入: ${Object.keys(marginMap).length} 檔`);
        } else {
            console.log('融資融券資料尚未載入，功能五將顯示部分欄位為空');
        }
        
        // 查詢上市資料
        const tseData = tseDb.exec(`
            SELECT Code, Name, Date, Open, High, Low, Close, Volume, Value
            FROM stock_price
            ORDER BY Code, Date
        `)[0];
        
        // 查詢上櫃資料
        const otcData = otcDb.exec(`
            SELECT Code, Name, Date, Open, High, Low, Close, Volume, Value
            FROM otc_price
            ORDER BY Code, Date
        `)[0];
        
        // 合併處理資料
        const allStocks = [];
        
        // 處理上市
        if (tseData) {
            const processed = processStockData(tseData.values, tseData.columns, '上市');
            allStocks.push(...processed);
        }
        
        // 處理上櫃
        if (otcData) {
            const processed = processStockData(otcData.values, otcData.columns, '上櫃');
            allStocks.push(...processed);
        }
        
        // 整合融資融券資料
        allStocks.forEach(stock => {
            const marginInfo = marginMap[stock.Code];
            if (marginInfo) {
                stock.Margin_Change = marginInfo.Margin_Change;  // 融資增減
                stock.Short_Balance = marginInfo.Short_Balance;  // 融券餘額
                stock.Short_Ratio = marginInfo.Short_Ratio;      // 券資比
            } else {
                stock.Margin_Change = null;
                stock.Short_Balance = null;
                stock.Short_Ratio = null;
            }
        });
        
        // 篩選成交值 >= 5000萬
        const hotStocks = allStocks.filter(s => s.Value_M >= 50);
        
        console.log(`台股熱門交易: 載入 ${allStocks.length} 檔，熱門 ${hotStocks.length} 檔`);
        
        // 關閉資料庫
        tseDb.close();
        otcDb.close();
        
        hotStockDataCache = hotStocks;
        hotStockDataLoaded = true;
        
        // 更新資料資訊
        const dataInfo = document.getElementById('stockRankingDataInfo');
        if (dataInfo && hotStocks.length > 0) {
            dataInfo.textContent = `共 ${hotStocks.length} 檔熱門股票`;
        }
        
        return hotStocks;
        
    } catch (error) {
        console.error('載入股票資料失敗:', error);
        if (container) {
            container.innerHTML = `
                <div style="text-align:center; color:#c62828; padding:60px 20px;">
                    <div style="font-size:32px; margin-bottom:12px;">⚠️</div>
                    <div style="font-size:15px;">載入資料失敗</div>
                    <div style="font-size:12px; color:#999; margin-top:8px;">${error.message}</div>
                </div>`;
        }
        return [];
    }
}

/**
 * 處理股票資料，計算各項指標
 */
function processStockData(rows, columns, market) {
    // 建立欄位索引
    const colIdx = {};
    columns.forEach((col, i) => colIdx[col] = i);
    
    // 按股票代碼+名稱分組（避免同代碼不同標的的問題）
    const stockGroups = {};
    rows.forEach(row => {
        const code = String(row[colIdx['Code']]);
        const name = String(row[colIdx['Name']] || '');
        const key = `${code}_${name}`;  // 用代碼+名稱作為唯一識別
        if (!stockGroups[key]) {
            stockGroups[key] = [];
        }
        stockGroups[key].push(row);
    });
    
    const results = [];
    
    for (const key in stockGroups) {
        const group = stockGroups[key].sort((a, b) => a[colIdx['Date']] - b[colIdx['Date']]);
        
        if (group.length < 5) continue;
        
        const latest = group[group.length - 1];
        const close = parseFloat(latest[colIdx['Close']]) || 0;
        const volume = parseInt(latest[colIdx['Volume']]) || 0;
        const value = parseFloat(latest[colIdx['Value']]) || 0;
        
        if (close <= 0) continue;
        
        const code = String(latest[colIdx['Code']]);
        const name = String(latest[colIdx['Name']] || '');
        
        // 過濾ETF和權證（通常名稱包含特定關鍵字）
        const etfKeywords = ['台灣50', '高股息', '旗艦', '中100', '元大', '富邦', '國泰', '永豐', '兆豐', '群益'];
        const isETF = etfKeywords.some(kw => name.includes(kw)) && !name.includes('-KY');
        if (isETF) continue;
        
        const result = {
            Code: code,
            Name: name,
            Market: market,
            Close: close,
            Volume: volume,
            Value_M: value / 1000000,
        };
        
        // 計算各期間漲跌幅
        const getChange = (daysAgo) => {
            if (group.length <= daysAgo) return 0;
            const prevClose = parseFloat(group[group.length - 1 - daysAgo][colIdx['Close']]) || 0;
            return prevClose > 0 ? ((close - prevClose) / prevClose * 100) : 0;
        };
        
        result.Change_1D = getChange(1);
        result.Change_3D = getChange(3);
        result.Change_5D = getChange(5);
        result.Change_10D = group.length > 10 ? getChange(10) : 0;
        result.Change_20D = group.length > 20 ? getChange(20) : 0;
        result.Change_60D = group.length > 60 ? getChange(60) : 0;
        
        // 驗證漲跌幅合理性（單日不應超過11%，除非是初上市）
        if (Math.abs(result.Change_1D) > 15 || Math.abs(result.Change_3D) > 50) {
            console.warn(`${code} ${name} 漲跌幅異常: 1D=${result.Change_1D.toFixed(2)}% 3D=${result.Change_3D.toFixed(2)}%`);
            continue;  // 跳過異常資料
        }
        
        // 計算均線乖離率
        const getMA = (days) => {
            if (group.length < days) return 0;
            let sum = 0;
            for (let i = group.length - days; i < group.length; i++) {
                sum += parseFloat(group[i][colIdx['Close']]) || 0;
            }
            return sum / days;
        };
        
        const ma5 = getMA(5);
        const ma10 = getMA(10);
        const ma20 = getMA(20);
        const ma60 = group.length >= 60 ? getMA(60) : 0;
        
        result.Bias5 = ma5 > 0 ? ((close - ma5) / ma5 * 100) : 0;
        result.Bias10 = ma10 > 0 ? ((close - ma10) / ma10 * 100) : 0;
        result.Bias20 = ma20 > 0 ? ((close - ma20) / ma20 * 100) : 0;
        result.Bias60 = ma60 > 0 ? ((close - ma60) / ma60 * 100) : 0;
        
        // 5日均量和量比
        const ma5Vol = group.slice(-5).reduce((sum, r) => sum + (parseInt(r[colIdx['Volume']]) || 0), 0) / 5;
        result.MA5_Vol = ma5Vol;
        result.Vol_Ratio = ma5Vol > 0 ? (volume / ma5Vol) : 0;
        
        // 5日均值
        const ma5Val = group.slice(-5).reduce((sum, r) => sum + (parseFloat(r[colIdx['Value']]) || 0), 0) / 5;
        result.MA5_Val_M = ma5Val / 1000000;
        
        // 強度觀念 = (當日×5 + 3日×4 + 5日×3 + 10日×2 + 20日×1) / 15
        result.Strength = (result.Change_1D * 5 + result.Change_3D * 4 + result.Change_5D * 3 + 
                          result.Change_10D * 2 + result.Change_20D * 1) / 15;
        
        // 型態觀念 = (5MA乖離×1 + 10MA×2 + 20MA×3 + 60MA×4) / 10
        result.Pattern = (result.Bias5 * 1 + result.Bias10 * 2 + result.Bias20 * 3 + result.Bias60 * 4) / 10;
        
        // 預留法人買賣超欄位
        result.Foreign = null;      // 外資
        result.Investment = null;   // 投信
        result.Dealer = null;       // 主力
        result.Retail = null;       // 散戶
        result.Margin_Buy = null;   // 融資增減
        result.Margin_Sell = null;  // 融券增減
        
        results.push(result);
    }
    
    return results;
}

/**
 * 渲染熱門股票表格
 */
async function renderHotStockTable() {
    const container = document.getElementById('stockRankingContent');
    if (!container) return;
    
    const data = await loadHotStockData();
    if (!data || data.length === 0) {
        return;
    }
    
    // 複製資料進行排序
    let sortedData = [...data];
    
    // 決定排序欄位和方向
    let actualSortField = hotStockSortField || 'Value_M';  // 預設按成交值排序
    let actualSortDir = hotStockSortDir || 'desc';
    
    // 排序
    sortedData.sort((a, b) => {
        let aVal = a[actualSortField];
        let bVal = b[actualSortField];
        
        // 處理字串排序（如產業）
        if (typeof aVal === 'string') {
            return actualSortDir === 'desc' ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
        }
        
        aVal = aVal || 0;
        bVal = bVal || 0;
        return actualSortDir === 'desc' ? bVal - aVal : aVal - bVal;
    });
    
    // 取前30名
    const topN = sortedData.slice(0, 30);
    
    // 表頭顏色
    const headerBg = '#37474f';
    
    // 排序圖示函數
    const getSortIcon = (field) => {
        if (hotStockSortField === field) {
            return hotStockSortDir === 'desc' ? '▼' : '▲';
        }
        return '↕';
    };
    
    // v3.97-dv: 格式化漲跌幅
    const fmtChg = (val) => {
        if (val === null || val === undefined) return '-';
        const num = parseFloat(val);
        if (isNaN(num)) return '-';
        return (num > 0 ? '+' : '') + num.toFixed(2) + '%';
    };
    
    // 可排序表頭樣式
    const thStyle = 'padding:12px 6px; text-align:right; font-weight:600; cursor:pointer; user-select:none; white-space:nowrap;';
    
    // 生成表格
    let tableHTML = `
        <div style="background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
            <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px; min-width:1000px;">
                <thead>
                    <tr style="background:${headerBg}; color:white;">
                        <th style="padding:12px 6px; text-align:center; font-weight:600; width:30px;">#</th>
                        <th style="padding:12px 6px; text-align:left; font-weight:600; min-width:110px;">股票</th>
                        <th style="padding:12px 6px; text-align:left; font-weight:600; width:70px;">產業</th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Close')">
                            收盤 ${getSortIcon('Close')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Change_1D')">
                            1日% ${getSortIcon('Change_1D')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Change_3D')">
                            3日% ${getSortIcon('Change_3D')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Change_5D')">
                            5日% ${getSortIcon('Change_5D')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Change_10D')">
                            10日% ${getSortIcon('Change_10D')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Change_20D')">
                            20日% ${getSortIcon('Change_20D')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Change_60D')">
                            60日% ${getSortIcon('Change_60D')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Strength')">
                            強度 ${getSortIcon('Strength')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Value_M')">
                            成交值 ${getSortIcon('Value_M')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Vol_Ratio')">
                            量比 ${getSortIcon('Vol_Ratio')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Margin_Change')">
                            融資增 ${getSortIcon('Margin_Change')}
                        </th>
                        <th style="${thStyle}" onclick="sortHotStockTable('Short_Balance')">
                            融券 ${getSortIcon('Short_Balance')}
                        </th>
                    </tr>
                </thead>
                <tbody>`;
    
    topN.forEach((stock, idx) => {
        // 顏色規則函數
        const getChangeStyle = (val) => {
            if (val > 2) return 'color:#c62828; background:#ffebee;';
            if (val < -2) return 'color:#2e7d32; background:#e8f5e9;';
            return 'color:#333;';
        };
        
        // 量比顏色
        let volRatioStyle = 'color:#333;';
        if (stock.Vol_Ratio >= 1.5 && stock.Change_1D > 2) {
            volRatioStyle = 'color:#e65100; background:#fff3e0;';
        } else if (stock.Vol_Ratio >= 1.2 && stock.Change_1D < -2) {
            volRatioStyle = 'color:#1565c0; background:#e3f2fd;';
        }
        
        const bgColor = idx % 2 === 0 ? '#fff' : '#fafafa';
        const marketBadge = stock.Market === '上市' ? 
            '<span style="background:#1976d2; color:white; padding:1px 4px; border-radius:3px; font-size:10px; margin-left:4px;">市</span>' :
            '<span style="background:#7b1fa2; color:white; padding:1px 4px; border-radius:3px; font-size:10px; margin-left:4px;">櫃</span>';
        
        // 產業
        const industry = industryMap[stock.Code] || '-';
        
        // 法人欄位改為融資融券
        const marginChangeDisplay = stock.Margin_Change !== null ? 
            (stock.Margin_Change > 0 ? '+' : '') + stock.Margin_Change.toLocaleString() : '-';
        const shortDisplay = stock.Short_Balance !== null ? 
            stock.Short_Balance.toLocaleString() : '-';
        
        // 融資增減顏色
        let marginStyle = 'color:#888;';
        if (stock.Margin_Change > 500) {
            marginStyle = 'color:#c62828; font-weight:600;';  // 大增紅色
        } else if (stock.Margin_Change < -500) {
            marginStyle = 'color:#2e7d32; font-weight:600;';  // 大減綠色
        }
        
        const tdStyle = 'padding:10px 6px; text-align:right; font-size:13px;';
        
        tableHTML += `
            <tr style="background:${bgColor}; border-bottom:1px solid #eee;">
                <td style="padding:10px 6px; text-align:center; font-weight:600; color:#888; font-size:12px;">${idx + 1}</td>
                <td style="padding:10px 6px; text-align:left;">
                    <div style="font-weight:600; color:#333; font-size:14px;">${stock.Name} ${marketBadge}</div>
                    <div style="font-size:12px; color:#888;">${stock.Code}</div>
                </td>
                <td style="padding:10px 6px; text-align:left; font-size:12px; color:#666;">${industry}</td>
                <td style="${tdStyle} font-weight:600;">${stock.Close.toFixed(1)}</td>
                <td style="${tdStyle} ${getChangeStyle(stock.Change_1D)} font-weight:600;">${fmtChg(stock.Change_1D)}</td>
                <td style="${tdStyle} ${getChangeStyle(stock.Change_3D)}">${fmtChg(stock.Change_3D)}</td>
                <td style="${tdStyle} ${getChangeStyle(stock.Change_5D)}">${fmtChg(stock.Change_5D)}</td>
                <td style="${tdStyle} ${getChangeStyle(stock.Change_10D)}">${fmtChg(stock.Change_10D)}</td>
                <td style="${tdStyle} ${getChangeStyle(stock.Change_20D)}">${fmtChg(stock.Change_20D)}</td>
                <td style="${tdStyle} ${getChangeStyle(stock.Change_60D)}">${fmtChg(stock.Change_60D)}</td>
                <td style="${tdStyle} ${getChangeStyle(stock.Strength)} font-weight:600;">${stock.Strength.toFixed(2)}</td>
                <td style="${tdStyle} color:#666; font-weight:500;">${(stock.Value_M).toFixed(0)}</td>
                <td style="${tdStyle} ${volRatioStyle} font-weight:500;">${stock.Vol_Ratio.toFixed(2)}</td>
                <td style="${tdStyle} ${marginStyle}">${marginChangeDisplay}</td>
                <td style="${tdStyle} color:#666;">${shortDisplay}</td>
            </tr>`;
    });
    
    tableHTML += `
                </tbody>
            </table>
            </div>
        </div>
        <div style="padding:10px 16px; font-size:12px; color:#666; background:#f5f5f5; border-radius:0 0 8px 8px;">
            💡 點擊表頭排序 | <span style="color:#c62828;">紅</span>=漲>2% <span style="color:#2e7d32;">綠</span>=跌>2% | 融資增：<span style="color:#c62828;">紅>500</span> <span style="color:#2e7d32;">綠<-500</span> | 成交值：百萬
        </div>`;
    
    container.innerHTML = tableHTML;
    
    // 更新資料資訊
    const dataInfo = document.getElementById('stockRankingDataInfo');
    if (dataInfo) {
        dataInfo.textContent = `共 ${data.length} 檔熱門股票`;
    }
}

/**
 * 台股熱門交易區塊初始化
 */
async function initHotStockSection() {
    // 先載入產業分類
    if (Object.keys(industryMap).length === 0) {
        await loadIndustryData();
    }
    
    const content = document.getElementById('stockRankingContent');
    if (content && !hotStockDataLoaded) {
        renderHotStockTable();
    }
}

// 監聽區塊展開事件
document.addEventListener('click', function(e) {
    if (e.target.closest('.section-ranking .right-section-header')) {
        setTimeout(initHotStockSection, 100);
    }
});

// ==================== 保留原有的價格走勢功能 ====================

/**
 * 載入價格走勢資料
 */
function loadPriceTrend(cbCode) {
    if (!cbCode) {
        document.getElementById('priceTrendContent').innerHTML = `
            <div style="text-align:center; color:#999; padding:40px;">
                👆 請先選擇一檔可轉債查看價格走勢
            </div>`;
        return;
    }

    currentPriceTrendCB = cbCode;
    showPriceTrendTab('stockPrice');
}

/**
 * 更新價格走勢期間
 */
function updatePriceTrendPeriod() {
    if (currentPriceTrendCB) {
        const activeTab = document.querySelector('.price-trend-tab.active');
        if (activeTab) {
            const tabText = activeTab.textContent;
            const tabName = tabText.includes('股價') ? 'stockPrice' :
                           tabText.includes('理論價值') ? 'cbPrice' :
                           tabText.includes('CB價格') ? 'cbHistory' :
                           tabText.includes('籌碼') ? 'balance' : 'cbas';
            showPriceTrendTab(tabName);
        }
    }
}

/**
 * 顯示價格走勢標籤頁
 */
function showPriceTrendTab(tabName, event) {
    // v3.97-as-ci: 更新標籤樣式（紫色邊框風格）
    document.querySelectorAll('.price-trend-tab').forEach(tab => {
        tab.style.background = 'white';
        tab.style.color = '#7b1fa2';
        tab.style.border = '2px solid #9c27b0';
        tab.classList.remove('active');
    });

    // 確保正確找到按鈕元素（處理點擊 emoji 或文字的情況）
    if (event) {
        let target = event.target;
        while (target && !target.classList.contains('price-trend-tab')) {
            target = target.parentElement;
        }
        if (target) {
            target.style.background = '#9c27b0';
            target.style.color = 'white';
            target.style.border = '2px solid #9c27b0';
            target.classList.add('active');
        }
    } else {
        const tabs = document.querySelectorAll('.price-trend-tab');
        const index = tabName === 'stockPrice' ? 0 : tabName === 'cbPrice' ? 1 :
                      tabName === 'cbHistory' ? 2 : tabName === 'balance' ? 3 : 4;
        if (tabs[index]) {
            tabs[index].style.background = '#9c27b0';
            tabs[index].style.color = 'white';
            tabs[index].style.border = '2px solid #9c27b0';
            tabs[index].classList.add('active');
        }
    }

    const content = document.getElementById('priceTrendContent');
    const cbCode = currentPriceTrendCB;

    if (!cbCode) {
        content.innerHTML = `<div style="text-align:center; color:#999; padding:60px 20px; background:#fff; border-radius:12px;">
            <div style="font-size:32px; margin-bottom:12px;">👆</div>
            <div style="font-size:15px;">請先選擇一檔可轉債</div>
        </div>`;
        return;
    }

    // CBAS標籤特殊處理：可以不依賴 kanban 歷史資料
    if (tabName === 'cbas') {
        renderCBASFromCurrentData(cbCode, content);
        return;
    }

    // v3.97-zs-br: CB價格走勢標籤 - 使用 CB_price 資料庫
    if (tabName === 'cbHistory') {
        const period = document.getElementById('priceTrendPeriod')?.value || '90';
        renderCBHistory(cbCode, content, period);
        return;
    }

    // 顯示載入中
    content.innerHTML = `<div style="text-align:center; padding:40px; color:#666; background:#fff; border-radius:12px;">
        <div style="font-size:24px; margin-bottom:10px;">⏳</div>
        <div>載入 ${cbCode} 價格走勢中...</div>
    </div>`;

    // 取得期間設定
    const period = document.getElementById('priceTrendPeriod')?.value || '90';

    // 載入kanban資料並繪製圖表
    loadKanbanAndRender(cbCode, tabName, period, content);
}

/**
 * 從當前資料渲染 CBAS 分析（不依賴 kanban 歷史資料）
 */
function renderCBASFromCurrentData(cbCode, container) {
    // 嘗試從 quoteData 取得當前資料
    const quoteData09 = window.quoteData?.['09'] || {};
    const cbData = quoteData09[cbCode];

    // 也嘗試從 kanban 取得最新資料
    const kanbanTimeSeries = window.kanbanData?.data?.[cbCode] || [];
    const latestKanban = kanbanTimeSeries[kanbanTimeSeries.length - 1] || {};

    // 合併資料來源
    const cbPrice = parseFloat(latestKanban.cbPrice) || parseFloat(cbData?.['最新成交價']) || 0;
    const stockPrice = parseFloat(latestKanban.stockPrice) || 0;
    const convPrice = parseFloat(latestKanban.convPrice) || parseFloat(cbData?.['轉換價格']) || 0;

    // 渲染 CBAS 分析頁面
    const period = document.getElementById('priceTrendPeriod')?.value || '90';
    renderCBASChart(cbCode, [{
        cbPrice: cbPrice,
        stockPrice: stockPrice,
        convPrice: convPrice,
        convValue: convPrice > 0 ? (stockPrice / convPrice * 100) : 0,
        premium: 0
    }], container, period);
}

// ==================== v3.97z-s 新增：CB_kanban資料載入與圖表繪製 ====================

// v3.97-zs-bs: 等待資料載入的 Promise 輔助函數（取代 setInterval 輪詢）
function waitForDataLoaded(checkFn, timeout = 30000) {
    return new Promise((resolve, reject) => {
        if (checkFn()) {
            resolve();
            return;
        }
        const startTime = Date.now();
        const check = () => {
            if (checkFn()) {
                resolve();
            } else if (Date.now() - startTime > timeout) {
                reject(new Error('載入逾時'));
            } else {
                requestAnimationFrame(check);
            }
        };
        requestAnimationFrame(check);
    });
}

// 全域變數 - kanban時間序列資料
window.kanbanData = {
    loaded: false,
    loading: false,
    data: {},  // { cbCode: [{ date, stockPrice, cbPrice, convPrice, balance }] }
    dates: []  // 所有日期清單
};

// v3.97-zs-br: 全域變數 - CB價格歷史資料
window.cbPriceData = {
    loaded: false,
    loading: false,
    data: {}  // { cbCode: [{ date, close, open, high, low, volume, amount }] }
};

// Chart.js 實例存儲（用於銷毀舊圖表）
let priceChartInstance = null;

// v3.97z-s 新增：元大歷史資料（yuanta_data1.xlsx + yuanta_data2.xlsx）
window.yuantaHistoryData = {
    loaded: false,
    loading: false,
    data: {}  // { cbCode: { 最新一筆的完整資料 } }
};

// v3.97-zs-at 新增：週餘額時間序列資料
window.weeklyBalanceData = {
    loaded: false,
    loading: false,
    data: {}  // { cbCode: [{ date, balance, ... }, ...] }
};

// v3.97-zs-az 新增：融資融券資料
window.marginData = {
    loaded: false,
    loading: false,
    data: {}  // { stockCode: { date: { marginBalance, marginChange, shortBalance, shortChange, shortCover }, ... } }
};

/**
 * v3.97-eb: 載入融資融券資料
 * 優先使用 SQLite (margin_2025.db)，沒有才用 Excel
 */
async function loadMarginData() {
    if (window.marginData.loaded || window.marginData.loading) return;
    window.marginData.loading = true;

    console.log('📊 載入融資融券資料...');
    const startTime = Date.now();

    const allData = {};

    // v3.97-eb: 優先嘗試 SQLite
    try {
        const dbResponse = await fetch('data/margin_2025.db');
        if (dbResponse.ok) {
            console.log('   使用 SQLite 資料庫...');
            
            // 確保 sql.js 已初始化
            let SQL;
            if (window.kanbanSQL) {
                SQL = window.kanbanSQL;
            } else {
                SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
            }
            
            const buffer = await dbResponse.arrayBuffer();
            const db = new SQL.Database(new Uint8Array(buffer));
            
            // 查詢所有資料
            const results = db.exec(`
                SELECT date, code, margin_balance, short_balance
                FROM margin_data
                ORDER BY code, date
            `);
            
            if (results.length > 0) {
                for (const row of results[0].values) {
                    const [dateStr, code, marginBalance, shortBalance] = row;
                    if (!code) continue;
                    
                    if (!allData[code]) allData[code] = {};
                    allData[code][dateStr] = {
                        marginBalance: marginBalance || 0,
                        shortBalance: shortBalance || 0
                    };
                }
            }
            
            db.close();
            
            window.marginData.data = allData;
            window.marginData.loaded = true;
            window.marginData.loading = false;
            
            console.log(`✅ 融資融券完成(SQLite): ${Object.keys(allData).length} 檔, ${Date.now() - startTime}ms`);
            return;
        }
    } catch (e) {
        console.log('   SQLite 載入失敗，改用 Excel...', e.message);
    }

    // 備用方案：使用 Excel
    const fileConfigs = [
        { prefix: 'data/tpxlenging_2025.xlsx', market: '上市' },
        { prefix: 'data/otclenging_2025.xlsx', market: '上櫃' }
    ];

    for (const config of fileConfigs) {
        try {
            const response = await fetch(config.prefix);
            if (!response.ok) continue;

            const workbook = XLSX.read(await response.arrayBuffer(), { type: 'array' });
            
            // 只載入最近30天（效能優先）
            const validSheets = workbook.SheetNames.filter(name => /^\d{8}$/.test(name)).sort().slice(-30);
            if (validSheets.length === 0) continue;

            let addedCount = 0;
            for (const sheetName of validSheets) {
                const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                if (rawData.length < 2) continue;

                // 找欄位位置
                const headers = rawData[0];
                let codeIdx = -1, marginIdx = -1, shortIdx = -1;
                headers.forEach((h, idx) => {
                    const col = String(h || '').trim();
                    if (col === '代號') codeIdx = idx;
                    if (col === '資餘額') marginIdx = idx;
                    if (col === '券餘額') shortIdx = idx;
                });

                if (codeIdx < 0 || marginIdx < 0 || shortIdx < 0) continue;

                const dateStr = `${sheetName.substring(0,4)}/${sheetName.substring(4,6)}/${sheetName.substring(6,8)}`;

                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    let code = String(row[codeIdx] || '').trim().replace(/\.0*$/, '');
                    if (!code) continue;

                    if (!allData[code]) allData[code] = {};
                    allData[code][dateStr] = {
                        marginBalance: parseInt(row[marginIdx]) || 0,
                        shortBalance: parseInt(row[shortIdx]) || 0
                    };
                    addedCount++;
                }
            }
            console.log(`   ${config.market}: ${validSheets.length}天, ${addedCount}筆`);
        } catch (err) {
            console.warn(`❌ ${config.market} 載入失敗:`, err.message);
        }
    }

    window.marginData.data = allData;
    window.marginData.loaded = true;
    window.marginData.loading = false;

    console.log(`✅ 融資融券完成: ${Object.keys(allData).length} 檔, ${Date.now() - startTime}ms`);
}

/**
 * v3.97-zs-az: 取得CB對應的股票代號
 */
function getStockCodeFromCB(cbCode) {
    const searchCode = String(cbCode).trim();

    // 從 sheet08Data 取得
    if (window.sheet08Data?.length > 0) {
        const row = window.sheet08Data.find(r => String(r['代號']).trim() === searchCode);
        if (row) {
            const stockCode = String(row['轉換標的代碼'] || row['股票代號'] || '').trim();
            if (stockCode) return stockCode;
        }
    }

    // 從 auctionDataCache 取得
    if (window.auctionDataCache?.length > 0) {
        const row = window.auctionDataCache.find(r => String(r['CB代號']).trim() === searchCode);
        if (row) {
            const stockCode = String(row['股票代號'] || '').trim();
            if (stockCode) return stockCode;
        }
    }

    // 從 cbDatabase 取得
    if (window.cbDatabase?.allCB) {
        const cb = window.cbDatabase.allCB.find(c => c.code === searchCode);
        if (cb?.stockCode) return cb.stockCode;
    }

    return null;
}

/**
 * v3.97-zs-az: 取得指定股票在指定日期的融資融券資料
 */
function getMarginDataForDate(stockCode, dateStr) {
    if (!window.marginData.loaded || !stockCode) return null;

    const stockData = window.marginData.data[stockCode];
    if (!stockData) return null;

    // 直接匹配日期
    if (stockData[dateStr]) return stockData[dateStr];

    // 找最接近的日期（週資料可能在假日，找最近的交易日）
    const dates = Object.keys(stockData).sort();
    const targetNum = parseInt(dateStr.replace(/\//g, ''));

    let closestDate = null;
    let minDiff = Infinity;

    for (const d of dates) {
        const dNum = parseInt(d.replace(/\//g, ''));
        const diff = Math.abs(dNum - targetNum);
        if (diff < minDiff && dNum <= targetNum) {
            minDiff = diff;
            closestDate = d;
        }
    }

    return closestDate ? stockData[closestDate] : null;
}

/**
 * v3.97-zs-at 新增：載入週餘額時間序列
 * 從 yuanta_data1.xlsx 和 yuanta_data2.xlsx 的 S 欄「最新餘額(百萬)」
 */
async function loadWeeklyBalanceData() {
    if (window.weeklyBalanceData.loaded || window.weeklyBalanceData.loading) return;
    window.weeklyBalanceData.loading = true;

    const startTime = Date.now();

    const allData = {};

    // v3.97-zs-br: 改用 SQLite 資料庫
    const dbFiles = ['data/yuanta_data1.db', 'data/yuanta_data2.db'];

    // 確保 sql.js 已初始化
    if (!window.kanbanSQL) {
        try {
            window.kanbanSQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });
        } catch (e) {
            console.error('SQL.js 初始化失敗:', e);
            window.weeklyBalanceData.loading = false;
            return;
        }
    }
    const SQL = window.kanbanSQL;

    for (const dbFile of dbFiles) {
        try {
            const response = await fetch(dbFile);
            if (!response.ok) continue;

            const buffer = await response.arrayBuffer();
            const db = new SQL.Database(new Uint8Array(buffer));

            // 讀取欄位映射，找出「代號」和「最新餘額」的欄位索引
            const mappingResult = db.exec("SELECT col_index, col_name FROM column_mapping ORDER BY col_index");
            if (!mappingResult.length) {
                db.close();
                continue;
            }

            let codeColIdx = -1, balanceColIdx = -1;
            mappingResult[0].values.forEach(([idx, name]) => {
                const normalized = String(name || '').replace(/^\d{6,7}/, '').trim();
                if (normalized === '代號') codeColIdx = idx;
                if (normalized === '最新餘額(百萬)' || normalized === '最新餘額') balanceColIdx = idx;
            });

            if (codeColIdx < 0 || balanceColIdx < 0) {
                console.warn(`${dbFile} 找不到必要欄位`);
                db.close();
                continue;
            }

            // 取得所有 table（t + 民國年日期）
            const tablesResult = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 't%' AND name != 'column_mapping' ORDER BY name ASC");
            if (!tablesResult.length) {
                db.close();
                continue;
            }

            const tables = tablesResult[0].values.map(r => r[0]);
            console.log(`載入 ${dbFile}: ${tables.length} 個週快照`);

            for (const tableName of tables) {
                // 從 table 名稱解析日期 (t1141212 -> 1141212)
                const rocDateStr = tableName.replace('t', '');
                if (!/^\d{7}$/.test(rocDateStr)) continue;

                const rocYear = parseInt(rocDateStr.substring(0, 3));
                const month = rocDateStr.substring(3, 5);
                const day = rocDateStr.substring(5, 7);
                const westYear = rocYear + 1911;
                const dateStr = `${westYear}/${month}/${day}`;
                const dateNum = parseInt(`${westYear}${month}${day}`);

                const dataResult = db.exec(`SELECT col${codeColIdx}, col${balanceColIdx} FROM "${tableName}"`);
                if (!dataResult.length) continue;

                for (const row of dataResult[0].values) {
                    const code = String(row[0] || '').trim();
                    if (!code) continue;

                    const balanceRaw = parseFloat(row[1]) || 0;
                    if (balanceRaw <= 0) continue;

                    // 百萬轉億元
                    const balance = balanceRaw / 100;
                    // 百萬轉張數（1張=10萬，所以百萬×10=張數）
                    const balanceShares = Math.round(balanceRaw * 10);

                    if (!allData[code]) allData[code] = [];

                    // 檢查是否已有該日期資料
                    const existing = allData[code].find(d => d.dateNum === dateNum);
                    if (!existing) {
                        allData[code].push({
                            date: dateStr,
                            dateNum: dateNum,
                            balance: balance,
                            balanceShares: balanceShares
                        });
                    }
                }
            }

            db.close();
        } catch (err) {
            console.warn(`載入 ${dbFile} 週餘額失敗:`, err.message);
        }
    }

    // 排序每個CB的時間序列
    for (const code of Object.keys(allData)) {
        allData[code].sort((a, b) => a.dateNum - b.dateNum);
    }

    window.weeklyBalanceData.data = allData;
    window.weeklyBalanceData.loaded = true;
    window.weeklyBalanceData.loading = false;

    const totalRecords = Object.values(allData).reduce((sum, arr) => sum + arr.length, 0);
    console.log(`✅ 週餘額載入完成: ${Object.keys(allData).length} 檔CB, ${totalRecords} 筆週資料, ${Date.now() - startTime}ms`);
}

/**
 * v3.97z-s 載入元大歷史基本資料
 * 從 yuanta_data1.xlsx 和 yuanta_data2.xlsx 載入歷年每週基本資料
 */
async function loadYuantaHistoryData() {
    if (window.yuantaHistoryData.loaded || window.yuantaHistoryData.loading) return;
    window.yuantaHistoryData.loading = true;

    console.log('📂 開始載入元大歷史資料 (SQLite版)...');
    const startTime = Date.now();

    // 欄位名稱標準化（去掉日期前綴 YYYMMDD 民國年7位 或 YYYYMM 西元年6位）
    function normalizeFieldName(field) {
        if (!field) return '';
        let result = String(field).replace(/^\d{7}/, '').trim();
        if (result === String(field).trim()) {
            result = String(field).replace(/^\d{6}/, '').trim();
        }
        return result;
    }

    const allData = {};

    // v3.97-dm: 先初始化 SQL.js
    let SQL;
    try {
        SQL = await initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        });
    } catch (err) {
        console.error('SQL.js 初始化失敗:', err);
        window.yuantaHistoryData.loading = false;
        return;
    }

    // v3.97-zs-br: 改用 SQLite 資料庫載入
    const dbFiles = ['data/yuanta_data1.db', 'data/yuanta_data2.db'];

    for (const dbFile of dbFiles) {
        try {
            const response = await fetch(dbFile);
            if (!response.ok) {
                console.warn(`找不到 ${dbFile}，跳過`);
                continue;
            }

            const buffer = await response.arrayBuffer();
            const db = new SQL.Database(new Uint8Array(buffer));

            // 讀取欄位對照表
            const mappingResult = db.exec("SELECT col_index, col_name FROM column_mapping ORDER BY col_index");
            if (!mappingResult.length) {
                console.warn(`${dbFile} 無 column_mapping，跳過`);
                db.close();
                continue;
            }

            // 建立欄位映射 (col索引 -> 標準化欄位名)
            const colToField = {};
            mappingResult[0].values.forEach(([idx, name]) => {
                const normalized = normalizeFieldName(name);
                if (normalized) colToField[idx] = normalized;
            });

            // 找出「代號」對應的 col 索引
            let codeColIdx = null;
            for (const [idx, field] of Object.entries(colToField)) {
                if (field === '代號') { codeColIdx = parseInt(idx); break; }
            }
            if (codeColIdx === null) {
                console.warn(`${dbFile} 找不到代號欄位，跳過`);
                db.close();
                continue;
            }

            // 取得所有 table（排除 column_mapping，按日期排序）
            const tablesResult = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name != 'column_mapping' ORDER BY name ASC");
            if (!tablesResult.length) {
                db.close();
                continue;
            }

            const tables = tablesResult[0].values.map(r => r[0]);
            console.log(`載入 ${dbFile}: ${tables.length} 個快照`);

            // 遍歷每個 table（從舊到新，新的會覆蓋舊的）
            for (const tableName of tables) {
                const sheetDate = tableName.replace('t', ''); // t1141212 -> 1141212

                const dataResult = db.exec(`SELECT * FROM "${tableName}"`);
                if (!dataResult.length) continue;

                const rows = dataResult[0].values;
                const colCount = rows[0]?.length || 0;

                for (const row of rows) {
                    const code = String(row[codeColIdx] || '').trim();
                    if (!code || code === 'undefined') continue;

                    // 建立標準化的資料物件
                    const record = { _sheetDate: sheetDate };

                    for (let i = 0; i < colCount; i++) {
                        const fieldName = colToField[i];
                        if (fieldName && row[i] !== null && row[i] !== '') {
                            record[fieldName] = row[i];
                        }
                    }

                    // 儲存（新的會覆蓋舊的，保留最新資料）
                    allData[code] = record;
                }
            }

            db.close();
        } catch (err) {
            console.warn(`載入 ${dbFile} 失敗:`, err);
        }
    }

    window.yuantaHistoryData.data = allData;
    window.yuantaHistoryData.loaded = true;
    window.yuantaHistoryData.loading = false;

    const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
    console.log(`✅ 元大歷史資料載入完成: ${Object.keys(allData).length} 檔CB，耗時 ${elapsed} 秒`);
}

/**
 * 載入kanban資料並渲染圖表
 */
async function loadKanbanAndRender(cbCode, tabName, period, container) {
    try {
        // 檢查是否已載入資料
        if (!window.kanbanData.loaded && !window.kanbanData.loading) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">⏳ 首次載入歷史資料中，請稍候...</div>`;
            await loadAllKanbanData();
        }

        // 等待載入完成
        while (window.kanbanData.loading) {
            await new Promise(r => setTimeout(r, 100));
        }

        // 取得該CB的時間序列資料（同時嘗試字串和數字格式）
        const searchCode = String(cbCode).trim();
        let cbTimeSeries = window.kanbanData.data[searchCode] || [];

        // 如果找不到，嘗試純數字格式（去掉前導零）
        if (cbTimeSeries.length === 0) {
            const numCode = parseInt(searchCode, 10);
            if (!isNaN(numCode)) {
                cbTimeSeries = window.kanbanData.data[String(numCode)] || [];
            }
        }

        // 除錯輸出
        console.log(`[kanban] 查詢 ${searchCode}, 找到 ${cbTimeSeries.length} 筆資料`);

        if (cbTimeSeries.length === 0) {
            // 檢查kanban中是否有該CB（列出前10個key作為參考）
            const keys = Object.keys(window.kanbanData.data).slice(0, 10);
            console.log(`[kanban] 資料庫中前10個CB代號:`, keys);

            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:#999;">
                    <div style="font-size:48px; margin-bottom:15px;">📭</div>
                    <div style="font-size:14px;">找不到 <strong>${cbCode}</strong> 的歷史價格資料</div>
                    <div style="font-size:12px; margin-top:10px; color:#aaa;">
                        可能原因：<br>
                        • 新發行的CB，尚無歷史行情<br>
                        • 已下市較久的CB，不在 CB_kanban Excel 資料中<br>
                        • data/kanban/ 資料夾未放置 CB_kanban_YYYY_all.csv 檔案
                    </div>
                    <div style="margin-top:15px;">
                        <button onclick="showPriceTrendTab('cbas')"
                                style="padding:10px 20px; background:#9c27b0; color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">
                            🎯 查看 CBAS 基本分析
                        </button>
                    </div>
                </div>`;
            return;
        }

        // 依期間篩選資料
        const filteredData = filterDataByPeriod(cbTimeSeries, period);

        // 渲染對應的圖表
        switch(tabName) {
            case 'stockPrice':
                renderStockPriceChart(cbCode, filteredData, container, period);
                break;
            case 'cbPrice':
                renderCBPriceChart(cbCode, filteredData, container, period);
                break;
            case 'balance':
                renderBalanceChart(cbCode, filteredData, container, period);
                break;
            case 'cbas':
                renderCBASChart(cbCode, filteredData, container, period);
                break;
        }

    } catch (err) {
        console.error('載入kanban資料失敗:', err);
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#c62828;">❌ 載入資料失敗: ${err.message}</div>`;
    }
}

/**
 * 載入kanban資料
 * v3.97-zs-br: 改用 SQLite 資料庫，預設只載入最新 3 年
 * @param {boolean} loadAll - 是否載入全部歷史（預設 false，只載入 2023-2025）
 */
async function loadAllKanbanData(loadAll = false) {
    if (window.kanbanData.loaded || window.kanbanData.loading) return;
    window.kanbanData.loading = true;

    // 顯示載入進度
    const container = document.getElementById('priceTrendContent');
    const stockRankingContainer = document.getElementById('stockRankingContent');
    const updateProgress = (msg) => {
        const html = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>${msg}</div>
        </div>`;
        if (container) container.innerHTML = html;
        if (stockRankingContainer) stockRankingContainer.innerHTML = html;
    };

    updateProgress('初始化資料庫引擎...');

    try {
        // 初始化 sql.js
        const SQL = await initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        });

        // 儲存 SQL 引擎供後續使用
        window.kanbanSQL = SQL;

        const allData = window.kanbanData.data || {};
        const allDates = new Set(window.kanbanData.dates || []);

        // v3.97-as-cj: 簡化載入邏輯
        // 預設載入 2023-2025 整個資料庫（不做 WHERE 過濾，資料庫本身已按年份分割）
        // loadAll = true 時才載入更早期資料
        const dbFiles = loadAll ? [
            { file: 'data/cb_kanban_2023_2025.db', label: '2023-2025' },
            { file: 'data/cb_kanban_2020_2022.db', label: '2020-2022' },
            { file: 'data/cb_kanban_2017_2019.db', label: '2017-2019' }
        ] : [
            { file: 'data/cb_kanban_2023_2025.db', label: '2023-2025' }  // 預設只載入這個
        ];

        for (const dbInfo of dbFiles) {
            updateProgress(`載入 ${dbInfo.label} 資料...`);

            try {
                const response = await fetch(dbInfo.file);
                if (!response.ok) {
                    console.warn(`無法載入 ${dbInfo.file}: ${response.status}`);
                    continue;
                }

                const arrayBuffer = await response.arrayBuffer();
                updateProgress(`解析 ${dbInfo.label} 資料...`);
                
                const db = new SQL.Database(new Uint8Array(arrayBuffer));
                
                // v3.97-as-cj: 直接查詢全部資料，不做 WHERE 過濾
                const results = db.exec(`
                    SELECT date, code, name, conv_price, call_start, call_end,
                           call_price, delist_date, balance, cb_price, stock_price
                    FROM kanban ORDER BY code, date
                `);

                if (results.length > 0) {
                    const rows = results[0].values;
                    for (const row of rows) {
                        const [date, code, name, convPrice, callStart, callEnd,
                               callPrice, delistDate, balance, cbPrice, stockPrice] = row;

                        if (!code) continue;

                        if (!allData[code]) {
                            allData[code] = [];
                        }

                        // 轉換為原本的格式
                        const dateNum = parseInt(date) || 0;
                        allData[code].push({
                            date: date,
                            dateNum: dateNum,
                            cbName: name,
                            convPrice: convPrice || 0,
                            callStartDate: callStart || '',
                            callEndDate: callEnd || '',
                            callPrice: callPrice || 0,
                            delistDate: delistDate || '',
                            balance: balance || 0,
                            cbPrice: cbPrice || 0,
                            stockPrice: stockPrice || 0
                        });

                        if (dateNum) allDates.add(dateNum);
                    }
                }

                db.close();

            } catch (e) {
                console.warn(`載入 ${dbInfo.file} 失敗:`, e.message);
            }
        }

        // 對每檔 CB 的時間序列按日期排序
        for (const cbCode in allData) {
            allData[cbCode].sort((a, b) => a.dateNum - b.dateNum);
        }

        window.kanbanData.data = allData;
        window.kanbanData.dates = [...allDates].sort();
        window.kanbanData.loaded = true;
        window.kanbanData.loadedAll = loadAll;

    } catch (err) {
        console.error('載入 kanban 資料失敗:', err);
        if (container) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:#e74c3c;">
                <div style="font-size:24px; margin-bottom:10px;">❌</div>
                <div>載入失敗: ${err.message}</div>
            </div>`;
        }
    } finally {
        window.kanbanData.loading = false;
    }
}

/**
 * v3.97-zs-br: 載入更早期的資料（2017-2022）
 */
async function loadEarlierKanbanData() {
    if (window.kanbanData.loadedAll) return;

    const container = document.getElementById('priceTrendContent');
    if (container) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>載入 2017-2022 歷史資料...</div>
        </div>`;
    }

    try {
        const SQL = window.kanbanSQL;
        if (!SQL) {
            console.error('SQL 引擎未初始化');
            return;
        }

        const allData = window.kanbanData.data;
        const allDates = new Set(window.kanbanData.dates);

        const dbFiles = [
            { file: 'data/cb_kanban_2020_2022.db', label: '2020-2022' },
            { file: 'data/cb_kanban_2017_2019.db', label: '2017-2019' }
        ];

        for (const dbInfo of dbFiles) {
            try {
                const response = await fetch(dbInfo.file);
                if (!response.ok) continue;

                const arrayBuffer = await response.arrayBuffer();
                const db = new SQL.Database(new Uint8Array(arrayBuffer));

                const results = db.exec(`
                    SELECT date, code, name, conv_price, call_start, call_end,
                           call_price, delist_date, balance, cb_price, stock_price
                    FROM kanban ORDER BY code, date
                `);

                if (results.length > 0) {
                    const rows = results[0].values;
                    for (const row of rows) {
                        const [date, code, name, convPrice, callStart, callEnd,
                               callPrice, delistDate, balance, cbPrice, stockPrice] = row;

                        if (!code) continue;
                        if (!allData[code]) allData[code] = [];

                        const dateNum = parseInt(date) || 0;
                        allData[code].push({
                            date, dateNum, cbName: name,
                            convPrice: convPrice || 0,
                            callStartDate: callStart || '',
                            callEndDate: callEnd || '',
                            callPrice: callPrice || 0,
                            delistDate: delistDate || '',
                            balance: balance || 0,
                            cbPrice: cbPrice || 0,
                            stockPrice: stockPrice || 0
                        });

                        if (dateNum) allDates.add(dateNum);
                    }
                }
                db.close();
            } catch (e) {
                console.warn(`載入 ${dbInfo.file} 失敗:`, e.message);
            }
        }

        // 重新排序
        for (const cbCode in allData) {
            allData[cbCode].sort((a, b) => a.dateNum - b.dateNum);
        }

        window.kanbanData.dates = [...allDates].sort();
        window.kanbanData.loadedAll = true;

    } catch (err) {
        console.error('載入歷史資料失敗:', err);
    }
}

/**
 * v3.97-zs-be: 解析 kanban CSV 資料
 * 保留所有 18 個欄位
 */
function parseKanbanCSV(csvText, allData, allDates) {
    const lines = csvText.split('\n');
    if (lines.length < 2) return 0;

    // 解析標題列
    const headers = parseCSVLine(lines[0]);
    const colIndex = {};
    headers.forEach((h, i) => { colIndex[h.trim()] = i; });

    let count = 0;

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const cols = parseCSVLine(line);

        // 取得 CB 代碼
        const cbCodeRaw = cols[colIndex['債券代碼']] || '';
        const cbCode = String(cbCodeRaw).replace(/\.0*$/, '').trim();
        if (!cbCode || !/^\d+$/.test(cbCode)) continue;

        // 取得日期 (YYYYMMDD -> YYYY/MM/DD)
        const dateRaw = cols[colIndex['資料日期']] || '';
        const dateStr = String(dateRaw).length === 8
            ? `${dateRaw.substring(0,4)}/${dateRaw.substring(4,6)}/${dateRaw.substring(6,8)}`
            : dateRaw;
        const dateNum = parseInt(String(dateRaw).replace(/\//g, ''));
        if (!dateNum) continue;

        allDates.add(dateStr);

        // 提取所有欄位數值
        const stockPrice = parseFloat(cols[colIndex['轉換標的股票價格']]) || 0;
        const cbPrice = parseFloat(cols[colIndex['轉債參考價格']]) || 0;
        const convPrice = parseFloat(cols[colIndex['轉換價格']]) || 0;
        const balanceRaw = parseFloat(cols[colIndex['上月底發行餘額']]) || 0;
        const balance = balanceRaw / 100000000; // 轉為億元
        const originalIssue = parseFloat(cols[colIndex['原始發行總額']]) || 0;

        // 日期欄位
        const convStartDate = cols[colIndex['轉換起日']] || '';
        const convEndDate = cols[colIndex['轉換迄日']] || '';
        const nextConvPriceDate = cols[colIndex['下次轉換價格生效日期']] || '';
        const putStartDate = cols[colIndex['最近賣回權起日']] || '';
        const putEndDate = cols[colIndex['最近賣回權迄日']] || '';
        const putPrice = parseFloat(cols[colIndex['最近賣回權價格']]) || 0;
        const callStartDate = cols[colIndex['強制贖回起日']] || '';
        const callEndDate = cols[colIndex['強制贖回迄日']] || '';
        const callPrice = cols[colIndex['強制贖回價格']] || '';
        const delistDate = cols[colIndex['終止櫃檯買賣日']] || '';
        const cbName = cols[colIndex['債券簡稱']] || '';

        // 計算轉換價值和溢價率
        const convValue = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;
        const premium = convValue > 0 && cbPrice > 0 ? ((cbPrice - convValue) / convValue * 100) : 0;

        // 加入時間序列（保留所有欄位）
        if (!allData[cbCode]) allData[cbCode] = [];
        allData[cbCode].push({
            date: dateStr,
            dateNum: dateNum,
            cbName,
            stockPrice,
            cbPrice,
            convPrice,
            convValue,
            premium,
            balance,
            originalIssue,
            convStartDate,
            convEndDate,
            nextConvPriceDate,
            putStartDate,
            putEndDate,
            putPrice,
            callStartDate,
            callEndDate,
            callPrice,
            delistDate
        });

        count++;
    }

    return count;
}

/**
 * v3.97-zs-be: 解析 CSV 行（處理逗號在引號內的情況）
 */
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current.trim());
    return result;
}

/**
 * v3.97-zs-be: 解析 kanban Excel 資料（向下相容）
 */
async function parseKanbanExcel(arrayBuffer, allData, allDates) {
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const validSheets = workbook.SheetNames.filter(name => /^\d{8}$/.test(name));

    let count = 0;

    // Excel 日期序號轉換函數
    const excelDateToStr = (val) => {
        if (val === undefined || val === null || val === '' || val === 0) return '';
        if (typeof val === 'string' && val.includes('/')) return val;
        const num = parseFloat(val);
        if (isNaN(num) || num < 1000) return String(val);
        const date = new Date((num - 25569) * 86400 * 1000);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}/${m}/${d}`;
    };

    for (const sheetName of validSheets) {
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        if (jsonData.length === 0) continue;

        const dateStr = `${sheetName.substring(0,4)}/${sheetName.substring(4,6)}/${sheetName.substring(6,8)}`;
        const dateNum = parseInt(sheetName);
        allDates.add(dateStr);

        for (const row of jsonData) {
            let cbCodeRaw = row['債券代碼'] || row['代碼'] || row['代號'];
            if (!cbCodeRaw) continue;

            const cbCode = String(cbCodeRaw).replace(/\.0*$/, '').trim();
            if (!cbCode || !/^\d+$/.test(cbCode)) continue;

            const stockPrice = parseFloat(row['轉換標的股票價格']) || 0;
            const cbPrice = parseFloat(row['轉債參考價格']) || 0;
            const convPrice = parseFloat(row['轉換價格']) || 0;
            const balanceRaw = parseFloat(row['上月底發行餘額']) || 0;
            const balance = balanceRaw / 100000000;

            const callStartDate = excelDateToStr(row['強制贖回起日']);
            const callEndDate = excelDateToStr(row['強制贖回迄日']);
            const callPrice = row['強制贖回價格'] || '';
            const delistDate = excelDateToStr(row['終止櫃檯買賣日']);

            const convValue = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;
            const premium = convValue > 0 && cbPrice > 0 ? ((cbPrice - convValue) / convValue * 100) : 0;

            if (!allData[cbCode]) allData[cbCode] = [];
            allData[cbCode].push({
                date: dateStr,
                dateNum,
                stockPrice,
                cbPrice,
                convPrice,
                convValue,
                premium,
                balance,
                callStartDate,
                callEndDate,
                callPrice,
                delistDate
            });

            count++;
        }
    }

    return count;
}

/**
 * 依期間篩選資料
 */
function filterDataByPeriod(data, period) {
    if (period === 'all' || !data || data.length === 0) return data;

    // v3.97-as-bv: 改為從資料中最新日期往前推算，而非從今天
    const days = parseInt(period) || 90;

    // 找出資料中的最新日期
    const latestData = data[data.length - 1];
    let latestDateNum = latestData?.dateNum;

    // 如果沒有 dateNum，嘗試從 date 欄位解析
    if (!latestDateNum && latestData?.date) {
        latestDateNum = parseInt(latestData.date.replace(/-/g, '').replace(/\//g, ''));
    }

    if (!latestDateNum) {
        // 如果無法取得最新日期，退回使用今天
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);
        const cutoffNum = parseInt(cutoffDate.toISOString().slice(0, 10).replace(/-/g, ''));
        return data.filter(d => d.dateNum >= cutoffNum);
    }

    // 從最新日期往前推算 cutoff 日期
    const latestStr = String(latestDateNum);
    const latestYear = parseInt(latestStr.substring(0, 4));
    const latestMonth = parseInt(latestStr.substring(4, 6));
    const latestDay = parseInt(latestStr.substring(6, 8));
    const latestDate = new Date(latestYear, latestMonth - 1, latestDay);

    latestDate.setDate(latestDate.getDate() - days);
    const cutoffNum = parseInt(latestDate.toISOString().slice(0, 10).replace(/-/g, ''));

    return data.filter(d => d.dateNum >= cutoffNum);
}

/**
 * v3.97-as-bs: SVG 圖表生成工具函數
 */

// 計算Y軸範圍（自動調整刻度）
function calcYAxisRange(values, padding = 0.05) {
    const validValues = values.filter(v => v != null && !isNaN(v) && v !== 0);
    if (validValues.length === 0) return { min: 0, max: 100, range: 100 };

    let min = Math.min(...validValues);
    let max = Math.max(...validValues);
    const range = max - min || 1;

    min = min - range * padding;
    max = max + range * padding;

    return { min, max, range: max - min };
}

// 生成Y軸刻度
function generateYTicks(min, max, tickCount = 5) {
    const range = max - min;
    const step = range / tickCount;
    const ticks = [];
    for (let i = 0; i <= tickCount; i++) {
        ticks.push(min + step * i);
    }
    return ticks;
}

// 生成SVG路徑
function generateSVGPath(data, xScale, yScale, getValue) {
    let path = '';
    let started = false;

    data.forEach((d, i) => {
        const value = getValue(d);
        if (value == null || isNaN(value) || value === 0) return;

        const x = xScale(i);
        const y = yScale(value);

        if (!started) {
            path = `M ${x.toFixed(1)} ${y.toFixed(1)}`;
            started = true;
        } else {
            path += ` L ${x.toFixed(1)} ${y.toFixed(1)}`;
        }
    });

    return path;
}

// 生成填充區域路徑
function generateFillPath(data, xScale, yScale, getValue, baseY) {
    const linePath = generateSVGPath(data, xScale, yScale, getValue);
    if (!linePath) return '';

    // 找到有效數據的起始和結束點
    let firstX = null, lastX = null;
    data.forEach((d, i) => {
        const value = getValue(d);
        if (value != null && !isNaN(value) && value !== 0) {
            if (firstX === null) firstX = xScale(i);
            lastX = xScale(i);
        }
    });

    if (firstX === null) return '';

    return `${linePath} L ${lastX.toFixed(1)} ${baseY.toFixed(1)} L ${firstX.toFixed(1)} ${baseY.toFixed(1)} Z`;
}

// 生成X軸日期標籤
function generateXLabels(data, count = 5) {
    if (data.length === 0) return [];
    const step = Math.max(1, Math.floor((data.length - 1) / (count - 1)));
    const labels = [];
    for (let i = 0; i < count && i * step < data.length; i++) {
        const idx = Math.min(i * step, data.length - 1);
        labels.push({ idx, label: data[idx].date?.substring(5) || '' });
    }
    // 確保包含最後一個
    if (labels[labels.length - 1]?.idx !== data.length - 1) {
        labels.push({ idx: data.length - 1, label: data[data.length - 1].date?.substring(5) || '' });
    }
    return labels;
}

/**
 * 渲染股價與轉換價走勢圖
 */
function renderStockPriceChart(cbCode, data, container, period) {
    const periodLabel = getPeriodLabel(period);

    // 準備圖表資料
    const labels = data.map(d => d.date);
    const stockPrices = data.map(d => d.stockPrice);
    const convPrices = data.map(d => d.convPrice);

    // 計算統計數據
    const latestData = data[data.length - 1] || {};
    const stockPrice = latestData.stockPrice || 0;
    const convPrice = latestData.convPrice || 0;
    const isInMoney = stockPrice > convPrice;
    const priceDiff = stockPrice - convPrice;
    const priceDiffPct = convPrice > 0 ? (priceDiff / convPrice * 100) : 0;

    // 動態分析判斷
    let statusTag, statusBg, statusColor;
    let analysisTitle, analysisContent, conclusionContent;

    if (isInMoney) {
        // 價內情境
        statusBg = '#e8f5e9';
        statusColor = '#2e7d32';
        analysisTitle = '📈 上漲情境分析（價內＝股票特性）';

        if (priceDiffPct >= 30) {
            statusTag = '✅ 深度價內';
            analysisContent = `
                <div style="margin-bottom:6px;">股價 <span style="color:#2e7d32; font-weight:bold;">${stockPrice.toFixed(2)}</span> 元，
                <span style="color:#d32f2f; font-weight:bold;">大幅超過</span>轉換價 ${convPrice.toFixed(2)} 元達 <span style="color:#d32f2f; font-weight:bold;">${priceDiffPct.toFixed(1)}%</span>。</div>
                <div style="margin-bottom:6px;">可轉債已完全具備<span style="color:#2e7d32; font-weight:bold;">股票特性</span>，價格走勢將與股票高度同步。</div>
            `;
            conclusionContent = `此時可轉債幾乎等同於股票，<span style="color:#d32f2f;">上漲獲利空間大，但下跌風險也相對提高</span>，需留意股價回檔風險。`;
        } else if (priceDiffPct >= 10) {
            statusTag = '✅ 價內';
            analysisContent = `
                <div style="margin-bottom:6px;">股價 <span style="color:#2e7d32; font-weight:bold;">${stockPrice.toFixed(2)}</span> 元，
                超過轉換價 ${convPrice.toFixed(2)} 元約 <span style="color:#2e7d32; font-weight:bold;">${priceDiffPct.toFixed(1)}%</span>。</div>
                <div style="margin-bottom:6px;">可轉債與現股股價將會同步，具有<span style="color:#2e7d32; font-weight:bold;">股票特性</span>，買進交割方式與一般買賣股票一樣T+2全額交割。</div>
            `;
            conclusionContent = `當股價超過轉換價，可轉債將發揮股票特性，<span style="color:#2e7d32;">漲越多獲利越多</span>。`;
        } else {
            statusTag = '⚡ 臨界價內';
            analysisContent = `
                <div style="margin-bottom:6px;">股價 <span style="color:#ff9800; font-weight:bold;">${stockPrice.toFixed(2)}</span> 元，
                僅略高於轉換價 ${convPrice.toFixed(2)} 元約 <span style="color:#ff9800; font-weight:bold;">${priceDiffPct.toFixed(1)}%</span>。</div>
                <div style="margin-bottom:6px;">處於<span style="color:#ff9800; font-weight:bold;">價內外臨界區</span>，股價小幅波動就可能改變價內外狀態。</div>
            `;
            conclusionContent = `建議密切關注股價走勢，若股價持續站穩轉換價之上，可轉債將逐漸發揮股票特性；<span style="color:#ff9800;">若跌破轉換價則轉為債券特性</span>。`;
        }
    } else {
        // 價外情境
        statusBg = '#fff3e0';
        statusColor = '#e65100';
        analysisTitle = '📉 下跌情境分析（價外＝債券特性）';

        const discountPct = Math.abs(priceDiffPct);

        if (discountPct >= 30) {
            statusTag = '⚠️ 深度價外';
            analysisContent = `
                <div style="margin-bottom:6px;">股價 <span style="color:#d32f2f; font-weight:bold;">${stockPrice.toFixed(2)}</span> 元，
                <span style="color:#d32f2f; font-weight:bold;">大幅低於</span>轉換價 ${convPrice.toFixed(2)} 元達 <span style="color:#d32f2f; font-weight:bold;">${discountPct.toFixed(1)}%</span>。</div>
                <div style="margin-bottom:6px;">可轉債已完全具備<span style="color:#e65100; font-weight:bold;">純債券特性</span>，價格走勢與股票脫鉤，主要受利率和信用風險影響。</div>
            `;
            conclusionContent = `除非股價大幅反彈超過 ${discountPct.toFixed(0)}%，否則短期內不具轉換價值。<span style="color:#2e7d32;">但到期還本的保護機制仍在</span>，適合保守型投資人持有至到期。`;
        } else if (discountPct >= 10) {
            statusTag = '⚠️ 價外';
            analysisContent = `
                <div style="margin-bottom:6px;">股價 <span style="color:#e65100; font-weight:bold;">${stockPrice.toFixed(2)}</span> 元，
                低於轉換價 ${convPrice.toFixed(2)} 元約 <span style="color:#e65100; font-weight:bold;">${discountPct.toFixed(1)}%</span>。</div>
                <div style="margin-bottom:6px;">可轉債與現股股價將<span style="color:#e65100; font-weight:bold;">不會同步</span>，具有債券特性，在公司沒有倒閉的前提下，將充分發揮債券到期還本特性。</div>
            `;
            conclusionContent = `無擔保時為第一順位求償人，有擔保時有公司實體資產當做抵押擔保，<span style="color:#2e7d32;">下檔風險有限</span>。`;
        } else {
            statusTag = '⚡ 臨界價外';
            analysisContent = `
                <div style="margin-bottom:6px;">股價 <span style="color:#ff9800; font-weight:bold;">${stockPrice.toFixed(2)}</span> 元，
                僅略低於轉換價 ${convPrice.toFixed(2)} 元約 <span style="color:#ff9800; font-weight:bold;">${discountPct.toFixed(1)}%</span>。</div>
                <div style="margin-bottom:6px;">處於<span style="color:#ff9800; font-weight:bold;">價內外臨界區</span>，股價小幅上漲就可能轉為價內。</div>
            `;
            conclusionContent = `<span style="color:#2e7d32;">具有潛在轉換價值</span>，若看好標的股後市，此時進場可同時享有債券保護和股票上漲潛力。`;
        }
    }

    container.innerHTML = `
        <div style="background:#fff; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-weight:bold; color:#1976d2; font-size:16px;">
                    📈 ${cbCode} 股價與轉換價走勢 <span style="font-size:12px; color:#666; font-weight:normal;">(${periodLabel})</span>
                </div>
                <div style="font-size:12px; padding:4px 10px; border-radius:12px; background:${statusBg}; color:${statusColor};">
                    ${statusTag}
                </div>
            </div>

            <!-- 數據摘要 -->
            <div class="balance-grid-3col" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:15px;">
                <div style="background:#e3f2fd; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">最新股價</div>
                    <div class="balance-number" style="font-size:18px; font-weight:bold; color:#1976d2;">${stockPrice.toFixed(2)}</div>
                </div>
                <div style="background:#fff3e0; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">轉換價</div>
                    <div class="balance-number" style="font-size:18px; font-weight:bold; color:#e65100;">${convPrice.toFixed(2)}</div>
                </div>
                <div style="background:${isInMoney ? '#e8f5e9' : '#ffebee'}; padding:12px; border-radius:6px; text-align:center;">
                    <div style="font-size:11px; color:#666;">價差</div>
                    <div class="balance-number" style="font-size:18px; font-weight:bold; color:${isInMoney ? '#2e7d32' : '#d32f2f'};">${priceDiff >= 0 ? '+' : ''}${priceDiff.toFixed(2)}</div>
                </div>
            </div>

            <!-- 圖表區域 - SVG版本 -->
            <div id="stockPriceChartSVG" style="width:100%; min-height:350px;"></div>

            <!-- 動態情境分析說明 -->
            <div style="margin-top:15px; padding:12px; background:${statusBg}; border-radius:8px; border-left:4px solid ${statusColor};">
                <div style="font-weight:bold; color:#333; margin-bottom:8px; font-size:13px;">
                    ${analysisTitle}
                </div>
                <div style="font-size:12px; color:#555; line-height:1.6;">
                    ${analysisContent}
                    <div style="background:#fff; padding:8px; border-radius:4px; margin:8px 0;">
                        <span style="font-weight:bold;">結論：</span>${conclusionContent}
                    </div>
                </div>
            </div>
        </div>
    `;

    // v3.97-as-bs: 使用 SVG 繪製圖表
    renderStockPriceChartSVG(data, stockPrices, convPrices, labels);
}

/**
 * v3.97-as-bt: SVG 版股價與轉換價走勢圖（手機版優化）
 */
function renderStockPriceChartSVG(data, stockPrices, convPrices, labels) {
    const container = document.getElementById('stockPriceChartSVG');
    if (!container) return;

    // v3.97-as-bt: 加大尺寸，移除 max-width 限制
    const width = 600;
    const height = 380;
    const padding = { top: 45, right: 55, bottom: 50, left: 60 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // 計算Y軸範圍（合併股價和轉換價）
    const allValues = [...stockPrices, ...convPrices].filter(v => v > 0);
    const { min: minY, max: maxY, range: yRange } = calcYAxisRange(allValues, 0.08);

    // 縮放函數
    const xScale = (i) => padding.left + (i / Math.max(data.length - 1, 1)) * chartWidth;
    const yScale = (v) => padding.top + chartHeight - ((v - minY) / yRange) * chartHeight;

    // 生成路徑
    const stockPath = generateSVGPath(data, xScale, yScale, (d, i) => stockPrices[data.indexOf(d)] || stockPrices[i]);
    const convPath = generateSVGPath(data, xScale, yScale, (d, i) => convPrices[data.indexOf(d)] || convPrices[i]);

    // 生成股價填充區域
    let stockFillPath = '';
    if (stockPath) {
        const baseY = padding.top + chartHeight;
        let firstX = null, lastX = null;
        data.forEach((d, i) => {
            const value = stockPrices[i];
            if (value > 0) {
                if (firstX === null) firstX = xScale(i);
                lastX = xScale(i);
            }
        });
        if (firstX !== null) {
            stockFillPath = `${stockPath} L ${lastX.toFixed(1)} ${baseY.toFixed(1)} L ${firstX.toFixed(1)} ${baseY.toFixed(1)} Z`;
        }
    }

    // Y軸刻度 - 加大字體
    const yTicks = generateYTicks(minY, maxY, 5);
    let yTicksHTML = yTicks.map(tick => {
        const y = yScale(tick);
        return `
            <line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e0e0e0" stroke-width="1"/>
            <text x="${padding.left - 10}" y="${y + 5}" text-anchor="end" font-size="13" fill="#666" font-weight="500">${tick.toFixed(1)}</text>
        `;
    }).join('');

    // X軸標籤 - 加大字體
    const xLabels = generateXLabels(data, 5);
    let xLabelsHTML = xLabels.map(({ idx, label }) => {
        const x = xScale(idx);
        return `<text x="${x}" y="${height - 12}" text-anchor="middle" font-size="12" fill="#666">${label}</text>`;
    }).join('');

    container.innerHTML = `
        <svg width="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="display:block; margin:0 auto;">
            <!-- 背景 -->
            <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="#fafafa" rx="4"/>

            <!-- Y軸刻度線和標籤 -->
            ${yTicksHTML}

            <!-- 股價填充區域 -->
            <path d="${stockFillPath}" fill="rgba(25, 118, 210, 0.15)"/>

            <!-- 股價線 -->
            <path d="${stockPath}" fill="none" stroke="#1976d2" stroke-width="2.5"/>

            <!-- 轉換價線（虛線）-->
            <path d="${convPath}" fill="none" stroke="#e65100" stroke-width="2.5" stroke-dasharray="8,4"/>

            <!-- 圖例 -->
            <g transform="translate(${padding.left + 10}, ${padding.top - 18})">
                <line x1="0" y1="0" x2="25" y2="0" stroke="#1976d2" stroke-width="3"/>
                <text x="30" y="5" font-size="14" fill="#1976d2" font-weight="600">股價</text>
                <line x1="80" y1="0" x2="105" y2="0" stroke="#e65100" stroke-width="3" stroke-dasharray="8,4"/>
                <text x="110" y="5" font-size="14" fill="#e65100" font-weight="600">轉換價</text>
            </g>

            <!-- X軸標籤 -->
            ${xLabelsHTML}

            <!-- Y軸標題 -->
            <text x="${padding.left - 45}" y="${height/2}" text-anchor="middle" font-size="13" fill="#666" font-weight="500" transform="rotate(-90, ${padding.left - 45}, ${height/2})">價格(元)</text>

            <!-- 邊框 -->
            <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="none" stroke="#ccc" stroke-width="1" rx="4"/>
        </svg>
    `;
}

/**
 * 渲染理論價值分析圖（CB價格 vs 理論價格 + 折溢價比率）
 */
function renderCBPriceChart(cbCode, data, container, period) {
    const periodLabel = getPeriodLabel(period);

    const labels = data.map(d => d.date);
    const cbPrices = data.map(d => d.cbPrice);
    const convValues = data.map(d => d.convValue);  // 理論價格（轉換價值）
    const premiums = data.map(d => d.premium);

    const latestData = data[data.length - 1] || {};
    const cbPrice = latestData.cbPrice || 0;
    const convValue = latestData.convValue || 0;
    const premium = latestData.premium || 0;
    const hasConvValue = convValue > 100;
    const stockPrice = latestData.stockPrice || 0;
    const convPrice = latestData.convPrice || 0;

    // 動態分析判斷
    let statusTag, statusBg, statusColor;
    let analysisContent, conclusionContent, educationTip;

    // 計算理論價值（轉換價值）
    const theoryValue = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;
    // 計算股價距離轉換價的差距
    const priceDiffPct = convPrice > 0 ? ((stockPrice - convPrice) / convPrice * 100) : 0;

    if (hasConvValue) {
        // 有轉換價值
        if (premium <= 5) {
            statusTag = '🔥 低溢價（高轉換價值）';
            statusBg = '#e8f5e9';
            statusColor = '#2e7d32';
            analysisContent = `
                <div style="margin-bottom:6px;">理論價值 <span style="color:#2e7d32; font-weight:bold;">${convValue.toFixed(2)}</span> 元，CB收盤價 <span style="color:#7b1fa2; font-weight:bold;">${cbPrice.toFixed(2)}</span> 元，
                溢價僅 <span style="color:#2e7d32; font-weight:bold;">${premium.toFixed(2)}%</span>。</div>
                <div style="margin-bottom:6px;">可轉債價格<span style="color:#2e7d32; font-weight:bold;">非常接近理論價值</span>，幾乎等同於持有股票，上漲時將與股價同步獲利。</div>
            `;
            conclusionContent = `低溢價代表<span style="color:#2e7d32;">買進成本接近股票</span>，但仍保有債券的到期保護，是較理想的進場時機。`;
            educationTip = `💡 低溢價時CB與股票連動性最高，股價漲跌會直接反映在CB價格上。`;
        } else if (premium <= 15) {
            statusTag = '✅ 合理溢價';
            statusBg = '#e3f2fd';
            statusColor = '#1976d2';
            analysisContent = `
                <div style="margin-bottom:6px;">理論價值 <span style="color:#2e7d32; font-weight:bold;">${convValue.toFixed(2)}</span> 元，CB收盤價 <span style="color:#7b1fa2; font-weight:bold;">${cbPrice.toFixed(2)}</span> 元，
                溢價 <span style="color:#1976d2; font-weight:bold;">${premium.toFixed(2)}%</span>。</div>
                <div style="margin-bottom:6px;">溢價率處於<span style="color:#1976d2; font-weight:bold;">合理區間</span>，反映了市場對標的股票有一定的上漲預期。</div>
            `;
            conclusionContent = `合理溢價代表市場看好但不過熱，<span style="color:#1976d2;">具有參與股價上漲的空間</span>，同時保有債券保護。`;
            educationTip = `💡 溢價是指買CB要貴多少%，越看好標的未來的爆發性，越能接受越高的溢價率。`;
        } else if (premium <= 30) {
            statusTag = '⚠️ 偏高溢價';
            statusBg = '#fff3e0';
            statusColor = '#e65100';
            analysisContent = `
                <div style="margin-bottom:6px;">理論價值 <span style="color:#2e7d32; font-weight:bold;">${convValue.toFixed(2)}</span> 元，CB收盤價 <span style="color:#7b1fa2; font-weight:bold;">${cbPrice.toFixed(2)}</span> 元，
                溢價達 <span style="color:#e65100; font-weight:bold;">${premium.toFixed(2)}%</span>。</div>
                <div style="margin-bottom:6px;">溢價率<span style="color:#e65100; font-weight:bold;">偏高</span>，市場對此標的有較高的上漲預期，買進需股價上漲 ${premium.toFixed(0)}% 以上才能回本。</div>
            `;
            conclusionContent = `偏高溢價代表<span style="color:#e65100;">需要較大的股價漲幅才能獲利</span>，建議評估標的基本面是否支持這樣的預期。`;
            educationTip = `💡 溢價偏高時，即使股價上漲，CB可能因「溢價收斂」而漲幅落後股票。`;
        } else {
            statusTag = '🔴 過高溢價';
            statusBg = '#ffebee';
            statusColor = '#d32f2f';
            analysisContent = `
                <div style="margin-bottom:6px;">理論價值 <span style="color:#2e7d32; font-weight:bold;">${convValue.toFixed(2)}</span> 元，CB收盤價 <span style="color:#7b1fa2; font-weight:bold;">${cbPrice.toFixed(2)}</span> 元，
                溢價高達 <span style="color:#d32f2f; font-weight:bold;">${premium.toFixed(2)}%</span>。</div>
                <div style="margin-bottom:6px;">溢價率<span style="color:#d32f2f; font-weight:bold;">過高</span>，即使股價上漲，可轉債價格也可能因溢價收斂而表現不佳。</div>
            `;
            conclusionContent = `過高溢價風險較大，<span style="color:#d32f2f;">股價需大漲超過 ${premium.toFixed(0)}% 才能真正獲利</span>，建議謹慎評估或等待溢價收斂。`;
            educationTip = `💡 過高溢價通常出現在熱門題材股，需留意溢價收斂風險。`;
        }
    } else {
        // 沒有轉換價值（價外）
        if (cbPrice <= 100) {
            statusTag = '💎 折價（低於面額）';
            statusBg = '#e8f5e9';
            statusColor = '#2e7d32';
            const discount = 100 - cbPrice;
            analysisContent = `
                <div style="margin-bottom:6px;">CB收盤價 <span style="color:#2e7d32; font-weight:bold;">${cbPrice.toFixed(2)}</span> 元，<span style="color:#2e7d32; font-weight:bold;">低於面額100元</span>，折價 ${discount.toFixed(2)} 元。</div>
                <div style="margin-bottom:6px;">目前<span style="color:#2e7d32; font-weight:bold;">沒有轉換價值</span>，但買進價格低於面額，若公司不倒，持有至到期可賺取價差。</div>
                <div style="margin-bottom:6px;">📌 <span style="color:#1565c0; font-weight:bold;">賣回操作機會：</span>若有投資人提前賣回日，可考慮買進後於賣回日以100元賣回給公司，賺取約 ${discount.toFixed(2)} 元價差。</div>
            `;
            conclusionContent = `折價買進代表<span style="color:#2e7d32;">到期保本有額外收益</span>，同時保有股價上漲時的轉換機會，是低風險的操作策略。`;
            educationTip = `💡 折價CB適合保守型投資人，需留意公司信用風險及流動性。評等差或無擔保的標的，券商可能不接受拆解成選擇權。`;
        } else if (cbPrice <= 105) {
            statusTag = '⚡ 小幅溢價（近面額）';
            statusBg = '#fff3e0';
            statusColor = '#ff9800';
            analysisContent = `
                <div style="margin-bottom:6px;">CB收盤價 <span style="color:#ff9800; font-weight:bold;">${cbPrice.toFixed(2)}</span> 元，目前<span style="color:#e65100; font-weight:bold;">沒有轉換價值</span>。</div>
                <div style="margin-bottom:6px;">價格略高於面額，溢價部分 ${(cbPrice - 100).toFixed(2)} 元可視為<span style="color:#ff9800; font-weight:bold;">購買股價上漲選擇權的權利金</span>。</div>
            `;
            conclusionContent = `小幅溢價是合理的，<span style="color:#ff9800;">最多損失約 ${((cbPrice - 100) * 1000).toLocaleString()} 元/張</span>，換取未來股價上漲的參與權。`;
            educationTip = `💡 價外CB具有「抗跌性」，跌到一定程度後就不太會再跌，但相對的也會「抗漲」，要等股價回到轉換價附近才會與股票同步。`;
        } else {
            statusTag = '⚠️ 無轉換價值但溢價';
            statusBg = '#ffebee';
            statusColor = '#d32f2f';
            const premiumAmount = (cbPrice - 100) * 1000;
            analysisContent = `
                <div style="margin-bottom:6px;">CB收盤價 <span style="color:#d32f2f; font-weight:bold;">${cbPrice.toFixed(2)}</span> 元，目前<span style="color:#d32f2f; font-weight:bold;">沒有轉換價值</span>，但價格高於面額 ${(cbPrice - 100).toFixed(2)} 元。</div>
                <div style="margin-bottom:6px;">當股價大幅低於轉換價時，溢價會很嚴重，這是因為CB的<span style="color:#d32f2f; font-weight:bold;">抗跌保本性</span>讓它跌到一定程度後就不太會再跌，而股票可能還在持續下跌。</div>
                <div style="margin-bottom:6px;">⚠️ 此時CB與股票會<span style="color:#d32f2f; font-weight:bold;">失去連動性</span>：先「抗跌」，抗跌之後是「抗漲」（漲不動），要等股價回到轉換價附近，CB才會與股票同步。</div>
            `;
            conclusionContent = `<span style="color:#d32f2f;">高溢價無轉換價值</span>代表股價已大幅偏離轉換價，除非看好標的股能大幅反彈，否則建議謹慎評估。`;
            educationTip = `💡 評等差、無擔保或跌太多的標的，券商會考量風險，可能不能拆解成選擇權。`;
        }
    }

    container.innerHTML = `
        <div style="background:#fff; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-weight:bold; color:#7b1fa2; font-size:16px;">
                    💹 ${cbCode} 理論價值分析 <span style="font-size:12px; color:#666; font-weight:normal;">(${periodLabel})</span>
                </div>
                <div style="font-size:12px; padding:4px 10px; border-radius:12px; background:${statusBg}; color:${statusColor};">
                    ${statusTag}
                </div>
            </div>

            <!-- 數據摘要 -->
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:15px;">
                <div style="background:#e8f5e9; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">理論價值</div>
                    <div style="font-size:16px; font-weight:bold; color:#2e7d32;">${hasConvValue ? convValue.toFixed(2) : '-'}</div>
                </div>
                <div style="background:#f3e5f5; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">CB收盤價</div>
                    <div style="font-size:16px; font-weight:bold; color:#7b1fa2;">${cbPrice.toFixed(2)}</div>
                </div>
                <div style="background:#fff3e0; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">溢價率</div>
                    <div style="font-size:16px; font-weight:bold; color:#e65100;">${premium.toFixed(2)}%</div>
                </div>
                <div style="background:#e3f2fd; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">理論價值</div>
                    <div style="font-size:16px; font-weight:bold; color:#1976d2;">${theoryValue > 0 ? theoryValue.toFixed(2) : '-'}</div>
                </div>
            </div>

            <!-- 圖表區域 - SVG版本 -->
            <div id="cbPriceChartSVG" style="width:100%; min-height:380px;"></div>

            <!-- 動態理論價值分析說明 -->
            <div style="margin-top:15px; padding:12px; background:${statusBg}; border-radius:8px; border-left:4px solid ${statusColor};">
                <div style="font-weight:bold; color:#333; margin-bottom:8px; font-size:13px;">
                    📊 價值分析判斷
                </div>
                <div style="font-size:12px; color:#555; line-height:1.6;">
                    ${analysisContent}
                    <div style="background:#fff; padding:8px; border-radius:4px; margin:8px 0;">
                        <span style="font-weight:bold;">結論：</span>${conclusionContent}
                    </div>
                </div>
            </div>

            <!-- 教育小提示 -->
            <div style="margin-top:10px; padding:10px; background:#f5f5f5; border-radius:8px; font-size:11px; color:#666; line-height:1.5;">
                ${educationTip}
            </div>
        </div>
    `;

    // v3.97-as-bs: 使用 SVG 繪製圖表
    renderCBPriceChartSVG(data, cbPrices, convValues, premiums, labels);
}

/**
 * v3.97-as-bt: SVG 版理論價值分析圖（雙Y軸混合圖，手機版優化）
 */
function renderCBPriceChartSVG(data, cbPrices, convValues, premiums, labels) {
    const container = document.getElementById('cbPriceChartSVG');
    if (!container) return;

    // v3.97-as-bt: 加大尺寸
    const width = 600;
    const height = 400;
    const padding = { top: 50, right: 65, bottom: 50, left: 60 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // 左Y軸：價格範圍
    const priceValues = [...cbPrices, ...convValues].filter(v => v > 0);
    const { min: minPrice, max: maxPrice, range: priceRange } = calcYAxisRange(priceValues, 0.08);

    // 右Y軸：折溢價率範圍
    const premiumValues = premiums.filter(v => v != null && !isNaN(v));
    let minPremium = Math.min(...premiumValues, 0);
    let maxPremium = Math.max(...premiumValues, 0);
    const premiumPadding = (maxPremium - minPremium) * 0.1 || 5;
    minPremium -= premiumPadding;
    maxPremium += premiumPadding;
    const premiumRange = maxPremium - minPremium || 1;

    // 縮放函數
    const xScale = (i) => padding.left + (i / Math.max(data.length - 1, 1)) * chartWidth;
    const yPriceScale = (v) => padding.top + chartHeight - ((v - minPrice) / priceRange) * chartHeight;
    const yPremiumScale = (v) => padding.top + chartHeight - ((v - minPremium) / premiumRange) * chartHeight;

    // 柱狀圖 - 加粗
    const barWidth = Math.max(3, Math.min(12, chartWidth / data.length * 0.7));
    let barsHTML = '';
    data.forEach((d, i) => {
        const p = premiums[i];
        if (p == null || isNaN(p)) return;

        const x = xScale(i) - barWidth / 2;
        const zeroY = yPremiumScale(0);
        const valueY = yPremiumScale(p);
        const barHeight = Math.abs(valueY - zeroY);
        const barY = p >= 0 ? valueY : zeroY;
        const fillColor = p >= 0 ? 'rgba(255, 152, 0, 0.5)' : 'rgba(76, 175, 80, 0.5)';
        const strokeColor = p >= 0 ? '#ff9800' : '#4caf50';

        barsHTML += `<rect x="${x.toFixed(1)}" y="${barY.toFixed(1)}" width="${barWidth}" height="${barHeight.toFixed(1)}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="1"/>`;
    });

    // 生成線條路徑
    const cbPath = generateSVGPath(data, xScale, yPriceScale, (d, i) => cbPrices[data.indexOf(d)] || cbPrices[i]);
    const convPath = generateSVGPath(data, xScale, yPriceScale, (d, i) => convValues[data.indexOf(d)] || convValues[i]);

    // 左Y軸刻度（價格）- 加大字體
    const yPriceTicks = generateYTicks(minPrice, maxPrice, 5);
    let yPriceTicksHTML = yPriceTicks.map(tick => {
        const y = yPriceScale(tick);
        return `
            <line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e0e0e0" stroke-width="1"/>
            <text x="${padding.left - 10}" y="${y + 5}" text-anchor="end" font-size="13" fill="#666" font-weight="500">${tick.toFixed(1)}</text>
        `;
    }).join('');

    // 右Y軸刻度（折溢價率）- 加大字體
    const yPremiumTicks = generateYTicks(minPremium, maxPremium, 5);
    let yPremiumTicksHTML = yPremiumTicks.map(tick => {
        const y = yPremiumScale(tick);
        return `<text x="${width - padding.right + 10}" y="${y + 5}" text-anchor="start" font-size="13" fill="#666" font-weight="500">${tick.toFixed(1)}%</text>`;
    }).join('');

    // X軸標籤 - 加大字體
    const xLabels = generateXLabels(data, 5);
    let xLabelsHTML = xLabels.map(({ idx, label }) => {
        const x = xScale(idx);
        return `<text x="${x}" y="${height - 12}" text-anchor="middle" font-size="12" fill="#666">${label}</text>`;
    }).join('');

    container.innerHTML = `
        <svg width="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="display:block; margin:0 auto;">
            <!-- 背景 -->
            <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="#fafafa" rx="4"/>

            <!-- Y軸刻度線和標籤 -->
            ${yPriceTicksHTML}
            ${yPremiumTicksHTML}

            <!-- 折溢價柱狀圖 -->
            ${barsHTML}

            <!-- CB價格線 -->
            <path d="${cbPath}" fill="none" stroke="#7b1fa2" stroke-width="2.5"/>

            <!-- 理論價格線（虛線）-->
            <path d="${convPath}" fill="none" stroke="#2e7d32" stroke-width="2.5" stroke-dasharray="8,4"/>

            <!-- 圖例 -->
            <g transform="translate(${padding.left + 5}, ${padding.top - 20})">
                <line x1="0" y1="0" x2="22" y2="0" stroke="#7b1fa2" stroke-width="3"/>
                <text x="27" y="5" font-size="13" fill="#7b1fa2" font-weight="600">CB價格</text>
                <line x1="95" y1="0" x2="117" y2="0" stroke="#2e7d32" stroke-width="3" stroke-dasharray="8,4"/>
                <text x="122" y="5" font-size="13" fill="#2e7d32" font-weight="600">理論價格</text>
                <rect x="200" y="-6" width="14" height="12" fill="rgba(255, 152, 0, 0.5)" stroke="#ff9800" stroke-width="1"/>
                <text x="220" y="5" font-size="13" fill="#ff9800" font-weight="600">折溢價%</text>
            </g>

            <!-- X軸標籤 -->
            ${xLabelsHTML}

            <!-- Y軸標題 -->
            <text x="${padding.left - 45}" y="${height/2}" text-anchor="middle" font-size="13" fill="#7b1fa2" font-weight="500" transform="rotate(-90, ${padding.left - 45}, ${height/2})">價格(元)</text>
            <text x="${width - padding.right + 50}" y="${height/2}" text-anchor="middle" font-size="13" fill="#ff9800" font-weight="500" transform="rotate(90, ${width - padding.right + 50}, ${height/2})">折溢價率</text>

            <!-- 邊框 -->
            <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="none" stroke="#ccc" stroke-width="1" rx="4"/>
        </svg>
    `;
}

/**
 * 渲染籌碼轉換分析圖（CB張數、約當股票張數、佔股本比）
 */
function renderBalanceChart(cbCode, data, container, period) {
    const periodLabel = getPeriodLabel(period);

    const labels = data.map(d => d.date);
    const latestData = data[data.length - 1] || {};
    const firstData = data[0] || {};

    // 取得轉換價格
    const convPrice = latestData.convPrice || 0;

    // 取得股本資料（優先從 cbSupplementMap 查詢，再從 sheet01Data 查詢）
    let stockCapital = 0; // 股本（億）

    // 方法1: 從 cbSupplementMap 查詢（在 loadStatistics 中已建立）
    if (window.cbSupplementMap && window.cbSupplementMap[cbCode]) {
        stockCapital = window.cbSupplementMap[cbCode].capital || 0;
    }

    // 方法2: 如果沒有，從 sheet01Data 查詢
    if (stockCapital <= 0 && window.sheet01Data && window.sheet01Data.length > 0) {
        const cbInfo = window.sheet01Data.find(row => {
            const code = String(row['CB代號'] || row['代號'] || '').replace('.0', '').trim();
            return code === cbCode;
        });
        if (cbInfo) {
            // N欄可能的欄位名稱
            stockCapital = parseFloat(cbInfo['股本大小'] || cbInfo['股本'] || cbInfo['股本(億)'] || cbInfo['股本(億元)'] || 0);
        }
    }

    console.log(`📊 ${cbCode} 股本資料: ${stockCapital} 億`);

    // 計算張數資料（每張CB面額10萬元）
    // CB張數 = 餘額(億) × 1億 / 10萬 = 餘額(億) × 1000
    // 約當股票張數 = CB張數 × (10萬/轉換價) / 1000 = 餘額(億) × 1000 × 100000 / 轉換價 / 1000 = 餘額 × 100000 / 轉換價
    const cbShares = data.map(d => d.balance * 1000); // CB張數
    const stockShares = data.map(d => convPrice > 0 ? d.balance * 100000 / convPrice : 0); // 約當股票張數

    const latestCBShares = latestData.balance ? latestData.balance * 1000 : 0;
    const latestStockShares = convPrice > 0 ? latestData.balance * 100000 / convPrice : 0;
    const originalCBShares = latestData.originalBalance ? latestData.originalBalance * 1000 : 0;
    const originalStockShares = convPrice > 0 ? latestData.originalBalance * 100000 / convPrice : 0;

    // 已轉換張數
    const convertedCBShares = originalCBShares - latestCBShares;
    const convertedStockShares = originalStockShares - latestStockShares;

    // 佔股本比（股本以億元為單位，股票面額10元，1億元=1000萬股=1萬張）
    const stockCapitalShares = stockCapital * 10000; // 股本張數
    const stockCapitalPct = stockCapitalShares > 0 ? (latestStockShares / stockCapitalShares * 100) : 0;

    // 轉換比率（每張CB可換幾股）
    const convRatio = convPrice > 0 ? (100000 / convPrice) : 0;

    // 計算CBAS權利金（簡化計算：溢價部分就是權利金概念）
    const cbPrice = latestData.cbPrice || 100;
    const premium = latestData.premium || 0;
    const premiumCost = cbPrice > 100 ? (cbPrice - 100) * 1000 : 0; // 溢價部分的成本
    const totalCost = cbPrice * 1000; // 總成本
    const remainRatio = latestData.remainRatio || 100;
    const convertedPct = 100 - remainRatio;

    // 動態分析判斷
    let statusTag, statusBg, statusColor;
    let analysisContent, conclusionContent;

    // 根據已轉換比例判斷
    if (convertedPct >= 50) {
        statusTag = '🔥 大量轉換';
        statusBg = '#ffebee';
        statusColor = '#d32f2f';
        analysisContent = `
            <div style="margin-bottom:6px;">已有 <span style="color:#d32f2f; font-weight:bold;">${convertedPct.toFixed(1)}%</span> 的可轉債已被轉換成股票，
            流通餘額僅剩 <span style="color:#d32f2f; font-weight:bold;">${latestCBShares.toLocaleString()}</span> 張。</div>
            <div style="margin-bottom:6px;"><span style="color:#d32f2f; font-weight:bold;">大量轉換</span>代表持有人看好股價而選擇轉換，
            但也意味著市場上流通的CB數量減少，<span style="color:#d32f2f;">流動性可能降低</span>。</div>
        `;
        conclusionContent = `大量轉換後CB籌碼稀少，<span style="color:#d32f2f;">買賣價差可能擴大</span>，交易時需留意流動性風險。`;
    } else if (convertedPct >= 20) {
        statusTag = '⚡ 部分轉換';
        statusBg = '#fff3e0';
        statusColor = '#ff9800';
        analysisContent = `
            <div style="margin-bottom:6px;">已有 <span style="color:#ff9800; font-weight:bold;">${convertedPct.toFixed(1)}%</span> 的可轉債已被轉換成股票，
            流通餘額 <span style="color:#ff9800; font-weight:bold;">${latestCBShares.toLocaleString()}</span> 張。</div>
            <div style="margin-bottom:6px;">部分持有人已選擇轉換，代表過去曾有<span style="color:#ff9800; font-weight:bold;">股價高於轉換價</span>的時機。</div>
        `;
        conclusionContent = `部分轉換顯示標的股有上漲潛力，<span style="color:#ff9800;">CB流動性仍屬正常</span>。`;
    } else if (convertedPct >= 5) {
        statusTag = '✅ 少量轉換';
        statusBg = '#e8f5e9';
        statusColor = '#2e7d32';
        analysisContent = `
            <div style="margin-bottom:6px;">僅有 <span style="color:#2e7d32; font-weight:bold;">${convertedPct.toFixed(1)}%</span> 的可轉債被轉換，
            流通餘額 <span style="color:#2e7d32; font-weight:bold;">${latestCBShares.toLocaleString()}</span> 張，籌碼充足。</div>
            <div style="margin-bottom:6px;">大部分持有人選擇<span style="color:#2e7d32; font-weight:bold;">持有CB而非轉換</span>，可能因為股價尚未大幅超越轉換價。</div>
        `;
        conclusionContent = `籌碼充足，<span style="color:#2e7d32;">流動性佳</span>，適合進出交易。`;
    } else {
        statusTag = '💎 幾乎未轉換';
        statusBg = '#e3f2fd';
        statusColor = '#1976d2';
        analysisContent = `
            <div style="margin-bottom:6px;">轉換比例僅 <span style="color:#1976d2; font-weight:bold;">${convertedPct.toFixed(1)}%</span>，
            流通餘額 <span style="color:#1976d2; font-weight:bold;">${latestCBShares.toLocaleString()}</span> 張，<span style="color:#1976d2; font-weight:bold;">籌碼非常充足</span>。</div>
            <div style="margin-bottom:6px;">幾乎沒有人轉換，可能因為：(1)股價低於轉換價、(2)CB剛發行不久、(3)持有人看好未來更大漲幅。</div>
        `;
        conclusionContent = `<span style="color:#1976d2;">籌碼最充足的狀態</span>，流動性最佳，買賣價差通常較小。`;
    }

    // 佔股本比分析
    let capitalAnalysis = '';
    if (stockCapital > 0) {
        if (stockCapitalPct >= 10) {
            capitalAnalysis = `<div style="margin-top:6px; padding:6px; background:#ffebee; border-radius:4px;">
                ⚠️ 約當股票佔股本 <span style="color:#d32f2f; font-weight:bold;">${stockCapitalPct.toFixed(2)}%</span>，
                若全數轉換將<span style="color:#d32f2f;">稀釋股本較多</span>，可能對股價有壓力。
            </div>`;
        } else if (stockCapitalPct >= 5) {
            capitalAnalysis = `<div style="margin-top:6px; padding:6px; background:#fff3e0; border-radius:4px;">
                📊 約當股票佔股本 <span style="color:#ff9800; font-weight:bold;">${stockCapitalPct.toFixed(2)}%</span>，
                轉換後對股本稀釋<span style="color:#ff9800;">影響適中</span>。
            </div>`;
        } else {
            capitalAnalysis = `<div style="margin-top:6px; padding:6px; background:#e8f5e9; border-radius:4px;">
                ✅ 約當股票佔股本僅 <span style="color:#2e7d32; font-weight:bold;">${stockCapitalPct.toFixed(2)}%</span>，
                轉換後對股本稀釋<span style="color:#2e7d32;">影響很小</span>。
            </div>`;
        }
    }

    container.innerHTML = `
        <div style="background:#fff; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-weight:bold; color:#2e7d32; font-size:16px;">
                    📊 ${cbCode} 籌碼轉換分析 <span style="font-size:12px; color:#666; font-weight:normal;">(${periodLabel})</span>
                </div>
                <div style="font-size:12px; padding:4px 10px; border-radius:12px; background:${statusBg}; color:${statusColor};">
                    ${statusTag}
                </div>
            </div>

            <!-- 數據摘要 -->
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:15px;">
                <div style="background:#e3f2fd; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">剩餘CB張數</div>
                    <div style="font-size:16px; font-weight:bold; color:#1976d2;">${latestCBShares.toLocaleString()}</div>
                    <div style="font-size:9px; color:#999;">張</div>
                </div>
                <div style="background:#e8f5e9; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">約當股票</div>
                    <div style="font-size:16px; font-weight:bold; color:#2e7d32;">${latestStockShares.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    <div style="font-size:9px; color:#999;">張</div>
                </div>
                <div style="background:#fff3e0; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">已轉換</div>
                    <div style="font-size:16px; font-weight:bold; color:#e65100;">${convertedPct.toFixed(1)}%</div>
                    <div style="font-size:9px; color:#999;">${convertedStockShares.toLocaleString(undefined, {maximumFractionDigits: 0})}張</div>
                </div>
                <div style="background:#f3e5f5; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">佔股本比</div>
                    <div style="font-size:16px; font-weight:bold; color:#7b1fa2;">${stockCapitalPct.toFixed(2)}%</div>
                    <div style="font-size:9px; color:#999;">${stockCapital > 0 ? '股本' + stockCapital.toFixed(1) + '億' : '無資料'}</div>
                </div>
            </div>

            <!-- 圖表區域 - SVG版本 -->
            <div id="balanceChartSVG" style="width:100%; min-height:350px;"></div>

            <!-- 動態籌碼分析說明 -->
            <div style="margin-top:15px; padding:12px; background:${statusBg}; border-radius:8px; border-left:4px solid ${statusColor};">
                <div style="font-weight:bold; color:#333; margin-bottom:8px; font-size:13px;">
                    🎯 籌碼轉換分析
                </div>
                <div style="font-size:12px; color:#555; line-height:1.6;">
                    ${analysisContent}
                    ${capitalAnalysis}
                    <div style="background:#fff; padding:8px; border-radius:4px; margin:8px 0;">
                        <span style="font-weight:bold;">結論：</span>${conclusionContent}
                    </div>
                </div>
            </div>
        </div>
    `;

    // v3.97-as-bs: 使用 SVG 繪製圖表
    renderBalanceChartSVG(data, cbShares, stockShares, labels);
}

/**
 * v3.97-as-bt: SVG 版籌碼轉換分析圖（雙Y軸，手機版優化）
 */
function renderBalanceChartSVG(data, cbShares, stockShares, labels) {
    const container = document.getElementById('balanceChartSVG');
    if (!container) return;

    // v3.97-as-bt: 加大尺寸
    const width = 600;
    const height = 360;
    const padding = { top: 45, right: 75, bottom: 50, left: 70 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // 左Y軸：CB張數範圍
    const cbValues = cbShares.filter(v => v > 0);
    const { min: minCB, max: maxCB, range: cbRange } = calcYAxisRange(cbValues, 0.08);

    // 右Y軸：約當股票張數範圍
    const stockValues = stockShares.filter(v => v > 0);
    const { min: minStock, max: maxStock, range: stockRange } = calcYAxisRange(stockValues, 0.08);

    // 縮放函數
    const xScale = (i) => padding.left + (i / Math.max(data.length - 1, 1)) * chartWidth;
    const yCBScale = (v) => padding.top + chartHeight - ((v - minCB) / cbRange) * chartHeight;
    const yStockScale = (v) => padding.top + chartHeight - ((v - minStock) / stockRange) * chartHeight;

    // 生成CB張數路徑和填充
    let cbPath = '';
    let cbFillPath = '';
    let firstX = null, lastX = null;
    data.forEach((d, i) => {
        const value = cbShares[i];
        if (value > 0) {
            const x = xScale(i);
            const y = yCBScale(value);
            if (firstX === null) {
                cbPath = `M ${x.toFixed(1)} ${y.toFixed(1)}`;
                firstX = x;
            } else {
                cbPath += ` L ${x.toFixed(1)} ${y.toFixed(1)}`;
            }
            lastX = x;
        }
    });
    if (cbPath && firstX !== null) {
        const baseY = padding.top + chartHeight;
        cbFillPath = `${cbPath} L ${lastX.toFixed(1)} ${baseY.toFixed(1)} L ${firstX.toFixed(1)} ${baseY.toFixed(1)} Z`;
    }

    // 生成約當股票張數路徑
    let stockPath = '';
    data.forEach((d, i) => {
        const value = stockShares[i];
        if (value > 0) {
            const x = xScale(i);
            const y = yStockScale(value);
            if (!stockPath) {
                stockPath = `M ${x.toFixed(1)} ${y.toFixed(1)}`;
            } else {
                stockPath += ` L ${x.toFixed(1)} ${y.toFixed(1)}`;
            }
        }
    });

    // 左Y軸刻度（CB張數）- 加大字體，使用千分位格式
    const yCBTicks = generateYTicks(minCB, maxCB, 5);
    let yCBTicksHTML = yCBTicks.map(tick => {
        const y = yCBScale(tick);
        return `
            <line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e0e0e0" stroke-width="1"/>
            <text x="${padding.left - 10}" y="${y + 5}" text-anchor="end" font-size="12" fill="#666" font-weight="500">${Math.round(tick).toLocaleString()}</text>
        `;
    }).join('');

    // 右Y軸刻度（約當股票張數）- 加大字體
    const yStockTicks = generateYTicks(minStock, maxStock, 5);
    let yStockTicksHTML = yStockTicks.map(tick => {
        const y = yStockScale(tick);
        return `<text x="${width - padding.right + 10}" y="${y + 5}" text-anchor="start" font-size="12" fill="#666" font-weight="500">${Math.round(tick).toLocaleString()}</text>`;
    }).join('');

    // X軸標籤 - 加大字體
    const xLabels = generateXLabels(data, 5);
    let xLabelsHTML = xLabels.map(({ idx, label }) => {
        const x = xScale(idx);
        return `<text x="${x}" y="${height - 12}" text-anchor="middle" font-size="12" fill="#666">${label}</text>`;
    }).join('');

    container.innerHTML = `
        <svg width="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="display:block; margin:0 auto;">
            <!-- 背景 -->
            <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="#fafafa" rx="4"/>

            <!-- Y軸刻度線和標籤 -->
            ${yCBTicksHTML}
            ${yStockTicksHTML}

            <!-- CB張數填充區域 -->
            <path d="${cbFillPath}" fill="rgba(25, 118, 210, 0.15)"/>

            <!-- CB張數線 -->
            <path d="${cbPath}" fill="none" stroke="#1976d2" stroke-width="2.5"/>

            <!-- 約當股票張數線（虛線）-->
            <path d="${stockPath}" fill="none" stroke="#2e7d32" stroke-width="2.5" stroke-dasharray="8,4"/>

            <!-- 圖例 -->
            <g transform="translate(${padding.left + 10}, ${padding.top - 18})">
                <line x1="0" y1="0" x2="25" y2="0" stroke="#1976d2" stroke-width="3"/>
                <text x="30" y="5" font-size="13" fill="#1976d2" font-weight="600">CB張數</text>
                <line x1="105" y1="0" x2="130" y2="0" stroke="#2e7d32" stroke-width="3" stroke-dasharray="8,4"/>
                <text x="135" y="5" font-size="13" fill="#2e7d32" font-weight="600">約當股票張數</text>
            </g>

            <!-- X軸標籤 -->
            ${xLabelsHTML}

            <!-- Y軸標題 -->
            <text x="${padding.left - 55}" y="${height/2}" text-anchor="middle" font-size="13" fill="#1976d2" font-weight="500" transform="rotate(-90, ${padding.left - 55}, ${height/2})">CB張數</text>
            <text x="${width - padding.right + 60}" y="${height/2}" text-anchor="middle" font-size="13" fill="#2e7d32" font-weight="500" transform="rotate(90, ${width - padding.right + 60}, ${height/2})">約當股票張數</text>

            <!-- 邊框 -->
            <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="none" stroke="#ccc" stroke-width="1" rx="4"/>
        </svg>
    `;
}

/**
 * 渲染CBAS選擇權拆解分析圖
 */
function renderCBASChart(cbCode, data, container, period) {
    const periodLabel = getPeriodLabel(period);
    const latestData = data[data.length - 1] || {};

    // 取得基本數據
    const cbPrice = latestData.cbPrice || 0;
    const stockPrice = latestData.stockPrice || 0;
    const convPrice = latestData.convPrice || 0;

    // 嘗試從 quoteData 補充資料
    const quoteData09 = window.quoteData?.['09'] || {};
    const cbData = quoteData09[cbCode] || {};

    const finalCBPrice = cbPrice || parseFloat(cbData['最新成交價']) || 0;
    const finalConvPrice = convPrice || parseFloat(cbData['轉換價格']) || 0;
    const finalStockPrice = stockPrice || 0;

    // 計算CBAS拆解數據
    const convRatio = finalConvPrice > 0 ? (100000 / finalConvPrice) : 0; // 轉換比例（股）
    const theoryValue = convRatio > 0 ? (convRatio * finalStockPrice / 1000) : 0; // 理論價值
    const holdingCost = convRatio > 0 ? (finalCBPrice * 1000 / convRatio) : 0; // 換股成本（元/股）
    const breakEvenPrice = holdingCost; // 損益兩平股價 = 換股成本
    const bondValue = 100;
    const optionValue = finalCBPrice > 100 ? (finalCBPrice - 100) : 0;
    const optionCost = optionValue * 1000;

    // 溢價分析計算
    const pricePremium = finalStockPrice > 0 ? ((holdingCost - finalStockPrice) / finalStockPrice * 100) : 0; // 溢價%
    const priceGap = holdingCost - finalStockPrice; // 股價差距
    const needRisePct = pricePremium; // 股價需漲幅度才打平

    // 檢查是否有足夠數據
    const hasData = finalCBPrice > 0 && finalConvPrice > 0;
    const hasStockPrice = finalStockPrice > 0;

    // 情境模擬計算
    const scenarioRows = hasStockPrice ? [
        { name: '股價上漲20%', pct: 20 },
        { name: '股價上漲50%', pct: 50 },
        { name: '股價上漲100%', pct: 100 },
        { name: '股價下跌20%', pct: -20 },
        { name: '股價下跌50%', pct: -50 }
    ].map((s, i) => {
        const newStockPrice = finalStockPrice * (1 + s.pct / 100);
        const newConvValue = finalConvPrice > 0 ? (newStockPrice / finalConvPrice * 100) : 0;
        const newCBPrice = Math.max(100, newConvValue);
        const cbReturn = finalCBPrice > 0 ? ((newCBPrice - finalCBPrice) / finalCBPrice * 100) : 0;
        const bg = i % 2 === 0 ? '#fff' : '#fafafa';
        const stockColor = s.pct >= 0 ? '#2e7d32' : '#d32f2f';
        const cbColor = cbReturn >= 0 ? '#2e7d32' : '#d32f2f';
        return `
            <tr style="background:${bg};">
                <td style="padding:8px;">${s.name}</td>
                <td style="padding:8px; text-align:right;">${newStockPrice.toFixed(2)}</td>
                <td style="padding:8px; text-align:right;">${newCBPrice.toFixed(2)}</td>
                <td style="padding:8px; text-align:right; color:${stockColor};">${s.pct >= 0 ? '+' : ''}${s.pct.toFixed(1)}%</td>
                <td style="padding:8px; text-align:right; color:${cbColor};">${cbReturn >= 0 ? '+' : ''}${cbReturn.toFixed(1)}%</td>
            </tr>
        `;
    }).join('') : `
        <tr><td colspan="5" style="padding:20px; text-align:center; color:#999;">需要股價資料才能計算情境分析</td></tr>
    `;

    container.innerHTML = `
        <div style="background:#fff; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <div style="font-weight:bold; color:#1565c0; font-size:16px;">
                    🎯 ${cbCode} CBAS選擇權拆解分析
                </div>
                <div style="font-size:12px; padding:4px 10px; border-radius:12px; background:#e3f2fd; color:#1565c0;">
                    轉換比率 ${hasData ? convRatio.toFixed(0) : '-'} 股/張
                </div>
            </div>

            <!-- 拆解概念說明 -->
            <div style="background:linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); color:white; padding:15px; border-radius:8px; margin-bottom:15px;">
                <div style="font-weight:bold; margin-bottom:10px; font-size:14px;">📋 可轉債 = 公司債 + 股票選擇權</div>
                <div style="display:grid; grid-template-columns:1fr auto 1fr auto 1fr; gap:8px; align-items:center; text-align:center;">
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:6px;">
                        <div style="font-size:11px; opacity:0.9;">CB市價</div>
                        <div style="font-size:18px; font-weight:bold;">${hasData ? finalCBPrice.toFixed(2) : '-'}</div>
                        <div style="font-size:10px; opacity:0.8;">元/張</div>
                    </div>
                    <div style="font-size:18px;">=</div>
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:6px;">
                        <div style="font-size:11px; opacity:0.9;">債券價值</div>
                        <div style="font-size:18px; font-weight:bold;">${bondValue.toFixed(2)}</div>
                        <div style="font-size:10px; opacity:0.8;">面額保本</div>
                    </div>
                    <div style="font-size:18px;">+</div>
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:6px;">
                        <div style="font-size:11px; opacity:0.9;">選擇權價值</div>
                        <div style="font-size:18px; font-weight:bold;">${hasData ? optionValue.toFixed(2) : '-'}</div>
                        <div style="font-size:10px; opacity:0.8;">權利金</div>
                    </div>
                </div>
            </div>

            <!-- 關鍵數據 -->
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:15px;">
                <div style="background:#e8f5e9; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">現股股價</div>
                    <div style="font-size:16px; font-weight:bold; color:#2e7d32;">${hasStockPrice ? finalStockPrice.toFixed(2) : '-'}</div>
                    <div style="font-size:9px; color:#999;">${hasStockPrice ? '元' : '無資料'}</div>
                </div>
                <div style="background:#fff3e0; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">轉換價</div>
                    <div style="font-size:16px; font-weight:bold; color:#e65100;">${hasData ? finalConvPrice.toFixed(2) : '-'}</div>
                    <div style="font-size:9px; color:#999;">${hasData ? '元' : '無資料'}</div>
                </div>
                <div style="background:#e3f2fd; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">換股成本</div>
                    <div style="font-size:16px; font-weight:bold; color:#1976d2;">${hasData ? holdingCost.toFixed(2) : '-'}</div>
                    <div style="font-size:9px; color:#999;">CB金額÷轉換比例</div>
                </div>
                <div style="background:#ffebee; padding:10px; border-radius:6px; text-align:center;">
                    <div style="font-size:10px; color:#666;">最大損失/張</div>
                    <div style="font-size:16px; font-weight:bold; color:#d32f2f;">${hasData ? optionCost.toLocaleString() : '-'}</div>
                    <div style="font-size:9px; color:#999;">溢價×1000</div>
                </div>
            </div>

            <!-- 拆解說明 -->
            <div style="background:#fff8e1; padding:12px; border-radius:8px; border-left:4px solid #ffc107; margin-bottom:15px;">
                <div style="font-weight:bold; color:#333; margin-bottom:8px; font-size:13px;">
                    💡 CBAS拆解的主要用意
                </div>
                <div style="font-size:12px; color:#555; line-height:1.7;">
                    <div style="margin-bottom:6px;">
                        <span style="color:#1565c0; font-weight:bold;">會拆解的主要用意在於</span>，積極看好的客戶只想參與股票上漲機會，所以會選擇<span style="color:#d32f2f; font-weight:bold;">只付出權利金</span>，只持有股票上漲選擇權部位。
                    </div>
                    <div style="margin-bottom:6px;">
                        而<span style="color:#2e7d32; font-weight:bold;">債券本金</span>將由券商尋找願意提供債券本金轉取得當利息的客戶進行拆解交割。
                    </div>
                    <div>
                        實務上以<span style="color:#7b1fa2; font-weight:bold;">折現率計算出權利金百元報價</span>，簡單說就是持有到可轉債選擇權到期日的利息成本。
                    </div>
                </div>
            </div>

            <!-- 情境分析表格 -->
            <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                <div style="font-weight:bold; color:#333; margin-bottom:10px; font-size:13px;">
                    📊 情境分析
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%; border-collapse:collapse; font-size:12px; min-width:400px;">
                        <thead>
                            <tr style="background:#e0e0e0;">
                                <th style="padding:8px; text-align:left;">情境</th>
                                <th style="padding:8px; text-align:right;">預期股價</th>
                                <th style="padding:8px; text-align:right;">預期CB價</th>
                                <th style="padding:8px; text-align:right;">股票報酬</th>
                                <th style="padding:8px; text-align:right;">CB報酬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${scenarioRows}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 結論 -->
            <div style="margin-top:12px; padding:12px; background:#e8f5e9; border-radius:8px; border-left:4px solid #4caf50;">
                <div style="font-weight:bold; color:#333; margin-bottom:8px; font-size:13px;">
                    🎯 投資結論
                </div>
                <div style="font-size:12px; color:#555; line-height:1.8;">
                    ${hasData ? `
                        <div style="margin-bottom:8px;">
                            ✅ <span style="font-weight:bold;">最大損失：</span>
                            <span style="color:#d32f2f; font-weight:bold;">${optionCost.toLocaleString()}</span> 元/張
                            （把風險控制在可接受範圍，先求少輸）
                        </div>
                        <div style="margin-bottom:8px;">
                            ✅ <span style="font-weight:bold;">損益兩平：</span>
                            股價漲到 <span style="color:#7b1fa2; font-weight:bold;">${breakEvenPrice.toFixed(2)}</span> 元
                            ${hasStockPrice ? `（需漲 ${needRisePct.toFixed(1)}%）` : ''}
                        </div>
                        ${hasStockPrice && pricePremium > 10 ? `
                        <div style="background:#fff3e0; padding:8px; border-radius:4px; margin-top:8px;">
                            ⚠️ <span style="font-weight:bold;">溢價提醒：</span>
                            目前溢價 ${pricePremium.toFixed(1)}%，意味著股價上漲 ${needRisePct.toFixed(0)}% 以內時，
                            CB 可能<span style="color:#e65100;">不會同步上漲</span>，需等股價突破 ${breakEvenPrice.toFixed(0)} 元才會明顯反映。
                        </div>
                        ` : ''}
                    ` : `
                        <span style="color:#999;">需要 CB 價格和轉換價資料才能計算結論</span>
                    `}
                </div>
            </div>
        </div>
    `;
}

/**
 * 取得期間標籤
 */
function getPeriodLabel(period) {
    const labels = {
        '30': '近1個月',
        '90': '近3個月',
        '180': '近6個月',
        '365': '近1年',
        '730': '近2年',
        '1095': '近3年',
        'all': '全部期間'
    };
    return labels[period] || period;
}

/**
 * 格式化數字
 */
function formatNumber(num) {
    if (num === null || num === undefined || num === '' || isNaN(num)) return '-';
    return Number(num).toLocaleString();
}

// ==================== v3.97-zs-br: CB價格歷史資料模組 ====================

/**
 * 載入 CB 價格歷史資料
 */
async function loadCBPriceData() {
    if (window.cbPriceData.loaded || window.cbPriceData.loading) return;
    window.cbPriceData.loading = true;

    console.log('💰 開始載入 CB 價格歷史資料...');
    const startTime = Date.now();

    // 確保 sql.js 已初始化
    if (!window.kanbanSQL) {
        try {
            window.kanbanSQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });
        } catch (e) {
            console.error('SQL.js 初始化失敗:', e);
            window.cbPriceData.loading = false;
            return;
        }
    }
    const SQL = window.kanbanSQL;

    const allData = window.cbPriceData.data || {};

    // 按時間順序載入（最新優先）
    const dbFiles = [
        'data/CB_price_2025.db',
        'data/CB_price_2022_2024.db',
        'data/CB_price_2019_2021.db'
    ];

    for (const dbFile of dbFiles) {
        try {
            const response = await fetch(dbFile);
            if (!response.ok) {
                console.warn(`${dbFile} 載入失敗: ${response.status}`);
                continue;
            }

            const buffer = await response.arrayBuffer();
            const db = new SQL.Database(new Uint8Array(buffer));

            // 查詢所有價格資料
            const results = db.exec(`
                SELECT 日期, 代號, 名稱, 收市, 開市, 最高, 最低, 單位, 金額, 均價
                FROM CB_price
                WHERE 收市 > 0 OR 最高 > 0
                ORDER BY 代號, 日期
            `);

            if (results.length > 0) {
                let count = 0;
                for (const row of results[0].values) {
                    const [date, code, name, close, open, high, low, volume, amount, avgPrice] = row;
                    if (!code) continue;

                    const cbCode = String(code).trim();
                    if (!allData[cbCode]) allData[cbCode] = [];

                    // 轉換日期格式 20250102 -> 2025/01/02
                    const dateStr = String(date);
                    const formattedDate = dateStr.length === 8 ?
                        `${dateStr.substring(0,4)}/${dateStr.substring(4,6)}/${dateStr.substring(6,8)}` : dateStr;

                    allData[cbCode].push({
                        date: formattedDate,
                        dateNum: parseInt(date) || 0,
                        name: name || '',
                        close: parseFloat(close) || 0,
                        open: parseFloat(open) || 0,
                        high: parseFloat(high) || 0,
                        low: parseFloat(low) || 0,
                        volume: parseFloat(volume) || 0,
                        amount: parseFloat(amount) || 0,
                        avgPrice: parseFloat(avgPrice) || 0
                    });
                    count++;
                }
                console.log(`  載入 ${dbFile}: ${count} 筆`);
            }

            db.close();
        } catch (err) {
            console.warn(`載入 ${dbFile} 失敗:`, err.message);
        }
    }

    // 排序每檔 CB 的時間序列
    for (const cbCode of Object.keys(allData)) {
        allData[cbCode].sort((a, b) => a.dateNum - b.dateNum);
    }

    window.cbPriceData.data = allData;
    window.cbPriceData.loaded = true;
    window.cbPriceData.loading = false;

    const totalCB = Object.keys(allData).length;
    const totalRecords = Object.values(allData).reduce((sum, arr) => sum + arr.length, 0);
    console.log(`✅ CB價格資料載入完成: ${totalCB} 檔CB, ${totalRecords} 筆價格記錄, ${Date.now() - startTime}ms`);
}

/**
 * 渲染 CB 價格走勢
 */
async function renderCBHistory(cbCode, container, period) {
    // 確保資料已載入
    if (!window.cbPriceData.loaded && !window.cbPriceData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>首次載入 CB 價格歷史資料中...</div>
        </div>`;

        await loadCBPriceData();
    }

    if (window.cbPriceData.loading) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:10px;">⏳</div>
            <div>CB 價格資料載入中...</div>
        </div>`;

        // v3.97-zs-bs: 使用 waitForDataLoaded
        waitForDataLoaded(() => !window.cbPriceData.loading).then(() => {
            renderCBHistory(cbCode, container, period);
        });
        return;
    }

    const searchCode = String(cbCode).trim();
    let allData = window.cbPriceData.data[searchCode] || [];

    // 如果找不到，嘗試數字格式
    if (allData.length === 0) {
        const numCode = parseInt(searchCode, 10);
        if (!isNaN(numCode)) {
            allData = window.cbPriceData.data[String(numCode)] || [];
        }
    }

    if (allData.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#888; padding:40px;">
            <div style="font-size:32px; margin-bottom:10px;">💰</div>
            <div>尚無 ${searchCode} 的價格歷史資料</div>
            <div style="font-size:12px; margin-top:8px; color:#aaa;">資料庫：CB_price_2019_2025</div>
        </div>`;
        return;
    }

    // v3.97-as-bv: 根據期間過濾（從資料最新日期往前推算）
    let filteredData = allData;
    if (period !== 'all') {
        const days = parseInt(period);

        // 找出資料中的最新日期
        const latestData = allData[allData.length - 1];
        let latestDateNum = latestData?.dateNum;

        if (latestDateNum) {
            // 從最新日期往前推算
            const latestStr = String(latestDateNum);
            const latestYear = parseInt(latestStr.substring(0, 4));
            const latestMonth = parseInt(latestStr.substring(4, 6));
            const latestDay = parseInt(latestStr.substring(6, 8));
            const latestDate = new Date(latestYear, latestMonth - 1, latestDay);

            latestDate.setDate(latestDate.getDate() - days);
            const cutoffNum = parseInt(latestDate.toISOString().slice(0,10).replace(/-/g, ''));
            filteredData = allData.filter(d => d.dateNum >= cutoffNum);
        } else {
            // 退回使用今天
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            const cutoffNum = parseInt(cutoffDate.toISOString().slice(0,10).replace(/-/g, ''));
            filteredData = allData.filter(d => d.dateNum >= cutoffNum);
        }
    }

    if (filteredData.length === 0) {
        filteredData = allData.slice(-30); // 至少顯示最後30筆
    }

    // 計算統計數據
    const closes = filteredData.map(d => d.close).filter(v => v > 0);
    const highs = filteredData.map(d => d.high).filter(v => v > 0);
    const lows = filteredData.map(d => d.low).filter(v => v > 0);
    const volumes = filteredData.map(d => d.volume).filter(v => v > 0);

    const stats = {
        maxPrice: highs.length > 0 ? Math.max(...highs) : 0,
        minPrice: lows.length > 0 ? Math.min(...lows) : 0,
        avgPrice: closes.length > 0 ? (closes.reduce((a,b) => a+b, 0) / closes.length) : 0,
        latestPrice: closes.length > 0 ? closes[closes.length - 1] : 0,
        totalVolume: volumes.reduce((a,b) => a+b, 0),
        avgVolume: volumes.length > 0 ? Math.round(volumes.reduce((a,b) => a+b, 0) / volumes.length) : 0,
        dataCount: filteredData.length
    };

    // 找出最高/最低價日期
    const maxPriceData = filteredData.find(d => d.high === stats.maxPrice);
    const minPriceData = filteredData.find(d => d.low === stats.minPrice);

    // CB名稱
    const cbName = filteredData[0]?.name || '';

    // 期間文字
    const periodTexts = { '30': '1個月', '90': '3個月', '180': '6個月', '365': '1年', '730': '2年', '1095': '3年', 'all': '全部' };
    const periodText = periodTexts[period] || period;

    // 生成走勢圖 SVG
    const svgChart = generateCBPriceChart(filteredData, stats);

    // 渲染內容 - v3.97-as-bu 優化佈局
    container.innerHTML = `
        <div style="margin-bottom:15px;">
            <!-- 標題單獨一列 -->
            <div style="text-align:center; margin-bottom:12px;">
                <span style="font-size:16px; font-weight:700; color:#7b1fa2;">
                    💰 ${cbName || searchCode} ${periodText}價格走勢
                </span>
            </div>

            <!-- 按鈕單獨一列 -->
            <div style="display:flex; justify-content:center; gap:12px; margin-bottom:15px;">
                <button type="button" onclick="switchCBHistoryView('chart')" id="cbHistoryChartBtn"
                    style="padding:8px 20px; border:2px solid #7b1fa2; border-radius:6px; background:#7b1fa2; color:white; cursor:pointer; font-size:13px; font-weight:600;">
                    📈 走勢圖
                </button>
                <button type="button" onclick="switchCBHistoryView('table')" id="cbHistoryTableBtn"
                    style="padding:8px 20px; border:2px solid #7b1fa2; border-radius:6px; background:white; color:#7b1fa2; cursor:pointer; font-size:13px; font-weight:600;">
                    📋 價格表
                </button>
            </div>

            <!-- 統計摘要 - 重新設計參考 Investing.com 風格 -->
            <div style="padding:16px; background:#fff; border-radius:12px; margin-bottom:16px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                <!-- 最新價格突出顯示 -->
                <div style="text-align:center; margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid #eee;">
                    <div style="font-size:13px; color:#666; margin-bottom:4px;">最新價</div>
                    <div style="font-size:36px; font-weight:700; color:#7b1fa2;">${stats.latestPrice.toFixed(2)}</div>
                </div>
                
                <!-- 高低價格 -->
                <div style="display:flex; justify-content:space-around; margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid #eee;">
                    <div style="text-align:center;">
                        <div style="font-size:12px; color:#888; margin-bottom:4px;">最高價</div>
                        <div style="font-size:22px; font-weight:700; color:#c62828;">${stats.maxPrice.toFixed(2)}</div>
                        <div style="font-size:11px; color:#aaa;">${maxPriceData?.date?.substring(5) || ''}</div>
                    </div>
                    <div style="width:1px; background:#eee;"></div>
                    <div style="text-align:center;">
                        <div style="font-size:12px; color:#888; margin-bottom:4px;">最低價</div>
                        <div style="font-size:22px; font-weight:700; color:#2e7d32;">${stats.minPrice.toFixed(2)}</div>
                        <div style="font-size:11px; color:#aaa;">${minPriceData?.date?.substring(5) || ''}</div>
                    </div>
                </div>
                
                <!-- 其他統計 -->
                <div style="display:flex; justify-content:space-around;">
                    <div style="text-align:center;">
                        <div style="font-size:11px; color:#888;">平均價</div>
                        <div style="font-size:16px; font-weight:600; color:#333;">${stats.avgPrice.toFixed(2)}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:11px; color:#888;">累計成交</div>
                        <div style="font-size:16px; font-weight:600; color:#333;">${formatNumber(stats.totalVolume)} 張</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:11px; color:#888;">日均量</div>
                        <div style="font-size:16px; font-weight:600; color:#333;">${formatNumber(stats.avgVolume)} 張</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 走勢圖 / 價格表 內容區 -->
        <div id="cbHistoryChartView">
            ${svgChart}
        </div>
        <div id="cbHistoryTableView" style="display:none;">
            ${generateCBPriceTable(filteredData)}
        </div>

        <div style="font-size:11px; color:#888; margin-top:8px; text-align:right;">
            共 ${stats.dataCount} 筆交易日資料 | 資料來源：CB_price 資料庫
        </div>
    `;
}

/**
 * 切換 CB 價格顯示模式（走勢圖/價格表）
 */
function switchCBHistoryView(view) {
    const chartView = document.getElementById('cbHistoryChartView');
    const tableView = document.getElementById('cbHistoryTableView');
    const chartBtn = document.getElementById('cbHistoryChartBtn');
    const tableBtn = document.getElementById('cbHistoryTableBtn');

    if (view === 'chart') {
        chartView.style.display = 'block';
        tableView.style.display = 'none';
        chartBtn.style.background = '#7b1fa2';
        chartBtn.style.color = 'white';
        tableBtn.style.background = 'white';
        tableBtn.style.color = '#7b1fa2';
    } else {
        chartView.style.display = 'none';
        tableView.style.display = 'block';
        chartBtn.style.background = 'white';
        chartBtn.style.color = '#7b1fa2';
        tableBtn.style.background = '#7b1fa2';
        tableBtn.style.color = 'white';
    }
}

/**
 * 生成 CB 價格走勢圖 SVG
 */
function generateCBPriceChart(data, stats) {
    if (data.length === 0) return '<div style="text-align:center; padding:40px; color:#888;">無資料</div>';

    const width = 680;
    const height = 280;
    const padding = { top: 20, right: 50, bottom: 40, left: 50 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // 計算 Y 軸範圍
    const allPrices = data.flatMap(d => [d.high, d.low, d.close].filter(v => v > 0));
    const minY = Math.min(...allPrices) * 0.98;
    const maxY = Math.max(...allPrices) * 1.02;
    const yRange = maxY - minY || 1;

    // 生成價格路徑
    let closePath = '';
    let highPath = '';
    let lowPath = '';

    data.forEach((d, i) => {
        const x = padding.left + (i / Math.max(data.length - 1, 1)) * chartWidth;

        if (d.close > 0) {
            const yClose = padding.top + chartHeight - ((d.close - minY) / yRange) * chartHeight;
            closePath += (closePath ? ' L ' : 'M ') + `${x.toFixed(1)} ${yClose.toFixed(1)}`;
        }
        if (d.high > 0) {
            const yHigh = padding.top + chartHeight - ((d.high - minY) / yRange) * chartHeight;
            highPath += (highPath ? ' L ' : 'M ') + `${x.toFixed(1)} ${yHigh.toFixed(1)}`;
        }
        if (d.low > 0) {
            const yLow = padding.top + chartHeight - ((d.low - minY) / yRange) * chartHeight;
            lowPath += (lowPath ? ' L ' : 'M ') + `${x.toFixed(1)} ${yLow.toFixed(1)}`;
        }
    });

    // Y 軸刻度
    const yTicks = 5;
    let yTicksHTML = '';
    for (let i = 0; i <= yTicks; i++) {
        const value = minY + (yRange * i / yTicks);
        const y = padding.top + chartHeight - (chartHeight * i / yTicks);
        yTicksHTML += `
            <line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#eee" stroke-width="1"/>
            <text x="${padding.left - 5}" y="${y + 4}" text-anchor="end" font-size="10" fill="#666">${value.toFixed(1)}</text>
        `;
    }

    // X 軸日期標籤（顯示5個）
    let xLabelsHTML = '';
    const labelCount = Math.min(5, data.length);
    for (let i = 0; i < labelCount; i++) {
        const idx = Math.floor(i * (data.length - 1) / Math.max(labelCount - 1, 1));
        const d = data[idx];
        const x = padding.left + (idx / Math.max(data.length - 1, 1)) * chartWidth;
        xLabelsHTML += `<text x="${x}" y="${height - 10}" text-anchor="middle" font-size="10" fill="#666">${d.date?.substring(5) || ''}</text>`;
    }

    return `
        <svg width="100%" viewBox="0 0 ${width} ${height}" style="max-width:${width}px; display:block; margin:0 auto;">
            <!-- 背景 -->
            <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="#fafafa" rx="4"/>

            <!-- Y軸刻度 -->
            ${yTicksHTML}

            <!-- 價格線 -->
            <path d="${highPath}" fill="none" stroke="#ffcdd2" stroke-width="1.5" opacity="0.7"/>
            <path d="${lowPath}" fill="none" stroke="#c8e6c9" stroke-width="1.5" opacity="0.7"/>
            <path d="${closePath}" fill="none" stroke="#7b1fa2" stroke-width="2"/>

            <!-- 圖例 -->
            <g transform="translate(${padding.left + 10}, ${padding.top + 15})">
                <line x1="0" y1="0" x2="20" y2="0" stroke="#7b1fa2" stroke-width="2"/>
                <text x="25" y="4" font-size="10" fill="#7b1fa2">收盤</text>
                <line x1="60" y1="0" x2="80" y2="0" stroke="#ffcdd2" stroke-width="2"/>
                <text x="85" y="4" font-size="10" fill="#c62828">最高</text>
                <line x1="120" y1="0" x2="140" y2="0" stroke="#c8e6c9" stroke-width="2"/>
                <text x="145" y="4" font-size="10" fill="#2e7d32">最低</text>
            </g>

            <!-- X軸標籤 -->
            ${xLabelsHTML}

            <!-- Y軸標題 -->
            <text x="${padding.left - 35}" y="${height/2}" text-anchor="middle" font-size="11" fill="#666" transform="rotate(-90, ${padding.left - 35}, ${height/2})">價格(元)</text>
        </svg>
    `;
}

/**
 * 生成 CB 價格明細表
 */
function generateCBPriceTable(data) {
    if (data.length === 0) return '<div style="text-align:center; padding:40px; color:#888;">無資料</div>';

    // 倒序顯示（最新在前）
    const displayData = [...data].reverse();

    // v3.97-as-bu: 優化表格佈局，移除成交量欄位避免擠壓
    let tableHTML = `
        <div style="max-height:400px; overflow-y:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed;">
                <thead style="position:sticky; top:0; background:#7b1fa2; color:white;">
                    <tr>
                        <th style="padding:10px 8px; text-align:center; font-weight:600; width:28%;">日期</th>
                        <th style="padding:10px 8px; text-align:right; font-weight:600; width:18%;">收盤</th>
                        <th style="padding:10px 8px; text-align:right; font-weight:600; width:18%;">漲跌</th>
                        <th style="padding:10px 8px; text-align:right; font-weight:600; width:18%;">最高</th>
                        <th style="padding:10px 8px; text-align:right; font-weight:600; width:18%;">最低</th>
                    </tr>
                </thead>
                <tbody>
    `;

    displayData.forEach((d, i) => {
        const bgColor = i % 2 === 0 ? '#f5f5f5' : 'white';
        const prevData = displayData[i + 1];
        const change = prevData && d.close > 0 && prevData.close > 0 ? d.close - prevData.close : 0;
        const changeColor = change > 0 ? '#c62828' : change < 0 ? '#2e7d32' : '#666';
        const changeStr = change !== 0 ? (change > 0 ? '+' : '') + change.toFixed(2) : '-';

        tableHTML += `
            <tr style="background:${bgColor};">
                <td style="padding:8px; text-align:center; color:#555; font-size:13px;">${d.date || '-'}</td>
                <td style="padding:8px; text-align:right; font-weight:700; color:#7b1fa2; font-size:15px;">${d.close > 0 ? d.close.toFixed(2) : '-'}</td>
                <td style="padding:8px; text-align:right; color:${changeColor}; font-weight:600; font-size:14px;">${changeStr}</td>
                <td style="padding:8px; text-align:right; color:#c62828; font-size:14px;">${d.high > 0 ? d.high.toFixed(2) : '-'}</td>
                <td style="padding:8px; text-align:right; color:#2e7d32; font-size:14px;">${d.low > 0 ? d.low.toFixed(2) : '-'}</td>
            </tr>
        `;
    });

    tableHTML += '</tbody></table></div>';
    return tableHTML;
}

// ==================== v3.97-dk 重新設計：CB套利追蹤模組 ====================
// 追蹤CB主力套利軌跡：融資餘額 / 融券餘額 / CB流通餘額
// 使用現有的 weeklyBalanceData（來自 yuanta_data1.db / yuanta_data2.db）

let arbitrageCBList = [];
let arbitrageFullList = [];  // 完整清單（篩選前）
let currentArbitrageFilter = 'listed';  // 當前篩選：listed / delisted / all
let currentArbitragePeriod = 180;  // 當前追蹤區間（天）
let currentArbitrageCB = null;  // 當前選中的CB代號

/**
 * 初始化CB套利追蹤模組
 * 區分掛牌中和已下市CB
 */
async function initArbitrageModule() {
    const select = document.getElementById('arbitrageCBSelect');
    if (!select) return;
    
    // 如果已載入過就不重複
    if (arbitrageFullList.length > 0) {
        updateArbitrageCBCount();
        return;
    }
    
    // 顯示載入中
    select.innerHTML = '<option value="">載入CB清單中...</option>';
    
    try {
        // v3.97-dm: 加入超時機制，避免無限等待
        const timeout = (ms) => new Promise((_, reject) => 
            setTimeout(() => reject(new Error('載入超時')), ms)
        );
        
        // 確保週餘額資料已載入（最多等待 30 秒）
        if (!window.weeklyBalanceData.loaded) {
            if (!window.weeklyBalanceData.loading) {
                loadWeeklyBalanceData(); // 不 await，讓它背景載入
            }
            
            // 等待最多 30 秒
            try {
                await Promise.race([
                    waitForDataLoaded(() => window.weeklyBalanceData.loaded),
                    timeout(30000)
                ]);
            } catch (e) {
                console.warn('週餘額資料載入超時或失敗');
                select.innerHTML = '<option value="">資料載入中，請稍後重試...</option>';
                return;
            }
        }
        
        // 取得掛牌中CB清單
        const listedCodes = window.cbDatabase?.listedCodes || new Set();
        
        // 從 weeklyBalanceData 建立CB清單
        const cbCodes = Object.keys(window.weeklyBalanceData.data);
        
        if (cbCodes.length === 0) {
            select.innerHTML = '<option value="">無可用的CB資料</option>';
            return;
        }
        
        // 建立CB清單
        arbitrageFullList = [];
        
        for (const cbCode of cbCodes) {
            const history = window.weeklyBalanceData.data[cbCode];
            if (!history || history.length === 0) continue;
            
            const latest = history[history.length - 1];
            const earliest = history[0];
            
            // 判斷是否掛牌中
            const isListed = listedCodes.has(cbCode);
            
            // 從 sheet08Data 取得詳細資訊
            let cbName = cbCode;
            let stockCode = '';
            let stockName = '';
            let issueShares = earliest.balanceShares || latest.balanceShares || 0;
            let convPrice = 0;
            
            // v3.97-eh: 優先從 sheet01Data (01工作表-所有CB清單) 取得發行規模
            if (window.sheet01Data) {
                const info01 = window.sheet01Data.find(r => String(r['代號'] || r['CB代號']).trim() === cbCode);
                if (info01) {
                    if (!cbName || cbName === cbCode) cbName = info01['名稱'] || info01['CB名稱'] || cbCode;
                    if (!stockCode) stockCode = info01['轉換標的代碼'] || info01['股票代號'] || '';
                    if (!stockName) stockName = info01['轉換標的名稱'] || '';
                    // 發行規模（億）→ 張數 = 億 × 10000 / 10萬 = 億 × 10000
                    const issueAmountBillion = parseFloat(info01['發行規模'] || info01['發行總額(億)'] || info01['實際發行總額(億)']) || 0;
                    if (issueAmountBillion > 0) issueShares = Math.round(issueAmountBillion * 10000);
                    // 發行規模（百萬）→ 張數 = 百萬 × 10
                    const issueAmountMillion = parseFloat(info01['實際發行總額(百萬)']) || 0;
                    if (issueAmountMillion > 0) issueShares = Math.round(issueAmountMillion * 10);
                    if (!convPrice) convPrice = parseFloat(info01['轉換價格(元)'] || info01['轉換價']) || 0;
                }
            }
            
            if (window.sheet08Data) {
                const info = window.sheet08Data.find(r => String(r['代號']).trim() === cbCode);
                if (info) {
                    cbName = info['名稱'] || cbCode;
                    stockCode = info['轉換標的代碼'] || '';
                    stockName = info['轉換標的名稱'] || '';
                    const issueAmount = parseFloat(info['實際發行總額(百萬)']) || 0;
                    if (issueAmount > 0) issueShares = Math.round(issueAmount * 10);
                    convPrice = parseFloat(info['轉換價格(元)']) || 0;
                }
            }
            
            // 如果 sheet08Data 沒有，嘗試從 auctionDataCache 取得
            if (cbName === cbCode && window.auctionDataCache) {
                const auctionInfo = window.auctionDataCache.find(r => String(r['CB代號']).trim() === cbCode);
                if (auctionInfo) {
                    cbName = auctionInfo['名稱'] || cbCode;
                    stockCode = auctionInfo['股票代號'] || '';
                    stockName = auctionInfo['轉換標的名稱'] || '';
                    const issueAmount = parseFloat(auctionInfo['發行規模']) || 0;
                    if (issueAmount > 0) issueShares = Math.round(issueAmount * 10);
                    convPrice = parseFloat(auctionInfo['轉換價']) || 0;
                }
            }
            
            // v3.97-eh: 如果還是沒有發行張數，用歷史最大餘額作為估計
            if (issueShares <= 0 || issueShares < 100) {
                const maxBalance = Math.max(...history.map(h => h.balanceShares || 0));
                if (maxBalance > issueShares) issueShares = maxBalance;
            }
            
            const balanceShares = latest.balanceShares || 0;
            const convertedPct = issueShares > 0 ? ((1 - balanceShares / issueShares) * 100) : 0;
            
            // v3.97-ed: 取得最後資料日期（用於判斷下市時間）
            const lastDateStr = latest.date || '';
            const lastDate = lastDateStr ? parseInt(lastDateStr.replace(/\//g, '')) : 0;
            
            arbitrageFullList.push({
                cbCode,
                cbName,
                stockCode,
                stockName,
                issueShares,
                balanceShares,
                convertedPct,
                convPrice,
                isListed,
                historyCount: history.length,
                lastDate  // v3.97-ed: 最後資料日期
            });
        }
        
        // 預設按代號排序
        arbitrageFullList.sort((a, b) => a.cbCode.localeCompare(b.cbCode));
        
        // 預設顯示掛牌中
        filterArbitrageCB('listed');
        
        console.log(`CB套利模組: 載入 ${arbitrageFullList.length} 檔CB (掛牌中 ${arbitrageFullList.filter(c => c.isListed).length} 檔)`);
        
    } catch (error) {
        console.error('初始化CB套利模組失敗:', error);
        select.innerHTML = '<option value="">載入失敗</option>';
        
        const chartContainer = document.getElementById('arbitrageChart');
        if (chartContainer) {
            chartContainer.innerHTML = `
                <div style="text-align:center; color:#c62828; padding:40px;">
                    <div style="font-size:24px;">⚠️</div>
                    <div style="margin-top:8px;">載入失敗: ${error.message}</div>
                </div>`;
        }
    }
}

/**
 * 篩選CB清單（掛牌中/已下市/全部）
 */
function filterArbitrageCB(filter, btnElement) {
    currentArbitrageFilter = filter;
    
    // v3.97-ee: 更新按鈕狀態 - 有背景色區別
    document.querySelectorAll('.arb-filter-tab').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#e0e0e0';
        btn.style.color = '#666';
        btn.style.boxShadow = 'none';
    });
    
    if (btnElement) {
        btnElement.classList.add('active');
        if (filter === 'listed') {
            btnElement.style.background = '#4caf50';
            btnElement.style.color = 'white';
            btnElement.style.boxShadow = '0 2px 4px rgba(76,175,80,0.3)';
        } else if (filter === 'delisted-recent') {
            btnElement.style.background = '#616161';
            btnElement.style.color = 'white';
            btnElement.style.boxShadow = '0 2px 4px rgba(97,97,97,0.3)';
        } else if (filter === 'delisted-old') {
            btnElement.style.background = '#795548';
            btnElement.style.color = 'white';
            btnElement.style.boxShadow = '0 2px 4px rgba(121,85,72,0.3)';
        }
    }
    
    // v3.97-dm: 防止資料未載入時卡死
    if (!arbitrageFullList || arbitrageFullList.length === 0) {
        console.warn('CB清單尚未載入，無法篩選');
        arbitrageCBList = [];
        updateArbitrageSelect();
        updateArbitrageCBCount();
        return;
    }
    
    // v3.97-ed: 計算三年前的日期
    const now = new Date();
    const threeYearsAgo = new Date(now.getFullYear() - 3, now.getMonth(), now.getDate());
    const threeYearsAgoNum = parseInt(
        `${threeYearsAgo.getFullYear()}${String(threeYearsAgo.getMonth()+1).padStart(2,'0')}${String(threeYearsAgo.getDate()).padStart(2,'0')}`
    );
    
    // 篩選清單
    if (filter === 'listed') {
        arbitrageCBList = arbitrageFullList.filter(c => c.isListed);
    } else if (filter === 'delisted-recent') {
        // 近三年下市：下市日期在三年內
        arbitrageCBList = arbitrageFullList.filter(c => {
            if (c.isListed) return false;
            // 從 CB 代碼或資料判斷下市時間（使用最後資料日期）
            const lastDate = c.lastDate || 0;
            return lastDate >= threeYearsAgoNum;
        });
    } else if (filter === 'delisted-old') {
        // 三年以上：下市日期超過三年
        arbitrageCBList = arbitrageFullList.filter(c => {
            if (c.isListed) return false;
            const lastDate = c.lastDate || 0;
            return lastDate < threeYearsAgoNum || lastDate === 0;
        });
    } else {
        arbitrageCBList = [...arbitrageFullList];
    }
    
    // v3.97-eg: 統一按代號排序
    arbitrageCBList.sort((a, b) => a.cbCode.localeCompare(b.cbCode));
    
    // 清空搜尋框
    const searchInput = document.getElementById('arbitrageSearchInput');
    if (searchInput) searchInput.value = '';
    
    // 更新下拉選單
    updateArbitrageSelect();
    updateArbitrageCBCount();
}

/**
 * 搜尋CB
 */
function searchArbitrageCB(keyword) {
    const kw = keyword.trim().toLowerCase();
    
    if (!kw) {
        // 清空搜尋時恢復原本篩選
        filterArbitrageCB(currentArbitrageFilter, document.querySelector(`.arb-filter-tab[data-filter="${currentArbitrageFilter}"]`));
        return;
    }
    
    // v3.97-ed: 先套用當前篩選條件，再在範圍內搜尋
    const now = new Date();
    const threeYearsAgo = new Date(now.getFullYear() - 3, now.getMonth(), now.getDate());
    const threeYearsAgoNum = parseInt(
        `${threeYearsAgo.getFullYear()}${String(threeYearsAgo.getMonth()+1).padStart(2,'0')}${String(threeYearsAgo.getDate()).padStart(2,'0')}`
    );
    
    let baseList = arbitrageFullList;
    
    // 根據當前篩選條件限定範圍
    if (currentArbitrageFilter === 'listed') {
        baseList = arbitrageFullList.filter(c => c.isListed);
    } else if (currentArbitrageFilter === 'delisted-recent') {
        baseList = arbitrageFullList.filter(c => !c.isListed && (c.lastDate || 0) >= threeYearsAgoNum);
    } else if (currentArbitrageFilter === 'delisted-old') {
        baseList = arbitrageFullList.filter(c => !c.isListed && ((c.lastDate || 0) < threeYearsAgoNum || (c.lastDate || 0) === 0));
    }
    
    // 在範圍內搜尋
    arbitrageCBList = baseList.filter(c => 
        c.cbCode.toLowerCase().includes(kw) || 
        c.cbName.toLowerCase().includes(kw) ||
        c.stockCode.toLowerCase().includes(kw) ||
        c.stockName.toLowerCase().includes(kw)
    );
    
    // v3.97-eg: 統一按代號排序
    arbitrageCBList.sort((a, b) => a.cbCode.localeCompare(b.cbCode));
    
    updateArbitrageSelect();
    updateArbitrageCBCount();
}

/**
 * 更新CB下拉選單
 */
function updateArbitrageSelect() {
    const select = document.getElementById('arbitrageCBSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">-- 請選擇要追蹤的CB --</option>';
    
    arbitrageCBList.forEach(cb => {
        const statusIcon = cb.isListed ? '🟢' : '⚫';
        const pctDisplay = cb.convertedPct.toFixed(0);
        select.innerHTML += `<option value="${cb.cbCode}">${statusIcon} ${cb.cbCode} ${cb.cbName} - 餘${cb.balanceShares.toLocaleString()}張 已轉${pctDisplay}%</option>`;
    });
}

/**
 * 更新CB數量顯示
 */
function updateArbitrageCBCount() {
    const countEl = document.getElementById('arbitrageCBCount');
    if (countEl) {
        countEl.textContent = arbitrageCBList.length;
    }
}

/**
 * 切換追蹤區間
 */
// v3.97-ds: 快取當前CB的完整資料，避免重複載入
let cachedArbitrageData = {
    cbCode: null,
    cbData: [],
    marginData: [],
    cbInfo: null
};

function changeArbitragePeriod(period, btnElement) {
    currentArbitragePeriod = period;
    
    // 更新按鈕狀態
    document.querySelectorAll('.arb-period-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    if (btnElement) {
        btnElement.classList.add('active');
    }
    
    // v3.97-ds: 如果有快取資料，直接用快取重繪，不重新載入
    if (currentArbitrageCB && cachedArbitrageData.cbCode === currentArbitrageCB) {
        const filteredCbData = filterDataByPeriod(cachedArbitrageData.cbData, period);
        displayArbitrageSummary(filteredCbData, cachedArbitrageData.marginData, cachedArbitrageData.cbInfo);
        displayArbitrageChart(filteredCbData, cachedArbitrageData.marginData);
    } else if (currentArbitrageCB) {
        loadArbitrageData(currentArbitrageCB);
    }
}

// v3.97-ds: 根據時間區間篩選資料
function filterDataByPeriod(cbData, period) {
    if (period === 'all' || !cbData || cbData.length === 0) {
        return cbData;
    }
    
    const latestDate = new Date(cbData[cbData.length - 1].dateStr?.replace(/\//g, '-') || Date.now());
    const cutoffDate = new Date(latestDate);
    cutoffDate.setDate(cutoffDate.getDate() - period);
    
    return cbData.filter(d => {
        const dDate = new Date(d.dateStr?.replace(/\//g, '-'));
        return dDate >= cutoffDate;
    });
}

/**
 * 載入指定CB的套利資料
 */
async function loadArbitrageData(cbCode) {
    if (!cbCode) {
        document.getElementById('arbitrageSummary').style.display = 'none';
        document.getElementById('arbitrageHotList').style.display = 'none';
        document.getElementById('arbitragePeriodSelector').style.display = 'none';
        document.getElementById('conversionValueSection').style.display = 'none';
        document.getElementById('arbitrageChart').innerHTML = `
            <div style="text-align:center; color:#999; padding:60px 20px;">
                <div style="font-size:48px; margin-bottom:12px;">💎</div>
                <div style="font-size:15px; color:#666;">CB套利追蹤系統</div>
                <div style="font-size:13px; color:#999; margin-top:8px;">
                    選擇一檔CB，觀察主力套利軌跡
                </div>
            </div>`;
        currentArbitrageCB = null;
        return;
    }
    
    currentArbitrageCB = cbCode;
    
    document.getElementById('arbitrageHotList').style.display = 'none';
    document.getElementById('arbitragePeriodSelector').style.display = 'block';
    document.getElementById('arbitrageChart').innerHTML = `
        <div style="text-align:center; padding:40px;">
            <div style="font-size:24px;">⏳</div>
            <div style="color:#666; margin-top:8px;">載入資料中...</div>
        </div>`;
    
    try {
        // 從 weeklyBalanceData 取得CB餘額歷史
        const cbHistory = window.weeklyBalanceData.data[cbCode];
        
        if (!cbHistory || cbHistory.length === 0) {
            throw new Error('找不到此CB的餘額資料');
        }
        
        // 找出CB的基本資訊
        const cbInfo = arbitrageFullList.find(c => c.cbCode === cbCode) || {};
        
        // v3.97-ds: 存入快取（完整資料，未篩選時間）
        const fullCbData = cbHistory.map(d => ({
            date: d.date ? parseInt(d.date.replace(/\//g, '')) : 0,
            dateStr: d.date,
            cbName: cbInfo.cbName || cbCode,
            stockCode: cbInfo.stockCode || '',
            stockName: cbInfo.stockName || '',
            convPrice: cbInfo.convPrice || 0,
            issueShares: cbInfo.issueShares || d.balanceShares,
            balance: d.balanceShares || 0
        }));
        
        // 取得股票代碼
        const stockCode = cbInfo.stockCode;
        
        // 載入融資融券資料（不阻塞，有就用沒有就算）
        let marginData = [];
        if (stockCode) {
            // v3.97-dm: 不等待融資融券載入，有資料就用
            if (!window.marginData.loaded && !window.marginData.loading) {
                loadMarginData(); // 背景載入，不 await
            }
            
            // 如果已有資料就使用
            if (window.marginData.loaded) {
                const stockMargin = window.marginData.data[stockCode];
                if (stockMargin) {
                    marginData = Object.entries(stockMargin).map(([dateStr, data]) => {
                        const dateNum = parseInt(dateStr.replace(/\//g, ''));
                        return {
                            date: dateNum,
                            dateStr: dateStr,
                            marginBalance: data.marginBalance || 0,
                            shortBalance: data.shortBalance || 0
                        };
                    }).filter(d => !isNaN(d.date)).sort((a, b) => a.date - b.date);
                }
            }
        }
        
        // v3.97-ds: 存入快取
        cachedArbitrageData = {
            cbCode: cbCode,
            cbData: fullCbData,
            marginData: marginData,
            cbInfo: cbInfo
        };
        
        // 套用時間區間篩選
        const filteredCbData = filterDataByPeriod(fullCbData, currentArbitragePeriod);
        
        // 顯示摘要
        displayArbitrageSummary(filteredCbData, marginData, cbInfo);
        
        // 繪製圖表
        displayArbitrageChart(filteredCbData, marginData);
        
        // v3.97-ec: 顯示轉換價值分析
        displayConversionValueAnalysis(cbCode, cbInfo);
        
    } catch (error) {
        console.error('載入套利資料失敗:', error);
        document.getElementById('arbitrageChart').innerHTML = `
            <div style="text-align:center; color:#c62828; padding:40px;">
                <div style="font-size:24px;">⚠️</div>
                <div style="margin-top:8px;">${error.message}</div>
            </div>`;
    }
}

/**
 * 顯示套利狀態摘要
 */
function displayArbitrageSummary(cbData, marginData, cbInfo) {
    const summary = document.getElementById('arbitrageSummary');
    const latest = cbData[cbData.length - 1];
    const first = cbData[0];
    
    // balance 已經是張數
    const issueShares = cbInfo?.issueShares || first.issueShares || first.balance || 0;
    const balanceShares = latest.balance || 0;
    const convertedShares = issueShares - balanceShares;
    const convertedPct = issueShares > 0 ? ((convertedShares / issueShares) * 100).toFixed(1) : 0;
    
    // 區間內變化
    const periodChange = first.balance - latest.balance;
    const periodChangePct = first.balance > 0 ? ((periodChange / first.balance) * 100).toFixed(1) : 0;
    
    // v3.97-dz: 計算轉換動能（累積轉換壓力）
    // 邏輯：連續下降的週數越多、累積下降量越大 = 出貨壓力越大
    let consecutiveDecline = 0;  // 連續下降週數
    let totalDeclineShares = 0;  // 累積下降張數
    let declineWeeks = 0;        // 總下降週數
    
    for (let i = cbData.length - 1; i > 0; i--) {
        const change = cbData[i-1].balance - cbData[i].balance;
        if (change > 0) {
            // 餘額下降（轉換中）
            if (consecutiveDecline === cbData.length - 1 - i) {
                consecutiveDecline++;
            }
            totalDeclineShares += change;
            declineWeeks++;
        }
    }
    
    // 轉換動能分數 (0-100)
    // 考慮: 連續下降週數、累積轉換比例、轉換速度
    const avgWeeklyDecline = declineWeeks > 0 ? totalDeclineShares / declineWeeks : 0;
    const declineRatio = issueShares > 0 ? (totalDeclineShares / issueShares * 100) : 0;
    const momentum = Math.min(100, Math.round(
        (consecutiveDecline * 10) +           // 連續性加分 (最多50分)
        (declineRatio * 0.5) +                 // 累積轉換比例 (最多50分)
        (avgWeeklyDecline > 1000 ? 10 : 0)     // 大量轉換加分
    ));
    
    // 動能等級判定
    let momentumLevel = '低';
    let momentumColor = '#666';
    let momentumIcon = '😴';
    let momentumDesc = '轉換平緩';
    
    if (momentum >= 70) {
        momentumLevel = '極高';
        momentumColor = '#c62828';
        momentumIcon = '🚀';
        momentumDesc = '積極拉抬出貨中';
    } else if (momentum >= 50) {
        momentumLevel = '高';
        momentumColor = '#e65100';
        momentumIcon = '🔥';
        momentumDesc = '加速轉換出場';
    } else if (momentum >= 30) {
        momentumLevel = '中';
        momentumColor = '#ff9800';
        momentumIcon = '⚡';
        momentumDesc = '穩定轉換中';
    } else if (momentum >= 10) {
        momentumLevel = '低';
        momentumColor = '#2196f3';
        momentumIcon = '📊';
        momentumDesc = '小量觀察';
    }
    
    // 換股比例 & 約當股票張數
    const convPrice = cbInfo?.convPrice || latest.convPrice || 0;
    const convRatio = convPrice > 0 ? (100000 / convPrice) : 0;
    const equivStockShares = balanceShares * convRatio / 1000;
    
    // 計算套利階段
    let stage = '觀望期';
    let stageColor = '#666';
    let stageIcon = '⏸️';
    
    const pctNum = parseFloat(convertedPct);
    if (pctNum > 80) {
        stage = '套利完成';
        stageColor = '#4caf50';
        stageIcon = '✅';
    } else if (pctNum > 50) {
        stage = '大量轉換中';
        stageColor = '#ff9800';
        stageIcon = '🔥';
    } else if (pctNum > 20) {
        stage = '套利進行中';
        stageColor = '#e91e63';
        stageIcon = '⚡';
    } else if (pctNum > 5) {
        stage = '小量轉換';
        stageColor = '#2196f3';
        stageIcon = '📈';
    }
    
    // 融資融券最新資料
    let marginInfo = '';
    if (marginData.length > 0) {
        const latestMargin = marginData[marginData.length - 1];
        const firstMargin = marginData.length > 1 ? marginData[0] : latestMargin;
        const shortRatio = latestMargin.marginBalance > 0 ? 
            (latestMargin.shortBalance / latestMargin.marginBalance * 100).toFixed(1) : 0;
        
        // 計算期間變化
        const marginChange = latestMargin.marginBalance - firstMargin.marginBalance;
        const shortChange = latestMargin.shortBalance - firstMargin.shortBalance;
        
        marginInfo = `
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-top:12px; padding-top:12px; border-top:1px solid #eee;">
                <div style="text-align:center;">
                    <div style="font-size:11px; color:#888;">融資餘額</div>
                    <div style="font-size:16px; font-weight:600; color:#c62828;">${latestMargin.marginBalance?.toLocaleString() || '-'}</div>
                    <div style="font-size:10px; color:${marginChange >= 0 ? '#c62828' : '#2e7d32'};">
                        ${marginChange >= 0 ? '+' : ''}${marginChange.toLocaleString()}張
                    </div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:11px; color:#888;">融券餘額</div>
                    <div style="font-size:16px; font-weight:600; color:#2e7d32;">${latestMargin.shortBalance?.toLocaleString() || '-'}</div>
                    <div style="font-size:10px; color:${shortChange >= 0 ? '#2e7d32' : '#c62828'};">
                        ${shortChange >= 0 ? '+' : ''}${shortChange.toLocaleString()}張
                    </div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:11px; color:#888;">券資比</div>
                    <div style="font-size:16px; font-weight:600; color:#9c27b0;">${shortRatio}%</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:11px; color:#888;">約當股票</div>
                    <div style="font-size:16px; font-weight:600; color:#ff9800;">${Math.round(equivStockShares).toLocaleString()}</div>
                    <div style="font-size:10px; color:#999;">張</div>
                </div>
            </div>`;
    } else {
        marginInfo = `
            <div style="margin-top:12px; padding:12px; background:#f5f5f5; border-radius:8px; text-align:center; font-size:12px; color:#666;">
                📊 融資融券資料載入中...（首次載入約需20秒）
            </div>`;
        
        // v3.97-du: 如果融資融券還沒載入，背景觸發載入
        if (!window.marginData?.loaded && !window.marginData?.loading) {
            loadMarginData();
        }
    }
    
    const statusIcon = cbInfo?.isListed ? '🟢' : '⚫';
    const statusText = cbInfo?.isListed ? '掛牌中' : '已下市';
    
    summary.style.display = 'block';
    summary.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <div>
                <div style="font-size:18px; font-weight:700; color:#333;">
                    ${statusIcon} ${cbInfo?.cbCode || ''} ${latest.cbName}
                </div>
                <div style="font-size:13px; color:#888;">
                    ${latest.stockCode} ${latest.stockName} | 轉換價 ${convPrice} 元 | 換股比例 ${convRatio.toFixed(2)} | ${statusText}
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:14px; color:${stageColor}; font-weight:600;">${stageIcon} ${stage}</div>
            </div>
        </div>
        
        <!-- v3.97-dz: 轉換動能指標 -->
        <div style="background:linear-gradient(135deg, ${momentumColor}15, ${momentumColor}05); border-left:4px solid ${momentumColor}; border-radius:8px; padding:12px 16px; margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:12px; color:#666;">轉換動能</div>
                    <div style="font-size:20px; font-weight:700; color:${momentumColor};">
                        ${momentumIcon} ${momentum}分 <span style="font-size:14px;">(${momentumLevel})</span>
                    </div>
                    <div style="font-size:12px; color:#888;">${momentumDesc}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:11px; color:#888;">連續下降 <b style="color:${momentumColor};">${consecutiveDecline}</b> 週</div>
                    <div style="font-size:11px; color:#888;">累積轉換 <b style="color:${momentumColor};">${totalDeclineShares.toLocaleString()}</b> 張</div>
                    <div style="font-size:11px; color:#888;">週均轉換 <b style="color:${momentumColor};">${Math.round(avgWeeklyDecline).toLocaleString()}</b> 張</div>
                </div>
            </div>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px;">
            <div style="text-align:center; padding:12px 8px; background:#f8f9fa; border-radius:8px;">
                <div style="font-size:11px; color:#888;">發行張數</div>
                <div style="font-size:16px; font-weight:700; color:#333;">${issueShares.toLocaleString()}</div>
                <div style="font-size:10px; color:#999;">張</div>
            </div>
            <div style="text-align:center; padding:12px 8px; background:#f8f9fa; border-radius:8px;">
                <div style="font-size:11px; color:#888;">目前餘額</div>
                <div style="font-size:16px; font-weight:700; color:#1976d2;">${balanceShares.toLocaleString()}</div>
                <div style="font-size:10px; color:#999;">張</div>
            </div>
            <div style="text-align:center; padding:12px 8px; background:#f8f9fa; border-radius:8px;">
                <div style="font-size:11px; color:#888;">已轉換</div>
                <div style="font-size:16px; font-weight:700; color:#e91e63;">${convertedShares.toLocaleString()}</div>
                <div style="font-size:10px; color:#999;">(${convertedPct}%)</div>
            </div>
            <div style="text-align:center; padding:12px 8px; background:#e8f5e9; border-radius:8px;">
                <div style="font-size:11px; color:#888;">區間轉換</div>
                <div style="font-size:16px; font-weight:700; color:#2e7d32;">${periodChange.toLocaleString()}</div>
                <div style="font-size:10px; color:#2e7d32;">(${periodChangePct}%)</div>
            </div>
            <div style="text-align:center; padding:12px 8px; background:#f8f9fa; border-radius:8px;">
                <div style="font-size:11px; color:#888;">週數據筆數</div>
                <div style="font-size:16px; font-weight:700; color:#666;">${cbData.length}</div>
                <div style="font-size:10px; color:#999;">筆</div>
            </div>
        </div>
        ${marginInfo}
    `;
}

/**
 * 繪製套利追蹤圖表
 * v3.97-ei: 智慧壓縮長期無變化區間，間隔顯示數值標籤
 */
function displayArbitrageChart(cbData, marginData) {
    const container = document.getElementById('arbitrageChart');
    
    // v3.97-eh: 過濾掉餘額為0的資料點（發行前的空白期間）
    let startIdx = 0;
    for (let i = 0; i < cbData.length; i++) {
        if (cbData[i].balance > 0) {
            startIdx = i;
            break;
        }
    }
    
    const validCbData = cbData.slice(startIdx);
    
    if (validCbData.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:#999; padding:40px;">
                <div style="font-size:24px;">📊</div>
                <div style="margin-top:8px;">無有效餘額資料</div>
            </div>`;
        return;
    }
    
    // v3.97-ei: 智慧壓縮 - 檢測長期無變化區間
    let compressedData = [];
    let compressInfo = null;
    let unchangedCount = 0;
    let lastValue = null;
    
    for (let i = 0; i < validCbData.length; i++) {
        const d = validCbData[i];
        const currentValue = d.balance || 0;
        
        if (lastValue !== null && currentValue === lastValue) {
            unchangedCount++;
        } else {
            // 值有變化，重置計數
            if (unchangedCount > 8) {
                // 前面有長期無變化，壓縮處理
                compressInfo = {
                    count: unchangedCount,
                    value: lastValue,
                    startDate: compressedData.length > 0 ? compressedData[compressedData.length - unchangedCount]?.dateStr : '',
                    endDate: validCbData[i-1]?.dateStr || ''
                };
            }
            unchangedCount = 0;
        }
        
        // 如果連續無變化超過8週，只保留頭尾和每4週一個點
        if (unchangedCount > 8 && unchangedCount % 4 !== 0 && i < validCbData.length - 1) {
            continue; // 跳過中間點
        }
        
        compressedData.push(d);
        lastValue = currentValue;
    }
    
    // 使用壓縮後的資料
    const displayData = compressedData.length > 0 ? compressedData : validCbData;
    
    // 準備資料
    const labels = displayData.map(d => {
        if (d.dateStr) {
            const parts = d.dateStr.split('/');
            return parts.length >= 3 ? `${parts[1]}/${parts[2]}` : d.dateStr;
        }
        const dateStr = String(d.date);
        return dateStr.slice(4, 6) + '/' + dateStr.slice(6, 8);
    });
    
    const cbBalanceData = displayData.map(d => d.balance || 0);
    
    // 合併融資融券資料
    const marginMap = {};
    marginData.forEach(m => { marginMap[m.date] = m; });
    
    const marginBalanceData = displayData.map(d => marginMap[d.date]?.marginBalance || null);
    const shortBalanceData = displayData.map(d => marginMap[d.date]?.shortBalance || null);
    
    // v3.97-ei: 計算顯示數值的間隔（避免重疊）
    const totalPoints = displayData.length;
    const labelInterval = totalPoints <= 10 ? 1 : 
                          totalPoints <= 20 ? 2 : 
                          totalPoints <= 40 ? 4 : 
                          totalPoints <= 60 ? 6 : 8;
    
    // 建立圖表提示訊息
    let chartNote = '';
    if (compressInfo && compressInfo.count > 8) {
        chartNote = `<div style="text-align:center; font-size:11px; color:#888; margin-bottom:8px; padding:6px; background:#f5f5f5; border-radius:6px;">
            📋 期間 ${compressInfo.startDate?.slice(5) || ''} ~ ${compressInfo.endDate?.slice(5) || ''} 連續 ${compressInfo.count} 週餘額無變化 (${compressInfo.value?.toLocaleString()} 張)，已壓縮顯示
        </div>`;
    }
    
    container.innerHTML = `${chartNote}<canvas id="arbitrageChartCanvas" style="width:100%; height:280px;"></canvas>`;
    
    const ctx = document.getElementById('arbitrageChartCanvas').getContext('2d');
    
    // v3.97-ei: 自定義插件 - 在數據點上顯示數值
    const dataLabelPlugin = {
        id: 'dataLabels',
        afterDatasetsDraw: (chart) => {
            const ctx = chart.ctx;
            chart.data.datasets.forEach((dataset, datasetIndex) => {
                // 只為 CB 餘額顯示標籤（第一個 dataset）
                if (datasetIndex !== 0) return;
                
                const meta = chart.getDatasetMeta(datasetIndex);
                meta.data.forEach((point, index) => {
                    // 間隔顯示 + 首尾必顯示
                    const isFirst = index === 0;
                    const isLast = index === dataset.data.length - 1;
                    const isInterval = index % labelInterval === 0;
                    
                    // 檢查是否有變化（與前一個值不同）
                    const hasChange = index > 0 && dataset.data[index] !== dataset.data[index - 1];
                    
                    if (isFirst || isLast || isInterval || hasChange) {
                        const value = dataset.data[index];
                        if (value === null || value === undefined) return;
                        
                        ctx.save();
                        ctx.font = 'bold 10px Arial';
                        ctx.fillStyle = '#9c27b0';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        
                        // 格式化數值
                        let displayValue;
                        if (value >= 10000) {
                            displayValue = (value / 10000).toFixed(1) + '萬';
                        } else if (value >= 1000) {
                            displayValue = (value / 1000).toFixed(1) + 'k';
                        } else {
                            displayValue = value.toLocaleString();
                        }
                        
                        ctx.fillText(displayValue, point.x, point.y - 5);
                        ctx.restore();
                    }
                });
            });
        }
    };
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'CB餘額(張)',
                    data: cbBalanceData,
                    borderColor: '#9c27b0',
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3,
                    yAxisID: 'y',
                    pointRadius: totalPoints <= 30 ? 4 : 2,
                    pointHoverRadius: 6
                },
                {
                    label: '融資餘額(張)',
                    data: marginBalanceData,
                    borderColor: '#c62828',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y1',
                    pointRadius: 0
                },
                {
                    label: '融券餘額(張)',
                    data: shortBalanceData,
                    borderColor: '#2e7d32',
                    borderWidth: 2,
                    borderDash: [3, 3],
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y1',
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { font: { size: 11 } }
                },
                title: {
                    display: true,
                    text: `${cbData[0]?.cbName || ''} 套利追蹤`,
                    font: { size: 14, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toLocaleString() + ' 張';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { 
                        font: { size: 10 }, 
                        maxRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: 15
                    }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'CB餘額(張)', font: { size: 11 } },
                    ticks: { font: { size: 10 } }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: '融資/融券(張)', font: { size: 11 } },
                    ticks: { font: { size: 10 } },
                    grid: { drawOnChartArea: false }
                }
            }
        },
        plugins: [dataLabelPlugin]
    });
}

/**
 * 載入轉換熱門榜
 * 支援排序和篩選
 */
/**
 * v3.97-ec: 顯示轉換價值分析
 * 仿照 XQ 的轉換價值畫面
 */
async function displayConversionValueAnalysis(cbCode, cbInfo) {
    const section = document.getElementById('conversionValueSection');
    const summaryDiv = document.getElementById('convValueSummary');
    const chartDiv = document.getElementById('convValueChart');
    const tableDiv = document.getElementById('convValueTable');
    
    if (!cbCode || !cbInfo) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    // 從看板資料取得 CB 價格歷史
    const stockCode = cbInfo.stockCode;
    const convPrice = cbInfo.convPrice || 0;
    const convRatio = convPrice > 0 ? (100 / convPrice) : 0;  // 每張CB可換幾股
    const redemptionPrice = convPrice * 1.3;  // 130% 強制贖回價
    
    // 嘗試從看板資料取得最新價格
    let cbPrice = 0;
    let stockPrice = 0;
    let cbPriceHistory = [];
    
    // 從 kanbanData 取得 CB 價格
    if (window.kanbanData?.loaded) {
        const cbKanban = window.kanbanData.data.find(k => k.cbCode === cbCode);
        if (cbKanban) {
            cbPrice = cbKanban.cbPrice || 0;
            stockPrice = cbKanban.stockPrice || 0;
        }
    }
    
    // 計算轉換價值和溢價率
    const conversionValue = stockPrice * convRatio;  // 轉換價值 = 股價 × 換股比例
    const premiumRate = conversionValue > 0 ? ((cbPrice - conversionValue) / conversionValue * 100) : 0;
    
    // 轉換價值狀態判斷
    let convStatus = '價外';
    let convStatusColor = '#666';
    let convStatusIcon = '⚪';
    
    if (stockPrice >= redemptionPrice) {
        convStatus = '觸及贖回';
        convStatusColor = '#c62828';
        convStatusIcon = '🔴';
    } else if (stockPrice >= convPrice) {
        convStatus = '價內';
        convStatusColor = '#4caf50';
        convStatusIcon = '🟢';
    } else if (stockPrice >= convPrice * 0.9) {
        convStatus = '接近轉換價';
        convStatusColor = '#ff9800';
        convStatusIcon = '🟡';
    }
    
    // 顯示摘要
    summaryDiv.innerHTML = `
        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-bottom:12px;">
            <div style="text-align:center; padding:12px 8px; background:linear-gradient(135deg, #e3f2fd, #fff); border-radius:8px; border:1px solid #1976d2;">
                <div style="font-size:11px; color:#1976d2;">CB收盤價</div>
                <div style="font-size:20px; font-weight:700; color:#1976d2;">${cbPrice > 0 ? cbPrice.toFixed(2) : '-'}</div>
                <div style="font-size:10px; color:#888;">元</div>
            </div>
            <div style="text-align:center; padding:12px 8px; background:linear-gradient(135deg, #fff3e0, #fff); border-radius:8px; border:1px solid #ff9800;">
                <div style="font-size:11px; color:#e65100;">標的股價</div>
                <div style="font-size:20px; font-weight:700; color:#e65100;">${stockPrice > 0 ? stockPrice.toFixed(2) : '-'}</div>
                <div style="font-size:10px; color:#888;">元</div>
            </div>
            <div style="text-align:center; padding:12px 8px; background:linear-gradient(135deg, #e8f5e9, #fff); border-radius:8px; border:1px solid #4caf50;">
                <div style="font-size:11px; color:#2e7d32;">轉換價值</div>
                <div style="font-size:20px; font-weight:700; color:#2e7d32;">${conversionValue > 0 ? conversionValue.toFixed(2) : '-'}</div>
                <div style="font-size:10px; color:#888;">元</div>
            </div>
            <div style="text-align:center; padding:12px 8px; background:linear-gradient(135deg, ${premiumRate > 20 ? '#ffebee' : premiumRate > 0 ? '#fff3e0' : '#e8f5e9'}, #fff); border-radius:8px; border:1px solid ${premiumRate > 20 ? '#c62828' : premiumRate > 0 ? '#ff9800' : '#4caf50'};">
                <div style="font-size:11px; color:${premiumRate > 20 ? '#c62828' : premiumRate > 0 ? '#e65100' : '#2e7d32'};">轉換溢價率</div>
                <div style="font-size:20px; font-weight:700; color:${premiumRate > 20 ? '#c62828' : premiumRate > 0 ? '#e65100' : '#2e7d32'};">${premiumRate.toFixed(2)}%</div>
                <div style="font-size:10px; color:#888;">${premiumRate > 30 ? '偏高' : premiumRate > 15 ? '適中' : '偏低'}</div>
            </div>
        </div>
        
        <!-- 關鍵價格線 -->
        <div style="background:#f8f9fa; border-radius:8px; padding:12px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
            <div style="text-align:center; flex:1; min-width:100px;">
                <div style="font-size:11px; color:#888;">轉換價</div>
                <div style="font-size:16px; font-weight:600; color:#333;">${convPrice.toFixed(2)}</div>
            </div>
            <div style="text-align:center; flex:1; min-width:100px;">
                <div style="font-size:11px; color:#888;">130%贖回價</div>
                <div style="font-size:16px; font-weight:600; color:#c62828;">${redemptionPrice.toFixed(2)}</div>
            </div>
            <div style="text-align:center; flex:1; min-width:100px;">
                <div style="font-size:11px; color:#888;">換股比例</div>
                <div style="font-size:16px; font-weight:600; color:#666;">${convRatio.toFixed(4)}</div>
            </div>
            <div style="text-align:center; flex:1; min-width:100px; padding:8px; background:${convStatusColor}15; border-radius:6px;">
                <div style="font-size:11px; color:#888;">轉換狀態</div>
                <div style="font-size:16px; font-weight:600; color:${convStatusColor};">${convStatusIcon} ${convStatus}</div>
            </div>
        </div>
    `;
    
    // 如果有每日價格資料，顯示圖表和表格
    // 目前先顯示提示，日後可以整合看板歷史資料
    chartDiv.innerHTML = `
        <div style="text-align:center; padding:20px; color:#888; font-size:13px;">
            <div style="margin-bottom:8px;">📈 轉換溢價率走勢</div>
            <div style="font-size:12px; color:#aaa;">（需整合看板歷史資料）</div>
        </div>
    `;
    
    tableDiv.innerHTML = '';
}

let hotListSortField = 'convertedPct';
let hotListSortDir = 'desc';

async function loadArbitrageHotList() {
    const container = document.getElementById('arbitrageHotList');
    container.style.display = 'block';
    container.innerHTML = `
        <div style="text-align:center; padding:40px;">
            <div style="font-size:24px;">⏳</div>
            <div style="color:#666; margin-top:8px;">載入熱門榜...</div>
        </div>`;
    
    document.getElementById('arbitrageSummary').style.display = 'none';
    document.getElementById('arbitragePeriodSelector').style.display = 'none';
    document.getElementById('arbitrageChart').innerHTML = '';
    currentArbitrageCB = null;
    
    try {
        // 確保資料已載入
        if (arbitrageFullList.length === 0) {
            await initArbitrageModule();
        }
        
        // 只顯示掛牌中且有一定轉換率的CB
        let hotList = arbitrageFullList.filter(c => c.isListed && c.convertedPct > 0);
        
        // 排序
        hotList.sort((a, b) => {
            let aVal = a[hotListSortField] || 0;
            let bVal = b[hotListSortField] || 0;
            return hotListSortDir === 'desc' ? bVal - aVal : aVal - bVal;
        });
        
        // 取前30名
        hotList = hotList.slice(0, 30);
        
        if (hotList.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">無資料</div>';
            return;
        }
        
        const getSortIcon = (field) => {
            if (hotListSortField !== field) return '';
            return hotListSortDir === 'desc' ? ' ▼' : ' ▲';
        };
        
        let html = `
            <div style="padding:12px 16px; background:#9c27b0; color:white; font-weight:600; display:flex; justify-content:space-between; align-items:center;">
                <span>🔥 轉換熱門榜（掛牌中）</span>
                <span style="font-size:11px; opacity:0.9;">點擊表頭排序 | 點擊列查看詳情</span>
            </div>
            <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px; min-width:600px;">
                <thead>
                    <tr style="background:#f5f5f5;">
                        <th style="padding:10px; text-align:left; width:30px;">#</th>
                        <th class="arb-sortable" onclick="sortHotList('cbCode')" style="padding:10px; text-align:left; cursor:pointer;">
                            CB代號${getSortIcon('cbCode')}
                        </th>
                        <th class="arb-sortable" onclick="sortHotList('cbName')" style="padding:10px; text-align:left; cursor:pointer;">
                            CB名稱${getSortIcon('cbName')}
                        </th>
                        <th style="padding:10px; text-align:left;">股票</th>
                        <th class="arb-sortable" onclick="sortHotList('issueShares')" style="padding:10px; text-align:right; cursor:pointer;">
                            發行${getSortIcon('issueShares')}
                        </th>
                        <th class="arb-sortable" onclick="sortHotList('balanceShares')" style="padding:10px; text-align:right; cursor:pointer;">
                            餘額${getSortIcon('balanceShares')}
                        </th>
                        <th class="arb-sortable" onclick="sortHotList('convertedPct')" style="padding:10px; text-align:right; cursor:pointer;">
                            轉換率${getSortIcon('convertedPct')}
                        </th>
                    </tr>
                </thead>
                <tbody>`;
        
        hotList.forEach((cb, idx) => {
            const convertedShares = cb.issueShares - cb.balanceShares;
            const bgColor = idx % 2 === 0 ? '#fff' : '#fafafa';
            
            // 轉換率顏色
            let pctColor = '#666';
            if (cb.convertedPct > 80) pctColor = '#4caf50';
            else if (cb.convertedPct > 50) pctColor = '#ff9800';
            else if (cb.convertedPct > 20) pctColor = '#e91e63';
            
            html += `
                <tr style="background:${bgColor}; cursor:pointer;" onclick="document.getElementById('arbitrageCBSelect').value='${cb.cbCode}'; loadArbitrageData('${cb.cbCode}');">
                    <td style="padding:10px; font-weight:600; color:#888;">${idx + 1}</td>
                    <td style="padding:10px; color:#666; font-family:monospace;">${cb.cbCode}</td>
                    <td style="padding:10px; font-weight:600;">${cb.cbName}</td>
                    <td style="padding:10px; color:#666; font-size:12px;">${cb.stockCode} ${cb.stockName}</td>
                    <td style="padding:10px; text-align:right; font-size:12px;">${cb.issueShares.toLocaleString()}</td>
                    <td style="padding:10px; text-align:right; color:#1976d2; font-weight:600;">${cb.balanceShares.toLocaleString()}</td>
                    <td style="padding:10px; text-align:right; color:${pctColor}; font-weight:700;">${cb.convertedPct.toFixed(1)}%</td>
                </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('載入熱門榜失敗:', error);
        container.innerHTML = `<div style="padding:20px; text-align:center; color:#c62828;">載入失敗: ${error.message}</div>`;
    }
}

/**
 * 熱門榜排序
 */
function sortHotList(field) {
    if (hotListSortField === field) {
        hotListSortDir = hotListSortDir === 'desc' ? 'asc' : 'desc';
    } else {
        hotListSortField = field;
        hotListSortDir = 'desc';
    }
    loadArbitrageHotList();
}

// 系統啟動
window.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    initResizer();
    // v3.73 修正：initQuickSelect 移到 initializeUI 中，確保資料已載入
    // v3.97-zs-bf：移除強制贖回預載入（已整合到 kanbanData CSV）

    // v3.97-dr: 簡化預載入，只載入必要資料
    setTimeout(() => {
        // 預載入週餘額資料（約 40MB）- 套利追蹤需要
        if (!window.weeklyBalanceData?.loaded && !window.weeklyBalanceData?.loading) {
            loadWeeklyBalanceData();
        }
    }, 3000);
    
    // v3.97-dr: CB價格資料延後更多，避免同時載入
    setTimeout(() => {
        if (!window.cbPriceData?.loaded && !window.cbPriceData?.loading) {
            loadCBPriceData();
        }
    }, 8000);
    
    // v3.97-dr: 融資融券不自動載入，改為在套利頁面選擇CB時才載入
});
</script>

</body>
</html>
```
