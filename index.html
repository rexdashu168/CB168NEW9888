<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.49 (å„ªåŒ–å®Œå–„ç‰ˆ)</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="embedded_data.js" onerror="console.warn('embedded_data.js not found, using defaults.')"></script>

<style>
/* ================= v3.48 åŸå§‹é¢¨æ ¼åŸºç¤ (ä¿ç•™åŸå‘³) ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #000; }
.container { max-width: 1600px; margin: 0 auto; }
.header { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
.header::before { content: ""; position: absolute; top: 0; left: 0; width: 10px; height: 100%; background: #9C27B0; }
.header h1 { color: #4a148c; font-size: 32px; margin-bottom: 10px; font-weight: 900; } /* å­—é«”åŠ æ·± */
.header .subtitle { color: #444; font-size: 16px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
.version-badge { display: inline-block; background: #7B1FA2; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; }

.evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
.input-panel { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }
.input-panel h2 { color: #4a148c; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; font-weight: 800; }

.form-section { margin-bottom: 25px; }
.form-section h3 { color: #000; font-size: 16px; margin-bottom: 15px; font-weight: 900; border-left: 4px solid #667eea; padding-left: 10px; }
.form-group { margin-bottom: 15px; position: relative; } /* ç‚ºæ­·å²æœå°‹å®šä½ */
.form-group label { display: block; color: #333; font-size: 15px; margin-bottom: 8px; font-weight: 700; }
.form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #999; border-radius: 8px; font-size: 16px; color: #000; font-weight: 600; transition: border-color 0.3s; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; background: #fcfdff; }

/* è­¦ç¤ºèªæ¨£å¼ */
.warning-box { font-size: 13px; color: #c62828; margin-top: 5px; font-weight: bold; display: flex; align-items: center; gap: 5px; background: #ffebee; padding: 8px; border-radius: 6px; }

/* æ­·å²è³‡æ–™æœå°‹çµæœ */
.history-results { 
    max-height: 250px; overflow-y: auto; background: #fdfdfd; 
    border: 2px solid #667eea; border-radius: 0 0 8px 8px; 
    margin-top: -2px; display: none; padding: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.history-item { 
    background: #f3e5f5; border-left: 4px solid #9c27b0; 
    padding: 10px; margin-bottom: 8px; border-radius: 4px; font-size: 13px;
}
.history-item .title { font-weight: 900; color: #4a148c; display: flex; justify-content: space-between; margin-bottom: 5px; }
.history-item .data-row { display: flex; justify-content: space-between; color: #333; }

/* ä¸»è§€æ¬Šé‡èªªæ˜å€ */
.subjective-note {
    background: linear-gradient(to right, #fff8e1, #fff);
    border-left: 4px solid #ff9800;
    padding: 12px;
    margin-bottom: 15px;
    font-size: 13px;
    color: #5d4037;
    line-height: 1.5;
    border-radius: 4px;
}

.calculate-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: 900; cursor: pointer; transition: all 0.2s; margin-top: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); filter: brightness(1.1); }

.result-panel { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px; }
.result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; }

/* ================= 3.49 è¡¨æ ¼å„ªåŒ– (é‡é») ================= */
.data-table { width: 100%; border-collapse: collapse; font-size: 15px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.data-table th { 
    background-color: #1A237E; color: white; padding: 12px 5px; 
    text-align: center; font-weight: 900; border: 1px solid #0d1b5e; 
    vertical-align: middle; line-height: 1.3; /* è®“å…©è¡Œå­—æ›´ç·Šæ¹Š */
}
.data-table td { 
    padding: 12px 10px; border: 1px solid #ccc; color: #000; font-weight: 600; 
}
/* æ•¸å­—æ¬„ä½é å³å°é½Š (ç¬¬3æ¬„é–‹å§‹) */
.data-table td:nth-child(n+3) { text-align: right; font-family: 'Segoe UI', monospace; }
.data-table tr:nth-child(even) { background-color: #f5f5f5; }
.data-table tfoot td { background-color: #e8eaf6; font-weight: 900; color: #1A237E; border-top: 2px solid #3f51b5; }

/* ç­–ç•¥å¡ç‰‡ */
.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; text-align: center; }
.strategy-card .price { font-size: 32px; font-weight: 900; margin: 10px 0; color: #000; }

@media (max-width: 1200px) { .evaluation-container { grid-template-columns: 1fr; } }
</style>
</head>

<body>
<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white;">
    <div style="font-size: 40px;">ğŸ”„</div>
    <div style="font-size: 24px; font-weight: bold; margin-top: 10px;">ç³»çµ±å„ªåŒ–è¼‰å…¥ä¸­ (v3.49)...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.49 å„ªåŒ–å®Œå–„ç‰ˆ</span></h1>
        <div class="subtitle">
            <span>Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</span>
            <span style="color:#ddd">|</span>
            <span id="headerSubtitle">è³‡æ–™åº«é€£ç·šä¸­...</span>
        </div>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™ (æ”¯æ´æ­·å²æœå°‹)</h3>
                    <div class="form-group">
                        <label>CBåç¨± / ä»£è™Ÿ *</label>
                        <input type="text" id="cbName" required placeholder="è¼¸å…¥ 2368 æˆ– é‡‘åƒé›»..." autocomplete="off">
                        <div id="historyResults" class="history-results"></div> </div>
                    <div class="form-group"><label>è‚¡æœ¬ (å„„å…ƒ) *</label><input type="number" id="capital" step="0.01" required></div>
                    <div class="form-group"><label>ç”¢æ¥­åˆ†é¡ *</label><select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select></div>
                    <div class="form-group"><label>ç™¼è¡Œåˆ¸å•†</label><select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select></div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group"><label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label><input type="number" id="issueSize" step="0.1" required></div>
                    <div class="form-group"><label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label><input type="number" id="conversionPrice" step="0.01" required></div>
                    <div class="form-group"><label>ç™¼è¡Œå¹´æœŸ *</label><select id="years" required><option value="3">3å¹´æœŸ</option><option value="5">5å¹´æœŸ</option><option value="7">7å¹´æœŸ</option></select></div>
                    <div class="form-group"><label>æ“”ä¿æƒ…æ³ *</label><select id="guarantee" required><option value="">è«‹é¸æ“‡...</option><option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option><option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option></select></div>
                    <div class="form-group"><label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label><select id="rating" required><option value="">è«‹é¸æ“‡...</option><option value="1">TCRI 1</option><option value="2">TCRI 2</option><option value="3">TCRI 3</option><option value="4">TCRI 4</option><option value="5">TCRI 5</option><option value="6">TCRI 6</option><option value="7">TCRI 7</option><option value="8">TCRI 8</option><option value="9">TCRI 9</option><option value="BBB">BBBç´š</option></select></div>
                </div>

                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                    <div class="form-group">
                        <label>ç«¶æ‹æˆªæ­¢æ—¥ 13:30 æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="è«‹è¼¸å…¥æ”¶ç›¤åƒ¹">
                        <div class="warning-box">
                            âš ï¸ Rexå¤§å”æé†’ï¼šå»ºè­°æ–¼ 13:00 å¾Œå†é€²è¡Œæœ€çµ‚è©¦ç®—ã€‚ç†è«–åƒ¹æ ¼éš¨è‚¡åƒ¹æ³¢å‹•ï¼Œéæ—©è¨ˆç®—å¯èƒ½å¤±æº–ï¼Œè«‹å‹™å¿…ä»¥æˆªæ¨™å‰åƒ¹æ ¼ç‚ºæº–ã€‚
                        </div>
                    </div>
                </div>

                <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 20px;">
                    <h3 style="color: #e65100; border-left:none; padding-left:0;">âš–ï¸ ä¸»è§€æ¬Šé‡èª¿æ•´</h3>
                    
                    <div class="subjective-note">
                        <strong>ğŸ’¡ Rexå¤§å”è²¼å¿ƒè¨­è¨ˆï¼š</strong><br>
                        æ­¤åŠŸèƒ½å…è¨±æ‚¨å°‡ã€Œå€‹äººç«¶æ‹ç¶“é©—ã€èˆ‡ã€Œå¸‚å ´çµ±è¨ˆæ•¸æ“šã€çµåˆã€‚<br>
                        â€¢ è‹¥æ‚¨åå¥½ç´”æ•¸æ“šå®¢è§€åˆ†æï¼Œè«‹ç¶­æŒ 0ã€‚<br>
                        â€¢ è‹¥æ‚¨å°è©²æ¨™çš„æœ‰ç¨åˆ°è¦‹è§£ï¼Œå¯èª¿æ•´æ¬Šé‡ä»¥ä¿®æ­£æœ€çµ‚ä¼°å€¼ã€‚
                    </div>

                    <div class="form-group"><label>ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label><input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0"></div>
                    <div class="form-group"><label>ä¸»è§€æœ€ä½æº¢åƒ¹ç‡ (%)</label><input type="number" id="subjectiveLowPremium" step="0.1" value="0"></div>
                    <div class="form-group"><label>ä¸»è§€å¹³å‡æº¢åƒ¹ç‡ (%)</label><input type="number" id="subjectiveAvgPremium" step="0.1" value="0"></div>
                </div>

                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹ AI è©•ä¼°</button>
            </form>
        </div>
        
        <div class="result-panel">
            <div id="welcomeMsg" style="text-align: center; padding: 60px 20px;">
                <h2>æ­¡è¿ä½¿ç”¨ AI æ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ± (v3.49)</h2>
                <p style="margin-top:10px; color:#666;">
                    âœ… æ­·å²è³‡æ–™å¼•æ“å·²å•Ÿå‹•<br>
                    âœ… è¡¨æ ¼ç¾å­¸èˆ‡å°ç¨±å„ªåŒ–
                </p>
                <div id="statsSummary" style="margin-top:20px; font-weight:bold; color:#4a148c;"></div>
            </div>
            <div id="evaluationResult" style="display:none;"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. è³‡æ–™è™•ç†èˆ‡è¨­å®š
// ==========================================
const FIELD_ALIASES = {
    'cbId': ['CBä»£è™Ÿ', 'ä»£è™Ÿ', 'è‚¡ç¥¨ä»£è™Ÿ'], 
    'name': ['åç¨±', 'CBåç¨±', 'å…¬å¸åç¨±'],
    'industry': ['ç”¢æ¥­åˆ†é¡', 'ç”¢æ¥­'], 
    'broker': ['ç™¼è¡Œåˆ¸å•†', 'æ‰¿éŠ·åˆ¸å•†'],
    'capital': ['è‚¡æœ¬', 'è‚¡æœ¬(å„„)'], 
    'issueSize': ['ç™¼è¡Œè¦æ¨¡', 'ç™¼è¡Œç¸½é¡'],
    'minBidPrice': ['æœ€ä½å¾—æ¨™', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼'], 
    'avgBidPrice': ['å¹³å‡å¾—æ¨™', 'å¹³å‡å¾—æ¨™åƒ¹æ ¼'],
    'lowPremium': ['æœ€ä½æº¢åƒ¹', 'æœ€ä½å¾—æ¨™æº¢åƒ¹'],
    'avgPremium': ['å¹³å‡æº¢åƒ¹', 'å¹³å‡å¾—æ¨™æº¢åƒ¹'],
    'marketHigh': ['æ›ç‰Œæœ€é«˜', 'æ›ç‰Œæœ€é«˜åƒ¹'],
    'marketLow': ['æ›ç‰Œæœ€ä½', 'æ›ç‰Œæœ€ä½åƒ¹']
};

let auctionRawData = [], cbDatabase = {}, statistics = { 'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} } };
let globalMarketStats = { low: 0, avg: 0 };

function normalizeKeys(obj) { const n={}; Object.keys(obj).forEach(k=>n[k.trim()]=obj[k]); return n; }
function getSmartValue(row, key) { if(!FIELD_ALIASES[key]) return undefined; for(let a of FIELD_ALIASES[key]) if(row[a]!==undefined) return row[a]; return undefined; }
function safeFloat(v) { const n=parseFloat(v); return isNaN(n)?0:n; }
function safeFixed(v,d=2) { const n=parseFloat(v); return isNaN(n)?'-':n.toFixed(d); }

// ==========================================
// 2. è³‡æ–™è¼‰å…¥
// ==========================================
async function loadData() {
    try {
        const res = await fetch('00_CB.xlsx');
        if(!res.ok) throw new Error("è®€å– Excel å¤±æ•—");
        const wb = XLSX.read(await res.arrayBuffer(), {type:'array'});
        
        const shAuc = wb.SheetNames.find(n => n.includes('04') || n.includes('ç«¶æ‹'));
        const shHl = wb.SheetNames.find(n => n.includes('00') || n.includes('æ›ç‰Œ'));
        
        const rawAuc = XLSX.utils.sheet_to_json(wb.Sheets[shAuc]);
        const rawHl = shHl ? XLSX.utils.sheet_to_json(wb.Sheets[shHl]) : [];
        const hlMap = {};
        
        rawHl.forEach(r => {
            const n = normalizeKeys(r);
            const id = String(n['ä»£è™Ÿ']||n['CBä»£è™Ÿ']||'').trim().replace('.0','');
            if(id) hlMap[id] = n;
        });

        auctionRawData = rawAuc.map(r => {
            const row = normalizeKeys(r);
            const id = String(row['ä»£è™Ÿ']||row['CBä»£è™Ÿ']||'').trim().replace('.0','');
            if(!id) return null;
            
            const hl = hlMap[id] || {};
            let lp = safeFloat(getSmartValue(row, 'lowPremium'));
            let ap = safeFloat(getSmartValue(row, 'avgPremium'));
            // ä¿®æ­£ç™¾åˆ†æ¯”å–®ä½
            if(Math.abs(lp)<2 && lp!==0) lp*=100;
            if(Math.abs(ap)<2 && ap!==0) ap*=100;

            return {
                id, name: getSmartValue(row, 'name'), 
                industry: getSmartValue(row, 'industry'), broker: getSmartValue(row, 'broker'),
                capital: safeFloat(getSmartValue(row, 'capital')), issueSize: safeFloat(getSmartValue(row, 'issueSize')),
                minBid: safeFloat(getSmartValue(row, 'minBidPrice')), avgBid: safeFloat(getSmartValue(row, 'avgBidPrice')),
                lowPrem: lp, avgPrem: ap,
                mkHigh: safeFloat(getSmartValue(hl, 'marketHigh')), mkLow: safeFloat(getSmartValue(hl, 'marketLow'))
            };
        }).filter(x=>x && x.minBid>0);

        // å»ºç«‹ç´¢å¼•èˆ‡çµ±è¨ˆ
        let sumL=0, sumA=0;
        auctionRawData.forEach(d => {
            cbDatabase[d.name] = d;
            sumL+=d.lowPrem; sumA+=d.avgPrem;
            
            ['industry','broker'].forEach(k => {
                const val = d[k]; if(!val) return;
                const cat = k==='industry'?'ç”¢æ¥­':'ç™¼è¡Œåˆ¸å•†';
                if(!statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val]) statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val] = {c:0, sL:0, sA:0};
                statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val].c++;
                statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val].sL+=d.lowPrem;
                statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val].sA+=d.avgPrem;
            });
        });
        if(auctionRawData.length>0) { globalMarketStats.low = sumL/auctionRawData.length; globalMarketStats.avg = sumA/auctionRawData.length; }

        initUI();
        document.getElementById('loading').style.display='none';
        document.querySelector('.container').style.display='block';

    } catch(e) {
        alert("ç³»çµ±å•Ÿå‹•å¤±æ•—: " + e.message);
    }
}

// ==========================================
// 3. UI äº’å‹•èˆ‡æ­·å²æœå°‹ (æ–°åŠŸèƒ½)
// ==========================================
function initUI() {
    document.getElementById('headerSubtitle').textContent = `è³‡æ–™åº«å°±ç·’ (æ¨£æœ¬æ•¸: ${auctionRawData.length})`;
    document.getElementById('statsSummary').textContent = `ç›®å‰è³‡æ–™åº«æ”¶éŒ„ ${auctionRawData.length} ç­†å®Œæ•´ç«¶æ‹æ•¸æ“š`;
    
    // å¡«å……é¸å–®
    const fill = (id, obj) => {
        const s=document.getElementById(id);
        Object.keys(obj).sort((a,b)=>obj[b].c-obj[a].c).forEach(k=>{
            s.add(new Option(`${k} (${obj[k].c})`, k));
        });
    };
    fill('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']);
    fill('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);

    // æ­·å²æœå°‹ç›£è½
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim();
        const resDiv = document.getElementById('historyResults');
        
        if(val.length < 2) { resDiv.style.display = 'none'; return; }
        
        // æ¨¡ç³Šæœå°‹: ä»£è™Ÿå‰4ç¢¼ æˆ– åç¨±å»é™¤æ•¸å­—
        const cleanVal = val.replace(/[0-9]/g, '');
        const matches = auctionRawData.filter(d => {
            return d.id.startsWith(val) || (cleanVal.length>1 && d.name.includes(cleanVal));
        }).sort((a,b) => b.id.localeCompare(a.id));

        if(matches.length > 0) {
            resDiv.innerHTML = `<div style="color:#667eea; font-weight:bold; margin-bottom:5px;">ğŸ” ç™¼ç¾ ${matches.length} ç­†æ­·å²è³‡æ–™ï¼š</div>` + 
            matches.map(d => `
                <div class="history-item">
                    <div class="title"><span>${d.id} ${d.name}</span> <span>${d.issueSize}å„„</span></div>
                    <div class="data-row">
                        <span>æœ€ä½æº¢åƒ¹: <b>${safeFixed(d.lowPrem)}%</b></span>
                        <span>å¹³å‡æº¢åƒ¹: <b>${safeFixed(d.avgPrem)}%</b></span>
                    </div>
                    <div class="data-row" style="margin-top:2px; font-size:12px; color:#666;">
                        <span>æ›ç‰Œé«˜/ä½: ${safeFixed(d.mkHigh)} / ${safeFixed(d.mkLow)}</span>
                    </div>
                </div>
            `).join('');
            resDiv.style.display = 'block';
        } else {
            resDiv.style.display = 'none';
        }
    });
}

// ==========================================
// 4. è¨ˆç®—æ ¸å¿ƒ & æŸ¥è©¢
// ==========================================
function getStats(cat, val) {
    let list = [], label = val;
    const v = parseFloat(val);

    // å€é–“é‚è¼¯
    if(cat==='è‚¡æœ¬') {
        if(v<3) { label='< 3å„„'; list=auctionRawData.filter(d=>d.capital<3); }
        else if(v<6) { label='3~6å„„'; list=auctionRawData.filter(d=>d.capital>=3 && d.capital<6); }
        else if(v<10) { label='6~10å„„'; list=auctionRawData.filter(d=>d.capital>=6 && d.capital<10); }
        else { label='> 10å„„'; list=auctionRawData.filter(d=>d.capital>=10); }
    } else if(cat==='ç™¼è¡Œè¦æ¨¡') {
        if(v<5) { label='< 5å„„'; list=auctionRawData.filter(d=>d.issueSize<5); }
        else if(v<10) { label='5~10å„„'; list=auctionRawData.filter(d=>d.issueSize>=5 && d.issueSize<10); }
        else { label='> 10å„„'; list=auctionRawData.filter(d=>d.issueSize>=10); }
    } else if(cat==='è½‰æ›åƒ¹') {
        if(v<100) { label='<100å…ƒ'; list=auctionRawData.filter(d=>d.convPrice<100); } // å‡è¨­æœ‰æ¬„ä½
        else { label='>100å…ƒ'; list=auctionRawData.filter(d=>d.convPrice>=100); } // ç°¡åŒ–
    } else {
        // æ–‡å­—æ¯”å°
        if(cat==='ç”¢æ¥­') list = auctionRawData.filter(d=>d.industry===val);
        else if(cat==='ç™¼è¡Œåˆ¸å•†') list = auctionRawData.filter(d=>(d.broker||'').includes(val));
    }

    if(list.length > 0) {
        const avgL = list.reduce((s,i)=>s+i.lowPrem,0)/list.length;
        const avgA = list.reduce((s,i)=>s+i.avgPrem,0)/list.length;
        return { low: avgL, avg: avgA, label: label, count: list.length };
    }
    return { low: globalMarketStats.low, avg: globalMarketStats.avg, label: label, count: 0, isFallback: true };
}

// ==========================================
// 5. çµæœé¡¯ç¤º (è¡¨æ ¼å„ªåŒ–ç‰ˆ)
// ==========================================
function displayResult(res) {
    document.getElementById('welcomeMsg').style.display = 'none';
    const div = document.getElementById('evaluationResult');
    div.style.display = 'block';

    let tableRows = '';
    res.details.forEach(d => {
        tableRows += `<tr>
            <td>${d.name}</td>
            <td>${d.displayVal}</td>
            <td>${safeFixed(d.stats.low)}%</td>
            <td>${safeFixed(d.stats.avg)}%</td>
            <td>${(d.weight*100).toFixed(0)}%</td>
            <td style="color:#1A237E; font-weight:bold;">${safeFixed(d.wLow)}</td>
            <td style="color:#1A237E; font-weight:bold;">${safeFixed(d.wAvg)}</td>
        </tr>`;
    });

    if(res.subW > 0) {
        tableRows += `<tr style="background:#fff3e0;">
            <td style="color:#e65100;">ä¸»è§€</td>
            <td>è‡ªè¨‚</td>
            <td>${res.subL}%</td>
            <td>${res.subA}%</td>
            <td>${res.subW}%</td>
            <td style="color:#e65100; font-weight:bold;">${res.wSubL.toFixed(2)}</td>
            <td style="color:#e65100; font-weight:bold;">${res.wSubA.toFixed(2)}</td>
        </tr>`;
    }

    const tHTML = `
    <div class="result-header">
        <h2>${res.name}</h2>
        <div style="font-size:18px; margin-top:10px;">ç†è«–åƒ¹æ ¼ï¼š${res.theoPrice} å…ƒ</div>
    </div>

    <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
        <h3 style="color:#1A237E; border-bottom:2px solid #1A237E; padding-bottom:10px; margin-bottom:15px;">ğŸ“Š ç¶­åº¦æ¬Šé‡åˆ†æ</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ç¶­åº¦</th>
                    <th>æ¢ä»¶</th>
                    <th>æœ€ä½<br>æº¢åƒ¹</th>
                    <th>å¹³å‡<br>æº¢åƒ¹</th>
                    <th>æ¬Šé‡</th>
                    <th>åŠ æ¬Š<br>æœ€ä½</th>
                    <th>åŠ æ¬Š<br>å¹³å‡</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
            <tfoot>
                <tr>
                    <td></td>
                    <td style="text-align:right; font-size:13px;">åˆè¨ˆ</td>
                    <td>-</td>
                    <td>-</td>
                    <td>100%</td>
                    <td style="text-align:right;">${res.finalLow}%</td>
                    <td style="text-align:right;">${res.finalAvg}%</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div style="margin-top:30px;">
        <h3 style="color:#1A237E; border-left:4px solid #1A237E; padding-left:10px;">ğŸ’¡ æŠ•æ¨™å»ºè­°åƒ¹æ ¼</h3>
        <div class="price-grid">
            <div class="strategy-card" style="border-color:#4CAF50; background:#E8F5E9;">
                <h4 style="color:#2E7D32;">ğŸ›¡ï¸ ä¿å®ˆä½ˆå±€</h4>
                <div class="price">${res.prices.p1}</div>
                <div style="color:#666; font-size:13px;">å®‰å…¨é‚Šéš›å„ªå…ˆ</div>
            </div>
            <div class="strategy-card" style="border-color:#FF9800; background:#FFF3E0;">
                <h4 style="color:#EF6C00;">âš–ï¸ å¹³è¡¡ç­–ç•¥</h4>
                <div class="price">${res.prices.p2}</div>
                <div style="color:#666; font-size:13px;">è²¼è¿‘å¸‚å ´å‡å€¼</div>
            </div>
            <div class="strategy-card" style="border-color:#F44336; background:#FFEBEE;">
                <h4 style="color:#C62828;">ğŸš€ ç©æ¥µæ¶æ¨™</h4>
                <div class="price">${res.prices.p3}</div>
                <div style="color:#666; font-size:13px;">æé«˜å¾—æ¨™ç‡</div>
            </div>
            <div class="strategy-card" style="border-color:#9C27B0; background:#F3E5F5;">
                <h4 style="color:#6A1B9A;">ğŸ”¥ æ¥µè‡´åƒ¹æ ¼</h4>
                <div class="price">${res.prices.p4}</div>
                <div style="color:#666; font-size:13px;">ç†±é–€æ¨™çš„é©ç”¨</div>
            </div>
        </div>
    </div>
    
    <button onclick="window.print()" class="calculate-btn" style="margin-top:30px; background:#555;">ğŸ–¨ï¸ åˆ—å°å ±å‘Š</button>
    `;

    div.innerHTML = tHTML;
    div.scrollIntoView({behavior:'smooth'});
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const getVal = (id) => document.getElementById(id).value;
    const getNum = (id) => parseFloat(document.getElementById(id).value)||0;

    const data = {
        name: getVal('cbName'),
        stock: getNum('stockPrice'), conv: getNum('conversionPrice'),
        subW: getNum('subjectiveWeight'), subL: getNum('subjectiveLowPremium'), subA: getNum('subjectiveAvgPremium')
    };

    const dims = [
        {k:'industry', n:'ç”¢æ¥­', v:getVal('industry'), w:0.25},
        {k:'broker', n:'åˆ¸å•†', v:getVal('broker'), w:0.13},
        {k:'capital', n:'è‚¡æœ¬', v:getNum('capital'), w:0.12},
        {k:'issueSize', n:'è¦æ¨¡', v:getNum('issueSize'), w:0.10},
        {k:'rating', n:'ä¿¡è©•', v:getVal('rating'), w:0.15},
        {k:'guarantee', n:'æ“”ä¿', v:getVal('guarantee'), w:0.12},
        {k:'years', n:'å¹´æœŸ', v:getVal('years'), w:0.08},
        {k:'conv', n:'è½‰åƒ¹', v:getNum('conversionPrice'), w:0.05}
    ];

    let sumWL=0, sumWA=0;
    const details = dims.map(d => {
        const s = getStats(d.n, d.v);
        const wL = s.low * d.w;
        const wA = s.avg * d.w;
        sumWL += wL; sumWA += wA;
        return { name:d.n, displayVal:s.label||d.v, stats:s, weight:d.w, wLow:wL, wAvg:wA };
    });

    // ä¸»è§€æ¬Šé‡è¨ˆç®—
    const sR = data.subW/100;
    const oR = 1 - sR;
    const wSubL = data.subL * sR;
    const wSubA = data.subA * sR;
    
    const finalL = (sumWL * oR) + wSubL;
    const finalA = (sumWA * oR) + wSubA;

    const theo = (data.stock / data.conv) * 100;
    
    displayResult({
        name: data.name, theoPrice: safeFixed(theo),
        details: details,
        subW: data.subW, subL: data.subL, subA: data.subA, wSubL: wSubL, wSubA: wSubA,
        finalLow: safeFixed(finalL), finalAvg: safeFixed(finalA),
        prices: {
            p1: safeFixed(theo*(1+finalL/100)),
            p2: safeFixed(theo*(1+finalA/100)),
            p3: safeFixed(theo*(1+(finalA + (finalA-finalL))/100)),
            p4: safeFixed(theo*(1+(finalA + (finalA-finalL)*2)/100))
        }
    });
});

window.onload = loadData;
</script>
</body>
</html>
