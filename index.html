<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.37 (é‚è¼¯ä¿®æ­£ç‰ˆ) - Rexå¤§å”</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="embedded_data.js"></script>

<style>
/* ================= é¢¨æ ¼è¨­å®š (ä¿æŒä¸è®Š) ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1600px; margin: 0 auto; }
.header { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
.header .subtitle { color: #666; font-size: 16px; }
.version-badge { display: inline-block; background: #D32F2F; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; font-weight: bold; }

.evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
.input-panel { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }
.input-panel h2 { color: #667eea; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }
.form-section { margin-bottom: 25px; }
.form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
.form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }

.info-box { background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 5px solid #4CAF50; margin-top: 10px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.stat-label { color: #555; font-weight: 500; }
.stat-value { font-weight: bold; color: #333; }

.calculate-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s; margin-top: 20px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }

.result-panel { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px; }
.welcome-message { text-align: center; padding: 60px 20px; }
.stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
.stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
.stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }

.evaluation-result { display: none; }
.evaluation-result.active { display: block; animation: fadeIn 0.5s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.detail-section { background: white; border-radius: 12px; padding: 30px; margin-bottom: 25px; border: 2px solid #e0e0e0; }
.detail-section h3 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; transition: transform 0.3s; }
.strategy-card:hover { transform: translateY(-5px); }
.strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
.strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
.strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
.strategy-card.ultimate { border-color: #9C27B0; background: #f3e5f5; }
.strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }

.data-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.data-table th { background-color: #1A237E; color: white; padding: 15px 10px; text-align: center; font-weight: bold; border: 1px solid #0d1b5e; }
.data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tr:hover { background-color: #e8eaf6; }
.val-pos { color: #d32f2f; font-weight: bold; }
.val-neg { color: #388e3c; font-weight: bold; }
.val-neu { color: #333; }

.rex-analysis { background: linear-gradient(to right, #fff3e0, #ffe0b2); border-left: 6px solid #ff9800; padding: 25px; border-radius: 8px; margin-top: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.rex-title { font-size: 20px; font-weight: bold; color: #e65100; margin-bottom: 15px; display: flex; align-items: center; }
.rex-content { color: #5d4037; line-height: 1.8; font-size: 15px; }
@media (max-width: 1200px) { .evaluation-container { grid-template-columns: 1fr; } .input-panel { position: relative; top: 0; } }
</style>
</head>

<body>
<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold;">
    <div>ğŸ”„ ç³»çµ±å•Ÿå‹•ä¸­ (v3.37)...</div>
    <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æ­£åœ¨è®€å– 04_ç«¶æ‹è³‡æ–™åº« èˆ‡ 00_æ›ç‰Œè¡Œæƒ…...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.37 ä¿®æ­£ç‰ˆ</span></h1>
        <p class="subtitle" id="headerSubtitle">è¼‰å…¥ä¸­...</p>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                    <div class="form-group"><label>CBåç¨± *</label><input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ"><div id="cbNameInfo" class="info-box"></div></div>
                    <div class="form-group"><label>è‚¡æœ¬ (å„„å…ƒ) *</label><input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80"><div id="capitalInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç”¢æ¥­åˆ†é¡ *</label><select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select><div id="industryInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç™¼è¡Œåˆ¸å•†</label><select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select><div id="brokerInfo" class="info-box"></div></div>
                </div>
                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group"><label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label><input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š90"><div id="issueSizeInfo" class="info-box"></div></div>
                    <div class="form-group"><label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label><input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š450"><div id="conversionPriceInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç™¼è¡Œå¹´æœŸ *</label><select id="years" required><option value="">è«‹é¸æ“‡...</option><option value="3">3å¹´æœŸ</option><option value="5">5å¹´æœŸ</option><option value="7">7å¹´æœŸ</option></select><div id="yearsInfo" class="info-box"></div></div>
                    <div class="form-group"><label>æ“”ä¿æƒ…æ³ *</label><select id="guarantee" required><option value="">è«‹é¸æ“‡...</option><option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option><option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option></select><div id="guaranteeInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label><select id="rating" required><option value="">è«‹é¸æ“‡...</option><option value="1">TCRI 1</option><option value="2">TCRI 2</option><option value="3">TCRI 3</option><option value="4">TCRI 4</option><option value="5">TCRI 5</option><option value="6">TCRI 6</option><option value="7">TCRI 7</option><option value="8">TCRI 8</option><option value="9">TCRI 9</option><option value="BBB">BBBç´š</option></select><div id="ratingInfo" class="info-box"></div></div>
                </div>
                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                    <div class="form-group"><label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label><input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5"></div>
                </div>
                <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 20px; margin: 25px 0;">
                    <h3 style="color: #e65100;">âš–ï¸ ä¸»è§€æ¬Šé‡èª¿æ•´ï¼ˆé¸å¡«ï¼‰</h3>
                    <div class="form-group"><label>ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label><input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0"></div>
                    <div class="form-group"><label>ä¸»è§€æœ€ä½æº¢åƒ¹ç‡ (%)</label><input type="number" id="subjectiveLowPremium" step="0.1" value="0"></div>
                    <div class="form-group"><label>ä¸»è§€å¹³å‡æº¢åƒ¹ç‡ (%)</label><input type="number" id="subjectiveAvgPremium" step="0.1" value="0"></div>
                </div>
                <div class="form-section"><h3>ğŸ“Š è¿‘æœŸå¸‚å ´ç«¶æ‹æ°›åœ</h3><div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;"><div class="stat-row">è«‹å…ˆé¸æ“‡ã€Œæ“”ä¿æƒ…æ³ã€</div></div></div>
                <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;"><div style="font-weight: bold; color: #856404;">ğŸ’¡ Rexå¤§å”çš„æ™ºæ…§æé†’</div><div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div></div>
                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
            </form>
        </div>
        <div class="result-panel">
            <div id="welcomeMsg" class="welcome-message"><h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ± (v3.37)</h2><p>âœ… ä¿®æ­£çµ±è¨ˆé‚è¼¯ï¼šæœ€ä½å¾—æ¨™ã€å¹³å‡å¾—æ¨™ã€æ›ç‰Œé«˜ä½ã€æŒ¯å¹…å®Œæ•´é¡¯ç¤º</p><div class="stats-summary" id="statsSummary"></div></div>
            <div id="evaluationResult" class="evaluation-result"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. æ¬„ä½è¨­å®š
// ==========================================
const FIELD_ALIASES = {
    'cbId': ['CBä»£è™Ÿ', 'ä»£è™Ÿ', 'è‚¡ç¥¨ä»£è™Ÿ'], 'name': ['åç¨±', 'CBåç¨±', 'å…¬å¸åç¨±'],
    'industry': ['ç”¢æ¥­åˆ†é¡', 'ç”¢æ¥­åˆ¥', 'ç”¢æ¥­'], 'broker': ['ç™¼è¡Œåˆ¸å•†', 'æ‰¿éŠ·åˆ¸å•†', 'ä¸»è¾¦åˆ¸å•†'],
    'guarantee': ['æ“”ä¿', 'æœ‰ç„¡æ“”ä¿', 'æ“”ä¿æƒ…å½¢'], 'rating': ['ä¿¡è©•', 'ä¿¡ç”¨æ“”ä¿', 'TCRI'],
    'capital': ['è‚¡æœ¬', 'è‚¡æœ¬è¦æ¨¡', 'è‚¡æœ¬(å„„)'], 'issueSize': ['ç™¼è¡Œè¦æ¨¡', 'ç™¼è¡Œç¸½é¡'],
    'years': ['å¹´æœŸ', 'ç™¼è¡Œå¹´æœŸ'], 'conversionPrice': ['è½‰æ›åƒ¹', 'è½‰æ›åƒ¹æ ¼'],
    'minBidPrice': ['æœ€ä½å¾—æ¨™', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼', 'æœ€ä½å¾—æ¨™åƒ¹'], 'lowPremium': ['æœ€ä½æº¢åƒ¹', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡', 'æœ€ä½å¾—æ¨™æº¢åƒ¹', 'æœ€ä½æº¢åƒ¹(%)'],
    'avgBidPrice': ['å¹³å‡å¾—æ¨™', 'å¹³å‡å¾—æ¨™åƒ¹æ ¼', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼', 'å¹³å‡å¾—æ¨™åƒ¹'], 'avgPremium': ['å¹³å‡æº¢åƒ¹', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡', 'å¹³å‡å¾—æ¨™æº¢åƒ¹', 'å¹³å‡æº¢åƒ¹(%)'],
    'marketHigh': ['æ›ç‰Œæœ€é«˜', 'æ›ç‰Œæœ€é«˜åƒ¹'], 'marketLow': ['æ›ç‰Œæœ€ä½', 'æ›ç‰Œæœ€ä½åƒ¹']
};

function getSmartValue(row, fieldKey) {
    if (!FIELD_ALIASES[fieldKey]) return undefined;
    for (let name of FIELD_ALIASES[fieldKey]) {
        if (row[name] !== undefined && row[name] !== null && row[name] !== '') return row[name];
    }
    return undefined;
}
function safeFloat(val) { const num = parseFloat(val); return isNaN(num) ? 0 : num; }
function getWeightCoefficient(category, value) {
    if (!window.WEIGHT_COEFFICIENTS || !window.WEIGHT_COEFFICIENTS[category]) return 1.0;
    return window.WEIGHT_COEFFICIENTS[category][value] ? window.WEIGHT_COEFFICIENTS[category][value].coefficient : 1.0;
}
function getBrokerName(cbName) {
    const found = auctionRawData.find(d => d['name'] === cbName);
    return (found && found['broker']) ? found['broker'] : (window.BROKER_MAPPING ? window.BROKER_MAPPING[cbName] : null);
}

let statistics = { 'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} }, 'è³‡æ–™æœŸé–“': {} };
let cbDatabase = {}, auctionRawData = [], globalMarketStats = { low: 0, avg: 0 }, cbNameMap = {};

// ==========================================
// 2. è³‡æ–™è®€å–
// ==========================================
async function loadStatistics() {
    const loadingDiv = document.getElementById('loading');
    try {
        const response = await fetch('00_CB.xlsx');
        if (!response.ok) throw new Error("æ‰¾ä¸åˆ° 00_CB.xlsx");
        const workbook = XLSX.read(await response.arrayBuffer(), { type: 'array' });
        const getSheetData = (k) => { const n = workbook.SheetNames.find(x => x.includes(k)); return n ? XLSX.utils.sheet_to_json(workbook.Sheets[n]) : []; };

        const sheetAuction = getSheetData('ç«¶æ‹'), sheetHighLow = getSheetData('æ›ç‰Œ') || getSheetData('åç¨±éæ¿¾');
        if (sheetAuction.length === 0) throw new Error("æ‰¾ä¸åˆ°ã€Œç«¶æ‹ã€åˆ†é ");

        const highLowMap = {};
        sheetHighLow.forEach(row => {
            let id = getSmartValue(row, 'cbId');
            if(id) highLowMap[String(id).replace('.0','').trim()] = row;
        });

        auctionRawData = sheetAuction.map(row => {
            let rawId = getSmartValue(row, 'cbId');
            if (!rawId) return null;
            const id = String(rawId).trim();
            const hlRow = highLowMap[id] || {};

            let lowPrem = safeFloat(getSmartValue(row, 'lowPremium'));
            let avgPrem = safeFloat(getSmartValue(row, 'avgPremium'));
            if (lowPrem !== 0 && Math.abs(lowPrem) < 2) lowPrem *= 100;
            if (avgPrem !== 0 && Math.abs(avgPrem) < 2) avgPrem *= 100;

            return {
                'id': id, 'name': getSmartValue(row, 'name'), 'industry': getSmartValue(row, 'industry'), 'broker': getSmartValue(row, 'broker'),
                'guarantee': getSmartValue(row, 'guarantee'), 'rating': getSmartValue(row, 'rating'),
                'capital': safeFloat(getSmartValue(row, 'capital')), 'issueSize': safeFloat(getSmartValue(row, 'issueSize')), 'years': safeFloat(getSmartValue(row, 'years')),
                'minBidPrice': safeFloat(getSmartValue(row, 'minBidPrice')), 'avgBidPrice': safeFloat(getSmartValue(row, 'avgBidPrice')),
                'lowPremium': lowPrem, 'avgPremium': avgPrem,
                'marketHigh': safeFloat(getSmartValue(hlRow, 'marketHigh')), 'marketLow': safeFloat(getSmartValue(hlRow, 'marketLow'))
            };
        }).filter(item => item !== null);

        auctionRawData.forEach(item => { if (item.name) { cbDatabase[item.name] = item; cbNameMap[item.name] = item; } });
        autoGenerateStatistics(); calculateGlobalMarketStats(); initializeUI();
        loadingDiv.style.display = 'none'; document.querySelector('.container').style.display = 'block';
    } catch (error) { console.error(error); loadingDiv.innerHTML = `<div style="padding:20px;background:white;color:red;">éŒ¯èª¤: ${error.message}</div>`; }
}

// ==========================================
// 3. çµ±è¨ˆæ ¸å¿ƒ (ä¿®æ­£ï¼šç¢ºä¿ç´¯åŠ é‚è¼¯æ­£ç¢º)
// ==========================================
function autoGenerateStatistics() {
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'] = {}; statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'] = {};
    auctionRawData.forEach(row => {
        if (row.industry) updateStatCategory('ç”¢æ¥­', row.industry, row);
        if (row.broker) updateStatCategory('ç™¼è¡Œåˆ¸å•†', row.broker, row);
    });

    ['ç”¢æ¥­', 'ç™¼è¡Œåˆ¸å•†'].forEach(cat => {
        Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ'][cat]).forEach(key => {
            const item = statistics['ç¶­åº¦çµ±è¨ˆ'][cat][key];
            if (item.count > 0) {
                item['å¹³å‡æœ€ä½æº¢åƒ¹'] = item.sumLowPrem / item.count; item['å¹³å‡æº¢åƒ¹'] = item.sumAvgPrem / item.count;
                item['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'] = item.sumLowPrice / item.count; item['å¹³å‡å¾—æ¨™åƒ¹'] = item.sumAvgPrice / item.count;
                item['å¹³å‡æ›ç‰Œæœ€é«˜'] = item.countMarket > 0 ? item.sumHigh / item.countMarket : 0;
                item['å¹³å‡æ›ç‰Œæœ€ä½'] = item.countMarket > 0 ? item.sumLow / item.countMarket : 0; // ç¢ºä¿æœ‰ç®—
                item['æ¨£æœ¬æ•¸'] = item.count;
            }
        });
    });
}

function updateStatCategory(category, key, row) {
    if (!statistics['ç¶­åº¦çµ±è¨ˆ'][category][key]) {
        statistics['ç¶­åº¦çµ±è¨ˆ'][category][key] = { count: 0, sumLowPrem: 0, sumAvgPrem: 0, sumLowPrice: 0, sumAvgPrice: 0, sumHigh: 0, sumLow: 0, countMarket: 0 };
    }
    const obj = statistics['ç¶­åº¦çµ±è¨ˆ'][category][key];
    if (row.lowPremium !== 0 || row.avgPremium !== 0) {
        obj.count++; obj.sumLowPrem += row.lowPremium; obj.sumAvgPrem += row.avgPremium;
        obj.sumLowPrice += row.minBidPrice; obj.sumAvgPrice += row.avgBidPrice;
    }
    // ä¿®æ­£ï¼šå¿…é ˆåŒæ™‚æœ‰æ›ç‰Œé«˜èˆ‡æ›ç‰Œä½æ‰åˆ—å…¥çµ±è¨ˆï¼Œç¢ºä¿æŒ¯å¹…è¨ˆç®—åˆç†
    if (row.marketHigh > 0 && row.marketLow > 0) {
        obj.sumHigh += row.marketHigh; obj.sumLow += row.marketLow; // ä¹‹å‰æ¼äº† sumLow
        obj.countMarket++;
    }
}

function calculateGlobalMarketStats() {
    let sumLow = 0, sumAvg = 0, count = 0;
    auctionRawData.forEach(d => { if (d.lowPremium !== 0) { sumLow += d.lowPremium; sumAvg += d.avgPremium; count++; } });
    if (count > 0) { globalMarketStats.low = (sumLow / count); globalMarketStats.avg = (sumAvg / count); }
}

function getStatsSmart(category, val) {
    let stats = { low: 0, avg: 0, usedFallback: false, rawData: null };
    let filterFn = null;
    if (category === 'ç™¼è¡Œåˆ¸å•†') filterFn = d => (d.broker||'').includes(val) || val.includes(d.broker||'');
    else if (category === 'ç”¢æ¥­') filterFn = d => d.industry === val;
    else if (category === 'æ“”ä¿') filterFn = d => (d.guarantee||'').includes(val);
    else if (category === 'å¹´æœŸ') filterFn = d => d.years == val;
    else if (category === 'ä¿¡è©•') filterFn = d => (d.rating||'').toString().includes(val.toString());
    else if (category === 'è‚¡æœ¬') { const v=parseFloat(val); if(v<3)filterFn=d=>d.capital<3; else if(v<6)filterFn=d=>d.capital>=3&&d.capital<6; else if(v>=20)filterFn=d=>d.capital>=20; else filterFn=d=>d.capital>=v&&d.capital<v+5; } 

    if (filterFn) {
        let sumLowP = 0, sumAvgP = 0, sumLowPr = 0, sumAvgPr = 0, sumH = 0, sumL = 0, countM = 0, count = 0;
        auctionRawData.filter(filterFn).forEach(d => {
            if (d.lowPremium !== 0) { sumLowP += d.lowPremium; sumAvgP += d.avgPremium; sumLowPr += d.minBidPrice; sumAvgPr += d.avgBidPrice; count++; }
            if (d.marketHigh > 0 && d.marketLow > 0) { sumH += d.marketHigh; sumL += d.marketLow; countM++; }
        });
        if (count > 0) {
            stats.rawData = { 
                'å¹³å‡æœ€ä½æº¢åƒ¹': sumLowP/count, 'å¹³å‡æº¢åƒ¹': sumAvgP/count, 'å¹³å‡æœ€ä½å¾—æ¨™åƒ¹': sumLowPr/count, 'å¹³å‡å¾—æ¨™åƒ¹': sumAvgPr/count,
                'å¹³å‡æ›ç‰Œæœ€é«˜': countM>0 ? sumH/countM : 0, 'å¹³å‡æ›ç‰Œæœ€ä½': countM>0 ? sumL/countM : 0, 'æ¨£æœ¬æ•¸': count 
            };
            stats.low = stats.rawData['å¹³å‡æœ€ä½æº¢åƒ¹']; stats.avg = stats.rawData['å¹³å‡æº¢åƒ¹'];
        }
    }
    // Fallback: éœæ…‹çµ±è¨ˆ
    if (stats.low === 0 && statistics['ç¶­åº¦çµ±è¨ˆ'][category] && statistics['ç¶­åº¦çµ±è¨ˆ'][category][val]) {
        stats.rawData = statistics['ç¶­åº¦çµ±è¨ˆ'][category][val]; stats.low = safeFloat(stats.rawData['å¹³å‡æœ€ä½æº¢åƒ¹']); stats.avg = safeFloat(stats.rawData['å¹³å‡æº¢åƒ¹']);
    }
    if (stats.low === 0) { stats.low = globalMarketStats.low; stats.avg = globalMarketStats.avg; stats.usedFallback = true; }
    return stats;
}

// ==========================================
// 4. UI é¡¯ç¤º (ä¿®æ­£ï¼šå¹³å‡æ›ç‰Œæœ€ä½ èˆ‡ æŒ¯å¹…)
// ==========================================
function generateStandardCard(data, titleOverride=null) {
    if (!data) return `<div class="stat-row" style="color:#999;">æŸ¥ç„¡è³‡æ–™</div>`;
    const val = (v, s='') => (v!==undefined && v!==null && v!=='' && v!==0) ? `${safeFloat(v).toFixed(2)}${s}` : '-';
    
    // è¨ˆç®—æŒ¯å¹…
    const h = safeFloat(data['å¹³å‡æ›ç‰Œæœ€é«˜']);
    const l = safeFloat(data['å¹³å‡æ›ç‰Œæœ€ä½']);
    const amp = (h > 0 && l > 0) ? ((h - l) / l * 100).toFixed(2) : '-';

    let html = `<div class="stats-header">ğŸ“Š ${titleOverride || 'æ­·å²çµ±è¨ˆ'}</div>`;
    if (data['æ¨£æœ¬æ•¸']) html += `<div class="stat-row" style="color:#555; font-weight:bold; margin-bottom:8px;">æ¨£æœ¬æ•¸: ${data['æ¨£æœ¬æ•¸']} æª”</div>`;
    
    html += `<div style="background:#f1f8e9; padding:8px; border-radius:5px; margin-bottom:8px;">
    <div class="stat-row"><span class="stat-label">ğŸ“‰ æœ€ä½å¾—æ¨™:</span><span class="stat-value">${val(data['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'])} å…ƒ (æº¢${val(data['å¹³å‡æœ€ä½æº¢åƒ¹'], '%')})</span></div>
    <div class="stat-row"><span class="stat-label">âš–ï¸ å¹³å‡å¾—æ¨™:</span><span class="stat-value">${val(data['å¹³å‡å¾—æ¨™åƒ¹'])} å…ƒ (æº¢${val(data['å¹³å‡æº¢åƒ¹'], '%')})</span></div>
    </div>`;
    
    if (h > 0) {
        html += `<div style="border-top:1px dashed #ccc; padding-top:8px;">
        <div class="stat-row"><span class="stat-label">ğŸ“ˆ æ›ç‰Œæœ€é«˜:</span> <span class="stat-value">${val(h)}</span></div>
        <div class="stat-row"><span class="stat-label">ğŸ“‰ æ›ç‰Œæœ€ä½:</span> <span class="stat-value">${val(l)}</span></div>
        <div class="stat-row"><span class="stat-label" style="color:#E91E63;">âš¡ å¹³å‡æŒ¯å¹…:</span> <span class="stat-value" style="color:#E91E63;">${amp}%</span></div>
        </div>`;
    }
    return html;
}

function initializeUI() {
    document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | é–å®šç«¶æ‹è³‡æ–™åº«`;
    populateSelect('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']); populateSelect('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);
    showStatsSummary(); bindInputEvents();
}
function populateSelect(id, dataObj) {
    if (!dataObj) return; const sel = document.getElementById(id); while (sel.options.length > 1) sel.remove(1);
    Object.keys(dataObj).sort((a,b)=>(dataObj[b].count||0)-(dataObj[a].count||0)).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.text=`${k} (æ¨£æœ¬:${dataObj[k].count})`; sel.add(o); });
}
function showStatsSummary() { document.getElementById('statsSummary').innerHTML = `<div class="stat-box"><div class="number">${Object.keys(cbDatabase).length}</div><div class="label">è³‡æ–™ç¸½æ•¸</div></div><div class="stat-box"><div class="number">${auctionRawData.filter(d=>d.lowPremium!==0).length}</div><div class="label">æœ‰æ•ˆæ¡ˆä¾‹</div></div>`; }

function bindInputEvents() {
    const show = (id, html) => { const el = document.getElementById(id); el.innerHTML = html||''; el.style.display = html?'block':'none'; };
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim(); if (!val) { show('cbNameInfo', null); return; }
        const found = cbNameMap[val] || Object.values(cbDatabase).find(d => d.name && d.name.includes(val));
        if (found) {
            const h = safeFloat(found.marketHigh), l = safeFloat(found.marketLow);
            const amp = (h > 0 && l > 0) ? ((h - l) / l * 100).toFixed(2) : '-';
            let html = `<div class="stats-header">ğŸ“Š æ­·å²è³‡æ–™</div><div class="stat-row">${found.id||''}</div>`;
            html += `<div style="background:#f1f8e9; padding:8px; border-radius:5px; margin-bottom:8px;">
            <div class="stat-row">ğŸ“‰ æœ€ä½å¾—æ¨™: ${safeFloat(found.minBidPrice)} (æº¢${safeFloat(found.lowPremium)}%)</div>
            <div class="stat-row">âš–ï¸ å¹³å‡å¾—æ¨™: ${safeFloat(found.avgBidPrice)} (æº¢${safeFloat(found.avgPremium)}%)</div></div>`;
            if(h>0) html += `<div style="border-top:1px dashed #ccc; padding-top:8px;"><div class="stat-row">ğŸ“ˆ æœ€é«˜: ${h}</div><div class="stat-row">ğŸ“‰ æœ€ä½: ${l}</div><div class="stat-row" style="color:#E91E63;">âš¡ æŒ¯å¹…: ${amp}%</div></div>`;
            show('cbNameInfo', html);
        } else show('cbNameInfo', null);
    });

    const bind = (id, cat) => {
        const handler = function() {
            const val = parseFloat(this.value) || this.value;
            if (val) {
                let rangeLabel = val;
                if(cat==='è‚¡æœ¬') rangeLabel = classifyCapital(val); // ... ç°¡åŒ–é¡¯ç¤ºï¼Œé‚è¼¯åŒå‰ ...
                const smartResult = getStatsSmart(cat, val);
                show(id+'Info', generateStandardCard(smartResult.rawData, `å€é–“çµ±è¨ˆ (${val})`));
                if(cat==='è½‰æ›åƒ¹'||cat==='ä¿¡è©•') updateSmartReminders();
            }
        };
        const el = document.getElementById(id); el.addEventListener('change', handler); if(el.tagName==='INPUT') el.addEventListener('input', handler);
    };
    bind('capital','è‚¡æœ¬'); bind('issueSize','ç™¼è¡Œè¦æ¨¡'); bind('conversionPrice','è½‰æ›åƒ¹'); bind('industry','ç”¢æ¥­'); bind('broker','ç™¼è¡Œåˆ¸å•†'); bind('years','å¹´æœŸ'); bind('guarantee','æ“”ä¿'); bind('rating','ä¿¡è©•');
    document.getElementById('guarantee').addEventListener('change', function() {
        const val = this.value, div = document.getElementById('marketSentiment');
        if(!val) return;
        const recent = auctionRawData.filter(d=>(d.guarantee||'').includes(val)).slice(-20);
        if(recent.length===0){div.innerHTML=`<div class="stat-row">ç„¡æ¡ˆä¾‹</div>`;return;}
        const avgP=recent.reduce((s,i)=>s+(i.avgPremium||0),0)/recent.length;
        div.innerHTML=`<div class="stats-header">ğŸŒ¡ï¸ å¸‚å ´æ°›åœ (${val})</div><div class="stat-row">è¿‘ ${recent.length} ç­†å¹³å‡æº¢åƒ¹ï¼š<span class="val-pos">${avgP.toFixed(2)}%</span></div>`;
        div.style.display='block';
    });
    document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
}
function updateSmartReminders() {
    const s = parseFloat(document.getElementById('stockPrice').value), c = parseFloat(document.getElementById('conversionPrice').value);
    if(s&&c) { const t=(s/c)*100; document.getElementById('reminderContent').textContent = t>115?'âš ï¸ ç†è«–åƒ¹åé«˜':t<90?'ğŸ’¡ å…·å¸å¼•åŠ›':'âœ¨ åˆç†å€é–“'; document.getElementById('smartReminders').style.display='block'; }
}
function generateRexCommentary(r) { return `<div class="rex-analysis"><div class="rex-title">ğŸ§¢ Rexå¤§å”åˆ†æ</div><div class="rex-content"><p>${parseFloat(r.totalAvgPremium)>15?'ğŸ”¥ å¸‚å ´éç†±':'âš–ï¸ å€é–“åˆç†'}</p></div></div>`; }
function calculateEvaluation(d) {
    const theo = (d.stockPrice/d.conversionPrice)*100;
    const dims = [
        {k:'industry',c:'ç”¢æ¥­',w:0.25,v:d.industry}, {k:'broker',c:'ç™¼è¡Œåˆ¸å•†',w:0.13,v:getBrokerName(d.cbName)},
        {k:'capital',c:'è‚¡æœ¬',w:0.12,v:d.capital}, {k:'size',c:'ç™¼è¡Œè¦æ¨¡',w:0.10,v:d.issueSize},
        {k:'rating',c:'ä¿¡è©•',w:0.15,v:d.rating}, {k:'guarantee',c:'æ“”ä¿',w:0.12,v:d.guarantee},
        {k:'years',c:'å¹´æœŸ',w:0.08,v:d.years}, {k:'conversion',c:'è½‰æ›åƒ¹',w:0.05,v:d.conversionPrice}
    ];
    let wL=0, wA=0, resDims={};
    dims.forEach(x=>{
        const s = getStatsSmart(x.c, x.v), coef = getWeightCoefficient(x.k, x.v);
        resDims[x.k] = { ...s, coefficient: coef, weight: x.w, range: x.v, weightedLow: s.low*x.w*coef, weightedAvg: s.avg*x.w*coef };
        wL+=resDims[x.k].weightedLow; wA+=resDims[x.k].weightedAvg;
    });
    const subR = (d.subjectiveWeight||0)/100, objR = 1-subR;
    const tL = (wL*objR)+((d.subjectiveLowPremium||0)*subR), tA = (wA*objR)+((d.subjectiveAvgPremium||0)*subR), gap = tA-tL;
    return {
        cbName:d.cbName, theoreticalPrice:theo.toFixed(2), dimensions:resDims, totalLowPremium:tL.toFixed(2), totalAvgPremium:tA.toFixed(2),
        bidPrices:{ conservative:(theo*(1+tL/100)).toFixed(2), balanced:(theo*(1+tA/100)).toFixed(2), aggressive:(theo*(1+(tA+gap)/100)).toFixed(2), ultimate:(theo*(1+(tA+gap*2)/100)).toFixed(2) },
        inputData:d, weightedSubjectiveLow:((d.subjectiveLowPremium||0)*subR).toFixed(2), weightedSubjectiveAvg:((d.subjectiveAvgPremium||0)*subR).toFixed(2)
    };
}
function displayResult(r) {
    document.getElementById('welcomeMsg').style.display = 'none';
    const div = document.getElementById('evaluationResult'); div.className = 'evaluation-result active';
    let rows = ''; const nm={'industry':'ç”¢æ¥­','broker':'åˆ¸å•†','capital':'è‚¡æœ¬','size':'è¦æ¨¡','rating':'ä¿¡è©•','guarantee':'æ“”ä¿','years':'å¹´æœŸ','conversion':'è½‰åƒ¹'};
    for(const[k,d] of Object.entries(r.dimensions)) rows+=`<tr><td>${nm[k]}</td><td>${d.range}</td><td>${d.low.toFixed(2)}%</td><td>${d.avg.toFixed(2)}%</td><td>${(d.weight*100).toFixed(0)}%</td><td>${d.weightedAvg.toFixed(2)}</td></tr>`;
    if(r.inputData.subjectiveWeight>0) rows+=`<tr style="background:#fff3e0"><td>ä¸»è§€</td><td>è‡ªè¨‚</td><td>${r.inputData.subjectiveLowPremium}%</td><td>${r.inputData.subjectiveAvgPremium}%</td><td>${r.inputData.subjectiveWeight}%</td><td>${r.weightedSubjectiveAvg}</td></tr>`;
    rows+=`<tr style="background:#667eea;color:white"><td colspan="6" style="text-align:right">ç¸½è¨ˆ: <b>${r.totalAvgPremium}%</b></td></tr>`;
    
    div.innerHTML = `
    <div class="result-header"><h2>${r.cbName}</h2><div class="subtitle">AI è©•ä¼°çµæœ</div></div>
    <div class="detail-section"><h3>ğŸ“Š ç†è«–åƒ¹: ${r.theoreticalPrice}</h3></div>
    <div class="detail-section"><table class="data-table"><thead><tr><th>ç¶­åº¦</th><th>æ¢ä»¶</th><th>æœ€ä½æº¢åƒ¹</th><th>å¹³å‡æº¢åƒ¹</th><th>æ¬Šé‡</th><th>åŠ æ¬Š</th></tr></thead><tbody>${rows}</tbody></table></div>
    ${generateRexCommentary(r)}
    <div class="detail-section"><h3>ğŸ’¡ æŠ•æ¨™å»ºè­°</h3><div class="price-grid">
    <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆ</h4><div class="price">${r.bidPrices.conservative}</div></div>
    <div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡</h4><div class="price">${r.bidPrices.balanced}</div></div>
    <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µ</h4><div class="price">${r.bidPrices.aggressive}</div></div>
    <div class="strategy-card ultimate"><h4>ğŸ”¥ æ¥µè‡´</h4><div class="price">${r.bidPrices.ultimate}</div></div>
    </div></div>
    <div style="text-align:center;margin-top:30px;"><button onclick="location.reload()" class="calculate-btn" style="width:200px;">ğŸ”„ é‡æ–°è©•ä¼°</button></div>`;
    div.scrollIntoView({ behavior: 'smooth' });
}
document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    displayResult(calculateEvaluation({
        cbName: document.getElementById('cbName').value, industry: document.getElementById('industry').value, issueSize: parseFloat(document.getElementById('issueSize').value),
        years: document.getElementById('years').value, guarantee: document.getElementById('guarantee').value, rating: document.getElementById('rating').value,
        capital: parseFloat(document.getElementById('capital').value), stockPrice: parseFloat(document.getElementById('stockPrice').value), conversionPrice: parseFloat(document.getElementById('conversionPrice').value),
        subjectiveWeight: parseFloat(document.getElementById('subjectiveWeight').value)||0, subjectiveLowPremium: parseFloat(document.getElementById('subjectiveLowPremium').value)||0, subjectiveAvgPremium: parseFloat(document.getElementById('subjectiveAvgPremium').value)||0
    }));
});
window.addEventListener('DOMContentLoaded', loadStatistics);
</script>
</body>
</html>
