<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.51 (Rexå¤§å”æ——è‰¦ç¾å­¸ç‰ˆ)</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
/* ================= å…¨åŸŸè¨­å®š ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; 
    background: #f0f2f5; /* æ›´æŸ”å’Œçš„èƒŒæ™¯è‰² */
    min-height: 100vh; 
    padding: 20px; 
    font-size: 16px;
}
.container { max-width: 1600px; margin: 0 auto; }

/* ================= Header ç¾åŒ– ================= */
.header { 
    background: white; 
    border-radius: 12px; 
    padding: 25px 30px; 
    margin-bottom: 20px; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    border-left: 6px solid #0056b3; /* æ”¹ç”¨ç©©é‡çš„æ·±è—è‰² */
}
.header h1 { color: #0056b3; font-size: 32px; margin-bottom: 8px; font-weight: 900; letter-spacing: 1px; }
.header .subtitle { color: #666; font-size: 16px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
.version-badge { background: #e3f2fd; color: #0056b3; padding: 4px 12px; border-radius: 4px; font-size: 14px; border: 1px solid #bbdefb; }

/* ================= ä½ˆå±€è¨­å®š ================= */
.evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
.input-panel { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: fit-content; }
.result-panel { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 600px; }

/* ================= è¡¨å–®ç¾åŒ– ================= */
.input-panel h2 { color: #333; font-size: 22px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee; font-weight: 800; }
.form-section h3 { color: #0056b3; font-size: 16px; margin: 20px 0 10px 0; font-weight: bold; display: flex; align-items: center; gap: 5px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 5px; font-weight: 700; }
.form-group input, .form-group select { 
    width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; 
    font-size: 16px; transition: all 0.3s; color:#333; background: #fff;
}
.form-group input:focus, .form-group select:focus { outline: none; border-color: #0056b3; box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1); }

/* è³‡è¨Šå¡ç‰‡ */
.info-box { background: #f1f8e9; padding: 12px; border-radius: 6px; border: 1px solid #c5e1a5; margin-top: 5px; display: none; font-size: 14px; }
.warning-box { background: #fff3e0; border: 1px solid #ffe0b2; border-radius: 6px; padding: 10px; margin-top: 5px; font-size: 13px; color: #e65100; line-height: 1.5; }

/* æŒ‰éˆ• */
.calculate-btn { 
    width: 100%; padding: 15px; 
    background: #0056b3; 
    color: white; border: none; border-radius: 8px; 
    font-size: 20px; font-weight: bold; 
    cursor: pointer; margin-top: 20px; 
    transition: background 0.2s;
}
.calculate-btn:hover { background: #004494; }

/* ================= ğŸŒŸ è¡¨æ ¼å„ªåŒ–æ ¸å¿ƒ (ä»¿é€ ç¬¬äºŒå¼µåœ–é¢¨æ ¼) ================= */
.financial-table-container {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    margin-top: 20px;
}
.financial-table { 
    width: 100%; 
    border-collapse: collapse; 
    font-family: 'Segoe UI', sans-serif;
}
.financial-table th { 
    background-color: #00508e; /* é¡ä¼¼åœ–äºŒçš„æ·±è—è‰² */
    color: white; 
    padding: 12px 15px; 
    text-align: center; 
    font-weight: 600; 
    font-size: 15px;
    border-right: 1px solid rgba(255,255,255,0.2);
}
.financial-table th:last-child { border-right: none; }
.financial-table td { 
    padding: 12px 15px; 
    border-bottom: 1px solid #eee; 
    border-right: 1px solid #f0f0f0;
    color: #333; 
    text-align: center; 
    font-size: 16px;
    vertical-align: middle;
}
.financial-table td:last-child { border-right: none; }
.financial-table tr:nth-child(even) { background-color: #fcfcfc; }
.financial-table tr:hover { background-color: #f5f9ff; }

/* é‡é»æ•¸å­—æ¨£å¼ (ä»¿è‚¡åƒ¹ä¸Šæ¼²ç´…å­—) */
.val-positive { color: #d32f2f; font-weight: 900; font-family: 'Segoe UI', monospace; }
.val-neutral { color: #333; font-weight: 600; }
.col-highlight { background-color: #fffde7; } /* å¼·èª¿æ¬„ä½åº•è‰² */

/* åº•éƒ¨åˆè¨ˆåˆ— */
.financial-table tfoot tr { background-color: #e3f2fd; border-top: 2px solid #bbdefb; }
.financial-table tfoot td { color: #0d47a1; font-weight: 900; font-size: 17px; padding: 15px; }

/* ================= çµæœå€åŸŸ ================= */
.result-header-box { 
    text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px dashed #ddd; 
}
.result-title { font-size: 28px; color: #333; font-weight: 900; }
.theory-price { font-size: 20px; color: #0056b3; margin-top: 10px; background: #e3f2fd; display: inline-block; padding: 5px 20px; border-radius: 20px; }

/* ç­–ç•¥å¡ç‰‡ */
.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 30px; }
.strategy-card { 
    border: 1px solid #ddd; border-radius: 10px; padding: 20px; text-align: center; 
    background: white; transition: transform 0.2s, box-shadow 0.2s;
}
.strategy-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.strategy-card h4 { font-size: 18px; margin-bottom: 10px; font-weight: 800; }
.strategy-card .price { font-size: 32px; font-weight: 900; margin: 10px 0; font-family: 'Segoe UI', monospace; }
.conservative { border-top: 4px solid #4CAF50; } .conservative .price { color: #2e7d32; }
.balanced { border-top: 4px solid #FF9800; } .balanced .price { color: #e65100; }
.aggressive { border-top: 4px solid #f44336; } .aggressive .price { color: #c62828; }
.ultimate { border-top: 4px solid #9C27B0; } .ultimate .price { color: #6a1b9a; }

/* Rex åˆ†æå€å¡Š */
.rex-analysis { 
    margin-top: 30px; background: #fff8e1; border-left: 5px solid #ffc107; padding: 20px; border-radius: 4px; 
}

@media (max-width: 1200px) { .evaluation-container { grid-template-columns: 1fr; } }
</style>
</head>

<body>
<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;">
    <div style="font-size: 40px;">ğŸ”„</div>
    <div style="font-size: 24px; font-weight: bold; margin-top: 15px; color:#333;">Rexå¤§å”ç«¶æ‹ç³»çµ±</div>
    <div style="font-size: 16px; margin-top: 10px; color:#666;">æ­£åœ¨æº–å‚™è³‡æ–™...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.51 ç¾å­¸ç‰ˆ</span></h1>
        <div class="subtitle">
            <span>Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</span>
            <span style="color:#ccc">|</span>
            <span id="headerSubtitle">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ æ¨™çš„åƒæ•¸è¼¸å…¥</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                    <div class="form-group"><label>CBåç¨± / ä»£è™Ÿ</label><input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼š2368 æˆ– é‡‘åƒé›»" autocomplete="off"><div id="cbNameInfo" class="info-box"></div></div>
                    <div class="form-group"><label>è‚¡æœ¬ (å„„å…ƒ)</label><input type="number" id="capital" step="0.01" required><div id="capitalInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç”¢æ¥­åˆ†é¡</label><select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select><div id="industryInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç™¼è¡Œåˆ¸å•†</label><select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select><div id="brokerInfo" class="info-box"></div></div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group"><label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ)</label><input type="number" id="issueSize" step="0.1" required><div id="issueSizeInfo" class="info-box"></div></div>
                    <div class="form-group"><label>è½‰æ›åƒ¹æ ¼ (å…ƒ)</label><input type="number" id="conversionPrice" step="0.01" required><div id="conversionPriceInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç™¼è¡Œå¹´æœŸ</label><select id="years" required><option value="3">3å¹´æœŸ</option><option value="5">5å¹´æœŸ</option><option value="7">7å¹´æœŸ</option></select><div id="yearsInfo" class="info-box"></div></div>
                    <div class="form-group"><label>æ“”ä¿æƒ…æ³</label><select id="guarantee" required><option value="">è«‹é¸æ“‡...</option><option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option><option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option></select><div id="guaranteeInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ä¿¡ç”¨è©•ç­‰ (TCRI)</label><select id="rating" required><option value="">è«‹é¸æ“‡...</option><option value="1">TCRI 1</option><option value="2">TCRI 2</option><option value="3">TCRI 3</option><option value="4">TCRI 4</option><option value="5">TCRI 5</option><option value="6">TCRI 6</option><option value="7">TCRI 7</option><option value="8">TCRI 8</option><option value="9">TCRI 9</option><option value="BBB">BBBç´š</option></select><div id="ratingInfo" class="info-box"></div></div>
                </div>

                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹èˆ‡ä¸»è§€</h3>
                    <div class="form-group">
                        <label>ç«¶æ‹æˆªæ­¢æ—¥ 13:30 æ”¶ç›¤åƒ¹æ ¼</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                        <div class="warning-box">âš ï¸ ç†è«–åƒ¹æ ¼æœƒéš¨è‚¡åƒ¹æ³¢å‹•ï¼Œå»ºè­°æ–¼ 13:30 æ”¶ç›¤å¾Œç¢ºèªã€‚</div>
                    </div>
                    <div class="form-group" style="margin-top:15px; padding:15px; background:#fafafa; border-radius:8px;">
                        <label style="color:#e65100;">âš–ï¸ ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label>
                        <input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0">
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <div style="flex:1;"><label style="font-size:12px;">ä¸»è§€æœ€ä½æº¢åƒ¹</label><input type="number" id="subjectiveLowPremium" step="0.1" value="0"></div>
                            <div style="flex:1;"><label style="font-size:12px;">ä¸»è§€å¹³å‡æº¢åƒ¹</label><input type="number" id="subjectiveAvgPremium" step="0.1" value="0"></div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹ AI è©•ä¼°</button>
            </form>
        </div>
        
        <div class="result-panel">
            <div id="welcomeMsg" style="text-align: center; padding: 100px 20px; color:#888;">
                <img src="https://cdn-icons-png.flaticon.com/512/2504/2504087.png" width="100" style="opacity:0.5; margin-bottom:20px;">
                <h3>æº–å‚™å¥½é–‹å§‹åˆ†æäº†å—ï¼Ÿ</h3>
                <p>è«‹åœ¨å·¦å´è¼¸å…¥ CB è³‡æ–™ï¼ŒAI å°‡ç‚ºæ‚¨è¨ˆç®—æœ€ä½³æŠ•æ¨™å€é–“ã€‚</p>
            </div>
            <div id="evaluationResult" style="display:none;"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// æ ¸å¿ƒé‚è¼¯ (ä¿æŒä¸è®Šï¼Œåƒ…å„ªåŒ–é¡¯ç¤º)
// ==========================================
const FIELD_ALIASES = { 'cbId': ['CBä»£è™Ÿ', 'ä»£è™Ÿ'], 'name': ['åç¨±', 'CBåç¨±'], 'industry': ['ç”¢æ¥­åˆ†é¡', 'ç”¢æ¥­'], 'broker': ['ç™¼è¡Œåˆ¸å•†', 'ä¸»è¾¦åˆ¸å•†'], 'guarantee': ['æ“”ä¿', 'æœ‰ç„¡æ“”ä¿'], 'rating': ['ä¿¡è©•', 'TCRI'], 'capital': ['è‚¡æœ¬', 'è‚¡æœ¬(å„„)'], 'issueSize': ['ç™¼è¡Œè¦æ¨¡', 'ç¸½é¡'], 'years': ['å¹´æœŸ', 'ç™¼è¡Œå¹´æœŸ'], 'conversionPrice': ['è½‰æ›åƒ¹', 'è½‰æ›åƒ¹æ ¼'], 'minBidPrice': ['æœ€ä½å¾—æ¨™', 'æœ€ä½å¾—æ¨™åƒ¹'], 'lowPremium': ['æœ€ä½æº¢åƒ¹', 'æœ€ä½æº¢åƒ¹(%)'], 'avgBidPrice': ['å¹³å‡å¾—æ¨™', 'å¹³å‡å¾—æ¨™åƒ¹'], 'avgPremium': ['å¹³å‡æº¢åƒ¹', 'å¹³å‡æº¢åƒ¹(%)'], 'marketHigh': ['æ›ç‰Œæœ€é«˜'], 'marketLow': ['æ›ç‰Œæœ€ä½'], 'issueDate': ['é–‹æ¨™æ—¥æœŸ', 'æ—¥æœŸ'], 'bidMultiplier': ['æŠ•æ¨™å€æ•¸', 'å€æ•¸'] };
let auctionRawData = [], cbDatabase = {}, statistics = { 'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} } };

function normalizeKeys(obj) { const n={}; Object.keys(obj).forEach(k=>n[k.trim()]=obj[k]); return n; }
function getSmartValue(row, key) { if(!FIELD_ALIASES[key]) return undefined; for(let a of FIELD_ALIASES[key]) if(row[a]!==undefined) return row[a]; return undefined; }
function safeFloat(v) { const n=parseFloat(v); return isNaN(n)?0:n; }
function safeFixed(v,d=2) { const n=parseFloat(v); return isNaN(n)?'-':n.toFixed(d); }
function getRangeLabel(cat, val) {
    const v = parseFloat(val); if (isNaN(v)) return val;
    if (cat === 'è‚¡æœ¬') return v < 3 ? "< 3 å„„" : v < 6 ? "3 ~ 6 å„„" : v < 10 ? "6 ~ 10 å„„" : v < 15 ? "10 ~ 15 å„„" : v < 20 ? "15 ~ 20 å„„" : "> 20 å„„";
    if (cat === 'ç™¼è¡Œè¦æ¨¡') return v < 2 ? "< 2 å„„" : v < 5 ? "2 ~ 5 å„„" : v < 10 ? "5 ~ 10 å„„" : v < 15 ? "10 ~ 15 å„„" : v < 20 ? "15 ~ 20 å„„" : "> 20 å„„";
    if (cat === 'è½‰æ›åƒ¹') return v < 20 ? "< 20 å…ƒ" : v < 50 ? "20 ~ 50 å…ƒ" : v < 100 ? "50 ~ 100 å…ƒ" : v < 150 ? "100 ~ 150 å…ƒ" : "> 150 å…ƒ";
    return val;
}

async function loadData() {
    try {
        const res = await fetch('00_CB.xlsx');
        if(!res.ok) throw new Error("è®€å– Excel å¤±æ•—");
        const wb = XLSX.read(await res.arrayBuffer(), {type:'array'});
        const shAuc = wb.SheetNames.find(n => n.includes('04') || n.includes('ç«¶æ‹'));
        const rawAuc = XLSX.utils.sheet_to_json(wb.Sheets[shAuc]);
        
        auctionRawData = rawAuc.map(r => {
            const row = normalizeKeys(r);
            let lp = safeFloat(getSmartValue(row, 'lowPremium')), ap = safeFloat(getSmartValue(row, 'avgPremium'));
            if(Math.abs(lp)<2 && lp!==0) lp*=100; if(Math.abs(ap)<2 && ap!==0) ap*=100;
            return {
                id: String(row['ä»£è™Ÿ']||'').trim(), name: getSmartValue(row, 'name'), 
                industry: getSmartValue(row, 'industry'), broker: getSmartValue(row, 'broker'),
                capital: safeFloat(getSmartValue(row, 'capital')), issueSize: safeFloat(getSmartValue(row, 'issueSize')),
                minBid: safeFloat(getSmartValue(row, 'minBidPrice')), avgBid: safeFloat(getSmartValue(row, 'avgBidPrice')),
                lowPrem: lp, avgPrem: ap, multiplier: safeFloat(getSmartValue(row, 'bidMultiplier')),
                rating: getSmartValue(row, 'rating'), guarantee: getSmartValue(row, 'guarantee'),
                conversionPrice: safeFloat(getSmartValue(row, 'conversionPrice')), years: getSmartValue(row, 'years')
            };
        }).filter(x=>x && x.minBid>0);

        auctionRawData.forEach(item => { if (item.name) cbDatabase[item.name] = item; });
        auctionRawData.forEach(d => {
            ['industry','broker'].forEach(k => {
                const val = d[k]; if(!val) return;
                const cat = k==='industry'?'ç”¢æ¥­':'ç™¼è¡Œåˆ¸å•†';
                if(!statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val]) statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val] = {c:0, sL:0, sA:0};
                statistics['ç¶­åº¦çµ±è¨ˆ'][cat][val].c++;
            });
        });

        initUI();
        document.getElementById('loading').style.display='none';
        document.querySelector('.container').style.display='block';
    } catch(e) { alert("ç³»çµ±å•Ÿå‹•å¤±æ•—: " + e.message); }
}

function getStats(cat, val) {
    let list = [], label = val; const v = parseFloat(val);
    if(cat==='è‚¡æœ¬') list = v<3?auctionRawData.filter(d=>d.capital<3):v<6?auctionRawData.filter(d=>d.capital>=3&&d.capital<6):v<10?auctionRawData.filter(d=>d.capital>=6&&d.capital<10):v<15?auctionRawData.filter(d=>d.capital>=10&&d.capital<15):v<20?auctionRawData.filter(d=>d.capital>=15&&d.capital<20):auctionRawData.filter(d=>d.capital>=20);
    else if(cat==='ç™¼è¡Œè¦æ¨¡') list = v<2?auctionRawData.filter(d=>d.issueSize<2):v<5?auctionRawData.filter(d=>d.issueSize>=2&&d.issueSize<5):v<10?auctionRawData.filter(d=>d.issueSize>=5&&d.issueSize<10):v<15?auctionRawData.filter(d=>d.issueSize>=10&&d.issueSize<15):v<20?auctionRawData.filter(d=>d.issueSize>=15&&d.issueSize<20):auctionRawData.filter(d=>d.issueSize>=20);
    else if(cat==='è½‰æ›åƒ¹') list = v<20?auctionRawData.filter(d=>d.conversionPrice<20):v<50?auctionRawData.filter(d=>d.conversionPrice>=20&&d.conversionPrice<50):v<100?auctionRawData.filter(d=>d.conversionPrice>=50&&d.conversionPrice<100):auctionRawData.filter(d=>d.conversionPrice>=100);
    else list = auctionRawData.filter(d=>(d[cat==='ç”¢æ¥­'?'industry':cat==='ç™¼è¡Œåˆ¸å•†'?'broker':cat==='ä¿¡è©•'?'rating':cat==='æ“”ä¿'?'guarantee':'years']||'').includes(val));

    if(list.length > 0) {
        const avgL = list.reduce((s,i)=>s+i.lowPrem,0)/list.length;
        const avgA = list.reduce((s,i)=>s+i.avgPrem,0)/list.length;
        return { low: avgL, avg: avgA, label: getRangeLabel(cat, val), count: list.length };
    }
    return { low: 0, avg: 0, label: label, count: 0 };
}

function initUI() {
    document.getElementById('headerSubtitle').textContent = `è³‡æ–™åº«ç­†æ•¸: ${Object.keys(cbDatabase).length}`;
    const fill = (id, obj) => { const s=document.getElementById(id); Object.keys(obj).sort((a,b)=>obj[b].c-obj[a].c).forEach(k=>s.add(new Option(`${k} (${obj[k].c})`, k))); };
    fill('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']); fill('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);

    // ç¶å®šè¼¸å…¥äº‹ä»¶é¡¯ç¤ºå°å¡
    const bind = (id, cat) => {
        const el = document.getElementById(id);
        const handler = function() {
            const res = getStats(cat, this.value);
            const box = document.getElementById(id+'Info');
            if(this.value && res.count > 0) {
                box.style.display='block';
                box.innerHTML = `<b>${res.label}</b> (æ¨£æœ¬æ›¸:${res.count})<br>å‡ä½æº¢: <span style="color:#d32f2f;font-weight:bold">${safeFixed(res.low)}%</span> | å‡å‡æº¢: <span style="color:#d32f2f;font-weight:bold">${safeFixed(res.avg)}%</span>`;
            } else box.style.display='none';
        };
        el.addEventListener('change', handler); if(el.tagName==='INPUT') el.addEventListener('input', handler);
    };
    ['capital','issueSize','conversionPrice','industry','broker','years','guarantee','rating'].forEach(k => bind(k, k==='capital'?'è‚¡æœ¬':k==='issueSize'?'ç™¼è¡Œè¦æ¨¡':k==='conversionPrice'?'è½‰æ›åƒ¹':k==='industry'?'ç”¢æ¥­':k==='broker'?'ç™¼è¡Œåˆ¸å•†':k==='years'?'å¹´æœŸ':k==='guarantee'?'æ“”ä¿':'ä¿¡è©•'));
}

// ==========================================
// 4. çµæœé¡¯ç¤º (ä¾ç…§åœ–ç‰‡äºŒé¢¨æ ¼å®Œå…¨é‡å¯«)
// ==========================================
function displayResult(res) {
    document.getElementById('welcomeMsg').style.display = 'none';
    const div = document.getElementById('evaluationResult');
    div.style.display = 'block';

    let tableRows = '';
    let totalDimLow = 0, totalDimAvg = 0;
    
    res.details.forEach(d => {
        totalDimLow += d.stats.low; totalDimAvg += d.stats.avg;
        tableRows += `<tr>
            <td style="font-weight:bold; color:#0056b3;">${d.name}</td>
            <td>${d.displayVal}</td>
            <td class="val-positive">${safeFixed(d.stats.low)}%</td>
            <td class="val-positive">${safeFixed(d.stats.avg)}%</td>
            <td>${(d.weight*100).toFixed(0)}%</td>
            <td class="val-neutral">${safeFixed(d.wLow)}</td>
            <td class="val-neutral">${safeFixed(d.wAvg)}</td>
        </tr>`;
    });
    
    const avgDimLow = res.details.length ? totalDimLow / res.details.length : 0;
    const avgDimAvg = res.details.length ? totalDimAvg / res.details.length : 0;

    if(res.subW > 0) {
        tableRows += `<tr style="background:#fffde7;">
            <td style="color:#e65100; font-weight:bold;">ä¸»è§€ä¿®æ­£</td>
            <td style="color:#e65100;">è‡ªè¨‚è§€é»</td>
            <td class="val-positive">${res.subL}%</td>
            <td class="val-positive">${res.subA}%</td>
            <td style="font-weight:bold;">${res.subW}%</td>
            <td class="val-neutral">${res.wSubL.toFixed(2)}</td>
            <td class="val-neutral">${res.wSubA.toFixed(2)}</td>
        </tr>`;
    }

    div.innerHTML = `
    <div class="result-header-box">
        <div class="result-title">${res.name} ç«¶æ‹åˆ†æ</div>
        <div class="theory-price">ç†è«–åƒ¹æ ¼ ${res.theoPrice} å…ƒ</div>
    </div>

    <div class="financial-table-container">
        <table class="financial-table">
            <thead>
                <tr>
                    <th width="15%">ç¶­åº¦</th>
                    <th width="25%">æ¢ä»¶å…§å®¹</th>
                    <th>æ­·å²æœ€ä½æº¢åƒ¹</th>
                    <th>æ­·å²å¹³å‡æº¢åƒ¹</th>
                    <th>æ¬Šé‡</th>
                    <th>åŠ æ¬Šæœ€ä½</th>
                    <th>åŠ æ¬Šå¹³å‡</th>
                </tr>
            </thead>
            <tbody>${tableRows}</tbody>
            <tfoot>
                <tr>
                    <td>åˆè¨ˆçµæœ</td>
                    <td style="font-size:14px; font-weight:normal; color:#666;">(ç¶œåˆæ‰€æœ‰ç¶­åº¦)</td>
                    <td>${safeFixed(avgDimLow)}%</td>
                    <td>${safeFixed(avgDimAvg)}%</td>
                    <td>100%</td>
                    <td style="color:#d32f2f;">${res.finalLow}%</td>
                    <td style="color:#d32f2f;">${res.finalAvg}%</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="price-grid">
        <div class="strategy-card conservative">
            <h4>ğŸ›¡ï¸ ä¿å®ˆä½ˆå±€</h4>
            <div class="price">${res.prices.p1}</div>
            <div style="color:#666; font-size:13px;">${res.theoPrice} Ã— (1 + ${res.finalLow}%)</div>
        </div>
        <div class="strategy-card balanced">
            <h4>âš–ï¸ å¹³è¡¡ç­–ç•¥</h4>
            <div class="price">${res.prices.p2}</div>
            <div style="color:#666; font-size:13px;">${res.theoPrice} Ã— (1 + ${res.finalAvg}%)</div>
        </div>
        <div class="strategy-card aggressive">
            <h4>ğŸš€ ç©æ¥µæ¶æ¨™</h4>
            <div class="price">${res.prices.p3}</div>
            <div style="color:#666; font-size:13px;">è¿½æ±‚å¾—æ¨™ç‡</div>
        </div>
        <div class="strategy-card ultimate">
            <h4>ğŸ”¥ æ¥µè‡´åƒ¹æ ¼</h4>
            <div class="price">${res.prices.p4}</div>
            <div style="color:#666; font-size:13px;">ç†±é–€æ¨™çš„é©ç”¨</div>
        </div>
    </div>
    
    <div class="rex-analysis">
        <h4 style="color:#e65100; margin-bottom:10px;">ğŸ§¢ Rexå¤§å”åˆ†æè§€é»</h4>
        <p style="color:#444; line-height:1.6;">
            æ ¹æ“šç•¶å‰ç†è«–åƒ¹æ ¼ <b>${res.theoPrice}</b> å…ƒè¨ˆç®—ï¼ŒåŠ æ¬Šå¹³å‡æº¢åƒ¹ç‡ç‚º <b>${res.finalAvg}%</b>ã€‚<br>
            ${res.prices.p2 > res.theoPrice * 1.2 ? 'âš ï¸ ç›®å‰æº¢åƒ¹åé«˜ï¼Œå»ºè­°æ¡å–ä¿å®ˆç­–ç•¥ï¼Œé¿å…éåº¦è¿½åƒ¹ã€‚' : 
              res.prices.p2 < res.theoPrice * 1.05 ? 'âœ¨ æº¢åƒ¹ç©ºé–“åˆç†ï¼Œå¯è€ƒæ…®ç©æ¥µä½ˆå±€ä»¥ç²å–ç±Œç¢¼ã€‚' : 
              'âš–ï¸ ä¼°å€¼è™•æ–¼åˆç†å€é–“ï¼Œå»ºè­°åƒè€ƒå¹³è¡¡åƒ¹æ ¼é€²è¡ŒæŠ•æ¨™ã€‚'}
        </p>
    </div>

    <div style="text-align:center;">
        <button onclick="window.print()" class="calculate-btn" style="width:200px; background:#555; margin-right:10px;">ğŸ–¨ï¸ åˆ—å° / å­˜æª”</button>
        <button onclick="location.reload()" class="calculate-btn" style="width:200px;">ğŸ”„ é‡æ–°è©•ä¼°</button>
    </div>`;
    
    div.scrollIntoView({behavior:'smooth'});
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const getVal = (id) => document.getElementById(id).value, getNum = (id) => parseFloat(document.getElementById(id).value)||0;
    const data = { name: getVal('cbName'), stock: getNum('stockPrice'), conv: getNum('conversionPrice'), subW: getNum('subjectiveWeight'), subL: getNum('subjectiveLowPremium'), subA: getNum('subjectiveAvgPremium') };

    const dims = [
        {k:'industry', n:'ç”¢æ¥­', v:getVal('industry'), w:0.25}, {k:'broker', n:'åˆ¸å•†', v:getVal('broker'), w:0.13},
        {k:'capital', n:'è‚¡æœ¬', v:getNum('capital'), w:0.12}, {k:'issueSize', n:'è¦æ¨¡', v:getNum('issueSize'), w:0.10},
        {k:'rating', n:'ä¿¡è©•', v:getVal('rating'), w:0.15}, {k:'guarantee', n:'æ“”ä¿', v:getVal('guarantee'), w:0.12},
        {k:'years', n:'å¹´æœŸ', v:getVal('years'), w:0.08}, {k:'conv', n:'è½‰åƒ¹', v:getNum('conversionPrice'), w:0.05}
    ];

    let sumWL=0, sumWA=0;
    const details = dims.map(d => {
        const s = getStats(d.n, d.v); const wL = s.low * d.w, wA = s.avg * d.w; sumWL += wL; sumWA += wA;
        return { name:d.n, displayVal:s.label||d.v, stats:s, weight:d.w, wLow:wL, wAvg:wA };
    });

    const sR = data.subW/100, oR = 1 - sR, wSubL = data.subL * sR, wSubA = data.subA * sR;
    const finalL = (sumWL * oR) + wSubL, finalA = (sumWA * oR) + wSubA, theo = (data.stock / data.conv) * 100;
    
    displayResult({
        name: data.name, theoPrice: safeFixed(theo), details: details,
        subW: data.subW, subL: data.subL, subA: data.subA, wSubL: wSubL, wSubA: wSubA,
        finalLow: safeFixed(finalL), finalAvg: safeFixed(finalA),
        prices: { p1: safeFixed(theo*(1+finalL/100)), p2: safeFixed(theo*(1+finalA/100)), p3: safeFixed(theo*(1+(finalA+(finalA-finalL))/100)), p4: safeFixed(theo*(1+(finalA+(finalA-finalL)*2)/100)) }
    });
});

window.onload = loadData;
</script>
</body>
</html>
