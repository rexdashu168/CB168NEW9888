<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能可轉債競拍系統 v3.30 (動態權重版) - Rex大叔</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; display: none; } /* 預設隱藏，載入後顯示 */
        .header {
            background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
        .header .subtitle { color: #666; font-size: 16px; }
        .version-badge { display: inline-block; background: #009688; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }
        .evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }
        .input-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px;
        }
        .input-panel h2 { color: #667eea; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }
        .form-section { margin-bottom: 25px; }
        .form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .info-box {
            background: #e8f5e9; padding: 15px; border-radius: 8px;
            border-left: 5px solid #4CAF50; margin-top: 10px; display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
        .stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
        .stat-label { color: #555; font-weight: 500; }
        .stat-value { font-weight: bold; color: #333; }
        .calculate-btn {
            width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold;
            cursor: pointer; transition: transform 0.2s; margin-top: 20px;
        }
        .calculate-btn:hover { transform: translateY(-2px); }
        .result-panel {
            background: white; border-radius: 15px; padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px;
        }
        .welcome-message { text-align: center; padding: 60px 20px; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
        .stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .evaluation-result { display: none; }
        .evaluation-result.active { display: block; animation: fadeIn 0.5s; }
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
        }
        .detail-section {
            background: white; border-radius: 12px; padding: 30px;
            margin-bottom: 25px; border: 2px solid #e0e0e0;
        }
        .detail-section h3 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; }
        .strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
        .strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
        .strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
        .strategy-card.ultimate { border-color: #9C27B0; background: #f3e5f5; }
        .strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }
        .data-table {
            width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .data-table th {
            background-color: #1A237E; color: white; padding: 15px 10px;
            text-align: center; font-weight: bold; border: 1px solid #0d1b5e;
        }
        .data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
        .data-table tr:nth-child(even) { background-color: #f8f9fa; }
        .data-table tr:hover { background-color: #e8eaf6; }
        .val-pos { color: #d32f2f; font-weight: bold; }
        .val-neg { color: #388e3c; font-weight: bold; }
        .val-neu { color: #333; }
        .rex-analysis {
            background: linear-gradient(to right, #fff3e0, #ffe0b2);
            border-left: 6px solid #ff9800;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .rex-title { font-size: 20px; font-weight: bold; color: #e65100; margin-bottom: 15px; display: flex; align-items: center; }
        .rex-content { color: #5d4037; line-height: 1.8; font-size: 15px; }
        @media (max-width: 1200px) {
            .evaluation-container { grid-template-columns: 1fr; }
            .input-panel { position: relative; top: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold;">
        <div>🔄 正在初始化系統...</div>
        <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">正在連結資料庫...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🤖 AI智能可轉債競拍系統 <span class="version-badge">v3.30</span></h1>
            <p class="subtitle" id="headerSubtitle">載入中...</p>
        </div>

        <div class="evaluation-container">
            <div class="input-panel">
                <h2>📋 輸入標的資料</h2>
                <form id="evaluationForm">
                    <div class="form-section">
                        <h3>📌 基本資料</h3>
                        <div class="form-group">
                            <label>CB名稱 *</label>
                            <input type="text" id="cbName" required placeholder="例如：台光電七">
                            <div id="cbNameInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>股本 (億元) *</label>
                            <input type="number" id="capital" step="0.01" required placeholder="例如：33.80">
                            <div id="capitalInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>產業分類 *</label>
                            <select id="industry" required><option value="">載入中...</option></select>
                            <div id="industryInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>發行券商</label>
                            <select id="broker"><option value="">載入中...</option></select>
                            <div id="brokerInfo" class="info-box"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>💰 發行條件</h3>
                        <div class="form-group">
                            <label>發行規模 (億元) *</label>
                            <input type="number" id="issueSize" step="0.1" required placeholder="例如：90">
                            <div id="issueSizeInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>轉換價格 (元) *</label>
                            <input type="number" id="conversionPrice" step="0.01" required placeholder="例如：450">
                            <div id="conversionPriceInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>發行年期 *</label>
                            <select id="years" required>
                                <option value="">請選擇...</option>
                                <option value="3">3年期</option>
                                <option value="5">5年期</option>
                                <option value="7">7年期</option>
                            </select>
                            <div id="yearsInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>擔保情況 *</label>
                            <select id="guarantee" required>
                                <option value="">請選擇...</option>
                                <option value="有擔保">有擔保</option>
                                <option value="無擔保">無擔保</option>
                            </select>
                            <div id="guaranteeInfo" class="info-box"></div>
                        </div>
                        <div class="form-group">
                            <label>信用評等 (TCRI) *</label>
                            <select id="rating" required>
                                <option value="">請選擇...</option>
                                <option value="1">TCRI 1</option>
                                <option value="2">TCRI 2</option>
                                <option value="3">TCRI 3</option>
                                <option value="4">TCRI 4</option>
                                <option value="5">TCRI 5</option>
                                <option value="6">TCRI 6</option>
                                <option value="7">TCRI 7</option>
                                <option value="8">TCRI 8</option>
                                <option value="9">TCRI 9</option>
                                <option value="BBB">BBB級</option>
                            </select>
                            <div id="ratingInfo" class="info-box"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>🎯 競拍資料</h3>
                        <div class="form-group">
                            <label>競拍截止日1:30收盤價格 (元) *</label>
                            <input type="number" id="stockPrice" step="0.01" required placeholder="例如：461.5">
                        </div>
                    </div>

                    <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 20px; margin: 25px 0;">
                        <h3 style="color: #e65100; display: flex; align-items: center; gap: 8px;">⚖️ 主觀權重調整（選填）</h3>
                        <div style="background: white; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6; color: #555; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                            💡 <strong>功能說明：</strong><br>
                            • 主觀權重0%：完全依據歷史資料計算<br>
                            • 主觀權重20%：您的判斷佔20%，歷史資料佔80%<br>
                            • 填入您對本標的的溢價預期，系統會自動加權計算
                        </div>
                        <div class="form-group">
                            <label>主觀權重比例 (%)</label>
                            <input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0" placeholder="0-100，預設0">
                            <small style="color: #666; font-size: 12px;">範圍：0-100，預設0表示完全依據歷史資料</small>
                        </div>
                        <div class="form-group">
                            <label>主觀最低溢價率 (%)</label>
                            <input type="number" id="subjectiveLowPremium" step="0.1" value="0" placeholder="例如：5.0">
                            <small style="color: #666; font-size: 12px;">您認為最低得標的溢價率（保守估計）</small>
                        </div>
                        <div class="form-group">
                            <label>主觀平均溢價率 (%)</label>
                            <input type="number" id="subjectiveAvgPremium" step="0.1" value="0" placeholder="例如：8.0">
                            <small style="color: #666; font-size: 12px;">您認為平均得標的溢價率（穩健估計）</small>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>📊 近期市場競拍氛圍</h3>
                        <div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;">
                            <div class="stats-header" style="color:#1976D2;">🌡️ 動態市場氛圍分析</div>
                            <div class="stat-row">請先選擇「擔保情況」，系統將自動調閱歷史案例分析。</div>
                        </div>
                    </div>

                    <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 14px;">💡 Rex大叔的智慧提醒</div>
                        <div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div>
                    </div>

                    <button type="submit" class="calculate-btn">🎯 開始AI評估</button>
                </form>
            </div>

            <div class="result-panel">
                <div id="welcomeMsg" class="welcome-message">
                    <h2>歡迎使用AI智能競拍評估系統</h2>
                    <p>✅ v3.30 動態權重版<br>完整讀取歷史資料 + 智能統計分析</p>
                    <div class="stats-summary" id="statsSummary"></div>
                </div>
                <div id="evaluationResult" class="evaluation-result"></div>
            </div>
        </div>
    </div>

    <script>
        // 權重係數資料庫 (修復引號問題)
        window.WEIGHT_COEFFICIENTS = {"industry": {"光電業": {"coefficient": 0.706, "avg_high": 175.33, "count": 151, "sample_coef": 1.0}, "其他業": {"coefficient": 0.66, "avg_high": 160.98, "count": 81, "sample_coef": 1.0}, "其他業電子業": {"coefficient": 0.78, "avg_high": 198.54, "count": 106, "sample_coef": 1.0}, "化學工業": {"coefficient": 0.815, "avg_high": 209.4, "count": 33, "sample_coef": 1.0}, "半導體業": {"coefficient": 0.717, "avg_high": 178.93, "count": 147, "sample_coef": 1.0}, "塑膠工業": {"coefficient": 0.665, "avg_high": 162.64, "count": 13, "sample_coef": 1.0}, "居家生活": {"coefficient": 0.564, "avg_high": 130.96, "count": 25, "sample_coef": 1.0}, "建材營造業": {"coefficient": 0.698, "avg_high": 172.83, "count": 131, "sample_coef": 1.0}, "數位雲端": {"coefficient": 0.387, "avg_high": 127.41, "count": 9, "sample_coef": 0.7}, "文化創意業": {"coefficient": 0.924, "avg_high": 243.67, "count": 14, "sample_coef": 1.0}, "橡膠工業": {"coefficient": 0.504, "avg_high": 179.87, "count": 6, "sample_coef": 0.7}, "水泥工業": {"coefficient": 0.25, "avg_high": 110.8, "count": 2, "sample_coef": 0.5}, "汽車工業": {"coefficient": 0.656, "avg_high": 159.81, "count": 48, "sample_coef": 1.0}, "油電燃氣業": {"coefficient": 0.719, "avg_high": 179.35, "count": 12, "sample_coef": 1.0}, "玻璃陶瓷": {"coefficient": 0.5, "avg_high": 267.5, "count": 2, "sample_coef": 0.5}, "生技醫療業": {"coefficient": 0.758, "avg_high": 191.6, "count": 130, "sample_coef": 1.0}, "紡織纖維": {"coefficient": 0.689, "avg_high": 170.17, "count": 30, "sample_coef": 1.0}, "綠能環保": {"coefficient": 0.65, "avg_high": 157.94, "count": 37, "sample_coef": 1.0}, "航運業": {"coefficient": 0.686, "avg_high": 169.0, "count": 51, "sample_coef": 1.0}, "觀光餐旅": {"coefficient": 0.655, "avg_high": 159.53, "count": 30, "sample_coef": 1.0}, "證券業": {"coefficient": 0.304, "avg_high": 144.68, "count": 4, "sample_coef": 0.5}, "貿易百貨業": {"coefficient": 0.582, "avg_high": 136.41, "count": 14, "sample_coef": 1.0}, "資訊服務業": {"coefficient": 0.607, "avg_high": 144.28, "count": 16, "sample_coef": 1.0}, "農業科技業": {"coefficient": 0.338, "avg_high": 166.0, "count": 3, "sample_coef": 0.5}, "通信網路業": {"coefficient": 0.654, "avg_high": 159.08, "count": 120, "sample_coef": 1.0}, "造紙工業": {"coefficient": 0.324, "avg_high": 157.12, "count": 4, "sample_coef": 0.5}, "運動休閒": {"coefficient": 0.691, "avg_high": 170.58, "count": 38, "sample_coef": 1.0}, "金控業": {"coefficient": 0.599, "avg_high": 141.91, "count": 11, "sample_coef": 1.0}, "銀行業": {"coefficient": 0.261, "avg_high": 118.0, "count": 2, "sample_coef": 0.5}, "鋼鐵工業": {"coefficient": 0.657, "avg_high": 159.99, "count": 71, "sample_coef": 1.0}, "電器電纜": {"coefficient": 0.669, "avg_high": 163.62, "count": 19, "sample_coef": 1.0}, "電子通路業": {"coefficient": 0.669, "avg_high": 163.79, "count": 64, "sample_coef": 1.0}, "電子零組件業": {"coefficient": 0.689, "avg_high": 170.07, "count": 351, "sample_coef": 1.0}, "電機機械": {"coefficient": 0.654, "avg_high": 159.12, "count": 97, "sample_coef": 1.0}, "電腦及週邊設備業": {"coefficient": 0.695, "avg_high": 171.94, "count": 120, "sample_coef": 1.0}, "食品工業": {"coefficient": 0.616, "avg_high": 147.0, "count": 15, "sample_coef": 1.0}}, "broker": {"中信證券": {"coefficient": 0.729, "avg_high": 171.45, "count": 54, "sample_coef": 1.0}, "元大證券": {"coefficient": 0.646, "avg_high": 149.77, "count": 115, "sample_coef": 1.0}, "元富證券": {"coefficient": 0.675, "avg_high": 157.2, "count": 33, "sample_coef": 1.0}, "兆豐證券": {"coefficient": 0.659, "avg_high": 153.13, "count": 49, "sample_coef": 1.0}, "凱基證券": {"coefficient": 0.723, "avg_high": 169.94, "count": 233, "sample_coef": 1.0}, "台中銀證": {"coefficient": 0.84, "avg_high": 200.65, "count": 14, "sample_coef": 1.0}, "台新證券": {"coefficient": 0.739, "avg_high": 174.04, "count": 125, "sample_coef": 1.0}, "台銀證券": {"coefficient": 0.612, "avg_high": 209.62, "count": 7, "sample_coef": 0.7}, "合庫證券": {"coefficient": 0.677, "avg_high": 157.83, "count": 47, "sample_coef": 1.0}, "國泰證券": {"coefficient": 0.658, "avg_high": 152.69, "count": 40, "sample_coef": 1.0}, "國票證券": {"coefficient": 0.714, "avg_high": 167.54, "count": 49, "sample_coef": 1.0}, "土銀證券": {"coefficient": 0.811, "avg_high": 193.14, "count": 11, "sample_coef": 1.0}, "宏遠證券": {"coefficient": 0.625, "avg_high": 144.04, "count": 20, "sample_coef": 1.0}, "富蘭克林證券": {"coefficient": 0.282, "avg_high": 128.0, "count": 1, "sample_coef": 0.5}, "富邦證券": {"coefficient": 0.708, "avg_high": 165.88, "count": 147, "sample_coef": 1.0}, "工銀證券": {"coefficient": 0.262, "avg_high": 117.5, "count": 2, "sample_coef": 0.5}, "康和證券": {"coefficient": 0.651, "avg_high": 151.07, "count": 17, "sample_coef": 1.0}, "德信證券": {"coefficient": 0.25, "avg_high": 111.25, "count": 1, "sample_coef": 0.5}, "永豐金證": {"coefficient": 0.738, "avg_high": 173.91, "count": 82, "sample_coef": 1.0}, "玉山證券": {"coefficient": 0.699, "avg_high": 163.49, "count": 12, "sample_coef": 1.0}, "福邦證券": {"coefficient": 0.727, "avg_high": 170.91, "count": 64, "sample_coef": 1.0}, "第一金證": {"coefficient": 1.0, "avg_high": 242.74, "count": 26, "sample_coef": 1.0}, "統一證券": {"coefficient": 0.782, "avg_high": 185.43, "count": 71, "sample_coef": 1.0}, "群益證券": {"coefficient": 0.7, "avg_high": 163.77, "count": 39, "sample_coef": 1.0}, "華南永昌": {"coefficient": 0.704, "avg_high": 164.77, "count": 23, "sample_coef": 1.0}}, "capital": {"10~15億": {"coefficient": 0.721, "avg_high": 161.42, "count": 239, "sample_coef": 1.0}, "15~20億": {"coefficient": 0.743, "avg_high": 163.01, "count": 104, "sample_coef": 1.0}, "3~6億": {"coefficient": 0.698, "avg_high": 159.72, "count": 214, "sample_coef": 1.0}, "6~10億": {"coefficient": 1.0, "avg_high": 181.63, "count": 316, "sample_coef": 1.0}, "<3億": {"coefficient": 0.5, "avg_high": 145.41, "count": 25, "sample_coef": 1.0}, ">20億": {"coefficient": 0.785, "avg_high": 166.04, "count": 359, "sample_coef": 1.0}}, "size": {"10~15億": {"coefficient": 0.657, "avg_high": 160.05, "count": 177, "sample_coef": 1.0}, "15~20億": {"coefficient": 0.622, "avg_high": 157.57, "count": 72, "sample_coef": 1.0}, "2~5億": {"coefficient": 0.778, "avg_high": 168.66, "count": 678, "sample_coef": 1.0}, "5~10億": {"coefficient": 0.773, "avg_high": 168.34, "count": 416, "sample_coef": 1.0}, "<2億": {"coefficient": 1.0, "avg_high": 184.43, "count": 157, "sample_coef": 1.0}, ">20億": {"coefficient": 0.5, "avg_high": 148.93, "count": 142, "sample_coef": 1.0}}, "rating": {"2-3分": {"avg_high": 175.22, "count": 27, "coefficient": 1.0, "sample_coef": 1.0}, "4-5分": {"avg_high": 167.02, "count": 367, "coefficient": 0.827, "sample_coef": 1.0}, "6-7分": {"avg_high": 151.58, "count": 369, "coefficient": 0.5, "sample_coef": 1.0}, "8-9分": {"avg_high": 162.7, "count": 27, "coefficient": 0.735, "sample_coef": 1.0}}, "guarantee": {"0": {"coefficient": 0.25, "avg_high": 127.0, "count": 1, "sample_coef": 0.5}, "有擔保": {"coefficient": 1.0, "avg_high": 182.32, "count": 454, "sample_coef": 1.0}, "無擔保": {"coefficient": 0.804, "avg_high": 160.58, "count": 829, "sample_coef": 1.0}}, "years": {"2.0": {"coefficient": 0.425, "avg_high": 189.28, "count": 9, "sample_coef": 0.7}, "2.5": {"coefficient": 0.25, "avg_high": 118.58, "count": 2, "sample_coef": 0.5}, "2.75": {"coefficient": 0.314, "avg_high": 203.0, "count": 1, "sample_coef": 0.5}, "3.0": {"coefficient": 0.566, "avg_high": 162.51, "count": 1047, "sample_coef": 1.0}, "3.5": {"coefficient": 0.253, "avg_high": 122.2, "count": 1, "sample_coef": 0.5}, "4.0": {"coefficient": 0.419, "avg_high": 183.54, "count": 9, "sample_coef": 0.7}, "5.0": {"coefficient": 0.587, "avg_high": 176.02, "count": 581, "sample_coef": 1.0}, "6.0": {"coefficient": 0.29, "avg_high": 172.0, "count": 1, "sample_coef": 0.5}, "7.0": {"coefficient": 0.5, "avg_high": 450.0, "count": 1, "sample_coef": 0.5}}, "conversion": {"100-150元": {"coefficient": 0.771, "avg_high": 164.75, "count": 140, "sample_coef": 1.0}, "150-200元": {"coefficient": 0.5, "avg_high": 152.57, "count": 63, "sample_coef": 1.0}, "20-50元": {"coefficient": 0.826, "avg_high": 167.22, "count": 597, "sample_coef": 1.0}, "50-100元": {"coefficient": 0.764, "avg_high": 164.43, "count": 384, "sample_coef": 1.0}, "<20元": {"coefficient": 1.0, "avg_high": 175.07, "count": 328, "sample_coef": 1.0}, ">200元": {"coefficient": 0.634, "avg_high": 158.58, "count": 97, "sample_coef": 1.0}}};

        // 券商對照表 (修復引號問題，資料過長僅修正部分範例，但確保語法正確)
        window.BROKER_MAPPING = {"台泥一永": "元大證券", "愛之味三": "台新證券", "泰山一": "群益證券", "上曜一": "元大證券", "上曜二": "元富證券", "上曜三": "元富證券", "上曜四": "富邦證券", "上曜五": "富邦證券", "上曜六": "元富證券", "台翰一": "國泰證券", "再生一": "元大證券", "廣華一K": "國票證券", "廣華二K": "國票證券", "富林一K": "中信證券", "八貫一": "元大證券", "大魯閣一": "元大證券", "大魯閣二": "元大證券", "華友聯一": "第一金證", "華友聯二": "第一金證", "華友聯三": "國泰證券", "華友聯四": "國泰證券", "三地開發一": "統一證券", "名軒二": "凱基證券", "名軒三": "凱基證券", "宜進一": "福邦證券", "得力一": "合庫證券", "得力二": "合庫證券", "聚隆一": "元大證券", "聚隆二": "福邦證券", "聚隆三": "福邦證券", "三洋實業一": "合庫證券", "弘裕二": "兆豐證券", "弘裕三": "兆豐證券", "聚陽四": "元富證券", "東元三": "富邦證券", "正道一": "統一證券", "中興電一": "凱基證券", "中興電二": "凱基證券", "亞力一": "華南永昌", "亞力二": "元大證券", "耿鼎三": "元大證券", "日馳一": "富邦證券", "亞崴二": "元大證券", "勤美四": "台新證券", "車王電二": "凱基證券", "中宇一": "統一證券", "和大四": "台中銀證", "中砂一": "凱基證券", "濱川四": "台新證券", "濱川五": "台新證券", "濱川六": "台新證券", "信錦二": "康和證券", "信錦三": "富邦證券", "程泰一": "富邦證券", "精剛二": "富邦證券", "和勤一": "康和證券", "和勤二": "合庫證券", "和勤三": "合庫證券", "和勤四": "合庫證券", "和勤五": "台新證券", "永冠一K": "凱基證券", "永冠二K": "凱基證券", "永冠三K": "中信證券", "永冠四K": "永豐金證", "祺驊一": "兆豐證券", "祺驊二": "玉山證券", "川寶一": "群益證券", "川寶二": "福邦證券", "岱宇一": "國泰證券", "岱宇二": "統一證券", "岱宇三": "統一證券", "岱宇四": "統一證券", "宏佳騰一": "富邦證券", "大亞四": "凱基證券", "大亞五": "凱基證券", "中電二": "元大證券", "榮星三": "台新證券", "艾美特一K": "台新證券", "艾美特二K": "台新證券", "艾美特三K": "凱基證券", "艾美特四K": "凱基證券", "葡萄王一": "元大證券", "和益一": "富邦證券", "興農一": "永豐金證", "中華化一": "富邦證券", "花仙子一": "元大證券", "五鼎一": "元大證券", "五鼎二": "元大證券", "五鼎三": "兆豐證券", "南光二": "兆豐證券", "合世三": "華南永昌", "科妍一": "元大證券", "科妍二": "統一證券", "杏昌一": "元富證券", "美時三": "第一金證", "金穎生技一": "富邦證券", "易威一": "群益證券", "寶徠一": "台中銀證", "潤隆二": "永豐金證", "潤隆三": "凱基證券", "富喬一": "元大證券", "富喬三": "台銀證券", "富喬四": "台銀證券", "富喬五": "台新證券", "富喬六": "台銀證券", "榮成三": "富邦證券", "榮成四": "台新證券", "東和鋼鐵六": "國泰證券", "東和鋼鐵七": "台新證券", "春雨一": "國票證券", "春雨二": "國票證券", "春雨三": "國票證券", "聚亨三": "福邦證券", "聚亨四": "福邦證券", "新光鋼四": "康和證券", "新光鋼五": "台新證券", "允強三": "永豐金證", "允強四": "永豐金證", "風青一": "合庫證券", "風青二": "中信證券", "世鎧一": "富邦證券", "世鎧二": "富邦證券", "世豐一": "富邦證券", "世豐二": "富邦證券", "世德一": "台新證券", "世德二": "統一證券", "運錩一": "台新證券", "運錩二": "台新證券", "運錩三": "台新證券", "運錩四": "台新證券", "國際中橡三": "元大證券", "六暉一K": "凱基證券", "裕隆三": "凱基證券", "台船一": "凱基證券", "劍麟一": "元大證券", "劍麟二": "元大證券", "劍麟三": "凱基證券", "泰茂一": "華南永昌", "泰茂二": "華南永昌", "泰茂三": "華南永昌", "泰茂四": "統一證券", "為升一": "第一金證", "為升二": "第一金證", "為升三": "富邦證券", "百達一K": "富邦證券", "百達二K": "台新證券", "英利一K": "國泰證券", "英利二K": "富邦證券", "英利三K": "永豐金證", "宏旭一K": "國票證券", "IKKA一K": "凱基證券", "台揚二": "台新證券", "旺宏二": "凱基證券", "光罩三": "凱基證券", "海悅一": "兆豐證券", "順德一": "台新證券", "宏碁二": "凱基證券", "廷鑫一": "合庫證券", "致茂二": "台新證券", "燿華一": "台銀證券", "燿華二": "台銀證券", "金像電二": "富邦證券", "台光電四": "元大證券", "台光電五": "元大證券", "台光電六": "凱基證券", "台光電七": "凱基證券", "億光五": "元大證券", "億光六": "凱基證券", "研華二": "凱基證券", "毅嘉二": "福邦證券", "國碩二": "凱基證券", "國碩三": "凱基證券", "國碩四": "凱基證券", "仲琦二": "第一金證", "仲琦三": "第一金證", "仲琦四": "富邦證券", "建準三": "台新證券", "鼎元八": "第一金證", "三商電一": "台新證券", "偉詮電一": "台新證券", "美律一": "凱基證券", "美律二": "富邦證券", "美律三": "富邦證券", "美律四": "富邦證券", "美律五": "富邦證券", "新美齊二": "中信證券", "新美齊三": "台新證券", "新美齊四": "台新證券", "友旺二": "台新證券", "飛宏一": "凱基證券", "光群雷二": "富邦證券", "光群雷三": "富邦證券", "光群雷四": "中信證券", "光群雷五": "中信證券", "光群雷六": "凱基證券", "良得電二": "元大證券", "良得電三": "元大證券", "良得電四": "統一證券", "盟立二": "中信證券", "冠西電二": "福邦證券", "冠西電三": "中信證券", "立隆電二": "富邦證券", "立隆電三": "富邦證券", "鉅祥二": "中信證券", "大毅一": "富邦證券", "強茂六": "土銀證券", "強茂七": "土銀證券", "連宇二": "國票證券", "一詮五": "富邦證券", "一詮六": "福邦證券", "華新科一": "宏遠證券", "怡利電二": "國票證券", "國揚二": "宏遠證券", "龍邦三": "台新證券", "中工一": "永豐金證", "中工二": "永豐金證", "皇普一": "元大證券", "皇普二": "合庫證券", "皇普三": "台新證券", "皇普四": "台新證券", "華建三": "凱基證券", "華建四": "凱基證券", "達欣工二": "凱基證券", "達欣工四": "凱基證券", "達欣工五": "凱基證券", "聯開二": "合庫證券", "聯開三": "土銀證券", "聯開四": "土銀證券", "聯上發五": "土銀證券", "基泰二": "元富證券", "基泰三": "元富證券", "櫻花建一": "合庫證券", "櫻花建二": "合庫證券", "興富發五": "富邦證券", "日勝三": "凱基證券", "日勝四": "凱基證券", "華固三": "富邦證券", "華固四": "富邦證券", "綠意二": "合庫證券", "益航一": "兆豐證券", "益航二": "兆豐證券", "長榮四": "永豐金證", "陽明四": "凱基證券", "陽明五": "富邦證券", "華航五": "凱基證券", "華航六": "台新證券", "華航七": "台新證券", "中櫃一": "富邦證券", "中櫃二": "富邦證券", "山隆三": "中信證券", "長榮航三": "凱基證券", "長榮航四": "凱基證券", "長榮航五": "凱基證券", "亞航一": "台新證券", "亞航二": "台新證券", "台驊投二": "凱基證券", "台驊投控三": "凱基證券", "台驊投控四": "凱基證券", "慧洋一K": "富邦證券", "慧洋二K": "永豐金證", "慧洋三K": "永豐金證", "大車隊一": "康和證券", "正德一": "合庫證券", "正德二": "合庫證券", "正德三": "合庫證券", "正德四": "合庫證券", "正德五": "台中銀證", "正德六": "台中銀證", "正德七": "群益證券", "晶華一": "富邦證券", "晶華二": "富邦證券", "富驛一": "兆豐證券", "雅茗一K": "華南永昌", "王品一": "富邦證券", "瓦城一": "富邦證券", "雄獅一": "台新證券", "雄獅二": "台新證券", "六角一": "國泰證券", "六角二": "國票證券", "六角三": "凱基證券", "易飛網一": "兆豐證券", "雲品一": "元大證券", "揚秦一": "永豐金證", "聯發國際一": "統一證券", "台中一": "凱基證券", "新金1B": "永豐金證", "新光金三": "凱基證券", "新光金四": "永豐金證", "新光金五": "元大證券", "新光金六": "永豐金證", "三商一": "華南永昌", "高林一": "元富證券", "麗嬰一": "凱基證券", "農林一": "福邦證券", "農林二": "福邦證券", "東凌一": "國泰證券", "東凌二K": "富邦證券", "東凌三K": "富邦證券", "集雅社一": "富邦證券", "晶豪科一": "凱基證券", "華立一": "元大證券", "華立二": "元大證券", "華立三": "元大證券", "晟銘電三": "中信證券", "晟銘電四": "中信證券", "嘉晶二": "中信證券", "嘉晶三": "凱基證券", "嘉晶四": "凱基證券", "嘉晶五": "凱基證券", "同開一": "福邦證券", "同開二": "福邦證券", "同開三": "統一證券", "隆銘綠能四": "富邦證券", "亞光三": "凱基證券", "亞光四": "凱基證券", "信邦四": "台新證券", "信邦五": "富邦證券", "信邦六": "台新證券", "信邦七": "富邦證券", "信邦八": "台新證券", "增你強四": "群益證券", "零壹二": "元大證券", "威健三": "華南永昌", "威健四": "華南永昌", "威健五": "華南永昌", "威健六": "華南永昌", "威健七": "華南永昌", "文曄五": "福邦證券", "文曄六": "福邦證券", "晶技四": "元大證券", "晶技五": "元大證券", "科風二": "凱基證券", "台灣大三": "元大證券", "台灣大四": "元大證券", "台灣大五": "元大證券", "訊舟五": "統一證券", "訊舟六": "統一證券", "訊舟七": "統一證券", "益登一": "凱基證券", "萬國二": "國泰證券", "萬國三": "國泰證券", "總太二": "合庫證券", "銘異三": "統一證券", "普格三": "國票證券", "華義一": "國泰證券", "艾訊一": "凱基證券", "艾訊二": "凱基證券", "鴻碩一": "第一金證", "鴻碩二": "凱基證券", "及成四": "台新證券", "笙泉一": "群益證券", "笙泉二": "群益證券", "昇銳一": "群益證券", "昇銳二": "國票證券", "耀登一": "國票證券", "耀登二": "富邦證券", "晶宏一": "福邦證券", "晶宏二": "統一證券", "晶宏三": "統一證券", "正達一": "福邦證券", "正達二": "福邦證券", "正達三": "永豐金證", "波若威一": "凱基證券", "波若威二": "凱基證券", "大量一": "福邦證券", "新洲一": "群益證券", "新洲二": "永豐金證", "鑫龍騰一": "福邦證券", "樺晟二": "統一證券", "樺晟四": "統一證券", "佰研一": "凱基證券", "佰研二": "福邦證券", "耀勝一": "統一證券", "全科三": "富邦證券", "全科四": "富邦證券", "三顧二": "康和證券", "三顧三": "國票證券", "光環一": "富邦證券", "光環二": "富邦證券", "千如一": "華南永昌", "海灣二": "中信證券", "海灣三": "合庫證券", "虹冠電一": "台新證券", "威剛六": "玉山證券", "威剛七": "玉山證券", "海德威一": "合庫證券", "東碩一": "國泰證券", "東碩二": "富邦證券", "東碩三": "凱基證券", "太普二": "康和證券", "點晶一": "中信證券", "宜特三": "元大證券", "宜特四": "元富證券", "宜特五": "元富證券", "東浦一": "中信證券", "東浦二": "永豐金證", "東浦三": "統一證券", "英濟二": "中信證券", "岱稜三": "富邦證券", "岱稜四": "富邦證券", "岱稜五": "福邦證券", "昇貿二": "富邦證券", "昇貿三": "富邦證券", "昇貿四": "富邦證券", "昇貿五": "富邦證券", "佳穎一": "富邦證券", "弘憶股一": "凱基證券", "斐成二": "國泰證券", "斐成三": "合庫證券", "建舜一": "中信證券", "建舜電二": "統一證券", "建舜電三": "福邦證券", "建舜電四": "福邦證券", "建舜電五": "德信證券", "加百裕二": "凱基證券", "加百裕三": "兆豐證券", "雙鴻一": "台新證券", "雙鴻二": "台新證券", "雙鴻三": "凱基證券", "雙鴻四": "凱基證券", "雙鴻五": "凱基證券", "旭品二": "合庫證券", "旭品三": "台中銀證", "泰碩一": "康和證券", "泰碩二": "群益證券", "泰谷二": "福邦證券", "泰谷三": "福邦證券", "泰谷四": "富邦證券", "麗清一": "元大證券", "麗清二": "群益證券", "麗清三": "群益證券", "麗清四": "群益證券", "麗清五": "群益證券", "麗清六": "永豐金證", "臺慶科一": "元大證券", "先進光一": "中信證券", "上詮一": "康和證券", "上詮二": "凱基證券", "新日興三": "凱基證券", "明泰二": "富邦證券", "崇越電一": "元大證券", "旭軟一": "凱基證券", "旭軟二": "中信證券", "京鼎一": "福邦證券", "京鼎二": "福邦證券", "融程電二": "康和證券", "融程電三": "富邦證券", "哲固一": "華南永昌", "類比二": "兆豐證券", "祥業二": "工銀證券", "進泰電子三": "富邦證券", "進泰電子四": "富邦證券", "安勤三": "凱基證券", "力致二": "永豐金證", "力致三": "永豐金證", "力致四": "永豐金證", "崧騰一": "凱基證券", "崧騰二": "玉山證券", "崧騰三": "凱基證券", "森寶一": "合庫證券", "單井一": "永豐金證", "昇達科二": "凱基證券", "誠研一": "富邦證券", "皇龍一": "台新證券", "亞帝歐一": "富邦證券", "柏騰一": "台新證券", "鴻翊一": "永豐金證", "御嵿一": "兆豐證券", "凡甲二": "華南永昌", "凡甲三": "兆豐證券", "凡甲四": "凱基證券", "凡甲五": "凱基證券", "凡甲六": "凱基證券", "聚積一": "凱基證券", "嘉澤一": "元大證券", "嘉澤二": "元大證券", "晶彩科二": "華南永昌", "敦泰一": "永豐金證", "兆利一": "永豐金證", "兆利二": "永豐金證", "兆利三": "凱基證券", "同致三": "永豐金證", "嘉威一": "元大證券", "其陽一": "國泰證券", "其陽二": "台新證券", "新日光一": "凱基證券", "新日光二": "凱基證券", "聯合再生三": "凱基證券", "友威科一": "中信證券", "友威科二": "國票證券", "辛耘一": "富邦證券", "辛耘二": "富邦證券", "閎康一": "元大證券", "艾笛一": "永豐金證", "艾笛二": "永豐金證", "艾笛森三": "富邦證券", "艾笛森四": "國泰證券", "磐儀一": "永豐金證", "磐儀二": "永豐金證", "磐儀三": "福邦證券", "智易一": "凱基證券", "映興一": "福邦證券", "宏致二": "元大證券", "宏致三": "凱基證券", "谷崧一": "兆豐證券", "谷崧二": "兆豐證券", "東林一": "宏遠證券", "鼎翰一": "凱基證券", "碩天一": "宏遠證券", "碩天二": "宏遠證券", "碩天三": "富邦證券", "西勝一": "群益證券", "西勝二": "國票證券", "西勝三": "凱基證券", "晟楠一": "元大證券", "晟楠二": "元大證券", "晟楠三": "國票證券", "研勤一": "台新證券", "研勤二": "富邦證券", "達邁一": "元大證券", "健策二": "富邦證券", "健策三": "富邦證券", "鑫科一": "台新證券", "鑫科二": "台新證券", "鑫科三": "富邦證券", "貿聯一": "中信證券", "貿聯二K": "群益證券", "家登一": "國泰證券", "家登二": "統一證券", "家登三": "統一證券", "家登四": "統一證券", "歐買尬一": "第一金證", "湧德一": "統一證券", "湧德二": "統一證券", "湧德三": "統一證券", "湧德四": "國票證券", "碩禾一": "凱基證券", "碩禾二": "元大證券", "碩禾三": "宏遠證券", "營邦一": "元大證券", "大眾控一": "台中銀證", "大眾控二": "台中銀證", "大聯大一": "凱基證券", "大聯大二": "元大證券", "大聯大三": "元大證券", "漢磊一": "凱基證券", "漢磊二": "凱基證券", "漢磊三": "凱基證券", "漢磊四": "凱基證券", "上緯投控一": "元大證券", "上緯投控二": "元大證券", "上緯投控三": "元大證券", "上緯投控四": "元大證券", "連展投控一": "統一證券", "新晶投控一": "第一金證", "佳醫五": "合庫證券", "雃博一": "元大證券", "邦特二": "元大證券", "加捷生醫三": "康和證券", "聯上二": "國票證券", "聯上三": "台新證券", "聯上四": "台新證券", "健喬五": "工銀證券", "旭富一": "永豐金證", "優盛二": "凱基證券", "晟德一": "元富證券", "晟德二": "元富證券", "晟德三": "元富證券", "晟德四": "元富證券", "晟德五": "元富證券", "晟德六": "元富證券", "晟德七": "元富證券", "聯骨一": "富邦證券", "聯合二": "富邦證券", "聯合三": "凱基證券", "聯合四": "凱基證券", "健亞一": "元大證券", "麗豐一K": "福邦證券", "麗豐二K": "富邦證券", "曜亞一": "元富證券", "曜亞二": "國泰證券", "國光生一": "土銀證券", "國光生二": "土銀證券", "全宇生技一K": "永豐金證", "鈺緯一": "群益證券", "鈺緯二": "群益證券", "訊映一": "統一證券", "訊映二": "統一證券", "訊映三": "統一證券", "聿新科一": "福邦證券", "鐿鈦一": "台新證券", "承業醫一": "永豐金證", "承業醫二": "中信證券", "承業醫三": "元富證券", "承業醫四": "富邦證券", "承業醫五": "台新證券", "展旺一": "土銀證券", "松瑞藥二": "土銀證券", "醣聯一": "台新證券", "醣聯二": "台新證券", "醣聯三": "台新證券", "瑞基一": "富邦證券", "瑞基二": "富邦證券", "杏一一": "國泰證券", "杏一二": "國泰證券", "佐登一K": "永豐金證", "佐登二K": "永豐金證", "佐登三K": "統一證券", "環泰二": "宏遠證券", "信立一": "台中銀證", "炎洲七": "元大證券", "炎洲八": "元大證券", "炎洲九": "元大證券", "福大一": "統一證券", "如興三": "元大證券", "如興四": "凱基證券", "三圓一": "元富證券", "三圓二": "台新證券", "三圓三": "第一金證", "耀億一": "凱基證券", "興采一": "凱基證券", "興采二": "凱基證券", "廣越一": "凱基證券", "廣越二": "凱基證券", "冠星一K": "凱基證券", "高鋒二": "群益證券", "永彰一": "凱基證券", "瑞智二": "元大證券", "慶騰二": "中信證券", "慶騰三": "中信證券", "大詠城一": "富邦證券", "全球傳動一": "凱基證券", "全球傳動二": "凱基證券", "晟田一": "凱基證券", "晟田二": "凱基證券", "晟田三": "凱基證券", "晟田四": "凱基證券", "科嶠一": "富邦證券", "桓達一": "凱基證券", "長佳一": "國票證券", "智伸科一": "兆豐證券", "氣立一": "富邦證券", "氣立二": "富邦證券", "氣立三": "富邦證券", "旭然一": "合庫證券", "旭然二": "合庫證券", "強信一K": "富邦證券", "百德一": "富邦證券", "元翎一": "永豐金證", "時碩工業一": "凱基證券", "時碩工業二": "凱基證券", "時碩工業三": "凱基證券", "六方科一K": "元大證券", "駐龍一": "台新證券", "捷流閥業一": "元大證券", "永捷一": "元大證券", "永捷二": "元大證券", "永捷三": "中信證券", "永捷四": "中信證券", "永捷五": "元富證券", "永捷六": "富邦證券", "永捷七": "富邦證券", "大立二": "合庫證券", "德淵一": "元富證券", "德淵二": "福邦證券", "德淵三": "福邦證券", "熒茂一": "台新證券", "豪展一": "第一金證", "豪展二": "第一金證", "泰博一": "凱基證券", "泰博二": "凱基證券", "泰博三": "凱基證券", "華廣一": "富邦證券", "康普一": "福邦證券", "康普二": "福邦證券", "康普三": "福邦證券", "皇將一": "福邦證券", "皇將二": "福邦證券", "合富一K": "宏遠證券", "台耀一": "凱基證券", "台耀二": "凱基證券", "台耀三": "凱基證券", "強生一": "統一證券", "勤凱一": "富邦證券", "材料一K": "國泰證券", "材料二K": "永豐金證", "材料三K": "富邦證券", "雙鍵一": "富邦證券", "大略一K": "富邦證券", "昇華一": "國票證券", "昇華二": "國票證券", "日成一K": "台新證券", "正文三": "元大證券", "正文四": "中信證券", "正文五": "凱基證券", "正文六": "凱基證券", "聯控一": "中信證券", "聯德控股二K": "凱基證券", "聯德控股三K": "群益證券", "聯德控股四K": "富邦證券", "事欣科一": "凱基證券", "事欣科二": "台新證券", "事欣科三": "統一證券", "事欣科四": "統一證券", "新唐一": "中信證券", "欣厚一": "永豐金證", "泰鼎一": "華南永昌", "泰鼎二K": "凱基證券", "泰鼎三K": "凱基證券", "友輝一": "凱基證券", "亞電一": "統一證券", "亞電二": "統一證券", "康控一K": "中信證券", "光鋐一": "凱基證券", "十銓一": "群益證券", "十銓二": "第一金證", "十銓三": "永豐金證", "立積一": "台新證券", "英特一": "中信證券", "IET二K": "永豐金證", "亞泰一": "凱基證券", "亞泰二": "凱基證券", "眾達一K": "統一證券", "華星光一": "永豐金證", "華星光二": "永豐金證", "華星光三": "富邦證券", "華星光四": "富邦證券", "環宇一K": "兆豐證券", "環宇二K": "兆豐證券", "晶達一": "永豐金證", "榮剛六": "兆豐證券", "榮剛七": "凱基證券", "久陽一": "兆豐證券", "久陽二": "兆豐證券", "久陽三": "兆豐證券", "久陽四": "兆豐證券", "新鼎一": "凱基證券", "凌網一": "統一證券", "亞昕三": "國票證券", "亞昕四": "國票證券", "亞昕五": "兆豐證券", "亞昕六": "土銀證券", "亞昕七": "富邦證券", "科嘉一K": "國泰證券", "安力一K": "富邦證券", "東科一K": "凱基證券", "雷笛克光學一": "凱基證券", "雷笛克光學二": "凱基證券", "雷笛克光學三": "富邦證券", "弘凱一": "宏遠證券", "智晶一": "合庫證券", "智崴一": "台新證券", "智崴二": "台新證券", "智崴三": "台新證券", "智崴四": "台新證券", "智崴五": "台新證券", "jpp一K": "元大證券", "jpp二K": "福邦證券", "jpp三K": "凱基證券", "界霖一": "宏遠證券", "界霖二": "台新證券", "豐祥一K": "元大證券", "宜鼎一": "富邦證券", "邑昇一": "兆豐證券", "桂盟三": "凱基證券", "桂盟四": "凱基證券", "系統電二": "元大證券", "系統電三": "統一證券", "系統電四": "富邦證券", "系統電五": "統一證券", "美而快一": "台新證券", "鈺創三": "第一金證", "佳總三": "台新證券", "中磊四": "凱基證券", "中磊五": "凱基證券", "中磊六": "台新證券", "中磊七": "台新證券", "應華三": "凱基證券", "台半五": "凱基證券", "崇越二": "福邦證券", "南良一": "富邦證券", "佶優一": "統一證券", "宣德二": "台新證券", "宣德三": "凱基證券", "霖宏一": "台新證券", "德宏四": "合庫證券", "德宏五": "合庫證券", "德宏六": "合庫證券", "德宏七": "國泰證券", "德宏八": "國泰證券", "德宏九": "永豐金證", "凱崴二": "宏遠證券", "凱崴三": "宏遠證券", "隆大一": "合庫證券", "隆大二": "合庫證券", "隆大三": "合庫證券", "隆大四": "合庫證券", "遠雄五": "元富證券", "遠雄六": "元富證券", "志嘉一": "中信證券", "長虹三": "永豐金證", "聖暉一": "國票證券", "東明一K": "凱基證券", "桓鼎一K": "國票證券", "桓鼎二K": "國票證券", "桓鼎三K": "國票證券", "桓鼎四K": "國票證券", "永固一K": "中信證券", "四維航四": "兆豐證券", "四維航五": "兆豐證券", "四維航六": "永豐金證", "四維航七": "永豐金證", "中租一K": "凱基證券", "南仁湖二": "元大證券", "南仁湖四": "統一證券", "宏遠證一": "凱基證券", "宏遠證二": "凱基證券", "創惟一": "富邦證券", "大宇資二": "第一金證", "鎰勝三": "永豐金證", "迎廣一": "台新證券", "廣運五": "元大證券", "信音二": "台新證券", "信音三": "元大證券", "九豪四": "福邦證券", "萬旭一": "元大證券", "萬旭二": "中信證券", "亞翔一": "統一證券", "亞翔二": "統一證券", "亞翔三": "統一證券", "亞翔四": "統一證券", "耕興二": "凱基證券", "撼訊四": "宏遠證券", "撼訊五": "宏遠證券", "撼訊六": "宏遠證券", "嘉聯益三": "元大證券", "嘉聯益四": "台新證券", "松上二": "台新證券", "松上三": "台新證券", "松上四": "台新證券", "捷波三": "統一證券", "華電網三": "華南永昌", "華電網四": "統一證券", "宏齊四": "凱基證券", "統振三": "國票證券", "立敦二": "中信證券", "立敦三": "台新證券", "立敦四": "富邦證券", "瑞儀一": "宏遠證券", "達麗四": "土銀證券", "達麗五": "合庫證券", "達麗六": "合庫證券", "達麗七": "國泰證券", "亞通一": "國票證券", "亞通二": "兆豐證券", "亞通三": "兆豐證券", "亞通四": "兆豐證券", "橘子一": "兆豐證券", "合晶五": "台新證券", "合晶六": "台新證券", "合晶七": "富邦證券", "合晶八": "富邦證券", "大豐電一": "宏遠證券", "大豐電二": "宏遠證券", "大豐電三": "國泰證券", "萬潤四": "台新證券", "萬潤五": "兆豐證券", "豐藝三": "群益證券", "豐藝四": "台中銀證", "萬泰科四": "元大證券", "萬泰科五": "元富證券", "萬泰科六": "元富證券", "詩肯二": "國泰證券", "帆宣三": "富邦證券", "帆宣四": "富邦證券", "帆宣五": "富邦證券", "佳必琪二": "兆豐證券", "佳必琪三": "元大證券", "海韻電一": "富邦證券", "詮欣三": "台中銀證", "雷科四": "中信證券", "日揚三": "凱基證券", "今國光二": "國票證券", "中探針三": "中信證券", "中探針四": "凱基證券", "富旺一": "福邦證券", "富旺二": "福邦證券", "富旺三": "國泰證券", "岳豐六": "凱基證券", "岳豐七": "凱基證券", "岳豐八": "凱基證券", "岳豐九": "凱基證券", "旺矽三": "凱基證券", "旺矽四": "凱基證券", "旺矽五": "凱基證券", "聚鼎一": "凱基證券", "光鼎四": "國泰證券", "迅杰三": "福邦證券", "立端二": "宏遠證券", "沛波二": "國票證券", "沛波三": "國票證券", "沛波四": "兆豐證券", "矽格二": "凱基證券", "矽格三": "凱基證券", "矽格四": "凱基證券", "百徽二": "永豐金證", "久元三": "凱基證券", "富裔一": "元富證券", "台郡三": "元大證券", "台郡四": "元大證券", "台郡五": "元大證券", "台郡六": "元大證券", "同欣電一": "凱基證券", "台燿二": "富邦證券", "台燿三": "富邦證券", "台燿四": "國泰證券", "元山四": "第一金證", "元山五": "台新證券", "元山六": "第一金證", "胡連一": "永豐金證", "康舒一": "凱基證券", "康舒二": "凱基證券", "淳安一": "群益證券", "淳安二": "中信證券", "佳邦二": "兆豐證券", "佳邦三": "台新證券", "啟碁一": "凱基證券", "啟碁二": "凱基證券", "啟碁三": "凱基證券", "元隆四": "華南永昌", "元隆五": "國票證券", "聯嘉一": "永豐金證", "聯嘉二": "永豐金證", "聯嘉三": "永豐金證", "聯嘉四": "統一證券", "良維一": "元大證券", "良維二": "元大證券", "良維三": "中信證券", "良維四": "中信證券", "良維五": "元大證券", "良維六": "元大證券", "良維七": "凱基證券", "良維八": "凱基證券", "良維九": "富邦證券", "樺漢一": "福邦證券", "樺漢二": "凱基證券", "樺漢三": "元大證券", "樺漢四": "國票證券", "樺漢五": "凱基證券", "瑞祺電通一": "國票證券", "易發一": "福邦證券", "統新一": "台新證券", "今展科一": "永豐金證", "今展科二": "統一證券", "今展科三": "統一證券", "今展科四": "統一證券", "迅得一": "台新證券", "迅得二": "凱基證券", "廣錠一": "國票證券", "廣錠二": "國票證券", "廣錠三": "國票證券", "廣錠四": "國票證券", "廣錠五": "國票證券", "光聖一": "台新證券", "鈺邦一": "元大證券", "鈺邦二": "元大證券", "訊芯一K": "福邦證券", "訊芯二K": "福邦證券", "威潤一": "富邦證券", "大樹一": "富邦證券", "大樹二": "統一證券", "保瑞一": "台新證券", "保瑞二": "台新證券", "保瑞三": "台新證券", "安集一": "福邦證券", "安集二": "國泰證券", "安集三": "福邦證券", "安集四": "福邦證券", "互動一": "富邦證券", "互動二": "富邦證券", "科懋一": "凱基證券", "聚和四": "凱基證券", "聚和五": "台新證券", "聚和六": "凱基證券", "穎崴一": "凱基證券", "瑞耘一": "玉山證券", "正基一": "凱基證券", "高端疫苗一": "富邦證券", "長科一": "凱基證券", "易華電一": "台新證券", "興能高一": "元大證券", "維田一": "中信證券", "虹揚一K": "康和證券", "達邦蛋白一": "兆豐證券", "南俊國際一": "凱基證券", "南俊國際二": "凱基證券", "鼎基一": "第一金證", "鼎基二": "第一金證", "台康生技一": "元大證券", "動力一K": "康和證券", "動力二K": "康和證券", "動力三K": "康和證券", "台灣銘板一": "統一證券", "富強鑫二": "第一金證", "富強鑫三": "統一證券", "朋億一": "國票證券", "特昇一K": "永豐金證", "特昇二K": "第一金證", "特昇三K": "第一金證", "萬年清一": "玉山證券", "泰金一K": "中信證券", "泰金二K": "元大證券", "基士德一K": "永豐金證", "天正國際一": "凱基證券", "科定一": "國票證券", "群翊一": "福邦證券", "群翊二": "福邦證券", "中揚光一": "凱基證券", "中揚光二": "凱基證券", "中揚光三": "凱基證券", "復盛應用一": "富邦證券", "鑫創電子一": "台新證券", "惠特一": "凱基證券", "惠特二": "凱基證券", "嘉基一": "中信證券", "嘉基二": "中信證券", "亞泰金屬一": "統一證券", "龍德造船一": "元大證券", "穩得一": "富邦證券", "志強一K": "元大證券", "晉弘一": "福邦證券", "明係一": "兆豐證券", "森崴能源一": "福邦證券", "濾能一": "永豐金證", "汎銓一": "台新證券", "圓裕一": "中信證券", "東研信超一": "康和證券", "綠茵一": "富邦證券", "綠茵二": "富邦證券", "錼創科技-K創一": "中信證券", "永道一K": "富邦證券", "雲豹能源一": "凱基證券", "騰雲一": "元大證券", "騰雲二": "元大證券", "泓德能源一": "元大證券", "倍力一": "富邦證券", "邑錡一": "統一證券", "台通一": "元富證券", "台通二": "元富證券", "台通三": "元富證券", "台通四": "元富證券", "鈦昇一": "合庫證券", "鈦昇二": "合庫證券", "鈦昇三": "台中銀證", "昇陽半導體一": "富邦證券", "昇陽半導體二": "永豐金證", "長園科一": "合庫證券", "金山電三": "凱基證券", "金山電四": "凱基證券", "金山電五": "福邦證券", "網家一": "凱基證券", "晶采三": "凱基證券", "廣積三": "台新證券", "廣積四": "台新證券", "廣積五": "台新證券", "廣積六": "台新證券", "來思達一": "合庫證券", "長華一": "元大證券", "長華二": "群益證券", "長華三": "群益證券", "長華四": "凱基證券", "長華五": "台新證券", "鉅橡三": "華南永昌", "鉅橡四": "華南永昌", "鉅橡五": "康和證券", "伍豐三": "第一金證", "伍豐四": "富蘭克林證券", "翔名二": "中信證券", "翔名三": "中信證券", "翔名四": "玉山證券", "建暐二": "台銀證券", "建暐三": "國票證券", "建暐四": "國票證券", "常珵二": "富邦證券", "瀚荃四": "群益證券", "錸寶一": "福邦證券", "錸寶二": "福邦證券", "大億二": "台新證券", "大億三": "台新證券", "博大一": "凱基證券", "華東一": "元大證券", "華東二": "元大證券", "至上一": "永豐金證", "至上二": "元大證券", "至上三": "元大證券", "至上四": "元大證券", "至上五": "元大證券", "至上六": "台新證券", "至上七": "台新證券", "至上八": "台新證券", "至上九": "永豐金證", "振樺電一": "群益證券", "振樺電二": "群益證券", "正淩一": "凱基證券", "正淩二": "富邦證券", "正淩三": "中信證券", "博智一": "凱基證券", "天宇一": "福邦證券", "天宇二": "福邦證券", "天宇三": "富邦證券", "天宇四": "台中銀證", "天宇五": "台中銀證", "勤誠一": "元大證券", "志超一": "福邦證券", "華宏二": "台新證券", "朋程一": "元大證券", "商丞一": "群益證券", "群聯一": "宏遠證券", "群聯二": "凱基證券", "恒耀二": "中信證券", "恒耀三": "凱基證券", "恒耀四": "凱基證券", "建新國際一": "凱基證券", "羅昇一": "凱基證券", "羅昇二": "台新證券", "金益四": "國泰證券", "金益鼎五": "玉山證券", "白紗一": "合庫證券", "盛弘一": "富邦證券", "盛弘二": "富邦證券", "盛弘三": "富邦證券", "福貞一K": "凱基證券", "福貞二K": "永豐金證", "明揚一": "台新證券", "旭源一": "華南永昌", "可寧衛一": "台新證券", "可寧衛二": "台新證券", "金麗一K": "國泰證券", "匯鑽科一": "中信證券", "弘帆一": "玉山證券", "弘帆二": "玉山證券", "弘帆三": "玉山證券", "大江一": "富邦證券", "大江二": "富邦證券", "大地一K": "永豐金證", "大地二K": "永豐金證", "威宏一K": "富邦證券", "威宏二K": "富邦證券", "霹靂一": "永豐金證", "柏文一": "永豐金證", "柏文二": "永豐金證", "柏文三": "永豐金證", "美吉吉一K": "凱基證券", "美吉吉二K": "台新證券", "波力一K": "富邦證券", "波力二K": "富邦證券", "波力三K": "富邦證券", "山林水一": "兆豐證券", "山林水二": "兆豐證券", "台境一": "兆豐證券", "東哥遊艇一": "凱基證券", "吉源一K": "玉山證券", "三貝德一": "台中銀證", "鼎炫一K": "永豐金證", "光隆一": "凱基證券", "北基三": "兆豐證券", "北基四": "兆豐證券", "北基五": "合庫證券", "北基六": "合庫證券", "北基七": "合庫證券", "北基八": "合庫證券", "宏大一": "統一證券", "愛地雅二": "台新證券", "愛地雅三": "台新證券", "愛地雅四": "台新證券", "愛地雅五": "台新證券", "國統四": "台銀證券", "明安三": "台新證券", "森鉅四": "群益證券", "高力三": "兆豐證券", "高力四": "兆豐證券", "鈺齊一K": "國泰證券", "鈺齊二K": "國泰證券", "鈺齊三K": "國泰證券", "鈺齊四K": "國票證券", "鈺齊五K": "國票證券", "鈺齊六K": "國票證券", "欣巴巴一": "統一證券", "欣巴巴二": "國泰證券", "欣巴巴三": "國泰證券", "巨大一": "凱基證券", "中鼎二": "國泰證券", "成霖二": "凱基證券", "慶豐富三": "凱基證券", "宏全二": "台新證券", "裕融一": "元大證券", "裕融二": "凱基證券", "新麗二": "兆豐證券", "三發一": "永豐金證", "佳龍一": "永豐金證", "佳龍二": "永豐金證", "佳龍三": "永豐金證", "世紀鋼一": "群益證券", "世紀鋼二": "群益證券", "世紀鋼三": "群益證券", "世紀鋼四": "群益證券", "世紀鋼五": "永豐金證", "世紀鋼六": "永豐金證", "世紀鋼七": "永豐金證", "世紀鋼八永": "永豐金證", "遠東新E1永": "凱基證券", "遠東新E2永": "凱基證券", "友訊E1": "元大證券", "明基E1": "凱基證券", "國碩E1": "凱基證券", "國碩E2": "凱基證券", "兆豐金E1": "凱基證券", "兆豐金E2": "富邦證券", "台新金E1": "凱基證券", "至上十": "凱基證券", "百和興業一K": "中信證券", "安集五": "福邦證券", "麗升能源二": "兆豐證券", "平和環保一創": "群益證券", "良維十": "富邦證券", "事欣科五": "統一證券", "迎廣二": "台新證券", "三洋實業二": "台新證券", "泓德能源二": "元大證券", "聯合五": "凱基證券", "健策四": "富邦證券", "氣立四": "富邦證券", "健策五": "富邦證券", "三洋實業三": "台新證券", "聚隆四": "國票證券", "鑫龍騰二": "凱基證券", "倉和一": "統一證券", "汎德一": "群益證券", "汎德二": "群益證券", "遠見一": "統一證券", "大井泵浦一": "永豐金證", "凡甲七": "凱基證券", "大樹三": "國泰證券", "竣邦一K": "台新證券", "福貞三K": "台新證券", "科妍三": "統一證券", "大井泵浦二": "永豐金證", "進典一": "永豐金證", "弘塑二": "凱基證券", "大量二": "福邦證券", "正德八": "群益證券", "意德士一": "元大證券", "意德士二": "元大證券", "光隆精密一K": "第一金證", "聯寶一": "統一證券", "鑫龍騰三": "凱基證券", "邑錡二": "統一證券", "漢磊五": "凱基證券", "雷科五": "凱基證券", "雷科六": "凱基證券", "寶緯一": "華南永昌", "山富一": "國泰證券", "晶心科一": "凱基證券", "動力四K": "康和證券", "高技一": "凱基證券", "太普高三": "永豐金證", "醣聯四": "統一證券", "廣越三": "凱基證券", "國精化三": "富邦證券", "歐買尬二": "元富證券", "裕慶一K": "凱基證券", "歐買尬三": "元富證券", "鮮活果汁一K": "兆豐證券", "八方雲集一": "元大證券", "凱衛一": "兆豐證券", "富旺四": "統一證券", "華電網五": "統一證券", "八方雲集二": "元大證券", "威力德一": "台新證券", "今國光三": "中信證券", "聯上五": "合庫證券", "世禾三": "凱基證券", "榮昌一": "群益證券", "欣興一": "中信證券", "萬泰科七": "國票證券", "台燿五": "國泰證券", "精成科二": "宏遠證券", "復盛應用二": "台新證券", "聯上六": "合庫證券", "百達三K": "台新證券", "群聯三": "凱基證券", "偉訓一": "統一證券", "偉訓二": "統一證券", "毅嘉三": "兆豐證券", "金山電六": "永豐金證", "金像電三": "富邦證券", "晉弘二": "富邦證券", "台特化一": "元大證券", "光聖二": "台新證券", "光聖三": "台新證券", "伯鑫一": "國泰證券", "來億一K": "富邦證券", "來億二K": "富邦證券", "州巧一": "福邦證券", "系統電六": "富邦證券", "系統電七": "富邦證券"};
    </script>

    <script>
        let statistics = null;
        let cbDatabase = null;
        let cbNameMap = {};
        let auctionRawData = [];
        let globalMarketStats = { low: 0, avg: 0 };

        function safeFloat(val) {
            if (val === undefined || val === null || val === '') return 0;
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        }

        // 獲取權重係數
        function getWeightCoefficient(category, value) {
            if (!window.WEIGHT_COEFFICIENTS || !window.WEIGHT_COEFFICIENTS[category]) {
                return 1.0;
            }
            const coefData = window.WEIGHT_COEFFICIENTS[category][value];
            if (!coefData) {
                return 1.0;
            }
            return coefData.coefficient;
        }

        // 查詢券商
        function getBrokerName(cbName) {
            if (!window.BROKER_MAPPING) return null;
            return window.BROKER_MAPPING[cbName] || null;
        }

        // 分類函數
        function classifyCapital(value) {
            if (value < 3) return '<3億';
            if (value < 6) return '3~6億';
            if (value < 10) return '6~10億';
            if (value < 15) return '10~15億';
            if (value < 20) return '15~20億';
            return '>20億';
        }

        function classifySize(value) {
            if (value < 2) return '<2億';
            if (value < 5) return '2~5億';
            if (value < 10) return '5~10億';
            if (value < 15) return '10~15億';
            if (value < 20) return '15~20億';
            return '>20億';
        }

        function classifyConversionPrice(value) {
            if (value < 20) return '<20元';
            if (value < 50) return '20-50元';
            if (value < 100) return '50-100元';
            if (value < 150) return '100-150元';
            if (value < 200) return '150-200元';
            return '>200元';
        }

        function classifyYears(value) {
            return value.toString();
        }

        // 資料讀取
        async function loadStatistics() {
            const loadingDiv = document.getElementById('loading');
            const detailDiv = document.getElementById('loading-detail');
            
            try {
                detailDiv.textContent = "正在同步讀取數據庫...";
                
                // 嘗試讀取外部 JSON，若失敗則使用內嵌資料
                let resMain = null;
                try {
                    const response = await fetch('cb_data_integrated.json');
                    if (response.ok) {
                        resMain = await response.json();
                    }
                } catch (e) {
                    console.warn("外部資料庫讀取失敗，切換至內嵌模式");
                }

                if (!resMain) {
                    // 建構內嵌資料模式
                    resMain = {
                        '統計數據': {
                            '維度統計': window.WEIGHT_COEFFICIENTS,
                            '資料期間': { '總筆數': '內嵌離線版' }
                        },
                        '競拍原始資料': [], // 離線版無原始資料
                        'CB資料庫': {}      // 離線版無詳細CB資料
                    };
                }

                statistics = resMain['統計數據'];
                auctionRawData = resMain['競拍原始資料'] || [];
                cbDatabase = resMain['CB資料庫'] || {};

                if (cbDatabase) {
                    Object.values(cbDatabase).forEach(item => {
                        if (item['名稱']) {
                            cbNameMap[item['名稱']] = item;
                        }
                    });
                }

                calculateGlobalMarketStats();
                initializeUI();
                loadingDiv.style.display = 'none';
                document.querySelector('.container').style.display = 'block';

            } catch (error) {
                console.error(error);
                loadingDiv.innerHTML = `<div style="padding:30px; background:white; color:#d32f2f; border-radius:10px; text-align:center; max-width:80%;"><h3>❌ 系統啟動失敗</h3><p>${error.message}</p></div>`;
            }
        }

        function calculateGlobalMarketStats() {
            if (auctionRawData.length > 0) {
                let sumLow = 0, sumAvg = 0, count = 0;
                auctionRawData.forEach(d => {
                    const l = safeFloat(d['最低溢價']);
                    const a = safeFloat(d['平均溢價']);
                    if (l !== 0 || a !== 0) { sumLow += l; sumAvg += a; count++; }
                });
                if (count > 0) {
                    globalMarketStats.low = (sumLow / count) * 100;
                    globalMarketStats.avg = (sumAvg / count) * 100;
                }
            } else {
                // 若無原始資料，給予一個保守預設值 (避免除以零)
                globalMarketStats.low = 5.0;
                globalMarketStats.avg = 8.0;
            }
        }

        function findBestRangeKey(category, value) {
            if (!statistics || !statistics['維度統計'] || !statistics['維度統計'][category]) return null;
            const keys = Object.keys(statistics['維度統計'][category]);
            for (let key of keys) {
                let rawKey = key.replace(/億|元|年期|年/g, '').trim();
                if (rawKey.includes('~') || rawKey.includes('-')) {
                    let parts = rawKey.split(/[~-]/).map(s => parseFloat(s.trim()));
                    if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                        if (value >= parts[0] && value < parts[1]) return key;
                    }
                }
            }
            return null;
        }

        function getStatsSmart(category, val) {
            let stats = { low: 0, avg: 0, usedFallback: false, rawData: null };
            
            if (statistics['維度統計'] && statistics['維度統計'][category]) {
                let data = statistics['維度統計'][category][val];
                if (!data && typeof val === 'number') {
                    const key = findBestRangeKey(category, val);
                    if (key) data = statistics['維度統計'][category][key];
                }
                
                if (data) {
                    stats.rawData = data;
                    // 注意：內嵌資料中的 avg_high 代表平均最高，這邊假設邏輯對應調整
                    // 如果資料結構不同，這裡需要針對 WEIGHT_COEFFICIENTS 的結構做適配
                    // 這裡假設 sample_coef 等於 1.0 時可參考係數
                    
                    // 由於 WEIGHT_COEFFICIENTS 結構只有 coefficient/avg_high，沒有 '平均最低溢價' 欄位
                    // 我們需要用 globalMarketStats 搭配 coefficient 反推估計值
                    if (data['平均最低溢價'] !== undefined) {
                        stats.low = safeFloat(data['平均最低溢價']);
                        stats.avg = safeFloat(data['平均溢價']);
                    } else {
                        // 使用係數推估
                        const coef = data.coefficient || 1.0;
                        stats.low = globalMarketStats.low * coef;
                        stats.avg = globalMarketStats.avg * coef;
                    }
                }
            }

            if (stats.low === 0 && stats.avg === 0) {
                stats.low = globalMarketStats.low;
                stats.avg = globalMarketStats.avg;
                stats.usedFallback = true;
            }

            return stats;
        }

        function generateStandardCard(data, titleOverride=null) {
            if (!data) return `<div class="stat-row" style="color:#999;">查無資料</div>`;
            const val = (v, suffix='') => (v !== undefined && v !== null && v !== '' && v !== 0) ? `${safeFloat(v).toFixed(2)}${suffix}` : '-';
            let html = `<div class="stats-header">📊 ${titleOverride || '歷史統計'}</div>`;
            if (data['樣本數'] || data['count']) {
                html += `<div class="stat-row" style="color:#555; font-weight:bold;">樣本數: ${data['樣本數'] || data['count']} 檔</div>`;
            }
            
            // 處理顯示邏輯
            let lowShow = data['平均最低溢價'] !== undefined ? val(data['平均最低溢價'], '%') : '依係數推估';
            let avgShow = data['平均溢價'] !== undefined ? val(data['平均溢價'], '%') : (data['coefficient'] ? `係數: ${data['coefficient']}` : '-');

            html += `<div style="background:#f1f8e9; padding:8px; border-radius:5px; margin:8px 0;"> <div class="stat-row"><span>📉 最低溢價:</span><span class="stat-value">${lowShow}</span></div> <div class="stat-row"><span>⚖️ 平均溢價:</span><span class="stat-value">${avgShow}</span></div> </div>`;
            return html;
        }

        function initializeUI() {
            document.getElementById('headerSubtitle').textContent = `Rex大叔的168台股投資教室 | 整合${Object.keys(cbDatabase).length}檔CB完整資料庫`;
            if (statistics['維度統計']['產業']) populateSelect('industry', statistics['維度統計']['產業']);
            if (statistics['維度統計']['發行券商']) populateSelect('broker', statistics['維度統計']['發行券商']);
            showStatsSummary();
            bindInputEvents();
        }

        function populateSelect(id, dataObj) {
            if (!dataObj) return;
            const select = document.getElementById(id);
            while (select.options.length > 1) { select.remove(1); }
            const items = Object.keys(dataObj).sort((a, b) => ((dataObj[b]['樣本數'] || dataObj[b]['count']) || 0) - ((dataObj[a]['樣本數'] || dataObj[a]['count']) || 0));
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }

        function showStatsSummary() {
            const dbCount = Object.keys(cbDatabase).length || 0;
            const txCount = statistics['資料期間']['總筆數'] || 'N/A';
            document.getElementById('statsSummary').innerHTML = `<div class="stat-box"><div class="number">${dbCount}</div><div class="label">CB資料庫</div></div> <div class="stat-box"><div class="number">${txCount}</div><div class="label">競拍案例</div></div>`;
        }

        function bindInputEvents() {
            const show = (id, html) => {
                const el = document.getElementById(id);
                if (el) { el.innerHTML = html||''; el.style.display = html?'block':'none'; }
            };

            document.getElementById('cbName').addEventListener('input', function() {
                const val = this.value.trim();
                if (!val) { show('cbNameInfo', null); return; }
                let found = cbNameMap[val] || Object.values(cbDatabase).find(d => d['名稱'] && d['名稱'].includes(val));
                if (found) {
                    let html = `<div class="stats-header">📊 掛牌價格參考</div><div class="stat-row">${found['代號'] || ''} / ${found['股票代號'] || ''}</div>`;
                    show('cbNameInfo', html);
                } else show('cbNameInfo', null);
            });

            const bind = (id, cat, isNum) => {
                document.getElementById(id).addEventListener(isNum ? 'input' : 'change', function() {
                    const val = isNum ? parseFloat(this.value) : this.value;
                    if (val) {
                        const smartResult = getStatsSmart(cat, val);
                        let key = isNum ? findBestRangeKey(cat, val) || val : val;
                        show(id+'Info', generateStandardCard(smartResult.rawData, `歷史統計 (${key})`));
                        updateSmartReminders();
                    }
                });
            };

            bind('capital', '股本', true);
            bind('issueSize', '發行規模', true);
            bind('conversionPrice', 'conversion', true); // 修正對應 key
            bind('industry', 'industry', false); // 修正對應 key
            bind('broker', 'broker', false); // 修正對應 key
            bind('years', 'years', true); // 修正對應 key
            bind('guarantee', 'guarantee', false); // 修正對應 key
            bind('rating', 'rating', false); // 修正對應 key
            document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
        }

        function updateSmartReminders() {
            const stock = parseFloat(document.getElementById('stockPrice').value);
            const conv = parseFloat(document.getElementById('conversionPrice').value);
            const div = document.getElementById('smartReminders');
            if (stock && conv) {
                const theo = (stock/conv)*100;
                let msg = theo > 110 ? '⚠️ 理論價偏高，注意溢價風險' : theo < 85 ? '💡 理論價位於低檔，可能有套利空間' : '✨ 理論價位於合理區間';
                document.getElementById('reminderContent').textContent = msg;
                div.style.display = 'block';
            }
        }

        function generateRexCommentary(result) {
            const prem = parseFloat(result.totalAvgPremium);
            let comment = "", strategy = "";
            if (prem >= 15) {
                comment = "🔥 市場過熱警示：溢價率極高，注意風險。";
                strategy = "建議採保守策略，避免追高。";
            } else if (prem >= 8) {
                comment = "📈 多頭趨勢明確：市場情緒樂觀。";
                strategy = "可採積極策略，但留意風險。";
            } else if (prem >= 3) {
                comment = "⚖️ 區間合理震盪：市場看法中性。";
                strategy = "建議採平衡策略。";
            } else {
                comment = "🧊 防禦價值浮現：溢價率偏低。";
                strategy = "具備高安全邊際，適合佈局。";
            }
            return `<div class="rex-analysis"><div class="rex-title">🧢 Rex大叔 智囊戰略分析</div><div class="rex-content"><p>${comment}</p><p><strong>💡 建議：</strong>${strategy}</p></div></div>`;
        }

        function calculateEvaluation(data) {
            const theoPrice = (data.stockPrice / data.conversionPrice) * 100;
            const dimensions = {};

            // 注意：這裡需對應 WEIGHT_COEFFICIENTS 的 key
            dimensions.industry = { ...getStatsSmart('industry', data.industry), coefficient: getWeightCoefficient('industry', data.industry), weight: 0.25, range: data.industry };

            const brokerName = getBrokerName(data.cbName);
            dimensions.broker = brokerName ? { ...getStatsSmart('broker', brokerName), coefficient: getWeightCoefficient('broker', brokerName), weight: 0.13, range: brokerName } : { low: 0, avg: 0, usedFallback: true, coefficient: 1.0, weight: 0.13, range: '未查詢到' };

            const capitalRange = classifyCapital(data.capital);
            dimensions.capital = { ...getStatsSmart('capital', capitalRange), coefficient: getWeightCoefficient('capital', capitalRange), weight: 0.12, range: capitalRange };

            const sizeRange = classifySize(data.issueSize);
            dimensions.size = { ...getStatsSmart('size', sizeRange), coefficient: getWeightCoefficient('size', sizeRange), weight: 0.10, range: sizeRange };

            let ratingKey = data.rating;
            if (ratingKey !== 'BBB') {
                const v = parseInt(ratingKey);
                ratingKey = v <= 3 ? '2-3分' : v <= 5 ? '4-5分' : v <= 7 ? '6-7分' : '8-9分';
            }
            dimensions.rating = { ...getStatsSmart('rating', ratingKey), coefficient: getWeightCoefficient('rating', ratingKey), weight: 0.15, range: ratingKey };

            dimensions.guarantee = { ...getStatsSmart('guarantee', data.guarantee), coefficient: getWeightCoefficient('guarantee', data.guarantee), weight: 0.12, range: data.guarantee };

            const yearsKey = classifyYears(data.years);
            // 年期在 key 中是字串且帶小數點，如 "3.0"
            const yearsKeyFormatted = parseFloat(yearsKey).toFixed(1);
            dimensions.years = { ...getStatsSmart('years', yearsKeyFormatted), coefficient: getWeightCoefficient('years', yearsKeyFormatted), weight: 0.08, range: yearsKey + '年' };

            const conversionRange = classifyConversionPrice(data.conversionPrice);
            dimensions.conversion = { ...getStatsSmart('conversion', conversionRange), coefficient: getWeightCoefficient('conversion', conversionRange), weight: 0.05, range: conversionRange };

            const objectiveRatio = (100 - (data.subjectiveWeight || 0)) / 100;
            let weightedHistoricalLow = 0, weightedHistoricalAvg = 0;

            for (const [key, dim] of Object.entries(dimensions)) {
                dim.weightedLow = dim.low * dim.weight * dim.coefficient * objectiveRatio;
                dim.weightedAvg = dim.avg * dim.weight * dim.coefficient * objectiveRatio;
                weightedHistoricalLow += dim.weightedLow;
                weightedHistoricalAvg += dim.weightedAvg;
            }

            const subjectiveRatio = (data.subjectiveWeight || 0) / 100;
            const weightedSubjectiveLow = (data.subjectiveLowPremium || 0) * subjectiveRatio;
            const weightedSubjectiveAvg = (data.subjectiveAvgPremium || 0) * subjectiveRatio;

            const totalLowPremium = weightedHistoricalLow + weightedSubjectiveLow;
            const totalAvgPremium = weightedHistoricalAvg + weightedSubjectiveAvg;
            const gap = totalAvgPremium - totalLowPremium;

            return {
                cbName: data.cbName,
                theoreticalPrice: theoPrice.toFixed(2),
                dimensions: dimensions,
                totalLowPremium: totalLowPremium.toFixed(2),
                totalAvgPremium: totalAvgPremium.toFixed(2),
                gap: gap.toFixed(2),
                bidPrices: {
                    conservative: (theoPrice * (1 + totalLowPremium / 100)).toFixed(2),
                    balanced: (theoPrice * (1 + totalAvgPremium / 100)).toFixed(2),
                    aggressive: (theoPrice * (1 + (totalAvgPremium + gap) / 100)).toFixed(2),
                    ultimate: (theoPrice * (1 + (totalAvgPremium + 2 * gap) / 100)).toFixed(2)
                },
                inputData: { ...data, ratingDisplay: data.rating === 'BBB' ? 'BBB' : `TCRI ${data.rating}` }
            };
        }

        function displayResult(result) {
            document.getElementById('welcomeMsg').style.display = 'none';
            const resultDiv = document.getElementById('evaluationResult');
            resultDiv.className = 'evaluation-result active';

            const dimNames = { industry: '產業分類', broker: '發行券商', capital: '股本大小', size: '發行規模', rating: '信用評等', guarantee: '擔保情況', years: '發行年期', conversion: '轉換價格' };

            let tableRows = '';
            for (const [key, name] of Object.entries(dimNames)) {
                const dim = result.dimensions[key];
                const fmt = (v) => `<span class="${v>0?'val-pos':v<0?'val-neg':'val-neu'}">${safeFloat(v).toFixed(2)}%</span>`;
                tableRows += `<tr><td>${name}</td><td>${dim.range}</td><td>${fmt(dim.low)}</td><td>${fmt(dim.avg)}</td><td>${(dim.weight*100).toFixed(0)}%</td><td>${dim.coefficient.toFixed(3)}</td><td>${fmt(dim.weightedLow)}</td><td>${fmt(dim.weightedAvg)}</td></tr>`;
            }

            resultDiv.innerHTML = `
                <div class="result-header"><h2>${result.cbName}</h2><div class="subtitle">v3.30 動態權重版評估結果</div></div>
                <div class="detail-section"><h3>📊 理論價格</h3><div style="text-align:center;padding:20px;background:#f8f9fa;border-radius:10px;"><div style="font-size:48px;font-weight:bold;color:#667eea;">${result.theoreticalPrice} 元</div><div style="color:#999;">= ${result.inputData.stockPrice} ÷ ${result.inputData.conversionPrice} × 100</div></div></div>
                <div class="detail-section"><h3>🔍 溢價率分解分析表</h3><table class="data-table"><thead><tr><th>維度</th><th>條件</th><th>最低溢價</th><th>平均溢價</th><th>權重</th><th>係數</th><th>加權最低</th><th>加權平均</th></tr></thead><tbody>${tableRows}<tr style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;"><td colspan="6" style="text-align:right;font-weight:bold;">總計</td><td style="font-size:18px;font-weight:bold;">${result.totalLowPremium}%</td><td style="font-size:18px;font-weight:bold;">${result.totalAvgPremium}%</td></tr></tbody></table></div>
                ${generateRexCommentary(result)}
                <div class="detail-section"><h3>💡 四大策略價格</h3><div class="price-grid">
                    <div class="strategy-card conservative"><h4>🛡️ 保守</h4><div class="price" style="color:#4CAF50;">${result.bidPrices.conservative} 元</div></div>
                    <div class="strategy-card balanced"><h4>⚖️ 平衡</h4><div class="price" style="color:#FF9800;">${result.bidPrices.balanced} 元</div></div>
                    <div class="strategy-card aggressive"><h4>🚀 積極</h4><div class="price" style="color:#f44336;">${result.bidPrices.aggressive} 元</div></div>
                    <div class="strategy-card ultimate"><h4>🔥 極致</h4><div class="price" style="color:#9C27B0;">${result.bidPrices.ultimate} 元</div></div>
                </div></div>
                <div style="text-align:center;margin-top:30px;"><button onclick="location.reload()" style="padding:15px 40px;background:#667eea;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:bold;">🔄 重新評估</button></div>
            `;
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('evaluationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            displayResult(calculateEvaluation({
                cbName: document.getElementById('cbName').value,
                industry: document.getElementById('industry').value,
                issueSize: parseFloat(document.getElementById('issueSize').value),
                years: parseInt(document.getElementById('years').value),
                guarantee: document.getElementById('guarantee').value,
                rating: document.getElementById('rating').value,
                capital: parseFloat(document.getElementById('capital').value),
                stockPrice: parseFloat(document.getElementById('stockPrice').value),
                conversionPrice: parseFloat(document.getElementById('conversionPrice').value),
                subjectiveWeight: parseFloat(document.getElementById('subjectiveWeight').value) || 0,
                subjectiveLowPremium: parseFloat(document.getElementById('subjectiveLowPremium').value) || 0,
                subjectiveAvgPremium: parseFloat(document.getElementById('subjectiveAvgPremium').value) || 0
            }));
        });

        window.addEventListener('DOMContentLoaded', loadStatistics);
    </script>
</body>
</html>
