<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.50 (Mobile Pro)</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="embedded_data.js" onerror="console.warn('embedded_data.js not found, using defaults.')"></script>

<style>
/* ================= é¢¨æ ¼è¨­å®š (Mobile Pro) ================= */
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
    font-family: 'Microsoft JhengHei', 'PingFang TC', 'Segoe UI', sans-serif; 
    background: #f0f2f5; 
    min-height: 100vh; 
    padding: 15px; 
    color: #333;
    font-size: 16px; /* åŸºç¤å­—é«”æ”¾å¤§ */
}
.container { max-width: 800px; margin: 0 auto; } /* æ‰‹æ©Ÿå„ªå…ˆï¼Œé™åˆ¶æœ€å¤§å¯¬åº¦ */

/* é ‚éƒ¨ Header */
.header { background: white; border-radius: 16px; padding: 25px 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left: 8px solid #2196F3; }
.header h1 { color: #1565C0; font-size: 26px; margin-bottom: 8px; font-weight: 800; letter-spacing: 1px; }
.header .subtitle { color: #555; font-size: 15px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
.version-badge { background: #1976D2; color: white; padding: 3px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; }

/* è¼¸å…¥å€å¡Š */
.input-panel { background: white; border-radius: 16px; padding: 25px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
.input-panel h2 { color: #1565C0; font-size: 20px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #E3F2FD; font-weight: 800; }

.form-section { margin-bottom: 30px; }
.form-section h3 { color: #333; font-size: 17px; margin-bottom: 15px; font-weight: 800; border-left: 5px solid #2196F3; padding-left: 10px; line-height: 1.2; }

.form-group { margin-bottom: 18px; }
.form-group label { display: block; color: #444; font-size: 15px; margin-bottom: 8px; font-weight: 700; }
.form-group input, .form-group select { 
    width: 100%; padding: 14px; 
    border: 2px solid #e0e0e0; border-radius: 10px; 
    font-size: 17px; font-weight: 600; color: #222;
    background: #fff;
    transition: border-color 0.3s; 
}
.form-group input:focus, .form-group select:focus { outline: none; border-color: #2196F3; background: #fbfdff; }

/* === æ­·å²ç«¶æ‹å¡ç‰‡ (History Card) === */
.history-card-container { margin-top: 15px; display: flex; flex-direction: column; gap: 15px; }
.history-card { 
    background: linear-gradient(to bottom right, #ffffff, #f8fbff); 
    border: 1px solid #bbdefb; 
    border-radius: 12px; 
    padding: 15px; 
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.1);
    position: relative;
    overflow: hidden;
}
.history-card::before { content: "æ­·å²"; position: absolute; top: 0; right: 0; background: #2196F3; color: white; font-size: 12px; padding: 2px 8px; border-bottom-left-radius: 8px; }
.hc-title { font-size: 18px; font-weight: 900; color: #0D47A1; margin-bottom: 10px; border-bottom: 2px solid #e3f2fd; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.hc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px 12px; font-size: 14px; }
.hc-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
.hc-label { color: #666; font-weight: normal; font-size: 13px; }
.hc-val { color: #333; font-weight: 700; font-size: 15px; }
.hc-val.highlight { color: #D32F2F; }
.hc-val.positive { color: #D32F2F; } 
.hc-val.negative { color: #388E3C; }

/* ä¸€èˆ¬è³‡è¨Šæ¡† */
.info-box { background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 5px solid #4CAF50; margin-top: 10px; display: none; }
.stats-header { font-size: 15px; color: #2e7d32; font-weight: 800; margin-bottom: 8px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 14px; color: #222; margin-bottom: 6px; display: flex; justify-content: space-between; font-weight: 600; }

/* æŒ‰éˆ• */
.calculate-btn { 
    width: 100%; padding: 18px; 
    background: linear-gradient(135deg, #1565C0 0%, #42A5F5 100%); 
    color: white; border: none; border-radius: 12px; 
    font-size: 22px; font-weight: 900; 
    cursor: pointer; box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4); 
    margin-top: 20px; 
}
.calculate-btn:active { transform: scale(0.98); }

/* çµæœå€å¡Š */
.result-panel { background: white; border-radius: 16px; padding: 25px 20px; margin-bottom: 30px; display: none; }
.result-panel.active { display: block; animation: fadeIn 0.5s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.result-header { text-align: center; background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #90caf9; }
.result-header h2 { color: #0D47A1; margin: 0; font-size: 28px; font-weight: 900; }

.detail-section { margin-bottom: 30px; }
.detail-section h3 { color: #1565C0; font-size: 20px; border-bottom: 3px solid #1565C0; padding-bottom: 8px; margin-bottom: 15px; font-weight: 900; }

/* === å®Œç¾å°ç¨±è¡¨æ ¼è¨­è¨ˆ (Mobile Pro Table) === */
.table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #e0e0e0; }
.data-table { width: 100%; border-collapse: collapse; min-width: 100%; }
.data-table th { 
    background-color: #283593; /* æ·±è—åº• */
    color: white; 
    padding: 12px 4px; 
    text-align: center; 
    font-weight: 900; 
    font-size: 15px;
    border: 1px solid #1a237e;
    vertical-align: middle;
    white-space: normal; /* å…è¨±æ›è¡Œ */
    line-height: 1.4;
}
.data-table td { 
    padding: 12px 8px; 
    border: 1px solid #cfd8dc; 
    color: #000; 
    font-weight: 700; /* æ•¸å­—åŠ ç²— */
    font-size: 16px;
    text-align: right; /* æ•¸å­—é å³ */
}
/* èª¿æ•´æ¬„å¯¬ï¼šè®“æ¢ä»¶æ¬„ä½å¯¬ä¸€é»ï¼Œå…¶ä»–æ¬„ä½çª„ä¸€é» */
.data-table th:nth-child(2) { width: 28%; } /* æ¢ä»¶å…§å®¹ */
.data-table th:nth-child(1) { width: 12%; } /* ç¶­åº¦åˆ†æ */
/* å…¶ä»–æ¬„ä½å‡åˆ†å‰©é¤˜ç©ºé–“ */

.data-table td:nth-child(1) { text-align: center; background: #f5f5f5; color: #283593; } /* ç¬¬ä¸€æ¬„ç½®ä¸­ */
.data-table td:nth-child(2) { text-align: left; } /* æ¢ä»¶å…§å®¹é å·¦ */

.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tfoot td { 
    background-color: #e8eaf6; 
    color: #b71c1c; /* åº•éƒ¨ç´…å­— */
    font-weight: 900; 
    border-top: 2px solid #283593;
    font-size: 17px;
}

/* æŠ•æ¨™å»ºè­°å¡ç‰‡ */
.price-grid { display: grid; gap: 15px; margin-top: 15px; }
.strategy-card { border: 3px solid; border-radius: 12px; padding: 20px; text-align: center; position: relative; background: #fff; }
.strategy-card h4 { font-size: 18px; margin-bottom: 5px; font-weight: 900; letter-spacing: 1px; }
.strategy-card .price { font-size: 36px; font-weight: 900; color: #333; margin: 10px 0; font-family: Consolas, monospace; }
.strategy-card.conservative { border-color: #4CAF50; background: #e8f5e9; }
.strategy-card.conservative h4 { color: #2e7d32; }
.strategy-card.balanced { border-color: #FF9800; background: #fff3e0; }
.strategy-card.balanced h4 { color: #ef6c00; }
.strategy-card.aggressive { border-color: #F44336; background: #ffebee; }
.strategy-card.aggressive h4 { color: #c62828; }
.strategy-card.ultimate { border-color: #9C27B0; background: #f3e5f5; }
.strategy-card.ultimate h4 { color: #6a1b9a; }

/* ä¸»è§€æ¬Šé‡èªªæ˜ */
.subjective-note { background: #fff8e1; border: 1px solid #ffe082; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 15px; line-height: 1.6; color: #5d4037; }

#smartReminders { margin: 20px 0; padding: 15px; background: #fffde7; border-left: 5px solid #ffeb3b; border-radius: 8px; font-size: 16px; font-weight: bold; color: #f57f17; line-height: 1.6; display: none; }
</style>
</head>

<body>
<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1565C0 0%, #42A5F5 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 22px; font-weight: bold;">
    <div>ğŸ”„ ç³»çµ±å•Ÿå‹•ä¸­ (v3.50)...</div>
    <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æ­£åœ¨å»ºç«‹æ­·å²ç«¶æ‹è³‡æ–™åº«...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIç«¶æ‹ç³»çµ± <span class="version-badge">v3.50</span></h1>
        <div class="subtitle">Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</div>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™ (æ™ºæ…§æœå°‹)</h3>
                    <div class="form-group">
                        <label>CBåç¨± / ä»£è™Ÿ *</label>
                        <input type="text" id="cbName" required placeholder="è¼¸å…¥ 2368 (å…¨ç³»åˆ—) æˆ– 23683 (å–®æª”)">
                        <div style="font-size:13px; color:#666; margin-top:5px;">ğŸ’¡ æ”¯æ´è¼¸å…¥ï¼šè‚¡ç¥¨ä»£è™Ÿ(4ç¢¼)ã€CBä»£è™Ÿ(5ç¢¼) æˆ– ä¸­æ–‡åç¨±</div>
                        <div id="historyContainer" class="history-card-container"></div>
                        <div id="cbNameInfo" class="info-box"></div>
                    </div>
                    <div class="form-group"><label>è‚¡æœ¬ (å„„å…ƒ) *</label><input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80"><div id="capitalInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç”¢æ¥­åˆ†é¡ *</label><select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select><div id="industryInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç™¼è¡Œåˆ¸å•†</label><select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select><div id="brokerInfo" class="info-box"></div></div>
                </div>
                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group"><label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label><input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š90"><div id="issueSizeInfo" class="info-box"></div></div>
                    <div class="form-group"><label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label><input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š450"><div id="conversionPriceInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ç™¼è¡Œå¹´æœŸ *</label><select id="years" required><option value="">è«‹é¸æ“‡...</option><option value="3">3å¹´æœŸ</option><option value="5">5å¹´æœŸ</option><option value="7">7å¹´æœŸ</option></select><div id="yearsInfo" class="info-box"></div></div>
                    <div class="form-group"><label>æ“”ä¿æƒ…æ³ *</label><select id="guarantee" required><option value="">è«‹é¸æ“‡...</option><option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option><option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option></select><div id="guaranteeInfo" class="info-box"></div></div>
                    <div class="form-group"><label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label><select id="rating" required><option value="">è«‹é¸æ“‡...</option><option value="1">TCRI 1</option><option value="2">TCRI 2</option><option value="3">TCRI 3</option><option value="4">TCRI 4</option><option value="5">TCRI 5</option><option value="6">TCRI 6</option><option value="7">TCRI 7</option><option value="8">TCRI 8</option><option value="9">TCRI 9</option><option value="BBB">BBBç´š</option></select><div id="ratingInfo" class="info-box"></div></div>
                </div>
                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                    <div class="form-group"><label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label><input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5"></div>
                </div>
                <div class="form-section" style="background: #fff8e1; border: 2px solid #ffb300; border-radius: 12px; padding: 20px; margin: 25px 0;">
                    <h3 style="color: #e65100; border-left-color: #ff9800;">âš–ï¸ ä¸»è§€æ¬Šé‡ (ç¶“é©—å¾®èª¿)</h3>
                    <div class="subjective-note">
                        <strong>ğŸ’¡ ç‚ºä»€éº¼éœ€è¦ä¸»è§€æ¬Šé‡ï¼Ÿ</strong><br>
                        AI ä¾è³´æ­·å²æ•¸æ“šï¼Œä½†å¸‚å ´æ°›åœç¬æ¯è¬è®Šã€‚è‹¥æ‚¨æ“æœ‰è±å¯Œç«¶æ‹ç¶“é©—æˆ–å°æ­¤æ¨™çš„æœ‰ç¨åˆ°è¦‹è§£ï¼ˆä¾‹å¦‚ï¼šçœ‹å¥½å¾Œå¸‚å¤§æ¼²ï¼‰ï¼Œå¯åœ¨æ­¤è¼¸å…¥æ¬Šé‡ï¼ˆå¦‚ 10%~30%ï¼‰èˆ‡é æœŸæº¢åƒ¹ï¼Œè®“ç³»çµ±èåˆæ‚¨çš„æ™ºæ…§èˆ‡å¤§æ•¸æ“šï¼Œè¨ˆç®—å‡ºæ›´è²¼è¿‘å¯¦æˆ°çš„åƒ¹æ ¼ã€‚è‹¥ç„¡æƒ³æ³•ï¼Œç¶­æŒ 0 å³å¯ã€‚
                    </div>
                    <div class="form-group"><label>ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label><input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0"></div>
                    <div class="form-group"><label>ä¸»è§€æœ€ä½æº¢åƒ¹ç‡ (%)</label><input type="number" id="subjectiveLowPremium" step="0.1" value="0"></div>
                    <div class="form-group"><label>ä¸»è§€å¹³å‡æº¢åƒ¹ç‡ (%)</label><input type="number" id="subjectiveAvgPremium" step="0.1" value="0"></div>
                </div>
                <div class="form-section">
                    <h3>ğŸ“Š è¿‘æœŸå¸‚å ´æ°›åœ</h3>
                    <div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;">
                        <div class="stat-row">è«‹å…ˆé¸æ“‡ã€Œæ“”ä¿æƒ…æ³ã€</div>
                    </div>
                </div>
                <div id="smartReminders"></div>
                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹ AI è©•ä¼°</button>
            </form>
        </div>
        
        <div class="result-panel" id="evaluationResult"></div>
    </div>
</div>

<script>
// ==========================================
// 1. æ¬„ä½è¨­å®š & å·¥å…·å‡½æ•¸
// ==========================================
const FIELD_ALIASES = {
    'cbId': ['CBä»£è™Ÿ', 'ä»£è™Ÿ', 'è‚¡ç¥¨ä»£è™Ÿ'], 'name': ['åç¨±', 'CBåç¨±', 'å…¬å¸åç¨±'],
    'industry': ['ç”¢æ¥­åˆ†é¡', 'ç”¢æ¥­åˆ¥', 'ç”¢æ¥­'], 'broker': ['ç™¼è¡Œåˆ¸å•†', 'æ‰¿éŠ·åˆ¸å•†', 'ä¸»è¾¦åˆ¸å•†'],
    'guarantee': ['æ“”ä¿', 'æœ‰ç„¡æ“”ä¿', 'æ“”ä¿æƒ…å½¢'], 'rating': ['ä¿¡è©•', 'ä¿¡ç”¨æ“”ä¿', 'TCRI'],
    'capital': ['è‚¡æœ¬', 'è‚¡æœ¬è¦æ¨¡', 'è‚¡æœ¬(å„„)'], 'issueSize': ['ç™¼è¡Œè¦æ¨¡', 'ç™¼è¡Œç¸½é¡'],
    'years': ['å¹´æœŸ', 'ç™¼è¡Œå¹´æœŸ'], 'conversionPrice': ['è½‰æ›åƒ¹', 'è½‰æ›åƒ¹æ ¼'],
    'minBidPrice': ['æœ€ä½å¾—æ¨™', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼', 'æœ€ä½å¾—æ¨™åƒ¹'], 'lowPremium': ['æœ€ä½æº¢åƒ¹', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡', 'æœ€ä½å¾—æ¨™æº¢åƒ¹', 'æœ€ä½æº¢åƒ¹(%)'],
    'avgBidPrice': ['å¹³å‡å¾—æ¨™', 'å¹³å‡å¾—æ¨™åƒ¹æ ¼', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼', 'å¹³å‡å¾—æ¨™åƒ¹'], 'avgPremium': ['å¹³å‡æº¢åƒ¹', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡', 'å¹³å‡å¾—æ¨™æº¢åƒ¹', 'å¹³å‡æº¢åƒ¹(%)'],
    'marketHigh': ['æ›ç‰Œæœ€é«˜', 'æ›ç‰Œæœ€é«˜åƒ¹'], 'marketLow': ['æ›ç‰Œæœ€ä½', 'æ›ç‰Œæœ€ä½åƒ¹'],
    // æ–°å¢é¡¯ç¤ºæ¬„ä½
    'closeDate': ['æˆªæ¨™æ—¥', 'é–‹æ¨™æ—¥æœŸ'], 'bidVol': ['æŠ•æ¨™å¼µæ•¸', 'ç«¶æ‹å¼µæ•¸'], 'floorPrice': ['åº•æ¨™åƒ¹', 'åº•æ¨™'], 
    'closePrice': ['æˆªæ¨™æ”¶ç›¤', 'æˆªæ¨™æ”¶ç›¤åƒ¹'], 'theoPrice': ['ç†è«–åƒ¹']
};

function normalizeKeys(obj) {
    const newObj = {};
    Object.keys(obj).forEach(key => { newObj[key.trim()] = obj[key]; });
    return newObj;
}

function getSmartValue(row, fieldKey) {
    if (!FIELD_ALIASES[fieldKey]) return undefined;
    for (let name of FIELD_ALIASES[fieldKey]) {
        if (row[name] !== undefined && row[name] !== null && row[name] !== '') return row[name];
    }
    return undefined;
}
function safeFloat(val) { const num = parseFloat(val); return isNaN(num) ? 0 : num; }
function safeFixed(val, digits=2) { const num = parseFloat(val); if (isNaN(num)) return '-'; return num.toFixed(digits); }

function getWeightCoefficient(category, value) {
    const weights = (typeof window.WEIGHT_COEFFICIENTS !== 'undefined') ? window.WEIGHT_COEFFICIENTS : {};
    if (!weights[category]) return 1.0;
    return weights[category][value] ? weights[category][value].coefficient : 1.0;
}

function getRangeLabel(category, val) {
    const v = parseFloat(val);
    if (isNaN(v)) return val;
    if (category === 'è‚¡æœ¬') {
        if (v < 3) return "å°æ–¼ 3 å„„";
        if (v < 6) return "3 ~ 6 å„„";
        if (v < 10) return "6 ~ 10 å„„";
        if (v < 15) return "10 ~ 15 å„„";
        if (v < 20) return "15 ~ 20 å„„";
        return "å¤§æ–¼ 20 å„„";
    }
    if (category === 'ç™¼è¡Œè¦æ¨¡') {
        if (v < 2) return "å°æ–¼ 2 å„„";
        if (v < 5) return "2 ~ 5 å„„";
        if (v < 10) return "5 ~ 10 å„„";
        if (v < 15) return "10 ~ 15 å„„";
        if (v < 20) return "15 ~ 20 å„„";
        return "å¤§æ–¼ 20 å„„";
    }
    if (category === 'è½‰æ›åƒ¹') {
        if (v < 20) return "å°æ–¼ 20 å…ƒ";
        if (v < 50) return "20 ~ 50 å…ƒ";
        if (v < 100) return "50 ~ 100 å…ƒ";
        if (v < 150) return "100 ~ 150 å…ƒ";
        if (v < 200) return "150 ~ 200 å…ƒ";
        return "å¤§æ–¼ 200 å…ƒ";
    }
    return val;
}

let statistics = { 'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} }, 'è³‡æ–™æœŸé–“': {} };
let cbDatabase = {}, auctionRawData = [], globalMarketStats = { low: 0, avg: 0 }, cbNameMap = {};

// ==========================================
// 2. è³‡æ–™è®€å–
// ==========================================
async function loadStatistics() {
    const loadingDiv = document.getElementById('loading');
    try {
        const response = await fetch('00_CB.xlsx');
        if (!response.ok) throw new Error("æ‰¾ä¸åˆ° 00_CB.xlsx");
        const workbook = XLSX.read(await response.arrayBuffer(), { type: 'array' });
        
        const getSheetData = (keywords) => { 
            const n = workbook.SheetNames.find(x => keywords.some(k => x.includes(k)));
            if (!n) return null;
            const raw = XLSX.utils.sheet_to_json(workbook.Sheets[n]);
            return raw.map(row => normalizeKeys(row));
        };

        const sheetAuction = getSheetData(['04', 'æ‰€æœ‰CBç«¶æ‹']);
        const sheetHighLow = getSheetData(['00', 'æ›ç‰Œ', 'åç¨±éæ¿¾']);
        
        if (!sheetAuction) throw new Error("ç¼ºå°‘ç«¶æ‹è³‡æ–™åº«(04)");
        const hasHighLow = (sheetHighLow && sheetHighLow.length > 0);

        const highLowMap = {};
        if (hasHighLow) {
            sheetHighLow.forEach(row => {
                let id = row['ä»£è™Ÿ'] || row['CBä»£è™Ÿ'] || row['è‚¡ç¥¨ä»£è™Ÿ'];
                if(id) highLowMap[String(id).replace('.0','').trim()] = row;
            });
        }

        auctionRawData = sheetAuction.map(row => {
            let rawId = row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ']; 
            if (!rawId) return null;
            const id = String(rawId).replace('.0','').trim();
            const hlRow = highLowMap[id] || {}; 

            let lowPrem = safeFloat(getSmartValue(row, 'lowPremium'));
            let avgPrem = safeFloat(getSmartValue(row, 'avgPremium'));
            if (lowPrem !== 0 && Math.abs(lowPrem) < 2) lowPrem *= 100;
            if (avgPrem !== 0 && Math.abs(avgPrem) < 2) avgPrem *= 100;

            return {
                'id': id, 'name': getSmartValue(row, 'name'), 
                'industry': getSmartValue(row, 'industry'), 'broker': getSmartValue(row, 'broker'),
                'guarantee': getSmartValue(row, 'guarantee'), 'rating': getSmartValue(row, 'rating'),
                'capital': safeFloat(getSmartValue(row, 'capital')), 'issueSize': safeFloat(getSmartValue(row, 'issueSize')), 
                'years': safeFloat(getSmartValue(row, 'years')),
                'conversionPrice': safeFloat(getSmartValue(row, 'conversionPrice')), 
                'minBidPrice': safeFloat(getSmartValue(row, 'minBidPrice')), 'avgBidPrice': safeFloat(getSmartValue(row, 'avgBidPrice')),
                'lowPremium': lowPrem, 'avgPremium': avgPrem,
                'marketHigh': safeFloat(getSmartValue(hlRow, 'marketHigh')), 'marketLow': safeFloat(getSmartValue(hlRow, 'marketLow')),
                // æ–°å¢æ¬„ä½ä¾›å¡ç‰‡é¡¯ç¤º
                'closeDate': getSmartValue(row, 'closeDate'), 'bidVol': getSmartValue(row, 'bidVol'),
                'floorPrice': getSmartValue(row, 'floorPrice'), 'closePrice': getSmartValue(row, 'closePrice'),
                'theoPrice': getSmartValue(row, 'theoPrice')
            };
        }).filter(item => item !== null);

        auctionRawData.forEach(item => { if (item.name) { cbDatabase[item.name] = item; cbNameMap[item.name] = item; } });
        
        autoGenerateStatistics(); 
        calculateGlobalMarketStats(); 
        initializeUI();
        loadingDiv.style.display = 'none'; 
        document.querySelector('.container').style.display = 'block';
    } catch (error) { 
        console.error(error); 
        loadingDiv.innerHTML = `<div style="padding:20px;background:white;color:red;">${error.message}</div>`; 
    }
}

// ==========================================
// 3. çµ±è¨ˆ & é‚è¼¯
// ==========================================
function autoGenerateStatistics() {
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'] = {}; statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'] = {};
    auctionRawData.forEach(row => {
        if (row.industry) updateStatCategory('ç”¢æ¥­', row.industry, row);
        if (row.broker) updateStatCategory('ç™¼è¡Œåˆ¸å•†', row.broker, row);
    });
    ['ç”¢æ¥­', 'ç™¼è¡Œåˆ¸å•†'].forEach(cat => {
        Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ'][cat]).forEach(key => {
            const item = statistics['ç¶­åº¦çµ±è¨ˆ'][cat][key];
            if (item.count > 0) {
                item['å¹³å‡æœ€ä½æº¢åƒ¹'] = item.sumLowPrem / item.count; item['å¹³å‡æº¢åƒ¹'] = item.sumAvgPrem / item.count;
                item['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'] = item.sumLowPrice / item.count; item['å¹³å‡å¾—æ¨™åƒ¹'] = item.sumAvgPrice / item.count;
                item['å¹³å‡æ›ç‰Œæœ€é«˜'] = item.countMarket > 0 ? item.sumHigh / item.countMarket : 0;
                item['å¹³å‡æ›ç‰Œæœ€ä½'] = item.countMarket > 0 ? item.sumLow / item.countMarket : 0;
                item['æ¨£æœ¬æ•¸'] = item.count;
            }
        });
    });
}

function updateStatCategory(category, key, row) {
    if (!statistics['ç¶­åº¦çµ±è¨ˆ'][category][key]) statistics['ç¶­åº¦çµ±è¨ˆ'][category][key] = { count: 0, sumLowPrem: 0, sumAvgPrem: 0, sumLowPrice: 0, sumAvgPrice: 0, sumHigh: 0, sumLow: 0, countMarket: 0 };
    const obj = statistics['ç¶­åº¦çµ±è¨ˆ'][category][key];
    if (row.minBidPrice > 0 || row.avgBidPrice > 0) {
        obj.count++; obj.sumLowPrem += row.lowPremium; obj.sumAvgPrem += row.avgPremium; obj.sumLowPrice += row.minBidPrice; obj.sumAvgPrice += row.avgBidPrice;
    }
    if (row.marketHigh > 0 && row.marketLow > 0) {
        obj.sumHigh += row.marketHigh; obj.sumLow += row.marketLow; obj.countMarket++;
    }
}

function calculateGlobalMarketStats() {
    let sumLow = 0, sumAvg = 0, count = 0;
    auctionRawData.forEach(d => { if (d.minBidPrice > 0) { sumLow += d.lowPremium; sumAvg += d.avgPremium; count++; } });
    if (count > 0) { globalMarketStats.low = (sumLow / count); globalMarketStats.avg = (sumAvg / count); }
}

function getStatsSmart(category, val) {
    let stats = { low: 0, avg: 0, usedFallback: false, rawData: null };
    let filterFn = null;
    const v = parseFloat(val);
    let rangeLabel = "";

    if (category === 'è‚¡æœ¬') {
        if (v < 3) { rangeLabel = "å°æ–¼ 3 å„„"; filterFn = d => d.capital < 3; }
        else if (v < 6) { rangeLabel = "3 ~ 6 å„„"; filterFn = d => d.capital >= 3 && d.capital < 6; }
        else if (v < 10) { rangeLabel = "6 ~ 10 å„„"; filterFn = d => d.capital >= 6 && d.capital < 10; }
        else if (v < 15) { rangeLabel = "10 ~ 15 å„„"; filterFn = d => d.capital >= 10 && d.capital < 15; }
        else if (v < 20) { rangeLabel = "15 ~ 20 å„„"; filterFn = d => d.capital >= 15 && d.capital < 20; }
        else { rangeLabel = "å¤§æ–¼ 20 å„„"; filterFn = d => d.capital >= 20; }
    }
    else if (category === 'ç™¼è¡Œè¦æ¨¡') {
        if (v < 2) { rangeLabel = "å°æ–¼ 2 å„„"; filterFn = d => d.issueSize < 2; }
        else if (v < 5) { rangeLabel = "2 ~ 5 å„„"; filterFn = d => d.issueSize >= 2 && d.issueSize < 5; }
        else if (v < 10) { rangeLabel = "5 ~ 10 å„„"; filterFn = d => d.issueSize >= 5 && d.issueSize < 10; }
        else if (v < 15) { rangeLabel = "10 ~ 15 å„„"; filterFn = d => d.issueSize >= 10 && d.issueSize < 15; }
        else if (v < 20) { rangeLabel = "15 ~ 20 å„„"; filterFn = d => d.issueSize >= 15 && d.issueSize < 20; }
        else { rangeLabel = "å¤§æ–¼ 20 å„„"; filterFn = d => d.issueSize >= 20; }
    }
    else if (category === 'è½‰æ›åƒ¹') {
        if (v < 20) { rangeLabel = "å°æ–¼ 20 å…ƒ"; filterFn = d => d.conversionPrice < 20; }
        else if (v < 50) { rangeLabel = "20 ~ 50 å…ƒ"; filterFn = d => d.conversionPrice >= 20 && d.conversionPrice < 50; }
        else if (v < 100) { rangeLabel = "50 ~ 100 å…ƒ"; filterFn = d => d.conversionPrice >= 50 && d.conversionPrice < 100; }
        else if (v < 150) { rangeLabel = "100 ~ 150 å…ƒ"; filterFn = d => d.conversionPrice >= 100 && d.conversionPrice < 150; }
        else if (v < 200) { rangeLabel = "150 ~ 200 å…ƒ"; filterFn = d => d.conversionPrice >= 150 && d.conversionPrice < 200; }
        else { rangeLabel = "å¤§æ–¼ 200 å…ƒ"; filterFn = d => d.conversionPrice >= 200; }
    }
    else {
        const safeVal = String(val || ""); if (safeVal === "") return stats;
        if (category === 'ç™¼è¡Œåˆ¸å•†') filterFn = d => (d.broker || '').includes(safeVal) || safeVal.includes(d.broker || '');
        else if (category === 'ç”¢æ¥­') filterFn = d => d.industry === safeVal;
        else if (category === 'æ“”ä¿') filterFn = d => (d.guarantee || '').includes(safeVal);
        else if (category === 'å¹´æœŸ') filterFn = d => d.years == safeVal;
        else if (category === 'ä¿¡è©•') filterFn = d => (d.rating || '').toString().includes(safeVal);
    }

    if (filterFn) {
        let sumLowP = 0, sumAvgP = 0, count = 0;
        auctionRawData.filter(filterFn).forEach(d => {
            if (d.minBidPrice > 0 || d.avgBidPrice > 0) { sumLowP += d.lowPremium; sumAvgP += d.avgPremium; count++; }
        });
        if (count > 0) {
            stats.low = sumLowP / count; stats.avg = sumAvgP / count;
            stats.rawData = { 'å¹³å‡æœ€ä½æº¢åƒ¹': stats.low, 'å¹³å‡æº¢åƒ¹': stats.avg, 'æ¨£æœ¬æ•¸': count };
            if(rangeLabel) stats.rawData['å€é–“åç¨±'] = rangeLabel;
        }
    }
    
    if (stats.low === 0) {
        if (statistics['ç¶­åº¦çµ±è¨ˆ'][category] && statistics['ç¶­åº¦çµ±è¨ˆ'][category][val]) {
            stats.rawData = statistics['ç¶­åº¦çµ±è¨ˆ'][category][val];
            stats.low = safeFloat(stats.rawData['å¹³å‡æœ€ä½æº¢åƒ¹']); stats.avg = safeFloat(stats.rawData['å¹³å‡æº¢åƒ¹']);
        }
        if (stats.low === 0 || isNaN(stats.low)) {
            stats.low = globalMarketStats.low; stats.avg = globalMarketStats.avg; stats.usedFallback = true;
            if(!stats.rawData) stats.rawData = { 'å¹³å‡æœ€ä½æº¢åƒ¹': stats.low, 'å¹³å‡æº¢åƒ¹': stats.avg, 'æ¨£æœ¬æ•¸': 'å…¨å¸‚å ´(å‚™æ´)' };
        }
    }
    return stats;
}

// ==========================================
// 4. UI - æ­·å²å¡ç‰‡ç”Ÿæˆ (v3.50 æ–°å¢)
// ==========================================
function renderHistoryCard(d) {
    const dateStr = (raw) => {
        if(!raw) return '-';
        // å˜—è©¦å°‡ Excel æ—¥æœŸæ•¸å€¼è½‰ç‚º YYYY/MM/DDï¼Œæˆ–ç›´æ¥å›å‚³å­—ä¸²
        if(typeof raw === 'number') {
            const date = new Date(Math.round((raw - 25569)*86400*1000));
            return `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
        }
        return String(raw).split('T')[0]; // è‹¥æ˜¯ ISO å­—ä¸²
    };

    const val = (v) => (v && v!==0) ? v : '-';
    
    return `
    <div class="history-card">
        <div class="hc-title">
            <span>${d.name} (${d.id})</span>
            <span style="font-size:14px;color:#666;font-weight:normal;">${dateStr(d.closeDate)} æˆªæ¨™</span>
        </div>
        <div class="hc-grid">
            <div class="hc-item"><span class="hc-label">åº•æ¨™åƒ¹æ ¼</span><span class="hc-val">${val(d.floorPrice)}</span></div>
            <div class="hc-item"><span class="hc-label">è½‰æ›åƒ¹æ ¼</span><span class="hc-val">${val(d.conversionPrice)}</span></div>
            <div class="hc-item"><span class="hc-label">æˆªæ¨™æ”¶ç›¤</span><span class="hc-val">${val(d.closePrice)}</span></div>
            <div class="hc-item"><span class="hc-label">ç†è«–åƒ¹æ ¼</span><span class="hc-val">${val(d.theoPrice)}</span></div>
            
            <div class="hc-item"><span class="hc-label">ç«¶æ‹å¼µæ•¸</span><span class="hc-val">${val(d.bidVol)}</span></div>
            <div class="hc-item"><span class="hc-label">æœ€ä½å¾—æ¨™</span><span class="hc-val highlight">${val(d.minBidPrice)}</span></div>
            
            <div class="hc-item"><span class="hc-label">æœ€ä½æº¢åƒ¹</span><span class="hc-val highlight">${safeFixed(d.lowPremium)}%</span></div>
            <div class="hc-item"><span class="hc-label">å¹³å‡å¾—æ¨™</span><span class="hc-val highlight">${val(d.avgBidPrice)}</span></div>
            
            <div class="hc-item"><span class="hc-label">å¹³å‡æº¢åƒ¹</span><span class="hc-val highlight">${safeFixed(d.avgPremium)}%</span></div>
            <div class="hc-item" style="grid-column: span 2; justify-content:flex-start; gap:10px;">
                <span class="hc-label">æ›ç‰Œé«˜/ä½:</span>
                <span class="hc-val positive">${val(d.marketHigh)}</span> / <span class="hc-val negative">${val(d.marketLow)}</span>
            </div>
        </div>
    </div>`;
}

function generateStandardCard(data, title) {
    if (!data) return `<div class="stat-row" style="color:#999;">æŸ¥ç„¡è³‡æ–™</div>`;
    const v = (n, s='') => (n!==undefined && n!==null && n!==0) ? `${safeFixed(n,2)}${s}` : '-';
    const titleStr = data['å€é–“åç¨±'] ? `å€é–“: ${data['å€é–“åç¨±']}` : title;
    
    return `
    <div class="stats-header">ğŸ“Š ${titleStr}</div>
    <div style="background:#f1f8e9; padding:10px; border-radius:8px;">
        <div class="stat-row"><span>æ¨£æœ¬æ•¸</span><span>${data['æ¨£æœ¬æ•¸']} æª”</span></div>
        <div class="stat-row"><span>å¹³å‡æœ€ä½æº¢åƒ¹</span><span style="color:#D32F2F;">${v(data['å¹³å‡æœ€ä½æº¢åƒ¹'],'%')}</span></div>
        <div class="stat-row"><span>å¹³å‡æº¢åƒ¹</span><span style="color:#D32F2F;">${v(data['å¹³å‡æº¢åƒ¹'],'%')}</span></div>
    </div>`;
}

function initializeUI() {
    populateSelect('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']); populateSelect('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);
    showStatsSummary(); bindInputEvents();
}
function populateSelect(id, dataObj) {
    const sel = document.getElementById(id); while (sel.options.length > 1) sel.remove(1);
    Object.keys(dataObj).sort((a,b)=>(dataObj[b].count||0)-(dataObj[a].count||0)).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.text=`${k} (${dataObj[k].count})`; sel.add(o); });
}
function showStatsSummary() { document.getElementById('statsSummary').innerHTML = `<div class="stat-box"><div class="number">${Object.keys(cbDatabase).length}</div><div class="label">è³‡æ–™ç¸½æ•¸</div></div><div class="stat-box"><div class="number">${auctionRawData.filter(d=>d.minBidPrice>0).length}</div><div class="label">æœ‰æ•ˆç«¶æ‹</div></div>`; }

function bindInputEvents() {
    const show = (id, html) => { const el = document.getElementById(id); el.innerHTML = html||''; el.style.display = html?'block':'none'; };
    
    // æ ¸å¿ƒæœå°‹é‚è¼¯ (v3.50)
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim().toUpperCase();
        const container = document.getElementById('historyContainer');
        container.innerHTML = '';
        
        if (val.length >= 2) {
            let matches = [];
            // 1. è¼¸å…¥ 4 ç¢¼ (2368) -> æ‰¾æ‰€æœ‰é–‹é ­æ˜¯ 2368 çš„
            if (/^\d{4}$/.test(val)) {
                matches = auctionRawData.filter(d => d.id.startsWith(val));
            } 
            // 2. è¼¸å…¥ 5 ç¢¼ (23683) -> æ‰¾å®Œå…¨ç¬¦åˆçš„
            else if (/^\d{5}$/.test(val)) {
                matches = auctionRawData.filter(d => d.id === val);
            }
            // 3. è¼¸å…¥ä¸­æ–‡ -> åŒ…å«è©²æ–‡å­—çš„
            else {
                matches = auctionRawData.filter(d => d.name.includes(val));
            }
            
            // æ’åºï¼šä¾ä»£è™Ÿæ’åº
            matches.sort((a, b) => a.id.localeCompare(b.id));

            if (matches.length > 0) {
                container.innerHTML = matches.map(d => renderHistoryCard(d)).join('');
            } else {
                container.innerHTML = `<div style="padding:10px;color:#666;text-align:center;">æŸ¥ç„¡ç¬¦åˆ "${val}" çš„æ­·å²ç«¶æ‹è³‡æ–™</div>`;
            }
        }
    });

    const bind = (id, cat) => {
        const handler = function() {
            const val = parseFloat(this.value) || this.value;
            if (val) {
                let title = cat;
                if(['è‚¡æœ¬','ç™¼è¡Œè¦æ¨¡','è½‰æ›åƒ¹'].includes(cat)) title = getRangeLabel(cat, val);
                const res = getStatsSmart(cat, val);
                show(id+'Info', generateStandardCard(res.rawData, title));
                if(cat==='è½‰æ›åƒ¹'||cat==='ä¿¡è©•') updateSmartReminders();
            }
        };
        const el = document.getElementById(id); el.addEventListener('change', handler); if(el.tagName==='INPUT') el.addEventListener('input', handler);
    };
    bind('capital','è‚¡æœ¬'); bind('issueSize','ç™¼è¡Œè¦æ¨¡'); bind('conversionPrice','è½‰æ›åƒ¹'); 
    bind('industry','ç”¢æ¥­'); bind('broker','ç™¼è¡Œåˆ¸å•†'); bind('years','å¹´æœŸ'); bind('guarantee','æ“”ä¿'); bind('rating','ä¿¡è©•');
    
    document.getElementById('guarantee').addEventListener('change', function() {
        const val = this.value, div = document.getElementById('marketSentiment');
        if(!val) return;
        const recent = auctionRawData.filter(d=>(d.guarantee||'').includes(val)).slice(-20);
        if(recent.length===0){div.innerHTML=`<div class="stat-row">ç„¡æ¡ˆä¾‹</div>`;return;}
        const avgP=recent.reduce((s,i)=>s+(i.avgPremium||0),0)/recent.length;
        div.innerHTML=`<div class="stats-header">ğŸŒ¡ï¸ å¸‚å ´æ°›åœ (${val})</div><div class="stat-row">è¿‘ ${recent.length} ç­†å¹³å‡æº¢åƒ¹ï¼š<span style="color:#D32F2F;">${avgP.toFixed(2)}%</span></div>`;
        div.style.display='block';
    });
    document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
}

function updateSmartReminders() {
    const s = parseFloat(document.getElementById('stockPrice').value);
    const c = parseFloat(document.getElementById('conversionPrice').value);
    if(s && c) { 
        const t = (s/c)*100; 
        document.getElementById('smartReminders').innerHTML = `ç†è«–åƒ¹ï¼š${t.toFixed(2)} å…ƒ` + (t>120?" ğŸ”¥ é«˜æº¢åƒ¹é¢¨éšª":t<95?" ğŸ’¡ å…·å¸å¼•åŠ›":" âœ¨ åˆç†å€é–“"); 
        document.getElementById('smartReminders').style.display='block'; 
    }
}

function displayResult(r) {
    const div = document.getElementById('evaluationResult'); 
    div.className = 'result-panel active';
    let rows = ''; const nm={'industry':'ç”¢æ¥­','broker':'åˆ¸å•†','capital':'è‚¡æœ¬','size':'è¦æ¨¡','rating':'ä¿¡è©•','guarantee':'æ“”ä¿','years':'å¹´æœŸ','conversion':'è½‰åƒ¹'};
    
    for(const[k,d] of Object.entries(r.dimensions)) {
        rows+=`<tr>
            <td>${nm[k]}<br>åˆ†æ</td>
            <td style="text-align:left;">${d.displayRange || d.range}</td>
            <td>${safeFixed(d.low)}%</td>
            <td>${safeFixed(d.avg)}%</td>
            <td>${safeFixed(d.weight*100,0)}%</td>
            <td>${safeFixed(d.weightedLow)}</td>
            <td>${safeFixed(d.weightedAvg)}</td>
        </tr>`;
    }
    
    if(r.inputData.subjectiveWeight>0) {
        rows+=`<tr style="background:#fff3e0">
            <td>ä¸»è§€<br>æ¬Šé‡</td>
            <td>è‡ªè¨‚<br>è¼¸å…¥</td>
            <td>${r.inputData.subjectiveLowPremium}%</td>
            <td>${r.inputData.subjectiveAvgPremium}%</td>
            <td>${r.inputData.subjectiveWeight}%</td>
            <td>${r.weightedSubjectiveLow}</td>
            <td>${r.weightedSubjectiveAvg}</td>
        </tr>`;
    }

    rows+=`<tfoot><tr>
        <td></td>
        <td style="text-align:right">åŠ æ¬Š<br>ç¸½è¨ˆ</td>
        <td>-</td>
        <td>-</td>
        <td>100%</td>
        <td>${r.totalLowPremium}%</td>
        <td>${r.totalAvgPremium}%</td>
    </tr></tfoot>`;
    
    div.innerHTML = `
    <div class="result-header"><h2>${r.cbName}</h2><div style="color:#555;">AI è©•ä¼°çµæœå ±å‘Š</div></div>
    <div class="detail-section">
        <h3>ğŸ“Š æ ¸å¿ƒæ•¸æ“š</h3>
        <div style="font-size:20px; font-weight:bold; margin-bottom:10px;">ç†è«–åƒ¹æ ¼ï¼š<span style="color:#D32F2F;">${r.theoreticalPrice}</span> å…ƒ</div>
        <div style="font-size:20px; font-weight:bold;">é ä¼°æº¢åƒ¹ï¼š<span style="color:#1976D2;">${r.totalLowPremium}% ~ ${r.totalAvgPremium}%</span></div>
    </div>
    <div class="detail-section">
        <h3>ğŸ“ ç¶­åº¦æ¬Šé‡åˆ†æ</h3>
        <div class="table-wrapper">
            <table class="data-table">
                <thead><tr>
                    <th>ç¶­åº¦<br>åˆ†æ</th><th>æ¢ä»¶<br>å…§å®¹</th><th>æœ€ä½<br>æº¢åƒ¹</th><th>å¹³å‡<br>æº¢åƒ¹</th><th>æ¬Šé‡<br>æ¯”ä¾‹</th><th>åŠ æ¬Š<br>æœ€ä½</th><th>åŠ æ¬Š<br>å¹³å‡</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    </div>
    <div class="detail-section">
        <h3>ğŸ’¡ æŠ•æ¨™å»ºè­°åƒ¹æ ¼</h3>
        <div class="price-grid">
            <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆä½ˆå±€</h4><div class="price">${r.bidPrices.conservative}</div></div>
            <div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡ç­–ç•¥</h4><div class="price">${r.bidPrices.balanced}</div></div>
            <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µæ¶æ¨™</h4><div class="price">${r.bidPrices.aggressive}</div></div>
            <div class="strategy-card ultimate"><h4>ğŸ”¥ æ¥µè‡´åƒ¹æ ¼</h4><div class="price">${r.bidPrices.ultimate}</div></div>
        </div>
    </div>
    <div style="text-align:center;"><button onclick="location.reload()" class="calculate-btn" style="background:#555;width:auto;padding:10px 30px;font-size:16px;">ğŸ”„ é‡æ–°è©•ä¼°</button></div>`;
    div.scrollIntoView({ behavior: 'smooth' });
}

function calculateEvaluation(d) {
    const theo = (d.stockPrice/d.conversionPrice)*100;
    const brokerName = d.broker || ""; 
    const dims = [
        {k:'industry',c:'ç”¢æ¥­',w:0.25,v:d.industry}, {k:'broker',c:'ç™¼è¡Œåˆ¸å•†',w:0.13,v:brokerName},
        {k:'capital',c:'è‚¡æœ¬',w:0.12,v:d.capital}, {k:'size',c:'ç™¼è¡Œè¦æ¨¡',w:0.10,v:d.issueSize},
        {k:'rating',c:'ä¿¡è©•',w:0.15,v:d.rating}, {k:'guarantee',c:'æ“”ä¿',w:0.12,v:d.guarantee},
        {k:'years',c:'å¹´æœŸ',w:0.08,v:d.years}, {k:'conversion',c:'è½‰æ›åƒ¹',w:0.05,v:d.conversionPrice}
    ];
    let wL=0, wA=0, resDims={};
    dims.forEach(x=>{
        const s = getStatsSmart(x.c, x.v), coef = getWeightCoefficient(x.k, x.v);
        resDims[x.k] = { ...s, coefficient: coef, weight: x.w, range: x.v, weightedLow: s.low*x.w*coef, weightedAvg: s.avg*x.w*coef };
        if (s.rawData && s.rawData['å€é–“åç¨±']) resDims[x.k].displayRange = s.rawData['å€é–“åç¨±'];
        else resDims[x.k].displayRange = x.v;
        wL+=resDims[x.k].weightedLow; wA+=resDims[x.k].weightedAvg;
    });
    const subR = (d.subjectiveWeight||0)/100, objR = 1-subR;
    const tL = (wL*objR)+((d.subjectiveLowPremium||0)*subR), tA = (wA*objR)+((d.subjectiveAvgPremium||0)*subR), gap = tA-tL;
    return {
        cbName:d.cbName, theoreticalPrice:safeFixed(theo), dimensions:resDims, totalLowPremium:safeFixed(tL), totalAvgPremium:safeFixed(tA),
        bidPrices:{ conservative:safeFixed(theo*(1+tL/100)), balanced:safeFixed(theo*(1+tA/100)), aggressive:safeFixed(theo*(1+(tA+gap)/100)), ultimate:safeFixed(theo*(1+(tA+gap*2)/100)) },
        inputData:d, weightedSubjectiveLow:safeFixed(((d.subjectiveLowPremium||0)*subR)), weightedSubjectiveAvg:safeFixed(((d.subjectiveAvgPremium||0)*subR))
    };
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    displayResult(calculateEvaluation({
        cbName: document.getElementById('cbName').value, industry: document.getElementById('industry').value, issueSize: parseFloat(document.getElementById('issueSize').value),
        years: document.getElementById('years').value, guarantee: document.getElementById('guarantee').value, rating: document.getElementById('rating').value,
        capital: parseFloat(document.getElementById('capital').value), stockPrice: parseFloat(document.getElementById('stockPrice').value), conversionPrice: parseFloat(document.getElementById('conversionPrice').value),
        subjectiveWeight: parseFloat(document.getElementById('subjectiveWeight').value)||0, subjectiveLowPremium: parseFloat(document.getElementById('subjectiveLowPremium').value)||0, subjectiveAvgPremium: parseFloat(document.getElementById('subjectiveAvgPremium').value)||0,
        broker: document.getElementById('broker').value 
    }));
});
window.addEventListener('DOMContentLoaded', loadStatistics);
</script>
</body>
</html>
