<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.31 (Excelç›´è®€ç‰ˆ) - Rexå¤§å”</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
/* ================= é¢¨æ ¼è¨­å®š (ç¶­æŒåŸæ¨£) ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh; padding: 20px;
}
.container { max-width: 1600px; margin: 0 auto; }

.header {
    background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
.header .subtitle { color: #666; font-size: 16px; }
.version-badge { display: inline-block; background: #FF5722; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }

.evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }

.input-panel {
    background: white; border-radius: 15px; padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px;
}
.input-panel h2 { color: #667eea; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }

.form-section { margin-bottom: 25px; }
.form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
.form-group input, .form-group select {
    width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
}
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }

/* è³‡è¨Šæ¡†æ¨£å¼ (å¡ç‰‡) */
.info-box {
    background: #e8f5e9; padding: 15px; border-radius: 8px;
    border-left: 5px solid #4CAF50; margin-top: 10px; display: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.stat-label { color: #555; font-weight: 500; }
.stat-value { font-weight: bold; color: #333; }

.calculate-btn {
    width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold;
    cursor: pointer; transition: transform 0.2s; margin-top: 20px;
}
.calculate-btn:hover { transform: translateY(-2px); }

.result-panel {
    background: white; border-radius: 15px; padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px;
}
.welcome-message { text-align: center; padding: 60px 20px; }
.stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
.stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; }
.stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }

.evaluation-result { display: none; }
.evaluation-result.active { display: block; animation: fadeIn 0.5s; }

.result-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
}
.detail-section {
    background: white; border-radius: 12px; padding: 30px;
    margin-bottom: 25px; border: 2px solid #e0e0e0;
}
.detail-section h3 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; }
.strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
.strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
.strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
.strategy-card.ultimate { border-color: #f44336; background: #fff0f0; }
.strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }

.data-table {
    width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.data-table th {
    background-color: #1A237E; color: white; padding: 15px 10px;
    text-align: center; font-weight: bold; border: 1px solid #0d1b5e;
}
.data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tr:hover { background-color: #e8eaf6; }
.val-pos { color: #d32f2f; font-weight: bold; }
.val-neg { color: #388e3c; font-weight: bold; }
.val-neu { color: #333; }

.rex-analysis {
    background: linear-gradient(to right, #fff3e0, #ffe0b2);
    border-left: 6px solid #ff9800;
    padding: 25px;
    border-radius: 8px;
    margin-top: 30px;
}
.rex-title { font-size: 20px; font-weight: bold; color: #e65100; margin-bottom: 15px; display: flex; align-items: center; }
.rex-content { color: #5d4037; line-height: 1.8; font-size: 15px; }

@media (max-width: 1200px) {
    .evaluation-container { grid-template-columns: 1fr; }
    .input-panel { position: relative; top: 0; }
}
</style>
<script src="embedded_data.js"></script>
</head>

<body>

<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold;">
    <div>ğŸ”„ æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</div>
    <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æ­£åœ¨è®€å– Excel è³‡æ–™åº«...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.31 Excelç‰ˆ</span></h1>
        <p class="subtitle" id="headerSubtitle">è¼‰å…¥ä¸­...</p>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                    <div class="form-group">
                        <label>CBåç¨± *</label>
                        <input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ">
                        <div id="cbNameInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>è‚¡æœ¬ (å„„å…ƒ) *</label>
                        <input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80">
                        <div id="capitalInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç”¢æ¥­åˆ†é¡ *</label>
                        <select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select>
                        <div id="industryInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç™¼è¡Œåˆ¸å•†</label>
                        <select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select>
                        <div id="brokerInfo" class="info-box"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group">
                        <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label>
                        <input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š90">
                        <div id="issueSizeInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š450">
                        <div id="conversionPriceInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç™¼è¡Œå¹´æœŸ *</label>
                        <select id="years" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="3">3å¹´æœŸ</option>
                            <option value="5">5å¹´æœŸ</option>
                            <option value="7">7å¹´æœŸ</option>
                        </select>
                        <div id="yearsInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>æ“”ä¿æƒ…æ³ *</label>
                        <select id="guarantee" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                            <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                        </select>
                        <div id="guaranteeInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                        <select id="rating" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="1">TCRI 1</option>
                            <option value="2">TCRI 2</option>
                            <option value="3">TCRI 3</option>
                            <option value="4">TCRI 4</option>
                            <option value="5">TCRI 5</option>
                            <option value="6">TCRI 6</option>
                            <option value="7">TCRI 7</option>
                            <option value="8">TCRI 8</option>
                            <option value="9">TCRI 9</option>
                            <option value="BBB">BBBç´š</option>
                        </select>
                        <div id="ratingInfo" class="info-box"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                    <div class="form-group">
                        <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                    </div>
                </div>

                <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 20px; margin: 25px 0;">
                    <h3 style="color: #e65100; display: flex; align-items: center; gap: 8px;">âš–ï¸ ä¸»è§€æ¬Šé‡èª¿æ•´ï¼ˆé¸å¡«ï¼‰</h3>
                    <div class="form-group">
                        <label>ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label>
                        <input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0" placeholder="0-100ï¼Œé è¨­0">
                    </div>
                    <div class="form-group">
                        <label>ä¸»è§€æœ€ä½æº¢åƒ¹ç‡ (%)</label>
                        <input type="number" id="subjectiveLowPremium" step="0.1" value="0" placeholder="ä¾‹å¦‚ï¼š5.0">
                    </div>
                    <div class="form-group">
                        <label>ä¸»è§€å¹³å‡æº¢åƒ¹ç‡ (%)</label>
                        <input type="number" id="subjectiveAvgPremium" step="0.1" value="0" placeholder="ä¾‹å¦‚ï¼š8.0">
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ“Š è¿‘æœŸå¸‚å ´ç«¶æ‹æ°›åœ</h3>
                    <div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;">
                        <div class="stats-header" style="color:#1976D2;">ğŸŒ¡ï¸ å‹•æ…‹å¸‚å ´æ°›åœåˆ†æ</div>
                        <div class="stat-row">è«‹å…ˆé¸æ“‡ã€Œæ“”ä¿æƒ…æ³ã€ï¼Œç³»çµ±å°‡è‡ªå‹•èª¿é–±æ­·å²æ¡ˆä¾‹åˆ†æã€‚</div>
                    </div>
                </div>

                <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 14px;">ğŸ’¡ Rexå¤§å”çš„æ™ºæ…§æé†’</div>
                    <div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div>
                </div>

                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
            </form>
        </div>

        <div class="result-panel">
            <div id="welcomeMsg" class="welcome-message">
                <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ± (Excelç‰ˆ)</h2>
                <p>âœ… ç›´æ¥è®€å– Excel è³‡æ–™åº«<br>âœ… è‡ªå‹•é‹ç®—ç”¢æ¥­èˆ‡åˆ¸å•†çµ±è¨ˆæ•¸æ“š</p>
                <div class="stats-summary" id="statsSummary"></div>
            </div>
            <div id="evaluationResult" class="evaluation-result"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// æ ¸å¿ƒè¨­å®šèˆ‡è®Šæ•¸
// ==========================================
let statistics = {
    'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} }, // è‡ªå‹•ç”Ÿæˆ
    'è³‡æ–™æœŸé–“': {}
};
let cbDatabase = {}; // CBä»£è™Ÿå°ç…§è¡¨
let auctionRawData = []; // åŸå§‹ç«¶æ‹æ•¸æ“š (Excelå°å…¥)
let globalMarketStats = { low: 0, avg: 0 };
let cbNameMap = {}; // åç¨±å¿«é€Ÿç´¢å¼•

// è¼”åŠ©å‡½æ•¸
function safeFloat(val) {
    if (val === undefined || val === null || val === '') return 0;
    const num = parseFloat(val);
    return isNaN(num) ? 0 : num;
}

function getWeightCoefficient(category, value) {
    if (!window.WEIGHT_COEFFICIENTS || !window.WEIGHT_COEFFICIENTS[category]) return 1.0;
    const coefData = window.WEIGHT_COEFFICIENTS[category][value];
    return coefData ? coefData.coefficient : 1.0;
}

function getBrokerName(cbName) {
    // å„ªå…ˆå¾ Excel åŸå§‹è³‡æ–™æŸ¥æ‰¾
    const found = auctionRawData.find(d => (d['åç¨±'] == cbName || d['CBåç¨±'] == cbName));
    if (found && (found['ç™¼è¡Œåˆ¸å•†'] || found['æ‰¿éŠ·åˆ¸å•†'])) return found['ç™¼è¡Œåˆ¸å•†'] || found['æ‰¿éŠ·åˆ¸å•†'];
    return window.BROKER_MAPPING ? window.BROKER_MAPPING[cbName] : null;
}

// ==========================================
// æ ¸å¿ƒï¼šExcel è®€å–èˆ‡åˆå§‹åŒ–
// ==========================================
async function loadStatistics() {
    const loadingDiv = document.getElementById('loading');
    const detailDiv = document.getElementById('loading-detail');

    try {
        detailDiv.textContent = "æ­£åœ¨è®€å– cb_data.xlsx ...";
        
        // 1. è®€å– Excel æª”æ¡ˆ
        const response = await fetch('cb_data.xlsx');
        if (!response.ok) throw new Error("æ‰¾ä¸åˆ° cb_data.xlsxï¼Œè«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³è‡³æ­£ç¢ºä½ç½®ã€‚");
        
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });

        // 2. è§£æã€Œç«¶æ‹åŸå§‹è³‡æ–™ã€Sheet
        let rawSheetName = workbook.SheetNames.find(n => n.includes('ç«¶æ‹') || n.includes('Raw') || n.includes('åŸå§‹'));
        if (!rawSheetName) rawSheetName = workbook.SheetNames[0]; // é è¨­æŠ“ç¬¬ä¸€å€‹ Sheet
        
        auctionRawData = XLSX.utils.sheet_to_json(workbook.Sheets[rawSheetName]);
        console.log(`å·²è¼‰å…¥ ${auctionRawData.length} ç­†åŸå§‹è³‡æ–™`);

        // 3. è§£æã€ŒCBè³‡æ–™åº«ã€Sheet (ç”¨æ–¼æŸ¥æ‰¾æ›ç‰Œåƒ¹ç­‰ï¼Œè‹¥ç„¡å‰‡å˜—è©¦å¾åŸå§‹è³‡æ–™å»ºç«‹)
        let dbSheetName = workbook.SheetNames.find(n => n.includes('CBè³‡æ–™åº«') || n.includes('Database') || n.includes('åå–®'));
        if (dbSheetName) {
            const dbData = XLSX.utils.sheet_to_json(workbook.Sheets[dbSheetName]);
            dbData.forEach(row => {
                if (row['åç¨±']) {
                    cbDatabase[row['åç¨±']] = row;
                    cbNameMap[row['åç¨±']] = row;
                }
            });
        } else {
            // å¦‚æœæ²’æœ‰å°ˆé–€çš„ DB Sheetï¼Œå°±ç”¨åŸå§‹è³‡æ–™å……ç•¶ DB
            auctionRawData.forEach(row => {
                const name = row['åç¨±'] || row['CBåç¨±'];
                if (name) {
                    cbDatabase[name] = row;
                    cbNameMap[name] = row;
                }
            });
        }

        // 4. è‡ªå‹•ç”¢ç”Ÿçµ±è¨ˆæ•¸æ“š (å–ä»£èˆŠç‰ˆ JSON å…§çš„é çµ±è¨ˆ)
        autoGenerateStatistics();

        // 5. åˆå§‹åŒ– UI
        calculateGlobalMarketStats();
        initializeUI();
        
        loadingDiv.style.display = 'none';
        document.querySelector('.container').style.display = 'block';

    } catch (error) {
        console.error(error);
        loadingDiv.innerHTML = `<div style="padding:30px; background:white; color:#d32f2f; border-radius:10px; text-align:center; max-width:80%;"><h3 style="margin-bottom:10px;">âŒ è®€å–å¤±æ•—</h3><p style="font-size:16px;">${error.message}</p><p style="font-size:14px; color:#666; margin-top:10px;">è«‹ç¢ºä¿ç›®éŒ„ä¸‹æœ‰ <b>cb_data.xlsx</b> ä¸”æ ¼å¼æ­£ç¢ºã€‚</p></div>`;
    }
}

// ==========================================
// V3.31 æ–°å¢ï¼šè‡ªå‹•çµ±è¨ˆå¼•æ“
// ==========================================
function autoGenerateStatistics() {
    // åˆå§‹åŒ–çµ±è¨ˆå®¹å™¨
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'] = {};
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'] = {};
    statistics['è³‡æ–™æœŸé–“']['ç¸½ç­†æ•¸'] = auctionRawData.length;

    // éæ­·æ‰€æœ‰åŸå§‹æ•¸æ“šé€²è¡Œæ­¸ç´
    auctionRawData.forEach(row => {
        const ind = row['ç”¢æ¥­åˆ†é¡'] || row['ç”¢æ¥­åˆ¥'];
        const broker = row['ç™¼è¡Œåˆ¸å•†'] || row['æ‰¿éŠ·åˆ¸å•†'] || row['ä¸»è¾¦åˆ¸å•†'];
        
        // çµ±è¨ˆç”¢æ¥­
        if (ind) updateStatCategory('ç”¢æ¥­', ind, row);
        // çµ±è¨ˆåˆ¸å•†
        if (broker) updateStatCategory('ç™¼è¡Œåˆ¸å•†', broker, row);
    });

    // è¨ˆç®—å¹³å‡å€¼
    ['ç”¢æ¥­', 'ç™¼è¡Œåˆ¸å•†'].forEach(cat => {
        Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ'][cat]).forEach(key => {
            const item = statistics['ç¶­åº¦çµ±è¨ˆ'][cat][key];
            if (item.count > 0) {
                item['å¹³å‡æœ€ä½æº¢åƒ¹'] = item.sumLowPrem / item.count;
                item['å¹³å‡æº¢åƒ¹'] = item.sumAvgPrem / item.count;
                item['å¹³å‡æ›ç‰Œæœ€é«˜'] = item.countMarket > 0 ? item.sumHigh / item.countMarket : 0;
                item['å¹³å‡æ›ç‰Œæœ€ä½'] = item.countMarket > 0 ? item.sumLow / item.countMarket : 0;
                item['æ¨£æœ¬æ•¸'] = item.count;
            }
        });
    });
}

function updateStatCategory(category, key, row) {
    if (!statistics['ç¶­åº¦çµ±è¨ˆ'][category][key]) {
        statistics['ç¶­åº¦çµ±è¨ˆ'][category][key] = {
            count: 0, sumLowPrem: 0, sumAvgPrem: 0, sumHigh: 0, sumLow: 0, countMarket: 0
        };
    }
    
    const obj = statistics['ç¶­åº¦çµ±è¨ˆ'][category][key];
    const lowPrem = safeFloat(row['æœ€ä½æº¢åƒ¹'] || row['æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡'] || row['s1']);
    const avgPrem = safeFloat(row['å¹³å‡æº¢åƒ¹'] || row['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡'] || row['u1']);
    
    // æ’é™¤æ¥µç«¯ç•°å¸¸å€¼æˆ–ç„¡æ•ˆå€¼
    if (lowPrem !== 0 && avgPrem !== 0) {
        obj.count++;
        obj.sumLowPrem += lowPrem > 50 ? lowPrem - 100 : lowPrem; // ç°¡å–®ä¿®æ­£ï¼šæœ‰äº›è³‡æ–™å¯èƒ½æ˜¯ 105 è€Œä¸æ˜¯ 5
        obj.sumAvgPrem += avgPrem > 50 ? avgPrem - 100 : avgPrem;
    }

    // å˜—è©¦å–å¾—æ›ç‰Œè¡¨ç¾ (è‹¥ Excel æœ‰æä¾›)
    const h = safeFloat(row['æ›ç‰Œæœ€é«˜']);
    const l = safeFloat(row['æ›ç‰Œæœ€ä½']);
    if (h > 0 && l > 0) {
        obj.sumHigh += h;
        obj.sumLow += l;
        obj.countMarket++;
    }
}

// ==========================================
// çµ±è¨ˆèˆ‡é‹ç®—é‚è¼¯ (ç¶­æŒåŸé‚è¼¯ï¼Œæ”¹æ¥æ–°è³‡æ–™æº)
// ==========================================
function calculateGlobalMarketStats() {
    if (auctionRawData.length > 0) {
        let sumLow = 0, sumAvg = 0, count = 0;
        auctionRawData.forEach(d => {
            const l = safeFloat(d['æœ€ä½æº¢åƒ¹'] || d['s1']);
            const a = safeFloat(d['å¹³å‡æº¢åƒ¹'] || d['u1']);
            if (l > 0 && a > 0) { 
                sumLow += l > 50 ? l-100 : l; 
                sumAvg += a > 50 ? a-100 : a; 
                count++; 
            }
        });
        if (count > 0) {
            globalMarketStats.low = (sumLow / count);
            globalMarketStats.avg = (sumAvg / count);
        }
    }
}

// æ™ºèƒ½å€é–“åŒ¹é… (åˆ†é¡é‚è¼¯)
function classifyCapital(value) {
    if (value < 3) return '<3å„„';
    if (value < 6) return '3~6å„„';
    if (value < 10) return '6~10å„„';
    if (value < 15) return '10~15å„„';
    if (value < 20) return '15~20å„„';
    return '>20å„„';
}
function classifySize(value) {
    if (value < 2) return '<2å„„';
    if (value < 5) return '2~5å„„';
    if (value < 10) return '5~10å„„';
    if (value < 15) return '10~15å„„';
    if (value < 20) return '15~20å„„';
    return '>20å„„';
}
function classifyConversionPrice(value) {
    if (value < 20) return '<20å…ƒ';
    if (value < 50) return '20-50å…ƒ';
    if (value < 100) return '50-100å…ƒ';
    if (value < 150) return '100-150å…ƒ';
    if (value < 200) return '150-200å…ƒ';
    return '>200å…ƒ';
}
function classifyYears(value) { return value.toString(); }

function findBestRangeKey(category, value) {
    // æ­¤ç‰ˆæœ¬æ¡ç”¨å³æ™‚é‹ç®—ï¼Œæ­¤å‡½æ•¸ä¸»è¦ä¿ç•™ç›¸å®¹æ€§ï¼Œæˆ–ç”¨æ–¼æŸ¥æ‰¾éœæ…‹è¡¨
    return null; 
}

// å…¨èƒ½å‹•æ…‹çµ±è¨ˆé‹ç®— (æ ¸å¿ƒåŠŸèƒ½)
function getDynamicStats(filterFn) {
    if (!auctionRawData || auctionRawData.length === 0) return null;
    const matches = auctionRawData.filter(filterFn);
    if (matches.length === 0) return null;

    let sumLowPrem = 0, sumAvgPrem = 0, count = 0;
    matches.forEach(d => {
        const l = safeFloat(d['æœ€ä½æº¢åƒ¹'] || d['s1']);
        const a = safeFloat(d['å¹³å‡æº¢åƒ¹'] || d['u1']);
        if (l !== 0 && a !== 0) {
            sumLowPrem += l > 50 ? l-100 : l;
            sumAvgPrem += a > 50 ? a-100 : a;
            count++;
        }
    });

    if (count === 0) return null;
    return {
        'å¹³å‡æœ€ä½æº¢åƒ¹': sumLowPrem / count,
        'å¹³å‡æº¢åƒ¹': sumAvgPrem / count,
        'æ¨£æœ¬æ•¸': count
    };
}

// æ™ºèƒ½æ•¸æ“šç²å–ä»‹é¢
function getStatsSmart(category, val) {
    let stats = { low: 0, avg: 0, usedFallback: false, rawData: null };
    let filterFn = null;

    // å®šç¾©éæ¿¾é‚è¼¯
    if (category === 'ç™¼è¡Œåˆ¸å•†') {
        filterFn = d => { const n = d['ç™¼è¡Œåˆ¸å•†']||d['æ‰¿éŠ·åˆ¸å•†']||''; return n.includes(val) || val.includes(n); };
    } else if (category === 'ç”¢æ¥­') {
        filterFn = d => (d['ç”¢æ¥­åˆ†é¡']||d['ç”¢æ¥­åˆ¥']) === val;
    } else if (category === 'æ“”ä¿') {
        filterFn = d => (d['æ“”ä¿']||'').includes(val);
    } else if (category === 'å¹´æœŸ') {
        filterFn = d => safeFloat(d['å¹´æœŸ']||d['ç™¼è¡Œå¹´æœŸ']) == val;
    } else if (category === 'ä¿¡è©•') {
        filterFn = d => (d['ä¿¡è©•']||d['TCRI']||'').toString().includes(val.toString());
    } else if (category === 'è‚¡æœ¬') {
        // éœ€è§£æå€é–“é‚è¼¯ï¼Œæ­¤è™•ç°¡åŒ–è™•ç†ï¼Œè‹¥è¦ç²¾ç¢ºéœ€å¯¦ä½œå€é–“è§£æï¼Œç›®å‰ä¾è³´ DynamicStats æ‰¾ä¸åˆ°æ™‚å›å‚³ Global
    }

    // å˜—è©¦å³æ™‚é‹ç®—
    if (filterFn) {
        const dyn = getDynamicStats(filterFn);
        if (dyn) {
            stats.rawData = dyn;
            stats.low = dyn['å¹³å‡æœ€ä½æº¢åƒ¹'];
            stats.avg = dyn['å¹³å‡æº¢åƒ¹'];
        }
    }

    // è‹¥å³æ™‚é‹ç®—ç„¡çµæœï¼Œå˜—è©¦è®€å–å‰›ç”Ÿæˆçš„ Statistics
    if (stats.low === 0 && statistics['ç¶­åº¦çµ±è¨ˆ'][category] && statistics['ç¶­åº¦çµ±è¨ˆ'][category][val]) {
        let data = statistics['ç¶­åº¦çµ±è¨ˆ'][category][val];
        stats.rawData = data;
        stats.low = safeFloat(data['å¹³å‡æœ€ä½æº¢åƒ¹']);
        stats.avg = safeFloat(data['å¹³å‡æº¢åƒ¹']);
    }

    // è‡ªå‹•æ›¿è£œæ©Ÿåˆ¶
    if (stats.low === 0 || stats.avg === 0) {
        stats.low = globalMarketStats.low;
        stats.avg = globalMarketStats.avg;
        stats.usedFallback = true;
        if (!stats.rawData) stats.rawData = {};
    }

    return stats;
}

// ==========================================
// UI ç”Ÿæˆèˆ‡äº’å‹•é‚è¼¯
// ==========================================
function generateStandardCard(data, titleOverride=null) {
    if (!data) return `<div class="stat-row" style="color:#999;">æŸ¥ç„¡è³‡æ–™ (å°‡ä½¿ç”¨å¸‚å ´å‡å€¼é‹ç®—)</div>`;
    const val = (v, s='') => (v!==undefined && v!==null && v!=='') ? `${safeFloat(v).toFixed(2)}${s}` : '-';

    let html = `<div class="stats-header">ğŸ“Š ${titleOverride || 'æ­·å²çµ±è¨ˆ'}</div>`;
    if (data['æ¨£æœ¬æ•¸']) html += `<div class="stat-row" style="color:#555; font-weight:bold; margin-bottom:8px;">æ¨£æœ¬æ•¸: ${data['æ¨£æœ¬æ•¸']} æª”</div>`;

    html += `
    <div style="background:#f1f8e9; padding:8px; border-radius:5px; margin-bottom:8px;">
    <div class="stat-row"><span class="stat-label">ğŸ“‰ æœ€ä½æº¢åƒ¹:</span><span class="stat-value">${val(data['å¹³å‡æœ€ä½æº¢åƒ¹'], '%')}</span></div>
    <div class="stat-row"><span class="stat-label">âš–ï¸ å¹³å‡æº¢åƒ¹:</span><span class="stat-value">${val(data['å¹³å‡æº¢åƒ¹'], '%')}</span></div>
    </div>`;

    // åªæœ‰ç•¶ Excel æœ‰æ›ç‰Œæ•¸æ“šæ™‚æ‰é¡¯ç¤º
    const h = safeFloat(data['å¹³å‡æ›ç‰Œæœ€é«˜']);
    if (h > 0) {
        html += `<div style="border-top:1px dashed #ccc; padding-top:8px;"><div class="stat-row"><span class="stat-label">ğŸ“ˆ æ›ç‰Œæœ€é«˜:</span> <span class="stat-value">${val(h)}</span></div></div>`;
    }
    return html;
}

function initializeUI() {
    document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | æ•´åˆ Excel è³‡æ–™åº«`;
    populateSelect('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']);
    populateSelect('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);
    showStatsSummary();
    bindInputEvents();
}

function populateSelect(id, dataObj) {
    if (!dataObj) return;
    const select = document.getElementById(id);
    while (select.options.length > 1) { select.remove(1); }
    const items = Object.keys(dataObj).sort((a, b) => (dataObj[b]['æ¨£æœ¬æ•¸'] || 0) - (dataObj[a]['æ¨£æœ¬æ•¸'] || 0));
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = `${item} (æ¨£æœ¬:${dataObj[item]['æ¨£æœ¬æ•¸']})`;
        select.appendChild(option);
    });
}

function showStatsSummary() {
    document.getElementById('statsSummary').innerHTML = `
    <div class="stat-box"><div class="number">${Object.keys(cbDatabase).length || auctionRawData.length}</div><div class="label">è³‡æ–™åº«ç­†æ•¸</div></div>
    <div class="stat-box"><div class="number">${auctionRawData.length}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
    `;
}

function bindInputEvents() {
    const show = (id, html) => { const el = document.getElementById(id); el.innerHTML = html||''; el.style.display = html?'block':'none'; };

    // åç¨±è¼¸å…¥åæŸ¥
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim();
        if (!val) { show('cbNameInfo', null); return; }
        let found = cbNameMap[val] || auctionRawData.find(d => (d['åç¨±']||d['CBåç¨±']) && (d['åç¨±']||d['CBåç¨±']).includes(val));

        if (found) {
            let html = `<div class="stats-header">ğŸ“Š æ­·å²è³‡æ–™åƒè€ƒ</div><div class="stat-row">${found['ä»£è™Ÿ']||''} ${found['è‚¡ç¥¨ä»£è™Ÿ']||''}</div>`;
            if (found['æ›ç‰Œæœ€é«˜']) {
                html += `<div class="stat-row">ğŸ“ˆ æ›ç‰Œæœ€é«˜: ${safeFloat(found['æ›ç‰Œæœ€é«˜'])}</div>`;
            } else if (found['å¹³å‡æº¢åƒ¹']) {
                 html += `<div class="stat-row">ğŸ’° æ­·å²å¹³å‡æº¢åƒ¹: ${safeFloat(found['å¹³å‡æº¢åƒ¹'])}%</div>`;
            }
            show('cbNameInfo', html);
        } else show('cbNameInfo', null);
    });

    const bind = (id, cat) => {
        document.getElementById(id).addEventListener('change', function() {
            const val = this.value;
            if (val) {
                const smartResult = getStatsSmart(cat, val);
                show(id+'Info', generateStandardCard(smartResult.rawData, `æ­·å²çµ±è¨ˆ (${val})`));
            }
        });
        // æ•¸å­—è¼¸å…¥æ¡†ç”¨ input äº‹ä»¶
        if (document.getElementById(id).tagName === 'INPUT') {
            document.getElementById(id).addEventListener('input', function() {
                const val = parseFloat(this.value);
                if (val) {
                    // é‡å°æ•¸å­—é¡å‹çš„ç°¡å–®å€é–“åˆ¤å®š (åƒ…ä½œé¡¯ç¤ºç”¨ï¼Œå¯¦éš›è¨ˆç®—åœ¨ calculateEvaluation)
                    let rangeLabel = val;
                    if(cat==='è‚¡æœ¬') rangeLabel = classifyCapital(val);
                    if(cat==='ç™¼è¡Œè¦æ¨¡') rangeLabel = classifySize(val);
                    if(cat==='è½‰æ›åƒ¹') rangeLabel = classifyConversionPrice(val);
                    
                    const smartResult = getStatsSmart(cat, rangeLabel);
                    show(id+'Info', generateStandardCard(smartResult.rawData, `å€é–“çµ±è¨ˆ (${rangeLabel})`));
                    if(cat==='è½‰æ›åƒ¹' || cat==='ä¿¡è©•') updateSmartReminders();
                }
            });
        }
    };

    bind('capital', 'è‚¡æœ¬');
    bind('issueSize', 'ç™¼è¡Œè¦æ¨¡');
    bind('conversionPrice', 'è½‰æ›åƒ¹');
    bind('industry', 'ç”¢æ¥­');
    bind('broker', 'ç™¼è¡Œåˆ¸å•†');
    bind('years', 'å¹´æœŸ');
    bind('guarantee', 'æ“”ä¿');
    bind('rating', 'ä¿¡è©•');
    
    document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
}

function updateSmartReminders() {
    const stock = parseFloat(document.getElementById('stockPrice').value);
    const conv = parseFloat(document.getElementById('conversionPrice').value);
    if (stock && conv) {
        const theo = (stock/conv)*100;
        let msg = theo > 115 ? 'âš ï¸ ç†è«–åƒ¹åé«˜ï¼Œéœ€æ³¨æ„æº¢åƒ¹é¢¨éšª' : theo < 90 ? 'ğŸ’¡ ç†è«–åƒ¹å…·å¸å¼•åŠ›' : 'âœ¨ åƒ¹æ ¼å€é–“åˆç†';
        document.getElementById('reminderContent').textContent = msg;
        document.getElementById('smartReminders').style.display = 'block';
    }
}

// ç”¢ç”Ÿ Rex åˆ†æè©•è«–
function generateRexCommentary(result) {
    const prem = parseFloat(result.totalAvgPremium);
    let comment = "", strategy = "";

    if (prem >= 15) {
        comment = "ğŸ”¥ **å¸‚å ´éç†±è­¦ç¤º**ï¼šç›®å‰è©•ä¼°æº¢åƒ¹ç‡æ¥µé«˜ã€‚";
        strategy = "å»ºè­°æ¡**ä¿å®ˆç­–ç•¥**ï¼Œé¿å…è¿½é«˜é¢¨éšªã€‚";
    } else if (prem >= 8) {
        comment = "ğŸ“ˆ **å¤šé ­è¶¨å‹¢æ˜ç¢º**ï¼šç¶œåˆæº¢åƒ¹ç‡é¡¯ç¤ºå¸‚å ´æƒ…ç·’æ¨‚è§€ã€‚";
        strategy = "å¯æ¡**ç©æ¥µç­–ç•¥**ã€‚";
    } else if (prem >= 3) {
        comment = "âš–ï¸ **å€é–“åˆç†éœ‡ç›ª**ï¼šç›®å‰çš„æº¢åƒ¹ç‡è™•æ–¼æ­·å²åˆç†å€é–“ã€‚";
        strategy = "å»ºè­°æ¡**å¹³è¡¡ç­–ç•¥**ï¼Œä»¥ä¸Šä¸‹å¾®èª¿é€²è¡ŒæŠ•æ¨™ã€‚";
    } else {
        comment = "ğŸ§Š **é˜²ç¦¦åƒ¹å€¼æµ®ç¾**ï¼šç›®å‰æº¢åƒ¹ç‡ä½æ–¼å¹³å‡æ°´æº–ã€‚";
        strategy = "å…·å‚™**é«˜å®‰å…¨é‚Šéš›**ï¼Œé©åˆé•·æœŸæŒæœ‰ã€‚";
    }

    return `
    <div class="rex-analysis">
    <div class="rex-title">ğŸ§¢ Rexå¤§å” æ™ºå›Šæˆ°ç•¥åˆ†æ</div>
    <div class="rex-content"><p>${comment}</p><p style="margin-top:10px;"><strong>ğŸ’¡ æ“ä½œå»ºè­°ï¼š</strong>${strategy}</p></div>
    </div>`;
}

// ==========================================
// è¨ˆç®—æ ¸å¿ƒ (Evaluation)
// ==========================================
function calculateEvaluation(data) {
    const theoPrice = (data.stockPrice / data.conversionPrice) * 100;
    
    // å®šç¾©ç¶­åº¦èˆ‡æ¬Šé‡
    const dimsDef = [
        { key: 'industry', cat: 'ç”¢æ¥­', w: 0.25, val: data.industry },
        { key: 'broker', cat: 'ç™¼è¡Œåˆ¸å•†', w: 0.13, val: getBrokerName(data.cbName) || 'æœªæŸ¥è©¢åˆ°' },
        { key: 'capital', cat: 'è‚¡æœ¬', w: 0.12, val: classifyCapital(data.capital) },
        { key: 'size', cat: 'ç™¼è¡Œè¦æ¨¡', w: 0.10, val: classifySize(data.issueSize) },
        { key: 'rating', cat: 'ä¿¡è©•', w: 0.15, val: data.rating }, // éœ€æ³¨æ„ TCRI å°æ‡‰
        { key: 'guarantee', cat: 'æ“”ä¿', w: 0.12, val: data.guarantee },
        { key: 'years', cat: 'å¹´æœŸ', w: 0.08, val: data.years },
        { key: 'conversion', cat: 'è½‰æ›åƒ¹', w: 0.05, val: classifyConversionPrice(data.conversionPrice) }
    ];

    const dimensions = {};
    let weightedLow = 0, weightedAvg = 0;

    dimsDef.forEach(d => {
        const stat = getStatsSmart(d.cat, d.val);
        const coef = getWeightCoefficient(d.key, d.val);
        
        dimensions[d.key] = {
            ...stat, coefficient: coef, weight: d.w, range: d.val,
            weightedLow: stat.low * d.w * coef,
            weightedAvg: stat.avg * d.w * coef
        };
        weightedLow += dimensions[d.key].weightedLow;
        weightedAvg += dimensions[d.key].weightedAvg;
    });

    // ä¸»è§€æ¬Šé‡æ··åˆ
    const subRatio = (data.subjectiveWeight || 0) / 100;
    const objRatio = 1 - subRatio;
    
    const totalLow = (weightedLow * objRatio) + ((data.subjectiveLowPremium||0) * subRatio);
    const totalAvg = (weightedAvg * objRatio) + ((data.subjectiveAvgPremium||0) * subRatio);
    
    const gap = totalAvg - totalLow;
    const bidPrices = {
        conservative: (theoPrice * (1 + totalLow/100)).toFixed(2),
        balanced: (theoPrice * (1 + totalAvg/100)).toFixed(2),
        aggressive: (theoPrice * (1 + (totalAvg + gap)/100)).toFixed(2),
        ultimate: (theoPrice * (1 + (totalAvg + gap*2)/100)).toFixed(2)
    };

    return {
        cbName: data.cbName, theoreticalPrice: theoPrice.toFixed(2),
        dimensions: dimensions,
        totalLowPremium: totalLow.toFixed(2), totalAvgPremium: totalAvg.toFixed(2),
        bidPrices: bidPrices, gap: gap.toFixed(2), inputData: data,
        // ç”¨æ–¼é¡¯ç¤ºä¸»è§€æ¬Šé‡è©³ç´°è³‡è¨Š
        weightedSubjectiveLow: ((data.subjectiveLowPremium||0) * subRatio).toFixed(2),
        weightedSubjectiveAvg: ((data.subjectiveAvgPremium||0) * subRatio).toFixed(2)
    };
}

// é¡¯ç¤ºçµæœ
function displayResult(result) {
    document.getElementById('welcomeMsg').style.display = 'none';
    const resultDiv = document.getElementById('evaluationResult');
    resultDiv.className = 'evaluation-result active';
    
    // è¡¨æ ¼ç”Ÿæˆ (ç°¡åŒ–ç‰ˆ)
    let rows = '';
    const nameMap = {'industry':'ç”¢æ¥­åˆ†é¡','broker':'ç™¼è¡Œåˆ¸å•†','capital':'è‚¡æœ¬','size':'è¦æ¨¡','rating':'ä¿¡è©•','guarantee':'æ“”ä¿','years':'å¹´æœŸ','conversion':'è½‰æ›åƒ¹'};
    
    for (const [key, dim] of Object.entries(result.dimensions)) {
        rows += `<tr><td>${nameMap[key]}</td><td>${dim.range}</td><td>${dim.low.toFixed(2)}%</td><td>${dim.avg.toFixed(2)}%</td><td>${(dim.weight*100).toFixed(0)}%</td><td>${dim.weightedAvg.toFixed(2)}</td></tr>`;
    }

    resultDiv.innerHTML = `
    <div class="result-header"><h2>${result.cbName}</h2><div class="subtitle">Excel é©…å‹• AI è©•ä¼°çµæœ</div></div>
    <div class="detail-section">
        <h3>ğŸ“Š ç†è«–åƒ¹æ ¼è¨ˆç®—</h3>
        <div style="text-align:center; padding:20px; background:#f8f9fa;">
            <div style="font-size:48px; color:#667eea; font-weight:bold;">${result.theoreticalPrice} å…ƒ</div>
        </div>
    </div>
    <div class="detail-section">
        <h3>ğŸ” åˆ†ææ˜ç´°</h3>
        <table class="data-table"><thead><tr><th>ç¶­åº¦</th><th>æ¢ä»¶</th><th>æ­·å²æœ€ä½æº¢åƒ¹</th><th>æ­·å²å¹³å‡æº¢åƒ¹</th><th>æ¬Šé‡</th><th>åŠ æ¬Šè²¢ç»</th></tr></thead><tbody>${rows}</tbody></table>
    </div>
    ${generateRexCommentary(result)}
    <div class="detail-section">
        <h3>ğŸ’¡ æŠ•æ¨™å»ºè­°</h3>
        <div class="price-grid">
            <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆ</h4><div class="price">${result.bidPrices.conservative}</div></div>
            <div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡</h4><div class="price">${result.bidPrices.balanced}</div></div>
            <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µ</h4><div class="price">${result.bidPrices.aggressive}</div></div>
            <div class="strategy-card ultimate"><h4>ğŸ”¥ æ¥µè‡´</h4><div class="price">${result.bidPrices.ultimate}</div></div>
        </div>
    </div>
    <div style="text-align:center; margin-top:30px;"><button onclick="location.reload()" class="calculate-btn" style="width:200px;">ğŸ”„ é‡æ–°è©•ä¼°</button></div>
    `;
    resultDiv.scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const fd = {
        cbName: document.getElementById('cbName').value,
        industry: document.getElementById('industry').value,
        issueSize: parseFloat(document.getElementById('issueSize').value),
        years: document.getElementById('years').value,
        guarantee: document.getElementById('guarantee').value,
        rating: document.getElementById('rating').value,
        capital: parseFloat(document.getElementById('capital').value),
        stockPrice: parseFloat(document.getElementById('stockPrice').value),
        conversionPrice: parseFloat(document.getElementById('conversionPrice').value),
        subjectiveWeight: parseFloat(document.getElementById('subjectiveWeight').value)||0,
        subjectiveLowPremium: parseFloat(document.getElementById('subjectiveLowPremium').value)||0,
        subjectiveAvgPremium: parseFloat(document.getElementById('subjectiveAvgPremium').value)||0
    };
    displayResult(calculateEvaluation(fd));
});

window.addEventListener('DOMContentLoaded', loadStatistics);
</script>
</body>
</html>
