<!DOCTYPE html>

<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.52 (æ¨™çš„è©•åˆ†ç‰ˆ)</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="embedded_data.js" onerror="console.warn('embedded_data.js not found, using defaults.')"></script>

<style>
/* ================= é¢¨æ ¼è¨­å®š ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1600px; margin: 0 auto; }
.header { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
.header::before { content: ""; position: absolute; top: 0; left: 0; width: 10px; height: 100%; background: #9C27B0; }
.header h1 { color: #667eea; font-size: 28px; margin-bottom: 10px; font-weight: 900; }
.header .subtitle { color: #666; font-size: 15px; display: flex; align-items: center; gap: 10px; font-weight: bold; flex-wrap: wrap; }
.version-badge { display: inline-block; background: #7B1FA2; color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; }

.evaluation-container { display: grid; grid-template-columns: 480px 1fr; gap: 20px; }
.input-panel { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }
.input-panel h2 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid #667eea; font-weight: 800; }
.form-section { margin-bottom: 20px; }
.form-section h3 { color: #333; font-size: 15px; margin-bottom: 12px; font-weight: bold; border-left: 4px solid #667eea; padding-left: 10px; }
.form-group { margin-bottom: 12px; }
.form-group label { display: block; color: #555; font-size: 13px; margin-bottom: 6px; font-weight: 700; }
.form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; font-weight: 600; color:#333; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; background: #fcfdff; }

/* è³‡è¨Šå¡ç‰‡ */
.info-box { background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 5px solid #4CAF50; margin-top: 8px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); animation: slideDown 0.3s ease-out; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

/* ===== æ­·å²æœå°‹çµæœå¡ç‰‡ (v3.51 æ’é™¤æ¥µç«¯å€¼ç‰ˆ) ===== */
.history-results { 
    margin-top: 10px; 
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border: 2px solid #9c27b0; 
    border-radius: 12px; 
    padding: 15px; 
    display: none; 
    max-height: 450px; 
    overflow-y: auto;
}
.history-results-title {
    font-size: 14px;
    font-weight: bold;
    color: #6a1b9a;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* è©¢åœˆæ¡ˆä¾‹ç°¡å–®å¡ç‰‡ */
.inquiry-card {
    background: #fff3e0;
    border: 1px solid #ffb74d;
    border-radius: 6px;
    margin-bottom: 6px;
    padding: 8px 10px;
    font-size: 11px;
}
.inquiry-line1, .inquiry-line2 {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
}
.inquiry-line2 {
    margin-top: 4px;
}
.inquiry-badge {
    background: #ff9800;
    color: white;
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: bold;
}
.inquiry-name {
    font-weight: 700;
    color: #e65100;
    margin-right: 2px;
}
.inquiry-info {
    color: #666;
    white-space: nowrap;
}
.inquiry-info b {
    color: #333;
}
.inquiry-info b.pink {
    color: #E91E63;
}
/* å›ºå®šå„æ¬„ä½å¯¬åº¦ï¼ˆç·Šæ¹Šç‰ˆï¼‰ */
.iq-size { width: 58px; }
.iq-year { width: 48px; }
.iq-guar { width: 42px; }
.iq-high { width: 72px; }
.iq-low { width: 70px; }
.iq-amp { width: 78px; }
.iq-prem { width: 85px; }

/* å–®ç­†æ­·å²å¡ç‰‡ - ç²¾ç°¡ç‰ˆ */
.history-card { 
    background: #f3e5f5; 
    padding: 10px 12px; 
    border-radius: 8px; 
    margin-bottom: 8px; 
    border: 1px solid #ba68c8;
    font-size: 11px;
}
.history-card:last-child { margin-bottom: 0; }

/* å¡ç‰‡æ¨™é¡Œåˆ— */
.hc-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    flex-wrap: wrap;
}
.hc-badge {
    background: #9C27B0;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: bold;
}
.hc-name {
    font-weight: 700;
    color: #6a1b9a;
    flex: 1;
}
.hc-date {
    font-size: 10px;
    color: #999;
}

/* è³‡è¨Šåˆ— - æ©«å‘ç·Šæ¹Šæ’åˆ— */
.hc-line {
    display: flex;
    flex-wrap: wrap;
    gap: 4px 8px;
    margin-bottom: 6px;
}
.hc-info {
    color: #666;
    font-size: 11px;
    white-space: nowrap;
}
.hc-info b {
    color: #333;
    margin-left: 2px;
}

/* å¡ç‰‡å…§è¡¨æ ¼ - å¾—æ¨™+æ›ç‰Œåˆä½µ */
.hc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    margin-top: 6px;
    background: white;
    border-radius: 4px;
    overflow: hidden;
}
.hc-table th {
    background: #7B1FA2;
    color: white;
    padding: 5px 4px;
    font-weight: 700;
    text-align: center;
}
.hc-table td {
    padding: 5px 4px;
    text-align: center;
    border: 1px solid #e0e0e0;
    font-weight: 600;
}
.td-label {
    background: #f3e5f5;
    color: #6a1b9a;
    font-weight: 700;
    font-size: 10px;
}
.val-red { color: #d32f2f; font-weight: 700; }
.val-pink { color: #E91E63; font-weight: 900; }

/* è­¦ç¤ºèª */
.warning-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 10px; margin-top: 5px; font-size: 12px; color: #e65100; font-weight: bold; border-radius: 4px; }

/* ç¶ è‰²å¡ç‰‡å…§çš„æ›ç‰Œè¡¨æ ¼ */
.card-market-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    margin-top: 8px;
    border-radius: 4px;
    overflow: hidden;
}
.card-market-table th {
    background: #2e7d32;
    color: white;
    padding: 4px 5px;
    font-weight: 700;
    font-size: 10px;
    text-align: center;
}
.card-market-table td {
    padding: 4px 5px;
    text-align: center;
    border-bottom: 1px solid #c8e6c9;
    background: #f1f8e9;
}
.card-market-table .type-label {
    font-weight: 700;
    color: #1b5e20;
    text-align: left;
    padding-left: 8px;
}
.card-market-table .type-label .count {
    font-size: 9px;
    color: #666;
    margin-left: 3px;
}
.card-market-table .val-blue { font-weight: 700; color: #1565c0; }
.card-market-table .val-pink { font-weight: 700; color: #E91E63; }
.card-market-table .total-row td {
    background: #c8e6c9;
    font-weight: 900;
    border-top: 2px solid #4CAF50;
}
/* v3.51 æ–°å¢ï¼šæ’é™¤å‰ä¸‰çš„æ·ºè‰²åº• */
.card-market-table .exclude-row td {
    background: #e3f2fd;
    font-style: italic;
}

/* ä¸»è§€æ¬Šé‡èªªæ˜ */
.subjective-note { background: #f5f5f5; padding: 10px; border-radius: 6px; font-size: 12px; color: #555; margin-bottom: 12px; border: 1px solid #ddd; line-height: 1.5; }

/* Footer ç‰ˆæ¬Šå®£å‘Š */
.site-footer {
    margin-top: 30px;
    padding: 20px;
    background: rgba(255,255,255,0.95);
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.footer-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.visitor-count {
    font-size: 13px;
    color: #666;
    display: flex;
    align-items: center;
    gap: 5px;
}
.copyright {
    font-size: 12px;
    color: #888;
    line-height: 1.6;
}

.stats-header { font-size: 13px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 12px; color: #444; margin-bottom: 5px; display: flex; align-items: center; justify-content: space-between; }
.stat-label { color: #555; font-weight: 500; }
.stat-value { font-weight: bold; color: #333; }

.calculate-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-top: 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.calculate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }

.result-panel { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px; }
.welcome-message { text-align: center; padding: 50px 20px; }
.stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 30px; }
.stat-box { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #eee; transition: transform 0.3s; }
.stat-box:hover { transform: translateY(-5px); border-color: #b39ddb; }
.stat-box .number { font-size: 32px; font-weight: bold; color: #667eea; margin-bottom: 8px; }

.evaluation-result { display: none; }
.evaluation-result.active { display: block; animation: fadeIn 0.5s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
.detail-section { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 2px solid #e0e0e0; }
.detail-section h3 { color: #667eea; font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 20px; transition: transform 0.3s; }
.strategy-card:hover { transform: translateY(-5px); }
.strategy-card h4 { font-size: 16px; margin-bottom: 10px; }
.strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
.strategy-card.conservative h4 { color: #2e7d32; }
.strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
.strategy-card.balanced h4 { color: #e65100; }
.strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
.strategy-card.aggressive h4 { color: #c62828; }
.strategy-card.ultimate { border-color: #9C27B0; background: #f3e5f5; }
.strategy-card.ultimate h4 { color: #6a1b9a; }
.strategy-card .price { font-size: 28px; font-weight: bold; margin: 8px 0; color: #333; }

/* è¡¨æ ¼ */
.data-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
.data-table th { background-color: #1A237E; color: white; padding: 10px 5px; text-align: center; font-weight: 900; border: 1px solid #0d1b5e; vertical-align: bottom; line-height: 1.2; }
.data-table td { padding: 10px 8px; text-align: center; border: 1px solid #e0e0e0; color: #000; font-weight: 600; }
.data-table td:nth-child(n+3) { text-align: right; font-family: 'Segoe UI', monospace; }
.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tr:hover { background-color: #e8eaf6; }
.data-table tfoot td { background-color: #e8eaf6; font-weight: 900; color: #1A237E; border-top: 2px solid #3f51b5; }

.rex-analysis { background: linear-gradient(to right, #fff3e0, #ffe0b2); border-left: 6px solid #ff9800; padding: 20px; border-radius: 8px; margin-top: 25px; }
.rex-title { font-size: 18px; font-weight: bold; color: #e65100; margin-bottom: 12px; }
.rex-content { color: #5d4037; line-height: 1.8; font-size: 14px; }

@media (max-width: 1200px) { 
    .evaluation-container { grid-template-columns: 1fr; } 
    .input-panel { position: relative; top: 0; } 
}

@media (max-width: 768px) {
    body { padding: 10px; }
    .header { padding: 15px; }
    .header h1 { font-size: 20px; }
    .input-panel { padding: 15px; }
    
    /* å¹´åº¦ç¸¾æ•ˆæ‰‹æ©Ÿç‰ˆ */
    .yearly-performance { padding: 12px; }
    .yearly-performance-title { font-size: 14px; }
    .yearly-section { padding: 10px; }
    .year-block { padding: 10px; }
    .year-block-header { flex-direction: column; align-items: flex-start; gap: 5px; }
    .year-stats { font-size: 10px; }
    .year-rankings { flex-direction: column; gap: 10px; }
    .rank-col { min-width: 100%; }
    .ranking-item { font-size: 11px; }
    
    /* è¿‘æœŸç¸¾æ•ˆæ‰‹æ©Ÿç‰ˆ */
    .recent-performance { padding: 10px; }
    .recent-performance-title { font-size: 14px; }
    .period-container { flex-direction: column; gap: 10px; }
    .period-block { min-width: 100%; width: 100%; padding: 10px; }
    .period-rankings { flex-direction: row; gap: 8px; }
    .rank-col-sm { flex: 1; min-width: 0; }
    .rank-list-sm .ranking-item { font-size: 9px; }
    
    /* ç†±åº¦åˆ†ææ‰‹æ©Ÿç‰ˆ */
    .heat-analysis { padding: 12px; overflow-x: auto; }
    .heat-analysis-title { font-size: 14px; }
    .heat-table { font-size: 9px; min-width: 600px; }
    .heat-table th, .heat-table td { padding: 5px 3px; }
    .heat-insight { margin-top: 10px; }
    .insight-content { font-size: 11px; }
    
    /* ç‰¹å¾µåˆ†ææ‰‹æ©Ÿç‰ˆ */
    .trait-analysis { padding: 12px; }
    .trait-comparison { flex-direction: column; }
    .trait-group { min-width: 100%; }
    .performer-items { flex-direction: column; }
    .performer-item { white-space: normal; }
}

@media (max-width: 500px) {
    .history-info-line { gap: 2px 8px; }
    .history-bid-row { flex-direction: column; gap: 6px; }
    
    /* æ›´å°è¢å¹•å„ªåŒ– */
    .header h1 { font-size: 18px; }
    .version-badge { font-size: 11px; padding: 3px 8px; }
    .stat-box .number { font-size: 24px; }
    .yearly-section-title { font-size: 12px; }
    .year-badge { font-size: 11px; padding: 3px 8px; }
    .rank-label, .rank-label-sm { font-size: 10px; }
    .ranking-item { font-size: 10px; padding: 3px 0; }
    .ranking-item .return { font-size: 10px; }
}

/* v3.52 å¹´åº¦ç¸¾æ•ˆåˆ†ææ¨£å¼ */
.yearly-performance {
    margin-top: 25px;
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #4CAF50;
}
.yearly-performance-title {
    font-size: 16px;
    font-weight: bold;
    color: #2e7d32;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 2px solid #4CAF50;
    padding-bottom: 10px;
}
.yearly-section {
    margin-bottom: 20px;
    background: white;
    border-radius: 10px;
    padding: 15px;
}
.yearly-section:last-child {
    margin-bottom: 0;
}
.yearly-section-title {
    font-size: 14px;
    font-weight: bold;
    color: #1b5e20;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #4CAF50;
}
/* å¹´åº¦å€å¡Š */
.year-block {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}
.year-block:last-child {
    margin-bottom: 0;
}
.year-block-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}
.year-badge {
    background: #2e7d32;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 13px;
    font-weight: bold;
}
.year-badge.inquiry {
    background: #ff9800;
}
.year-stats {
    font-size: 12px;
    color: #555;
}
.year-rankings {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}
.rank-col {
    flex: 1;
    min-width: 220px;
    background: white;
    border-radius: 6px;
    padding: 10px;
    border: 1px solid #e8e8e8;
}
.rank-label {
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 8px;
    padding: 4px 10px;
    border-radius: 4px;
    display: inline-block;
}
.rank-label.best {
    background: #e8f5e9;
    color: #2e7d32;
}
.rank-label.worst {
    background: #ffebee;
    color: #c62828;
}
.rank-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.ranking-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    padding: 4px 0;
    border-bottom: 1px dotted #e0e0e0;
}
.ranking-item:last-child {
    border-bottom: none;
}
.ranking-item .return {
    margin-left: auto;
    font-weight: bold;
    font-size: 12px;
}
.ranking-item .return.positive {
    color: #d32f2f;
}
.ranking-item .return.negative {
    color: #1565c0;
}
.positive { color: #d32f2f; font-weight: bold; }
.negative { color: #1565c0; font-weight: bold; }

/* è¿‘æœŸç¸¾æ•ˆåˆ†ææ¨£å¼ */
.recent-performance {
    margin-top: 20px;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 12px;
    padding: 15px;
    border: 2px solid #2196F3;
    overflow: hidden;
}
.recent-performance-title {
    font-size: 16px;
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 15px;
    border-bottom: 2px solid #2196F3;
    padding-bottom: 10px;
    text-align: center;
}
.period-container {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}
.period-block {
    flex: 1;
    min-width: 280px;
    background: white;
    border-radius: 10px;
    padding: 12px;
    box-sizing: border-box;
    overflow: hidden;
}
.period-header {
    margin-bottom: 10px;
    text-align: center;
}
.period-badge {
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 13px;
    font-weight: bold;
    color: white;
    display: inline-block;
}
.period-badge.hot {
    background: linear-gradient(135deg, #ff5722, #ff9800);
}
.period-badge.warm {
    background: linear-gradient(135deg, #2196F3, #03a9f4);
}
.period-content {
    width: 100%;
}
.period-section {
    margin-bottom: 10px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
}
.period-section:last-child {
    margin-bottom: 0;
}
.period-section-title {
    font-size: 12px;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
    text-align: center;
}
.period-rankings {
    display: flex;
    gap: 10px;
}
.rank-col-sm {
    flex: 1;
    min-width: 0;
}
.rank-label-sm {
    font-size: 11px;
    font-weight: bold;
    margin-bottom: 5px;
    padding: 2px 6px;
    border-radius: 3px;
    display: inline-block;
}
.rank-label-sm.best {
    background: #e8f5e9;
    color: #2e7d32;
}
.rank-label-sm.worst {
    background: #ffebee;
    color: #c62828;
}
.rank-list-sm {
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: 11px;
}
.rank-list-sm .ranking-item {
    font-size: 10px;
    padding: 2px 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* æŠ•æ¨™ç†±åº¦åˆ†ææ¨£å¼ */
.heat-analysis {
    margin-top: 20px;
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #ff9800;
}
.heat-analysis-title {
    font-size: 16px;
    font-weight: bold;
    color: #e65100;
    margin-bottom: 10px;
    border-bottom: 2px solid #ff9800;
    padding-bottom: 10px;
}
.heat-explanation {
    font-size: 12px;
    color: #666;
    margin-bottom: 15px;
    padding: 8px;
    background: white;
    border-radius: 6px;
}
.heat-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}
.heat-table th {
    background: #e65100;
    color: white;
    padding: 8px 5px;
    font-weight: bold;
    text-align: center;
    font-size: 10px;
}
.heat-table td {
    padding: 8px 5px;
    text-align: center;
    border-bottom: 1px solid #e0e0e0;
}
.heat-table .year-cell {
    font-weight: bold;
    color: #e65100;
    background: #fff3e0;
}
.heat-table .total-row td {
    background: #ffe0b2;
    font-weight: bold;
    border-top: 2px solid #ff9800;
}
.corr-positive {
    color: #2e7d32;
    font-weight: bold;
    font-size: 10px;
}
.corr-negative {
    color: #c62828;
    font-weight: bold;
    font-size: 10px;
}
.corr-neutral {
    color: #666;
    font-size: 10px;
}
.heat-insight {
    margin-top: 15px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border-left: 4px solid #ff9800;
}
.insight-title {
    font-size: 13px;
    font-weight: bold;
    color: #e65100;
    margin-bottom: 8px;
}
.insight-content {
    font-size: 12px;
    color: #333;
    line-height: 1.6;
}

/* ç¸¾æ•ˆç‰¹å¾µåˆ†ææ¨£å¼ */
.trait-analysis {
    margin-top: 20px;
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #9c27b0;
}
.trait-analysis-title {
    font-size: 16px;
    font-weight: bold;
    color: #6a1b9a;
    margin-bottom: 10px;
    border-bottom: 2px solid #9c27b0;
    padding-bottom: 10px;
}
.trait-explanation {
    font-size: 12px;
    color: #666;
    margin-bottom: 15px;
    padding: 8px;
    background: white;
    border-radius: 6px;
}
.trait-comparison {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}
.trait-group {
    flex: 1;
    min-width: 280px;
    background: white;
    border-radius: 10px;
    padding: 15px;
}
.trait-group.good {
    border: 2px solid #4CAF50;
}
.trait-group.bad {
    border: 2px solid #f44336;
}
.trait-group-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e0e0e0;
}
.trait-group.good .trait-group-title {
    color: #2e7d32;
}
.trait-group.bad .trait-group-title {
    color: #c62828;
}
.trait-avg-return {
    font-size: 13px;
    margin-bottom: 10px;
    padding: 5px 8px;
    background: #f5f5f5;
    border-radius: 4px;
}
.trait-section {
    margin-bottom: 8px;
    padding: 6px 0;
    border-bottom: 1px dotted #e0e0e0;
}
.trait-section:last-child {
    border-bottom: none;
}
.trait-label {
    font-size: 11px;
    color: #666;
    margin-bottom: 3px;
}
.trait-value {
    font-size: 12px;
    color: #333;
    font-weight: 500;
}
.trait-insights {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 4px solid #9c27b0;
}
.trait-insights .insight-title {
    font-size: 14px;
    font-weight: bold;
    color: #6a1b9a;
    margin-bottom: 10px;
}
.insight-findings {
    font-size: 12px;
    line-height: 1.8;
}
.finding {
    display: block;
    padding: 5px 0;
}
.finding.good {
    color: #2e7d32;
}
.finding.bad {
    color: #c62828;
}
.finding.neutral {
    color: #666;
}
.top-performers-list, .bottom-performers-list {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}
.top-performers-list {
    border-left: 4px solid #4CAF50;
}
.bottom-performers-list {
    border-left: 4px solid #f44336;
}
.list-title {
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 8px;
}
.top-performers-list .list-title {
    color: #2e7d32;
}
.bottom-performers-list .list-title {
    color: #c62828;
}
.performer-items {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.performer-item {
    font-size: 11px;
    background: #f5f5f5;
    padding: 4px 8px;
    border-radius: 4px;
    white-space: nowrap;
}
.performer-item small {
    color: #999;
    font-size: 9px;
}

@media (max-width: 768px) {
    .trait-comparison {
        flex-direction: column;
    }
    .trait-group {
        min-width: 100%;
    }
    .performer-items {
        flex-direction: column;
    }
    .performer-item {
        white-space: normal;
    }
}

/* æ½›åŠ›æ¨™çš„ç¯©é¸æ¨£å¼ */
.potential-screening {
    margin-top: 20px;
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #4CAF50;
}
.potential-screening-title {
    font-size: 16px;
    font-weight: bold;
    color: #2e7d32;
    margin-bottom: 10px;
    border-bottom: 2px solid #4CAF50;
    padding-bottom: 10px;
    text-align: center;
}
.good-combos-section {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}
.good-combos-title {
    font-size: 14px;
    font-weight: bold;
    color: #1b5e20;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #c8e6c9;
}
.combo-cards {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.combo-card {
    flex: 1;
    min-width: 180px;
    background: linear-gradient(135deg, #f1f8e9, #dcedc8);
    border: 1px solid #aed581;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
}
.combo-card-name {
    font-size: 12px;
    font-weight: bold;
    color: #33691e;
    margin-bottom: 5px;
}
.combo-card-return {
    font-size: 18px;
    font-weight: 900;
    color: #2e7d32;
}
.combo-card-sample {
    font-size: 10px;
    color: #666;
}
.potential-list-section {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
}
.potential-list-title {
    font-size: 14px;
    font-weight: bold;
    color: #1b5e20;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #c8e6c9;
    display: flex;
    align-items: center;
    gap: 8px;
}
.potential-list-title .count-badge {
    background: #4CAF50;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
}
.potential-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}
.potential-table th {
    background: #2e7d32;
    color: white;
    padding: 8px 5px;
    text-align: center;
    font-size: 10px;
}
.potential-table td {
    padding: 8px 5px;
    text-align: center;
    border-bottom: 1px solid #e0e0e0;
}
.potential-table tr:hover {
    background: #f1f8e9;
}
.potential-table .name-cell {
    text-align: left;
    font-weight: bold;
    color: #1b5e20;
}
.potential-table .price-cell {
    font-weight: bold;
}
.potential-table .price-cell.below-par {
    color: #d32f2f;
    background: #ffebee;
}
.potential-table .combo-cell {
    font-size: 9px;
    color: #666;
    text-align: left;
    max-width: 150px;
}
.potential-table .return-cell {
    font-weight: bold;
    color: #2e7d32;
}
.match-badge {
    display: inline-block;
    background: #ff9800;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 9px;
    font-weight: bold;
}
.below-par-section {
    background: linear-gradient(135deg, #ffebee, #ffcdd2);
    border: 2px solid #f44336;
}
.below-par-section .potential-list-title {
    color: #c62828;
    border-bottom-color: #ef9a9a;
}
.below-par-note {
    font-size: 11px;
    color: #c62828;
    padding: 8px;
    background: white;
    border-radius: 6px;
    margin-bottom: 10px;
    border-left: 3px solid #f44336;
}
@media (max-width: 768px) {
    .combo-cards {
        flex-direction: column;
    }
    .combo-card {
        min-width: 100%;
    }
    .potential-table {
        font-size: 9px;
    }
    .potential-table th, .potential-table td {
        padding: 5px 3px;
    }
}

/* æ¨™çš„è©•åˆ†ç³»çµ±æ¨£å¼ */
.scoring-system {
    margin-top: 20px;
    background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #3f51b5;
}
.scoring-system-title {
    font-size: 16px;
    font-weight: bold;
    color: #283593;
    margin-bottom: 15px;
    border-bottom: 2px solid #3f51b5;
    padding-bottom: 10px;
    text-align: center;
}
.scoring-search-box {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.scoring-search-input {
    flex: 1;
    min-width: 200px;
    padding: 12px 15px;
    border: 2px solid #3f51b5;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
}
.scoring-search-input:focus {
    outline: none;
    border-color: #1a237e;
    background: #f5f5ff;
}
.scoring-search-btn {
    padding: 12px 25px;
    background: linear-gradient(135deg, #3f51b5, #1a237e);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
}
.scoring-search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(63, 81, 181, 0.4);
}
.scoring-result {
    background: white;
    border-radius: 10px;
    padding: 15px;
    display: none;
}
.scoring-result.active {
    display: block;
    animation: slideDown 0.3s ease-out;
}
.scoring-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
    flex-wrap: wrap;
}
.scoring-cb-name {
    font-size: 18px;
    font-weight: 900;
    color: #1a237e;
}
.scoring-cb-id {
    font-size: 13px;
    color: #666;
    background: #e8eaf6;
    padding: 3px 10px;
    border-radius: 15px;
}
.scoring-source {
    font-size: 11px;
    color: #999;
    margin-left: auto;
}
.scoring-gauge {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0;
    gap: 30px;
    flex-wrap: wrap;
}
.score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.score-circle.excellent {
    background: linear-gradient(135deg, #4CAF50, #2e7d32);
    color: white;
}
.score-circle.good {
    background: linear-gradient(135deg, #8bc34a, #689f38);
    color: white;
}
.score-circle.neutral {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
}
.score-circle.poor {
    background: linear-gradient(135deg, #f44336, #c62828);
    color: white;
}
.score-circle .score-value {
    font-size: 32px;
    line-height: 1;
}
.score-circle .score-label {
    font-size: 12px;
    margin-top: 5px;
    opacity: 0.9;
}
.scoring-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
}
.scoring-detail-box {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
}
.scoring-detail-box.positive {
    border-left: 4px solid #4CAF50;
    background: #f1f8e9;
}
.scoring-detail-box.negative {
    border-left: 4px solid #f44336;
    background: #ffebee;
}
.scoring-detail-title {
    font-size: 13px;
    font-weight: bold;
    margin-bottom: 8px;
}
.scoring-detail-box.positive .scoring-detail-title {
    color: #2e7d32;
}
.scoring-detail-box.negative .scoring-detail-title {
    color: #c62828;
}
.scoring-detail-list {
    font-size: 12px;
    line-height: 1.8;
}
.scoring-detail-item {
    display: flex;
    align-items: center;
    gap: 5px;
}
.scoring-detail-item .check {
    color: #4CAF50;
}
.scoring-detail-item .cross {
    color: #f44336;
}
.scoring-conditions {
    margin-top: 15px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
}
.scoring-conditions-title {
    font-size: 12px;
    font-weight: bold;
    color: #333;
    margin-bottom: 8px;
}
.scoring-condition-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    font-size: 11px;
}
.scoring-condition-tag {
    padding: 3px 8px;
    border-radius: 4px;
    background: #e0e0e0;
}
.scoring-prediction {
    margin-top: 15px;
    padding: 15px;
    background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    border-radius: 8px;
    border-left: 4px solid #ff9800;
}
.scoring-prediction-title {
    font-size: 13px;
    font-weight: bold;
    color: #e65100;
    margin-bottom: 8px;
}
.scoring-prediction-content {
    font-size: 12px;
    color: #5d4037;
    line-height: 1.6;
}
.no-result-msg {
    text-align: center;
    padding: 30px;
    color: #999;
}
@media (max-width: 768px) {
    .scoring-details {
        grid-template-columns: 1fr;
    }
    .scoring-gauge {
        flex-direction: column;
    }
    .score-circle {
        width: 100px;
        height: 100px;
    }
    .score-circle .score-value {
        font-size: 26px;
    }
}
</style>

</head>

<body>
<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 22px; font-weight: bold;">
    <div>ğŸ”„ ç³»çµ±å•Ÿå‹•ä¸­ (v3.52)...</div>
    <div id="loading-detail" style="font-size: 15px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æ­£åœ¨æ•´åˆç«¶æ‹è³‡æ–™åº«...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.52</span></h1>
        <div class="subtitle">
            <span>Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤</span>
            <span style="color:#ddd">|</span>
            <span id="headerSubtitle">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

```
<div class="evaluation-container">
    <div class="input-panel">
        <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
        <form id="evaluationForm">
            <div class="form-section">
                <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                <div class="form-group">
                    <label>CBåç¨± / ä»£è™Ÿ *</label>
                    <input type="text" id="cbName" required placeholder="è¼¸å…¥ä»£è™Ÿ(å¦‚2383)æˆ–åç¨±æœå°‹æ­·å²">
                    <div id="historyResults" class="history-results"></div>
                    <div id="cbNameInfo" class="info-box"></div>
                </div>
                
                <div class="form-group"><label>è‚¡æœ¬ (å„„å…ƒ) *</label><input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80"><div id="capitalInfo" class="info-box"></div></div>
                <div class="form-group"><label>ç”¢æ¥­åˆ†é¡ *</label><select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select><div id="industryInfo" class="info-box"></div></div>
                <div class="form-group"><label>ç™¼è¡Œåˆ¸å•†</label><select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select><div id="brokerInfo" class="info-box"></div></div>
            </div>
            <div class="form-section">
                <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                <div class="form-group"><label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label><input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š30"><div id="issueSizeInfo" class="info-box"></div></div>
                <div class="form-group"><label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label><input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š450"><div id="conversionPriceInfo" class="info-box"></div></div>
                <div class="form-group"><label>ç™¼è¡Œå¹´æœŸ *</label><select id="years" required><option value="">è«‹é¸æ“‡...</option><option value="3">3å¹´æœŸ</option><option value="5">5å¹´æœŸ</option><option value="7">7å¹´æœŸ</option></select><div id="yearsInfo" class="info-box"></div></div>
                <div class="form-group"><label>æ“”ä¿æƒ…æ³ *</label><select id="guarantee" required><option value="">è«‹é¸æ“‡...</option><option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option><option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option></select><div id="guaranteeInfo" class="info-box"></div></div>
                <div class="form-group"><label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label><select id="rating" required><option value="">è«‹é¸æ“‡...</option><option value="1">TCRI 1</option><option value="2">TCRI 2</option><option value="3">TCRI 3</option><option value="4">TCRI 4</option><option value="5">TCRI 5</option><option value="6">TCRI 6</option><option value="7">TCRI 7</option><option value="8">TCRI 8</option><option value="9">TCRI 9</option><option value="BBB">BBBç´š</option></select><div id="ratingInfo" class="info-box"></div></div>
            </div>
            <div class="form-section">
                <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                <div class="form-group">
                    <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                    <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                    <div class="warning-box">âš ï¸ ç†è«–åƒ¹æ ¼éš¨è‚¡åƒ¹è®Šå‹•ï¼Œå»ºè­°æ–¼ 13:30 æˆªæ¨™å‰å†é€²è¡Œæœ€çµ‚è©¦ç®—</div>
                </div>
            </div>
            <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 15px;">
                <h3 style="color: #e65100; margin-bottom: 10px;">âš–ï¸ ä¸»è§€æ¬Šé‡(é¸å¡«)</h3>
                <div class="subjective-note">
                    ğŸ’¡ é è¨­ç‚º 0 è¡¨ç¤ºå®Œå…¨ä¾æ“šæ­·å²æ•¸æ“šï¼›è‹¥æ‚¨æœ‰ç¨åˆ°è¦‹è§£ï¼Œå¯èª¿æ•´æ­¤è™•æ³¨å…¥ä¸»è§€åˆ¤æ–·ã€‚
                </div>
                <div class="form-group"><label>ä¸»è§€æ¬Šé‡ (%)</label><input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0"></div>
                <div class="form-group"><label>ä¸»è§€æœ€ä½æº¢åƒ¹ (%)</label><input type="number" id="subjectiveLowPremium" step="0.1" value="0"></div>
                <div class="form-group"><label>ä¸»è§€å¹³å‡æº¢åƒ¹ (%)</label><input type="number" id="subjectiveAvgPremium" step="0.1" value="0"></div>
            </div>
            <div class="form-section">
                <h3>ğŸ“Š è¿‘æœŸå¸‚å ´æ°›åœ</h3>
                <div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;">
                    <div class="stat-row">è«‹å…ˆé¸æ“‡ã€Œæ“”ä¿æƒ…æ³ã€</div>
                </div>
            </div>
            <div id="smartReminders" style="display:none; margin: 15px 0; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                <div style="font-weight: bold; color: #856404; font-size: 13px;">ğŸ’¡ Rexå¤§å”æé†’</div>
                <div id="reminderContent" style="font-size: 12px; line-height: 1.7; color: #856404; margin-top:5px;"></div>
            </div>
            <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
        </form>
    </div>
    
    <div class="result-panel">
        <div id="welcomeMsg" class="welcome-message">
            <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
            <p style="margin-top:10px; color:#666; font-size: 14px;">v3.52 æ¨™çš„è©•åˆ†ç‰ˆ<br>âœ… å¤šç¶­åº¦äº¤é›†åˆ†ææ‰¾å‡ºå„ªè³ªæ¢ä»¶çµ„åˆ<br>âœ… æ¨™çš„æ¢ä»¶è©•åˆ†ç³»çµ±ï¼ˆæŸ¥è©¢ä»»æ„CBï¼‰<br>âœ… æ½›åŠ›æ¨™çš„æ™ºèƒ½ç¯©é¸</p>
            <div class="stats-summary" id="statsSummary"></div>
            
            <!-- æ½›åŠ›æ¨™çš„ç¯©é¸å€å¡Š -->
            <div id="potentialScreening" class="potential-screening" style="display:none; margin-top:20px; text-align:left;"></div>
        </div>
        <div id="evaluationResult" class="evaluation-result"></div>
    </div>
</div>

<!-- ç‰ˆæ¬Šå®£å‘Šèˆ‡ç€è¦½äººæ•¸ -->
<footer class="site-footer">
    <div class="footer-content">
        <div class="visitor-count">
            ğŸ‘ï¸ ç€è¦½äººæ•¸ï¼š
            <a href="https://www.hitwebcounter.com" target="_blank">
                <img src="https://hitwebcounter.com/counter/counter.php?page=16839468&style=0006&nbdigits=6&type=page&initCount=0" 
                     title="Counter Widget" alt="Visit counter" border="0" style="vertical-align: middle;"/>
            </a>
        </div>
        <div class="copyright">
            Â© 2025 Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ ç‰ˆæ¬Šæ‰€æœ‰<br>
            <span style="font-size:11px; color:#999;">æœ¬ç³»çµ±åƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è‡ªè² ç›ˆè™§</span>
        </div>
    </div>
</footer>
```

</div>

<script>
// ==========================================
// 0. åˆå§‹åŒ–æ¬Šé‡ä¿‚æ•¸ï¼ˆé˜²æ­¢ embedded_data.js æœªè¼‰å…¥ï¼‰
// ==========================================
if (typeof window.WEIGHT_COEFFICIENTS === 'undefined') {
    window.WEIGHT_COEFFICIENTS = {
        'industry': {}, 
        'broker': {}, 
        'capital': {}, 
        'size': {}, 
        'rating': {}, 
        'guarantee': {}, 
        'years': {}, 
        'conversion': {}
    };
    console.warn('WEIGHT_COEFFICIENTS æœªå®šç¾©ï¼Œä½¿ç”¨é è¨­å€¼');
}

// ==========================================
// 1. æ¬„ä½è¨­å®š & å·¥å…·å‡½æ•¸
// ==========================================
const FIELD_ALIASES = {
    'cbId': ['CBä»£è™Ÿ', 'ä»£è™Ÿ', 'è‚¡ç¥¨ä»£è™Ÿ'], 
    'stockId': ['è‚¡ç¥¨ä»£è™Ÿ'],
    'name': ['åç¨±', 'CBåç¨±', 'å…¬å¸åç¨±'],
    'openDate': ['é–‹æ¨™æ—¥æœŸ', 'é–‹æ¨™æ—¥'],
    'industry': ['ç”¢æ¥­åˆ†é¡', 'ç”¢æ¥­åˆ¥', 'ç”¢æ¥­'], 
    'broker': ['ç™¼è¡Œåˆ¸å•†', 'æ‰¿éŠ·åˆ¸å•†', 'ä¸»è¾¦åˆ¸å•†'],
    'guarantee': ['æ“”ä¿', 'æœ‰ç„¡æ“”ä¿', 'æ“”ä¿æƒ…å½¢'], 
    'rating': ['ä¿¡è©•', 'ä¿¡ç”¨æ“”ä¿', 'TCRI'],
    'capital': ['è‚¡æœ¬', 'è‚¡æœ¬è¦æ¨¡', 'è‚¡æœ¬(å„„)'], 
    'issueSize': ['ç™¼è¡Œè¦æ¨¡', 'ç™¼è¡Œç¸½é¡'],
    'years': ['å¹´æœŸ', 'ç™¼è¡Œå¹´æœŸ'], 
    'conversionPrice': ['è½‰æ›åƒ¹', 'è½‰æ›åƒ¹æ ¼'],
    'closePrice': ['æˆªæ¨™æ”¶ç›¤', 'æˆªæ¨™æ—¥æ”¶ç›¤'],
    'theoreticalPrice': ['ç†è«–åƒ¹', 'ç†è«–åƒ¹æ ¼'],
    'floorPrice': ['åº•æ¨™åƒ¹', 'åº•æ¨™'],
    'premiumRate': ['è¨‚åƒ¹æº¢åƒ¹ç‡', 'æº¢åƒ¹ç‡'],
    'minBidPrice': ['æœ€ä½å¾—æ¨™', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼', 'æœ€ä½å¾—æ¨™åƒ¹'], 
    'lowPremium': ['æœ€ä½æº¢åƒ¹', 'æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡', 'æœ€ä½å¾—æ¨™æº¢åƒ¹', 'æœ€ä½æº¢åƒ¹(%)'],
    'avgBidPrice': ['å¹³å‡å¾—æ¨™', 'å¹³å‡å¾—æ¨™åƒ¹æ ¼', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼', 'å¹³å‡å¾—æ¨™åƒ¹'], 
    'avgPremium': ['å¹³å‡æº¢åƒ¹', 'å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡', 'å¹³å‡å¾—æ¨™æº¢åƒ¹', 'å¹³å‡æº¢åƒ¹(%)'],
    'marketHigh': ['æ›ç‰Œæœ€é«˜', 'æ›ç‰Œæœ€é«˜åƒ¹'], 
    'marketLow': ['æ›ç‰Œæœ€ä½', 'æ›ç‰Œæœ€ä½åƒ¹'],
    'qualifiedCount': ['åˆæ ¼ä»¶æ•¸', 'åˆæ ¼æ¨™å–®'],
    'bidShares': ['æŠ•æ¨™å¼µæ•¸', 'æŠ•æ¨™ç¸½å¼µæ•¸'],
    'bidMultiple': ['æŠ•æ¨™å€æ•¸'],
    'avgBidShares': ['æŠ•æ¨™å‡å¼µ', 'å¹³å‡æŠ•æ¨™å¼µæ•¸'],
    'auctionShares': ['ç«¶æ‹å¼µæ•¸', 'ç«¶æ‹ç¸½å¼µæ•¸']
};

function normalizeKeys(obj) {
    const newObj = {};
    Object.keys(obj).forEach(key => { newObj[key.trim()] = obj[key]; });
    return newObj;
}

function getSmartValue(row, fieldKey) {
    if (!FIELD_ALIASES[fieldKey]) return undefined;
    for (let name of FIELD_ALIASES[fieldKey]) {
        if (row[name] !== undefined && row[name] !== null && row[name] !== '') return row[name];
    }
    return undefined;
}

function safeFloat(val) { const num = parseFloat(val); return isNaN(num) ? 0 : num; }
function safeFixed(val, digits=2) { const num = parseFloat(val); return isNaN(num) ? '-' : num.toFixed(digits); }

function formatDate(dateVal) {
    if (!dateVal) return '-';
    if (typeof dateVal === 'number') {
        const date = new Date((dateVal - 25569) * 86400 * 1000);
        return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')}`;
    }
    if (typeof dateVal === 'string') {
        return dateVal.replace(/-/g, '/');
    }
    return dateVal;
}

function normalizePremium(premium) {
    const p = safeFloat(premium);
    if (p !== 0 && Math.abs(p) < 2) {
        return p * 100;
    }
    return p;
}

function getWeightCoefficient(category, value) {
    const weights = window.WEIGHT_COEFFICIENTS || {};
    if (!weights[category]) return 1.0;
    return weights[category][value] ? weights[category][value].coefficient : 1.0;
}

function getRangeLabel(category, val) {
    const v = parseFloat(val);
    if (isNaN(v)) return val;
    if (category === 'è‚¡æœ¬') {
        if (v < 3) return "< 3 å„„";
        if (v < 6) return "3~6 å„„";
        if (v < 10) return "6~10 å„„";
        if (v < 15) return "10~15 å„„";
        if (v < 20) return "15~20 å„„";
        return "> 20 å„„";
    }
    if (category === 'ç™¼è¡Œè¦æ¨¡') {
        if (v < 2) return "< 2 å„„";
        if (v < 5) return "2~5 å„„";
        if (v < 10) return "5~10 å„„";
        if (v < 15) return "10~15 å„„";
        if (v < 20) return "15~20 å„„";
        return "> 20 å„„";
    }
    if (category === 'è½‰æ›åƒ¹') {
        if (v < 20) return "< 20 å…ƒ";
        if (v < 50) return "20~50 å…ƒ";
        if (v < 100) return "50~100 å…ƒ";
        if (v < 150) return "100~150 å…ƒ";
        if (v < 200) return "150~200 å…ƒ";
        return "> 200 å…ƒ";
    }
    return val;
}

let statistics = { 'ç¶­åº¦çµ±è¨ˆ': { 'ç”¢æ¥­': {}, 'ç™¼è¡Œåˆ¸å•†': {} }, 'è³‡æ–™æœŸé–“': {} };
let cbDatabase = {}, auctionRawData = [], inquiryRawData = [], globalMarketStats = { low: 0, avg: 0 }, cbNameMap = {};
// v3.52 æ–°å¢ï¼šæ›ç‰Œæ—¥æœŸå°ç…§è¡¨
let listingDateMap = {};

// ==========================================
// 2. è³‡æ–™è®€å–
// ==========================================
async function loadStatistics() {
    const loadingDiv = document.getElementById('loading');
    try {
        const response = await fetch('00_CB.xlsx');
        if (!response.ok) throw new Error("æ‰¾ä¸åˆ° 00_CB.xlsx");
        const workbook = XLSX.read(await response.arrayBuffer(), { type: 'array' });
        
        const getSheetData = (keywords) => { 
            const n = workbook.SheetNames.find(x => keywords.some(k => x.includes(k)));
            if (!n) return null;
            return XLSX.utils.sheet_to_json(workbook.Sheets[n]).map(row => normalizeKeys(row));
        };

        const sheetAuction = getSheetData(['04', 'æ‰€æœ‰CBç«¶æ‹']);
        const sheetHighLow = getSheetData(['00', 'æ›ç‰Œ', 'åç¨±éæ¿¾']);
        const sheetAllCB = getSheetData(['01', 'ALLCBåŸºæœ¬']);
        
        if (!sheetAuction || sheetAuction.length === 0) throw new Error("æ‰¾ä¸åˆ°ç«¶æ‹è³‡æ–™åˆ†é ");

        // å»ºç«‹æ›ç‰Œé«˜ä½å°ç…§è¡¨
        const highLowMap = {};
        if (sheetHighLow && sheetHighLow.length > 0) {
            sheetHighLow.forEach(row => {
                let id = row['ä»£è™Ÿ'] || row['CBä»£è™Ÿ'] || row['è‚¡ç¥¨ä»£è™Ÿ'];
                if(id) highLowMap[String(id).replace('.0','').trim()] = row;
            });
        }
        
        // è®€å–è©¢åœˆè³‡æ–™ (å¾01å·¥ä½œè¡¨)
        if (sheetAllCB && sheetAllCB.length > 0) {
            // v3.52: å…ˆå»ºç«‹æ›ç‰Œæ—¥æœŸå°ç…§è¡¨
            sheetAllCB.forEach(row => {
                let rawId = row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'];
                if (rawId) {
                    const id = String(rawId).replace('.0','').trim();
                    const listingDate = row['æ›ç‰Œæ—¥æœŸ'];
                    if (listingDate) {
                        listingDateMap[id] = listingDate;
                    }
                }
            });
            console.log(`è¼‰å…¥æ›ç‰Œæ—¥æœŸ: ${Object.keys(listingDateMap).length} ç­†`);
            
            inquiryRawData = sheetAllCB.filter(row => {
                const type = row['è©¢åœˆç«¶æ‹'] || '';
                return type.includes('è©¢åœˆ');
            }).map(row => {
                let rawId = row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'];
                if (!rawId) return null;
                const id = String(rawId).replace('.0','').trim();
                const hlRow = highLowMap[id] || {};
                
                // è™•ç†ä¿¡è©•æ ¼å¼ï¼šTCRI1 -> 1, TCRI5 -> 5
                let rawRating = row['ä¿¡ç”¨æ“”ä¿'] || '';
                let normalizedRating = '';
                if (rawRating) {
                    const match = rawRating.match(/TCRI(\d+)/i);
                    if (match) {
                        normalizedRating = match[1]; // æå–æ•¸å­—éƒ¨åˆ†
                    } else if (rawRating.includes('BBB')) {
                        normalizedRating = 'BBB';
                    }
                }
                
                // v3.52: è™•ç†æ›ç‰Œæ—¥æœŸå’Œç¾åƒ¹
                const listingDate = row['æ›ç‰Œæ—¥æœŸ'];
                let listingYear = null;
                if (listingDate) {
                    if (typeof listingDate === 'number') {
                        const d = new Date((listingDate - 25569) * 86400 * 1000);
                        listingYear = d.getFullYear();
                    } else if (typeof listingDate === 'string') {
                        const match = listingDate.match(/(\d{4})/);
                        if (match) listingYear = parseInt(match[1]);
                    } else if (listingDate instanceof Date) {
                        listingYear = listingDate.getFullYear();
                    }
                }
                
                return {
                    'id': id,
                    'name': row['åç¨±'] || '',
                    'industry': row['ç”¢æ¥­åˆ†é¡'] || '',
                    'broker': row['æ‰¿éŠ·åˆ¸å•†'] || '',
                    'guarantee': row['æœ‰ç„¡æ“”ä¿'] || '',
                    'rating': normalizedRating,
                    'capital': safeFloat(row['è‚¡æœ¬è¦æ¨¡']),
                    'issueSize': safeFloat(row['ç™¼è¡Œè¦æ¨¡']),
                    'years': safeFloat(row['ç™¼è¡Œå¹´æœŸ']),
                    'conversionPrice': safeFloat(row['è½‰æ›åƒ¹æ ¼']),
                    'marketHigh': safeFloat(getSmartValue(hlRow, 'marketHigh')) || safeFloat(row['æ›ç‰Œæœ€é«˜']),
                    'marketLow': safeFloat(getSmartValue(hlRow, 'marketLow')) || safeFloat(row['æ›ç‰Œæœ€ä½']),
                    'premiumRate': safeFloat(row['è¨‚åƒ¹æº¢åƒ¹ç‡']),
                    'type': 'è©¢åœˆ',
                    // v3.52 æ–°å¢
                    'listingDate': listingDate,
                    'listingYear': listingYear
                };
            }).filter(item => item !== null);
            
            console.log(`è¼‰å…¥è©¢åœˆè³‡æ–™: ${inquiryRawData.length} ç­†`);
        }

        auctionRawData = sheetAuction.map(row => {
            let rawId = row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ']; 
            if (!rawId) return null;
            
            const id = String(rawId).replace('.0','').trim();
            const hlRow = highLowMap[id] || {}; 
            
            // è™•ç†ä¿¡è©•æ ¼å¼ï¼šçµ±ä¸€è½‰ç‚ºæ•¸å­—æ ¼å¼
            let rawRating = getSmartValue(row, 'rating') || '';
            let normalizedRating = '';
            if (rawRating) {
                rawRating = String(rawRating).trim();
                const match = rawRating.match(/TCRI(\d+)/i);
                if (match) {
                    normalizedRating = match[1];
                } else if (rawRating.match(/^\d+$/)) {
                    normalizedRating = rawRating; // å·²ç¶“æ˜¯æ•¸å­—
                } else if (rawRating.toUpperCase().includes('BBB')) {
                    normalizedRating = 'BBB';
                } else {
                    normalizedRating = rawRating;
                }
            }

            return {
                'id': id, 
                'stockId': getSmartValue(row, 'stockId'),
                'name': getSmartValue(row, 'name'), 
                'openDate': getSmartValue(row, 'openDate'),
                'industry': getSmartValue(row, 'industry'), 
                'broker': getSmartValue(row, 'broker'),
                'guarantee': getSmartValue(row, 'guarantee'), 
                'rating': normalizedRating,
                'capital': safeFloat(getSmartValue(row, 'capital')), 
                'issueSize': safeFloat(getSmartValue(row, 'issueSize')), 
                'years': safeFloat(getSmartValue(row, 'years')),
                'conversionPrice': safeFloat(getSmartValue(row, 'conversionPrice')),
                'closePrice': safeFloat(getSmartValue(row, 'closePrice')),
                'theoreticalPrice': safeFloat(getSmartValue(row, 'theoreticalPrice')),
                'floorPrice': safeFloat(getSmartValue(row, 'floorPrice')),
                'premiumRate': getSmartValue(row, 'premiumRate'),
                'minBidPrice': safeFloat(getSmartValue(row, 'minBidPrice')), 
                'avgBidPrice': safeFloat(getSmartValue(row, 'avgBidPrice')),
                'lowPremium': normalizePremium(getSmartValue(row, 'lowPremium')), 
                'avgPremium': normalizePremium(getSmartValue(row, 'avgPremium')),
                'marketHigh': safeFloat(getSmartValue(hlRow, 'marketHigh')) || safeFloat(getSmartValue(row, 'marketHigh')), 
                'marketLow': safeFloat(getSmartValue(hlRow, 'marketLow')) || safeFloat(getSmartValue(row, 'marketLow')),
                'qualifiedCount': safeFloat(getSmartValue(row, 'qualifiedCount')),
                'bidShares': safeFloat(getSmartValue(row, 'bidShares')),
                'bidMultiple': safeFloat(getSmartValue(row, 'bidMultiple')),
                'avgBidShares': safeFloat(getSmartValue(row, 'avgBidShares')),
                'auctionShares': safeFloat(getSmartValue(row, 'auctionShares')),
                // v3.52 æ–°å¢ï¼šæ›ç‰Œæ—¥æœŸå’Œå¹´åº¦
                'listingDate': listingDateMap[id],
                'listingYear': getListingYear(listingDateMap[id])
            };
        }).filter(item => item !== null);

        auctionRawData.forEach(item => { 
            if (item.name) { 
                cbDatabase[item.name] = item; 
                cbNameMap[item.name] = item; 
            } 
        });
        
        // v3.52: è®€å–09å·¥ä½œè¡¨ï¼ˆç›®å‰æ›ç‰Œæ¨™çš„ï¼‰
        const sheet09 = getSheetData(['09']);
        if (sheet09 && sheet09.length > 0) {
            window.currentListingData = sheet09;  // ç›´æ¥å­˜åŸå§‹è³‡æ–™åˆ°å…¨å±€è®Šæ•¸
            console.log(`è¼‰å…¥ç›®å‰æ›ç‰Œæ¨™çš„: ${sheet09.length} ç­†`);
        }
        
        // v3.52: è®€å–06å·¥ä½œè¡¨ï¼ˆæ­£åœ¨ç™¼è¡Œæ¨™çš„ï¼‰
        const sheet06 = getSheetData(['06']);
        if (sheet06 && sheet06.length > 0) {
            window.issuingData = sheet06;  // å­˜åˆ°å…¨å±€è®Šæ•¸
            console.log(`è¼‰å…¥æ­£åœ¨ç™¼è¡Œæ¨™çš„: ${sheet06.length} ç­†`);
        }
        
        // å„²å­˜01å·¥ä½œè¡¨ä¾›æŸ¥è©¢ä½¿ç”¨
        window.allCBData = sheetAllCB || [];
        
        // å„²å­˜04å·¥ä½œè¡¨ä¾›æŸ¥è©¢ä½¿ç”¨
        window.auctionData = sheetAuction || [];
        
        autoGenerateStatistics(); 
        calculateGlobalMarketStats(); 
        initializeUI();
        
        loadingDiv.style.display = 'none'; 
        document.querySelector('.container').style.display = 'block';
    } catch (error) { 
        console.error(error); 
        loadingDiv.innerHTML = `<div style="padding:20px;background:white;color:#D32F2F;border-radius:10px;text-align:center;max-width:400px;">
        <h3>âš ï¸ ç³»çµ±å•Ÿå‹•å¤±æ•—</h3><p style="margin:10px 0;">${error.message}</p>
        <button onclick="location.reload()" style="padding:8px 20px;cursor:pointer;">é‡è©¦</button></div>`; 
    }
}

// v3.52: æå–æ›ç‰Œå¹´ä»½çš„è¼”åŠ©å‡½æ•¸
function getListingYear(listingDate) {
    if (!listingDate) return null;
    if (typeof listingDate === 'number') {
        const d = new Date((listingDate - 25569) * 86400 * 1000);
        return d.getFullYear();
    } else if (typeof listingDate === 'string') {
        const match = listingDate.match(/(\d{4})/);
        if (match) return parseInt(match[1]);
    } else if (listingDate instanceof Date) {
        return listingDate.getFullYear();
    }
    return null;
}

// v3.52: æ½›åŠ›æ¨™çš„ç¯©é¸åˆ†æ

// ==========================================
// 3. çµ±è¨ˆæ ¸å¿ƒ
// ==========================================
function autoGenerateStatistics() {
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­'] = {}; 
    statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†'] = {};
    auctionRawData.forEach(row => {
        if (row.industry) updateStatCategory('ç”¢æ¥­', row.industry, row);
        if (row.broker) updateStatCategory('ç™¼è¡Œåˆ¸å•†', row.broker, row);
    });

    ['ç”¢æ¥­', 'ç™¼è¡Œåˆ¸å•†'].forEach(cat => {
        Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ'][cat]).forEach(key => {
            const item = statistics['ç¶­åº¦çµ±è¨ˆ'][cat][key];
            if (item.count > 0) {
                item['å¹³å‡æœ€ä½æº¢åƒ¹'] = item.sumLowPrem / item.count;
                item['å¹³å‡æº¢åƒ¹'] = item.sumAvgPrem / item.count;
                item['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'] = item.sumLowPrice / item.count;
                item['å¹³å‡å¾—æ¨™åƒ¹'] = item.sumAvgPrice / item.count;
                item['å¹³å‡æ›ç‰Œæœ€é«˜'] = item.countMarket > 0 ? item.sumHigh / item.countMarket : 0;
                item['å¹³å‡æ›ç‰Œæœ€ä½'] = item.countMarket > 0 ? item.sumLow / item.countMarket : 0;
                item['æ¨£æœ¬æ•¸'] = item.count;
            }
        });
    });
}

function updateStatCategory(category, key, row) {
    if (!statistics['ç¶­åº¦çµ±è¨ˆ'][category][key]) {
        statistics['ç¶­åº¦çµ±è¨ˆ'][category][key] = { count: 0, sumLowPrem: 0, sumAvgPrem: 0, sumLowPrice: 0, sumAvgPrice: 0, sumHigh: 0, sumLow: 0, countMarket: 0 };
    }
    const obj = statistics['ç¶­åº¦çµ±è¨ˆ'][category][key];
    if (row.minBidPrice > 0 || row.avgBidPrice > 0) {
        obj.count++; 
        obj.sumLowPrem += row.lowPremium; 
        obj.sumAvgPrem += row.avgPremium;
        obj.sumLowPrice += row.minBidPrice; 
        obj.sumAvgPrice += row.avgBidPrice;
    }
    if (row.marketHigh > 0 && row.marketLow > 0) {
        obj.sumHigh += row.marketHigh; 
        obj.sumLow += row.marketLow;
        obj.countMarket++;
    }
}

function calculateGlobalMarketStats() {
    let sumLow = 0, sumAvg = 0, count = 0;
    auctionRawData.forEach(d => { 
        if (d.minBidPrice > 0) { 
            sumLow += d.lowPremium; 
            sumAvg += d.avgPremium; 
            count++; 
        } 
    });
    if (count > 0) { 
        globalMarketStats.low = sumLow / count; 
        globalMarketStats.avg = sumAvg / count; 
    }
}

// v3.51 ä¿®æ”¹ï¼šå¢åŠ æ’é™¤å‰ä¸‰é«˜çš„çµ±è¨ˆ + æ“”ä¿é¡å‹ç´°åˆ†çµ±è¨ˆ
function getStatsSmart(category, val) {
    let stats = { 
        low: 0, 
        avg: 0, 
        usedFallback: false, 
        rawData: null, 
        inquiryData: null,
        excludeTop3Data: null,
        excludeTop3InquiryData: null,
        // v3.51 æ–°å¢ï¼šä¾æ“”ä¿é¡å‹ç´°åˆ†
        guaranteedAuctionData: null,
        guaranteedInquiryData: null,
        unguaranteedAuctionData: null,
        unguaranteedInquiryData: null
    };
    let filterFn = null;
    const v = parseFloat(val);
    let rangeLabel = "";

    if (category === 'è‚¡æœ¬') {
        if (v < 3) { rangeLabel = "< 3 å„„"; filterFn = d => d.capital < 3; }
        else if (v < 6) { rangeLabel = "3~6 å„„"; filterFn = d => d.capital >= 3 && d.capital < 6; }
        else if (v < 10) { rangeLabel = "6~10 å„„"; filterFn = d => d.capital >= 6 && d.capital < 10; }
        else if (v < 15) { rangeLabel = "10~15 å„„"; filterFn = d => d.capital >= 10 && d.capital < 15; }
        else if (v < 20) { rangeLabel = "15~20 å„„"; filterFn = d => d.capital >= 15 && d.capital < 20; }
        else { rangeLabel = "> 20 å„„"; filterFn = d => d.capital >= 20; }
    }
    else if (category === 'ç™¼è¡Œè¦æ¨¡') {
        if (v < 2) { rangeLabel = "< 2 å„„"; filterFn = d => d.issueSize < 2; }
        else if (v < 5) { rangeLabel = "2~5 å„„"; filterFn = d => d.issueSize >= 2 && d.issueSize < 5; }
        else if (v < 10) { rangeLabel = "5~10 å„„"; filterFn = d => d.issueSize >= 5 && d.issueSize < 10; }
        else if (v < 15) { rangeLabel = "10~15 å„„"; filterFn = d => d.issueSize >= 10 && d.issueSize < 15; }
        else if (v < 20) { rangeLabel = "15~20 å„„"; filterFn = d => d.issueSize >= 15 && d.issueSize < 20; }
        else { rangeLabel = "> 20 å„„"; filterFn = d => d.issueSize >= 20; }
    }
    else if (category === 'è½‰æ›åƒ¹') {
        if (v < 20) { rangeLabel = "< 20 å…ƒ"; filterFn = d => d.conversionPrice < 20; }
        else if (v < 50) { rangeLabel = "20~50 å…ƒ"; filterFn = d => d.conversionPrice >= 20 && d.conversionPrice < 50; }
        else if (v < 100) { rangeLabel = "50~100 å…ƒ"; filterFn = d => d.conversionPrice >= 50 && d.conversionPrice < 100; }
        else if (v < 150) { rangeLabel = "100~150 å…ƒ"; filterFn = d => d.conversionPrice >= 100 && d.conversionPrice < 150; }
        else if (v < 200) { rangeLabel = "150~200 å…ƒ"; filterFn = d => d.conversionPrice >= 150 && d.conversionPrice < 200; }
        else { rangeLabel = "> 200 å…ƒ"; filterFn = d => d.conversionPrice >= 200; }
    }
    else {
        const safeVal = String(val || ""); 
        if (safeVal === "") return stats;
        
        if (category === 'ç™¼è¡Œåˆ¸å•†') filterFn = d => (d.broker || '').includes(safeVal) || safeVal.includes(d.broker || '');
        else if (category === 'ç”¢æ¥­') filterFn = d => d.industry === safeVal;
        else if (category === 'æ“”ä¿') filterFn = d => (d.guarantee || '').includes(safeVal);
        else if (category === 'å¹´æœŸ') filterFn = d => d.years == safeVal;
        else if (category === 'ä¿¡è©•') {
            // ä¿¡è©•æ¯”å°ï¼šç”¨æˆ¶é¸ "5" è¦èƒ½æ¯”å°åˆ° rating ç‚º "5" æˆ– "TCRI5" çš„è³‡æ–™
            filterFn = d => {
                const rating = (d.rating || '').toString().trim();
                if (!rating) return false;
                // ç²¾ç¢ºæ¯”å°æ•¸å­—
                if (rating === safeVal) return true;
                // æ¯”å° TCRI æ ¼å¼
                if (rating.toUpperCase() === 'TCRI' + safeVal) return true;
                // BBB ç‰¹æ®Šè™•ç†
                if (safeVal === 'BBB' && rating.toUpperCase().includes('BBB')) return true;
                return false;
            };
        }
    }

    if (filterFn) {
        // === ç«¶æ‹æ•¸æ“šçµ±è¨ˆï¼ˆå…¨éƒ¨ï¼‰===
        const auctionFiltered = auctionRawData.filter(filterFn);
        let sumLowP = 0, sumAvgP = 0, sumLowPr = 0, sumAvgPr = 0, sumH = 0, sumL = 0, countM = 0, count = 0;
        
        auctionFiltered.forEach(d => {
            if (d.minBidPrice > 0 || d.avgBidPrice > 0) { 
                sumLowP += d.lowPremium; sumAvgP += d.avgPremium; 
                sumLowPr += d.minBidPrice; sumAvgPr += d.avgBidPrice; 
                count++; 
            }
            if (d.marketHigh > 0 && d.marketLow > 0) { 
                sumH += d.marketHigh; sumL += d.marketLow; countM++; 
            }
        });

        if (count > 0) {
            stats.rawData = { 
                'å¹³å‡æœ€ä½æº¢åƒ¹': sumLowP / count, 
                'å¹³å‡æº¢åƒ¹': sumAvgP / count, 
                'å¹³å‡æœ€ä½å¾—æ¨™åƒ¹': sumLowPr / count, 
                'å¹³å‡å¾—æ¨™åƒ¹': sumAvgPr / count,
                'å¹³å‡æ›ç‰Œæœ€é«˜': countM > 0 ? sumH / countM : 0, 
                'å¹³å‡æ›ç‰Œæœ€ä½': countM > 0 ? sumL / countM : 0, 
                'æ¨£æœ¬æ•¸': count 
            };
            if(rangeLabel) stats.rawData['å€é–“åç¨±'] = rangeLabel; 
            stats.low = stats.rawData['å¹³å‡æœ€ä½æº¢åƒ¹']; 
            stats.avg = stats.rawData['å¹³å‡æº¢åƒ¹'];
        }
        
        // === v3.51 æ–°å¢ï¼šç«¶æ‹æ’é™¤å‰ä¸‰é«˜çš„è¨ˆç®— ===
        const auctionWithMarket = auctionFiltered.filter(d => d.marketHigh > 0 && d.marketLow > 0);
        if (auctionWithMarket.length > 3) {
            // æŒ‰æ›ç‰Œæœ€é«˜æ’åºï¼Œæ’é™¤å‰ä¸‰å
            const sortedAuction = [...auctionWithMarket].sort((a, b) => b.marketHigh - a.marketHigh);
            const excludedAuction = sortedAuction.slice(3);
            
            let exSumH = 0, exSumL = 0;
            excludedAuction.forEach(d => {
                exSumH += d.marketHigh;
                exSumL += d.marketLow;
            });
            
            stats.excludeTop3Data = {
                'å¹³å‡æ›ç‰Œæœ€é«˜': exSumH / excludedAuction.length,
                'å¹³å‡æ›ç‰Œæœ€ä½': exSumL / excludedAuction.length,
                'æ¨£æœ¬æ•¸': excludedAuction.length
            };
        }
        
        // === è©¢åœˆæ•¸æ“šçµ±è¨ˆï¼ˆå…¨éƒ¨ï¼‰===
        const inquiryFiltered = inquiryRawData.filter(filterFn);
        let iSumH = 0, iSumL = 0, iCountM = 0;
        
        inquiryFiltered.forEach(d => {
            if (d.marketHigh > 0 && d.marketLow > 0) { 
                iSumH += d.marketHigh; iSumL += d.marketLow; iCountM++; 
            }
        });
        
        if (iCountM > 0) {
            stats.inquiryData = {
                'å¹³å‡æ›ç‰Œæœ€é«˜': iSumH / iCountM,
                'å¹³å‡æ›ç‰Œæœ€ä½': iSumL / iCountM,
                'æ¨£æœ¬æ•¸': iCountM
            };
        }
        
        // === v3.51 æ–°å¢ï¼šè©¢åœˆæ’é™¤å‰ä¸‰é«˜çš„è¨ˆç®— ===
        const inquiryWithMarket = inquiryFiltered.filter(d => d.marketHigh > 0 && d.marketLow > 0);
        if (inquiryWithMarket.length > 3) {
            const sortedInquiry = [...inquiryWithMarket].sort((a, b) => b.marketHigh - a.marketHigh);
            const excludedInquiry = sortedInquiry.slice(3);
            
            let exISumH = 0, exISumL = 0;
            excludedInquiry.forEach(d => {
                exISumH += d.marketHigh;
                exISumL += d.marketLow;
            });
            
            stats.excludeTop3InquiryData = {
                'å¹³å‡æ›ç‰Œæœ€é«˜': exISumH / excludedInquiry.length,
                'å¹³å‡æ›ç‰Œæœ€ä½': exISumL / excludedInquiry.length,
                'æ¨£æœ¬æ•¸': excludedInquiry.length
            };
        }
        
        // === v3.51 æ–°å¢ï¼šä¾æ“”ä¿é¡å‹ç´°åˆ†çµ±è¨ˆ ===
        // æœ‰æ“”ä¿ - ç«¶æ‹
        const guaranteedAuction = auctionFiltered.filter(d => (d.guarantee || '').includes('æœ‰'));
        if (guaranteedAuction.length > 0) {
            let gaSumH = 0, gaSumL = 0, gaCountM = 0;
            guaranteedAuction.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    gaSumH += d.marketHigh;
                    gaSumL += d.marketLow;
                    gaCountM++;
                }
            });
            if (gaCountM > 0) {
                stats.guaranteedAuctionData = {
                    'å¹³å‡æ›ç‰Œæœ€é«˜': gaSumH / gaCountM,
                    'å¹³å‡æ›ç‰Œæœ€ä½': gaSumL / gaCountM,
                    'æ¨£æœ¬æ•¸': gaCountM
                };
            }
        }
        
        // æœ‰æ“”ä¿ - è©¢åœˆ
        const guaranteedInquiry = inquiryFiltered.filter(d => (d.guarantee || '').includes('æœ‰'));
        if (guaranteedInquiry.length > 0) {
            let giSumH = 0, giSumL = 0, giCountM = 0;
            guaranteedInquiry.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    giSumH += d.marketHigh;
                    giSumL += d.marketLow;
                    giCountM++;
                }
            });
            if (giCountM > 0) {
                stats.guaranteedInquiryData = {
                    'å¹³å‡æ›ç‰Œæœ€é«˜': giSumH / giCountM,
                    'å¹³å‡æ›ç‰Œæœ€ä½': giSumL / giCountM,
                    'æ¨£æœ¬æ•¸': giCountM
                };
            }
        }
        
        // ç„¡æ“”ä¿ - ç«¶æ‹
        const unguaranteedAuction = auctionFiltered.filter(d => (d.guarantee || '').includes('ç„¡'));
        if (unguaranteedAuction.length > 0) {
            let uaSumH = 0, uaSumL = 0, uaCountM = 0;
            unguaranteedAuction.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    uaSumH += d.marketHigh;
                    uaSumL += d.marketLow;
                    uaCountM++;
                }
            });
            if (uaCountM > 0) {
                stats.unguaranteedAuctionData = {
                    'å¹³å‡æ›ç‰Œæœ€é«˜': uaSumH / uaCountM,
                    'å¹³å‡æ›ç‰Œæœ€ä½': uaSumL / uaCountM,
                    'æ¨£æœ¬æ•¸': uaCountM
                };
            }
        }
        
        // ç„¡æ“”ä¿ - è©¢åœˆ
        const unguaranteedInquiry = inquiryFiltered.filter(d => (d.guarantee || '').includes('ç„¡'));
        if (unguaranteedInquiry.length > 0) {
            let uiSumH = 0, uiSumL = 0, uiCountM = 0;
            unguaranteedInquiry.forEach(d => {
                if (d.marketHigh > 0 && d.marketLow > 0) {
                    uiSumH += d.marketHigh;
                    uiSumL += d.marketLow;
                    uiCountM++;
                }
            });
            if (uiCountM > 0) {
                stats.unguaranteedInquiryData = {
                    'å¹³å‡æ›ç‰Œæœ€é«˜': uiSumH / uiCountM,
                    'å¹³å‡æ›ç‰Œæœ€ä½': uiSumL / uiCountM,
                    'æ¨£æœ¬æ•¸': uiCountM
                };
            }
        }
    }
    
    if (stats.low === 0 && (!stats.rawData || stats.rawData['å¹³å‡å¾—æ¨™åƒ¹'] === 0)) { 
        if (statistics['ç¶­åº¦çµ±è¨ˆ'][category] && statistics['ç¶­åº¦çµ±è¨ˆ'][category][val]) {
            stats.rawData = statistics['ç¶­åº¦çµ±è¨ˆ'][category][val]; 
            stats.low = safeFloat(stats.rawData['å¹³å‡æœ€ä½æº¢åƒ¹']); 
            stats.avg = safeFloat(stats.rawData['å¹³å‡æº¢åƒ¹']);
        } 
        
        if (stats.low === 0 || isNaN(stats.low)) {
            stats.low = globalMarketStats.low; 
            stats.avg = globalMarketStats.avg; 
            stats.usedFallback = true; 
            if(!stats.rawData) stats.rawData = { 'å¹³å‡æœ€ä½æº¢åƒ¹': stats.low, 'å¹³å‡æº¢åƒ¹': stats.avg, 'æ¨£æœ¬æ•¸': 'å…¨å¸‚å ´' };
        }
    }
    return stats;
}

// ==========================================
// 4. UI é¡¯ç¤º
// ==========================================

// v3.51 å¼·åŒ–ç‰ˆï¼šæ­·å²æœå°‹å¡ç‰‡ç”Ÿæˆ
function generateHistoryCard(d) {
    const h = safeFloat(d.marketHigh);
    const l = safeFloat(d.marketLow);
    const amp = (h > 0 && l > 0) ? ((h - l) / l * 100).toFixed(1) : '-';
    
    const premium = safeFloat(d.premiumRate);
    const premiumStr = premium > 0 ? (premium < 2 ? (premium * 100).toFixed(1) : premium.toFixed(1)) : '-';
    
    let guarantee = d.guarantee || '-';
    if (guarantee.includes('æœ‰')) guarantee = 'æœ‰';
    else if (guarantee.includes('ç„¡')) guarantee = 'ç„¡';
    
    return `
    <div class="history-card">
        <div class="hc-header">
            <span class="hc-badge">ç«¶æ‹</span>
            <span class="hc-name">${d.name || '-'} (${d.id})</span>
            <span class="hc-date">${formatDate(d.openDate)}</span>
        </div>
        
        <div class="hc-line">
            <span class="hc-info">ç”¢æ¥­:<b>${d.industry || '-'}</b></span>
            <span class="hc-info">è¦æ¨¡:<b>${d.issueSize > 0 ? d.issueSize + 'å„„' : '-'}</b></span>
            <span class="hc-info">å¹´æœŸ:<b>${d.years > 0 ? d.years + 'å¹´' : '-'}</b></span>
            <span class="hc-info">æ“”ä¿:<b>${guarantee}</b></span>
            <span class="hc-info">ä¿¡è©•:<b>${d.rating || '-'}</b></span>
            <span class="hc-info">åˆ¸å•†:<b>${d.broker || '-'}</b></span>
            <span class="hc-info">åº•æ¨™:<b>${d.floorPrice > 0 ? safeFixed(d.floorPrice,2) : '-'}</b></span>
            <span class="hc-info">æº¢åƒ¹ç‡:<b class="pink">${premiumStr}%</b></span>
        </div>
        
        <div class="hc-line">
            <span class="hc-info">è½‰æ›åƒ¹:<b>${d.conversionPrice > 0 ? safeFixed(d.conversionPrice,1) : '-'}</b></span>
            <span class="hc-info">æˆªæ¨™æ”¶ç›¤:<b>${d.closePrice > 0 ? safeFixed(d.closePrice,1) : '-'}</b></span>
            <span class="hc-info">ç†è«–åƒ¹:<b style="color:#1565c0">${d.theoreticalPrice > 0 ? safeFixed(d.theoreticalPrice,2) : '-'}</b></span>
            <span class="hc-info">ç«¶æ‹å¼µæ•¸:<b>${d.auctionShares > 0 ? d.auctionShares.toLocaleString() : '-'}</b></span>
            <span class="hc-info">æŠ•æ¨™å¼µæ•¸:<b>${d.bidShares > 0 ? d.bidShares.toLocaleString() : '-'}</b></span>
            <span class="hc-info">æŠ•æ¨™å€æ•¸:<b style="color:#d32f2f">${d.bidMultiple > 0 ? safeFixed(d.bidMultiple, 2) + 'x' : '-'}</b></span>
        </div>
        
        <table class="hc-table">
            <tr>
                <th></th><th>å¾—æ¨™åƒ¹</th><th>æº¢åƒ¹ç‡</th><th></th><th>æ›ç‰Œåƒ¹</th><th>æŒ¯å¹…</th>
            </tr>
            <tr>
                <td class="td-label">æœ€ä½</td>
                <td>${d.minBidPrice > 0 ? safeFixed(d.minBidPrice, 2) : '-'}</td>
                <td class="val-red">${d.lowPremium !== 0 ? safeFixed(d.lowPremium, 2) + '%' : '-'}</td>
                <td class="td-label">é«˜</td>
                <td>${h > 0 ? safeFixed(h, 1) : '-'}</td>
                <td class="val-pink" rowspan="2">${amp}%</td>
            </tr>
            <tr>
                <td class="td-label">å¹³å‡</td>
                <td>${d.avgBidPrice > 0 ? safeFixed(d.avgBidPrice, 2) : '-'}</td>
                <td class="val-red">${d.avgPremium !== 0 ? safeFixed(d.avgPremium, 2) + '%' : '-'}</td>
                <td class="td-label">ä½</td>
                <td>${l > 0 ? safeFixed(l, 1) : '-'}</td>
            </tr>
        </table>
    </div>
    `;
}

// v3.51 ä¿®æ”¹ï¼šgenerateStandardCard å¢åŠ æ’é™¤å‰ä¸‰çš„åƒæ•¸ï¼Œç¨ç«‹æˆå…©å€‹è¡¨æ ¼ï¼Œä¸¦åŠ å…¥æ“”ä¿é¡å‹ç´°åˆ†
function generateStandardCard(data, titleOverride=null, inquiryData=null, excludeTop3Data=null, excludeTop3InquiryData=null, guaranteedAuctionData=null, guaranteedInquiryData=null, unguaranteedAuctionData=null, unguaranteedInquiryData=null) {
    if (!data) return `<div class="stat-row" style="color:#999;">æŸ¥ç„¡è³‡æ–™</div>`;
    
    const valStr = (v, s='') => (v!==undefined && v!==null && v!=='' && v!==0) ? `${safeFixed(v,2)}${s}` : '-';
    const title = data['å€é–“åç¨±'] ? `å€é–“çµ±è¨ˆ: ${data['å€é–“åç¨±']}` : (titleOverride || 'æ­·å²çµ±è¨ˆ');

    // è¨ˆç®—ç«¶æ‹æŒ¯å¹…
    const aH = safeFloat(data['å¹³å‡æ›ç‰Œæœ€é«˜']);
    const aL = safeFloat(data['å¹³å‡æ›ç‰Œæœ€ä½']);
    const aAmp = (aH > 0 && aL > 0) ? ((aH - aL) / aL * 100).toFixed(1) : '-';
    
    // è¨ˆç®—è©¢åœˆæŒ¯å¹…
    let iH = 0, iL = 0, iAmp = '-', iCount = 0;
    if (inquiryData) {
        iH = safeFloat(inquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']);
        iL = safeFloat(inquiryData['å¹³å‡æ›ç‰Œæœ€ä½']);
        iAmp = (iH > 0 && iL > 0) ? ((iH - iL) / iL * 100).toFixed(1) : '-';
        iCount = inquiryData['æ¨£æœ¬æ•¸'] || 0;
    }
    
    // v3.51ï¼šè¨ˆç®—æ’é™¤å‰ä¸‰çš„ç«¶æ‹æŒ¯å¹…
    let exAH = 0, exAL = 0, exAAmp = '-', exACount = 0;
    if (excludeTop3Data) {
        exAH = safeFloat(excludeTop3Data['å¹³å‡æ›ç‰Œæœ€é«˜']);
        exAL = safeFloat(excludeTop3Data['å¹³å‡æ›ç‰Œæœ€ä½']);
        exAAmp = (exAH > 0 && exAL > 0) ? ((exAH - exAL) / exAL * 100).toFixed(1) : '-';
        exACount = excludeTop3Data['æ¨£æœ¬æ•¸'] || 0;
    }
    
    // v3.51ï¼šè¨ˆç®—æ’é™¤å‰ä¸‰çš„è©¢åœˆæŒ¯å¹…
    let exIH = 0, exIL = 0, exIAmp = '-', exICount = 0;
    if (excludeTop3InquiryData) {
        exIH = safeFloat(excludeTop3InquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']);
        exIL = safeFloat(excludeTop3InquiryData['å¹³å‡æ›ç‰Œæœ€ä½']);
        exIAmp = (exIH > 0 && exIL > 0) ? ((exIH - exIL) / exIL * 100).toFixed(1) : '-';
        exICount = excludeTop3InquiryData['æ¨£æœ¬æ•¸'] || 0;
    }
    
    // è¨ˆç®—åˆè¨ˆï¼ˆå®Œæ•´æ•¸æ“šï¼‰
    const aCount = data['æ¨£æœ¬æ•¸'] || 0;
    const totalCount = (typeof aCount === 'number' ? aCount : 0) + (typeof iCount === 'number' ? iCount : 0);
    
    let tH = 0, tL = 0, tAmp = '-';
    if (aH > 0 && iH > 0) {
        tH = ((aH * aCount) + (iH * iCount)) / totalCount;
        tL = ((aL * aCount) + (iL * iCount)) / totalCount;
    } else if (aH > 0) {
        tH = aH; tL = aL;
    } else if (iH > 0) {
        tH = iH; tL = iL;
    }
    if (tH > 0 && tL > 0) tAmp = ((tH - tL) / tL * 100).toFixed(1);
    
    // è¨ˆç®—æ’é™¤å‰ä¸‰çš„åˆè¨ˆ
    const exTotalCount = exACount + exICount;
    let exTH = 0, exTL = 0, exTAmp = '-';
    if (exAH > 0 && exIH > 0) {
        exTH = ((exAH * exACount) + (exIH * exICount)) / exTotalCount;
        exTL = ((exAL * exACount) + (exIL * exICount)) / exTotalCount;
    } else if (exAH > 0) {
        exTH = exAH; exTL = exAL;
    } else if (exIH > 0) {
        exTH = exIH; exTL = exIL;
    }
    if (exTH > 0 && exTL > 0) exTAmp = ((exTH - exTL) / exTL * 100).toFixed(1);

    let html = `<div class="stats-header">ğŸ“Š ${title}</div>`;
    
    // ç«¶æ‹å¾—æ¨™æ•¸æ“š
    if (data['æ¨£æœ¬æ•¸']) {
        html += `<div style="background:#f1f8e9; padding:8px; border-radius:5px; margin:8px 0;">
        <div style="font-weight:bold; color:#2e7d32; font-size:12px; margin-bottom:5px;">ğŸ¯ ç«¶æ‹ (${data['æ¨£æœ¬æ•¸']}æª”)</div>
        <div class="stat-row"><span class="stat-label">æœ€ä½å¾—æ¨™:</span><span class="stat-value">${valStr(data['å¹³å‡æœ€ä½å¾—æ¨™åƒ¹'])}å…ƒ / æº¢${valStr(data['å¹³å‡æœ€ä½æº¢åƒ¹'],'%')}</span></div>
        <div class="stat-row"><span class="stat-label">å¹³å‡å¾—æ¨™:</span><span class="stat-value">${valStr(data['å¹³å‡å¾—æ¨™åƒ¹'])}å…ƒ / æº¢${valStr(data['å¹³å‡æº¢åƒ¹'],'%')}</span></div>
        </div>`;
    }
    
    // === ç¬¬ä¸€å€‹è¡¨æ ¼ï¼šå®Œæ•´æ•¸æ“š ===
    const hasAuction = aH > 0 || aL > 0;
    const hasInquiry = iH > 0 || iL > 0;
    
    if (hasAuction || hasInquiry) {
        html += `<div style="font-size:11px; color:#2e7d32; font-weight:bold; margin:8px 0 4px 0;">ğŸ“ˆ æ›ç‰Œçµ±è¨ˆï¼ˆå…¨éƒ¨ï¼‰</div>`;
        html += `<table class="card-market-table">
        <tr><th></th><th>æ›ç‰Œé«˜</th><th>æ›ç‰Œä½</th><th>æŒ¯å¹…</th></tr>`;
        
        if (hasAuction) {
            html += `<tr>
                <td class="type-label">ç«¶æ‹<span class="count">${aCount}</span></td>
                <td class="val-blue">${aH > 0 ? safeFixed(aH,1) : '-'}</td>
                <td class="val-blue">${aL > 0 ? safeFixed(aL,1) : '-'}</td>
                <td class="val-pink">${aAmp}%</td>
            </tr>`;
        }
        
        if (hasInquiry) {
            html += `<tr>
                <td class="type-label">è©¢åœˆ<span class="count">${iCount}</span></td>
                <td class="val-blue">${iH > 0 ? safeFixed(iH,1) : '-'}</td>
                <td class="val-blue">${iL > 0 ? safeFixed(iL,1) : '-'}</td>
                <td class="val-pink">${iAmp}%</td>
            </tr>`;
        }
        
        if (hasAuction && hasInquiry) {
            html += `<tr class="total-row">
                <td class="type-label">åˆè¨ˆ<span class="count">${totalCount}</span></td>
                <td class="val-blue">${tH > 0 ? safeFixed(tH,1) : '-'}</td>
                <td class="val-blue">${tL > 0 ? safeFixed(tL,1) : '-'}</td>
                <td class="val-pink">${tAmp}%</td>
            </tr>`;
        }
        
        html += `</table>`;
    }
    
    // === ç¬¬äºŒå€‹è¡¨æ ¼ï¼šæ’é™¤å‰ä¸‰é«˜ ===
    const hasExcludeAuction = exAH > 0 || exAL > 0;
    const hasExcludeInquiry = exIH > 0 || exIL > 0;
    
    if (hasExcludeAuction || hasExcludeInquiry) {
        html += `<div style="font-size:11px; color:#1565c0; font-weight:bold; margin:12px 0 4px 0;">ğŸ“‰ æ›ç‰Œçµ±è¨ˆï¼ˆæ’é™¤å‰3é«˜ï¼‰</div>`;
        html += `<table class="card-market-table" style="background:#e3f2fd;">
        <tr><th style="background:#1565c0;"></th><th style="background:#1565c0;">æ›ç‰Œé«˜</th><th style="background:#1565c0;">æ›ç‰Œä½</th><th style="background:#1565c0;">æŒ¯å¹…</th></tr>`;
        
        if (hasExcludeAuction) {
            html += `<tr>
                <td class="type-label" style="color:#1565c0;">ç«¶æ‹<span class="count">${exACount}</span></td>
                <td class="val-blue">${exAH > 0 ? safeFixed(exAH,1) : '-'}</td>
                <td class="val-blue">${exAL > 0 ? safeFixed(exAL,1) : '-'}</td>
                <td class="val-pink">${exAAmp}%</td>
            </tr>`;
        }
        
        if (hasExcludeInquiry) {
            html += `<tr>
                <td class="type-label" style="color:#1565c0;">è©¢åœˆ<span class="count">${exICount}</span></td>
                <td class="val-blue">${exIH > 0 ? safeFixed(exIH,1) : '-'}</td>
                <td class="val-blue">${exIL > 0 ? safeFixed(exIL,1) : '-'}</td>
                <td class="val-pink">${exIAmp}%</td>
            </tr>`;
        }
        
        if (hasExcludeAuction && hasExcludeInquiry) {
            html += `<tr class="total-row" style="background:#bbdefb;">
                <td class="type-label" style="color:#1565c0;">åˆè¨ˆ<span class="count">${exTotalCount}</span></td>
                <td class="val-blue">${exTH > 0 ? safeFixed(exTH,1) : '-'}</td>
                <td class="val-blue">${exTL > 0 ? safeFixed(exTL,1) : '-'}</td>
                <td class="val-pink">${exTAmp}%</td>
            </tr>`;
        }
        
        html += `</table>`;
        
        // === è¨ˆç®—è½å·®ä¸¦é¡¯ç¤ºæé†’ï¼ˆåˆ†é–‹ç«¶æ‹å’Œè©¢åœˆï¼‰===
        let warnings = [];
        
        // ç«¶æ‹è½å·®æª¢æŸ¥
        if (hasAuction && hasExcludeAuction) {
            const aAmpNum = parseFloat(aAmp);
            const exAAmpNum = parseFloat(exAAmp);
            
            if (!isNaN(aAmpNum) && !isNaN(exAAmpNum) && aAmpNum > 0) {
                const aAmpDiffPct = ((aAmpNum - exAAmpNum) / aAmpNum) * 100;
                
                if (aAmpDiffPct > 15) {
                    const aAmpDiff = (aAmpNum - exAAmpNum).toFixed(1);
                    const aHighDiff = (aH - exAH).toFixed(1);
                    warnings.push(`ğŸ¯ ç«¶æ‹ï¼šæŒ¯å¹…è½å·® ${aAmpDiff}%ï¼ˆé™å¹…${aAmpDiffPct.toFixed(0)}%ï¼‰ï¼Œæ›ç‰Œé«˜å‡åƒ¹å·® ${aHighDiff} å…ƒ`);
                }
            }
        }
        
        // è©¢åœˆè½å·®æª¢æŸ¥
        if (hasInquiry && hasExcludeInquiry) {
            const iAmpNum = parseFloat(iAmp);
            const exIAmpNum = parseFloat(exIAmp);
            
            if (!isNaN(iAmpNum) && !isNaN(exIAmpNum) && iAmpNum > 0) {
                const iAmpDiffPct = ((iAmpNum - exIAmpNum) / iAmpNum) * 100;
                
                if (iAmpDiffPct > 15) {
                    const iAmpDiff = (iAmpNum - exIAmpNum).toFixed(1);
                    const iHighDiff = (iH - exIH).toFixed(1);
                    warnings.push(`ğŸ“‹ è©¢åœˆï¼šæŒ¯å¹…è½å·® ${iAmpDiff}%ï¼ˆé™å¹…${iAmpDiffPct.toFixed(0)}%ï¼‰ï¼Œæ›ç‰Œé«˜å‡åƒ¹å·® ${iHighDiff} å…ƒ`);
                }
            }
        }
        
        if (warnings.length > 0) {
            html += `<div style="margin-top:6px; padding:6px 8px; background:#fff3e0; border-left:3px solid #ff9800; border-radius:4px; font-size:10px; color:#e65100; line-height:1.6;">
                <div style="font-weight:bold; margin-bottom:3px;">âš ï¸ å‰3é«˜å°æ•´é«”å½±éŸ¿é¡¯è‘—ï¼š</div>
                ${warnings.join('<br>')}
            </div>`;
        }
    }
    
    // === ç¬¬ä¸‰å€‹è¡¨æ ¼ï¼šä¾æ“”ä¿é¡å‹ç´°åˆ† ===
    const hasGuaranteedAuction = guaranteedAuctionData && safeFloat(guaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€é«˜']) > 0;
    const hasGuaranteedInquiry = guaranteedInquiryData && safeFloat(guaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']) > 0;
    const hasUnguaranteedAuction = unguaranteedAuctionData && safeFloat(unguaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€é«˜']) > 0;
    const hasUnguaranteedInquiry = unguaranteedInquiryData && safeFloat(unguaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']) > 0;
    
    if (hasGuaranteedAuction || hasGuaranteedInquiry || hasUnguaranteedAuction || hasUnguaranteedInquiry) {
        html += `<div style="font-size:11px; color:#7b1fa2; font-weight:bold; margin:12px 0 4px 0;">ğŸ·ï¸ ä¾æ“”ä¿é¡å‹ç´°åˆ†</div>`;
        html += `<table class="card-market-table" style="background:#f3e5f5;">
        <tr><th style="background:#7b1fa2;"></th><th style="background:#7b1fa2;">æ›ç‰Œé«˜</th><th style="background:#7b1fa2;">æ›ç‰Œä½</th><th style="background:#7b1fa2;">æŒ¯å¹…</th></tr>`;
        
        // æœ‰æ“”ä¿
        if (hasGuaranteedAuction || hasGuaranteedInquiry) {
            // æœ‰æ“”ä¿ - ç«¶æ‹
            if (hasGuaranteedAuction) {
                const gaH = safeFloat(guaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€é«˜']);
                const gaL = safeFloat(guaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€ä½']);
                const gaAmp = (gaH > 0 && gaL > 0) ? ((gaH - gaL) / gaL * 100).toFixed(1) : '-';
                html += `<tr>
                    <td class="type-label" style="color:#7b1fa2;">æœ‰æ“”ä¿-ç«¶æ‹<span class="count">${guaranteedAuctionData['æ¨£æœ¬æ•¸']}</span></td>
                    <td class="val-blue">${gaH > 0 ? safeFixed(gaH,1) : '-'}</td>
                    <td class="val-blue">${gaL > 0 ? safeFixed(gaL,1) : '-'}</td>
                    <td class="val-pink">${gaAmp}%</td>
                </tr>`;
            }
            
            // æœ‰æ“”ä¿ - è©¢åœˆ
            if (hasGuaranteedInquiry) {
                const giH = safeFloat(guaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']);
                const giL = safeFloat(guaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€ä½']);
                const giAmp = (giH > 0 && giL > 0) ? ((giH - giL) / giL * 100).toFixed(1) : '-';
                html += `<tr>
                    <td class="type-label" style="color:#7b1fa2;">æœ‰æ“”ä¿-è©¢åœˆ<span class="count">${guaranteedInquiryData['æ¨£æœ¬æ•¸']}</span></td>
                    <td class="val-blue">${giH > 0 ? safeFixed(giH,1) : '-'}</td>
                    <td class="val-blue">${giL > 0 ? safeFixed(giL,1) : '-'}</td>
                    <td class="val-pink">${giAmp}%</td>
                </tr>`;
            }
        }
        
        // ç„¡æ“”ä¿
        if (hasUnguaranteedAuction || hasUnguaranteedInquiry) {
            // ç„¡æ“”ä¿ - ç«¶æ‹
            if (hasUnguaranteedAuction) {
                const uaH = safeFloat(unguaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€é«˜']);
                const uaL = safeFloat(unguaranteedAuctionData['å¹³å‡æ›ç‰Œæœ€ä½']);
                const uaAmp = (uaH > 0 && uaL > 0) ? ((uaH - uaL) / uaL * 100).toFixed(1) : '-';
                html += `<tr style="background:#ede7f6;">
                    <td class="type-label" style="color:#512da8;">ç„¡æ“”ä¿-ç«¶æ‹<span class="count">${unguaranteedAuctionData['æ¨£æœ¬æ•¸']}</span></td>
                    <td class="val-blue">${uaH > 0 ? safeFixed(uaH,1) : '-'}</td>
                    <td class="val-blue">${uaL > 0 ? safeFixed(uaL,1) : '-'}</td>
                    <td class="val-pink">${uaAmp}%</td>
                </tr>`;
            }
            
            // ç„¡æ“”ä¿ - è©¢åœˆ
            if (hasUnguaranteedInquiry) {
                const uiH = safeFloat(unguaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€é«˜']);
                const uiL = safeFloat(unguaranteedInquiryData['å¹³å‡æ›ç‰Œæœ€ä½']);
                const uiAmp = (uiH > 0 && uiL > 0) ? ((uiH - uiL) / uiL * 100).toFixed(1) : '-';
                html += `<tr style="background:#ede7f6;">
                    <td class="type-label" style="color:#512da8;">ç„¡æ“”ä¿-è©¢åœˆ<span class="count">${unguaranteedInquiryData['æ¨£æœ¬æ•¸']}</span></td>
                    <td class="val-blue">${uiH > 0 ? safeFixed(uiH,1) : '-'}</td>
                    <td class="val-blue">${uiL > 0 ? safeFixed(uiL,1) : '-'}</td>
                    <td class="val-pink">${uiAmp}%</td>
                </tr>`;
            }
        }
        
        html += `</table>`;
    }
    
    return html;
}

function initializeUI() {
    document.getElementById('headerSubtitle').textContent = `ç«¶æ‹è³‡æ–™åº« ${Object.keys(cbDatabase).length} ç­†`;
    populateSelect('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']); 
    populateSelect('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);
    showStatsSummary(); 
    bindInputEvents();
}

function populateSelect(id, dataObj) {
    if (!dataObj) return; 
    const sel = document.getElementById(id); 
    while (sel.options.length > 1) sel.remove(1);
    Object.keys(dataObj).sort((a,b)=>(dataObj[b].count||0)-(dataObj[a].count||0)).forEach(k=>{ 
        const o=document.createElement('option'); 
        o.value=k; 
        o.text=`${k} (${dataObj[k].count})`; 
        sel.add(o); 
    });
}

function showStatsSummary() { 
    // åŸºæœ¬çµ±è¨ˆ
    let html = `
    <div class="stat-box"><div class="number">${auctionRawData.filter(d=>d.minBidPrice>0).length}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
    <div class="stat-box"><div class="number">${inquiryRawData.length}</div><div class="label">è©¢åœˆæ¡ˆä¾‹</div></div>
    <div class="stat-box"><div class="number">${auctionRawData.filter(d=>d.marketHigh>0).length + inquiryRawData.filter(d=>d.marketHigh>0).length}</div><div class="label">æ›ç‰Œè¡Œæƒ…</div></div>
    `;
    
    // v3.52: æ¨™çš„æ¢ä»¶è©•åˆ†ç³»çµ±ï¼ˆæ”¾æœ€ä¸Šé¢ï¼‰
    html += generateScoringSystem();
    
    // v3.52: å¤šç¶­åº¦äº¤é›†åˆ†æ
    html += generateMultiDimensionAnalysis();
    
    // v3.52: æ½›åŠ›æ¨™çš„ç¯©é¸
    html += generatePotentialScreening();
    
    // v3.52: å¹´åº¦ç¸¾æ•ˆåˆ†æ
    html += generateYearlyPerformance();
    
    // v3.52: è¿‘æœŸç¸¾æ•ˆæ’è¡Œ
    html += generateRecentPerformance();
    
    // v3.52: æŠ•æ¨™ç†±åº¦ vs ç¸¾æ•ˆåˆ†æ
    html += generateBidHeatAnalysis();
    
    document.getElementById('statsSummary').innerHTML = html;
    
    // ç¶å®šè©•åˆ†ç³»çµ±äº‹ä»¶
    setTimeout(() => bindScoringEvents(), 100);
}

// v3.52: ç”Ÿæˆæ½›åŠ›æ¨™çš„ç¯©é¸HTML

// v3.52: æ¨™çš„æ¢ä»¶è©•åˆ†ç³»çµ±
function generateScoringSystem() {
    return `
    <div class="scoring-system" style="grid-column: 1 / -1;">
        <div class="scoring-system-title">ğŸ¯ æ¨™çš„æ¢ä»¶è©•åˆ†ç³»çµ±</div>
        <div style="font-size:12px; color:#666; margin-bottom:15px; text-align:center;">
            è¼¸å…¥CBä»£è™Ÿæˆ–åç¨±ï¼Œç³»çµ±æœƒæ ¹æ“šæ­·å²å„ªè³ªæ¢ä»¶çµ„åˆé€²è¡Œè©•åˆ†åˆ†æ
        </div>
        <div class="scoring-search-box">
            <input type="text" id="scoringSearchInput" class="scoring-search-input" 
                   placeholder="è¼¸å…¥ä»£è™Ÿ(å¦‚30371)æˆ–åç¨±(å¦‚æ¬£èˆˆä¸€)æœå°‹...">
            <button type="button" id="scoringSearchBtn" class="scoring-search-btn">ğŸ” æŸ¥è©¢è©•åˆ†</button>
        </div>
        <div id="scoringResult" class="scoring-result"></div>
    </div>`;
}

// ç¶å®šè©•åˆ†ç³»çµ±äº‹ä»¶
function bindScoringEvents() {
    const input = document.getElementById('scoringSearchInput');
    const btn = document.getElementById('scoringSearchBtn');
    const resultDiv = document.getElementById('scoringResult');
    
    if (!input || !btn) return;
    
    btn.addEventListener('click', () => performScoringSearch());
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performScoringSearch();
    });
}

// åŸ·è¡Œè©•åˆ†æœå°‹
function performScoringSearch() {
    const input = document.getElementById('scoringSearchInput');
    const resultDiv = document.getElementById('scoringResult');
    const query = input.value.trim();
    
    if (!query) {
        resultDiv.innerHTML = '<div class="no-result-msg">è«‹è¼¸å…¥CBä»£è™Ÿæˆ–åç¨±</div>';
        resultDiv.classList.add('active');
        return;
    }
    
    console.log('æœå°‹æŸ¥è©¢:', query);
    
    // æ–°é‚è¼¯ï¼šåˆ†é–‹æœå°‹ã€Œç™¼è¡Œæ¢ä»¶ã€å’Œã€Œå³æ™‚åƒ¹æ ¼ã€
    // ç™¼è¡Œæ¢ä»¶å„ªå…ˆé †åºï¼š06(æ­£åœ¨ç™¼è¡Œ) â†’ 04(ç«¶æ‹) â†’ 01(æ‰€æœ‰CB)
    // å³æ™‚åƒ¹æ ¼ï¼š09(ç›®å‰æ›ç‰Œ)
    
    let conditionData = null;
    let priceData = null;
    let dataSource = '';
    
    // === 1. æœå°‹06å·¥ä½œè¡¨ï¼ˆæ­£åœ¨ç™¼è¡Œï¼‰===
    if (window.issuingData) {
        conditionData = window.issuingData.find(row => {
            const id = String(row['æ¨™çš„ä»£è™Ÿ'] || row['è‚¡ç¥¨ä»£è™Ÿ'] || '').trim();
            const name = String(row['ç™¼è¡Œæ¨™çš„'] || '').trim();
            return id.includes(query) || name.includes(query) || query.includes(id);
        });
        if (conditionData) {
            dataSource = 'æ­£åœ¨ç™¼è¡Œ (06å·¥ä½œè¡¨)';
            console.log('åœ¨06æ‰¾åˆ°:', conditionData);
        }
    }
    
    // === 2. æœå°‹04å·¥ä½œè¡¨ï¼ˆç«¶æ‹è³‡æ–™ï¼Œæœ‰å®Œæ•´ç™¼è¡Œæ¢ä»¶ï¼‰===
    if (!conditionData && window.auctionData) {
        conditionData = window.auctionData.find(row => {
            const id = String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').replace('.0', '').trim();
            const name = String(row['åç¨±'] || row['CBåç¨±'] || '').trim();
            return id.includes(query) || name.includes(query) || query.includes(id);
        });
        if (conditionData) {
            dataSource = 'ç«¶æ‹è³‡æ–™ (04å·¥ä½œè¡¨)';
            console.log('åœ¨04æ‰¾åˆ°:', conditionData);
        }
    }
    
    // === 3. æœå°‹01å·¥ä½œè¡¨ï¼ˆæ‰€æœ‰CBåŸºæœ¬è³‡æ–™ï¼‰===
    if (!conditionData && window.allCBData) {
        conditionData = window.allCBData.find(row => {
            const id = String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').replace('.0', '').trim();
            const name = String(row['åç¨±'] || '').trim();
            return id.includes(query) || name.includes(query) || query.includes(id);
        });
        if (conditionData) {
            dataSource = 'æ­·å²è³‡æ–™ (01å·¥ä½œè¡¨)';
            console.log('åœ¨01æ‰¾åˆ°:', conditionData);
        }
    }
    
    // === 4. æœå°‹09å·¥ä½œè¡¨å–å¾—å³æ™‚åƒ¹æ ¼ï¼ˆè£œå……è³‡è¨Šï¼‰===
    if (window.currentListingData) {
        priceData = window.currentListingData.find(row => {
            const id = String(row['ä»£ç¢¼'] || '').trim();
            const name = String(row['åç¨±  '] || row['åç¨±'] || '').trim();
            return id.includes(query) || name.includes(query) || query.includes(id);
        });
        if (priceData) {
            console.log('åœ¨09æ‰¾åˆ°åƒ¹æ ¼è³‡æ–™:', priceData);
        }
    }
    
    if (!conditionData) {
        resultDiv.innerHTML = `<div class="no-result-msg">âŒ æ‰¾ä¸åˆ°ã€Œ${query}ã€çš„ç›¸é—œè³‡æ–™<br><small style="color:#999;">è«‹ç¢ºèªä»£è™Ÿæˆ–åç¨±æ˜¯å¦æ­£ç¢º</small></div>`;
        resultDiv.classList.add('active');
        return;
    }
    
    // æ¨™æº–åŒ–è³‡æ–™
    let normalizedData;
    if (dataSource.includes('06')) {
        normalizedData = normalizeIssuingData(conditionData);
    } else if (dataSource.includes('04')) {
        normalizedData = normalizeAuctionData(conditionData);
    } else {
        normalizedData = normalizeAllCBData(conditionData);
    }
    
    // è£œå……å³æ™‚åƒ¹æ ¼
    if (priceData) {
        normalizedData.currentPrice = priceData['CBæ”¶ç›¤åƒ¹'] || '';
        normalizedData.currentPremium = priceData['æº¢(æŠ˜)åƒ¹%'] || '';
        if (priceData['ç”¢æ¥­']) {
            normalizedData.industry = priceData['ç”¢æ¥­'];
        }
    }
    
    console.log('æ¨™æº–åŒ–å¾Œè³‡æ–™:', normalizedData);
    
    // é¡¯ç¤ºè©•åˆ†çµæœ
    displayScoringResult(normalizedData, dataSource, resultDiv);
}

// æ¨™æº–åŒ–06å·¥ä½œè¡¨è³‡æ–™
function normalizeIssuingData(row) {
    const tcriRaw = row['TCRI/æ“”ä¿'] || '';
    let guarantee = 'ç„¡æ“”ä¿';
    let rating = '';
    
    if (tcriRaw.includes('æ“”ä¿')) {
        guarantee = 'æœ‰æ“”ä¿';
    }
    const ratingMatch = tcriRaw.match(/TCRI(\d+)/i);
    if (ratingMatch) rating = ratingMatch[1];
    
    const issueSize = parseFloat(row['ç™¼è¡Œé‡']) || 0;
    const years = parseFloat(row['å¹´æœŸ']) || 0;
    
    let yearRange = 'æœªçŸ¥';
    if (years > 0) {
        if (years <= 3) yearRange = '3å¹´æœŸ';
        else if (years <= 5) yearRange = '5å¹´æœŸ';
        else yearRange = '7å¹´æœŸ';
    }
    
    let sizeRange = 'æœªçŸ¥';
    if (issueSize > 0) {
        if (issueSize < 5) sizeRange = 'å°å‹(<5å„„)';
        else if (issueSize < 10) sizeRange = 'ä¸­å°å‹(5-10å„„)';
        else if (issueSize < 20) sizeRange = 'ä¸­å‹(10-20å„„)';
        else sizeRange = 'å¤§å‹(â‰¥20å„„)';
    }
    
    return {
        id: row['æ¨™çš„ä»£è™Ÿ'] || '',
        name: row['ç™¼è¡Œæ¨™çš„'] || '',
        guarantee,
        yearRange,
        sizeRange,
        issueSize,
        years,
        rating,
        industry: '',
        type: row['è©¢åœˆ/ç«¶æ‹'] || '',
        broker: row['ä¸»è¾¦åˆ¸å•†'] || '',
        conversionPrice: row['è½‰æ›åƒ¹'] || '',
        premiumRate: row['æº¢åƒ¹ç‡'] || ''
    };
}

// æ¨™æº–åŒ–09å·¥ä½œè¡¨è³‡æ–™
function normalizeListingData(row) {
    const guaranteeRaw = row['å‚µåˆ¸æ“”ä¿æƒ…å½¢'] || '';
    const guarantee = (guaranteeRaw === 'ç„¡' || guaranteeRaw.includes('ç„¡')) ? 'ç„¡æ“”ä¿' : 'æœ‰æ“”ä¿';
    
    const totalShares = parseFloat(row['ç™¼è¡Œç¸½é‡(å¼µ)']) || 0;
    const issueSize = totalShares / 10000;
    
    // è¨ˆç®—å¹´æœŸ
    const issueDate = row['ç™¼è¡Œæ—¥'];
    const maturityDate = row['åˆ°æœŸæ—¥'];
    let years = 0;
    if (issueDate && maturityDate) {
        const start = typeof issueDate === 'number' ? issueDate : 0;
        const end = typeof maturityDate === 'number' ? maturityDate : 0;
        if (start > 0 && end > 0) {
            years = Math.round((end - start) / 365);
        }
    }
    
    let yearRange = 'æœªçŸ¥';
    if (years > 0) {
        if (years <= 3) yearRange = '3å¹´æœŸ';
        else if (years <= 6) yearRange = '5å¹´æœŸ';
        else yearRange = '7å¹´æœŸ';
    }
    
    let sizeRange = 'æœªçŸ¥';
    if (issueSize > 0) {
        if (issueSize < 5) sizeRange = 'å°å‹(<5å„„)';
        else if (issueSize < 10) sizeRange = 'ä¸­å°å‹(5-10å„„)';
        else if (issueSize < 20) sizeRange = 'ä¸­å‹(10-20å„„)';
        else sizeRange = 'å¤§å‹(â‰¥20å„„)';
    }
    
    return {
        id: row['ä»£ç¢¼'] || '',
        name: (row['åç¨±  '] || row['åç¨±'] || '').trim(),
        guarantee,
        yearRange,
        sizeRange,
        issueSize,
        years,
        rating: row['TCRI'] || '',
        industry: row['ç”¢æ¥­'] || '',
        price: row['CBæ”¶ç›¤åƒ¹'] || '',
        premium: row['æº¢(æŠ˜)åƒ¹%'] || ''
    };
}

// æ¨™æº–åŒ–01å·¥ä½œè¡¨è³‡æ–™ï¼ˆæ‰€æœ‰CBåŸºæœ¬è³‡æ–™ï¼‰
function normalizeAllCBData(row) {
    // 01å·¥ä½œè¡¨æ¬„ä½ï¼šæœ‰ç„¡æ“”ä¿, ä¿¡ç”¨æ“”ä¿, ç™¼è¡Œè¦æ¨¡(å„„), ç™¼è¡Œå¹´æœŸ
    const guaranteeRaw = row['æœ‰ç„¡æ“”ä¿'] || '';
    const guarantee = guaranteeRaw.includes('æœ‰') ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    
    // ç™¼è¡Œè¦æ¨¡å–®ä½æ˜¯ã€Œå„„ã€
    const issueSize = parseFloat(row['ç™¼è¡Œè¦æ¨¡']) || 0;
    const years = parseFloat(row['ç™¼è¡Œå¹´æœŸ']) || 0;
    
    let yearRange = 'æœªçŸ¥';
    if (years > 0) {
        if (years <= 3) yearRange = '3å¹´æœŸ';
        else if (years <= 5) yearRange = '5å¹´æœŸ';
        else yearRange = '7å¹´æœŸ';
    }
    
    let sizeRange = 'æœªçŸ¥';
    if (issueSize > 0) {
        if (issueSize < 5) sizeRange = 'å°å‹(<5å„„)';
        else if (issueSize < 10) sizeRange = 'ä¸­å°å‹(5-10å„„)';
        else if (issueSize < 20) sizeRange = 'ä¸­å‹(10-20å„„)';
        else sizeRange = 'å¤§å‹(â‰¥20å„„)';
    }
    
    // è™•ç†ä¿¡è©•ï¼šå¯èƒ½æ˜¯ã€ŒTCRI5ã€æˆ–ã€ŒåœŸåœ°éŠ€è¡Œã€ç­‰
    let rating = '';
    const ratingRaw = row['ä¿¡ç”¨æ“”ä¿'] || '';
    if (ratingRaw) {
        const ratingMatch = String(ratingRaw).match(/TCRI(\d+)/i);
        if (ratingMatch) {
            rating = ratingMatch[1];
        } else if (String(ratingRaw).match(/^\d+$/)) {
            rating = ratingRaw;
        } else {
            // æœ‰æ“”ä¿çš„æƒ…æ³ä¸‹ï¼Œä¿¡ç”¨æ“”ä¿æ¬„ä½å¯èƒ½æ˜¯éŠ€è¡Œåç¨±
            rating = guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰æ“”ä¿' : ratingRaw;
        }
    }
    
    return {
        id: String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').replace('.0', '').trim(),
        name: row['åç¨±'] || '',
        guarantee,
        yearRange,
        sizeRange,
        issueSize,
        years,
        rating,
        industry: row['ç”¢æ¥­åˆ†é¡'] || '',
        broker: row['æ‰¿éŠ·åˆ¸å•†'] || '',
        type: row['è©¢åœˆç«¶æ‹'] || '',
        capital: row['è‚¡æœ¬è¦æ¨¡'] || '',
        conversionPrice: row['è½‰æ›åƒ¹æ ¼'] || ''
    };
}

// æ¨™æº–åŒ–04å·¥ä½œè¡¨è³‡æ–™ï¼ˆç«¶æ‹è³‡æ–™ï¼Œæœ€å®Œæ•´ï¼‰
function normalizeAuctionData(row) {
    // 04å·¥ä½œè¡¨æ¬„ä½ï¼šæ“”ä¿, ä¿¡è©•, ç™¼è¡Œè¦æ¨¡(å„„), å¹´æœŸ
    const guaranteeRaw = row['æ“”ä¿'] || '';
    const guarantee = guaranteeRaw.includes('æœ‰') ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    
    // ç™¼è¡Œè¦æ¨¡å–®ä½æ˜¯ã€Œå„„ã€
    const issueSize = parseFloat(row['ç™¼è¡Œè¦æ¨¡']) || 0;
    const years = parseFloat(row['å¹´æœŸ']) || 0;
    
    let yearRange = 'æœªçŸ¥';
    if (years > 0) {
        if (years <= 3) yearRange = '3å¹´æœŸ';
        else if (years <= 5) yearRange = '5å¹´æœŸ';
        else yearRange = '7å¹´æœŸ';
    }
    
    let sizeRange = 'æœªçŸ¥';
    if (issueSize > 0) {
        if (issueSize < 5) sizeRange = 'å°å‹(<5å„„)';
        else if (issueSize < 10) sizeRange = 'ä¸­å°å‹(5-10å„„)';
        else if (issueSize < 20) sizeRange = 'ä¸­å‹(10-20å„„)';
        else sizeRange = 'å¤§å‹(â‰¥20å„„)';
    }
    
    // ä¿¡è©•å¯èƒ½æ˜¯æ•¸å­—
    let rating = '';
    const ratingRaw = row['ä¿¡è©•'] || '';
    if (ratingRaw) {
        rating = String(ratingRaw).trim();
    }
    
    return {
        id: String(row['CBä»£è™Ÿ'] || row['ä»£è™Ÿ'] || '').replace('.0', '').trim(),
        name: row['åç¨±'] || row['CBåç¨±'] || '',
        guarantee,
        yearRange,
        sizeRange,
        issueSize,
        years,
        rating,
        industry: row['ç”¢æ¥­åˆ†é¡'] || '',
        broker: row['ç™¼è¡Œåˆ¸å•†'] || row['æ‰¿éŠ·åˆ¸å•†'] || '',
        capital: row['è‚¡æœ¬'] || '',
        conversionPrice: row['è½‰æ›åƒ¹'] || '',
        floorPrice: row['åº•æ¨™åƒ¹'] || '',
        minBid: row['æœ€ä½å¾—æ¨™'] || '',
        avgBid: row['å¹³å‡å¾—æ¨™'] || '',
        bidMultiple: row['æŠ•æ¨™å€æ•¸'] || ''
    };
}

// é¡¯ç¤ºè©•åˆ†çµæœ
function displayScoringResult(data, dataSource, resultDiv) {
    // å–å¾—å„ªè³ªæ¢ä»¶çµ„åˆ
    const qualityCombos = window.qualityConditions || [];
    
    // å¦‚æœæ²’æœ‰å„ªè³ªæ¢ä»¶ï¼Œé¡¯ç¤ºåŸºæœ¬è³‡è¨Š
    if (qualityCombos.length === 0) {
        resultDiv.innerHTML = `
        <div class="scoring-header">
            <span class="scoring-cb-name">${data.name}</span>
            <span class="scoring-cb-id">${data.id}</span>
            <span class="scoring-source">ğŸ“ ${dataSource}</span>
        </div>
        <div class="scoring-conditions">
            <div class="scoring-conditions-title">ğŸ“‹ æ¨™çš„åŸºæœ¬æ¢ä»¶</div>
            <div class="scoring-condition-row">
                <span class="scoring-condition-tag">æ“”ä¿: ${data.guarantee || 'æœªçŸ¥'}</span>
                <span class="scoring-condition-tag">å¹´æœŸ: ${data.yearRange || 'æœªçŸ¥'}</span>
                <span class="scoring-condition-tag">è¦æ¨¡: ${data.sizeRange || 'æœªçŸ¥'} ${data.issueSize ? '(' + data.issueSize + 'å„„)' : ''}</span>
                ${data.industry ? `<span class="scoring-condition-tag">ç”¢æ¥­: ${data.industry}</span>` : ''}
                ${data.rating ? `<span class="scoring-condition-tag">ä¿¡è©•: TCRI${data.rating}</span>` : ''}
                ${data.type ? `<span class="scoring-condition-tag">é¡å‹: ${data.type}</span>` : ''}
            </div>
        </div>
        <div class="scoring-prediction">
            <div class="scoring-prediction-title">ğŸ“ èªªæ˜</div>
            <div class="scoring-prediction-content">
                å·²æ‰¾åˆ°æ¨™çš„è³‡æ–™ï¼Œä½†ç³»çµ±å°šæœªå®Œæˆå„ªè³ªæ¢ä»¶åˆ†æã€‚<br>
                è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–å¾€ä¸‹æ»¾å‹•æŸ¥çœ‹ã€Œå¤šç¶­åº¦äº¤é›†åˆ†æã€æ˜¯å¦å·²å®Œæˆè¼‰å…¥ã€‚
            </div>
        </div>`;
        resultDiv.classList.add('active');
        return;
    }
    
    // å»ºç«‹æª¢æŸ¥å°è±¡
    const checkObj = {
        guarantee: data.guarantee,
        yearRange: data.yearRange,
        sizeRange: data.sizeRange
    };
    
    // æª¢æŸ¥ç¬¦åˆå“ªäº›å„ªè³ªæ¢ä»¶
    const matchedGood = [];
    const unmatchedGood = [];
    
    qualityCombos.forEach(combo => {
        try {
            if (combo.check && combo.check(checkObj)) {
                matchedGood.push({
                    name: combo.name,
                    topRatio: combo.topRatio,
                    avgReturn: combo.avgReturn
                });
            } else {
                unmatchedGood.push({
                    name: combo.name,
                    topRatio: combo.topRatio
                });
            }
        } catch (e) {
            console.error('æ¢ä»¶æª¢æŸ¥éŒ¯èª¤:', combo.name, e);
            unmatchedGood.push({ name: combo.name, topRatio: combo.topRatio || 0 });
        }
    });
    
    // è¨ˆç®—è©•åˆ†ï¼ˆ0-100åˆ†ï¼‰
    const maxScore = qualityCombos.length;
    const earnedScore = matchedGood.length;
    const scorePercent = maxScore > 0 ? Math.round((earnedScore / maxScore) * 100) : 0;
    
    // æ±ºå®šè©•åˆ†ç­‰ç´š
    let scoreClass = 'neutral';
    let scoreLabel = 'ä¸­ç­‰';
    if (scorePercent >= 60) { scoreClass = 'excellent'; scoreLabel = 'å„ªç§€'; }
    else if (scorePercent >= 40) { scoreClass = 'good'; scoreLabel = 'è‰¯å¥½'; }
    else if (scorePercent >= 20) { scoreClass = 'neutral'; scoreLabel = 'ä¸­ç­‰'; }
    else { scoreClass = 'poor'; scoreLabel = 'è¼ƒå¼±'; }
    
    // è¨ˆç®—å¹³å‡é æœŸå ±é…¬
    let expectedReturn = 0;
    if (matchedGood.length > 0) {
        expectedReturn = matchedGood.reduce((s, c) => s + (c.avgReturn || 0), 0) / matchedGood.length;
    }
    
    let html = `
    <div class="scoring-header">
        <span class="scoring-cb-name">${data.name}</span>
        <span class="scoring-cb-id">${data.id}</span>
        <span class="scoring-source">ğŸ“ ${dataSource}</span>
    </div>
    
    <div class="scoring-gauge">
        <div class="score-circle ${scoreClass}">
            <div class="score-value">${earnedScore}/${maxScore}</div>
            <div class="score-label">${scoreLabel}</div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:14px; color:#333; font-weight:bold;">æ¢ä»¶è©•åˆ†</div>
            <div style="font-size:12px; color:#666; margin-top:5px;">ç¬¦åˆ ${earnedScore} é …å„ªè³ªæ¢ä»¶çµ„åˆ</div>
            ${matchedGood.length > 0 ? `<div style="font-size:13px; color:#2e7d32; margin-top:8px; font-weight:bold;">é æœŸå¹³å‡å ±é…¬: +${expectedReturn.toFixed(0)}%</div>` : ''}
        </div>
    </div>
    
    <div class="scoring-conditions">
        <div class="scoring-conditions-title">ğŸ“‹ æ¨™çš„åŸºæœ¬æ¢ä»¶</div>
        <div class="scoring-condition-row">
            <span class="scoring-condition-tag">æ“”ä¿: ${data.guarantee || 'æœªçŸ¥'}</span>
            <span class="scoring-condition-tag">å¹´æœŸ: ${data.yearRange || 'æœªçŸ¥'}</span>
            <span class="scoring-condition-tag">è¦æ¨¡: ${data.sizeRange || 'æœªçŸ¥'} ${data.issueSize ? '(' + data.issueSize + 'å„„)' : ''}</span>
            ${data.industry ? `<span class="scoring-condition-tag">ç”¢æ¥­: ${data.industry}</span>` : ''}
            ${data.rating ? `<span class="scoring-condition-tag">ä¿¡è©•: ${data.rating.includes('TCRI') || data.rating.includes('æ“”ä¿') ? data.rating : 'TCRI' + data.rating}</span>` : ''}
            ${data.type ? `<span class="scoring-condition-tag">é¡å‹: ${data.type}</span>` : ''}
        </div>
        ${data.currentPrice || data.bidMultiple ? `
        <div class="scoring-condition-row" style="margin-top:8px; padding-top:8px; border-top:1px dashed #ddd;">
            ${data.currentPrice ? `<span class="scoring-condition-tag" style="background:#e3f2fd;">ç›®å‰åƒ¹æ ¼: ${data.currentPrice}</span>` : ''}
            ${data.currentPremium ? `<span class="scoring-condition-tag" style="background:#fff3e0;">æº¢åƒ¹ç‡: ${parseFloat(data.currentPremium).toFixed(1)}%</span>` : ''}
            ${data.bidMultiple ? `<span class="scoring-condition-tag" style="background:#f3e5f5;">æŠ•æ¨™å€æ•¸: ${parseFloat(data.bidMultiple).toFixed(2)}x</span>` : ''}
            ${data.minBid ? `<span class="scoring-condition-tag" style="background:#e8f5e9;">æœ€ä½å¾—æ¨™: ${data.minBid}</span>` : ''}
        </div>
        ` : ''}
    </div>
    
    <div class="scoring-details">
        <div class="scoring-detail-box positive">
            <div class="scoring-detail-title">âœ… ç¬¦åˆçš„å„ªè³ªæ¢ä»¶ (${matchedGood.length}é …)</div>
            <div class="scoring-detail-list">`;
    
    if (matchedGood.length > 0) {
        matchedGood.forEach(c => {
            html += `<div class="scoring-detail-item"><span class="check">âœ“</span> ${c.name} <small style="color:#2e7d32;">(ç¸¾å„ªç‡${(c.topRatio || 0).toFixed(0)}%, å ±é…¬+${(c.avgReturn || 0).toFixed(0)}%)</small></div>`;
        });
    } else {
        html += `<div style="color:#999;">æœªç¬¦åˆä»»ä½•å„ªè³ªæ¢ä»¶çµ„åˆ</div>`;
    }
    
    html += `
            </div>
        </div>
        <div class="scoring-detail-box negative">
            <div class="scoring-detail-title">âŒ æœªç¬¦åˆçš„å„ªè³ªæ¢ä»¶ (${unmatchedGood.length}é …)</div>
            <div class="scoring-detail-list">`;
    
    if (unmatchedGood.length > 0) {
        unmatchedGood.slice(0, 5).forEach(c => {
            html += `<div class="scoring-detail-item"><span class="cross">âœ—</span> ${c.name}</div>`;
        });
        if (unmatchedGood.length > 5) {
            html += `<div style="color:#999;">...é‚„æœ‰ ${unmatchedGood.length - 5} é …</div>`;
        }
    } else {
        html += `<div style="color:#2e7d32; font-weight:bold;">ğŸ‰ ç¬¦åˆæ‰€æœ‰å„ªè³ªæ¢ä»¶ï¼</div>`;
    }
    
    html += `
            </div>
        </div>
    </div>
    
    <div class="scoring-prediction">
        <div class="scoring-prediction-title">ğŸ”® Rexå¤§å”è©•ä¼°</div>
        <div class="scoring-prediction-content">`;
    
    if (earnedScore >= 3) {
        html += `æ­¤æ¨™çš„ç¬¦åˆ <b>${earnedScore}</b> é …æ­·å²ç¸¾å„ªæ¢ä»¶çµ„åˆï¼Œè¡¨ç¾æ½›åŠ›è¼ƒä½³ã€‚æ ¹æ“šæ­·å²æ•¸æ“šï¼Œç¬¦åˆé€™äº›æ¢ä»¶çš„æ¨™çš„å¹³å‡å ±é…¬ç´„ <b>+${expectedReturn.toFixed(0)}%</b>ã€‚å»ºè­°å¯åˆ—å…¥è§€å¯Ÿåå–®ï¼Œåœ¨åƒ¹æ ¼å›è½æ™‚ç©æ¥µé—œæ³¨ã€‚`;
    } else if (earnedScore >= 1) {
        html += `æ­¤æ¨™çš„ç¬¦åˆ <b>${earnedScore}</b> é …æ­·å²ç¸¾å„ªæ¢ä»¶çµ„åˆï¼Œæ¢ä»¶å°šå¯ã€‚å»ºè­°æ­é…å…¶ä»–åŸºæœ¬é¢åˆ†æï¼Œå¯©æ…è©•ä¼°æŠ•è³‡åƒ¹å€¼ã€‚`;
    } else {
        html += `æ­¤æ¨™çš„æœªç¬¦åˆä»»ä½•æ­·å²ç¸¾å„ªæ¢ä»¶çµ„åˆï¼Œä¸ä»£è¡¨ä¸€å®šè¡¨ç¾å·®ï¼Œä½†æ­·å²ç¶“é©—é¡¯ç¤ºç¸¾å„ªæ©Ÿç‡ç›¸å°è¼ƒä½ã€‚å»ºè­°æ›´è¬¹æ…è©•ä¼°ï¼Œæˆ–å°‹æ‰¾å…¶ä»–æ›´ç¬¦åˆæ¢ä»¶çš„æ¨™çš„ã€‚`;
    }
    
    html += `
        </div>
    </div>`;
    
    resultDiv.innerHTML = html;
    resultDiv.classList.add('active');
}

// v3.52: å¤šç¶­åº¦äº¤é›†åˆ†æï¼ˆæ‰¾å‡ºç¸¾æ•ˆå¥½çš„æ¢ä»¶çµ„åˆï¼‰
function generateMultiDimensionAnalysis() {
    // æ”¶é›†æ‰€æœ‰æœ‰ç¸¾æ•ˆè³‡æ–™çš„æ¨™çš„
    const allWithPerf = [];
    
    auctionRawData.forEach(d => {
        if (!d.minBidPrice || d.minBidPrice <= 0) return;
        if (!d.marketHigh || d.marketHigh <= 0) return;
        
        const maxReturn = (d.marketHigh - d.minBidPrice) / d.minBidPrice * 100;
        
        // æ¨™æº–åŒ–æ“”ä¿
        let guarantee = 'æœªçŸ¥';
        if (d.guarantee) {
            guarantee = d.guarantee.includes('æœ‰') ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
        }
        
        // å¹´æœŸåˆ†é¡
        let yearRange = 'æœªçŸ¥';
        if (d.years > 0) {
            if (d.years <= 3) yearRange = '3å¹´æœŸ';
            else if (d.years <= 5) yearRange = '5å¹´æœŸ';
            else yearRange = '7å¹´æœŸ';
        }
        
        // è¦æ¨¡åˆ†é¡
        let sizeRange = 'æœªçŸ¥';
        if (d.issueSize > 0) {
            if (d.issueSize < 5) sizeRange = 'å°å‹(<5å„„)';
            else if (d.issueSize < 10) sizeRange = 'ä¸­å°å‹(5-10å„„)';
            else if (d.issueSize < 20) sizeRange = 'ä¸­å‹(10-20å„„)';
            else sizeRange = 'å¤§å‹(â‰¥20å„„)';
        }
        
        // è‚¡æœ¬åˆ†é¡
        let capitalRange = 'æœªçŸ¥';
        if (d.capital > 0) {
            if (d.capital < 20) capitalRange = 'å°å‹(<20å„„)';
            else if (d.capital < 50) capitalRange = 'ä¸­å‹(20-50å„„)';
            else if (d.capital < 100) capitalRange = 'ä¸­å¤§å‹(50-100å„„)';
            else capitalRange = 'å¤§å‹(â‰¥100å„„)';
        }
        
        allWithPerf.push({
            ...d,
            maxReturn,
            guarantee,
            yearRange,
            sizeRange,
            capitalRange,
            type: 'ç«¶æ‹'
        });
    });
    
    inquiryRawData.forEach(d => {
        if (!d.marketHigh || d.marketHigh <= 0) return;
        
        const maxReturn = (d.marketHigh - 100) / 100 * 100;
        
        let guarantee = 'æœªçŸ¥';
        if (d.guarantee) {
            guarantee = d.guarantee.includes('æœ‰') ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
        }
        
        let yearRange = 'æœªçŸ¥';
        if (d.years > 0) {
            if (d.years <= 3) yearRange = '3å¹´æœŸ';
            else if (d.years <= 5) yearRange = '5å¹´æœŸ';
            else yearRange = '7å¹´æœŸ';
        }
        
        let sizeRange = 'æœªçŸ¥';
        if (d.issueSize > 0) {
            if (d.issueSize < 5) sizeRange = 'å°å‹(<5å„„)';
            else if (d.issueSize < 10) sizeRange = 'ä¸­å°å‹(5-10å„„)';
            else if (d.issueSize < 20) sizeRange = 'ä¸­å‹(10-20å„„)';
            else sizeRange = 'å¤§å‹(â‰¥20å„„)';
        }
        
        let capitalRange = 'æœªçŸ¥';
        if (d.capital > 0) {
            if (d.capital < 20) capitalRange = 'å°å‹(<20å„„)';
            else if (d.capital < 50) capitalRange = 'ä¸­å‹(20-50å„„)';
            else if (d.capital < 100) capitalRange = 'ä¸­å¤§å‹(50-100å„„)';
            else capitalRange = 'å¤§å‹(â‰¥100å„„)';
        }
        
        allWithPerf.push({
            ...d,
            maxReturn,
            guarantee,
            yearRange,
            sizeRange,
            capitalRange,
            type: 'è©¢åœˆ'
        });
    });
    
    if (allWithPerf.length < 30) {
        window.qualityConditions = []; // ç¢ºä¿è¨­å®šç©ºé™£åˆ—
        return `<div class="trait-analysis" style="grid-column: 1 / -1;">
            <div class="trait-analysis-title">ğŸ”¬ å¤šç¶­åº¦äº¤é›†åˆ†æ</div>
            <div style="color:#999; padding:20px; text-align:center;">æ¨£æœ¬æ•¸ä¸è¶³ï¼Œç„¡æ³•é€²è¡Œåˆ†æ</div>
        </div>`;
    }
    
    // æŒ‰å ±é…¬æ’åºï¼Œå–å‰30%ç‚ºç¸¾å„ªçµ„
    const sorted = [...allWithPerf].sort((a, b) => b.maxReturn - a.maxReturn);
    const topCount = Math.ceil(sorted.length * 0.3);
    const topPerformers = sorted.slice(0, topCount);
    
    // å®šç¾©è¦æ¸¬è©¦çš„æ¢ä»¶çµ„åˆ
    const conditionSets = [
        { name: 'æœ‰æ“”ä¿ + 5å¹´æœŸ', check: d => d.guarantee === 'æœ‰æ“”ä¿' && d.yearRange === '5å¹´æœŸ' },
        { name: 'æœ‰æ“”ä¿ + 3å¹´æœŸ', check: d => d.guarantee === 'æœ‰æ“”ä¿' && d.yearRange === '3å¹´æœŸ' },
        { name: 'ç„¡æ“”ä¿ + 5å¹´æœŸ + ä¸­å‹è¦æ¨¡', check: d => d.guarantee === 'ç„¡æ“”ä¿' && d.yearRange === '5å¹´æœŸ' && d.sizeRange === 'ä¸­å‹(10-20å„„)' },
        { name: 'ç„¡æ“”ä¿ + 5å¹´æœŸ + ä¸­å°å‹è¦æ¨¡', check: d => d.guarantee === 'ç„¡æ“”ä¿' && d.yearRange === '5å¹´æœŸ' && d.sizeRange === 'ä¸­å°å‹(5-10å„„)' },
        { name: 'ç„¡æ“”ä¿ + ä¸­å‹è¦æ¨¡', check: d => d.guarantee === 'ç„¡æ“”ä¿' && d.sizeRange === 'ä¸­å‹(10-20å„„)' },
        { name: 'ç„¡æ“”ä¿ + 5å¹´æœŸ', check: d => d.guarantee === 'ç„¡æ“”ä¿' && d.yearRange === '5å¹´æœŸ' },
        { name: 'ç„¡æ“”ä¿ + 3å¹´æœŸ', check: d => d.guarantee === 'ç„¡æ“”ä¿' && d.yearRange === '3å¹´æœŸ' },
        { name: 'æœ‰æ“”ä¿ + ä¸­å°å‹è¦æ¨¡', check: d => d.guarantee === 'æœ‰æ“”ä¿' && d.sizeRange === 'ä¸­å°å‹(5-10å„„)' },
        { name: '5å¹´æœŸ + ä¸­å‹è‚¡æœ¬', check: d => d.yearRange === '5å¹´æœŸ' && d.capitalRange === 'ä¸­å‹(20-50å„„)' },
        { name: '5å¹´æœŸ + ä¸­å¤§å‹è‚¡æœ¬', check: d => d.yearRange === '5å¹´æœŸ' && d.capitalRange === 'ä¸­å¤§å‹(50-100å„„)' },
    ];
    
    // è¨ˆç®—å„æ¢ä»¶çµ„åˆçš„è¡¨ç¾
    const conditionResults = [];
    
    conditionSets.forEach(cond => {
        const matchingAll = allWithPerf.filter(cond.check);
        const matchingTop = topPerformers.filter(cond.check);
        
        if (matchingAll.length >= 5) {
            const avgReturn = matchingAll.reduce((s, d) => s + d.maxReturn, 0) / matchingAll.length;
            const topRatio = matchingTop.length / matchingAll.length * 100;
            
            conditionResults.push({
                name: cond.name,
                check: cond.check,
                totalCount: matchingAll.length,
                topCount: matchingTop.length,
                topRatio: topRatio,
                avgReturn: avgReturn
            });
        }
    });
    
    // æŒ‰ç¸¾å„ªä½”æ¯”æ’åº
    conditionResults.sort((a, b) => b.topRatio - a.topRatio);
    
    // åªå–ç¸¾å„ªç‡è¶…éæ•´é«”å¹³å‡(30%)çš„æ¢ä»¶çµ„åˆ
    const goodCombos = conditionResults.filter(r => r.topRatio > 30);
    
    // å„²å­˜åˆ°å…¨å±€è®Šæ•¸ä¾›æ½›åŠ›æ¨™çš„ç¯©é¸ä½¿ç”¨
    window.qualityConditions = goodCombos.slice(0, 5);
    
    let html = `
    <div class="trait-analysis" style="grid-column: 1 / -1;">
        <div class="trait-analysis-title">ğŸ”¬ å¤šç¶­åº¦äº¤é›†åˆ†æ - å„ªè³ªæ¢ä»¶çµ„åˆ</div>
        <div class="trait-explanation">
            åˆ†æ ${allWithPerf.length} ç­†æ­·å²æ•¸æ“šï¼Œæ‰¾å‡ºç¸¾æ•ˆå‰30%æ¨™çš„çš„å…±åŒæ¢ä»¶çµ„åˆã€‚<br>
            <b>ç¸¾å„ªç‡</b> = ç¬¦åˆè©²æ¢ä»¶çš„æ¨™çš„ä¸­ï¼Œæœ‰å¤šå°‘æ¯”ä¾‹é€²å…¥ç¸¾æ•ˆå‰30%ã€‚ç¸¾å„ªç‡è¶Šé«˜ï¼Œè©²æ¢ä»¶çµ„åˆçš„æŠ•è³‡åƒè€ƒåƒ¹å€¼è¶Šé«˜ã€‚
        </div>
        
        <div class="combo-cards">`;
    
    if (goodCombos.length === 0) {
        html += `<div style="color:#999; padding:20px; text-align:center; width:100%;">ç„¡é¡¯è‘—å„ªæ–¼å¹³å‡çš„æ¢ä»¶çµ„åˆ</div>`;
    } else {
        goodCombos.slice(0, 5).forEach((combo, idx) => {
            const starCount = combo.topRatio >= 50 ? 'â­â­â­' : (combo.topRatio >= 40 ? 'â­â­' : 'â­');
            html += `
            <div class="combo-card">
                <div class="combo-card-name">${starCount} ${combo.name}</div>
                <div class="combo-card-return">ç¸¾å„ªç‡ ${combo.topRatio.toFixed(0)}%</div>
                <div class="combo-card-sample">å¹³å‡å ±é…¬ +${combo.avgReturn.toFixed(0)}% (${combo.totalCount}ç­†)</div>
            </div>`;
        });
    }
    
    html += `
        </div>
        
        <div class="trait-insights" style="margin-top:15px;">
            <div class="insight-title">ğŸ“Š æ¢ä»¶çµ„åˆå®Œæ•´æ’å</div>
            <div style="overflow-x:auto;">
                <table class="potential-table" style="margin-top:10px;">
                    <tr>
                        <th>æ’å</th>
                        <th>æ¢ä»¶çµ„åˆ</th>
                        <th>æ¨£æœ¬æ•¸</th>
                        <th>ç¸¾å„ªæ•¸</th>
                        <th>ç¸¾å„ªç‡</th>
                        <th>å¹³å‡å ±é…¬</th>
                    </tr>`;
    
    conditionResults.slice(0, 10).forEach((r, idx) => {
        const highlight = r.topRatio > 30 ? 'style="background:#e8f5e9;"' : '';
        html += `
                    <tr ${highlight}>
                        <td>${idx + 1}</td>
                        <td style="text-align:left; font-weight:bold;">${r.name}</td>
                        <td>${r.totalCount}</td>
                        <td>${r.topCount}</td>
                        <td style="font-weight:bold; color:${r.topRatio > 30 ? '#2e7d32' : '#666'};">${r.topRatio.toFixed(1)}%</td>
                        <td class="positive">+${r.avgReturn.toFixed(1)}%</td>
                    </tr>`;
    });
    
    html += `
                </table>
            </div>
            <div style="font-size:11px; color:#666; margin-top:8px;">
                ğŸ’¡ ç¶ è‰²åº•è‰²è¡¨ç¤ºç¸¾å„ªç‡è¶…é30%(æ•´é«”å¹³å‡)ï¼Œç‚ºç›¸å°æœ‰åˆ©çš„æ¢ä»¶çµ„åˆ
            </div>
        </div>
    </div>`;
    
    return html;
}

// v3.52: æ½›åŠ›æ¨™çš„ç¯©é¸ï¼ˆæ ¹æ“šå„ªè³ªæ¢ä»¶çµ„åˆç¯©é¸ç›®å‰æ›ç‰Œæ¨™çš„ï¼‰
function generatePotentialScreening() {
    // ç¢ºä¿æœ‰å„ªè³ªæ¢ä»¶çµ„åˆ
    if (!window.qualityConditions || window.qualityConditions.length === 0) {
        return '';
    }
    
    // ç¢ºä¿æœ‰09å·¥ä½œè¡¨è³‡æ–™
    if (!window.currentListingData || window.currentListingData.length === 0) {
        return `
        <div class="potential-screening" style="grid-column: 1 / -1;">
            <div class="potential-screening-title">ğŸ¯ æ½›åŠ›æ¨™çš„ç¯©é¸</div>
            <div style="color:#999; padding:20px; text-align:center;">éœ€è¦09å·¥ä½œè¡¨è³‡æ–™é€²è¡Œç¯©é¸</div>
        </div>`;
    }
    
    const listingData = window.currentListingData;
    const qualityCombos = window.qualityConditions;
    
    // ç‚ºæ¯å€‹æ›ç‰Œæ¨™çš„æª¢æŸ¥ç¬¦åˆå“ªäº›å„ªè³ªæ¢ä»¶
    const matchedCandidates = [];
    
    listingData.forEach(row => {
        const id = row['ä»£ç¢¼'] || '';
        const name = (row['åç¨±  '] || row['åç¨±'] || '').trim();
        const price = parseFloat(row['CBæ”¶ç›¤åƒ¹']) || 0;
        const premium = parseFloat(row['æº¢(æŠ˜)åƒ¹%']) || 0;
        const industry = row['ç”¢æ¥­'] || '';
        const tcri = row['TCRI'] || '';
        const guaranteeRaw = row['å‚µåˆ¸æ“”ä¿æƒ…å½¢'] || '';
        const totalShares = parseFloat(row['ç™¼è¡Œç¸½é‡(å¼µ)']) || 0;
        const issueSize = totalShares / 10000;
        
        // è¨ˆç®—å¹´æœŸ
        const issueDate = row['ç™¼è¡Œæ—¥'];
        const maturityDate = row['åˆ°æœŸæ—¥'];
        let years = 0;
        if (issueDate && maturityDate) {
            const start = typeof issueDate === 'number' ? issueDate : 0;
            const end = typeof maturityDate === 'number' ? maturityDate : 0;
            if (start > 0 && end > 0) {
                years = Math.round((end - start) / 365);
            }
        }
        
        // æ¨™æº–åŒ–ç‚ºèˆ‡åˆ†æç›¸åŒçš„æ ¼å¼
        const guarantee = guaranteeRaw === 'ç„¡' || guaranteeRaw.includes('ç„¡') ? 'ç„¡æ“”ä¿' : 'æœ‰æ“”ä¿';
        
        let yearRange = 'æœªçŸ¥';
        if (years > 0) {
            if (years <= 3) yearRange = '3å¹´æœŸ';
            else if (years <= 6) yearRange = '5å¹´æœŸ';
            else yearRange = '7å¹´æœŸ';
        }
        
        let sizeRange = 'æœªçŸ¥';
        if (issueSize > 0) {
            if (issueSize < 5) sizeRange = 'å°å‹(<5å„„)';
            else if (issueSize < 10) sizeRange = 'ä¸­å°å‹(5-10å„„)';
            else if (issueSize < 20) sizeRange = 'ä¸­å‹(10-20å„„)';
            else sizeRange = 'å¤§å‹(â‰¥20å„„)';
        }
        
        // å»ºç«‹ä¸€å€‹è™›æ“¬å°è±¡ä¾›æ¢ä»¶æª¢æŸ¥
        const checkObj = { guarantee, yearRange, sizeRange };
        
        // æª¢æŸ¥ç¬¦åˆå“ªäº›å„ªè³ªæ¢ä»¶
        const matchedCombos = [];
        qualityCombos.forEach(combo => {
            if (combo.check(checkObj)) {
                matchedCombos.push({
                    name: combo.name,
                    topRatio: combo.topRatio,
                    avgReturn: combo.avgReturn
                });
            }
        });
        
        if (matchedCombos.length > 0) {
            matchedCandidates.push({
                id,
                name,
                price,
                premium,
                industry,
                tcri,
                guarantee,
                yearRange,
                sizeRange: issueSize.toFixed(1) + 'å„„',
                matchedCombos,
                matchCount: matchedCombos.length,
                bestTopRatio: Math.max(...matchedCombos.map(c => c.topRatio)),
                belowPar: price < 100
            });
        }
    });
    
    // æ’åºï¼šå„ªå…ˆä½æ–¼é¢é¡ï¼Œå…¶æ¬¡ç¬¦åˆæ¢ä»¶æ•¸å¤šï¼Œå†æ¬¡ç¸¾å„ªç‡é«˜
    matchedCandidates.sort((a, b) => {
        if (a.belowPar !== b.belowPar) return b.belowPar - a.belowPar;
        if (a.matchCount !== b.matchCount) return b.matchCount - a.matchCount;
        return b.bestTopRatio - a.bestTopRatio;
    });
    
    // åˆ†é›¢ä½æ–¼é¢é¡å’Œé«˜æ–¼é¢é¡çš„æ¨™çš„
    const belowParCandidates = matchedCandidates.filter(c => c.belowPar);
    const aboveParCandidates = matchedCandidates.filter(c => !c.belowPar);
    
    let html = `
    <div class="potential-screening" style="grid-column: 1 / -1;">
        <div class="potential-screening-title">ğŸ¯ æ½›åŠ›æ¨™çš„ç¯©é¸ - ç¬¦åˆå„ªè³ªæ¢ä»¶çµ„åˆ</div>
        
        <div class="good-combos-section">
            <div class="good-combos-title">ğŸ“Œ åƒè€ƒçš„å„ªè³ªæ¢ä»¶çµ„åˆ</div>
            <div class="combo-cards">`;
    
    qualityCombos.slice(0, 4).forEach(combo => {
        html += `
                <div class="combo-card" style="min-width:140px;">
                    <div class="combo-card-name" style="font-size:11px;">${combo.name}</div>
                    <div class="combo-card-return" style="font-size:14px;">ç¸¾å„ªç‡${combo.topRatio.toFixed(0)}%</div>
                </div>`;
    });
    
    html += `
            </div>
        </div>`;
    
    // ä½æ–¼é¢é¡çš„å„ªè³ªæ¨™çš„ï¼ˆé‡é»å€å¡Šï¼‰
    if (belowParCandidates.length > 0) {
        html += `
        <div class="potential-list-section below-par-section">
            <div class="potential-list-title">
                â­ ä½æ–¼é¢é¡çš„å„ªè³ªæ¨™çš„
                <span class="count-badge" style="background:#f44336;">${belowParCandidates.length}æª”</span>
            </div>
            <div class="below-par-note">
                ğŸ’¡ é€™äº›æ¨™çš„ç›®å‰åƒ¹æ ¼ä½æ–¼100å…ƒï¼ŒåŒæ™‚ç¬¦åˆæ­·å²ç¸¾å„ªæ¢ä»¶çµ„åˆï¼Œåƒ¹æ ¼è‹¥æŒçºŒä¸‹æ¢å¯ç´å…¥è§€å¯Ÿ
            </div>
            <table class="potential-table">
                <tr>
                    <th>æ¨™çš„</th>
                    <th>åƒ¹æ ¼</th>
                    <th>æº¢åƒ¹%</th>
                    <th>ç”¢æ¥­</th>
                    <th>æ¢ä»¶</th>
                    <th>ç¬¦åˆçµ„åˆ</th>
                </tr>`;
        
        belowParCandidates.slice(0, 15).forEach(c => {
            const comboNames = c.matchedCombos.map(m => m.name).join('ã€');
            html += `
                <tr>
                    <td class="name-cell">${c.name}<br><small style="color:#999;">${c.id}</small></td>
                    <td class="price-cell below-par">${c.price}</td>
                    <td>${c.premium}%</td>
                    <td style="font-size:10px;">${c.industry}</td>
                    <td style="font-size:10px;">${c.guarantee}/${c.yearRange}/${c.sizeRange}</td>
                    <td class="combo-cell">${comboNames}</td>
                </tr>`;
        });
        
        html += `
            </table>
        </div>`;
    }
    
    // å…¶ä»–ç¬¦åˆæ¢ä»¶çš„æ¨™çš„
    if (aboveParCandidates.length > 0) {
        html += `
        <div class="potential-list-section">
            <div class="potential-list-title">
                ğŸ“‹ å…¶ä»–ç¬¦åˆå„ªè³ªæ¢ä»¶çš„æ¨™çš„
                <span class="count-badge">${aboveParCandidates.length}æª”</span>
            </div>
            <table class="potential-table">
                <tr>
                    <th>æ¨™çš„</th>
                    <th>åƒ¹æ ¼</th>
                    <th>æº¢åƒ¹%</th>
                    <th>ç”¢æ¥­</th>
                    <th>ç¬¦åˆçµ„åˆ</th>
                </tr>`;
        
        aboveParCandidates.slice(0, 10).forEach(c => {
            const mainCombo = c.matchedCombos[0].name;
            html += `
                <tr>
                    <td class="name-cell">${c.name}</td>
                    <td class="price-cell">${c.price}</td>
                    <td>${c.premium}%</td>
                    <td style="font-size:10px;">${c.industry}</td>
                    <td class="combo-cell">${mainCombo}${c.matchCount > 1 ? ` (+${c.matchCount-1})` : ''}</td>
                </tr>`;
        });
        
        if (aboveParCandidates.length > 10) {
            html += `<tr><td colspan="5" style="text-align:center; color:#666;">...é‚„æœ‰ ${aboveParCandidates.length - 10} æª”</td></tr>`;
        }
        
        html += `
            </table>
        </div>`;
    }
    
    if (matchedCandidates.length === 0) {
        html += `
        <div style="color:#999; padding:20px; text-align:center;">
            ç›®å‰ç„¡ç¬¦åˆå„ªè³ªæ¢ä»¶çµ„åˆçš„æ›ç‰Œæ¨™çš„
        </div>`;
    }
    
    html += `
        <div style="font-size:11px; color:#666; margin-top:10px; padding:10px; background:white; border-radius:6px;">
            âš ï¸ <b>å…è²¬è²æ˜</b>ï¼šä»¥ä¸Šç¯©é¸åƒ…ä¾›åƒè€ƒï¼Œä¿‚æ ¹æ“šæ­·å²æ•¸æ“šåˆ†ææ‰€å¾—ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚æŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è‡ªè¡Œè©•ä¼°ã€‚
        </div>
    </div>`;
    
    return html;
}

// v3.52: ç”Ÿæˆå¹´åº¦ç¸¾æ•ˆåˆ†æï¼ˆæ¯å¹´åˆ†åˆ¥é¡¯ç¤ºå‰5åï¼‰
function generateYearlyPerformance() {
    const years = [2022, 2023, 2024, 2025];
    
    // ç«¶æ‹ç¸¾æ•ˆè¨ˆç®— - æŒ‰å¹´åº¦åˆ†çµ„
    const auctionByYear = {};
    years.forEach(y => auctionByYear[y] = []);
    
    auctionRawData.forEach(d => {
        if (!d.listingYear || d.listingYear < 2022) return;
        if (!d.minBidPrice || d.minBidPrice <= 0) return;
        if (!d.marketHigh || d.marketHigh <= 0) return;
        
        const year = d.listingYear;
        const highReturn = (d.marketHigh - d.minBidPrice) / d.minBidPrice * 100;
        const lowReturn = d.marketLow > 0 ? (d.marketLow - d.minBidPrice) / d.minBidPrice * 100 : 0;
        
        if (auctionByYear[year]) {
            auctionByYear[year].push({
                name: d.name || d.id,
                highReturn: highReturn,
                lowReturn: lowReturn
            });
        }
    });
    
    // è©¢åœˆç¸¾æ•ˆè¨ˆç®— - æŒ‰å¹´åº¦åˆ†çµ„
    const inquiryByYear = {};
    years.forEach(y => inquiryByYear[y] = []);
    
    inquiryRawData.forEach(d => {
        if (!d.listingYear || d.listingYear < 2022) return;
        if (!d.marketHigh || d.marketHigh <= 0) return;
        
        const year = d.listingYear;
        const highReturn = (d.marketHigh - 100) / 100 * 100;
        const lowReturn = d.marketLow > 0 ? (d.marketLow - 100) / 100 * 100 : 0;
        
        if (inquiryByYear[year]) {
            inquiryByYear[year].push({
                name: d.name || d.id,
                highReturn: highReturn,
                lowReturn: lowReturn
            });
        }
    });
    
    const formatReturn = (val) => {
        if (val === null || val === undefined || isNaN(val)) return '-';
        const cls = val >= 0 ? 'positive' : 'negative';
        const sign = val >= 0 ? '+' : '';
        return `<span class="${cls}">${sign}${val.toFixed(1)}%</span>`;
    };
    
    const formatRankItem = (item, index, field) => {
        const val = item[field];
        const cls = val >= 0 ? 'positive' : 'negative';
        const sign = val >= 0 ? '+' : '';
        return `<span class="ranking-item">${index+1}.${item.name}<span class="return ${cls}">${sign}${val.toFixed(0)}%</span></span>`;
    };
    
    let html = `
    <div class="yearly-performance" style="grid-column: 1 / -1;">
        <div class="yearly-performance-title">ğŸ“Š å„å¹´åº¦æ›ç‰Œç¸¾æ•ˆåˆ†æ</div>
        
        <!-- ç«¶æ‹ç¸¾æ•ˆ -->
        <div class="yearly-section">
            <div class="yearly-section-title">ğŸ¯ ç«¶æ‹ç¸¾æ•ˆæ’è¡Œ (å¾—æ¨™â†’æ›ç‰Œ)</div>`;
    
    years.forEach(year => {
        const data = auctionByYear[year];
        if (!data || data.length === 0) return;
        
        const avgHigh = data.reduce((s, d) => s + d.highReturn, 0) / data.length;
        const avgLow = data.reduce((s, d) => s + d.lowReturn, 0) / data.length;
        
        const bestByHigh = [...data].sort((a, b) => b.highReturn - a.highReturn).slice(0, 5);
        const worstByLow = [...data].sort((a, b) => a.lowReturn - b.lowReturn).slice(0, 5);
        
        html += `
            <div class="year-block">
                <div class="year-block-header">
                    <span class="year-badge">${year}å¹´</span>
                    <span class="year-stats">${data.length}æª” | å¹³å‡æ›ç‰Œé«˜${formatReturn(avgHigh)} | å¹³å‡æ›ç‰Œä½${formatReturn(avgLow)}</span>
                </div>
                <div class="year-rankings">
                    <div class="rank-col">
                        <div class="rank-label best">ğŸ† æœ€ä½³5æª”</div>
                        <div class="rank-list">${bestByHigh.map((d, i) => formatRankItem(d, i, 'highReturn')).join('')}</div>
                    </div>
                    <div class="rank-col">
                        <div class="rank-label worst">ğŸ“‰ æœ€å·®5æª”</div>
                        <div class="rank-list">${worstByLow.map((d, i) => formatRankItem(d, i, 'lowReturn')).join('')}</div>
                    </div>
                </div>
            </div>`;
    });
    
    html += `</div>
        
        <!-- è©¢åœˆç¸¾æ•ˆ -->
        <div class="yearly-section">
            <div class="yearly-section-title">ğŸ“‹ è©¢åœˆç¸¾æ•ˆæ’è¡Œ (ç™¼è¡Œåƒ¹100å…ƒâ†’æ›ç‰Œ)</div>`;
    
    years.forEach(year => {
        const data = inquiryByYear[year];
        if (!data || data.length === 0) return;
        
        const avgHigh = data.reduce((s, d) => s + d.highReturn, 0) / data.length;
        const avgLow = data.reduce((s, d) => s + d.lowReturn, 0) / data.length;
        
        const bestByHigh = [...data].sort((a, b) => b.highReturn - a.highReturn).slice(0, 5);
        const worstByLow = [...data].sort((a, b) => a.lowReturn - b.lowReturn).slice(0, 5);
        
        html += `
            <div class="year-block">
                <div class="year-block-header">
                    <span class="year-badge inquiry">${year}å¹´</span>
                    <span class="year-stats">${data.length}æª” | å¹³å‡æ›ç‰Œé«˜${formatReturn(avgHigh)} | å¹³å‡æ›ç‰Œä½${formatReturn(avgLow)}</span>
                </div>
                <div class="year-rankings">
                    <div class="rank-col">
                        <div class="rank-label best">ğŸ† æœ€ä½³5æª”</div>
                        <div class="rank-list">${bestByHigh.map((d, i) => formatRankItem(d, i, 'highReturn')).join('')}</div>
                    </div>
                    <div class="rank-col">
                        <div class="rank-label worst">ğŸ“‰ æœ€å·®5æª”</div>
                        <div class="rank-list">${worstByLow.map((d, i) => formatRankItem(d, i, 'lowReturn')).join('')}</div>
                    </div>
                </div>
            </div>`;
    });
    
    html += `</div>
    </div>`;
    
    return html;
}

// v3.52: è¿‘æœŸç¸¾æ•ˆæ’è¡Œï¼ˆè¿‘åŠå¹´ã€è¿‘ä¸€å¹´ï¼‰
function generateRecentPerformance() {
    const now = new Date();
    const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
    const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
    
    // ç«¶æ‹è¿‘æœŸç¸¾æ•ˆ
    const auctionRecent = auctionRawData.filter(d => {
        if (!d.listingDate || !d.minBidPrice || d.minBidPrice <= 0) return false;
        if (!d.marketHigh || d.marketHigh <= 0) return false;
        return true;
    }).map(d => {
        const highReturn = (d.marketHigh - d.minBidPrice) / d.minBidPrice * 100;
        const lowReturn = d.marketLow > 0 ? (d.marketLow - d.minBidPrice) / d.minBidPrice * 100 : 0;
        return {
            name: d.name || d.id,
            listingDate: d.listingDate,
            highReturn: highReturn,
            lowReturn: lowReturn
        };
    });
    
    // è©¢åœˆè¿‘æœŸç¸¾æ•ˆ
    const inquiryRecent = inquiryRawData.filter(d => {
        if (!d.listingDate) return false;
        if (!d.marketHigh || d.marketHigh <= 0) return false;
        return true;
    }).map(d => {
        const highReturn = (d.marketHigh - 100) / 100 * 100;
        const lowReturn = d.marketLow > 0 ? (d.marketLow - 100) / 100 * 100 : 0;
        return {
            name: d.name || d.id,
            listingDate: d.listingDate,
            highReturn: highReturn,
            lowReturn: lowReturn
        };
    });
    
    // éæ¿¾è¿‘åŠå¹´å’Œè¿‘ä¸€å¹´
    const filterByDate = (arr, cutoffDate) => {
        return arr.filter(d => {
            if (!d.listingDate) return false;
            let date;
            if (typeof d.listingDate === 'number') {
                date = new Date((d.listingDate - 25569) * 86400 * 1000);
            } else {
                date = new Date(d.listingDate);
            }
            return date >= cutoffDate;
        });
    };
    
    const auction6m = filterByDate(auctionRecent, sixMonthsAgo);
    const auction1y = filterByDate(auctionRecent, oneYearAgo);
    const inquiry6m = filterByDate(inquiryRecent, sixMonthsAgo);
    const inquiry1y = filterByDate(inquiryRecent, oneYearAgo);
    
    const formatRankItem = (item, index, field) => {
        const val = item[field];
        const cls = val >= 0 ? 'positive' : 'negative';
        const sign = val >= 0 ? '+' : '';
        return `<span class="ranking-item">${index+1}.${item.name}<span class="return ${cls}">${sign}${val.toFixed(0)}%</span></span>`;
    };
    
    const generatePeriodBlock = (title, auctionData, inquiryData, badgeClass) => {
        let html = `<div class="period-block">
            <div class="period-header"><span class="period-badge ${badgeClass}">${title}</span></div>
            <div class="period-content">`;
        
        // ç«¶æ‹
        if (auctionData.length > 0) {
            const best = [...auctionData].sort((a, b) => b.highReturn - a.highReturn).slice(0, 5);
            const worst = [...auctionData].sort((a, b) => a.lowReturn - b.lowReturn).slice(0, 5);
            html += `
                <div class="period-section">
                    <div class="period-section-title">ğŸ¯ ç«¶æ‹ (${auctionData.length}æª”)</div>
                    <div class="period-rankings">
                        <div class="rank-col-sm">
                            <div class="rank-label-sm best">ğŸ† æœ€ä½³</div>
                            <div class="rank-list-sm">${best.map((d, i) => formatRankItem(d, i, 'highReturn')).join('')}</div>
                        </div>
                        <div class="rank-col-sm">
                            <div class="rank-label-sm worst">ğŸ“‰ æœ€å·®</div>
                            <div class="rank-list-sm">${worst.map((d, i) => formatRankItem(d, i, 'lowReturn')).join('')}</div>
                        </div>
                    </div>
                </div>`;
        }
        
        // è©¢åœˆ
        if (inquiryData.length > 0) {
            const best = [...inquiryData].sort((a, b) => b.highReturn - a.highReturn).slice(0, 5);
            const worst = [...inquiryData].sort((a, b) => a.lowReturn - b.lowReturn).slice(0, 5);
            html += `
                <div class="period-section">
                    <div class="period-section-title">ğŸ“‹ è©¢åœˆ (${inquiryData.length}æª”)</div>
                    <div class="period-rankings">
                        <div class="rank-col-sm">
                            <div class="rank-label-sm best">ğŸ† æœ€ä½³</div>
                            <div class="rank-list-sm">${best.map((d, i) => formatRankItem(d, i, 'highReturn')).join('')}</div>
                        </div>
                        <div class="rank-col-sm">
                            <div class="rank-label-sm worst">ğŸ“‰ æœ€å·®</div>
                            <div class="rank-list-sm">${worst.map((d, i) => formatRankItem(d, i, 'lowReturn')).join('')}</div>
                        </div>
                    </div>
                </div>`;
        }
        
        html += `</div></div>`;
        return html;
    };
    
    let html = `
    <div class="recent-performance" style="grid-column: 1 / -1;">
        <div class="recent-performance-title">â±ï¸ è¿‘æœŸæ›ç‰Œç¸¾æ•ˆæ’è¡Œ</div>
        <div class="period-container">
            ${generatePeriodBlock('è¿‘åŠå¹´', auction6m, inquiry6m, 'hot')}
            ${generatePeriodBlock('è¿‘ä¸€å¹´', auction1y, inquiry1y, 'warm')}
        </div>
    </div>`;
    
    return html;
}

// v3.52: æŠ•æ¨™ç†±åº¦ vs ç¸¾æ•ˆåˆ†æ
function generateBidHeatAnalysis() {
    const years = [2022, 2023, 2024, 2025];
    
    // æ”¶é›†æœ‰æŠ•æ¨™å€æ•¸å’Œç¸¾æ•ˆçš„è³‡æ–™
    const dataByYear = {};
    years.forEach(y => dataByYear[y] = []);
    
    auctionRawData.forEach(d => {
        if (!d.listingYear || d.listingYear < 2022) return;
        if (!d.bidMultiple || d.bidMultiple <= 0) return;
        if (!d.minBidPrice || d.minBidPrice <= 0) return;
        if (!d.marketHigh || d.marketHigh <= 0) return;
        
        const highReturn = (d.marketHigh - d.minBidPrice) / d.minBidPrice * 100;
        const lowReturn = d.marketLow > 0 ? (d.marketLow - d.minBidPrice) / d.minBidPrice * 100 : 0;
        
        dataByYear[d.listingYear].push({
            name: d.name || d.id,
            bidMultiple: d.bidMultiple,
            highReturn: highReturn,
            lowReturn: lowReturn
        });
    });
    
    // åˆ†ææ¯å¹´çš„ç†±åº¦èˆ‡ç¸¾æ•ˆé—œä¿‚
    const analyzeHeatVsPerformance = (data) => {
        if (data.length < 4) return null;
        
        // æŒ‰æŠ•æ¨™å€æ•¸æ’åºï¼Œåˆ†æˆé«˜ç†±åº¦å’Œä½ç†±åº¦å…©çµ„
        const sorted = [...data].sort((a, b) => b.bidMultiple - a.bidMultiple);
        const midPoint = Math.floor(sorted.length / 2);
        const hotGroup = sorted.slice(0, midPoint);
        const coldGroup = sorted.slice(midPoint);
        
        // è¨ˆç®—å„çµ„å¹³å‡ç¸¾æ•ˆ
        const hotAvgHigh = hotGroup.reduce((s, d) => s + d.highReturn, 0) / hotGroup.length;
        const hotAvgLow = hotGroup.reduce((s, d) => s + d.lowReturn, 0) / hotGroup.length;
        const coldAvgHigh = coldGroup.reduce((s, d) => s + d.highReturn, 0) / coldGroup.length;
        const coldAvgLow = coldGroup.reduce((s, d) => s + d.lowReturn, 0) / coldGroup.length;
        
        // è¨ˆç®—ç›¸é—œä¿‚æ•¸
        const n = data.length;
        const sumX = data.reduce((s, d) => s + d.bidMultiple, 0);
        const sumY = data.reduce((s, d) => s + d.highReturn, 0);
        const sumXY = data.reduce((s, d) => s + d.bidMultiple * d.highReturn, 0);
        const sumX2 = data.reduce((s, d) => s + d.bidMultiple * d.bidMultiple, 0);
        const sumY2 = data.reduce((s, d) => s + d.highReturn * d.highReturn, 0);
        
        const numerator = n * sumXY - sumX * sumY;
        const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
        const correlation = denominator !== 0 ? numerator / denominator : 0;
        
        return {
            total: data.length,
            hotCount: hotGroup.length,
            coldCount: coldGroup.length,
            hotAvgMultiple: hotGroup.reduce((s, d) => s + d.bidMultiple, 0) / hotGroup.length,
            coldAvgMultiple: coldGroup.reduce((s, d) => s + d.bidMultiple, 0) / coldGroup.length,
            hotAvgHigh: hotAvgHigh,
            hotAvgLow: hotAvgLow,
            coldAvgHigh: coldAvgHigh,
            coldAvgLow: coldAvgLow,
            correlation: correlation,
            // æ‰¾å‡ºæœ€ç†±å’Œæœ€å†·çš„æ¨™çš„
            hottest: sorted.slice(0, 3),
            coldest: sorted.slice(-3).reverse()
        };
    };
    
    const formatReturn = (val) => {
        const cls = val >= 0 ? 'positive' : 'negative';
        const sign = val >= 0 ? '+' : '';
        return `<span class="${cls}">${sign}${val.toFixed(1)}%</span>`;
    };
    
    const getCorrelationDesc = (corr) => {
        if (corr > 0.3) return { text: 'æ­£ç›¸é—œ (è¶Šç†±è¶Šå¥½)', cls: 'corr-positive' };
        if (corr < -0.3) return { text: 'è² ç›¸é—œ (è¶Šç†±è¶Šå·®)', cls: 'corr-negative' };
        return { text: 'ç„¡æ˜é¡¯ç›¸é—œ', cls: 'corr-neutral' };
    };
    
    let html = `
    <div class="heat-analysis" style="grid-column: 1 / -1;">
        <div class="heat-analysis-title">ğŸ”¥ æŠ•æ¨™ç†±åº¦ vs ç¸¾æ•ˆåˆ†æ</div>
        <div class="heat-explanation">
            æŠ•æ¨™å€æ•¸ = æŠ•æ¨™å¼µæ•¸ Ã· ç«¶æ‹å¼µæ•¸ï¼Œæ•¸å€¼è¶Šé«˜ä»£è¡¨å¸‚å ´è¿½æ§ç¨‹åº¦è¶Šç†±
        </div>
        
        <table class="heat-table">
            <tr>
                <th rowspan="2">å¹´åº¦</th>
                <th rowspan="2">æ¨£æœ¬æ•¸</th>
                <th colspan="3">é«˜ç†±åº¦çµ„ (æŠ•æ¨™å€æ•¸è¼ƒé«˜)</th>
                <th colspan="3">ä½ç†±åº¦çµ„ (æŠ•æ¨™å€æ•¸è¼ƒä½)</th>
                <th rowspan="2">ç›¸é—œæ€§</th>
            </tr>
            <tr>
                <th>å¹³å‡å€æ•¸</th>
                <th>æ›ç‰Œé«˜</th>
                <th>æ›ç‰Œä½</th>
                <th>å¹³å‡å€æ•¸</th>
                <th>æ›ç‰Œé«˜</th>
                <th>æ›ç‰Œä½</th>
            </tr>`;
    
    let allData = [];
    years.forEach(year => {
        const data = dataByYear[year];
        allData = allData.concat(data);
        
        if (data.length < 4) {
            html += `<tr><td class="year-cell">${year}å¹´</td><td colspan="8" style="color:#999;">æ¨£æœ¬ä¸è¶³</td></tr>`;
            return;
        }
        
        const analysis = analyzeHeatVsPerformance(data);
        const corrDesc = getCorrelationDesc(analysis.correlation);
        
        html += `<tr>
            <td class="year-cell">${year}å¹´</td>
            <td>${analysis.total}æª”</td>
            <td><b>${analysis.hotAvgMultiple.toFixed(1)}x</b></td>
            <td>${formatReturn(analysis.hotAvgHigh)}</td>
            <td>${formatReturn(analysis.hotAvgLow)}</td>
            <td><b>${analysis.coldAvgMultiple.toFixed(1)}x</b></td>
            <td>${formatReturn(analysis.coldAvgHigh)}</td>
            <td>${formatReturn(analysis.coldAvgLow)}</td>
            <td class="${corrDesc.cls}">${corrDesc.text}<br><small>(r=${analysis.correlation.toFixed(2)})</small></td>
        </tr>`;
    });
    
    // ç¸½è¨ˆåˆ†æ
    if (allData.length >= 10) {
        const totalAnalysis = analyzeHeatVsPerformance(allData);
        const totalCorrDesc = getCorrelationDesc(totalAnalysis.correlation);
        
        html += `<tr class="total-row">
            <td class="year-cell"><b>ç¸½è¨ˆ</b></td>
            <td><b>${totalAnalysis.total}æª”</b></td>
            <td><b>${totalAnalysis.hotAvgMultiple.toFixed(1)}x</b></td>
            <td>${formatReturn(totalAnalysis.hotAvgHigh)}</td>
            <td>${formatReturn(totalAnalysis.hotAvgLow)}</td>
            <td><b>${totalAnalysis.coldAvgMultiple.toFixed(1)}x</b></td>
            <td>${formatReturn(totalAnalysis.coldAvgHigh)}</td>
            <td>${formatReturn(totalAnalysis.coldAvgLow)}</td>
            <td class="${totalCorrDesc.cls}"><b>${totalCorrDesc.text}</b><br><small>(r=${totalAnalysis.correlation.toFixed(2)})</small></td>
        </tr>`;
    }
    
    html += `</table>
        
        <div class="heat-insight">
            <div class="insight-title">ğŸ’¡ åˆ†ææ´å¯Ÿ</div>
            <div class="insight-content" id="heatInsight"></div>
        </div>
    </div>`;
    
    // å»¶é²å¡«å…¥æ´å¯Ÿï¼ˆå› ç‚ºéœ€è¦ç­‰DOMæ¸²æŸ“ï¼‰
    setTimeout(() => {
        const insightDiv = document.getElementById('heatInsight');
        if (insightDiv && allData.length >= 10) {
            const totalAnalysis = analyzeHeatVsPerformance(allData);
            
            // è¨ˆç®—å„å¹´åº¦çš„é«˜ä½ç†±åº¦å·®ç•°
            let yearInsights = [];
            years.forEach(year => {
                const data = dataByYear[year];
                if (data.length >= 4) {
                    const analysis = analyzeHeatVsPerformance(data);
                    const diff = analysis.hotAvgHigh - analysis.coldAvgHigh;
                    yearInsights.push({
                        year: year,
                        diff: diff,
                        hotAvg: analysis.hotAvgHigh,
                        coldAvg: analysis.coldAvgHigh
                    });
                }
            });
            
            // çµ±è¨ˆæœ‰å¹¾å¹´æ˜¯é«˜ç†±åº¦è´
            const hotWins = yearInsights.filter(y => y.diff > 0).length;
            const totalYears = yearInsights.length;
            
            let insight = `<b>ğŸ“Œ åŒå¹´åº¦å…§æ¯”è¼ƒï¼š</b>`;
            
            if (hotWins >= totalYears * 0.7) {
                insight += `åœ¨ ${totalYears} å€‹å¹´åº¦ä¸­ï¼Œæœ‰ ${hotWins} å¹´æ˜¯<span class="positive">é«˜ç†±åº¦çµ„è¡¨ç¾è¼ƒä½³</span>ã€‚`;
                insight += `<br>é€™èªªæ˜<b>åœ¨åŒä¸€å¹´åº¦å…§ï¼ŒæŠ•æ¨™è¶Šç†±çš„æ¨™çš„ç¢ºå¯¦å‚¾å‘æœ‰è¼ƒå¥½çš„æ›ç‰Œè¡¨ç¾</b>ã€‚å¸‚å ´çš„è¿½æ§å¯èƒ½åæ˜ äº†å°æ¨™çš„åŸºæœ¬é¢çš„èªå¯ã€‚`;
            } else if (hotWins <= totalYears * 0.3) {
                insight += `åœ¨ ${totalYears} å€‹å¹´åº¦ä¸­ï¼Œåªæœ‰ ${hotWins} å¹´æ˜¯é«˜ç†±åº¦çµ„è¡¨ç¾è¼ƒä½³ã€‚`;
                insight += `<br>é€™èªªæ˜<b>æŠ•æ¨™éç†±çš„æ¨™çš„åè€Œå®¹æ˜“è¡¨ç¾ä¸ä½³</b>ï¼Œå¯èƒ½æ˜¯å¸‚å ´éåº¦è¿½æ§å°è‡´æœŸæœ›éé«˜ã€‚`;
            } else {
                insight += `åœ¨ ${totalYears} å€‹å¹´åº¦ä¸­ï¼Œæœ‰ ${hotWins} å¹´æ˜¯é«˜ç†±åº¦çµ„è¡¨ç¾è¼ƒä½³ã€‚`;
                insight += `<br>ç†±åº¦èˆ‡ç¸¾æ•ˆçš„é—œä¿‚å› å¹´åº¦è€Œç•°ï¼Œéœ€çµåˆå…¶ä»–å› ç´ åˆ¤æ–·ã€‚`;
            }
            
            insight += `<br><br><b>âš ï¸ æ³¨æ„ï¼š</b>æ­¤åˆ†æåƒ…é©ç”¨æ–¼<u>åŒå¹´åº¦å…§</u>çš„æ¯”è¼ƒã€‚ä¸åŒå¹´åº¦çš„å¸‚å ´ç’°å¢ƒå·®ç•°å¤§ï¼Œè·¨å¹´åº¦æ¯”è¼ƒç†±åº¦æ„ç¾©ä¸å¤§ã€‚`;
            
            insightDiv.innerHTML = insight;
        }
    }, 100);
    
    return html;
}


function bindInputEvents() {
    const show = (id, html) => { 
        const el = document.getElementById(id); 
        el.innerHTML = html||''; 
        el.style.display = html?'block':'none'; 
    };
    
    // CBåç¨±æœå°‹
    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim(); 
        const histDiv = document.getElementById('historyResults');
        
        if(val.length >= 2) {
            const auctionMatches = auctionRawData.filter(d => {
                const idMatch = d.id && d.id.startsWith(val);
                const stockIdMatch = d.stockId && String(d.stockId).startsWith(val);
                const nameMatch = d.name && d.name.includes(val);
                return idMatch || stockIdMatch || nameMatch;
            }).slice(0, 10);
            
            const inquiryMatches = inquiryRawData.filter(d => {
                const idMatch = d.id && d.id.startsWith(val);
                const nameMatch = d.name && d.name.includes(val);
                return idMatch || nameMatch;
            }).slice(0, 10);
            
            let html = '';
            
            if(inquiryMatches.length > 0) {
                html += `<div class="history-results-title">ğŸ“‹ è©¢åœˆæ¡ˆä¾‹ (${inquiryMatches.length}ç­†)</div>`;
                inquiryMatches.forEach(d => {
                    const h = safeFloat(d.marketHigh);
                    const l = safeFloat(d.marketLow);
                    const amp = (h > 0 && l > 0) ? ((h - l) / l * 100).toFixed(1) : '-';
                    const premium = safeFloat(d.premiumRate);
                    const premiumStr = premium > 0 ? (premium < 2 ? (premium * 100).toFixed(1) : premium.toFixed(1)) : '-';
                    let guarantee = '-';
                    if (d.guarantee) {
                        guarantee = d.guarantee.includes('æœ‰') ? 'æœ‰' : (d.guarantee.includes('ç„¡') ? 'ç„¡' : d.guarantee);
                    }
                    html += `
                    <div class="inquiry-card">
                        <div class="inquiry-line1">
                            <span class="inquiry-badge">è©¢åœˆ</span>
                            <span class="inquiry-name">${d.name || '-'} (${d.id})</span>
                            <span class="inquiry-info iq-size">è¦æ¨¡:<b>${d.issueSize > 0 ? d.issueSize + 'å„„' : '-'}</b></span>
                            <span class="inquiry-info iq-year">å¹´æœŸ:<b>${d.years > 0 ? d.years + 'å¹´' : '-'}</b></span>
                            <span class="inquiry-info iq-guar">æ“”ä¿:<b>${guarantee}</b></span>
                        </div>
                        <div class="inquiry-line2">
                            <span class="inquiry-info iq-high">æ›ç‰Œé«˜:<b>${h > 0 ? safeFixed(h,1) : '-'}</b></span>
                            <span class="inquiry-info iq-low">æ›ç‰Œä½:<b>${l > 0 ? safeFixed(l,1) : '-'}</b></span>
                            <span class="inquiry-info iq-amp">æŒ¯å¹…:<b class="pink">${amp}%</b></span>
                            <span class="inquiry-info iq-prem">æº¢åƒ¹ç‡:<b class="pink">${premiumStr}%</b></span>
                        </div>
                    </div>`;
                });
            }
            
            if(auctionMatches.length > 0) {
                html += `<div class="history-results-title" style="margin-top:${inquiryMatches.length > 0 ? '12px' : '0'}">ğŸ¯ ç«¶æ‹æ¡ˆä¾‹ (${auctionMatches.length}ç­†)</div>`;
                html += auctionMatches.map(d => generateHistoryCard(d)).join('');
            }
            
            if(html) {
                histDiv.innerHTML = html;
                histDiv.style.display = 'block';
            } else {
                histDiv.style.display = 'none';
            }
        } else {
            histDiv.style.display = 'none';
        }

        if (!val) { show('cbNameInfo', null); return; }
        const found = cbNameMap[val] || Object.values(cbDatabase).find(d => d.name && d.name === val);
        if (found) {
            show('cbNameInfo', generateStandardCard({
                'å¹³å‡æœ€ä½å¾—æ¨™åƒ¹': found.minBidPrice,
                'å¹³å‡æœ€ä½æº¢åƒ¹': found.lowPremium,
                'å¹³å‡å¾—æ¨™åƒ¹': found.avgBidPrice,
                'å¹³å‡æº¢åƒ¹': found.avgPremium,
                'å¹³å‡æ›ç‰Œæœ€é«˜': found.marketHigh,
                'å¹³å‡æ›ç‰Œæœ€ä½': found.marketLow,
                'æ¨£æœ¬æ•¸': 1
            }, `${found.name} æ­·å²ç´€éŒ„`));
        } else {
            show('cbNameInfo', null);
        }
    });

    // v3.51 ä¿®æ”¹ï¼šå…¶ä»–æ¬„ä½ç¶å®šï¼Œå‚³å…¥æ’é™¤å‰ä¸‰ + æ“”ä¿é¡å‹ç´°åˆ†
    const bind = (id, cat) => {
        const handler = function() {
            const rawVal = this.value;
            const val = parseFloat(rawVal) || rawVal;
            if (val) {
                let displayTitle = val;
                if(['è‚¡æœ¬','ç™¼è¡Œè¦æ¨¡','è½‰æ›åƒ¹'].includes(cat)) displayTitle = getRangeLabel(cat, val);
                
                const smartResult = getStatsSmart(cat, val);
                // v3.51: å‚³å…¥æ’é™¤å‰ä¸‰ + æ“”ä¿é¡å‹ç´°åˆ†æ•¸æ“š
                show(id+'Info', generateStandardCard(
                    smartResult.rawData, 
                    `å€é–“çµ±è¨ˆ: ${displayTitle}`, 
                    smartResult.inquiryData,
                    smartResult.excludeTop3Data,
                    smartResult.excludeTop3InquiryData,
                    smartResult.guaranteedAuctionData,
                    smartResult.guaranteedInquiryData,
                    smartResult.unguaranteedAuctionData,
                    smartResult.unguaranteedInquiryData
                ));
                if(cat==='è½‰æ›åƒ¹'||cat==='ä¿¡è©•') updateSmartReminders();
            }
        };
        const el = document.getElementById(id); 
        el.addEventListener('change', handler); 
        if(el.tagName==='INPUT') el.addEventListener('input', handler);
    };

    bind('capital','è‚¡æœ¬'); 
    bind('issueSize','ç™¼è¡Œè¦æ¨¡'); 
    bind('conversionPrice','è½‰æ›åƒ¹'); 
    bind('industry','ç”¢æ¥­'); 
    bind('broker','ç™¼è¡Œåˆ¸å•†'); 
    bind('years','å¹´æœŸ'); 
    bind('guarantee','æ“”ä¿'); 
    bind('rating','ä¿¡è©•');
    
    document.getElementById('guarantee').addEventListener('change', function() {
        const val = this.value, div = document.getElementById('marketSentiment');
        if(!val) return;
        const recent = auctionRawData.filter(d=>(d.guarantee||'').includes(val)).slice(-20);
        if(recent.length===0){ div.innerHTML=`<div class="stat-row">ç„¡æ¡ˆä¾‹</div>`; return; }
        const avgP = recent.reduce((s,i)=>s+(i.avgPremium||0),0)/recent.length;
        div.innerHTML=`<div class="stats-header">ğŸŒ¡ï¸ å¸‚å ´æ°›åœ (${val})</div><div class="stat-row">è¿‘ ${recent.length} ç­†å¹³å‡æº¢åƒ¹ï¼š<span style="color:#d32f2f; font-weight:bold;">${avgP.toFixed(2)}%</span></div>`;
        div.style.display='block';
    });
    
    document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
}

function updateSmartReminders() {
    const s = parseFloat(document.getElementById('stockPrice').value);
    const c = parseFloat(document.getElementById('conversionPrice').value);
    const r = document.getElementById('rating').value;
    
    if(s && c) { 
        const t = (s/c)*100; 
        let msg = `ç›®å‰ç†è«–åƒ¹ï¼š<b>${t.toFixed(2)} å…ƒ</b>ã€‚`;
        if(t > 120) msg += " ğŸ”¥ ç†è«–åƒ¹åé«˜ï¼Œæ³¨æ„æº¢åƒ¹é¢¨éšªã€‚";
        else if(t < 95) msg += " ğŸ’¡ ç†è«–åƒ¹å…·å¸å¼•åŠ›ã€‚";
        else msg += " âœ¨ ç†è«–åƒ¹è™•æ–¼åˆç†å€é–“ã€‚";
        
        if(r && ['7','8','9'].includes(r)) msg += "<br>âš ï¸ ä¿¡è©•è¼ƒä½ï¼Œå»ºè­°ä¿å®ˆç­–ç•¥ã€‚";
        
        document.getElementById('reminderContent').innerHTML = msg; 
        document.getElementById('smartReminders').style.display='block'; 
    }
}

function generateRexCommentary(r) { 
    const gap = parseFloat(r.bidPrices.balanced) - parseFloat(r.theoreticalPrice);
    let comment = "";
    if (gap > 20) comment = "å¸‚å ´å°æ­¤é¡æ¨™çš„ç†±æƒ…éé«˜ï¼Œå»ºè­°åš´æ§æˆæœ¬ã€‚";
    else if (gap > 10) comment = "æº¢åƒ¹åˆç†åé«˜ï¼Œé©åˆåœ¨ã€Œå¹³è¡¡ã€èˆ‡ã€Œä¿å®ˆã€é–“å°‹æ‰¾ç”œèœœé»ã€‚";
    else if (gap > 0) comment = "å¸‚å ´ä¼°å€¼ç†æ€§ï¼Œå¯åƒè€ƒã€Œç©æ¥µã€ç­–ç•¥çˆ­å–ç±Œç¢¼ã€‚";
    else comment = "ä¼°å€¼åä½ï¼Œå¯èƒ½å­˜åœ¨æ’¿æ¼æ©Ÿæœƒã€‚";
    return `<div class="rex-analysis"><div class="rex-title">ğŸ§¢ Rexå¤§å”åˆ†æ</div><div class="rex-content"><p>${comment}</p></div></div>`; 
}

function calculateEvaluation(d) {
    const theo = (d.stockPrice/d.conversionPrice)*100;
    const brokerName = d.broker || ""; 
    
    const dims = [
        {k:'industry',c:'ç”¢æ¥­',w:0.25,v:d.industry}, 
        {k:'broker',c:'ç™¼è¡Œåˆ¸å•†',w:0.13,v:brokerName},
        {k:'capital',c:'è‚¡æœ¬',w:0.12,v:d.capital}, 
        {k:'size',c:'ç™¼è¡Œè¦æ¨¡',w:0.10,v:d.issueSize},
        {k:'rating',c:'ä¿¡è©•',w:0.15,v:d.rating}, 
        {k:'guarantee',c:'æ“”ä¿',w:0.12,v:d.guarantee},
        {k:'years',c:'å¹´æœŸ',w:0.08,v:d.years}, 
        {k:'conversion',c:'è½‰æ›åƒ¹',w:0.05,v:d.conversionPrice}
    ];
    
    let wL=0, wA=0, resDims={};
    dims.forEach(x=>{
        const s = getStatsSmart(x.c, x.v), coef = getWeightCoefficient(x.k, x.v);
        resDims[x.k] = { ...s, coefficient: coef, weight: x.w, range: x.v, weightedLow: s.low*x.w*coef, weightedAvg: s.avg*x.w*coef };
        if (s.rawData && s.rawData['å€é–“åç¨±']) resDims[x.k].displayRange = s.rawData['å€é–“åç¨±'];
        else resDims[x.k].displayRange = x.v;
        wL+=resDims[x.k].weightedLow; 
        wA+=resDims[x.k].weightedAvg;
    });
    
    const subR = (d.subjectiveWeight||0)/100, objR = 1-subR;
    const tL = (wL*objR)+((d.subjectiveLowPremium||0)*subR);
    const tA = (wA*objR)+((d.subjectiveAvgPremium||0)*subR);
    const gap = tA-tL;
    
    const p1 = theo*(1+tL/100);
    const p2 = theo*(1+tA/100);
    const p3 = theo*(1+(tA+gap)/100);
    const p4 = theo*(1+(tA+gap*2)/100);

    return {
        cbName:d.cbName, 
        theoreticalPrice:safeFixed(theo), 
        dimensions:resDims, 
        totalLowPremium:safeFixed(tL), 
        totalAvgPremium:safeFixed(tA),
        bidPrices:{ conservative:safeFixed(p1), balanced:safeFixed(p2), aggressive:safeFixed(p3), ultimate:safeFixed(p4) },
        inputData:d, 
        weightedSubjectiveLow:safeFixed(((d.subjectiveLowPremium||0)*subR)), 
        weightedSubjectiveAvg:safeFixed(((d.subjectiveAvgPremium||0)*subR))
    };
}

function displayResult(r) {
    document.getElementById('welcomeMsg').style.display = 'none';
    const div = document.getElementById('evaluationResult'); 
    div.className = 'evaluation-result active';
    
    let rows = ''; 
    const nm={'industry':'ç”¢æ¥­','broker':'åˆ¸å•†','capital':'è‚¡æœ¬','size':'è¦æ¨¡','rating':'ä¿¡è©•','guarantee':'æ“”ä¿','years':'å¹´æœŸ','conversion':'è½‰åƒ¹'};
    
    for(const[k,d] of Object.entries(r.dimensions)) {
        rows+=`<tr>
            <td>${nm[k]}</td>
            <td>${d.displayRange || d.range}</td>
            <td>${safeFixed(d.low)}%</td>
            <td>${safeFixed(d.avg)}%</td>
            <td>${safeFixed(d.weight*100,0)}%</td>
            <td>${safeFixed(d.weightedLow)}</td>
            <td>${safeFixed(d.weightedAvg)}</td>
        </tr>`;
    }
    
    if(r.inputData.subjectiveWeight>0) {
        rows+=`<tr style="background:#fff3e0">
            <td>ä¸»è§€</td><td>è‡ªè¨‚</td>
            <td>${r.inputData.subjectiveLowPremium}%</td>
            <td>${r.inputData.subjectiveAvgPremium}%</td>
            <td>${r.inputData.subjectiveWeight}%</td>
            <td>${r.weightedSubjectiveLow}</td>
            <td>${r.weightedSubjectiveAvg}</td>
        </tr>`;
    }

    rows+=`<tfoot><tr>
        <td></td><td style="text-align:right">åˆè¨ˆ</td>
        <td>-</td><td>-</td><td>100%</td>
        <td>${r.totalLowPremium}%</td>
        <td>${r.totalAvgPremium}%</td>
    </tr></tfoot>`;
    
    div.innerHTML = `
    <div class="result-header"><h2>${r.cbName}</h2><div>AI è©•ä¼°çµæœ</div></div>
    
    <div style="display:flex; gap:20px; flex-wrap:wrap;">
        <div class="detail-section" style="flex:1; min-width:280px;">
            <h3>ğŸ“Š æ ¸å¿ƒæ•¸æ“š</h3>
            <div style="font-size:16px; line-height:2;">
                <div>ç†è«–åƒ¹æ ¼ï¼š<b style="color:#667eea; font-size:20px;">${r.theoreticalPrice}</b> å…ƒ</div>
                <div>é ä¼°æº¢åƒ¹ï¼š<b>${r.totalLowPremium}% ~ ${r.totalAvgPremium}%</b></div>
            </div>
        </div>
        <div class="detail-section" style="flex:2; min-width:280px;">
            <h3>ğŸ“ ç¶­åº¦æ¬Šé‡åˆ†æ</h3>
            <div style="overflow-x:auto;">
                <table class="data-table">
                    <thead><tr>
                        <th>ç¶­åº¦</th><th>æ¢ä»¶</th>
                        <th>æœ€ä½<br>æº¢åƒ¹</th><th>å¹³å‡<br>æº¢åƒ¹</th>
                        <th>æ¬Šé‡</th><th>åŠ æ¬Š<br>æœ€ä½</th><th>åŠ æ¬Š<br>å¹³å‡</th>
                    </tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        </div>
    </div>

    ${generateRexCommentary(r)}
    
    <div class="detail-section">
        <h3>ğŸ’¡ æŠ•æ¨™å»ºè­°åƒ¹æ ¼</h3>
        <div class="price-grid">
            <div class="strategy-card conservative">
                <h4>ğŸ›¡ï¸ ä¿å®ˆ</h4>
                <div class="price">${r.bidPrices.conservative}</div>
                <div style="font-size:12px; color:#666;">è¿½æ±‚é«˜å®‰å…¨é‚Šéš›</div>
            </div>
            <div class="strategy-card balanced">
                <h4>âš–ï¸ å¹³è¡¡</h4>
                <div class="price">${r.bidPrices.balanced}</div>
                <div style="font-size:12px; color:#666;">åƒè€ƒå¸‚å ´å¹³å‡</div>
            </div>
            <div class="strategy-card aggressive">
                <h4>ğŸš€ ç©æ¥µ</h4>
                <div class="price">${r.bidPrices.aggressive}</div>
                <div style="font-size:12px; color:#666;">é¡˜ä»˜æº¢åƒ¹å–ç±Œç¢¼</div>
            </div>
            <div class="strategy-card ultimate">
                <h4>ğŸ”¥ æ¥µè‡´</h4>
                <div class="price">${r.bidPrices.ultimate}</div>
                <div style="font-size:12px; color:#666;">å‹¢åœ¨å¿…å¾—</div>
            </div>
        </div>
    </div>
    <div style="text-align:center;margin-top:25px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button onclick="location.reload()" class="calculate-btn" style="width:180px; background:#555;">ğŸ”„ é‡æ–°è©•ä¼°</button>
        <button onclick="window.print()" class="calculate-btn" style="width:180px;">ğŸ–¨ï¸ åˆ—å°å ±å‘Š</button>
    </div>`;
    
    div.scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    try {
        displayResult(calculateEvaluation({
            cbName: document.getElementById('cbName').value, 
            industry: document.getElementById('industry').value, 
            issueSize: parseFloat(document.getElementById('issueSize').value),
            years: document.getElementById('years').value, 
            guarantee: document.getElementById('guarantee').value, 
            rating: document.getElementById('rating').value,
            capital: parseFloat(document.getElementById('capital').value), 
            stockPrice: parseFloat(document.getElementById('stockPrice').value), 
            conversionPrice: parseFloat(document.getElementById('conversionPrice').value),
            subjectiveWeight: parseFloat(document.getElementById('subjectiveWeight').value)||0, 
            subjectiveLowPremium: parseFloat(document.getElementById('subjectiveLowPremium').value)||0, 
            subjectiveAvgPremium: parseFloat(document.getElementById('subjectiveAvgPremium').value)||0,
            broker: document.getElementById('broker').value 
        }));
    } catch (err) {
        alert("âš ï¸ è¨ˆç®—éŒ¯èª¤ï¼š\n" + err.message);
        console.error(err);
    }
});

// ç³»çµ±å•Ÿå‹•
window.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
});
</script>

</body>
</html>