<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.36 (çµ‚æ¥µæ•¸æ“šå°æ¥ç‰ˆ) - Rexå¤§å”</title>

<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
/* ================= é¢¨æ ¼è¨­å®š ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%); /* æ”¹ç‚ºæ›´å°ˆæ¥­çš„æ·±è—ç´…æ¼¸å±¤ */
    min-height: 100vh; padding: 20px;
}
.container { max-width: 1600px; margin: 0 auto; display: none; }

.header {
    background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.header h1 { color: #b21f1f; font-size: 32px; margin-bottom: 10px; font-weight: 800; }
.header .subtitle { color: #555; font-size: 16px; font-weight: 500; }
.version-badge { display: inline-block; background: #1a2a6c; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }

.evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }

.input-panel {
    background: white; border-radius: 15px; padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2); height: fit-content; position: sticky; top: 20px;
}
.input-panel h2 { color: #1a2a6c; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #1a2a6c; }

.form-section { margin-bottom: 25px; }
.form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; border-left: 4px solid #b21f1f; padding-left: 10px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 600; }
.form-group input, .form-group select {
    width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
}
.form-group input:focus, .form-group select:focus { outline: none; border-color: #b21f1f; }

.info-box {
    background: #f8f9fa; padding: 15px; border-radius: 8px;
    border-left: 5px solid #4CAF50; margin-top: 10px; display: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.stat-value { font-weight: bold; color: #333; }

.calculate-btn {
    width: 100%; padding: 18px; background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
    color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold;
    cursor: pointer; transition: transform 0.2s; margin-top: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.calculate-btn:hover { transform: translateY(-2px); }

.result-panel {
    background: white; border-radius: 15px; padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2); min-height: 600px;
}
.welcome-message { text-align: center; padding: 60px 20px; }
.stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
.stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
.stat-box .number { font-size: 36px; font-weight: bold; color: #1a2a6c; margin-bottom: 10px; }

.evaluation-result { display: none; }
.evaluation-result.active { display: block; animation: fadeIn 0.5s; }

.result-header {
    background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
    color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
}
.detail-section {
    background: white; border-radius: 12px; padding: 30px;
    margin-bottom: 25px; border: 2px solid #e0e0e0;
}
.detail-section h3 { color: #1a2a6c; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #1a2a6c; }

.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; position: relative; overflow: hidden; }
.strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
.strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
.strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
.strategy-card.ultimate { border-color: #9C27B0; background: #f3e5f5; }
.strategy-card .price { font-size: 36px; font-weight: bold; margin: 20px 0; color: #333; }

/* è¡¨æ ¼å„ªåŒ– */
.data-table {
    width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.data-table th {
    background-color: #1a2a6c; color: white; padding: 15px 10px;
    text-align: center; font-weight: bold; border: 1px solid #0d1b5e;
}
.data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tr:hover { background-color: #e8eaf6; }
.val-pos { color: #d32f2f; font-weight: bold; }
.val-neg { color: #388e3c; font-weight: bold; }

/* è¼‰å…¥ç•«é¢ */
#loading {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 9999; color: white; font-size: 24px; font-weight: bold;
}

@media (max-width: 1200px) {
    .evaluation-container { grid-template-columns: 1fr; }
    .input-panel { position: relative; top: 0; }
}
</style>
</head>

<body>

<div id="loading">
    <div>ğŸ”„ æ­£åœ¨é€£ç·š 00_CB.xlsx è³‡æ–™åº«...</div>
    <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æº–å‚™è®€å– Excel</div>
    <div id="error-msg" style="margin-top: 20px; font-size: 14px; color: #ffcdd2; max-width: 80%; text-align: center; white-space: pre-wrap;"></div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.36</span></h1>
        <p class="subtitle" id="headerSubtitle">åˆå§‹åŒ–ä¸­...</p>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                    <div class="form-group">
                        <label>CBåç¨± *</label>
                        <input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ">
                        <div id="cbNameInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>è‚¡æœ¬ (å„„å…ƒ) *</label>
                        <input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80">
                        <div id="capitalInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç”¢æ¥­åˆ†é¡ *</label>
                        <select id="industry" required><option value="">(è®€å–ä¸­)</option></select>
                        <div id="industryInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç™¼è¡Œåˆ¸å•†</label>
                        <select id="broker"><option value="">(è®€å–ä¸­)</option></select>
                        <div id="brokerInfo" class="info-box"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group">
                        <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label>
                        <input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š90">
                        <div id="issueSizeInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š450">
                        <div id="conversionPriceInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç™¼è¡Œå¹´æœŸ *</label>
                        <select id="years" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="3">3å¹´æœŸ</option>
                            <option value="5">5å¹´æœŸ</option>
                            <option value="7">7å¹´æœŸ</option>
                        </select>
                        <div id="yearsInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>æ“”ä¿æƒ…æ³ *</label>
                        <select id="guarantee" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                            <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                        </select>
                        <div id="guaranteeInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                        <select id="rating" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="1">TCRI 1</option>
                            <option value="2">TCRI 2</option>
                            <option value="3">TCRI 3</option>
                            <option value="4">TCRI 4</option>
                            <option value="5">TCRI 5</option>
                            <option value="6">TCRI 6</option>
                            <option value="7">TCRI 7</option>
                            <option value="8">TCRI 8</option>
                            <option value="9">TCRI 9</option>
                            <option value="BBB">BBBç´š</option>
                        </select>
                        <div id="ratingInfo" class="info-box"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                    <div class="form-group">
                        <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                    </div>
                </div>

                <div class="form-section" style="background: #fff8e1; border: 2px solid #ffc107; border-radius: 12px; padding: 20px; margin: 25px 0;">
                    <h3 style="color: #ff9800; border-left-color: #ff9800;">âš–ï¸ ä¸»è§€æ¬Šé‡èª¿æ•´ï¼ˆé¸å¡«ï¼‰</h3>
                    <div class="form-group">
                        <label>ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label>
                        <input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0" placeholder="0-100ï¼Œé è¨­0">
                    </div>
                    <div class="form-group">
                        <label>ä¸»è§€æœ€ä½æº¢åƒ¹ç‡ (%)</label>
                        <input type="number" id="subjectiveLowPremium" step="0.1" value="0" placeholder="ä¾‹å¦‚ï¼š5.0">
                    </div>
                    <div class="form-group">
                        <label>ä¸»è§€å¹³å‡æº¢åƒ¹ç‡ (%)</label>
                        <input type="number" id="subjectiveAvgPremium" step="0.1" value="0" placeholder="ä¾‹å¦‚ï¼š8.0">
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ“Š è¿‘æœŸå¸‚å ´ç«¶æ‹æ°›åœ</h3>
                    <div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;">
                        <div class="stats-header" style="color:#1976D2;">ğŸŒ¡ï¸ å‹•æ…‹å¸‚å ´æ°›åœåˆ†æ</div>
                        <div class="stat-row">è«‹å…ˆé¸æ“‡ã€Œæ“”ä¿æƒ…æ³ã€ï¼Œç³»çµ±å°‡è‡ªå‹•èª¿é–±æ­·å²æ¡ˆä¾‹åˆ†æã€‚</div>
                    </div>
                </div>

                <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 14px;">ğŸ’¡ Rexå¤§å”çš„æ™ºæ…§æé†’</div>
                    <div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div>
                </div>

                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
            </form>
        </div>

        <div class="result-panel">
            <div id="welcomeMsg" class="welcome-message">
                <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
                <p>âœ… V3.36 çµ‚æ¥µæ•¸æ“šå°æ¥ç‰ˆ<br>ç›´æ¥è®€å– 00_CB.xlsx å®Œæ•´è³‡æ–™åº«</p>
                <div class="stats-summary" id="statsSummary"></div>
            </div>
            <div id="evaluationResult" class="evaluation-result"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// V3.36 æ ¸å¿ƒé‚è¼¯ - æ¬„ä½ç¡¬ç·šé€£æ¥
// ==========================================

// æ¬Šé‡ä¿‚æ•¸
function getWeightCoefficient(category, value) {
    if (!window.WEIGHT_COEFFICIENTS || !window.WEIGHT_COEFFICIENTS[category]) return 1.0;
    const coefData = window.WEIGHT_COEFFICIENTS[category][value];
    return coefData ? coefData.coefficient : 1.0;
}

// å®‰å…¨æ•¸å€¼è½‰æ›
function safeFloat(val) {
    if (val === undefined || val === null || val === '') return 0;
    if (typeof val === 'string') {
        val = val.replace(/,/g, '').replace(/%/g, '').trim();
    }
    let n = parseFloat(val);
    return isNaN(n) ? 0 : n;
}

function safeString(val) {
    return val ? String(val).trim() : "";
}

// å…¨åŸŸè®Šæ•¸
let statistics = {};
let cbDatabase = {};
let cbNameMap = {};
let auctionRawData = [];
let globalMarketStats = { low: 0, avg: 0 };

// 1. å•Ÿå‹•è¼‰å…¥
window.addEventListener('DOMContentLoaded', loadExcelDatabase);

async function loadExcelDatabase() {
    const loadingDiv = document.getElementById('loading');
    const detailDiv = document.getElementById('loading-detail');
    const errorDiv = document.getElementById('error-msg');

    try {
        detailDiv.textContent = "æ­£åœ¨ä¸‹è¼‰ 00_CB.xlsx (è«‹ç¨å€™)...";
        
        // å¼·åˆ¶è®€å– 00_CB.xlsx (è«‹ç¢ºèªæª”åæ­£ç¢º)
        const response = await fetch('00_CB.xlsx');
        if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ: 00_CB.xlsxï¼Œè«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³è‡³åŒä¸€ç›®éŒ„ã€‚");
        
        const arrayBuffer = await response.arrayBuffer();
        detailDiv.textContent = "æ­£åœ¨è§£æ Excel æ¬„ä½...";
        
        const workbook = XLSX.read(arrayBuffer);
        processExcelData(workbook);
        
        calculateGlobalMarketStats();
        initializeUI();
        
        loadingDiv.style.display = 'none';
        document.querySelector('.container').style.display = 'block';

    } catch (e) {
        console.error(e);
        detailDiv.textContent = "âš ï¸ è³‡æ–™åº«è®€å–å¤±æ•—";
        errorDiv.textContent = e.message;
    }
}

function processExcelData(workbook) {
    const sheetNames = workbook.SheetNames;
    const findSheet = (keywords) => sheetNames.find(name => keywords.some(k => name.includes(k)));

    // A. [åŸºæœ¬è³‡æ–™] (01) + [æ›ç‰Œ] (00)
    const sheet01Name = findSheet(['01_', 'åŸºæœ¬è³‡æ–™']);
    const sheet00Name = findSheet(['00_', 'æ›ç‰Œ']);
    
    if (sheet01Name) {
        const raw01 = XLSX.utils.sheet_to_json(workbook.Sheets[sheet01Name]);
        raw01.forEach(row => {
            // ç²¾æº–æ¬„ä½å°æ¥ (ä¾æ“šæ‚¨æä¾›çš„ CSV æ¬„ä½)
            let code = safeString(row['ä»£è™Ÿ'] || row['CBä»£è™Ÿ']);
            if (!code) return;
            
            // TCRI è™•ç†
            let rRaw = safeString(row['TCRI(è©•ç­‰)'] || row['ä¿¡è©•']);
            let rating = '9';
            if(rRaw.includes('BBB')) rating = 'BBB';
            else {
                let m = rRaw.match(/\d+/);
                if(m) rating = m[0];
            }

            cbDatabase[code] = {
                "ä»£è™Ÿ": code,
                "åç¨±": safeString(row['åç¨±']),
                "è‚¡ç¥¨ä»£è™Ÿ": safeString(row['è‚¡ç¥¨ä»£è™Ÿ']),
                "ç”¢æ¥­åˆ†é¡": safeString(row['ç”¢æ¥­åˆ†é¡']),
                "è‚¡æœ¬è¦æ¨¡": safeFloat(row['è‚¡æœ¬(å„„)']),
                "ç™¼è¡Œè¦æ¨¡": safeFloat(row['ç™¼è¡Œè¦æ¨¡(å„„)']),
                "è½‰æ›åƒ¹æ ¼": safeFloat(row['è½‰æ›åƒ¹æ ¼']),
                "ç™¼è¡Œå¹´æœŸ": safeFloat(row['ç™¼è¡Œå¹´æœŸ']),
                "æœ‰ç„¡æ“”ä¿": safeString(row['æ“”ä¿']),
                "ä¿¡è©•": rating,
                "æ‰¿éŠ·åˆ¸å•†": safeString(row['æ‰¿éŠ·åˆ¸å•†']),
                "æ›ç‰Œæœ€é«˜": 0, "æ›ç‰Œæœ€ä½": 0
            };
        });
    }

    if (sheet00Name) {
        const raw00 = XLSX.utils.sheet_to_json(workbook.Sheets[sheet00Name]);
        raw00.forEach(row => {
            let code = safeString(row['ä»£è™Ÿ']);
            if (cbDatabase[code]) {
                cbDatabase[code]['æ›ç‰Œæœ€é«˜'] = safeFloat(row['æ›ç‰Œæœ€é«˜']);
                cbDatabase[code]['æ›ç‰Œæœ€ä½'] = safeFloat(row['æ›ç‰Œæœ€ä½']);
            }
        });
    }

    Object.values(cbDatabase).forEach(item => {
        if (item['åç¨±']) cbNameMap[item['åç¨±']] = item;
    });

    // B. [ç«¶æ‹è³‡æ–™åº«] (04) - ä¿®æ­£æ¬„ä½åç¨±
    const sheet04Name = findSheet(['04_', 'ç«¶æ‹è³‡æ–™åº«']);
    if (sheet04Name) {
        const raw04 = XLSX.utils.sheet_to_json(workbook.Sheets[sheet04Name]);
        auctionRawData = raw04.map(row => {
            // è™•ç† TCRI
            let rRaw = safeString(row['TCRI(è©•ç­‰)']);
            let rating = '9';
            if(rRaw.includes('BBB')) rating = 'BBB';
            else {
                let m = rRaw.match(/\d+/);
                if(m) rating = m[0];
            }

            return {
                "CBä»£è™Ÿ": safeString(row['CBä»£è™Ÿ']),
                "åç¨±": safeString(row['åç¨±']),
                "ç™¼è¡Œåˆ¸å•†": safeString(row['æ‰¿éŠ·åˆ¸å•†']), // æ³¨æ„ï¼šè¡¨04ç”¨çš„æ˜¯ã€Œæ‰¿éŠ·åˆ¸å•†ã€
                "ç”¢æ¥­åˆ†é¡": safeString(row['ç”¢æ¥­åˆ†é¡']),
                "è‚¡æœ¬": safeFloat(row['è‚¡æœ¬(å„„)']),
                "ç™¼è¡Œè¦æ¨¡": safeFloat(row['ç™¼è¡Œè¦æ¨¡(å„„)']),
                "å¹´æœŸ": safeFloat(row['ç™¼è¡Œå¹´æœŸ']),
                "æ“”ä¿": safeString(row['æ“”ä¿']),
                "ä¿¡è©•": rating,
                "è½‰æ›åƒ¹": safeFloat(row['è½‰æ›åƒ¹æ ¼']),
                "æœ€ä½å¾—æ¨™": safeFloat(row['æœ€ä½å¾—æ¨™åƒ¹æ ¼']),
                "æœ€ä½æº¢åƒ¹": safeFloat(row['æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡']),
                "å¹³å‡å¾—æ¨™": safeFloat(row['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼']),
                "å¹³å‡æº¢åƒ¹": safeFloat(row['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡']),
                "æŠ•æ¨™å€æ•¸": safeFloat(row['æŠ•æ¨™å€æ•¸(å€)'])
            };
        });
    }

    // C. [çµ±è¨ˆå€é–“] (05)
    const sheet05Name = findSheet(['05_', 'ç¯©é¸æ¢ä»¶']);
    statistics['ç¶­åº¦çµ±è¨ˆ'] = {};
    
    if (sheet05Name) {
        const raw05 = XLSX.utils.sheet_to_json(workbook.Sheets[sheet05Name]);
        raw05.forEach(row => {
            let dim = safeString(row['ç¶­åº¦']);
            let rng = safeString(row['æ¢ä»¶å€é–“']);
            if (!dim || !rng) return;

            // çµ±ä¸€ key åç¨±
            if (dim.includes('åˆ¸å•†')) dim = 'ç™¼è¡Œåˆ¸å•†';
            else if (dim.includes('ä¿¡è©•')) dim = 'ä¿¡è©•';
            else if (dim.includes('è‚¡æœ¬')) dim = 'è‚¡æœ¬';
            else if (dim.includes('è¦æ¨¡')) dim = 'ç™¼è¡Œè¦æ¨¡';
            else if (dim.includes('å¹´æœŸ')) dim = 'å¹´æœŸ';
            else if (dim.includes('è½‰æ›')) dim = 'è½‰æ›åƒ¹';
            else if (dim.includes('æ“”ä¿')) dim = 'æ“”ä¿';
            else if (dim.includes('ç”¢æ¥­')) dim = 'ç”¢æ¥­';

            if (!statistics['ç¶­åº¦çµ±è¨ˆ'][dim]) statistics['ç¶­åº¦çµ±è¨ˆ'][dim] = {};

            statistics['ç¶­åº¦çµ±è¨ˆ'][dim][rng] = {
                "å¹³å‡æœ€ä½æº¢åƒ¹": safeFloat(row['æ­·å²æœ€ä½æº¢åƒ¹']),
                "å¹³å‡æº¢åƒ¹": safeFloat(row['æ­·å²å¹³å‡æº¢åƒ¹']),
                "æ¨£æœ¬æ•¸": safeFloat(row['æ¨£æœ¬æ•¸']),
                "å¹³å‡æœ€ä½å¾—æ¨™": safeFloat(row['æœ€ä½å¾—æ¨™']),
                "å¹³å‡å¾—æ¨™åƒ¹": safeFloat(row['å¹³å‡å¾—æ¨™']),
                "å¹³å‡æ›ç‰Œæœ€é«˜": safeFloat(row['æ›ç‰Œæœ€é«˜']),
                "å¹³å‡æ›ç‰Œæœ€ä½": safeFloat(row['æ›ç‰Œæœ€ä½'])
            };
        });
    }
}

function calculateGlobalMarketStats() {
    if (auctionRawData.length > 0) {
        let sumLow = 0, sumAvg = 0, count = 0;
        auctionRawData.forEach(d => {
            let l = d['æœ€ä½æº¢åƒ¹'];
            let a = d['å¹³å‡æº¢åƒ¹'];
            if (Math.abs(l) < 1) l *= 100; // ä¿®æ­£å°æ•¸
            if (Math.abs(a) < 1) a *= 100;
            
            if (Math.abs(l) > 0.01 && Math.abs(l) < 500) {
                sumLow += l; sumAvg += a; count++;
            }
        });
        if (count > 0) {
            globalMarketStats.low = sumLow / count;
            globalMarketStats.avg = sumAvg / count;
        }
    }
}

// UI åˆå§‹åŒ–ï¼šæ··åˆè³‡æ–™æºä»¥ç¢ºä¿é¸å–®å®Œæ•´
function initializeUI() {
    document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | æ•´åˆ${Object.keys(cbDatabase).length}æª”CBå®Œæ•´è³‡æ–™åº«`;
    
    const industries = new Set();
    const brokers = new Set();
    
    // ä¾†æº1: ç«¶æ‹è³‡æ–™åº« (å„ªå…ˆ)
    auctionRawData.forEach(d => {
        if(d['ç”¢æ¥­åˆ†é¡']) industries.add(d['ç”¢æ¥­åˆ†é¡']);
        if(d['ç™¼è¡Œåˆ¸å•†']) brokers.add(d['ç™¼è¡Œåˆ¸å•†']);
    });
    
    // ä¾†æº2: åŸºæœ¬è³‡æ–™åº« (è£œæ¼)
    Object.values(cbDatabase).forEach(d => {
        if(d['ç”¢æ¥­åˆ†é¡']) industries.add(d['ç”¢æ¥­åˆ†é¡']);
        if(d['æ‰¿éŠ·åˆ¸å•†']) brokers.add(d['æ‰¿éŠ·åˆ¸å•†']);
    });

    // æ’é™¤ç©ºç™½èˆ‡æ¨™é¡Œ
    const cleanSet = (s) => Array.from(s).filter(x => x && x !== 'ç”¢æ¥­åˆ†é¡' && x !== 'æ‰¿éŠ·åˆ¸å•†' && x.length > 1).sort();

    populateSelect('industry', cleanSet(industries));
    populateSelect('broker', cleanSet(brokers));

    showStatsSummary();
    bindInputEvents();
}

function populateSelect(id, items) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
    items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        select.appendChild(opt);
    });
}

function showStatsSummary() {
    document.getElementById('statsSummary').innerHTML = `
    <div class="stat-box"><div class="number">${Object.keys(cbDatabase).length}</div><div class="label">CBè³‡æ–™åº«</div></div>
    <div class="stat-box"><div class="number">${auctionRawData.length}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
    `;
}

// æ ¸å¿ƒè¨ˆç®—ï¼šSmart Stats
function getStatsSmart(category, val) {
    let stats = { low: 0, avg: 0, rawData: null };
    let filterFn = null;

    // å®šç¾©éæ¿¾å™¨
    if (category === 'ç™¼è¡Œåˆ¸å•†') filterFn = d => d['ç™¼è¡Œåˆ¸å•†'] === val;
    else if (category === 'ç”¢æ¥­') filterFn = d => d['ç”¢æ¥­åˆ†é¡'] === val;
    else if (category === 'æ“”ä¿') filterFn = d => (d['æ“”ä¿']||'').includes(val);
    else if (category === 'å¹´æœŸ') filterFn = d => d['å¹´æœŸ'] == val;
    else if (category === 'ä¿¡è©•') filterFn = d => (d['ä¿¡è©•']||'').toString().includes(val.toString());
    else if (category === 'è‚¡æœ¬') filterFn = d => classifyCapital(d['è‚¡æœ¬']) === classifyCapital(val);
    else if (category === 'ç™¼è¡Œè¦æ¨¡') filterFn = d => classifySize(d['ç™¼è¡Œè¦æ¨¡']) === classifySize(val);
    else if (category === 'è½‰æ›åƒ¹') filterFn = d => classifyConversionPrice(d['è½‰æ›åƒ¹']) === classifyConversionPrice(val);

    // 1. å˜—è©¦å³æ™‚é‹ç®— (æœ€æº–ç¢º)
    if (filterFn) {
        const dyn = getDynamicStats(filterFn);
        if (dyn) {
            stats.rawData = dyn;
            stats.low = dyn['å¹³å‡æœ€ä½æº¢åƒ¹'];
            stats.avg = dyn['å¹³å‡æº¢åƒ¹'];
            return stats;
        }
    }

    // 2. å˜—è©¦æŸ¥è¡¨ (Sheet 05)
    if (statistics['ç¶­åº¦çµ±è¨ˆ'] && statistics['ç¶­åº¦çµ±è¨ˆ'][category]) {
        let data = statistics['ç¶­åº¦çµ±è¨ˆ'][category][val];
        if (!data && typeof val === 'number') {
            const key = findBestRangeKey(category, val);
            if(key) data = statistics['ç¶­åº¦çµ±è¨ˆ'][category][key];
        }
        if (data) {
            stats.rawData = data;
            stats.low = data['å¹³å‡æœ€ä½æº¢åƒ¹'];
            stats.avg = data['å¹³å‡æº¢åƒ¹'];
            return stats;
        }
    }

    // 3. å¸‚å ´å‡å€¼
    stats.low = globalMarketStats.low;
    stats.avg = globalMarketStats.avg;
    return stats;
}

function getDynamicStats(filterFn) {
    const matches = auctionRawData.filter(filterFn);
    if (matches.length === 0) return null;

    let sumLow = 0, sumAvg = 0, count = 0;
    matches.forEach(d => {
        let l = d['æœ€ä½æº¢åƒ¹'];
        let a = d['å¹³å‡æº¢åƒ¹'];
        if (Math.abs(l) < 1) l *= 100;
        if (Math.abs(a) < 1) a *= 100;
        
        if (Math.abs(l) < 500) { 
            sumLow += l; sumAvg += a; count++;
        }
    });

    if (count === 0) return null;
    return {
        'å¹³å‡æœ€ä½æº¢åƒ¹': sumLow / count,
        'å¹³å‡æº¢åƒ¹': sumAvg / count,
        'æ¨£æœ¬æ•¸': count,
        'å¹³å‡æœ€ä½å¾—æ¨™': 0, 'å¹³å‡å¾—æ¨™åƒ¹': 0 // ç°¡åŒ–
    };
}

// å€é–“åˆ†é¡å™¨
function classifyCapital(v) { return v < 3 ? '<3å„„' : v < 6 ? '3~6å„„' : v < 10 ? '6~10å„„' : v < 15 ? '10~15å„„' : v < 20 ? '15~20å„„' : '>20å„„'; }
function classifySize(v) { return v < 2 ? '<2å„„' : v < 5 ? '2~5å„„' : v < 10 ? '5~10å„„' : v < 15 ? '10~15å„„' : v < 20 ? '15~20å„„' : '>20å„„'; }
function classifyConversionPrice(v) { return v < 20 ? '<20å…ƒ' : v < 50 ? '20-50å…ƒ' : v < 100 ? '50-100å…ƒ' : v < 150 ? '100-150å…ƒ' : v < 200 ? '150-200å…ƒ' : '>200å…ƒ'; }
function classifyYears(v) { return v.toString(); }

function findBestRangeKey(category, val) {
    if (category === 'è‚¡æœ¬') return classifyCapital(val);
    if (category === 'ç™¼è¡Œè¦æ¨¡') return classifySize(val);
    if (category === 'è½‰æ›åƒ¹') return classifyConversionPrice(val);
    return null;
}

function getBrokerName(cbName) {
    if(!cbName) return null;
    const names = Object.keys(cbNameMap);
    const match = names.find(n => n.includes(cbName) || cbName.includes(n));
    return match ? cbNameMap[match]['æ‰¿éŠ·åˆ¸å•†'] : null;
}

// UI ç¶å®š
function bindInputEvents() {
    const show = (id, html) => {
        const el = document.getElementById(id); 
        el.innerHTML = html || ''; 
        el.style.display = html ? 'block' : 'none';
    };

    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim();
        if (!val) { show('cbNameInfo', null); return; }
        const foundKey = Object.keys(cbNameMap).find(k => k.includes(val));
        const found = foundKey ? cbNameMap[foundKey] : null;

        if (found) {
            let html = `<div class="stats-header">ğŸ“Š æ›ç‰Œåƒ¹æ ¼åƒè€ƒ</div><div class="stat-row">${found['ä»£è™Ÿ']} / ${found['è‚¡ç¥¨ä»£è™Ÿ']}</div>`;
            const h = found['æ›ç‰Œæœ€é«˜'], l = found['æ›ç‰Œæœ€ä½'];
            if (h > 0) {
                const amp = ((h-l)/l*100).toFixed(2);
                html += `<div class="stat-row"><span>ğŸ“ˆ æœ€é«˜:${h}</span><span>ğŸ“‰ æœ€ä½:${l}</span><span style="color:#E91E63;">âš¡ ${amp}%</span></div>`;
            }
            show('cbNameInfo', html);
        } else show('cbNameInfo', null);
    });

    const bind = (id, cat, isNum) => {
        document.getElementById(id).addEventListener(isNum ? 'input' : 'change', function() {
            const val = isNum ? parseFloat(this.value) : this.value;
            if (val) {
                const stats = getStatsSmart(cat, val);
                let key = isNum ? findBestRangeKey(cat, val) : val;
                show(id+'Info', generateStandardCard(stats.rawData, `æ­·å²çµ±è¨ˆ (${key||val})`));
                if (cat === 'è½‰æ›åƒ¹' || cat === 'ä¿¡è©•') updateSmartReminders();
            }
        });
    };

    bind('capital', 'è‚¡æœ¬', true);
    bind('issueSize', 'ç™¼è¡Œè¦æ¨¡', true);
    bind('conversionPrice', 'è½‰æ›åƒ¹', true);
    bind('industry', 'ç”¢æ¥­', false);
    bind('broker', 'ç™¼è¡Œåˆ¸å•†', false);
    bind('years', 'å¹´æœŸ', true);
    
    document.getElementById('guarantee').addEventListener('change', function() {
        const stats = getStatsSmart('æ“”ä¿', this.value);
        show('guaranteeInfo', generateStandardCard(stats.rawData, `æ­·å²çµ±è¨ˆ (${this.value})`));
        updateMarketSentimentDisplay();
    });

    bind('rating', 'ä¿¡è©•', false);
    document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
}

function generateStandardCard(data, title) {
    if (!data) return `<div class="stat-row" style="color:#999;">æŸ¥ç„¡è³‡æ–™ (å°‡ä½¿ç”¨å¸‚å ´å‡å€¼)</div>`;
    const val = (v, s='') => v ? `${safeFloat(v).toFixed(2)}${s}` : '-';
    return `<div class="stats-header">ğŸ“Š ${title}</div><div class="stat-row">æ¨£æœ¬æ•¸: ${data['æ¨£æœ¬æ•¸']||0} æª”</div><div style="background:#f1f8e9; padding:8px; border-radius:5px;"><div class="stat-row"><span>ğŸ“‰ æœ€ä½æº¢åƒ¹:</span><span class="stat-value">${val(data['å¹³å‡æœ€ä½æº¢åƒ¹'], '%')}</span></div><div class="stat-row"><span>âš–ï¸ å¹³å‡æº¢åƒ¹:</span><span class="stat-value">${val(data['å¹³å‡æº¢åƒ¹'], '%')}</span></div></div>`;
}

function updateSmartReminders() {
    const stock = parseFloat(document.getElementById('stockPrice').value);
    const conv = parseFloat(document.getElementById('conversionPrice').value);
    const div = document.getElementById('smartReminders');
    if (stock && conv) {
        const theo = (stock/conv)*100;
        let msg = theo > 115 ? 'âš ï¸ ç†è«–åƒ¹éé«˜ï¼Œç•™æ„é¢¨éšª' : theo < 90 ? 'ğŸ’¡ ç†è«–åƒ¹åä½ï¼Œå…·é˜²ç¦¦åƒ¹å€¼' : 'âœ¨ ç†è«–åƒ¹åˆç†';
        document.getElementById('reminderContent').textContent = msg;
        div.style.display = 'block';
    }
}

function updateMarketSentimentDisplay() {
    const guarantee = document.getElementById('guarantee').value;
    const div = document.getElementById('marketSentiment');
    const matches = auctionRawData.filter(d => (d['æ“”ä¿']||'').includes(guarantee));
    
    if (matches.length === 0) {
        div.innerHTML = 'ç„¡ç›¸é—œè¿‘æœŸæ¡ˆä¾‹';
        return;
    }
    const recent = matches.slice(0, 3); 
    let html = `<div class="stats-header">ğŸŒ¡ï¸ è¿‘æœŸæ¡ˆä¾‹ (${guarantee})</div>`;
    recent.forEach(d => {
        let p = d['å¹³å‡æº¢åƒ¹']; if(Math.abs(p)<1) p*=100;
        html += `<div style="font-size:12px; margin-bottom:5px;">${d['åç¨±']} / æº¢ ${p.toFixed(2)}%</div>`;
    });
    div.innerHTML = html;
    div.style.display = 'block';
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const data = {
        cbName: document.getElementById('cbName').value,
        industry: document.getElementById('industry').value,
        broker: document.getElementById('broker').value,
        issueSize: parseFloat(document.getElementById('issueSize').value),
        years: parseInt(document.getElementById('years').value),
        guarantee: document.getElementById('guarantee').value,
        rating: document.getElementById('rating').value,
        capital: parseFloat(document.getElementById('capital').value),
        stockPrice: parseFloat(document.getElementById('stockPrice').value),
        conversionPrice: parseFloat(document.getElementById('conversionPrice').value),
        subWeight: parseFloat(document.getElementById('subjectiveWeight').value) || 0,
        subLow: parseFloat(document.getElementById('subjectiveLowPremium').value) || 0,
        subAvg: parseFloat(document.getElementById('subjectiveAvgPremium').value) || 0
    };

    const weights = { industry: 0.25, broker: 0.13, capital: 0.12, size: 0.10, rating: 0.15, guarantee: 0.12, years: 0.08, conversion: 0.05 };
    let wLow = 0, wAvg = 0;
    
    const calcDim = (key, val, cat) => {
        const stats = getStatsSmart(cat, val);
        wLow += stats.low * weights[key];
        wAvg += stats.avg * weights[key];
    };

    calcDim('industry', data.industry, 'ç”¢æ¥­');
    calcDim('broker', data.broker, 'ç™¼è¡Œåˆ¸å•†');
    calcDim('capital', data.capital, 'è‚¡æœ¬');
    calcDim('size', data.issueSize, 'ç™¼è¡Œè¦æ¨¡');
    calcDim('rating', data.rating, 'ä¿¡è©•');
    calcDim('guarantee', data.guarantee, 'æ“”ä¿');
    calcDim('years', data.years, 'å¹´æœŸ');
    calcDim('conversion', data.conversionPrice, 'è½‰æ›åƒ¹');

    const subRatio = data.subWeight / 100;
    const objRatio = 1 - subRatio;
    const finalLow = (wLow * objRatio) + (data.subLow * subRatio);
    const finalAvg = (wAvg * objRatio) + (data.subAvg * subRatio);
    const theoPrice = (data.stockPrice / data.conversionPrice) * 100;
    const gap = finalAvg - finalLow;

    const resDiv = document.getElementById('evaluationResult');
    document.getElementById('welcomeMsg').style.display = 'none';
    resDiv.className = 'evaluation-result active';
    
    resDiv.innerHTML = `
    <div class="result-header"><h2>${data.cbName}</h2><div class="subtitle">AI è©•ä¼°çµæœ (V3.36)</div></div>
    <div class="detail-section">
        <h3>ğŸ“Š ç†è«–åƒ¹æ ¼: <span style="color:#b21f1f; font-size:24px;">${theoPrice.toFixed(2)}</span></h3>
        <table class="data-table">
            <tr><th>é …ç›®</th><th>æœ€ä½æº¢åƒ¹ç‡</th><th>å¹³å‡æº¢åƒ¹ç‡</th></tr>
            <tr><td>æ­·å²å¤§æ•¸æ“šåŠ æ¬Š</td><td>${wLow.toFixed(2)}%</td><td>${wAvg.toFixed(2)}%</td></tr>
            <tr style="background:#fff3e0; font-weight:bold;"><td>æœ€çµ‚é æ¸¬ (å«ä¸»è§€)</td><td>${finalLow.toFixed(2)}%</td><td>${finalAvg.toFixed(2)}%</td></tr>
        </table>
    </div>
    <div class="detail-section">
        <h3>ğŸ’¡ å»ºè­°æŠ•æ¨™åƒ¹æ ¼</h3>
        <div class="price-grid">
            <div class="strategy-card conservative"><h4>ğŸ›¡ï¸ ä¿å®ˆ</h4><div class="price">${(theoPrice * (1 + finalLow/100)).toFixed(2)}</div></div>
            <div class="strategy-card balanced"><h4>âš–ï¸ å¹³è¡¡</h4><div class="price">${(theoPrice * (1 + finalAvg/100)).toFixed(2)}</div></div>
            <div class="strategy-card aggressive"><h4>ğŸš€ ç©æ¥µ</h4><div class="price">${(theoPrice * (1 + (finalAvg+gap)/100)).toFixed(2)}</div></div>
        </div>
    </div>
    <div style="text-align:center; margin-top:30px;">
        <button onclick="location.reload()" style="padding:10px 30px; border-radius:5px; border:none; background:#ddd; cursor:pointer;">é‡æ–°è©•ä¼°</button>
    </div>
    `;
    resDiv.scrollIntoView({ behavior: 'smooth' });
});
</script>

</body>
</html>
