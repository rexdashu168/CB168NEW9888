<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± v3.30 (ç¶“å…¸ç©©å®šç‰ˆ) - Rexå¤§å”</title>

<style>
/* ================= é¢¨æ ¼è¨­å®š ================= */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh; padding: 20px;
}
.container { max-width: 1600px; margin: 0 auto; }

.header {
    background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.header h1 { color: #667eea; font-size: 32px; margin-bottom: 10px; }
.header .subtitle { color: #666; font-size: 16px; }
.version-badge { display: inline-block; background: #009688; color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; margin-left: 10px; }

.evaluation-container { display: grid; grid-template-columns: 450px 1fr; gap: 20px; }

.input-panel {
    background: white; border-radius: 15px; padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px;
}
.input-panel h2 { color: #667eea; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 3px solid #667eea; }

.form-section { margin-bottom: 25px; }
.form-section h3 { color: #333; font-size: 16px; margin-bottom: 15px; font-weight: bold; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; font-weight: 500; }
.form-group input, .form-group select {
    width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: border-color 0.3s;
}
.form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }

/* è³‡è¨Šæ¡†æ¨£å¼ (å¡ç‰‡) */
.info-box {
    background: #e8f5e9; padding: 15px; border-radius: 8px;
    border-left: 5px solid #4CAF50; margin-top: 10px; display: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.stats-header { font-size: 14px; color: #2e7d32; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #c8e6c9; padding-bottom: 5px; }
.stat-row { font-size: 13px; color: #444; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.stat-label { color: #555; font-weight: 500; }
.stat-value { font-weight: bold; color: #333; }

.calculate-btn {
    width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold;
    cursor: pointer; transition: transform 0.2s; margin-top: 20px;
}
.calculate-btn:hover { transform: translateY(-2px); }

.result-panel {
    background: white; border-radius: 15px; padding: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1); min-height: 600px;
}
.welcome-message { text-align: center; padding: 60px 20px; }
.stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 40px; }
.stat-box { background: #f8f9fa; padding: 25px; border-radius: 10px; text-align: center; }
.stat-box .number { font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px; }

.evaluation-result { display: none; }
.evaluation-result.active { display: block; animation: fadeIn 0.5s; }

.result-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;
}
.detail-section {
    background: white; border-radius: 12px; padding: 30px;
    margin-bottom: 25px; border: 2px solid #e0e0e0;
}
.detail-section h3 { color: #667eea; font-size: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

.price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.strategy-card { border: 2px solid; border-radius: 12px; padding: 25px; }
.strategy-card.conservative { border-color: #4CAF50; background: #f1f8f4; }
.strategy-card.balanced { border-color: #FF9800; background: #fff8f0; }
.strategy-card.aggressive { border-color: #f44336; background: #fff0f0; }
.strategy-card.ultimate { border-color: #f44336; background: #fff0f0; }
.strategy-card .price { font-size: 32px; font-weight: bold; margin: 20px 0; }

/* è¡¨æ ¼å„ªåŒ– */
.data-table {
    width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.data-table th {
    background-color: #1A237E; color: white; padding: 15px 10px;
    text-align: center; font-weight: bold; border: 1px solid #0d1b5e;
}
.data-table td { padding: 12px 10px; text-align: center; border: 1px solid #e0e0e0; color: #333; }
.data-table tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tr:hover { background-color: #e8eaf6; }
.val-pos { color: #d32f2f; font-weight: bold; }
.val-neg { color: #388e3c; font-weight: bold; }
.val-neu { color: #333; }

/* Rexå¤§å”åˆ†æå€å¡Š */
.rex-analysis {
    background: linear-gradient(to right, #fff3e0, #ffe0b2);
    border-left: 6px solid #ff9800;
    padding: 25px;
    border-radius: 8px;
    margin-top: 30px;
}
.rex-title { font-size: 20px; font-weight: bold; color: #e65100; margin-bottom: 15px; display: flex; align-items: center; }
.rex-content { color: #5d4037; line-height: 1.8; font-size: 15px; }

@media (max-width: 1200px) {
    .evaluation-container { grid-template-columns: 1fr; }
    .input-panel { position: relative; top: 0; }
}
</style>
<script src="embedded_data.js"></script>
</head>

<body>

<div id="loading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 24px; font-weight: bold;">
    <div>ğŸ”„ æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</div>
    <div id="loading-detail" style="font-size: 16px; margin-top: 10px; font-weight: normal; opacity: 0.9;">æ­£åœ¨é€£çµè³‡æ–™åº«...</div>
</div>

<div class="container" style="display: none;">
    <div class="header">
        <h1>ğŸ¤– AIæ™ºèƒ½å¯è½‰å‚µç«¶æ‹ç³»çµ± <span class="version-badge">v3.30</span></h1>
        <p class="subtitle" id="headerSubtitle">è¼‰å…¥ä¸­...</p>
    </div>

    <div class="evaluation-container">
        <div class="input-panel">
            <h2>ğŸ“‹ è¼¸å…¥æ¨™çš„è³‡æ–™</h2>
            <form id="evaluationForm">
                <div class="form-section">
                    <h3>ğŸ“Œ åŸºæœ¬è³‡æ–™</h3>
                    <div class="form-group">
                        <label>CBåç¨± *</label>
                        <input type="text" id="cbName" required placeholder="ä¾‹å¦‚ï¼šå°å…‰é›»ä¸ƒ">
                        <div id="cbNameInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>è‚¡æœ¬ (å„„å…ƒ) *</label>
                        <input type="number" id="capital" step="0.01" required placeholder="ä¾‹å¦‚ï¼š33.80">
                        <div id="capitalInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç”¢æ¥­åˆ†é¡ *</label>
                        <select id="industry" required><option value="">è¼‰å…¥ä¸­...</option></select>
                        <div id="industryInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç™¼è¡Œåˆ¸å•†</label>
                        <select id="broker"><option value="">è¼‰å…¥ä¸­...</option></select>
                        <div id="brokerInfo" class="info-box"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’° ç™¼è¡Œæ¢ä»¶</h3>
                    <div class="form-group">
                        <label>ç™¼è¡Œè¦æ¨¡ (å„„å…ƒ) *</label>
                        <input type="number" id="issueSize" step="0.1" required placeholder="ä¾‹å¦‚ï¼š90">
                        <div id="issueSizeInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>è½‰æ›åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="conversionPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š450">
                        <div id="conversionPriceInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ç™¼è¡Œå¹´æœŸ *</label>
                        <select id="years" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="3">3å¹´æœŸ</option>
                            <option value="5">5å¹´æœŸ</option>
                            <option value="7">7å¹´æœŸ</option>
                        </select>
                        <div id="yearsInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>æ“”ä¿æƒ…æ³ *</label>
                        <select id="guarantee" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="æœ‰æ“”ä¿">æœ‰æ“”ä¿</option>
                            <option value="ç„¡æ“”ä¿">ç„¡æ“”ä¿</option>
                        </select>
                        <div id="guaranteeInfo" class="info-box"></div>
                    </div>
                    <div class="form-group">
                        <label>ä¿¡ç”¨è©•ç­‰ (TCRI) *</label>
                        <select id="rating" required>
                            <option value="">è«‹é¸æ“‡...</option>
                            <option value="1">TCRI 1</option>
                            <option value="2">TCRI 2</option>
                            <option value="3">TCRI 3</option>
                            <option value="4">TCRI 4</option>
                            <option value="5">TCRI 5</option>
                            <option value="6">TCRI 6</option>
                            <option value="7">TCRI 7</option>
                            <option value="8">TCRI 8</option>
                            <option value="9">TCRI 9</option>
                            <option value="BBB">BBBç´š</option>
                        </select>
                        <div id="ratingInfo" class="info-box"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ¯ ç«¶æ‹è³‡æ–™</h3>
                    <div class="form-group">
                        <label>ç«¶æ‹æˆªæ­¢æ—¥1:30æ”¶ç›¤åƒ¹æ ¼ (å…ƒ) *</label>
                        <input type="number" id="stockPrice" step="0.01" required placeholder="ä¾‹å¦‚ï¼š461.5">
                    </div>
                </div>

                <div class="form-section" style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6cc 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 20px; margin: 25px 0;">
                    <h3 style="color: #e65100; display: flex; align-items: center; gap: 8px;">âš–ï¸ ä¸»è§€æ¬Šé‡èª¿æ•´ï¼ˆé¸å¡«ï¼‰</h3>
                    <div style="background: white; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6; color: #555; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                        ğŸ’¡ <strong>åŠŸèƒ½èªªæ˜ï¼š</strong><br>
                        â€¢ ä¸»è§€æ¬Šé‡0%ï¼šå®Œå…¨ä¾æ“šæ­·å²è³‡æ–™è¨ˆç®—<br>
                        â€¢ ä¸»è§€æ¬Šé‡20%ï¼šæ‚¨çš„åˆ¤æ–·ä½”20%ï¼Œæ­·å²è³‡æ–™ä½”80%<br>
                        â€¢ å¡«å…¥æ‚¨å°æœ¬æ¨™çš„çš„æº¢åƒ¹é æœŸï¼Œç³»çµ±æœƒè‡ªå‹•åŠ æ¬Šè¨ˆç®—
                    </div>
                    <div class="form-group">
                        <label>ä¸»è§€æ¬Šé‡æ¯”ä¾‹ (%)</label>
                        <input type="number" id="subjectiveWeight" min="0" max="100" step="1" value="0" placeholder="0-100ï¼Œé è¨­0">
                        <small style="color: #666; font-size: 12px;">ç¯„åœï¼š0-100ï¼Œé è¨­0è¡¨ç¤ºå®Œå…¨ä¾æ“šæ­·å²è³‡æ–™</small>
                    </div>
                    <div class="form-group">
                        <label>ä¸»è§€æœ€ä½æº¢åƒ¹ç‡ (%)</label>
                        <input type="number" id="subjectiveLowPremium" step="0.1" value="0" placeholder="ä¾‹å¦‚ï¼š5.0">
                        <small style="color: #666; font-size: 12px;">æ‚¨èªç‚ºæœ€ä½å¾—æ¨™çš„æº¢åƒ¹ç‡ï¼ˆä¿å®ˆä¼°è¨ˆï¼‰</small>
                    </div>
                    <div class="form-group">
                        <label>ä¸»è§€å¹³å‡æº¢åƒ¹ç‡ (%)</label>
                        <input type="number" id="subjectiveAvgPremium" step="0.1" value="0" placeholder="ä¾‹å¦‚ï¼š8.0">
                        <small style="color: #666; font-size: 12px;">æ‚¨èªç‚ºå¹³å‡å¾—æ¨™çš„æº¢åƒ¹ç‡ï¼ˆç©©å¥ä¼°è¨ˆï¼‰</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ“Š è¿‘æœŸå¸‚å ´ç«¶æ‹æ°›åœ</h3>
                    <div id="marketSentiment" class="info-box" style="display: block; background:#e3f2fd; border-left: 4px solid #2196F3;">
                        <div class="stats-header" style="color:#1976D2;">ğŸŒ¡ï¸ å‹•æ…‹å¸‚å ´æ°›åœåˆ†æ</div>
                        <div class="stat-row">è«‹å…ˆé¸æ“‡ã€Œæ“”ä¿æƒ…æ³ã€ï¼Œç³»çµ±å°‡è‡ªå‹•èª¿é–±æ­·å²æ¡ˆä¾‹åˆ†æã€‚</div>
                    </div>
                </div>

                <div id="smartReminders" style="display:none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 14px;">ğŸ’¡ Rexå¤§å”çš„æ™ºæ…§æé†’</div>
                    <div id="reminderContent" style="font-size: 13px; line-height: 1.8; color: #856404;"></div>
                </div>

                <button type="submit" class="calculate-btn">ğŸ¯ é–‹å§‹AIè©•ä¼°</button>
            </form>
        </div>

        <div class="result-panel">
            <div id="welcomeMsg" class="welcome-message">
                <h2>æ­¡è¿ä½¿ç”¨AIæ™ºèƒ½ç«¶æ‹è©•ä¼°ç³»çµ±</h2>
                <p>âœ… é›™è³‡æ–™åº«è‡ªå‹•æ•´åˆç³»çµ±<br>å®Œæ•´è®€å–æ­·å²è³‡æ–™ + çµ±è¨ˆåˆ†æ</p>
                <div class="stats-summary" id="statsSummary"></div>
            </div>
            <div id="evaluationResult" class="evaluation-result"></div>
        </div>
    </div>
</div>

<script>
// ==========================================
// v3.30 æ–°å¢ï¼šè¼”åŠ©å‡½æ•¸
// ==========================================

// ç²å–æ¬Šé‡ä¿‚æ•¸
function getWeightCoefficient(category, value) {
    if (!window.WEIGHT_COEFFICIENTS || !window.WEIGHT_COEFFICIENTS[category]) {
        return 1.0;
    }
    const coefData = window.WEIGHT_COEFFICIENTS[category][value];
    if (!coefData) {
        return 1.0;
    }
    return coefData.coefficient;
}

// æŸ¥è©¢åˆ¸å•†
function getBrokerName(cbName) {
    if (!window.BROKER_MAPPING) return null;
    return window.BROKER_MAPPING[cbName] || null;
}

// åˆ†é¡å‡½æ•¸
function classifyCapital(value) {
    if (value < 3) return '<3å„„';
    if (value < 6) return '3~6å„„';
    if (value < 10) return '6~10å„„';
    if (value < 15) return '10~15å„„';
    if (value < 20) return '15~20å„„';
    return '>20å„„';
}

function classifySize(value) {
    if (value < 2) return '<2å„„';
    if (value < 5) return '2~5å„„';
    if (value < 10) return '5~10å„„';
    if (value < 15) return '10~15å„„';
    if (value < 20) return '15~20å„„';
    return '>20å„„';
}

function classifyConversionPrice(value) {
    if (value < 20) return '<20å…ƒ';
    if (value < 50) return '20-50å…ƒ';
    if (value < 100) return '50-100å…ƒ';
    if (value < 150) return '100-150å…ƒ';
    if (value < 200) return '150-200å…ƒ';
    return '>200å…ƒ';
}

function classifyYears(value) {
    return value.toString();
}

let statistics = null;
let cbDatabase = null;
let cbNameMap = {};
let auctionRawData = null;
let globalMarketStats = { low: 0, avg: 0 };

function safeFloat(val) {
    if (val === undefined || val === null || val === '') return 0;
    const num = parseFloat(val);
    return isNaN(num) ? 0 : num;
}

// 1. è³‡æ–™è®€å–èˆ‡ç´¢å¼•å»ºç«‹
async function loadStatistics() {
    const loadingDiv = document.getElementById('loading');
    const detailDiv = document.getElementById('loading-detail');

    try {
        detailDiv.textContent = "æ­£åœ¨åŒæ­¥è®€å–æ•¸æ“šåº«...";
        const [resMain, resNames] = await Promise.all([
            fetch('cb_data_integrated.json').then(res => res.ok ? res.json() : null).catch(e => null),
            fetch('cb_names_database.json').then(res => res.ok ? res.json() : null).catch(e => null)
        ]);

        if (!resMain) throw new Error("æ‰¾ä¸åˆ°ä¸»çµ±è¨ˆæª” (cb_data_integrated.json)ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±æ˜¯å¦æ­£ç¢º");

        statistics = resMain['çµ±è¨ˆæ•¸æ“š'] || {};
        auctionRawData = resMain['ç«¶æ‹åŸå§‹è³‡æ–™'] || [];
        let mainDB = resMain['CBè³‡æ–™åº«'] || {};

        if (resNames) {
            cbDatabase = { ...mainDB, ...resNames };
        } else {
            cbDatabase = mainDB;
        }

        // å»ºç«‹åç¨±ç´¢å¼•ï¼Œæ–¹ä¾¿åæŸ¥æ›ç‰Œåƒ¹
        if (cbDatabase) {
            Object.values(cbDatabase).forEach(item => {
                if (item['åç¨±']) {
                    cbNameMap[item['åç¨±']] = item;
                }
            });
        }

        calculateGlobalMarketStats();
        initializeUI();
        loadingDiv.style.display = 'none';
        document.querySelector('.container').style.display = 'block';

    } catch (error) {
        console.error(error);
        loadingDiv.innerHTML = `<div style="padding:30px; background:white; color:#d32f2f; border-radius:10px; text-align:center; max-width:80%;"><h3 style="margin-bottom:10px;">âŒ ç³»çµ±å•Ÿå‹•å¤±æ•—</h3><p style="font-size:16px;">${error.message}</p><p style="font-size:14px; color:#666; margin-top:10px;">è«‹ç¢ºèª GitHub ä¸Šçš„æª”åæ˜¯å¦ç‚º <b>cb_data_integrated.json</b></p></div>`;
    }
}

function calculateGlobalMarketStats() {
    if (auctionRawData.length > 0) {
        let sumLow = 0, sumAvg = 0, count = 0;
        auctionRawData.forEach(d => {
            const l = safeFloat(d['æœ€ä½æº¢åƒ¹'] || d['s1']);
            const a = safeFloat(d['å¹³å‡æº¢åƒ¹'] || d['u1']);
            if (l > 0 && a > 0) { sumLow += l; sumAvg += a; count++; }
        });
        if (count > 0) {
            globalMarketStats.low = (sumLow / count);
            globalMarketStats.avg = (sumAvg / count);
            if (globalMarketStats.low < 1) globalMarketStats.low *= 100;
            if (globalMarketStats.avg < 1) globalMarketStats.avg *= 100;
        }
    }
}

// 2. æ™ºèƒ½å€é–“åŒ¹é…
function findBestRangeKey(category, value) {
    if (!statistics || !statistics['ç¶­åº¦çµ±è¨ˆ'] || !statistics['ç¶­åº¦çµ±è¨ˆ'][category]) return null;
    const keys = Object.keys(statistics['ç¶­åº¦çµ±è¨ˆ'][category]);

    for (let key of keys) {
        let rawKey = key.replace(/å„„|å…ƒ|å¹´æœŸ|å¹´/g, '').trim();
        if (rawKey.includes('~') || rawKey.includes('-')) {
            let parts = rawKey.split(/[~-]/).map(s => parseFloat(s.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                if (value >= parts[0] && value < parts[1]) return key;
            }
        } else if (rawKey.includes('ä»¥ä¸‹') || rawKey.includes('æœªæ»¿') || rawKey.startsWith('<')) {
            let limit = parseFloat(rawKey.replace(/ä»¥ä¸‹|æœªæ»¿|<|<=/g, '').trim());
            if (!isNaN(limit) && value < limit) return key;
        } else if (rawKey.includes('ä»¥ä¸Š') || rawKey.includes('è¶…é') || rawKey.startsWith('>')) {
            let limit = parseFloat(rawKey.replace(/ä»¥ä¸Š|è¶…é|>|>=/g, '').trim());
            if (!isNaN(limit) && value >= limit) return key;
        } else {
            let num = parseFloat(rawKey);
            if (!isNaN(num) && value === num) return key;
        }
    }
    return null;
}

// 3. å…¨èƒ½å‹•æ…‹çµ±è¨ˆé‹ç®— (æ ¸å¿ƒåŠŸèƒ½)
function getDynamicStats(filterFn) {
    if (!auctionRawData || auctionRawData.length === 0) return null;

    const matches = auctionRawData.filter(filterFn);
    if (matches.length === 0) return null;

    let sumLowPrice = 0, sumAvgPrice = 0, sumLowPrem = 0, sumAvgPrem = 0;
    let sumHigh = 0, sumLow = 0;
    let count = 0, marketCount = 0;

    matches.forEach(d => {
        // è®€å–ç«¶æ‹æ•¸æ“š (æ”¯æ´æ‚¨çš„æ¬„ä½è¡¨)
        const lowPrice = safeFloat(d['æœ€ä½å¾—æ¨™'] || d['æœ€ä½å¾—æ¨™åƒ¹æ ¼'] || d['r1']);
        const lowPrem = safeFloat(d['æœ€ä½æº¢åƒ¹'] || d['æœ€ä½å¾—æ¨™åƒ¹æ ¼_æº¢åƒ¹ç‡'] || d['s1']);
        const avgPrice = safeFloat(d['å¹³å‡å¾—æ¨™'] || d['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼'] || d['t1']);
        const avgPrem = safeFloat(d['å¹³å‡æº¢åƒ¹'] || d['å¾—æ¨™åŠ æ¬Šå¹³å‡åƒ¹æ ¼_æº¢åƒ¹ç‡'] || d['u1']);

        if (lowPrice > 0 || lowPrem > 0) {
            sumLowPrice += lowPrice;
            sumAvgPrice += avgPrice;
            sumLowPrem += lowPrem;
            sumAvgPrem += avgPrem;
            count++;
        }

        // è®€å–æ›ç‰Œæ•¸æ“š (é€éåç¨±åæŸ¥)
        const cbName = d['åç¨±'] || d['CBåç¨±'];
        if (cbName && cbNameMap[cbName]) {
            const cbInfo = cbNameMap[cbName];
            const h = safeFloat(cbInfo['æ›ç‰Œæœ€é«˜']);
            const l = safeFloat(cbInfo['æ›ç‰Œæœ€ä½']);
            if (h > 0 && l > 0) {
                sumHigh += h;
                sumLow += l;
                marketCount++;
            }
        }
    });

    if (count === 0) return null;

    let finalLowPrem = sumLowPrem / count;
    let finalAvgPrem = sumAvgPrem / count;

    // æ•¸å€¼æ ¡æ­£ï¼šé¿å…å°‡åƒ¹æ ¼ (105) èª¤åˆ¤ç‚ºæº¢åƒ¹ (5)
    if (finalLowPrem > 50) finalLowPrem -= 100;
    if (finalAvgPrem > 50) finalAvgPrem -= 100;

    return {
        'å¹³å‡æœ€ä½å¾—æ¨™': sumLowPrice / count,
        'å¹³å‡æœ€ä½æº¢åƒ¹': finalLowPrem,
        'å¹³å‡å¾—æ¨™åƒ¹': sumAvgPrice / count,
        'å¹³å‡æº¢åƒ¹': finalAvgPrem,
        'å¹³å‡æ›ç‰Œæœ€é«˜': marketCount > 0 ? sumHigh / marketCount : 0,
        'å¹³å‡æ›ç‰Œæœ€ä½': marketCount > 0 ? sumLow / marketCount : 0,
        'æ¨£æœ¬æ•¸': count
    };
}

// 4. æ™ºèƒ½æ•¸æ“šç²å–ä»‹é¢
function getStatsSmart(category, val) {
    let stats = { low: 0, avg: 0, usedFallback: false, rawData: null };
    let filterFn = null;

    // å®šç¾©éæ¿¾é‚è¼¯
    if (category === 'ç™¼è¡Œåˆ¸å•†') {
        filterFn = d => {
            const name = d['ç™¼è¡Œåˆ¸å•†'] || d['æ‰¿éŠ·åˆ¸å•†'] || d['ä¸»è¾¦åˆ¸å•†'] || '';
            return name.includes(val) || val.includes(name);
        };
    } else if (category === 'ç”¢æ¥­') {
        filterFn = d => (d['ç”¢æ¥­åˆ†é¡'] || d['ç”¢æ¥­åˆ¥']) === val;
    } else if (category === 'æ“”ä¿') {
        filterFn = d => (d['æ“”ä¿'] || '').includes(val);
    } else if (category === 'å¹´æœŸ') {
        filterFn = d => safeFloat(d['å¹´æœŸ'] || d['ç™¼è¡Œå¹´æœŸ']) === val;
    } else if (category === 'ä¿¡è©•') {
        filterFn = d => (d['ä¿¡è©•'] || d['TCRI'] || '').toString().includes(val.toString());
    }

    // å˜—è©¦å³æ™‚é‹ç®—
    if (filterFn) {
        const dyn = getDynamicStats(filterFn);
        if (dyn) {
            stats.rawData = dyn;
            stats.low = dyn['å¹³å‡æœ€ä½æº¢åƒ¹'];
            stats.avg = dyn['å¹³å‡æº¢åƒ¹'];
        }
    }

    // è‹¥å³æ™‚é‹ç®—ç„¡çµæœï¼Œå˜—è©¦è®€å–é çµ±è¨ˆæª”
    if (stats.low === 0 && statistics['ç¶­åº¦çµ±è¨ˆ'] && statistics['ç¶­åº¦çµ±è¨ˆ'][category]) {
        let data = statistics['ç¶­åº¦çµ±è¨ˆ'][category][val];
        if (!data && typeof val === 'number') {
            const key = findBestRangeKey(category, val);
            if (key) data = statistics['ç¶­åº¦çµ±è¨ˆ'][category][key];
        }
        if (data) {
            stats.rawData = data;
            stats.low = safeFloat(data['å¹³å‡æœ€ä½æº¢åƒ¹']);
            stats.avg = safeFloat(data['å¹³å‡æº¢åƒ¹']);
        }
    }

    // è‡ªå‹•æ›¿è£œæ©Ÿåˆ¶ (Global Fallback)
    if (stats.low === 0 || stats.avg === 0) {
        stats.low = globalMarketStats.low;
        stats.avg = globalMarketStats.avg;
        stats.usedFallback = true;
        if (!stats.rawData) stats.rawData = {};
    }

    return stats;
}

// 5. å¡ç‰‡ç”Ÿæˆ
function generateStandardCard(data, titleOverride=null) {
    if (!data) return `<div class="stat-row" style="color:#999;">æŸ¥ç„¡è³‡æ–™ (å°‡ä½¿ç”¨å¸‚å ´å‡å€¼é‹ç®—)</div>`;

    const val = (v, suffix='') => (v !== undefined && v !== null && v !== '' && v !== 0) ? `${safeFloat(v).toFixed(2)}${suffix}` : '-';

    let html = `
    <div class="stats-header">ğŸ“Š ${titleOverride || 'æ­·å²çµ±è¨ˆ'}</div>
    `;

    if (data['æ¨£æœ¬æ•¸']) {
        html += `<div class="stat-row" style="color:#555; font-weight:bold; margin-bottom:8px;">æ¨£æœ¬æ•¸: ${data['æ¨£æœ¬æ•¸']} æª”</div>`;
    }

    html += `
    <div style="background:#f1f8e9; padding:8px; border-radius:5px; margin-bottom:8px;">
    <div class="stat-row">
    <span class="stat-label">ğŸ“‰ æœ€ä½å¾—æ¨™:</span>
    <span class="stat-value">${val(data['å¹³å‡æœ€ä½å¾—æ¨™'], 'å…ƒ')} / æº¢ ${val(data['å¹³å‡æœ€ä½æº¢åƒ¹'], '%')}</span>
    </div>
    <div class="stat-row">
    <span class="stat-label">âš–ï¸ å¹³å‡å¾—æ¨™:</span>
    <span class="stat-value">${val(data['å¹³å‡å¾—æ¨™åƒ¹'], 'å…ƒ')} / æº¢ ${val(data['å¹³å‡æº¢åƒ¹'], '%')}</span>
    </div>
    </div>
    `;

    const h = safeFloat(data['å¹³å‡æ›ç‰Œæœ€é«˜']);
    const l = safeFloat(data['å¹³å‡æ›ç‰Œæœ€ä½']);
    const amp = l > 0 ? ((h - l) / l * 100).toFixed(1) : 0;

    html += `
    <div style="border-top:1px dashed #ccc; padding-top:8px;">
    <div class="stat-row">
    <span class="stat-label">ğŸ“ˆ æ›ç‰Œæœ€é«˜:</span> <span class="stat-value">${val(h)}</span>
    </div>
    <div class="stat-row">
    <span class="stat-label">ğŸ“‰ æ›ç‰Œæœ€ä½:</span> <span class="stat-value">${val(l)}</span>
    </div>
    <div class="stat-row">
    <span class="stat-label" style="color:#E91E63;">âš¡ å¹³å‡æŒ¯å¹…:</span> <span class="stat-value" style="color:#E91E63;">${amp > 0 ? amp + '%' : '-'}</span>
    </div>
    </div>
    `;
    return html;
}

// 6. åˆå§‹åŒ–èˆ‡ç¶å®š
function initializeUI() {
    document.getElementById('headerSubtitle').textContent = `Rexå¤§å”çš„168å°è‚¡æŠ•è³‡æ•™å®¤ | æ•´åˆ${Object.keys(cbDatabase).length}æª”CBå®Œæ•´è³‡æ–™åº«`;
    if (statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']) populateSelect('industry', statistics['ç¶­åº¦çµ±è¨ˆ']['ç”¢æ¥­']);
    if (statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']) populateSelect('broker', statistics['ç¶­åº¦çµ±è¨ˆ']['ç™¼è¡Œåˆ¸å•†']);
    showStatsSummary();
    bindInputEvents();
}

function populateSelect(id, dataObj) {
    if (!dataObj) return;
    const select = document.getElementById(id);
    while (select.options.length > 1) { select.remove(1); }
    const items = Object.keys(dataObj).sort((a, b) => (dataObj[b]['æ¨£æœ¬æ•¸'] || 0) - (dataObj[a]['æ¨£æœ¬æ•¸'] || 0));
    items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        const avgHigh = dataObj[item]['å¹³å‡æ›ç‰Œæœ€é«˜'];
        option.textContent = avgHigh ? `${item} (æœ€é«˜${avgHigh}å…ƒ)` : item;
        select.appendChild(option);
    });
}

function showStatsSummary() {
    document.getElementById('statsSummary').innerHTML = `
    <div class="stat-box"><div class="number">${Object.keys(cbDatabase).length}</div><div class="label">CBè³‡æ–™åº«</div></div>
    <div class="stat-box"><div class="number">${statistics['è³‡æ–™æœŸé–“']['ç¸½ç­†æ•¸'] || 0}</div><div class="label">ç«¶æ‹æ¡ˆä¾‹</div></div>
    `;
}

function bindInputEvents() {
    const show = (id, html) => {
        const el = document.getElementById(id); el.innerHTML = html||''; el.style.display = html?'block':'none';
    };

    document.getElementById('cbName').addEventListener('input', function() {
        const val = this.value.trim();
        if (!val) { show('cbNameInfo', null); return; }
        let found = null;
        if (cbNameMap[val]) found = cbNameMap[val];
        else found = Object.values(cbDatabase).find(d => d['åç¨±'] && d['åç¨±'].includes(val));

        if (found) {
            let html = `<div class="stats-header">ğŸ“Š æ›ç‰Œåƒ¹æ ¼åƒè€ƒ</div><div class="stat-row">${found['ä»£è™Ÿ'] || ''} / ${found['è‚¡ç¥¨ä»£è™Ÿ'] || ''}</div>`;
            if (found['æ›ç‰Œæœ€é«˜']) {
                const h = safeFloat(found['æ›ç‰Œæœ€é«˜']), l = safeFloat(found['æ›ç‰Œæœ€ä½']);
                const amp = l > 0 ? ((h-l)/l*100).toFixed(2) : 0;
                html += `<div class="stat-row" style="justify-content:space-between;"><span>ğŸ“ˆ æœ€é«˜:${h}</span><span>ğŸ“‰ æœ€ä½:${l}</span><span style="color:#E91E63;">âš¡ ${amp}%</span></div>`;
            }
            show('cbNameInfo', html);
        } else show('cbNameInfo', null);
    });

    const bind = (id, cat, isNum) => {
        document.getElementById(id).addEventListener(isNum ? 'input' : 'change', function() {
            const val = isNum ? parseFloat(this.value) : this.value;
            if (val) {
                let data = null;
                let key = val;
                
                // çµ±ä¸€ä½¿ç”¨ Smart ç²å– (è‡ªå‹•åˆ¤å®šå‹•æ…‹æˆ–éœæ…‹)
                const smartResult = getStatsSmart(cat, val);
                data = smartResult.rawData;

                if (isNum) key = findBestRangeKey(cat, val) || val;
                
                show(id+'Info', generateStandardCard(data, key ? `æ­·å²çµ±è¨ˆ (${key})` : `æ­·å²çµ±è¨ˆ (${val})`));
                if (cat === 'è½‰æ›åƒ¹' || cat === 'ä¿¡è©•') updateSmartReminders();
            }
        });
    };

    bind('capital', 'è‚¡æœ¬', true);
    bind('issueSize', 'ç™¼è¡Œè¦æ¨¡', true);
    bind('conversionPrice', 'è½‰æ›åƒ¹', true);
    bind('industry', 'ç”¢æ¥­', false);
    bind('broker', 'ç™¼è¡Œåˆ¸å•†', false);
    bind('years', 'å¹´æœŸ', true);

    document.getElementById('guarantee').addEventListener('change', function() {
        const smartResult = getStatsSmart('æ“”ä¿', this.value);
        show('guaranteeInfo', generateStandardCard(smartResult.rawData, `æ­·å²çµ±è¨ˆ (${this.value})`));
        updateMarketSentimentDisplay();
    });

    bind('rating', 'ä¿¡è©•', false);
    document.getElementById('stockPrice').addEventListener('input', updateSmartReminders);
}

function updateSmartReminders() {
    const stock = parseFloat(document.getElementById('stockPrice').value);
    const conv = parseFloat(document.getElementById('conversionPrice').value);
    const div = document.getElementById('smartReminders');
    if (stock && conv) {
        const theo = (stock/conv)*100;
        let msg = theo > 110 ? 'âš ï¸ ç›®å‰ç†è«–åƒ¹åé«˜ï¼Œéœ€æ³¨æ„æº¢åƒ¹é¢¨éšª' : theo < 85 ? 'ğŸ’¡ ç†è«–åƒ¹ä½æ–¼ä½æª”ï¼Œå¯èƒ½æœ‰å¥—åˆ©ç©ºé–“' : 'âœ¨ ç†è«–åƒ¹ä½æ–¼åˆç†å€é–“';
        document.getElementById('reminderContent').textContent = msg;
        div.style.display = 'block';
    }
}

function updateMarketSentimentDisplay() {
    const guarantee = document.getElementById('guarantee').value;
    const div = document.getElementById('marketSentiment');
    if (!guarantee || !auctionRawData) return;

    const similarCases = auctionRawData.filter(item => (item['æ“”ä¿']||'').includes(guarantee));
    if (similarCases.length === 0) {
        div.innerHTML = `<div class="stats-header">ğŸŒ¡ï¸ å‹•æ…‹å¸‚å ´æ°›åœ</div><div class="stat-row">ç„¡ç›¸é—œæ¡ˆä¾‹</div>`;
        return;
    }

    const periods = [{ label: 'è¿‘1æœˆ', days: 30 }, { label: 'è¿‘3æœˆ', days: 90 }, { label: 'è¿‘6æœˆ', days: 180 }];
    let html = `<div class="stats-header">ğŸŒ¡ï¸ è¿‘æœŸå¸‚å ´ç«¶æ‹æ°›åœ (${guarantee})</div>`;

    periods.forEach(p => {
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - p.days);
        const cases = similarCases.filter(item => new Date(item['é–‹æ¨™æ—¥æœŸ']) >= cutoff);

        if (cases.length > 0) {
            const avgMult = (cases.reduce((s, i) => s + safeFloat(i['æŠ•æ¨™å€æ•¸']), 0) / cases.length).toFixed(2);
            const avgPrem = (cases.reduce((s, i) => s + (safeFloat(i['å¹³å‡æº¢åƒ¹']) || safeFloat(i['æœ€ä½æº¢åƒ¹'])), 0) / cases.length * 100).toFixed(2);
            const top3 = cases.sort((a, b) => safeFloat(b['æŠ•æ¨™å€æ•¸']) - safeFloat(a['æŠ•æ¨™å€æ•¸'])).slice(0, 3);
            const top3Str = top3.map(c => `${c['CBåç¨±'] || c['åç¨±'] || 'æ¨™çš„'}(${safeFloat(c['æŠ•æ¨™å€æ•¸'])}å€)`).join(', ');

            html += `
            <div style="margin-bottom:10px; padding:10px; background:white; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-weight:bold; color:#333; margin-bottom:5px;">ğŸ“… ${p.label} (æ¨£æœ¬:${cases.length})</div>
            <div class="stat-row" style="justify-content:space-between;">
            <span>ğŸ”¥ å¹³å‡å€æ•¸:<span style="color:#f57c00">${avgMult}</span></span>
            <span>ğŸ’° å¹³å‡æº¢åƒ¹:<span style="color:#d32f2f">${avgPrem}%</span></span>
            </div>
            <div style="font-size:12px; color:#666; margin-top:5px;">ğŸ† ç†±é–€: ${top3Str}</div>
            </div>
            `;
        }
    });
    div.innerHTML = html;
    div.style.display = 'block';
}

function generateRexCommentary(result) {
    const prem = parseFloat(result.totalAvgPremium); // ä½¿ç”¨æ–°ç‰ˆçš„ç¸½è¨ˆå¹³å‡æº¢åƒ¹
    let comment = "", strategy = "";

    if (prem >= 15) {
        comment = "ğŸ”¥ **å¸‚å ´éç†±è­¦ç¤º**ï¼šç›®å‰è©•ä¼°æº¢åƒ¹ç‡æ¥µé«˜ï¼Œé¡¯ç¤ºå¸‚å ´å°è©²é¡Œææ¥µåº¦è¿½æ§ã€‚éœ€æ³¨æ„ç†è«–åƒ¹æ ¼æ˜¯å¦å·²åœ¨é«˜æª”ã€‚";
        strategy = "å»ºè­°æ¡**ä¿å®ˆç­–ç•¥**ï¼Œæˆ–åƒ…ä»¥å°é‡è³‡é‡‘åƒèˆ‡ï¼Œé¿å…è¿½é«˜é¢¨éšªã€‚";
    } else if (prem >= 8) {
        comment = "ğŸ“ˆ **å¤šé ­è¶¨å‹¢æ˜ç¢º**ï¼šç¶œåˆæº¢åƒ¹ç‡é¡¯ç¤ºå¸‚å ´æƒ…ç·’æ¨‚è§€ï¼Œç”¢æ¥­èˆ‡ç™¼è¡Œæ¢ä»¶å‡å…·å¸å¼•åŠ›ã€‚";
        strategy = "å¯æ¡**ç©æ¥µç­–ç•¥**ï¼Œä½†éœ€ç•™æ„è½‰æ›åƒ¹æ˜¯å¦å…·å‚™æ”»æ“Šæ€§ã€‚";
    } else if (prem >= 3) {
        comment = "âš–ï¸ **å€é–“åˆç†éœ‡ç›ª**ï¼šç›®å‰çš„æº¢åƒ¹ç‡è™•æ–¼æ­·å²åˆç†å€é–“ï¼Œå¸‚å ´çœ‹æ³•ä¸­æ€§åå¤šã€‚";
        strategy = "å»ºè­°æ¡**å¹³è¡¡ç­–ç•¥**ï¼Œä»¥ç†è«–å¾—æ¨™åƒ¹ç‚ºåŸºæº–ï¼Œä¸Šä¸‹å¾®èª¿ 1~2 å…ƒé€²è¡ŒæŠ•æ¨™ã€‚";
    } else {
        comment = "ğŸ§Š **é˜²ç¦¦åƒ¹å€¼æµ®ç¾**ï¼šç›®å‰æº¢åƒ¹ç‡ä½æ–¼å¹³å‡æ°´æº–ï¼Œå¯èƒ½æ˜¯å¸‚å ´å¿½ç•¥çš„å†·é–€å„ªè³ªè‚¡ï¼Œæˆ–ç†è«–åƒ¹å·²åä½ã€‚";
        strategy = "å…·å‚™**é«˜å®‰å…¨é‚Šéš›**ï¼Œé©åˆé•·æœŸæŒæœ‰æˆ–å°‹æ±‚å¥—åˆ©æ©Ÿæœƒï¼Œå»ºè­°åœ¨æ­¤å€é–“ä½ˆå±€ã€‚";
    }

    return `
    <div class="rex-analysis">
    <div class="rex-title">ğŸ§¢ Rexå¤§å” æ™ºå›Šæˆ°ç•¥åˆ†æ</div>
    <div class="rex-content"><p>${comment}</p><p style="margin-top:10px;"><strong>ğŸ’¡ æ“ä½œå»ºè­°ï¼š</strong>${strategy}</p><p style="margin-top:10px; font-size:13px; color:#795548;">(æœ¬åˆ†æåŸºæ–¼æ­·å²å¤§æ•¸æ“šé‹ç®—ï¼Œåƒ…ä¾›åƒè€ƒï¼ŒæŠ•è³‡è«‹è‡ªè² ç›ˆè™§)</p></div>
    </div>
    `;
}

function calculateEvaluation(data) {
    // 1. è¨ˆç®—ç†è«–åƒ¹
    const theoPrice = (data.stockPrice / data.conversionPrice) * 100;
    
    // 2. ç²å–å„ç¶­åº¦çµ±è¨ˆæ•¸æ“š + æ¬Šé‡ä¿‚æ•¸
    const dimensions = {};
    
    // ç”¢æ¥­ (25%)
    dimensions.industry = {
        ...getStatsSmart('ç”¢æ¥­', data.industry),
        coefficient: getWeightCoefficient('industry', data.industry),
        weight: 0.25,
        range: data.industry
    };
    
    // åˆ¸å•† (13%)
    const brokerName = getBrokerName(data.cbName);
    if (brokerName) {
        dimensions.broker = {
            ...getStatsSmart('ç™¼è¡Œåˆ¸å•†', brokerName),
            coefficient: getWeightCoefficient('broker', brokerName),
            weight: 0.13,
            range: brokerName
        };
    } else {
        dimensions.broker = {
            low: 0, avg: 0, usedFallback: true,
            coefficient: 1.0, weight: 0.13, range: 'æœªæŸ¥è©¢åˆ°'
        };
    }
    
    // è‚¡æœ¬ (12%)
    const capitalRange = classifyCapital(data.capital);
    dimensions.capital = {
        ...getStatsSmart('è‚¡æœ¬', capitalRange),
        coefficient: getWeightCoefficient('capital', capitalRange),
        weight: 0.12,
        range: capitalRange
    };
    
    // è¦æ¨¡ (10%)
    const sizeRange = classifySize(data.issueSize);
    dimensions.size = {
        ...getStatsSmart('ç™¼è¡Œè¦æ¨¡', sizeRange),
        coefficient: getWeightCoefficient('size', sizeRange),
        weight: 0.10,
        range: sizeRange
    };
    
    // ä¿¡è©• (15%)
    let ratingKey = data.rating;
    if (ratingKey !== 'BBB') {
        const v = parseInt(ratingKey);
        ratingKey = v <= 3 ? '2-3åˆ†' : v <= 5 ? '4-5åˆ†' : v <= 7 ? '6-7åˆ†' : '8-9åˆ†';
    }
    dimensions.rating = {
        ...getStatsSmart('ä¿¡è©•', ratingKey),
        coefficient: getWeightCoefficient('rating', ratingKey),
        weight: 0.15,
        range: ratingKey
    };
    
    // æ“”ä¿ (12%)
    dimensions.guarantee = {
        ...getStatsSmart('æ“”ä¿', data.guarantee),
        coefficient: getWeightCoefficient('guarantee', data.guarantee),
        weight: 0.12,
        range: data.guarantee
    };
    
    // å¹´æœŸ (8%)
    const yearsKey = classifyYears(data.years);
    dimensions.years = {
        ...getStatsSmart('å¹´æœŸ', data.years),
        coefficient: getWeightCoefficient('years', yearsKey),
        weight: 0.08,
        range: yearsKey + 'å¹´'
    };
    
    // è½‰æ›åƒ¹ (5%)
    const conversionRange = classifyConversionPrice(data.conversionPrice);
    dimensions.conversion = {
        ...getStatsSmart('è½‰æ›åƒ¹', data.conversionPrice),
        coefficient: getWeightCoefficient('conversion', conversionRange),
        weight: 0.05,
        range: conversionRange
    };
    
    // 3. è¨ˆç®—å®¢è§€æ¬Šé‡æ¯”ä¾‹
    const objectiveRatio = (100 - (data.subjectiveWeight || 0)) / 100;
    
    // 4. è¨ˆç®—åŠ æ¬Šå¾Œçš„æ­·å²æº¢åƒ¹
    let weightedHistoricalLow = 0;
    let weightedHistoricalAvg = 0;
    
    for (const [key, dim] of Object.entries(dimensions)) {
        const contributionLow = dim.low * dim.weight * dim.coefficient * objectiveRatio;
        const contributionAvg = dim.avg * dim.weight * dim.coefficient * objectiveRatio;
        
        weightedHistoricalLow += contributionLow;
        weightedHistoricalAvg += contributionAvg;
        
        // è¨˜éŒ„æ¯å€‹ç¶­åº¦çš„è²¢ç»
        dim.weightedLow = contributionLow;
        dim.weightedAvg = contributionAvg;
    }
    
    // 5. åŠ å…¥ä¸»è§€æ¬Šé‡
    const subjectiveRatio = (data.subjectiveWeight || 0) / 100;
    const weightedSubjectiveLow = (data.subjectiveLowPremium || 0) * subjectiveRatio;
    const weightedSubjectiveAvg = (data.subjectiveAvgPremium || 0) * subjectiveRatio;
    
    // 6. è¨ˆç®—åˆè¨ˆæº¢åƒ¹
    const totalLowPremium = weightedHistoricalLow + weightedSubjectiveLow;
    const totalAvgPremium = weightedHistoricalAvg + weightedSubjectiveAvg;
    
    // 7. è¨ˆç®—å››å¤§ç­–ç•¥åƒ¹æ ¼
    const gap = totalAvgPremium - totalLowPremium;
    
    const bidPrices = {
        conservative: (theoPrice * (1 + totalLowPremium / 100)).toFixed(2),
        balanced: (theoPrice * (1 + totalAvgPremium / 100)).toFixed(2),
        aggressive: (theoPrice * (1 + (totalAvgPremium + gap) / 100)).toFixed(2),
        ultimate: (theoPrice * (1 + (totalAvgPremium + 2 * gap) / 100)).toFixed(2)
    };
    
    return {
        cbName: data.cbName,
        theoreticalPrice: theoPrice.toFixed(2),
        dimensions: dimensions,
        weightedHistoricalLow: weightedHistoricalLow.toFixed(2),
        weightedHistoricalAvg: weightedHistoricalAvg.toFixed(2),
        weightedSubjectiveLow: weightedSubjectiveLow.toFixed(2),
        weightedSubjectiveAvg: weightedSubjectiveAvg.toFixed(2),
        totalLowPremium: totalLowPremium.toFixed(2),
        totalAvgPremium: totalAvgPremium.toFixed(2),
        gap: gap.toFixed(2),
        bidPrices: bidPrices,
        inputData: {
            ...data,
            ratingDisplay: data.rating === 'BBB' ? 'BBB' : `TCRI ${data.rating}`
        }
    };
}

function displayResult(result) {
    document.getElementById('welcomeMsg').style.display = 'none';
    const resultDiv = document.getElementById('evaluationResult');
    resultDiv.className = 'evaluation-result active';
    
    // ç”Ÿæˆè¡¨æ ¼è¡Œ
    const generateTableRows = () => {
        const dimNames = {
            industry: 'ç”¢æ¥­åˆ†é¡',
            broker: 'ç™¼è¡Œåˆ¸å•†',
            capital: 'è‚¡æœ¬å¤§å°',
            size: 'ç™¼è¡Œè¦æ¨¡',
            rating: 'ä¿¡ç”¨è©•ç­‰',
            guarantee: 'æ“”ä¿æƒ…æ³',
            years: 'ç™¼è¡Œå¹´æœŸ',
            conversion: 'è½‰æ›åƒ¹æ ¼'
        };
        
        let rows = '';
        for (const [key, name] of Object.entries(dimNames)) {
            const dim = result.dimensions[key];
            const fmt = (v) => {
                const num = safeFloat(v);
                return `<span class="${num>0?'val-pos':num<0?'val-neg':'val-neu'}">${num.toFixed(2)}%</span>`;
            };
            
            rows += `
                <tr>
                    <td>${name}</td>
                    <td>${dim.range}</td>
                    <td>${fmt(dim.low)}</td>
                    <td>${fmt(dim.avg)}</td>
                    <td>${(dim.weight * 100).toFixed(0)}%</td>
                    <td>${dim.coefficient.toFixed(3)}</td>
                    <td>${fmt(dim.weightedLow)}</td>
                    <td>${fmt(dim.weightedAvg)}</td>
                </tr>
            `;
        }
        return rows;
    };
    
    // ä¸»è§€æ¬Šé‡è¡Œï¼ˆå¦‚æœæœ‰è¼¸å…¥ï¼‰
    const subjectiveRow = (result.inputData.subjectiveWeight || 0) > 0 ? `
        <tr style="background-color: #fff9e6;">
            <td><strong>ä¸»è§€æ¬Šé‡</strong></td>
            <td>ä½¿ç”¨è€…è¼¸å…¥</td>
            <td>${(result.inputData.subjectiveLowPremium || 0).toFixed(2)}%</td>
            <td>${(result.inputData.subjectiveAvgPremium || 0).toFixed(2)}%</td>
            <td>${result.inputData.subjectiveWeight}%</td>
            <td>1.000</td>
            <td style="color: #ff9800; font-weight: bold;">${result.weightedSubjectiveLow}%</td>
            <td style="color: #ff9800; font-weight: bold;">${result.weightedSubjectiveAvg}%</td>
        </tr>
    ` : '';
    
    // è¡¨æ ¼HTML
    const tableHtml = `
    <table class="data-table">
    <thead>
    <tr>
        <th>ç¶­åº¦</th>
        <th>æ¢ä»¶å€é–“</th>
        <th>æ­·å²æœ€ä½æº¢åƒ¹</th>
        <th>æ­·å²å¹³å‡æº¢åƒ¹</th>
        <th>æ¬Šé‡</th>
        <th>æ¬Šé‡ä¿‚æ•¸</th>
        <th>æœ€ä½æº¢åƒ¹åŠ æ¬Š</th>
        <th>å¹³å‡æº¢åƒ¹åŠ æ¬Š</th>
    </tr>
    </thead>
    <tbody>
    ${generateTableRows()}
    ${subjectiveRow}
    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <td colspan="6" style="text-align: right; padding-right: 20px; font-size: 16px; font-weight: bold;">
            ç¸½è¨ˆ
        </td>
        <td style="font-size: 18px; font-weight: bold;">${result.totalLowPremium}%</td>
        <td style="font-size: 18px; font-weight: bold;">${result.totalAvgPremium}%</td>
    </tr>
    </tbody>
    </table>
    `;
    
    // Rexå¤§å”åˆ†æ
    const rexCommentary = generateRexCommentary(result);
    
    // å®Œæ•´çµæœHTML
    resultDiv.innerHTML = `
    <div class="result-header">
        <h2>${result.cbName}</h2>
        <div class="subtitle">è³‡æ–™é©…å‹•AIè©•ä¼°çµæœ (V3.30 ç¶“å…¸ç©©å®šç‰ˆ)</div>
    </div>
    
    <div class="detail-section">
        <h3>ğŸ“Š ç†è«–åƒ¹æ ¼è¨ˆç®—</h3>
        <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:10px;">
            <div style="font-size:48px; font-weight:bold; color:#667eea;">${result.theoreticalPrice} å…ƒ</div>
            <div style="color:#999;">= è‚¡åƒ¹ ${result.inputData.stockPrice} Ã· è½‰åƒ¹ ${result.inputData.conversionPrice} Ã— 100</div>
        </div>
    </div>
    
    <div class="detail-section">
        <h3>ğŸ” æº¢åƒ¹ç‡åˆ†è§£åˆ†æè¡¨</h3>
        ${tableHtml}
    </div>
    
    ${rexCommentary}
    
    <div class="detail-section">
        <h3>ğŸ’¡ AIæŠ•æ¨™åƒ¹æ ¼å»ºè­°ï¼ˆå››å¤§ç­–ç•¥ï¼‰</h3>
        <div class="price-grid">
            <div class="strategy-card conservative">
                <h4>ğŸ›¡ï¸ ä¿å®ˆç­–ç•¥</h4>
                <div class="price">${result.bidPrices.conservative} å…ƒ</div>
                <div style="font-size: 12px; color: #666; margin-top: 10px; line-height: 1.6;">
                    è¨ˆç®—ï¼š${result.theoreticalPrice} Ã— (1 + ${result.totalLowPremium}%)<br>
                    å¾—æ¨™æ©Ÿç‡ï¼š60-75%
                </div>
            </div>
            
            <div class="strategy-card balanced">
                <h4>âš–ï¸ å¹³è¡¡ç­–ç•¥</h4>
                <div class="price">${result.bidPrices.balanced} å…ƒ</div>
                <div style="font-size: 12px; color: #666; margin-top: 10px; line-height: 1.6;">
                    è¨ˆç®—ï¼š${result.theoreticalPrice} Ã— (1 + ${result.totalAvgPremium}%)<br>
                    å¾—æ¨™æ©Ÿç‡ï¼š75-85%
                </div>
            </div>
            
            <div class="strategy-card aggressive">
                <h4>ğŸš€ ç©æ¥µç­–ç•¥</h4>
                <div class="price">${result.bidPrices.aggressive} å…ƒ</div>
                <div style="font-size: 12px; color: #666; margin-top: 10px; line-height: 1.6;">
                    è¨ˆç®—ï¼š${result.theoreticalPrice} Ã— (1 + ${(parseFloat(result.totalAvgPremium) + parseFloat(result.gap)).toFixed(2)}%)<br>
                    å¾—æ¨™æ©Ÿç‡ï¼š85-95%
                </div>
            </div>
            
            <div class="strategy-card ultimate">
                <h4>ğŸ”¥ æ¥µè‡´ç­–ç•¥</h4>
                <div class="price">${result.bidPrices.ultimate} å…ƒ</div>
                <div style="font-size: 12px; color: #666; margin-top: 10px; line-height: 1.6;">
                    è¨ˆç®—ï¼š${result.theoreticalPrice} Ã— (1 + ${(parseFloat(result.totalAvgPremium) + parseFloat(result.gap) * 2).toFixed(2)}%)<br>
                    å¾—æ¨™æ©Ÿç‡ï¼š95%+
                </div>
            </div>
        </div>
        
        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 25px; border-left: 4px solid #2196F3;">
            <strong style="color: #1976D2;">ğŸ’­ Rexå¤§å”æé†’ï¼š</strong>
            <p style="color: #555; margin-top: 10px; line-height: 1.8;">
                å››å¤§ç­–ç•¥æ¡ç”¨ç­‰å¹…å€é–“è¨­è¨ˆï¼Œå¾ä¿å®ˆåˆ°æ¥µè‡´ä¾åºéå¢ã€‚å»ºè­°åƒ¹æ ¼åŸºæ–¼å®Œæ•´çš„æ¬Šé‡ä¿‚æ•¸è¨ˆç®—ï¼Œåƒ…ä¾›åƒè€ƒã€‚
                å¯¦éš›æŠ•æ¨™è«‹ä¾å€‹äººé¢¨éšªæ‰¿å—åº¦èª¿æ•´ã€‚è¨˜ä½ï¼šå¯§å¯ä¸å¾—æ¨™ï¼Œä¹Ÿä¸è¦é«˜åƒ¹å¾—æ¨™é™·å…¥å¥—ç‰¢ã€‚
            </p>
        </div>
    </div>
    
    <div style="text-align:center; margin-top:30px;">
        <button onclick="location.reload()" style="padding:15px 40px; background:#667eea; color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">
            ğŸ”„ é‡æ–°è©•ä¼°
        </button>
    </div>
    `;
    
    resultDiv.scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = {
        cbName: document.getElementById('cbName').value,
        industry: document.getElementById('industry').value,
        issueSize: parseFloat(document.getElementById('issueSize').value),
        years: parseInt(document.getElementById('years').value),
        guarantee: document.getElementById('guarantee').value,
        rating: document.getElementById('rating').value,
        capital: parseFloat(document.getElementById('capital').value),
        stockPrice: parseFloat(document.getElementById('stockPrice').value),
        conversionPrice: parseFloat(document.getElementById('conversionPrice').value),
        
        // æ–°å¢ä¸»è§€æ¬Šé‡æ¬„ä½
        subjectiveWeight: parseFloat(document.getElementById('subjectiveWeight').value) || 0,
        subjectiveLowPremium: parseFloat(document.getElementById('subjectiveLowPremium').value) || 0,
        subjectiveAvgPremium: parseFloat(document.getElementById('subjectiveAvgPremium').value) || 0
    };
    displayResult(calculateEvaluation(formData));
});

window.addEventListener('DOMContentLoaded', loadStatistics);
</script>

</body>
</html>
